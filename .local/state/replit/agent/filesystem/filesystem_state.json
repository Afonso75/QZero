{"file_contents":{"src/pages/Profile.jsx":{"content":"import React, { useState } from \"react\";\nimport { useNavigate } from \"react-router-dom\";\nimport { base44 } from \"@/api/base44Client\";\nimport { useQuery, useQueryClient } from \"@tanstack/react-query\";\nimport { Skeleton } from \"@/components/ui/skeleton\";\nimport { Button } from \"@/components/ui/button\";\nimport { LogOut, Trash2, AlertTriangle } from \"lucide-react\";\nimport { createPageUrl } from \"@/utils\";\nimport ProfileManager from \"../components/portal/ProfileManager\";\nimport { TranslatedText } from \"@/components/translation/TranslatedText\";\nimport { useAutoTranslate } from \"@/hooks/useTranslate\";\nimport {\n  AlertDialog,\n  AlertDialogAction,\n  AlertDialogCancel,\n  AlertDialogContent,\n  AlertDialogDescription,\n  AlertDialogFooter,\n  AlertDialogHeader,\n  AlertDialogTitle,\n} from \"@/components/ui/alert-dialog\";\nimport { toast } from \"sonner\";\n\nexport default function ProfilePage() {\n  const queryClient = useQueryClient();\n  const navigate = useNavigate();\n  const [showDeleteDialog, setShowDeleteDialog] = useState(false);\n  const [isDeleting, setIsDeleting] = useState(false);\n  \n  const txtLogout = useAutoTranslate('Terminar Sessão', 'pt');\n  const txtDeleteAccount = useAutoTranslate('Eliminar Conta', 'pt');\n  const txtDeleteTitle = useAutoTranslate('Eliminar conta permanentemente?', 'pt');\n  const txtDeleteDescription = useAutoTranslate('Esta ação é irreversível. Todos os seus dados, incluindo perfil, marcações, senhas e histórico serão eliminados permanentemente.', 'pt');\n  const txtCancel = useAutoTranslate('Cancelar', 'pt');\n  const txtConfirmDelete = useAutoTranslate('Sim, eliminar conta', 'pt');\n  const txtDeleting = useAutoTranslate('A eliminar...', 'pt');\n  const txtDeleteError = useAutoTranslate('Erro ao eliminar conta. Tente novamente.', 'pt');\n  \n  const { data: user, isLoading } = useQuery({\n    queryKey: ['current-user'],\n    queryFn: () => base44.auth.me(),\n    staleTime: 0,\n    refetchOnMount: 'always',\n    refetchOnWindowFocus: true\n  });\n\n  const handleUpdate = async () => {\n    await queryClient.invalidateQueries({ queryKey: ['current-user'] });\n    await queryClient.refetchQueries({ queryKey: ['current-user'] });\n  };\n\n  const handleLogout = async () => {\n    try {\n      await base44.auth.logout();\n      queryClient.clear();\n      navigate(createPageUrl('Login'));\n    } catch (error) {\n      console.error('Erro ao fazer logout:', error);\n    }\n  };\n\n  const handleDeleteAccount = async () => {\n    setIsDeleting(true);\n    try {\n      await base44.auth.deleteAccount();\n      queryClient.clear();\n    } catch (error) {\n      console.error('Erro ao eliminar conta:', error);\n      toast.error(txtDeleteError);\n      setIsDeleting(false);\n      setShowDeleteDialog(false);\n    }\n  };\n\n  if (isLoading || !user) {\n    return (\n      <div className=\"bg-gradient-to-br from-slate-50 via-blue-50 to-sky-50 p-3 md:p-6\">\n        <div className=\"max-w-4xl mx-auto\">\n          <Skeleton className=\"h-12 md:h-16 w-48 md:w-64 mb-4 md:mb-8\" />\n          <Skeleton className=\"h-96 w-full\" />\n        </div>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"bg-gradient-to-br from-slate-50 via-blue-50 to-sky-50\">\n      <div className=\"max-w-4xl lg:max-w-5xl mx-auto px-3 md:px-6 lg:px-8 py-4 md:py-8 lg:py-10 pb-6 md:pb-8\">\n        <div className=\"mb-4 md:mb-8 lg:mb-10\">\n          <h1 className=\"text-2xl md:text-4xl lg:text-5xl font-bold text-slate-900 mb-1 md:mb-2 lg:mb-3\">\n            <TranslatedText text=\"Meu Perfil\" sourceLang=\"pt\" />\n          </h1>\n          <p className=\"text-sm md:text-xl lg:text-2xl text-slate-600\">\n            <TranslatedText text=\"Gerir as suas informações pessoais\" sourceLang=\"pt\" />\n          </p>\n        </div>\n\n        <ProfileManager user={user} onUpdate={handleUpdate} />\n\n        <div className=\"mt-6 md:mt-8 lg:mt-10 pt-6 lg:pt-8 border-t border-slate-200 space-y-3 lg:space-y-4\">\n          <Button\n            onClick={handleLogout}\n            variant=\"outline\"\n            className=\"w-full md:w-auto lg:h-12 lg:text-base lg:px-6 border-red-200 text-red-600 hover:bg-red-50 hover:text-red-700 hover:border-red-300\"\n          >\n            <LogOut className=\"w-4 h-4 lg:w-5 lg:h-5 mr-2\" />\n            {txtLogout}\n          </Button>\n          \n          <Button\n            onClick={() => setShowDeleteDialog(true)}\n            variant=\"ghost\"\n            className=\"w-full md:w-auto lg:h-12 lg:text-base lg:px-6 text-red-500 hover:bg-red-50 hover:text-red-600\"\n          >\n            <Trash2 className=\"w-4 h-4 lg:w-5 lg:h-5 mr-2\" />\n            {txtDeleteAccount}\n          </Button>\n        </div>\n      </div>\n\n      <AlertDialog open={showDeleteDialog} onOpenChange={setShowDeleteDialog}>\n        <AlertDialogContent className=\"max-w-md\">\n          <AlertDialogHeader>\n            <div className=\"flex items-center gap-3 text-red-600\">\n              <AlertTriangle className=\"w-6 h-6\" />\n              <AlertDialogTitle className=\"text-red-600\">\n                {txtDeleteTitle}\n              </AlertDialogTitle>\n            </div>\n            <AlertDialogDescription className=\"text-slate-600 pt-2\">\n              {txtDeleteDescription}\n            </AlertDialogDescription>\n          </AlertDialogHeader>\n          <AlertDialogFooter className=\"gap-2 sm:gap-0\">\n            <AlertDialogCancel disabled={isDeleting}>\n              {txtCancel}\n            </AlertDialogCancel>\n            <AlertDialogAction\n              onClick={handleDeleteAccount}\n              disabled={isDeleting}\n              className=\"bg-red-600 hover:bg-red-700 text-white\"\n            >\n              {isDeleting ? txtDeleting : txtConfirmDelete}\n            </AlertDialogAction>\n          </AlertDialogFooter>\n        </AlertDialogContent>\n      </AlertDialog>\n    </div>\n  );\n}","path":null,"size_bytes":5769,"size_tokens":null},"src/components/ui/hover-card.jsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as HoverCardPrimitive from \"@radix-ui/react-hover-card\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst HoverCard = HoverCardPrimitive.Root\n\nconst HoverCardTrigger = HoverCardPrimitive.Trigger\n\nconst HoverCardContent = React.forwardRef(({ className, align = \"center\", sideOffset = 4, ...props }, ref) => (\n  <HoverCardPrimitive.Content\n    ref={ref}\n    align={align}\n    sideOffset={sideOffset}\n    className={cn(\n      \"z-50 w-64 rounded-md border bg-popover p-4 text-popover-foreground shadow-md outline-none data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2\",\n      className\n    )}\n    {...props} />\n))\nHoverCardContent.displayName = HoverCardPrimitive.Content.displayName\n\nexport { HoverCard, HoverCardTrigger, HoverCardContent }\n","path":null,"size_bytes":1070,"size_tokens":null},"src/components/business/TicketPanel.jsx":{"content":"import React from \"react\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Button } from \"@/components/ui/button\";\nimport { \n  PhoneCall, \n  CheckCircle2, \n  XCircle,\n  Clock,\n  User,\n  Trash2\n} from \"lucide-react\";\nimport { useAutoTranslate } from \"@/hooks/useTranslate\";\n\nexport default function TicketPanel({ ticket, onUpdateTicket, onDeleteTicket }) {\n  const txtWaiting = useAutoTranslate('Aguard', 'pt');\n  const txtCalled = useAutoTranslate('Chamado', 'pt');\n  const txtAttending = useAutoTranslate('Atend', 'pt');\n  const txtDeleteTicket = useAutoTranslate('Eliminar senha', 'pt');\n  const txtDeleteConfirm = useAutoTranslate('Eliminar senha #', 'pt');\n\n  const statusConfig = {\n    aguardando: { \n      color: \"bg-blue-100 text-blue-700 border-blue-200\",\n      label: txtWaiting\n    },\n    chamado: { \n      color: \"bg-amber-100 text-amber-700 border-amber-200\",\n      label: txtCalled\n    },\n    atendendo: { \n      color: \"bg-purple-100 text-purple-700 border-purple-200\",\n      label: txtAttending\n    }\n  };\n  const status = statusConfig[ticket.status];\n\n  const handleCall = () => {\n    onUpdateTicket({\n      ticketId: ticket.id,\n      updates: {\n        status: 'chamado',\n        called_at: new Date().toISOString()\n      }\n    });\n  };\n\n  const handleStartAttending = () => {\n    onUpdateTicket({\n      ticketId: ticket.id,\n      updates: {\n        status: 'atendendo',\n        attending_started_at: new Date().toISOString()\n      }\n    });\n  };\n\n  const handleComplete = () => {\n    onUpdateTicket({\n      ticketId: ticket.id,\n      updates: {\n        status: 'concluido',\n        completed_at: new Date().toISOString()\n      }\n    });\n  };\n\n  const handleCancel = () => {\n    onUpdateTicket({\n      ticketId: ticket.id,\n      updates: {\n        status: 'cancelado'\n      }\n    });\n  };\n\n  const handleDelete = () => {\n    if (confirm(`${txtDeleteConfirm}${ticket.ticket_number}?`)) {\n      onDeleteTicket(ticket.id);\n    }\n  };\n\n  return (\n    <div className=\"flex items-center gap-1 p-1.5 bg-white border border-slate-200 rounded w-full overflow-hidden\">\n      <div className=\"w-7 h-7 rounded bg-gradient-to-br from-sky-500 to-blue-600 flex items-center justify-center text-white font-bold text-xs flex-shrink-0\">\n        #{ticket.ticket_number}\n      </div>\n      \n      <div className=\"flex-1 min-w-0\">\n        <div className=\"flex items-center gap-1 mb-0.5\">\n          <Badge className={`${status.color} text-xs h-4 px-1 py-0`}>\n            {status.label}\n          </Badge>\n          {ticket.is_manual && ticket.manual_name && (\n            <span className=\"text-xs text-slate-700 truncate\">{ticket.manual_name}</span>\n          )}\n        </div>\n        \n        {!ticket.is_manual && (\n          <div className=\"flex items-center gap-1 text-xs text-slate-600\">\n            <User className=\"w-2 h-2 flex-shrink-0\" />\n            <span className=\"truncate\">{ticket.user_email}</span>\n          </div>\n        )}\n      </div>\n\n      <div className=\"flex gap-0.5 flex-shrink-0\">\n        {ticket.status === 'aguardando' && (\n          <>\n            <Button\n              size=\"sm\"\n              variant=\"outline\"\n              onClick={handleCall}\n              className=\"h-6 px-1 text-xs\"\n            >\n              <PhoneCall className=\"w-2.5 h-2.5\" />\n            </Button>\n            <Button\n              size=\"sm\"\n              variant=\"outline\"\n              onClick={handleCancel}\n              className=\"h-6 w-6 p-0 border-red-200 text-red-600 hover:bg-red-50\"\n            >\n              <XCircle className=\"w-2.5 h-2.5\" />\n            </Button>\n          </>\n        )}\n\n        {ticket.status === 'chamado' && (\n          <>\n            <Button\n              size=\"sm\"\n              onClick={handleStartAttending}\n              className=\"h-6 px-1 text-xs bg-purple-600 hover:bg-purple-700\"\n            >\n              <Clock className=\"w-2.5 h-2.5\" />\n            </Button>\n            <Button\n              size=\"sm\"\n              variant=\"outline\"\n              onClick={handleCancel}\n              className=\"h-6 w-6 p-0 border-red-200 text-red-600 hover:bg-red-50\"\n            >\n              <XCircle className=\"w-2.5 h-2.5\" />\n            </Button>\n          </>\n        )}\n\n        {ticket.status === 'atendendo' && (\n          <Button\n            size=\"sm\"\n            onClick={handleComplete}\n            className=\"h-6 px-1 text-xs bg-green-600 hover:bg-green-700\"\n          >\n            <CheckCircle2 className=\"w-2.5 h-2.5\" />\n          </Button>\n        )}\n\n        {onDeleteTicket && !ticket.is_manual && (\n          <Button\n            size=\"sm\"\n            variant=\"outline\"\n            onClick={handleDelete}\n            className=\"h-6 w-6 p-0 border-red-300 text-red-700 hover:bg-red-100\"\n            title={txtDeleteTicket}\n          >\n            <Trash2 className=\"w-2.5 h-2.5\" />\n          </Button>\n        )}\n      </div>\n    </div>\n  );\n}","path":null,"size_bytes":4912,"size_tokens":null},"src/components/ui/command.jsx":{"content":"import * as React from \"react\"\nimport { Command as CommandPrimitive } from \"cmdk\"\nimport { Search } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\nimport { Dialog, DialogContent, DialogTitle, DialogDescription } from \"@/components/ui/dialog\"\nimport { VisuallyHidden } from \"@radix-ui/react-visually-hidden\"\n\nconst Command = React.forwardRef(({ className, ...props }, ref) => (\n  <CommandPrimitive\n    ref={ref}\n    className={cn(\n      \"flex h-full w-full flex-col overflow-hidden rounded-md bg-popover text-popover-foreground\",\n      className\n    )}\n    {...props} />\n))\nCommand.displayName = CommandPrimitive.displayName\n\nconst CommandDialog = ({\n  children,\n  ...props\n}) => {\n  return (\n    (<Dialog {...props}>\n      <DialogContent className=\"overflow-hidden p-0\">\n        <VisuallyHidden>\n          <DialogTitle>Command Menu</DialogTitle>\n          <DialogDescription>Search and select commands</DialogDescription>\n        </VisuallyHidden>\n        <Command\n          className=\"[&_[cmdk-group-heading]]:px-2 [&_[cmdk-group-heading]]:font-medium [&_[cmdk-group-heading]]:text-muted-foreground [&_[cmdk-group]:not([hidden])_~[cmdk-group]]:pt-0 [&_[cmdk-group]]:px-2 [&_[cmdk-input-wrapper]_svg]:h-5 [&_[cmdk-input-wrapper]_svg]:w-5 [&_[cmdk-input]]:h-12 [&_[cmdk-item]]:px-2 [&_[cmdk-item]]:py-3 [&_[cmdk-item]_svg]:h-5 [&_[cmdk-item]_svg]:w-5\">\n          {children}\n        </Command>\n      </DialogContent>\n    </Dialog>)\n  );\n}\n\nconst CommandInput = React.forwardRef(({ className, ...props }, ref) => (\n  <div className=\"flex items-center border-b px-3\" cmdk-input-wrapper=\"\">\n    <Search className=\"mr-2 h-4 w-4 shrink-0 opacity-50\" />\n    <CommandPrimitive.Input\n      ref={ref}\n      className={cn(\n        \"flex h-10 w-full rounded-md bg-transparent py-3 text-sm outline-none placeholder:text-muted-foreground disabled:cursor-not-allowed disabled:opacity-50\",\n        className\n      )}\n      {...props} />\n  </div>\n))\n\nCommandInput.displayName = CommandPrimitive.Input.displayName\n\nconst CommandList = React.forwardRef(({ className, ...props }, ref) => (\n  <CommandPrimitive.List\n    ref={ref}\n    className={cn(\"max-h-[300px] overflow-y-auto overflow-x-hidden\", className)}\n    {...props} />\n))\n\nCommandList.displayName = CommandPrimitive.List.displayName\n\nconst CommandEmpty = React.forwardRef((props, ref) => (\n  <CommandPrimitive.Empty ref={ref} className=\"py-6 text-center text-sm\" {...props} />\n))\n\nCommandEmpty.displayName = CommandPrimitive.Empty.displayName\n\nconst CommandGroup = React.forwardRef(({ className, ...props }, ref) => (\n  <CommandPrimitive.Group\n    ref={ref}\n    className={cn(\n      \"overflow-hidden p-1 text-foreground [&_[cmdk-group-heading]]:px-2 [&_[cmdk-group-heading]]:py-1.5 [&_[cmdk-group-heading]]:text-xs [&_[cmdk-group-heading]]:font-medium [&_[cmdk-group-heading]]:text-muted-foreground\",\n      className\n    )}\n    {...props} />\n))\n\nCommandGroup.displayName = CommandPrimitive.Group.displayName\n\nconst CommandSeparator = React.forwardRef(({ className, ...props }, ref) => (\n  <CommandPrimitive.Separator ref={ref} className={cn(\"-mx-1 h-px bg-border\", className)} {...props} />\n))\nCommandSeparator.displayName = CommandPrimitive.Separator.displayName\n\nconst CommandItem = React.forwardRef(({ className, ...props }, ref) => (\n  <CommandPrimitive.Item\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default gap-2 select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none data-[disabled=true]:pointer-events-none data-[selected=true]:bg-accent data-[selected=true]:text-accent-foreground data-[disabled=true]:opacity-50 [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0\",\n      className\n    )}\n    {...props} />\n))\n\nCommandItem.displayName = CommandPrimitive.Item.displayName\n\nconst CommandShortcut = ({\n  className,\n  ...props\n}) => {\n  return (\n    (<span\n      className={cn(\"ml-auto text-xs tracking-widest text-muted-foreground\", className)}\n      {...props} />)\n  );\n}\nCommandShortcut.displayName = \"CommandShortcut\"\n\nexport {\n  Command,\n  CommandDialog,\n  CommandInput,\n  CommandList,\n  CommandEmpty,\n  CommandGroup,\n  CommandItem,\n  CommandShortcut,\n  CommandSeparator,\n}\n","path":null,"size_bytes":4171,"size_tokens":null},"src/components/business/QuickResponses.jsx":{"content":"import React, { useState } from \"react\";\nimport { base44 } from \"@/api/base44Client\";\nimport { useMutation, useQueryClient } from \"@tanstack/react-query\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport { Label } from \"@/components/ui/label\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Plus, Trash2, MessageSquare, Copy } from \"lucide-react\";\nimport { useAutoTranslate } from \"@/hooks/useTranslate\";\n\nexport default function QuickResponses({ business }) {\n  const txtQuickResponses = useAutoTranslate('Respostas Rápidas', 'pt');\n  const txtNewResponse = useAutoTranslate('Nova Resposta', 'pt');\n  const txtDescription = useAutoTranslate('Configure mensagens pré-definidas para comunicar rapidamente com clientes através de SMS/email', 'pt');\n  const txtResponseTitle = useAutoTranslate('Título da Resposta', 'pt');\n  const txtTitlePlaceholder = useAutoTranslate('Ex: Aviso de Atraso', 'pt');\n  const txtMessage = useAutoTranslate('Mensagem', 'pt');\n  const txtMessagePlaceholder = useAutoTranslate('Ex: Devido a um imprevisto, teremos um atraso de 15 minutos. Pedimos desculpa pelo inconveniente.', 'pt');\n  const txtSave = useAutoTranslate('Guardar', 'pt');\n  const txtCancel = useAutoTranslate('Cancelar', 'pt');\n  const txtNoResponses = useAutoTranslate('Nenhuma resposta rápida configurada', 'pt');\n  const txtCreateMessages = useAutoTranslate('Crie mensagens pré-definidas para comunicar mais rapidamente', 'pt');\n  const txtCharacters = useAutoTranslate('caracteres', 'pt');\n  const txtDeleteConfirm = useAutoTranslate('Tem certeza que deseja eliminar esta resposta rápida?', 'pt');\n  const txtUsageTip = useAutoTranslate('Dica de Uso', 'pt');\n  const txtUsageDescription = useAutoTranslate('Use estas respostas quando precisar comunicar alterações nos horários, avisar sobre atrasos, ou enviar informações importantes para todos os clientes em espera.', 'pt');\n  const queryClient = useQueryClient();\n  const [showForm, setShowForm] = useState(false);\n  const [newResponse, setNewResponse] = useState({ title: '', message: '' });\n\n  const quickResponses = business?.quick_responses || [];\n\n  const updateBusinessMutation = useMutation({\n    mutationFn: async (responses) => {\n      await base44.entities.Business.update(business.id, {\n        quick_responses: responses\n      });\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['business'] });\n    },\n  });\n\n  const handleAdd = () => {\n    if (!newResponse.title || !newResponse.message) return;\n    \n    const updated = [...quickResponses, newResponse];\n    updateBusinessMutation.mutate(updated);\n    setNewResponse({ title: '', message: '' });\n    setShowForm(false);\n  };\n\n  const handleDelete = (index) => {\n    if (!confirm(txtDeleteConfirm)) return;\n    \n    const updated = quickResponses.filter((_, i) => i !== index);\n    updateBusinessMutation.mutate(updated);\n  };\n\n  const handleCopy = (message) => {\n    navigator.clipboard.writeText(message);\n  };\n\n  return (\n    <Card className=\"border-0 shadow-lg\">\n      <CardHeader>\n        <div className=\"flex items-center justify-between\">\n          <CardTitle className=\"flex items-center gap-2\">\n            <MessageSquare className=\"w-5 h-5\" />\n            {txtQuickResponses}\n          </CardTitle>\n          <Button\n            size=\"sm\"\n            onClick={() => setShowForm(!showForm)}\n            className=\"gap-2\"\n          >\n            <Plus className=\"w-4 h-4\" />\n            {txtNewResponse}\n          </Button>\n        </div>\n      </CardHeader>\n\n      <CardContent className=\"space-y-4\">\n        <p className=\"text-sm text-slate-600\">\n          {txtDescription}\n        </p>\n\n        {showForm && (\n          <div className=\"p-4 bg-slate-50 rounded-xl space-y-4\">\n            <div>\n              <Label htmlFor=\"title\">{txtResponseTitle}</Label>\n              <Input\n                id=\"title\"\n                value={newResponse.title}\n                onChange={(e) => setNewResponse({ ...newResponse, title: e.target.value })}\n                placeholder={txtTitlePlaceholder}\n              />\n            </div>\n\n            <div>\n              <Label htmlFor=\"message\">{txtMessage}</Label>\n              <Textarea\n                id=\"message\"\n                value={newResponse.message}\n                onChange={(e) => setNewResponse({ ...newResponse, message: e.target.value })}\n                placeholder={txtMessagePlaceholder}\n                rows={4}\n              />\n            </div>\n\n            <div className=\"flex gap-2\">\n              <Button onClick={handleAdd} disabled={updateBusinessMutation.isPending}>\n                {txtSave}\n              </Button>\n              <Button variant=\"outline\" onClick={() => setShowForm(false)}>\n                {txtCancel}\n              </Button>\n            </div>\n          </div>\n        )}\n\n        {quickResponses.length === 0 ? (\n          <div className=\"text-center py-12 text-slate-500\">\n            <MessageSquare className=\"w-12 h-12 mx-auto mb-3 opacity-50\" />\n            <p>{txtNoResponses}</p>\n            <p className=\"text-sm mt-1\">{txtCreateMessages}</p>\n          </div>\n        ) : (\n          <div className=\"space-y-3\">\n            {quickResponses.map((response, index) => (\n              <div\n                key={index}\n                className=\"p-4 bg-white border border-slate-200 rounded-xl hover:shadow-md transition-all\"\n              >\n                <div className=\"flex items-start justify-between mb-2\">\n                  <div>\n                    <h4 className=\"font-semibold text-slate-900\">{response.title}</h4>\n                    <Badge variant=\"secondary\" className=\"text-xs mt-1\">\n                      {response.message.length} {txtCharacters}\n                    </Badge>\n                  </div>\n                  <div className=\"flex gap-2\">\n                    <Button\n                      size=\"sm\"\n                      variant=\"outline\"\n                      onClick={() => handleCopy(response.message)}\n                    >\n                      <Copy className=\"w-4 h-4\" />\n                    </Button>\n                    <Button\n                      size=\"sm\"\n                      variant=\"outline\"\n                      onClick={() => handleDelete(index)}\n                      className=\"border-red-200 text-red-600 hover:bg-red-50\"\n                    >\n                      <Trash2 className=\"w-4 h-4\" />\n                    </Button>\n                  </div>\n                </div>\n                <p className=\"text-sm text-slate-600 bg-slate-50 p-3 rounded-lg\">\n                  {response.message}\n                </p>\n              </div>\n            ))}\n          </div>\n        )}\n\n        <div className=\"p-4 bg-blue-50 rounded-xl border border-blue-200\">\n          <h5 className=\"font-semibold text-blue-900 mb-2 flex items-center gap-2\">\n            <MessageSquare className=\"w-4 h-4\" />\n            {txtUsageTip}\n          </h5>\n          <p className=\"text-sm text-blue-800\">\n            {txtUsageDescription}\n          </p>\n        </div>\n      </CardContent>\n    </Card>\n  );\n}","path":null,"size_bytes":7286,"size_tokens":null},"src/pages/BusinessServices.jsx":{"content":"import React, { useState, useEffect } from \"react\";\nimport { base44 } from \"@/api/base44Client\";\nimport { useQuery, useMutation, useQueryClient } from \"@tanstack/react-query\";\nimport { Link, useNavigate } from \"react-router-dom\";\nimport { createPageUrl } from \"@/utils\";\nimport { Card, CardContent } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Plus, Edit, Trash2, Calendar, Crown, ArrowLeft } from \"lucide-react\";\nimport { Skeleton } from \"@/components/ui/skeleton\";\nimport { Badge } from \"@/components/ui/badge\";\nimport EmptyState from \"../components/shared/EmptyState\";\nimport ServiceForm from \"../components/business/ServiceForm\";\nimport { useConfirm } from \"@/hooks/useConfirm\";\nimport { toast } from \"sonner\";\nimport { useBusinessAccess } from \"@/hooks/useBusinessAccess\";\nimport { useAutoTranslate } from \"@/hooks/useTranslate\";\nimport { ExpiredBanner } from \"@/components/business/ExpiredBanner\";\nimport { BusinessFeatureGuard } from \"@/components/business/BusinessFeatureGuard\";\n\nexport default function BusinessServicesPage() {\n  const navigate = useNavigate();\n  const queryClient = useQueryClient();\n  const [user, setUser] = useState(null);\n  const [showForm, setShowForm] = useState(false);\n  const [editingService, setEditingService] = useState(null);\n  const { confirm, ConfirmDialog } = useConfirm();\n  \n  // ✅ Usar hook com hasAccess (inclui subscrições canceladas com acesso até currentPeriodEnd)\n  const { hasAccess, hasActiveSubscription, isExpired, companyProfile, isLoading: loadingAccess } = useBusinessAccess();\n\n  const txtServiceManagement = useAutoTranslate('Gestão de Serviços', 'pt');\n  const txtCreateManageServices = useAutoTranslate('Crie e gerir os serviços que oferece aos seus clientes', 'pt');\n  const txtNewService = useAutoTranslate('Novo Serviço', 'pt');\n  const txtServiceDeleted = useAutoTranslate('Serviço eliminado com sucesso', 'pt');\n  const txtDeleteServiceError = useAutoTranslate('Erro ao eliminar serviço', 'pt');\n  const txtDeleteServiceTitle = useAutoTranslate('Eliminar Serviço', 'pt');\n  const txtDeleteServiceConfirm = useAutoTranslate('Tem certeza que deseja eliminar este serviço? Esta ação não pode ser desfeita.', 'pt');\n  const txtEdit = useAutoTranslate('Editar', 'pt');\n  const txtAvailableDays = useAutoTranslate('Dias disponíveis:', 'pt');\n  const txtNoServicesCreated = useAutoTranslate('Nenhum serviço criado', 'pt');\n  const txtCreateFirstServiceDesc = useAutoTranslate('Crie seu primeiro serviço para oferecer aos clientes', 'pt');\n  const txtCreateFirstService = useAutoTranslate('Criar Primeiro Serviço', 'pt');\n  const txtSunday = useAutoTranslate('Domingo', 'pt');\n  const txtMonday = useAutoTranslate('Segunda-feira', 'pt');\n  const txtTuesday = useAutoTranslate('Terça-feira', 'pt');\n  const txtWednesday = useAutoTranslate('Quarta-feira', 'pt');\n  const txtThursday = useAutoTranslate('Quinta-feira', 'pt');\n  const txtFriday = useAutoTranslate('Sexta-feira', 'pt');\n  const txtSaturday = useAutoTranslate('Sábado', 'pt');\n  \n  const daysOfWeekMap = {\n    sunday: txtSunday,\n    monday: txtMonday,\n    tuesday: txtTuesday,\n    wednesday: txtWednesday,\n    thursday: txtThursday,\n    friday: txtFriday,\n    saturday: txtSaturday\n  };\n\n  useEffect(() => {\n    base44.auth.me().then(userData => {\n      setUser(userData);\n      if (!userData.is_business_user || !userData.business_id) {\n        navigate(createPageUrl(\"Home\"));\n      }\n    }).catch(() => base44.auth.redirectToLogin());\n  }, [navigate]);\n\n  // ✅ Usar hasAccess (true para subscrições ativas, trial, ou canceladas com currentPeriodEnd futuro)\n  const hasSubscription = hasAccess || hasActiveSubscription || user?.has_business_subscription;\n  const txtBack = useAutoTranslate('Voltar', 'pt');\n  const txtServiceManagementFeature = useAutoTranslate('a gestão de marcações', 'pt');\n\n  const { data: services, isLoading } = useQuery({\n    queryKey: ['business-services', user?.business_id],\n    queryFn: () => base44.entities.Service.filter({ business_id: user.business_id }),\n    initialData: [],\n    enabled: !!user?.business_id,\n  });\n\n  const deleteServiceMutation = useMutation({\n    mutationFn: (serviceId) => base44.entities.Service.delete(serviceId),\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['business-services', user?.business_id] });\n      toast.success(txtServiceDeleted);\n    },\n    onError: () => {\n      toast.error(txtDeleteServiceError);\n    }\n  });\n\n  const handleEdit = (service) => {\n    if (!hasSubscription) return;\n    setEditingService(service);\n    setShowForm(true);\n  };\n\n  const handleCloseForm = () => {\n    setShowForm(false);\n    setEditingService(null);\n  };\n\n  const handleDelete = async (serviceId) => {\n    if (!hasSubscription) return;\n    const confirmed = await confirm({\n      title: txtDeleteServiceTitle,\n      description: txtDeleteServiceConfirm,\n    });\n    if (confirmed) {\n      deleteServiceMutation.mutate(serviceId);\n    }\n  };\n\n  if (!user || isLoading) {\n    return (\n      <div className=\"bg-gradient-to-br from-slate-50 via-blue-50 to-sky-50 p-2\">\n        <div className=\"max-w-full mx-auto px-2\">\n          <Skeleton className=\"h-8 w-40 mb-2\" />\n          <Skeleton className=\"h-48 w-full\" />\n        </div>\n      </div>\n    );\n  }\n\n  return (\n    <BusinessFeatureGuard \n      companyProfile={companyProfile}\n      hasAccess={hasAccess}\n      isExpired={isExpired}\n      feature={txtServiceManagementFeature}\n      isLoading={loadingAccess}\n    >\n    <div className=\"bg-gradient-to-br from-slate-50 via-blue-50 to-sky-50\">\n      {isExpired && <ExpiredBanner companyProfileId={companyProfile?.id} />}\n      <div className=\"max-w-6xl mx-auto px-2 sm:px-4 lg:px-8 py-2 sm:py-3 lg:py-6\">\n        <div className=\"flex items-center justify-between gap-2 lg:gap-4 mb-2 sm:mb-3 lg:mb-6\">\n          <div className=\"flex items-center gap-2 lg:gap-3 min-w-0\">\n            <Button\n              variant=\"ghost\"\n              size=\"sm\"\n              className=\"h-7 w-7 lg:h-10 lg:w-10 p-0 flex-shrink-0\"\n              onClick={() => navigate(createPageUrl(\"BusinessDashboard\"))}\n            >\n              <ArrowLeft className=\"w-4 h-4 lg:w-5 lg:h-5\" />\n            </Button>\n            <div className=\"min-w-0\">\n              <h1 className=\"text-sm sm:text-base lg:text-2xl xl:text-3xl font-bold text-slate-900 truncate\">{txtServiceManagement}</h1>\n              <p className=\"text-[10px] sm:text-xs lg:text-base text-slate-500 truncate hidden sm:block\">{txtCreateManageServices}</p>\n            </div>\n          </div>\n          {!showForm && !isExpired && (\n            <Button \n              size=\"sm\" \n              onClick={() => { setEditingService(null); setShowForm(true); }} \n              className=\"gap-1 lg:gap-2 h-7 lg:h-10 text-xs lg:text-sm px-2 lg:px-4 flex-shrink-0\"\n            >\n              <Plus className=\"w-3 h-3 lg:w-4 lg:h-4\" />\n              <span className=\"hidden sm:inline\">{txtNewService}</span>\n              <span className=\"sm:hidden\">+</span>\n            </Button>\n          )}\n        </div>\n\n        {showForm && (\n          <div className=\"mb-3\">\n            <ServiceForm\n              service={editingService}\n              businessId={user.business_id}\n              onClose={handleCloseForm}\n            />\n          </div>\n        )}\n\n        {!showForm && services.length === 0 ? (\n          <EmptyState\n            icon={Calendar}\n            title={txtNoServicesCreated}\n            description={txtCreateFirstServiceDesc}\n            action={{\n              label: txtCreateFirstService,\n              onClick: () => setShowForm(true)\n            }}\n          />\n        ) : !showForm && (\n          <div className=\"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-2 lg:gap-4\">\n            {services.map(service => (\n              <Card key={service.id} className=\"border-0 shadow-sm lg:shadow-md hover:shadow-md lg:hover:shadow-lg transition-all\">\n                <CardContent className=\"p-3 lg:p-5\">\n                  <div className=\"flex justify-between items-start gap-2 lg:gap-3 mb-2 lg:mb-3\">\n                    <div className=\"min-w-0 flex-1\">\n                      <h3 className=\"font-semibold text-sm lg:text-lg text-slate-900 truncate\">{service.name}</h3>\n                      {service.description && (\n                        <p className=\"text-[10px] lg:text-sm text-slate-500 line-clamp-1\">{service.description}</p>\n                      )}\n                    </div>\n                    {service.price && service.price > 0 && (\n                      <Badge className=\"bg-sky-100 text-sky-700 border-sky-200 text-xs lg:text-sm flex-shrink-0\">\n                        €{service.price.toFixed(2)}\n                      </Badge>\n                    )}\n                  </div>\n\n                  <div className=\"flex items-center gap-2 lg:gap-3 mb-2 lg:mb-3\">\n                    <div className=\"flex items-center gap-1 lg:gap-2 text-slate-600\">\n                      <Calendar className=\"w-3 h-3 lg:w-4 lg:h-4\" />\n                      <span className=\"text-xs lg:text-sm\">{service.duration} min</span>\n                    </div>\n                    {service.category && (\n                      <Badge variant=\"secondary\" className=\"text-[10px] lg:text-xs h-4 lg:h-6 px-1 lg:px-2\">{service.category}</Badge>\n                    )}\n                  </div>\n\n                  {service.working_hours && Object.keys(service.working_hours).length > 0 && (\n                    <div className=\"mb-2 lg:mb-3 pb-2 lg:pb-3 border-b\">\n                      <p className=\"text-[9px] lg:text-xs text-slate-400 mb-1 lg:mb-2\">{txtAvailableDays}</p>\n                      <div className=\"flex flex-wrap gap-0.5 lg:gap-1\">\n                        {Object.keys(service.working_hours).map(day => (\n                          <Badge key={day} variant=\"outline\" className=\"text-[9px] lg:text-xs h-4 lg:h-6 px-1 lg:px-2\">\n                            {daysOfWeekMap[day]?.substring(0, 3)}\n                          </Badge>\n                        ))}\n                      </div>\n                    </div>\n                  )}\n\n                  {!isExpired && (\n                    <div className=\"flex gap-1.5\">\n                      <Button\n                        variant=\"outline\"\n                        size=\"sm\"\n                        className=\"flex-1 h-7 text-xs\"\n                        onClick={() => handleEdit(service)}\n                      >\n                        <Edit className=\"w-3 h-3 mr-1\" />\n                        {txtEdit}\n                      </Button>\n                      <Button\n                        variant=\"outline\"\n                        size=\"sm\"\n                        className=\"h-7 w-7 p-0 border-red-200 text-red-600 hover:bg-red-50\"\n                        onClick={() => handleDelete(service.id)}\n                      >\n                        <Trash2 className=\"w-3 h-3\" />\n                      </Button>\n                    </div>\n                  )}\n                </CardContent>\n              </Card>\n            ))}\n          </div>\n        )}\n      </div>\n      <ConfirmDialog />\n    </div>\n    </BusinessFeatureGuard>\n  );\n}\n","path":null,"size_bytes":11206,"size_tokens":null},"src/components/business/SMSGatewayConfig.jsx":{"content":"import React, { useState } from \"react\";\nimport { base44 } from \"@/api/base44Client\";\nimport { useMutation, useQueryClient } from \"@tanstack/react-query\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Label } from \"@/components/ui/label\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Tabs, TabsList, TabsTrigger, TabsContent } from \"@/components/ui/tabs\";\nimport { MessageSquare, CheckCircle2, AlertCircle, Smartphone, Send } from \"lucide-react\";\nimport {\n  Select,\n  SelectContent,\n  SelectItem,\n  SelectTrigger,\n  SelectValue,\n} from \"@/components/ui/select\";\nimport { useAutoTranslate } from \"@/hooks/useTranslate\";\n\nexport default function SMSGatewayConfig({ business }) {\n  const txtSMSConfig = useAutoTranslate('Configuração de SMS', 'pt');\n  const txtConfigured = useAutoTranslate('Configurado', 'pt');\n  const txtAboutSMS = useAutoTranslate('Sobre Notificações SMS', 'pt');\n  const txtAboutSMSDesc = useAutoTranslate('Configure um gateway SMS para enviar notificações automáticas aos seus clientes quando a senha for chamada, avisos de proximidade e lembretes de marcações.', 'pt');\n  const txtTwilioDesc = useAutoTranslate('Twilio: Plataforma global com cobertura em 180+ países', 'pt');\n  const txtVonageDesc = useAutoTranslate('Vonage: Anteriormente Nexmo, preços competitivos', 'pt');\n  const txtGatewaySMS = useAutoTranslate('Gateway SMS', 'pt');\n  const txtSelectGateway = useAutoTranslate('Selecione um gateway', 'pt');\n  const txtNoneEmailOnly = useAutoTranslate('Nenhum (apenas email)', 'pt');\n  const txtGetCredentials = useAutoTranslate('Obtenha as suas credenciais no', 'pt');\n  const txtPhoneNumber = useAutoTranslate('Número de Telefone', 'pt');\n  const txtTwilioPhone = useAutoTranslate('Número de Telefone Twilio', 'pt');\n  const txtInternationalFormat = useAutoTranslate('Formato internacional com código do país', 'pt');\n  const txtSaving = useAutoTranslate('A guardar...', 'pt');\n  const txtSaveConfig = useAutoTranslate('Guardar Configuração', 'pt');\n  const txtTestSMS = useAutoTranslate('Testar Envio de SMS', 'pt');\n  const txtSending = useAutoTranslate('Enviando...', 'pt');\n  const txtTest = useAutoTranslate('Testar', 'pt');\n  const txtTestSuccess = useAutoTranslate('SMS de teste enviado com sucesso! (Simulação - configure as chaves de API para envio real)', 'pt');\n  const txtTestError = useAutoTranslate('Erro ao enviar SMS de teste. Verifique as configurações.', 'pt');\n  const txtImportant = useAutoTranslate('Importante', 'pt');\n  const txtCredentialsSecure = useAutoTranslate('As credenciais são armazenadas de forma segura', 'pt');\n  const txtSMSCosts = useAutoTranslate('Custos de SMS aplicados conforme tarifário do gateway', 'pt');\n  const txtTestBefore = useAutoTranslate('Teste sempre antes de ativar para clientes', 'pt');\n  const txtCheckCredits = useAutoTranslate('Certifique-se de que tem créditos no gateway escolhido', 'pt');\n  const queryClient = useQueryClient();\n  const [gateway, setGateway] = useState(business?.sms_gateway || 'none');\n  const [config, setConfig] = useState(business?.sms_config || {});\n  const [testPhone, setTestPhone] = useState('');\n  const [testResult, setTestResult] = useState(null);\n\n  const updateMutation = useMutation({\n    mutationFn: async (data) => {\n      await base44.entities.Business.update(business.id, data);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['business'] });\n    },\n  });\n\n  const handleSave = () => {\n    updateMutation.mutate({\n      sms_gateway: gateway,\n      sms_config: config\n    });\n  };\n\n  const handleTest = async () => {\n    setTestResult({ status: 'loading' });\n    \n    try {\n      // Simulate SMS sending via configured gateway\n      const message = `Teste de SMS da ${business.name}. Gateway: ${gateway}`;\n      \n      // In production, this would call the actual SMS API\n      // For now, we'll send an email as fallback\n      await base44.integrations.Core.SendEmail({\n        to: business.email,\n        subject: 'Teste de SMS',\n        body: `[SMS TESTE] Para: ${testPhone}\\nMensagem: ${message}\\n\\nGateway: ${gateway}\\nConfiguração: ${gateway === 'twilio' ? `SID: ${config.twilio_account_sid?.slice(0, 8)}...` : `API Key: ${config.vonage_api_key?.slice(0, 8)}...`}`\n      });\n      \n      setTestResult({ \n        status: 'success', \n        message: txtTestSuccess \n      });\n    } catch (error) {\n      setTestResult({ \n        status: 'error', \n        message: txtTestError \n      });\n    }\n  };\n\n  const isConfigured = gateway !== 'none' && (\n    (gateway === 'twilio' && config.twilio_account_sid && config.twilio_auth_token && config.twilio_phone_number) ||\n    (gateway === 'vonage' && config.vonage_api_key && config.vonage_api_secret && config.vonage_phone_number)\n  );\n\n  return (\n    <Card className=\"border-0 shadow-lg\">\n      <CardHeader>\n        <div className=\"flex items-center justify-between\">\n          <CardTitle className=\"flex items-center gap-2\">\n            <Smartphone className=\"w-5 h-5\" />\n            {txtSMSConfig}\n          </CardTitle>\n          {isConfigured && (\n            <Badge className=\"bg-green-100 text-green-700 border-green-200\">\n              <CheckCircle2 className=\"w-3 h-3 mr-1\" />\n              {txtConfigured}\n            </Badge>\n          )}\n        </div>\n      </CardHeader>\n\n      <CardContent className=\"space-y-6\">\n        <div className=\"p-4 bg-blue-50 border border-blue-200 rounded-xl\">\n          <h5 className=\"font-semibold text-blue-900 mb-2 flex items-center gap-2\">\n            <MessageSquare className=\"w-4 h-4\" />\n            {txtAboutSMS}\n          </h5>\n          <p className=\"text-sm text-blue-800 mb-2\">\n            {txtAboutSMSDesc}\n          </p>\n          <ul className=\"text-sm text-blue-700 space-y-1 ml-4\">\n            <li>• {txtTwilioDesc}</li>\n            <li>• {txtVonageDesc}</li>\n          </ul>\n        </div>\n\n        <div>\n          <Label htmlFor=\"gateway\">{txtGatewaySMS}</Label>\n          <Select value={gateway} onValueChange={setGateway}>\n            <SelectTrigger>\n              <SelectValue placeholder={txtSelectGateway} />\n            </SelectTrigger>\n            <SelectContent>\n              <SelectItem value=\"none\">{txtNoneEmailOnly}</SelectItem>\n              <SelectItem value=\"twilio\">Twilio</SelectItem>\n              <SelectItem value=\"vonage\">Vonage (Nexmo)</SelectItem>\n            </SelectContent>\n          </Select>\n        </div>\n\n        {gateway !== 'none' && (\n          <Tabs value={gateway} className=\"w-full\">\n            <TabsContent value=\"twilio\" className=\"space-y-4 mt-4\">\n              <div className=\"p-4 bg-slate-50 rounded-xl space-y-4\">\n                <div className=\"flex items-start gap-2 text-sm text-slate-600 mb-3\">\n                  <AlertCircle className=\"w-4 h-4 mt-0.5 flex-shrink-0\" />\n                  <p>\n                    {txtGetCredentials} <a href=\"https://console.twilio.com\" target=\"_blank\" rel=\"noopener noreferrer\" className=\"text-blue-600 underline\">Console Twilio</a>\n                  </p>\n                </div>\n\n                <div>\n                  <Label htmlFor=\"twilio_sid\">Account SID</Label>\n                  <Input\n                    id=\"twilio_sid\"\n                    type=\"password\"\n                    value={config.twilio_account_sid || ''}\n                    onChange={(e) => setConfig({ ...config, twilio_account_sid: e.target.value })}\n                    placeholder=\"ACxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx\"\n                  />\n                </div>\n\n                <div>\n                  <Label htmlFor=\"twilio_token\">Auth Token</Label>\n                  <Input\n                    id=\"twilio_token\"\n                    type=\"password\"\n                    value={config.twilio_auth_token || ''}\n                    onChange={(e) => setConfig({ ...config, twilio_auth_token: e.target.value })}\n                    placeholder=\"********************************\"\n                  />\n                </div>\n\n                <div>\n                  <Label htmlFor=\"twilio_phone\">{txtTwilioPhone}</Label>\n                  <Input\n                    id=\"twilio_phone\"\n                    value={config.twilio_phone_number || ''}\n                    onChange={(e) => setConfig({ ...config, twilio_phone_number: e.target.value })}\n                    placeholder=\"+351912345678\"\n                  />\n                  <p className=\"text-xs text-slate-500 mt-1\">\n                    {txtInternationalFormat}\n                  </p>\n                </div>\n              </div>\n            </TabsContent>\n\n            <TabsContent value=\"vonage\" className=\"space-y-4 mt-4\">\n              <div className=\"p-4 bg-slate-50 rounded-xl space-y-4\">\n                <div className=\"flex items-start gap-2 text-sm text-slate-600 mb-3\">\n                  <AlertCircle className=\"w-4 h-4 mt-0.5 flex-shrink-0\" />\n                  <p>\n                    {txtGetCredentials} <a href=\"https://dashboard.nexmo.com\" target=\"_blank\" rel=\"noopener noreferrer\" className=\"text-blue-600 underline\">Dashboard Vonage</a>\n                  </p>\n                </div>\n\n                <div>\n                  <Label htmlFor=\"vonage_key\">API Key</Label>\n                  <Input\n                    id=\"vonage_key\"\n                    type=\"password\"\n                    value={config.vonage_api_key || ''}\n                    onChange={(e) => setConfig({ ...config, vonage_api_key: e.target.value })}\n                    placeholder=\"xxxxxxxx\"\n                  />\n                </div>\n\n                <div>\n                  <Label htmlFor=\"vonage_secret\">API Secret</Label>\n                  <Input\n                    id=\"vonage_secret\"\n                    type=\"password\"\n                    value={config.vonage_api_secret || ''}\n                    onChange={(e) => setConfig({ ...config, vonage_api_secret: e.target.value })}\n                    placeholder=\"********************************\"\n                  />\n                </div>\n\n                <div>\n                  <Label htmlFor=\"vonage_phone\">{txtPhoneNumber}</Label>\n                  <Input\n                    id=\"vonage_phone\"\n                    value={config.vonage_phone_number || ''}\n                    onChange={(e) => setConfig({ ...config, vonage_phone_number: e.target.value })}\n                    placeholder=\"+351912345678\"\n                  />\n                  <p className=\"text-xs text-slate-500 mt-1\">\n                    {txtInternationalFormat}\n                  </p>\n                </div>\n              </div>\n            </TabsContent>\n          </Tabs>\n        )}\n\n        <Button\n          onClick={handleSave}\n          disabled={updateMutation.isPending}\n          className=\"w-full\"\n        >\n          {updateMutation.isPending ? txtSaving : txtSaveConfig}\n        </Button>\n\n        {/* Test SMS */}\n        {isConfigured && (\n          <div className=\"p-4 bg-slate-50 rounded-xl space-y-4\">\n            <h4 className=\"font-semibold text-slate-900\">{txtTestSMS}</h4>\n            <div className=\"flex gap-2\">\n              <Input\n                value={testPhone}\n                onChange={(e) => setTestPhone(e.target.value)}\n                placeholder=\"+351912345678\"\n                className=\"flex-1\"\n              />\n              <Button\n                onClick={handleTest}\n                disabled={!testPhone || testResult?.status === 'loading'}\n              >\n                <Send className=\"w-4 h-4 mr-2\" />\n                {testResult?.status === 'loading' ? txtSending : txtTest}\n              </Button>\n            </div>\n            {testResult && testResult.status !== 'loading' && (\n              <div className={`p-3 rounded-lg ${\n                testResult.status === 'success' \n                  ? 'bg-green-50 border border-green-200 text-green-800'\n                  : 'bg-red-50 border border-red-200 text-red-800'\n              }`}>\n                <p className=\"text-sm\">{testResult.message}</p>\n              </div>\n            )}\n          </div>\n        )}\n\n        <div className=\"p-4 bg-amber-50 border border-amber-200 rounded-xl\">\n          <h5 className=\"font-semibold text-amber-900 mb-2 flex items-center gap-2\">\n            <AlertCircle className=\"w-4 h-4\" />\n            {txtImportant}\n          </h5>\n          <ul className=\"text-sm text-amber-800 space-y-1\">\n            <li>• {txtCredentialsSecure}</li>\n            <li>• {txtSMSCosts}</li>\n            <li>• {txtTestBefore}</li>\n            <li>• {txtCheckCredits}</li>\n          </ul>\n        </div>\n      </CardContent>\n    </Card>\n  );\n}","path":null,"size_bytes":12738,"size_tokens":null},"src/components/ui/button.jsx":{"content":"import * as React from \"react\"\nimport { Slot } from \"@radix-ui/react-slot\"\nimport { cva } from \"class-variance-authority\";\nimport { Loader2 } from \"lucide-react\";\n\nimport { cn } from \"@/lib/utils\"\n\nconst buttonVariants = cva(\n  \"inline-flex items-center justify-center gap-2 whitespace-nowrap rounded-md text-sm font-medium transition-all duration-300 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0\",\n  {\n    variants: {\n      variant: {\n        default:\n          \"bg-primary text-primary-foreground shadow-sm hover:bg-primary/90 hover:shadow-md active:scale-[0.98]\",\n        destructive:\n          \"bg-destructive text-destructive-foreground shadow-sm hover:bg-destructive/90 hover:shadow-md active:scale-[0.98]\",\n        outline:\n          \"border border-input bg-background shadow-sm hover:bg-accent hover:text-accent-foreground hover:border-primary/30 active:scale-[0.98]\",\n        secondary:\n          \"bg-secondary text-secondary-foreground shadow-sm hover:bg-secondary/80 hover:shadow-md active:scale-[0.98]\",\n        ghost: \"hover:bg-accent hover:text-accent-foreground active:scale-[0.98]\",\n        link: \"text-primary underline-offset-4 hover:underline\",\n        gradient:\n          \"bg-gradient-to-r from-purple-600 to-blue-600 text-white shadow-md hover:shadow-lg hover:from-purple-700 hover:to-blue-700 hover:-translate-y-0.5 active:translate-y-0\",\n      },\n      size: {\n        default: \"h-9 px-4 py-2\",\n        sm: \"h-8 rounded-md px-3 text-xs\",\n        lg: \"h-10 rounded-md px-6 sm:px-8\",\n        xl: \"h-11 rounded-lg px-6 text-sm sm:h-12 sm:px-10 sm:text-base\",\n        icon: \"h-9 w-9\",\n      },\n    },\n    defaultVariants: {\n      variant: \"default\",\n      size: \"default\",\n    },\n  }\n)\n\nconst Button = React.forwardRef(({ className, variant, size, asChild = false, isLoading, children, ...props }, ref) => {\n  const Comp = asChild ? Slot : \"button\"\n  return (\n    (<Comp\n      className={cn(buttonVariants({ variant, size, className }))}\n      ref={ref}\n      disabled={isLoading || props.disabled}\n      {...props}>\n      {isLoading && <Loader2 className=\"animate-spin\" />}\n      {children}\n    </Comp>)\n  );\n})\nButton.displayName = \"Button\"\n\nexport { Button, buttonVariants }\n","path":null,"size_bytes":2361,"size_tokens":null},"src/components/ui/input-otp.jsx":{"content":"import * as React from \"react\"\nimport { OTPInput, OTPInputContext } from \"input-otp\"\nimport { Minus } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst InputOTP = React.forwardRef(({ className, containerClassName, ...props }, ref) => (\n  <OTPInput\n    ref={ref}\n    containerClassName={cn(\"flex items-center gap-2 has-[:disabled]:opacity-50\", containerClassName)}\n    className={cn(\"disabled:cursor-not-allowed\", className)}\n    {...props} />\n))\nInputOTP.displayName = \"InputOTP\"\n\nconst InputOTPGroup = React.forwardRef(({ className, ...props }, ref) => (\n  <div ref={ref} className={cn(\"flex items-center\", className)} {...props} />\n))\nInputOTPGroup.displayName = \"InputOTPGroup\"\n\nconst InputOTPSlot = React.forwardRef(({ index, className, ...props }, ref) => {\n  const inputOTPContext = React.useContext(OTPInputContext)\n  const { char, hasFakeCaret, isActive } = inputOTPContext.slots[index]\n\n  return (\n    (<div\n      ref={ref}\n      className={cn(\n        \"relative flex h-9 w-9 items-center justify-center border-y border-r border-input text-sm shadow-sm transition-all first:rounded-l-md first:border-l last:rounded-r-md\",\n        isActive && \"z-10 ring-1 ring-ring\",\n        className\n      )}\n      {...props}>\n      {char}\n      {hasFakeCaret && (\n        <div\n          className=\"pointer-events-none absolute inset-0 flex items-center justify-center\">\n          <div className=\"h-4 w-px animate-caret-blink bg-foreground duration-1000\" />\n        </div>\n      )}\n    </div>)\n  );\n})\nInputOTPSlot.displayName = \"InputOTPSlot\"\n\nconst InputOTPSeparator = React.forwardRef(({ ...props }, ref) => (\n  <div ref={ref} role=\"separator\" {...props}>\n    <Minus />\n  </div>\n))\nInputOTPSeparator.displayName = \"InputOTPSeparator\"\n\nexport { InputOTP, InputOTPGroup, InputOTPSlot, InputOTPSeparator }\n","path":null,"size_bytes":1811,"size_tokens":null},"src/components/business/MessageTemplates.jsx":{"content":"import React, { useState } from \"react\";\nimport { base44 } from \"@/api/base44Client\";\nimport { useMutation, useQueryClient } from \"@tanstack/react-query\";\nimport { Button } from \"@/components/ui/button\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport { Label } from \"@/components/ui/label\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Tabs, TabsList, TabsTrigger, TabsContent } from \"@/components/ui/tabs\";\nimport { Mail, MessageSquare, Save } from \"lucide-react\";\nimport { toast } from \"sonner\";\nimport { useAutoTranslate } from \"@/hooks/useTranslate\";\n\nexport default function MessageTemplates({ business }) {\n  const txtMessageTemplates = useAutoTranslate('Templates de Mensagens', 'pt');\n  const txtAvailableVariables = useAutoTranslate('Variáveis Disponíveis:', 'pt');\n  const txtConfirmationEmail = useAutoTranslate('Email de Confirmação', 'pt');\n  const txtReminderEmail = useAutoTranslate('Email de Lembrete', 'pt');\n  const txtConfirmationSMS = useAutoTranslate('SMS de Confirmação (max 160 caracteres)', 'pt');\n  const txtReminderSMS = useAutoTranslate('SMS de Lembrete (max 160 caracteres)', 'pt');\n  const txtCharacters = useAutoTranslate('caracteres', 'pt');\n  const txtSaveTemplates = useAutoTranslate('Guardar Templates', 'pt');\n  const txtTemplatesSaved = useAutoTranslate('Templates guardados com sucesso!', 'pt');\n  const queryClient = useQueryClient();\n  const [confirmationEmail, setConfirmationEmail] = useState(\n    business.confirmation_email_template || \n    `Olá!\\n\\nA sua marcação foi confirmada.\\n\\nDetalhes:\\nServiço: {{service_name}}\\nData: {{date}}\\nHora: {{time}}\\nEmpresa: {{business_name}}\\n\\nPara reagendar ou cancelar, clique aqui: {{management_link}}\\n\\nObrigado!`\n  );\n  \n  const [reminderEmail, setReminderEmail] = useState(\n    business.reminder_email_template ||\n    `Olá!\\n\\nLembramos que tem uma marcação amanhã:\\n\\nServiço: {{service_name}}\\nData: {{date}}\\nHora: {{time}}\\nLocal: {{business_name}}\\n\\nVemo-nos em breve!`\n  );\n\n  const [confirmationSMS, setConfirmationSMS] = useState(\n    business.confirmation_sms_template ||\n    `Marcação confirmada! {{service_name}} em {{date}} às {{time}}. Gerir: {{management_link}}`\n  );\n\n  const [reminderSMS, setReminderSMS] = useState(\n    business.reminder_sms_template ||\n    `Lembrete: {{service_name}} amanhã às {{time}} em {{business_name}}`\n  );\n\n  const saveMutation = useMutation({\n    mutationFn: async (templates) => {\n      return await base44.entities.Business.update(business.id, templates);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['business'] });\n      toast.success(txtTemplatesSaved);\n    },\n  });\n\n  const handleSave = () => {\n    saveMutation.mutate({\n      confirmation_email_template: confirmationEmail,\n      reminder_email_template: reminderEmail,\n      confirmation_sms_template: confirmationSMS,\n      reminder_sms_template: reminderSMS\n    });\n  };\n\n  return (\n    <Card className=\"border-0 shadow-lg\">\n      <CardHeader>\n        <CardTitle>{txtMessageTemplates}</CardTitle>\n      </CardHeader>\n      <CardContent className=\"space-y-6\">\n        <div className=\"p-4 bg-blue-50 border border-blue-200 rounded-lg\">\n          <h4 className=\"font-semibold text-blue-900 mb-2\">{txtAvailableVariables}</h4>\n          <div className=\"grid grid-cols-2 gap-2 text-sm text-blue-700\">\n            <Badge variant=\"outline\">{'{{business_name}}'}</Badge>\n            <Badge variant=\"outline\">{'{{service_name}}'}</Badge>\n            <Badge variant=\"outline\">{'{{date}}'}</Badge>\n            <Badge variant=\"outline\">{'{{time}}'}</Badge>\n            <Badge variant=\"outline\">{'{{client_name}}'}</Badge>\n            <Badge variant=\"outline\">{'{{management_link}}'}</Badge>\n          </div>\n        </div>\n\n        <Tabs defaultValue=\"email\">\n          <TabsList className=\"grid grid-cols-2 w-full\">\n            <TabsTrigger value=\"email\">\n              <Mail className=\"w-4 h-4 mr-2\" />\n              Email\n            </TabsTrigger>\n            <TabsTrigger value=\"sms\">\n              <MessageSquare className=\"w-4 h-4 mr-2\" />\n              SMS\n            </TabsTrigger>\n          </TabsList>\n\n          <TabsContent value=\"email\" className=\"space-y-4\">\n            <div>\n              <Label>{txtConfirmationEmail}</Label>\n              <Textarea\n                value={confirmationEmail}\n                onChange={(e) => setConfirmationEmail(e.target.value)}\n                rows={8}\n                className=\"font-mono text-sm\"\n              />\n            </div>\n            <div>\n              <Label>{txtReminderEmail}</Label>\n              <Textarea\n                value={reminderEmail}\n                onChange={(e) => setReminderEmail(e.target.value)}\n                rows={6}\n                className=\"font-mono text-sm\"\n              />\n            </div>\n          </TabsContent>\n\n          <TabsContent value=\"sms\" className=\"space-y-4\">\n            <div>\n              <Label>{txtConfirmationSMS}</Label>\n              <Textarea\n                value={confirmationSMS}\n                onChange={(e) => setConfirmationSMS(e.target.value)}\n                rows={3}\n                maxLength={160}\n                className=\"font-mono text-sm\"\n              />\n              <p className=\"text-xs text-slate-500 mt-1\">\n                {confirmationSMS.length}/160 {txtCharacters}\n              </p>\n            </div>\n            <div>\n              <Label>{txtReminderSMS}</Label>\n              <Textarea\n                value={reminderSMS}\n                onChange={(e) => setReminderSMS(e.target.value)}\n                rows={3}\n                maxLength={160}\n                className=\"font-mono text-sm\"\n              />\n              <p className=\"text-xs text-slate-500 mt-1\">\n                {reminderSMS.length}/160 {txtCharacters}\n              </p>\n            </div>\n          </TabsContent>\n        </Tabs>\n\n        <Button\n          onClick={handleSave}\n          disabled={saveMutation.isPending}\n          className=\"w-full bg-gradient-to-r from-sky-600 to-blue-600 hover:from-sky-700 hover:to-blue-700\"\n        >\n          <Save className=\"w-4 h-4 mr-2\" />\n          {txtSaveTemplates}\n        </Button>\n      </CardContent>\n    </Card>\n  );\n}","path":null,"size_bytes":6338,"size_tokens":null},"src/components/business/BusinessInfo.jsx":{"content":"import React from \"react\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { MapPin, Phone, Mail, Clock, Navigation } from \"lucide-react\";\nimport { Button } from \"@/components/ui/button\";\nimport { useAutoTranslate } from \"@/hooks/useTranslate\";\n\nexport default function BusinessInfo({ business }) {\n  // Traduções\n  const txtSunday = useAutoTranslate('Domingo', 'pt');\n  const txtMonday = useAutoTranslate('Segunda-feira', 'pt');\n  const txtTuesday = useAutoTranslate('Terça-feira', 'pt');\n  const txtWednesday = useAutoTranslate('Quarta-feira', 'pt');\n  const txtThursday = useAutoTranslate('Quinta-feira', 'pt');\n  const txtFriday = useAutoTranslate('Sexta-feira', 'pt');\n  const txtSaturday = useAutoTranslate('Sábado', 'pt');\n  const txtLocation = useAutoTranslate('Localização', 'pt');\n  const txtAddressNotAvailable = useAutoTranslate('Morada não disponível', 'pt');\n  const txtOpenInMaps = useAutoTranslate('Abrir no Google Maps', 'pt');\n  const txtContacts = useAutoTranslate('Contactos', 'pt');\n  const txtWorkingHours = useAutoTranslate('Horário de Funcionamento', 'pt');\n  const txtToday = useAutoTranslate('Hoje', 'pt');\n  const txtClosed = useAutoTranslate('Fechado', 'pt');\n\n  const DAYS = [txtSunday, txtMonday, txtTuesday, txtWednesday, txtThursday, txtFriday, txtSaturday];\n  const openMaps = () => {\n    if (business.latitude && business.longitude) {\n      window.open(`https://www.google.com/maps?q=${business.latitude},${business.longitude}`, '_blank');\n    } else if (business.address) {\n      window.open(`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(business.address)}`, '_blank');\n    }\n  };\n\n  const callPhone = () => {\n    if (business.phone) {\n      window.location.href = `tel:${business.phone}`;\n    }\n  };\n\n  const sendEmail = () => {\n    if (business.email) {\n      window.location.href = `mailto:${business.email}`;\n    }\n  };\n\n  const today = new Date().getDay();\n  const todayHours = business.working_hours?.[today];\n\n  return (\n    <div className=\"space-y-2\">\n      <Card className=\"border-0 shadow-md\">\n        <CardHeader className=\"pb-2\">\n          <CardTitle className=\"text-sm flex items-center gap-1\">\n            <MapPin className=\"w-4 h-4 text-sky-600\" />\n            {txtLocation}\n          </CardTitle>\n        </CardHeader>\n        <CardContent>\n          <p className=\"text-sm text-slate-700 mb-3 leading-relaxed\">{business.address || txtAddressNotAvailable}</p>\n          <Button \n            size=\"sm\" \n            variant=\"outline\" \n            className=\"w-full h-8 text-xs font-medium hover:bg-blue-50 hover:text-blue-700 hover:border-blue-300 transition-colors\" \n            onClick={openMaps}\n          >\n            <Navigation className=\"w-3.5 h-3.5 mr-1.5\" />\n            {txtOpenInMaps}\n          </Button>\n        </CardContent>\n      </Card>\n\n      <Card className=\"border-0 shadow-md\">\n        <CardHeader className=\"pb-2\">\n          <CardTitle className=\"text-sm flex items-center gap-1\">\n            <Phone className=\"w-4 h-4 text-sky-600\" />\n            {txtContacts}\n          </CardTitle>\n        </CardHeader>\n        <CardContent className=\"space-y-1.5\">\n          {business.phone && (\n            <Button \n              size=\"sm\" \n              variant=\"outline\" \n              className=\"w-full h-7 text-xs justify-start\"\n              onClick={callPhone}\n            >\n              <Phone className=\"w-3 h-3 mr-1.5\" />\n              {business.phone}\n            </Button>\n          )}\n          {business.email && (\n            <Button \n              size=\"sm\" \n              variant=\"outline\" \n              className=\"w-full h-7 text-xs justify-start\"\n              onClick={sendEmail}\n            >\n              <Mail className=\"w-3 h-3 mr-1.5\" />\n              {business.email}\n            </Button>\n          )}\n        </CardContent>\n      </Card>\n\n      {business.working_hours && (\n        <Card className=\"border-0 shadow-md\">\n          <CardHeader className=\"pb-2\">\n            <CardTitle className=\"text-sm flex items-center gap-1\">\n              <Clock className=\"w-4 h-4 text-sky-600\" />\n              {txtWorkingHours}\n            </CardTitle>\n          </CardHeader>\n          <CardContent>\n            {todayHours && (\n              <div className=\"mb-2 p-2 bg-sky-50 rounded-lg\">\n                <p className=\"text-xs font-semibold text-sky-900\">{txtToday}</p>\n                <p className=\"text-xs text-sky-700\">\n                  {todayHours.closed ? txtClosed : `${todayHours.open} - ${todayHours.close}`}\n                </p>\n              </div>\n            )}\n            <div className=\"space-y-1\">\n              {DAYS.map((day, index) => {\n                const hours = business.working_hours[index];\n                if (!hours) return null;\n                return (\n                  <div key={index} className=\"flex justify-between text-xs\">\n                    <span className={`text-slate-700 ${index === today ? 'font-semibold' : ''}`}>\n                      {day}\n                    </span>\n                    <span className={`text-slate-600 ${index === today ? 'font-semibold text-sky-700' : ''}`}>\n                      {hours.closed ? txtClosed : `${hours.open} - ${hours.close}`}\n                    </span>\n                  </div>\n                );\n              })}\n            </div>\n          </CardContent>\n        </Card>\n      )}\n    </div>\n  );\n}","path":null,"size_bytes":5440,"size_tokens":null},"src/pages/Settings.jsx":{"content":"import React, { useState, useEffect } from \"react\";\nimport { base44 } from \"@/api/base44Client\";\nimport { useMutation, useQueryClient } from \"@tanstack/react-query\";\nimport { Button } from \"@/components/ui/button\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Input } from \"@/components/ui/input\";\nimport { Label } from \"@/components/ui/label\";\nimport { Globe, Check, ArrowLeft, Lock, Eye, EyeOff } from \"lucide-react\";\nimport { useNavigate } from \"react-router-dom\";\nimport { createPageUrl } from \"@/utils\";\nimport { useAutoTranslate } from \"@/hooks/useTranslate\";\nimport { toast } from \"sonner\";\n\nconst languages = [\n  { code: \"pt\", name: \"Português\", flag: \"🇵🇹\" },\n  { code: \"en\", name: \"English\", flag: \"🇬🇧\" },\n  { code: \"es\", name: \"Español\", flag: \"🇪🇸\" },\n  { code: \"fr\", name: \"Français\", flag: \"🇫🇷\" },\n  { code: \"de\", name: \"Deutsch\", flag: \"🇩🇪\" },\n  { code: \"it\", name: \"Italiano\", flag: \"🇮🇹\" },\n  { code: \"nl\", name: \"Nederlands\", flag: \"🇳🇱\" },\n  { code: \"pl\", name: \"Polski\", flag: \"🇵🇱\" },\n  { code: \"ru\", name: \"Русский\", flag: \"🇷🇺\" },\n  { code: \"zh\", name: \"中文\", flag: \"🇨🇳\" },\n  { code: \"ja\", name: \"日本語\", flag: \"🇯🇵\" },\n  { code: \"ko\", name: \"한국어\", flag: \"🇰🇷\" },\n  { code: \"ar\", name: \"العربية\", flag: \"🇸🇦\" },\n  { code: \"hi\", name: \"हिन्दी\", flag: \"🇮🇳\" },\n  { code: \"tr\", name: \"Türkçe\", flag: \"🇹🇷\" },\n  { code: \"sv\", name: \"Svenska\", flag: \"🇸🇪\" },\n  { code: \"no\", name: \"Norsk\", flag: \"🇳🇴\" },\n  { code: \"da\", name: \"Dansk\", flag: \"🇩🇰\" },\n  { code: \"fi\", name: \"Suomi\", flag: \"🇫🇮\" },\n  { code: \"el\", name: \"Ελληνικά\", flag: \"🇬🇷\" },\n  { code: \"cs\", name: \"Čeština\", flag: \"🇨🇿\" },\n  { code: \"hu\", name: \"Magyar\", flag: \"🇭🇺\" },\n  { code: \"ro\", name: \"Română\", flag: \"🇷🇴\" },\n  { code: \"th\", name: \"ไทย\", flag: \"🇹🇭\" },\n  { code: \"vi\", name: \"Tiếng Việt\", flag: \"🇻🇳\" },\n  { code: \"id\", name: \"Bahasa Indonesia\", flag: \"🇮🇩\" },\n  { code: \"ms\", name: \"Bahasa Melayu\", flag: \"🇲🇾\" },\n  { code: \"tl\", name: \"Tagalog\", flag: \"🇵🇭\" },\n  { code: \"uk\", name: \"Українська\", flag: \"🇺🇦\" },\n  { code: \"he\", name: \"עברית\", flag: \"🇮🇱\" },\n  { code: \"fa\", name: \"فارسی\", flag: \"🇮🇷\" },\n  { code: \"bn\", name: \"বাংলা\", flag: \"🇧🇩\" },\n  { code: \"ur\", name: \"اردو\", flag: \"🇵🇰\" },\n  { code: \"sw\", name: \"Kiswahili\", flag: \"🇰🇪\" },\n  { code: \"af\", name: \"Afrikaans\", flag: \"🇿🇦\" },\n];\n\nexport default function SettingsPage() {\n  const txtBack = useAutoTranslate('Anterior', 'pt');\n  const txtSettings = useAutoTranslate('Definições', 'pt');\n  const txtLanguageSettings = useAutoTranslate('Configurações de Idioma', 'pt');\n  const txtChooseLanguage = useAutoTranslate('Escolha o seu idioma preferido', 'pt');\n  const txtSelectedLanguage = useAutoTranslate('Idioma Selecionado', 'pt');\n  const txtCode = useAutoTranslate('Código', 'pt');\n  const txtSearchLanguages = useAutoTranslate('Procurar idiomas...', 'pt');\n  const txtAvailableLanguages = useAutoTranslate('Idiomas Disponíveis', 'pt');\n  const txtNoLanguageFound = useAutoTranslate('Nenhum idioma encontrado', 'pt');\n  const txtChangePassword = useAutoTranslate('Alterar Senha', 'pt');\n  const txtCurrentPassword = useAutoTranslate('Senha Atual', 'pt');\n  const txtNewPassword = useAutoTranslate('Nova Senha', 'pt');\n  const txtConfirmNewPassword = useAutoTranslate('Confirmar Nova Senha', 'pt');\n  const txtPasswordMinLength = useAutoTranslate('A senha deve ter pelo menos 6 caracteres', 'pt');\n  const txtPasswordsDoNotMatch = useAutoTranslate('As senhas não coincidem', 'pt');\n  const txtPasswordChanged = useAutoTranslate('Senha alterada com sucesso', 'pt');\n  const txtChangingPassword = useAutoTranslate('A alterar senha...', 'pt');\n  const txtSavePassword = useAutoTranslate('Guardar Nova Senha', 'pt');\n  const txtPasswordSecurity = useAutoTranslate('Segurança da Conta', 'pt');\n  const txtPasswordDescription = useAutoTranslate('Altere a sua senha para manter a conta segura', 'pt');\n\n  const navigate = useNavigate();\n  const queryClient = useQueryClient();\n  const [user, setUser] = useState(null);\n  const [selectedLanguage, setSelectedLanguage] = useState(\"pt\");\n  const [searchTerm, setSearchTerm] = useState(\"\");\n  \n  const [currentPassword, setCurrentPassword] = useState(\"\");\n  const [newPassword, setNewPassword] = useState(\"\");\n  const [confirmPassword, setConfirmPassword] = useState(\"\");\n  const [showCurrentPassword, setShowCurrentPassword] = useState(false);\n  const [showNewPassword, setShowNewPassword] = useState(false);\n  const [showConfirmPassword, setShowConfirmPassword] = useState(false);\n\n  useEffect(() => {\n    base44.auth.me().then(userData => {\n      setUser(userData);\n      setSelectedLanguage(userData.preferred_language || \"pt\");\n    }).catch(() => base44.auth.redirectToLogin());\n  }, []);\n\n  const updateLanguageMutation = useMutation({\n    mutationFn: async (languageCode) => {\n      await base44.auth.updateMe({ preferred_language: languageCode });\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries();\n    },\n  });\n\n  const changePasswordMutation = useMutation({\n    mutationFn: async () => {\n      return await base44.auth.changePassword(currentPassword, newPassword);\n    },\n    onSuccess: () => {\n      toast.success(txtPasswordChanged);\n      setCurrentPassword(\"\");\n      setNewPassword(\"\");\n      setConfirmPassword(\"\");\n    },\n    onError: (error) => {\n      toast.error(error.message);\n    },\n  });\n\n  const handleLanguageSelect = (code) => {\n    setSelectedLanguage(code);\n    updateLanguageMutation.mutate(code);\n  };\n\n  const handleChangePassword = (e) => {\n    e.preventDefault();\n    \n    if (newPassword.length < 6) {\n      toast.error(txtPasswordMinLength);\n      return;\n    }\n    \n    if (newPassword !== confirmPassword) {\n      toast.error(txtPasswordsDoNotMatch);\n      return;\n    }\n    \n    changePasswordMutation.mutate();\n  };\n\n  const filteredLanguages = languages.filter(lang => \n    lang.name.toLowerCase().includes(searchTerm.toLowerCase()) ||\n    lang.code.toLowerCase().includes(searchTerm.toLowerCase())\n  );\n\n  if (!user) return null;\n\n  return (\n    <div className=\"bg-gradient-to-br from-slate-50 via-blue-50 to-sky-50\">\n      <div className=\"max-w-5xl mx-auto px-4 py-4 sm:px-6 sm:py-6\">\n        <Button\n          variant=\"outline\"\n          className=\"mb-6 gap-2\"\n          onClick={() => navigate(createPageUrl(\"Home\"))}\n        >\n          <ArrowLeft className=\"w-4 h-4\" />\n          {txtBack}\n        </Button>\n\n        <div className=\"mb-8\">\n          <h1 className=\"text-4xl md:text-5xl font-bold text-slate-900 mb-3\">\n            {txtSettings}\n          </h1>\n          <p className=\"text-xl text-slate-600\">\n            {txtChooseLanguage}\n          </p>\n        </div>\n\n        <Card className=\"border-0 shadow-xl mb-6\">\n          <CardHeader className=\"border-b\">\n            <CardTitle className=\"flex items-center gap-2\">\n              <Lock className=\"w-5 h-5\" />\n              {txtPasswordSecurity}\n            </CardTitle>\n            <p className=\"text-sm text-slate-600 mt-1\">{txtPasswordDescription}</p>\n          </CardHeader>\n          <CardContent className=\"p-6\">\n            <form onSubmit={handleChangePassword} className=\"space-y-4\">\n              <div className=\"space-y-2\">\n                <Label htmlFor=\"currentPassword\">{txtCurrentPassword}</Label>\n                <div className=\"relative\">\n                  <Input\n                    id=\"currentPassword\"\n                    type={showCurrentPassword ? \"text\" : \"password\"}\n                    value={currentPassword}\n                    onChange={(e) => setCurrentPassword(e.target.value)}\n                    className=\"pr-10\"\n                    required\n                  />\n                  <button\n                    type=\"button\"\n                    onClick={() => setShowCurrentPassword(!showCurrentPassword)}\n                    className=\"absolute right-3 top-1/2 -translate-y-1/2 text-slate-400 hover:text-slate-600\"\n                  >\n                    {showCurrentPassword ? <EyeOff className=\"w-4 h-4\" /> : <Eye className=\"w-4 h-4\" />}\n                  </button>\n                </div>\n              </div>\n              \n              <div className=\"space-y-2\">\n                <Label htmlFor=\"newPassword\">{txtNewPassword}</Label>\n                <div className=\"relative\">\n                  <Input\n                    id=\"newPassword\"\n                    type={showNewPassword ? \"text\" : \"password\"}\n                    value={newPassword}\n                    onChange={(e) => setNewPassword(e.target.value)}\n                    className=\"pr-10\"\n                    required\n                    minLength={6}\n                  />\n                  <button\n                    type=\"button\"\n                    onClick={() => setShowNewPassword(!showNewPassword)}\n                    className=\"absolute right-3 top-1/2 -translate-y-1/2 text-slate-400 hover:text-slate-600\"\n                  >\n                    {showNewPassword ? <EyeOff className=\"w-4 h-4\" /> : <Eye className=\"w-4 h-4\" />}\n                  </button>\n                </div>\n              </div>\n              \n              <div className=\"space-y-2\">\n                <Label htmlFor=\"confirmPassword\">{txtConfirmNewPassword}</Label>\n                <div className=\"relative\">\n                  <Input\n                    id=\"confirmPassword\"\n                    type={showConfirmPassword ? \"text\" : \"password\"}\n                    value={confirmPassword}\n                    onChange={(e) => setConfirmPassword(e.target.value)}\n                    className=\"pr-10\"\n                    required\n                    minLength={6}\n                  />\n                  <button\n                    type=\"button\"\n                    onClick={() => setShowConfirmPassword(!showConfirmPassword)}\n                    className=\"absolute right-3 top-1/2 -translate-y-1/2 text-slate-400 hover:text-slate-600\"\n                  >\n                    {showConfirmPassword ? <EyeOff className=\"w-4 h-4\" /> : <Eye className=\"w-4 h-4\" />}\n                  </button>\n                </div>\n              </div>\n              \n              <Button \n                type=\"submit\" \n                className=\"w-full bg-gradient-to-r from-sky-500 to-blue-600 hover:from-sky-600 hover:to-blue-700\"\n                disabled={changePasswordMutation.isPending}\n              >\n                {changePasswordMutation.isPending ? txtChangingPassword : txtSavePassword}\n              </Button>\n            </form>\n          </CardContent>\n        </Card>\n\n        <Card className=\"border-0 shadow-xl mb-6\">\n          <CardHeader className=\"border-b\">\n            <CardTitle className=\"flex items-center gap-2\">\n              <Globe className=\"w-5 h-5\" />\n              {txtSelectedLanguage}\n            </CardTitle>\n          </CardHeader>\n          <CardContent className=\"p-6\">\n            <div className=\"flex items-center gap-4 p-4 bg-gradient-to-r from-sky-50 to-blue-50 rounded-xl border-2 border-sky-200\">\n              <div className=\"text-5xl\">\n                {languages.find(l => l.code === selectedLanguage)?.flag}\n              </div>\n              <div>\n                <div className=\"text-2xl font-bold text-slate-900\">\n                  {languages.find(l => l.code === selectedLanguage)?.name}\n                </div>\n                <div className=\"text-sm text-slate-600\">\n                  {txtCode}: {selectedLanguage.toUpperCase()}\n                </div>\n              </div>\n              <Check className=\"w-8 h-8 text-green-600 ml-auto\" />\n            </div>\n          </CardContent>\n        </Card>\n\n        <Card className=\"border-0 shadow-xl\">\n          <CardHeader className=\"border-b\">\n            <CardTitle>{txtAvailableLanguages}</CardTitle>\n            <div className=\"mt-4\">\n              <input\n                type=\"text\"\n                placeholder={txtSearchLanguages}\n                value={searchTerm}\n                onChange={(e) => setSearchTerm(e.target.value)}\n                className=\"w-full px-4 py-3 border border-slate-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-sky-500\"\n              />\n            </div>\n          </CardHeader>\n          <CardContent className=\"p-6\">\n            <div className=\"grid sm:grid-cols-2 md:grid-cols-3 gap-3 max-h-[600px] overflow-y-auto\">\n              {filteredLanguages.map((lang) => (\n                <button\n                  key={lang.code}\n                  onClick={() => handleLanguageSelect(lang.code)}\n                  className={`flex items-center gap-3 p-4 rounded-xl border-2 transition-all hover:shadow-md ${\n                    selectedLanguage === lang.code\n                      ? \"border-sky-500 bg-gradient-to-r from-sky-50 to-blue-50 shadow-md\"\n                      : \"border-slate-200 hover:border-slate-300 bg-white\"\n                  }`}\n                >\n                  <span className=\"text-3xl\">{lang.flag}</span>\n                  <div className=\"flex-1 text-left\">\n                    <div className=\"font-semibold text-slate-900\">\n                      {lang.name}\n                    </div>\n                    <div className=\"text-xs text-slate-500\">\n                      {lang.code.toUpperCase()}\n                    </div>\n                  </div>\n                  {selectedLanguage === lang.code && (\n                    <Check className=\"w-5 h-5 text-green-600\" />\n                  )}\n                </button>\n              ))}\n            </div>\n\n            {filteredLanguages.length === 0 && (\n              <div className=\"text-center py-12 text-slate-500\">\n                {txtNoLanguageFound}\n              </div>\n            )}\n          </CardContent>\n        </Card>\n      </div>\n    </div>\n  );\n}\n","path":null,"size_bytes":14001,"size_tokens":null},"src/pages/Home.jsx":{"content":"import React from \"react\";\nimport { base44 } from \"@/api/base44Client\";\nimport { useQuery } from \"@tanstack/react-query\";\nimport { useNavigate } from \"react-router-dom\";\nimport { createPageUrl } from \"@/utils\";\nimport { getUploadUrl } from \"@/utils/apiConfig\";\nimport { useAutoTranslate } from \"@/hooks/useTranslate\";\nimport { Button } from \"@/components/ui/button\";\nimport { Card, CardContent } from \"@/components/ui/card\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Input } from \"@/components/ui/input\";\nimport { \n  Clock, \n  Calendar, \n  TrendingUp, \n  Shield,\n  Search,\n  ArrowRight,\n  MapPin,\n  Star,\n  Sparkles\n} from \"lucide-react\";\nimport { Skeleton } from \"@/components/ui/skeleton\";\n\nexport default function HomePage() {\n  const navigate = useNavigate();\n  const [user, setUser] = React.useState(null);\n  const [searchTerm, setSearchTerm] = React.useState(\"\");\n\n  const txtSystemActive = useAutoTranslate('Sistema Ativo', 'pt');\n  const txtTitle = useAutoTranslate('Gestão de Filas e Marcações Simplificada', 'pt');\n  const txtSubtitle = useAutoTranslate('Elimine as filas e otimize o tempo dos seus clientes', 'pt');\n  const txtViewBusinesses = useAutoTranslate('Ver Empresas', 'pt');\n  const txtSearchPlaceholder = useAutoTranslate('Procurar empresas...', 'pt');\n  const txtAvailableBusinesses = useAutoTranslate('Empresas Disponíveis', 'pt');\n  const txtBusinessFound = useAutoTranslate('empresa encontrada', 'pt');\n  const txtBusinessesFound = useAutoTranslate('empresas encontradas', 'pt');\n  const txtNoBusinesses = useAutoTranslate('Nenhuma empresa encontrada', 'pt');\n  const txtAdjustFilters = useAutoTranslate('Tente ajustar os seus filtros de pesquisa', 'pt');\n  const txtReadyToStart = useAutoTranslate('Pronto para começar?', 'pt');\n  const txtJoinUsers = useAutoTranslate('Junte-se a milhares de utilizadores que já otimizaram o seu tempo', 'pt');\n  const txtNoQueuesTitle = useAutoTranslate('Sem Filas', 'pt');\n  const txtNoQueuesDesc = useAutoTranslate('Receba senhas virtuais e acompanhe em tempo real', 'pt');\n  const txtAppointmentsTitle = useAutoTranslate('Marcações Online', 'pt');\n  const txtAppointmentsDesc = useAutoTranslate('Agende serviços com facilidade', 'pt');\n  const txtRealTimeTitle = useAutoTranslate('Tempo Real', 'pt');\n  const txtRealTimeDesc = useAutoTranslate('Notificações instantâneas sobre o seu atendimento', 'pt');\n  const txtSecureTitle = useAutoTranslate('Seguro e Confiável', 'pt');\n  const txtSecureDesc = useAutoTranslate('Seus dados protegidos com tecnologia de ponta', 'pt');\n\n  React.useEffect(() => {\n    base44.auth.me().then(userData => {\n      setUser(userData);\n      \n      // Redirecionar se for conta empresarial pura\n      if (userData.account_type === 'empresa') {\n        navigate(createPageUrl(\"BusinessHome\"));\n      }\n    }).catch(() => {});\n  }, [navigate]);\n\n  const { data: businesses, isLoading } = useQuery({\n    queryKey: ['active-businesses'],\n    queryFn: () => base44.entities.Business.filter({ is_active: true }),\n    initialData: [],\n  });\n\n  const filteredBusinesses = businesses.filter(b => \n    // ✅ PROTEÇÃO: Verificar se business existe antes de acessar propriedades\n    b && b.name && (\n      b.name.toLowerCase().includes(searchTerm.toLowerCase()) ||\n      b.description?.toLowerCase().includes(searchTerm.toLowerCase())\n    )\n  );\n\n  const features = [\n    {\n      icon: Clock,\n      title: txtNoQueuesTitle,\n      description: txtNoQueuesDesc,\n      color: \"from-blue-500 to-cyan-500\"\n    },\n    {\n      icon: Calendar,\n      title: txtAppointmentsTitle,\n      description: txtAppointmentsDesc,\n      color: \"from-purple-500 to-pink-500\"\n    },\n    {\n      icon: TrendingUp,\n      title: txtRealTimeTitle,\n      description: txtRealTimeDesc,\n      color: \"from-amber-500 to-orange-500\"\n    },\n    {\n      icon: Shield,\n      title: txtSecureTitle,\n      description: txtSecureDesc,\n      color: \"from-green-500 to-emerald-500\"\n    }\n  ];\n\n  const handleStartButton = () => {\n    if (user) {\n      navigate(createPageUrl(\"Businesses\"));\n    } else {\n      base44.auth.redirectToLogin();\n    }\n  };\n\n  // Não mostrar para contas empresariais puras\n  if (user?.account_type === 'empresa') {\n    return null;\n  }\n\n  return (\n    <div className=\"bg-gradient-to-br from-slate-50 via-blue-50 to-sky-50\">\n      <div className=\"px-3 py-4 md:px-6 md:py-12\">\n        <div className=\"max-w-6xl mx-auto\">\n          <div className=\"text-center mb-4 md:mb-8\">\n            <div className=\"inline-flex items-center gap-1.5 bg-white/80 backdrop-blur-sm px-2 py-1 rounded-full mb-2 shadow-sm\">\n              <div className=\"w-1.5 h-1.5 bg-green-500 rounded-full animate-pulse\" />\n              <span className=\"text-xs font-medium text-slate-700\">{txtSystemActive}</span>\n            </div>\n            <h1 className=\"text-xl md:text-2xl font-bold text-slate-900 mb-2\">\n              {txtTitle}\n            </h1>\n            <p className=\"text-sm md:text-base text-slate-600 max-w-2xl mx-auto mb-3 px-2\">\n              {txtSubtitle}\n            </p>\n            <div className=\"flex justify-center px-2\">\n              <Button \n                size=\"sm\"\n                onClick={handleStartButton}\n                className=\"bg-gradient-to-r from-sky-500 to-blue-600 hover:from-sky-600 hover:to-blue-700 h-8 text-xs\"\n              >\n                {txtViewBusinesses}\n                <ArrowRight className=\"w-3 h-3 ml-1\" />\n              </Button>\n            </div>\n          </div>\n\n          <div className=\"grid grid-cols-2 md:grid-cols-4 gap-2 mb-4 md:mb-8\">\n            {features.map((feature, idx) => (\n              <Card key={idx} className=\"border-0 shadow-sm\">\n                <CardContent className=\"p-2 md:p-3 text-center\">\n                  <div className={`w-8 h-8 md:w-10 md:h-10 rounded-lg bg-gradient-to-br ${feature.color} flex items-center justify-center mx-auto mb-1`}>\n                    <feature.icon className=\"w-4 h-4 md:w-5 md:h-5 text-white\" />\n                  </div>\n                  <h3 className=\"font-semibold text-xs text-slate-900 mb-0.5\">{feature.title}</h3>\n                  <p className=\"text-[10px] md:text-xs text-slate-600 leading-tight\">{feature.description}</p>\n                </CardContent>\n              </Card>\n            ))}\n          </div>\n\n          <div className=\"mb-3\">\n            <div className=\"relative max-w-2xl mx-auto\">\n              <Search className=\"absolute left-2.5 top-1/2 -translate-y-1/2 w-3.5 h-3.5 text-slate-400\" />\n              <Input\n                placeholder={txtSearchPlaceholder}\n                value={searchTerm}\n                onChange={(e) => setSearchTerm(e.target.value)}\n                className=\"pl-8 h-9 text-sm\"\n              />\n            </div>\n          </div>\n\n          <div className=\"mb-2\">\n            <h2 className=\"text-base md:text-lg font-bold text-slate-900 mb-0.5\">\n              {txtAvailableBusinesses}\n            </h2>\n            <p className=\"text-xs md:text-sm text-slate-600\">\n              {filteredBusinesses.length} {filteredBusinesses.length === 1 ? txtBusinessFound : txtBusinessesFound}\n            </p>\n          </div>\n\n          {isLoading ? (\n            <div className=\"grid grid-cols-1 md:grid-cols-2 gap-2\">\n              {[1, 2, 3, 4].map(i => (\n                <Skeleton key={i} className=\"h-24 md:h-32\" />\n              ))}\n            </div>\n          ) : filteredBusinesses.length === 0 ? (\n            <Card className=\"border-0 shadow-md\">\n              <CardContent className=\"py-8 text-center\">\n                <div className=\"w-10 h-10 bg-slate-100 rounded-full flex items-center justify-center mx-auto mb-2\">\n                  <Search className=\"w-5 h-5 text-slate-400\" />\n                </div>\n                <h3 className=\"text-sm font-bold text-slate-900 mb-1\">\n                  {txtNoBusinesses}\n                </h3>\n                <p className=\"text-xs text-slate-600\">\n                  {txtAdjustFilters}\n                </p>\n              </CardContent>\n            </Card>\n          ) : (\n            <div className=\"grid grid-cols-1 md:grid-cols-2 gap-2\">\n              {filteredBusinesses.map(business => {\n                if (!business || !business.id) return null;\n                \n                return <Card key={business.id} className=\"border-0 shadow-sm hover:shadow-md transition-all\">\n                  <CardContent className=\"p-3\">\n                    <div className=\"flex gap-2 mb-2\">\n                      {business.logo_url && (\n                        <img \n                          src={getUploadUrl(business.logo_url)} \n                          alt={business.name || 'Business'}\n                          className=\"w-10 h-10 md:w-12 md:h-12 rounded-lg object-cover flex-shrink-0\"\n                          onError={(e) => { e.target.style.display = 'none'; }}\n                        />\n                      )}\n                      <div className=\"flex-1 min-w-0\">\n                        <h3 className=\"font-bold text-xs md:text-sm text-slate-900 truncate\">\n                          {business.name || 'Empresa sem nome'}\n                        </h3>\n                        {business.description && (\n                          <p className=\"text-[10px] md:text-xs text-slate-600 line-clamp-1\">\n                            {business.description}\n                          </p>\n                        )}\n                        <div className=\"flex flex-wrap items-center gap-1 mt-1\">\n                          {business.address && (\n                            <Badge variant=\"outline\" className=\"gap-0.5 text-[10px] px-1 py-0 h-4\">\n                              <MapPin className=\"w-2.5 h-2.5\" />\n                              {business.address.split(',')[0]}\n                            </Badge>\n                          )}\n                          {business.rating && (\n                            <Badge variant=\"outline\" className=\"gap-0.5 text-[10px] px-1 py-0 h-4\">\n                              <Star className=\"w-2.5 h-2.5 fill-yellow-400 text-yellow-400\" />\n                              {business.rating.toFixed(1)}\n                            </Badge>\n                          )}\n                        </div>\n                      </div>\n                    </div>\n\n                    <Button\n                      onClick={() => navigate(createPageUrl(`BusinessDetail?id=${business.id}`))}\n                      className=\"w-full bg-gradient-to-r from-sky-500 to-blue-600 hover:from-sky-600 hover:to-blue-700 h-7 text-[10px] gap-0.5\"\n                    >\n                      <Sparkles className=\"w-2.5 h-2.5\" />\n                      Ver Detalhes\n                    </Button>\n                  </CardContent>\n                </Card>\n              })}\n            </div>\n          )}\n        </div>\n      </div>\n\n      <div className=\"bg-gradient-to-r from-sky-600 to-blue-700 px-3 py-6 md:py-10\">\n        <div className=\"max-w-4xl mx-auto text-center\">\n          <h2 className=\"text-lg md:text-2xl font-bold text-white mb-2\">\n            {txtReadyToStart}\n          </h2>\n          <p className=\"text-sm md:text-base text-blue-100 mb-3 md:mb-4\">\n            {txtJoinUsers}\n          </p>\n          <Button \n            size=\"sm\"\n            onClick={handleStartButton}\n            className=\"bg-white text-sky-600 hover:bg-blue-50 h-8 text-xs\"\n          >\n            {txtViewBusinesses}\n            <ArrowRight className=\"w-3 h-3 ml-1\" />\n          </Button>\n        </div>\n      </div>\n    </div>\n  );\n}","path":null,"size_bytes":11519,"size_tokens":null},"eslint.config.js":{"content":"import js from '@eslint/js'\nimport globals from 'globals'\nimport react from 'eslint-plugin-react'\nimport reactHooks from 'eslint-plugin-react-hooks'\nimport reactRefresh from 'eslint-plugin-react-refresh'\n\nexport default [\n  { \n    ignores: [\n      'dist',\n      'android/**',\n      'ios/**',\n      'node_modules/**',\n      'build/**',\n      '*.config.ts',\n      'capacitor.config.ts'\n    ] \n  },\n  // Server-side files (Node.js environment)\n  {\n    files: ['server/**/*.js', 'drizzle.config.js', 'shared/**/*.js'],\n    languageOptions: {\n      ecmaVersion: 2020,\n      globals: { ...globals.node },\n      sourceType: 'module',\n    },\n    rules: {\n      ...js.configs.recommended.rules,\n      'no-unused-vars': ['warn', { argsIgnorePattern: '^_' }],\n    },\n  },\n  // Client-side files (Browser environment)\n  {\n    files: ['src/**/*.{js,jsx}'],\n    languageOptions: {\n      ecmaVersion: 2020,\n      globals: globals.browser,\n      parserOptions: {\n        ecmaVersion: 'latest',\n        ecmaFeatures: { jsx: true },\n        sourceType: 'module',\n      },\n    },\n    settings: { react: { version: '18.3' } },\n    plugins: {\n      react,\n      'react-hooks': reactHooks,\n      'react-refresh': reactRefresh,\n    },\n    rules: {\n      ...js.configs.recommended.rules,\n      ...react.configs.recommended.rules,\n      ...react.configs['jsx-runtime'].rules,\n      ...reactHooks.configs.recommended.rules,\n      'react/jsx-no-target-blank': 'off',\n      'react/prop-types': 'off', // Desabilitado - TypeScript seria mais adequado\n      'react/no-unescaped-entities': 'off', // Desabilitado - aspas duplas em JSX são aceitáveis\n      'react/no-unknown-property': 'off', // Desabilitado - permite propriedades customizadas (cmdk-*, etc)\n      'react/no-children-prop': 'warn', // Warning em vez de error\n      'no-unused-vars': ['warn', { argsIgnorePattern: '^_' }],\n      'no-useless-catch': 'warn', // Warning em vez de error\n      'react-refresh/only-export-components': [\n        'warn',\n        { allowConstantExport: true },\n      ],\n    },\n  },\n]\n","path":null,"size_bytes":2046,"size_tokens":null},"src/components/ui/breadcrumb.jsx":{"content":"import * as React from \"react\"\nimport { Slot } from \"@radix-ui/react-slot\"\nimport { ChevronRight, MoreHorizontal } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Breadcrumb = React.forwardRef(\n  ({ ...props }, ref) => <nav ref={ref} aria-label=\"breadcrumb\" {...props} />\n)\nBreadcrumb.displayName = \"Breadcrumb\"\n\nconst BreadcrumbList = React.forwardRef(({ className, ...props }, ref) => (\n  <ol\n    ref={ref}\n    className={cn(\n      \"flex flex-wrap items-center gap-1.5 break-words text-sm text-muted-foreground sm:gap-2.5\",\n      className\n    )}\n    {...props} />\n))\nBreadcrumbList.displayName = \"BreadcrumbList\"\n\nconst BreadcrumbItem = React.forwardRef(({ className, ...props }, ref) => (\n  <li\n    ref={ref}\n    className={cn(\"inline-flex items-center gap-1.5\", className)}\n    {...props} />\n))\nBreadcrumbItem.displayName = \"BreadcrumbItem\"\n\nconst BreadcrumbLink = React.forwardRef(({ asChild, className, ...props }, ref) => {\n  const Comp = asChild ? Slot : \"a\"\n\n  return (\n    (<Comp\n      ref={ref}\n      className={cn(\"transition-colors hover:text-foreground\", className)}\n      {...props} />)\n  );\n})\nBreadcrumbLink.displayName = \"BreadcrumbLink\"\n\nconst BreadcrumbPage = React.forwardRef(({ className, ...props }, ref) => (\n  <span\n    ref={ref}\n    role=\"link\"\n    aria-disabled=\"true\"\n    aria-current=\"page\"\n    className={cn(\"font-normal text-foreground\", className)}\n    {...props} />\n))\nBreadcrumbPage.displayName = \"BreadcrumbPage\"\n\nconst BreadcrumbSeparator = ({\n  children,\n  className,\n  ...props\n}) => (\n  <li\n    role=\"presentation\"\n    aria-hidden=\"true\"\n    className={cn(\"[&>svg]:w-3.5 [&>svg]:h-3.5\", className)}\n    {...props}>\n    {children ?? <ChevronRight />}\n  </li>\n)\nBreadcrumbSeparator.displayName = \"BreadcrumbSeparator\"\n\nconst BreadcrumbEllipsis = ({\n  className,\n  ...props\n}) => (\n  <span\n    role=\"presentation\"\n    aria-hidden=\"true\"\n    className={cn(\"flex h-9 w-9 items-center justify-center\", className)}\n    {...props}>\n    <MoreHorizontal className=\"h-4 w-4\" />\n    <span className=\"sr-only\">More</span>\n  </span>\n)\nBreadcrumbEllipsis.displayName = \"BreadcrumbElipssis\"\n\nexport {\n  Breadcrumb,\n  BreadcrumbList,\n  BreadcrumbItem,\n  BreadcrumbLink,\n  BreadcrumbPage,\n  BreadcrumbSeparator,\n  BreadcrumbEllipsis,\n}\n","path":null,"size_bytes":2271,"size_tokens":null},"src/pages/StaffInviteAccept.jsx":{"content":"import React, { useState, useEffect } from \"react\";\nimport { base44 } from \"@/api/base44Client\";\nimport { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { useNavigate } from \"react-router-dom\";\nimport { createPageUrl } from \"@/utils\";\nimport { Card, CardContent } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { CheckCircle2, XCircle, Loader2, Building2 } from \"lucide-react\";\nimport { toast } from \"sonner\";\nimport { useAutoTranslate } from \"@/hooks/useTranslate\";\n\nexport default function StaffInviteAcceptPage() {\n  const navigate = useNavigate();\n  const urlParams = new URLSearchParams(window.location.search);\n  const token = urlParams.get('token');\n  const [user, setUser] = useState(null);\n  const [processing, setProcessing] = useState(false);\n\n  const txtLoadingInvite = useAutoTranslate('A carregar convite...', 'pt');\n  const txtInvalidInvite = useAutoTranslate('Convite Inválido', 'pt');\n  const txtInviteNotExist = useAutoTranslate('Este convite não existe, já foi usado ou expirou.', 'pt');\n  const txtBackHome = useAutoTranslate('Voltar ao Início', 'pt');\n  const txtIncorrectEmail = useAutoTranslate('Email Incorreto', 'pt');\n  const txtInviteSentTo = useAutoTranslate('Este convite foi enviado para', 'pt');\n  const txtPleaseLoginWith = useAutoTranslate('Por favor faça login com esse email.', 'pt');\n  const txtSwitchAccount = useAutoTranslate('Trocar de Conta', 'pt');\n  const txtTeamInvite = useAutoTranslate('Convite para Equipa', 'pt');\n  const txtLoading = useAutoTranslate('A carregar...', 'pt');\n  const txtAssignedPermissions = useAutoTranslate('Permissões Atribuídas:', 'pt');\n  const txtManageQueues = useAutoTranslate('Gerir Senhas', 'pt');\n  const txtManageAppointments = useAutoTranslate('Gerir Marcações', 'pt');\n  const txtManageServices = useAutoTranslate('Gerir Serviços', 'pt');\n  const txtNote = useAutoTranslate('Nota:', 'pt');\n  const txtOnAcceptAccess = useAutoTranslate('Ao aceitar, terá acesso ao painel empresarial de', 'pt');\n  const txtWithPermissions = useAutoTranslate('com as permissões indicadas acima.', 'pt');\n  const txtReject = useAutoTranslate('Rejeitar', 'pt');\n  const txtAccepting = useAutoTranslate('A aceitar...', 'pt');\n  const txtAcceptInvite = useAutoTranslate('Aceitar Convite', 'pt');\n  const txtInviteAccepted = useAutoTranslate('Convite aceite com sucesso!', 'pt');\n\n  useEffect(() => {\n    base44.auth.me().then(setUser).catch(() => {\n      base44.auth.redirectToLogin(window.location.href);\n    });\n  }, []);\n\n  const { data: invite, isLoading } = useQuery({\n    queryKey: ['invite', token],\n    queryFn: async () => {\n      const invites = await base44.entities.StaffInvite.filter({ token: token });\n      return invites[0];\n    },\n    enabled: !!token && !!user,\n  });\n\n  const { data: business } = useQuery({\n    queryKey: ['business', invite?.business_id],\n    queryFn: async () => {\n      const businesses = await base44.entities.Business.filter({ id: invite.business_id });\n      return businesses[0];\n    },\n    enabled: !!invite?.business_id,\n  });\n\n  const acceptInviteMutation = useMutation({\n    mutationFn: async () => {\n      setProcessing(true);\n\n      // Atualizar perfil do utilizador (servidor emite novo JWT automaticamente)\n      await base44.auth.updateMe({\n        is_staff_member: true,\n        is_business_user: true,\n        business_id: invite.business_id,\n        staff_permissions: invite.permissions,\n        account_type: 'empresa'\n      });\n\n      // Marcar convite como aceite\n      await base44.entities.StaffInvite.update(invite.id, {\n        status: \"aceite\"\n      });\n    },\n    onSuccess: () => {\n      toast.success(txtInviteAccepted);\n      // Redirecionar para BusinessHome (JWT já atualizado pelo servidor)\n      window.location.href = createPageUrl(\"BusinessHome\");\n    },\n  });\n\n  const rejectInviteMutation = useMutation({\n    mutationFn: async () => {\n      await base44.entities.StaffInvite.update(invite.id, {\n        status: \"rejeitado\"\n      });\n    },\n    onSuccess: () => {\n      navigate(createPageUrl(\"Home\"));\n    },\n  });\n\n  const permissionLabels = {\n    manage_queues: txtManageQueues,\n    manage_appointments: txtManageAppointments,\n    manage_services: txtManageServices\n  };\n\n  if (isLoading || !user) {\n    return (\n      <div className=\"bg-gradient-to-br from-slate-50 via-blue-50 to-sky-50 flex items-center justify-center p-4\">\n        <Card className=\"border-0 shadow-2xl max-w-md w-full animate-scale-in\">\n          <CardContent className=\"p-12 text-center\">\n            <Loader2 className=\"w-12 h-12 animate-spin text-sky-600 mx-auto mb-4\" />\n            <p className=\"text-slate-600\">{txtLoadingInvite}</p>\n          </CardContent>\n        </Card>\n      </div>\n    );\n  }\n\n  if (!invite || invite.status !== 'pendente') {\n    return (\n      <div className=\"bg-gradient-to-br from-slate-50 via-blue-50 to-sky-50 flex items-center justify-center p-4\">\n        <Card className=\"border-0 shadow-2xl max-w-md w-full animate-scale-in\">\n          <CardContent className=\"p-12 text-center\">\n            <XCircle className=\"w-16 h-16 text-red-500 mx-auto mb-4 animate-pulse-slow\" />\n            <h2 className=\"text-2xl font-bold text-slate-900 mb-2\">\n              {txtInvalidInvite}\n            </h2>\n            <p className=\"text-slate-600 mb-6\">\n              {txtInviteNotExist}\n            </p>\n            <Button onClick={() => navigate(createPageUrl(\"Home\"))} className=\"hover-lift\">\n              {txtBackHome}\n            </Button>\n          </CardContent>\n        </Card>\n      </div>\n    );\n  }\n\n  if (invite.email !== user.email) {\n    return (\n      <div className=\"bg-gradient-to-br from-slate-50 via-blue-50 to-sky-50 flex items-center justify-center p-4\">\n        <Card className=\"border-0 shadow-2xl max-w-md w-full animate-scale-in\">\n          <CardContent className=\"p-12 text-center\">\n            <XCircle className=\"w-16 h-16 text-amber-500 mx-auto mb-4 animate-pulse-slow\" />\n            <h2 className=\"text-2xl font-bold text-slate-900 mb-2\">\n              {txtIncorrectEmail}\n            </h2>\n            <p className=\"text-slate-600 mb-6\">\n              {txtInviteSentTo} {invite.email}. \n              {txtPleaseLoginWith}\n            </p>\n            <Button onClick={() => base44.auth.logout()} className=\"hover-lift\">\n              {txtSwitchAccount}\n            </Button>\n          </CardContent>\n        </Card>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"bg-gradient-to-br from-slate-50 via-blue-50 to-sky-50 flex items-center justify-center p-4\">\n      <Card className=\"border-0 shadow-2xl max-w-2xl w-full overflow-hidden animate-scale-in\">\n        <div className=\"h-2 bg-gradient-to-r from-sky-500 to-blue-600\" />\n        <CardContent className=\"p-8\">\n          <div className=\"text-center mb-8 animate-slide-in-down\">\n            <div className=\"w-20 h-20 rounded-full bg-gradient-to-br from-sky-500 to-blue-600 flex items-center justify-center mx-auto mb-4 hover-lift\">\n              <Building2 className=\"w-10 h-10 text-white\" />\n            </div>\n            <h1 className=\"text-3xl font-bold text-slate-900 mb-2 gradient-text\">\n              {txtTeamInvite}\n            </h1>\n            <p className=\"text-lg text-slate-600\">\n              {business?.name || txtLoading}\n            </p>\n          </div>\n\n          <div className=\"bg-slate-50 rounded-xl p-6 mb-6 animate-slide-in-left\">\n            <h3 className=\"font-semibold text-slate-900 mb-4\">\n              {txtAssignedPermissions}\n            </h3>\n            <div className=\"space-y-3\">\n              {Object.entries(invite.permissions || {}).map(([key, value], idx) => (\n                <div \n                  key={key} \n                  className=\"flex items-center gap-3 stagger-item\"\n                  style={{ animationDelay: `${idx * 0.1}s` }}\n                >\n                  {value ? (\n                    <>\n                      <CheckCircle2 className=\"w-5 h-5 text-green-600 flex-shrink-0\" />\n                      <span className=\"text-slate-700\">{permissionLabels[key]}</span>\n                    </>\n                  ) : (\n                    <>\n                      <XCircle className=\"w-5 h-5 text-slate-300 flex-shrink-0\" />\n                      <span className=\"text-slate-400\">{permissionLabels[key]}</span>\n                    </>\n                  )}\n                </div>\n              ))}\n            </div>\n          </div>\n\n          <div className=\"bg-blue-50 rounded-xl p-4 mb-6 border border-blue-200 animate-slide-in-right\">\n            <p className=\"text-sm text-slate-700\">\n              <strong>{txtNote}</strong> {txtOnAcceptAccess} {business?.name} {txtWithPermissions}\n            </p>\n          </div>\n\n          <div className=\"flex gap-4 animate-slide-in-up\">\n            <Button\n              variant=\"outline\"\n              className=\"flex-1 smooth-transition hover-lift\"\n              onClick={() => rejectInviteMutation.mutate()}\n              disabled={processing || rejectInviteMutation.isPending}\n            >\n              {txtReject}\n            </Button>\n            <Button\n              className=\"flex-1 bg-gradient-to-r from-sky-500 to-blue-600 hover:from-sky-600 hover:to-blue-700 smooth-transition hover-lift\"\n              onClick={() => acceptInviteMutation.mutate()}\n              disabled={processing || acceptInviteMutation.isPending}\n            >\n              {processing || acceptInviteMutation.isPending ? (\n                <>\n                  <Loader2 className=\"w-4 h-4 mr-2 animate-spin\" />\n                  {txtAccepting}\n                </>\n              ) : (\n                txtAcceptInvite\n              )}\n            </Button>\n          </div>\n        </CardContent>\n      </Card>\n    </div>\n  );\n}","path":null,"size_bytes":9796,"size_tokens":null},"src/components/ui/tooltip.jsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as TooltipPrimitive from \"@radix-ui/react-tooltip\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst TooltipProvider = TooltipPrimitive.Provider\n\nconst Tooltip = TooltipPrimitive.Root\n\nconst TooltipTrigger = TooltipPrimitive.Trigger\n\nconst TooltipContent = React.forwardRef(({ className, sideOffset = 4, ...props }, ref) => (\n  <TooltipPrimitive.Portal>\n    <TooltipPrimitive.Content\n      ref={ref}\n      sideOffset={sideOffset}\n      className={cn(\n        \"z-50 overflow-hidden rounded-md bg-primary px-3 py-1.5 text-xs text-primary-foreground animate-in fade-in-0 zoom-in-95 data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=closed]:zoom-out-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2\",\n        className\n      )}\n      {...props} />\n  </TooltipPrimitive.Portal>\n))\nTooltipContent.displayName = TooltipPrimitive.Content.displayName\n\nexport { Tooltip, TooltipTrigger, TooltipContent, TooltipProvider }\n","path":null,"size_bytes":1091,"size_tokens":null},"src/components/ui/alert.jsx":{"content":"import * as React from \"react\"\nimport { cva } from \"class-variance-authority\";\n\nimport { cn } from \"@/lib/utils\"\n\nconst alertVariants = cva(\n  \"relative w-full rounded-lg border px-4 py-3 text-sm [&>svg+div]:translate-y-[-3px] [&>svg]:absolute [&>svg]:left-4 [&>svg]:top-4 [&>svg]:text-foreground [&>svg~*]:pl-7\",\n  {\n    variants: {\n      variant: {\n        default: \"bg-background text-foreground\",\n        destructive:\n          \"border-destructive/50 text-destructive dark:border-destructive [&>svg]:text-destructive\",\n      },\n    },\n    defaultVariants: {\n      variant: \"default\",\n    },\n  }\n)\n\nconst Alert = React.forwardRef(({ className, variant, ...props }, ref) => (\n  <div\n    ref={ref}\n    role=\"alert\"\n    className={cn(alertVariants({ variant }), className)}\n    {...props} />\n))\nAlert.displayName = \"Alert\"\n\nconst AlertTitle = React.forwardRef(({ className, ...props }, ref) => (\n  <h5\n    ref={ref}\n    className={cn(\"mb-1 font-medium leading-none tracking-tight\", className)}\n    {...props} />\n))\nAlertTitle.displayName = \"AlertTitle\"\n\nconst AlertDescription = React.forwardRef(({ className, ...props }, ref) => (\n  <div\n    ref={ref}\n    className={cn(\"text-sm [&_p]:leading-relaxed\", className)}\n    {...props} />\n))\nAlertDescription.displayName = \"AlertDescription\"\n\nexport { Alert, AlertTitle, AlertDescription }\n","path":null,"size_bytes":1335,"size_tokens":null},"src/components/ui/skeleton.jsx":{"content":"import { cn } from \"@/lib/utils\"\n\nfunction Skeleton({\n  className,\n  shimmer = true,\n  ...props\n}) {\n  return (\n    (<div\n      className={cn(\n        \"rounded-md bg-muted/50\",\n        shimmer && \"relative overflow-hidden before:absolute before:inset-0 before:-translate-x-full before:animate-[shimmer_2s_infinite] before:bg-gradient-to-r before:from-transparent before:via-white/20 before:to-transparent\",\n        !shimmer && \"animate-pulse\",\n        className\n      )}\n      {...props} />)\n  );\n}\n\nexport { Skeleton }\n","path":null,"size_bytes":520,"size_tokens":null},"src/pages/BusinessSettings.jsx":{"content":"import React, { useState, useEffect } from \"react\";\nimport { base44 } from \"@/api/base44Client\";\nimport { safeFetch } from \"@/utils/apiConfig\";\nimport { useQuery, useMutation, useQueryClient } from \"@tanstack/react-query\";\nimport { Button } from \"@/components/ui/button\";\nimport { Card, CardContent } from \"@/components/ui/card\";\nimport { Input } from \"@/components/ui/input\";\nimport { Label } from \"@/components/ui/label\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport { useNavigate } from \"react-router-dom\";\nimport { createPageUrl } from \"@/utils\";\nimport { \n  ArrowLeft,\n  Building2,\n  Save,\n  MessageSquare,\n  ChevronRight,\n  User,\n  Phone,\n  MapPin,\n  Image\n} from \"lucide-react\";\nimport { Skeleton } from \"@/components/ui/skeleton\";\nimport FeedbackManager from \"../components/business/FeedbackManager\";\nimport { ImageUpload } from \"../components/business/ImageUpload\";\nimport { MultiImageUpload } from \"../components/business/MultiImageUpload\";\nimport { AddressAutocomplete } from \"../components/business/AddressAutocomplete\";\nimport {\n  Accordion,\n  AccordionContent,\n  AccordionItem,\n  AccordionTrigger,\n} from \"@/components/ui/accordion\";\nimport {\n  Select,\n  SelectContent,\n  SelectItem,\n  SelectTrigger,\n  SelectValue,\n} from \"@/components/ui/select\";\nimport { toast } from \"sonner\";\nimport { STRIPE_SUPPORTED_COUNTRIES } from \"@/constants/stripeCountries\";\nimport { useAutoTranslate } from \"@/hooks/useTranslate\";\n\nconst countries = STRIPE_SUPPORTED_COUNTRIES;\n\nexport default function BusinessSettingsPage() {\n  const navigate = useNavigate();\n  const queryClient = useQueryClient();\n  const [user, setUser] = useState(null);\n  const [businessData, setBusinessData] = useState({});\n  const [activeSection, setActiveSection] = useState(null);\n\n  const txtBusinessSettings = useAutoTranslate('Configurações', 'pt');\n  const txtChooseSettings = useAutoTranslate('Escolha o que deseja configurar', 'pt');\n  const txtBackToDashboard = useAutoTranslate('Voltar ao Painel', 'pt');\n  const txtProfileUpdatedSuccess = useAutoTranslate('Perfil atualizado com sucesso!', 'pt');\n  const txtErrorUpdatingProfile = useAutoTranslate('Erro ao atualizar perfil', 'pt');\n  const txtCompanyNameRequired = useAutoTranslate('Nome da empresa é obrigatório.', 'pt');\n  const txtSpecifyBusinessType = useAutoTranslate('Por favor, especifique o tipo de negócio quando seleciona \"Outros\".', 'pt');\n  const txtAddressFilled = useAutoTranslate('✅ Morada preenchida automaticamente!', 'pt');\n  const txtSaving = useAutoTranslate('Salvando...', 'pt');\n  const txtSaveChanges = useAutoTranslate('Salvar Alterações', 'pt');\n  const txtCompanyProfile = useAutoTranslate('Perfil da Empresa', 'pt');\n  const txtNameCategoryContacts = useAutoTranslate('Nome, categoria e contactos', 'pt');\n  const txtFeedback = useAutoTranslate('Feedback', 'pt');\n  const txtClientReviews = useAutoTranslate('Avaliações dos clientes', 'pt');\n  const txtBack = useAutoTranslate('Anterior', 'pt');\n  const txtName = useAutoTranslate('Nome', 'pt');\n  const txtCategory = useAutoTranslate('Categoria', 'pt');\n  const txtSelect = useAutoTranslate('Selecione', 'pt');\n  const txtSpecifyBusinessTypeLabel = useAutoTranslate('Especifique o tipo', 'pt');\n  const txtHealthcare = useAutoTranslate('Saúde', 'pt');\n  const txtFinancial = useAutoTranslate('Financeiro', 'pt');\n  const txtGovernment = useAutoTranslate('Governo', 'pt');\n  const txtRestaurant = useAutoTranslate('Restauração', 'pt');\n  const txtBeauty = useAutoTranslate('Beleza', 'pt');\n  const txtOthers = useAutoTranslate('Outros', 'pt');\n  const txtDescription = useAutoTranslate('Descrição', 'pt');\n  const txtDescriptionPlaceholder = useAutoTranslate('Descreva seus serviços...', 'pt');\n  const txtPhone = useAutoTranslate('Telefone', 'pt');\n  const txtEmail = useAutoTranslate('Email', 'pt');\n  const txtCountry = useAutoTranslate('País', 'pt');\n  const txtSelectCountry = useAutoTranslate('Selecione o país', 'pt');\n  const txtDistrictRegion = useAutoTranslate('Distrito', 'pt');\n  const txtSearchAddressGoogleMaps = useAutoTranslate('Pesquisar Morada', 'pt');\n  const txtAddressHelp = useAutoTranslate('Comece a escrever para preencher automaticamente', 'pt');\n  const txtCity = useAutoTranslate('Cidade', 'pt');\n  const txtPostalCode = useAutoTranslate('Código Postal', 'pt');\n  const txtStreetName = useAutoTranslate('Rua', 'pt');\n  const txtDoorNumber = useAutoTranslate('Nº Porta', 'pt');\n  const txtAddressRequired = useAutoTranslate('Morada obrigatória para distâncias.', 'pt');\n  const txtCompanyLogo = useAutoTranslate('Logótipo', 'pt');\n  const txtPhotoGallery = useAutoTranslate('Galeria de Fotos', 'pt');\n  const txtPhotoGalleryHelp = useAutoTranslate('Adicione fotos da empresa', 'pt');\n  const txtRetail = useAutoTranslate('Retalho', 'pt');\n  const txtBasicInfo = useAutoTranslate('Informações Básicas', 'pt');\n  const txtContactInfo = useAutoTranslate('Contacto', 'pt');\n  const txtAddressInfo = useAutoTranslate('Morada', 'pt');\n  const txtMediaInfo = useAutoTranslate('Imagens', 'pt');\n  \n  const categories = [\n    { value: \"saude\", label: txtHealthcare },\n    { value: \"financeiro\", label: txtFinancial },\n    { value: \"governo\", label: txtGovernment },\n    { value: \"restauracao\", label: txtRestaurant },\n    { value: \"beleza\", label: txtBeauty },\n    { value: \"retalho\", label: txtRetail },\n    { value: \"outros\", label: txtOthers }\n  ];\n\n  useEffect(() => {\n    base44.auth.me().then(userData => {\n      setUser(userData);\n      if (!userData.is_business_user || !userData.business_id) {\n        navigate(createPageUrl(\"Home\"));\n      }\n    }).catch(() => {\n      base44.auth.redirectToLogin();\n    });\n  }, [navigate]);\n\n  const { data: business, isLoading } = useQuery({\n    queryKey: ['company-profile', user?.business_id],\n    queryFn: async () => {\n      const { response, data: profile } = await safeFetch(`/api/company-profiles/${user.business_id}`);\n      if (!response.ok) throw new Error('Failed to fetch company profile');\n      \n      const mappedProfile = {\n        ...profile,\n        name: profile.companyName,\n        category: profile.companyCategory,\n        phone: profile.companyPhone,\n        email: profile.companyEmail,\n        description: profile.companyDescription,\n        country: profile.companyCountry,\n        district: profile.companyDistrict,\n        city: profile.companyCity,\n        postal_code: profile.companyPostalCode,\n        street_name: profile.companyStreetName,\n        door_number: profile.companyDoorNumber,\n        address: profile.companyAddress,\n        custom_category: profile.customCategory,\n        logo_url: profile.logoUrl,\n        photo_url: profile.photoUrl,\n        media_gallery: profile.mediaGallery,\n        latitude: profile.companyCoordinates?.latitude,\n        longitude: profile.companyCoordinates?.longitude\n      };\n      \n      setBusinessData(mappedProfile);\n      return mappedProfile;\n    },\n    enabled: !!user?.business_id,\n  });\n\n  const updateBusinessMutation = useMutation({\n    mutationFn: async (updates) => {\n      const { response, data } = await safeFetch(`/api/company-profiles/${user.business_id}`, {\n        method: 'PUT',\n        body: JSON.stringify(updates)\n      });\n      if (!response.ok) {\n        throw new Error(`HTTP ${response.status}: ${data?.error || 'Update failed'}`);\n      }\n      return data;\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['company-profile'] });\n      toast.success(txtProfileUpdatedSuccess);\n    },\n    onError: (error) => {\n      console.error('Error updating business:', error);\n      toast.error(txtErrorUpdatingProfile);\n      queryClient.invalidateQueries({ queryKey: ['company-profile', user?.business_id] });\n    }\n  });\n\n  const handleBusinessUpdate = async () => {\n    if (!businessData.name?.trim()) {\n      toast.error(txtCompanyNameRequired);\n      return;\n    }\n    \n    if (businessData.category === 'outros' && !businessData.custom_category?.trim()) {\n      toast.error(txtSpecifyBusinessType);\n      return;\n    }\n    \n    const hasCompleteAddress = businessData.street_name && businessData.door_number && \n                                businessData.postal_code && businessData.city && \n                                businessData.district && businessData.country;\n    \n    const mappedUpdates = {\n      companyName: businessData.name,\n      companyCategory: businessData.category,\n      companyPhone: businessData.phone,\n      companyEmail: businessData.email,\n      companyDescription: businessData.description,\n      companyCountry: businessData.country,\n      companyDistrict: businessData.district,\n      companyCity: businessData.city,\n      companyPostalCode: businessData.postal_code,\n      companyStreetName: businessData.street_name,\n      companyDoorNumber: businessData.door_number,\n      logoUrl: businessData.logo_url,\n      photoUrl: businessData.photo_url,\n      mediaGallery: businessData.media_gallery,\n      updatedAt: new Date()\n    };\n    \n    if (businessData.category === 'outros') {\n      mappedUpdates.customCategory = businessData.custom_category || '';\n    } else {\n      mappedUpdates.customCategory = null;\n    }\n\n    if (hasCompleteAddress) {\n      const countryName = countries.find(c => c.code === businessData.country)?.name || businessData.country;\n      const fullAddress = `${businessData.street_name} ${businessData.door_number}, ${businessData.postal_code} ${businessData.city}, ${businessData.district}, ${countryName}`;\n      \n      mappedUpdates.companyAddress = fullAddress;\n      \n      // Sempre fazer geocoding da morada manual para obter coordenadas exactas\n      try {\n        const { response, data } = await safeFetch('/api/geocode-address', {\n          method: 'POST',\n          body: JSON.stringify({\n            address: `${businessData.street_name} ${businessData.door_number}`,\n            city: businessData.city,\n            postalCode: businessData.postal_code,\n            country: countryName\n          })\n        });\n        \n        if (response.ok && data?.coordinates) {\n          mappedUpdates.companyCoordinates = {\n            latitude: data.coordinates.lat,\n            longitude: data.coordinates.lng\n          };\n          console.log('✅ Coordenadas actualizadas para morada manual:', data.coordinates);\n        } else if (businessData.latitude && businessData.longitude) {\n          // Fallback para coordenadas existentes se geocoding falhar\n          mappedUpdates.companyCoordinates = {\n            latitude: businessData.latitude,\n            longitude: businessData.longitude\n          };\n        }\n      } catch (err) {\n        console.warn('⚠️ Geocoding falhou, usando coordenadas existentes:', err);\n        if (businessData.latitude && businessData.longitude) {\n          mappedUpdates.companyCoordinates = {\n            latitude: businessData.latitude,\n            longitude: businessData.longitude\n          };\n        }\n      }\n    }\n    \n    const cleanUpdates = Object.fromEntries(\n      Object.entries(mappedUpdates).filter(([_, value]) => value !== undefined && value !== null)\n    );\n    \n    updateBusinessMutation.mutate(cleanUpdates);\n  };\n\n  const autoSaveImageMutation = useMutation({\n    mutationFn: async (imageData) => {\n      const { response, data } = await safeFetch(`/api/company-profiles/${user.business_id}`, {\n        method: 'PUT',\n        body: JSON.stringify(imageData)\n      });\n      if (!response.ok) {\n        throw new Error(`HTTP ${response.status}: ${data?.error || 'Update failed'}`);\n      }\n      return data;\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['company-profile'] });\n      console.log('✅ Imagem auto-salva com sucesso');\n    },\n    onError: (error) => {\n      console.error('❌ Erro ao auto-salvar imagem:', error);\n    }\n  });\n\n  const handleChange = (field, value) => {\n    setBusinessData(prev => {\n      const updated = { ...prev, [field]: value };\n      \n      if (field === 'category' && value !== 'outros' && prev.category === 'outros') {\n        updated.custom_category = '';\n      }\n      \n      return updated;\n    });\n    \n    if (field === 'logo_url' || field === 'photo_url' || field === 'media_gallery') {\n      const fieldMap = {\n        'logo_url': 'logoUrl',\n        'photo_url': 'photoUrl',\n        'media_gallery': 'mediaGallery'\n      };\n      autoSaveImageMutation.mutate({ [fieldMap[field]]: value });\n    }\n  };\n\n  if (!user || isLoading) {\n    return (\n      <div className=\"bg-slate-50 p-2 lg:p-4\">\n        <div className=\"max-w-lg lg:max-w-3xl xl:max-w-4xl mx-auto\">\n          <Skeleton className=\"h-8 lg:h-10 w-32 lg:w-48 mb-3 lg:mb-6\" />\n          <Skeleton className=\"h-12 lg:h-16 w-full mb-2 lg:mb-4\" />\n          <Skeleton className=\"h-12 lg:h-16 w-full\" />\n        </div>\n      </div>\n    );\n  }\n\n  const sections = [\n    {\n      id: 'profile',\n      icon: Building2,\n      title: txtCompanyProfile,\n      description: txtNameCategoryContacts,\n      color: 'from-blue-500 to-cyan-500'\n    },\n    {\n      id: 'feedback',\n      icon: MessageSquare,\n      title: txtFeedback,\n      description: txtClientReviews,\n      color: 'from-amber-500 to-orange-500'\n    }\n  ];\n\n  if (activeSection) {\n    return (\n      <div className=\"bg-slate-50\">\n        <div className=\"max-w-lg lg:max-w-3xl xl:max-w-4xl mx-auto px-2 lg:px-6 py-2 lg:py-6 pb-32 lg:pb-20\">\n          <Button\n            variant=\"ghost\"\n            size=\"sm\"\n            className=\"mb-2 lg:mb-4 gap-1 lg:gap-2 h-7 lg:h-9 text-xs lg:text-sm px-2 lg:px-4\"\n            onClick={() => setActiveSection(null)}\n          >\n            <ArrowLeft className=\"w-3 h-3 lg:w-4 lg:h-4\" />\n            {txtBack}\n          </Button>\n\n          {activeSection === 'profile' && (\n            <div className=\"space-y-2 lg:space-y-4\">\n              <div className=\"flex items-center gap-2 lg:gap-3 px-1 mb-2 lg:mb-4\">\n                <div className=\"w-7 h-7 lg:w-10 lg:h-10 rounded-lg bg-gradient-to-br from-blue-500 to-cyan-500 flex items-center justify-center\">\n                  <Building2 className=\"w-3.5 h-3.5 lg:w-5 lg:h-5 text-white\" />\n                </div>\n                <h1 className=\"text-sm lg:text-xl font-bold text-slate-900\">{txtCompanyProfile}</h1>\n              </div>\n\n              <Accordion type=\"single\" collapsible defaultValue=\"basic\" className=\"space-y-1 lg:space-y-3\">\n                <AccordionItem value=\"basic\" className=\"border rounded-lg lg:rounded-xl bg-white shadow-sm overflow-hidden\">\n                  <AccordionTrigger className=\"px-3 lg:px-5 py-2 lg:py-4 hover:no-underline hover:bg-slate-50 text-left\">\n                    <div className=\"flex items-center gap-2 lg:gap-3\">\n                      <User className=\"w-3.5 h-3.5 lg:w-5 lg:h-5 text-blue-600\" />\n                      <span className=\"text-xs lg:text-base font-medium\">{txtBasicInfo}</span>\n                    </div>\n                  </AccordionTrigger>\n                  <AccordionContent className=\"px-3 lg:px-5 pb-2.5 lg:pb-5 pt-0\">\n                    <div className=\"space-y-2 lg:space-y-4\">\n                      <div>\n                        <Label htmlFor=\"name\" className=\"text-[10px] lg:text-xs text-slate-500 uppercase tracking-wide\">{txtName}</Label>\n                        <Input\n                          id=\"name\"\n                          value={businessData.name || ''}\n                          onChange={(e) => handleChange('name', e.target.value)}\n                          placeholder=\"Ex: Clínica Dr. Silva\"\n                          className=\"mt-0.5 lg:mt-1 h-8 lg:h-10 text-xs lg:text-sm\"\n                        />\n                      </div>\n\n                      <div>\n                        <Label htmlFor=\"category\" className=\"text-[10px] text-slate-500 uppercase tracking-wide\">{txtCategory}</Label>\n                        <Select\n                          value={businessData.category || ''}\n                          onValueChange={(value) => handleChange('category', value)}\n                        >\n                          <SelectTrigger className=\"mt-0.5 h-8 text-xs\">\n                            <SelectValue placeholder={txtSelect} />\n                          </SelectTrigger>\n                          <SelectContent>\n                            {categories.map(cat => (\n                              <SelectItem key={cat.value} value={cat.value} className=\"text-xs\">\n                                {cat.label}\n                              </SelectItem>\n                            ))}\n                          </SelectContent>\n                        </Select>\n                      </div>\n\n                      {businessData.category === 'outros' && (\n                        <div>\n                          <Label htmlFor=\"custom_category\" className=\"text-[10px] text-slate-500 uppercase tracking-wide\">{txtSpecifyBusinessTypeLabel}</Label>\n                          <Input\n                            id=\"custom_category\"\n                            value={businessData.custom_category || ''}\n                            onChange={(e) => handleChange('custom_category', e.target.value)}\n                            placeholder=\"Ex: Oficina Mecânica\"\n                            className=\"mt-0.5 h-8 text-xs\"\n                          />\n                        </div>\n                      )}\n\n                      <div>\n                        <Label htmlFor=\"description\" className=\"text-[10px] text-slate-500 uppercase tracking-wide\">{txtDescription}</Label>\n                        <Textarea\n                          id=\"description\"\n                          value={businessData.description || ''}\n                          onChange={(e) => handleChange('description', e.target.value)}\n                          placeholder={txtDescriptionPlaceholder}\n                          rows={2}\n                          className=\"mt-0.5 resize-none text-xs min-h-[48px]\"\n                        />\n                      </div>\n                    </div>\n                  </AccordionContent>\n                </AccordionItem>\n\n                <AccordionItem value=\"contact\" className=\"border rounded-lg bg-white shadow-sm overflow-hidden\">\n                  <AccordionTrigger className=\"px-3 py-2 hover:no-underline hover:bg-slate-50 text-left\">\n                    <div className=\"flex items-center gap-2\">\n                      <Phone className=\"w-3.5 h-3.5 text-green-600\" />\n                      <span className=\"text-xs font-medium\">{txtContactInfo}</span>\n                    </div>\n                  </AccordionTrigger>\n                  <AccordionContent className=\"px-3 pb-2.5 pt-0\">\n                    <div className=\"space-y-2\">\n                      <div>\n                        <Label htmlFor=\"phone\" className=\"text-[10px] text-slate-500 uppercase tracking-wide\">{txtPhone}</Label>\n                        <Input\n                          id=\"phone\"\n                          value={businessData.phone || ''}\n                          onChange={(e) => handleChange('phone', e.target.value)}\n                          placeholder=\"+351 912 345 678\"\n                          className=\"mt-0.5 h-8 text-xs\"\n                        />\n                      </div>\n\n                      <div>\n                        <Label htmlFor=\"email\" className=\"text-[10px] text-slate-500 uppercase tracking-wide\">{txtEmail}</Label>\n                        <Input\n                          id=\"email\"\n                          type=\"text\"\n                          inputMode=\"email\"\n                          value={businessData.email || ''}\n                          onChange={(e) => handleChange('email', e.target.value)}\n                          placeholder=\"contacto@empresa.pt\"\n                          className=\"mt-0.5 h-8 text-xs\"\n                          autoComplete=\"off\"\n                        />\n                      </div>\n                    </div>\n                  </AccordionContent>\n                </AccordionItem>\n\n                <AccordionItem value=\"address\" className=\"border rounded-lg bg-white shadow-sm overflow-hidden\">\n                  <AccordionTrigger className=\"px-3 py-2 hover:no-underline hover:bg-slate-50 text-left\">\n                    <div className=\"flex items-center gap-2\">\n                      <MapPin className=\"w-3.5 h-3.5 text-red-500\" />\n                      <span className=\"text-xs font-medium\">{txtAddressInfo}</span>\n                    </div>\n                  </AccordionTrigger>\n                  <AccordionContent className=\"px-3 pb-2.5 pt-0\">\n                    <div className=\"space-y-2\">\n                      <div>\n                        <Label htmlFor=\"country\" className=\"text-[10px] text-slate-500 uppercase tracking-wide\">{txtCountry}</Label>\n                        <Select\n                          value={businessData.country || ''}\n                          onValueChange={(value) => handleChange('country', value)}\n                        >\n                          <SelectTrigger className=\"mt-0.5 h-8 text-xs\">\n                            <SelectValue placeholder={txtSelectCountry} />\n                          </SelectTrigger>\n                          <SelectContent>\n                            {countries.map(country => (\n                              <SelectItem key={country.code} value={country.code} className=\"text-xs\">\n                                {country.flag} {country.name}\n                              </SelectItem>\n                            ))}\n                          </SelectContent>\n                        </Select>\n                      </div>\n\n                      <AddressAutocomplete\n                        onAddressSelect={(addressData) => {\n                          const isFromAutocomplete = addressData.geometry && !addressData.isManualEntry;\n                          \n                          if (addressData.country) handleChange('country', addressData.country.toUpperCase());\n                          if (addressData.district) handleChange('district', addressData.district);\n                          if (addressData.city) handleChange('city', addressData.city);\n                          if (addressData.postalCode) handleChange('postal_code', addressData.postalCode);\n                          if (addressData.streetName) handleChange('street_name', addressData.streetName);\n                          if (addressData.streetNumber) handleChange('door_number', addressData.streetNumber);\n                          if (addressData.geometry) {\n                            handleChange('latitude', addressData.geometry.lat);\n                            handleChange('longitude', addressData.geometry.lng);\n                          }\n                          if (isFromAutocomplete) {\n                            toast.success(txtAddressFilled);\n                          }\n                        }}\n                        countryCode={businessData.country || 'PT'}\n                        placeholder=\"Pesquisar morada...\"\n                        compact={true}\n                      />\n\n                      <div className=\"grid grid-cols-2 gap-1.5\">\n                        <div>\n                          <Label htmlFor=\"district\" className=\"text-[10px] text-slate-500 uppercase tracking-wide\">{txtDistrictRegion}</Label>\n                          <Input\n                            id=\"district\"\n                            value={businessData.district || ''}\n                            onChange={(e) => handleChange('district', e.target.value)}\n                            placeholder=\"Lisboa\"\n                            className=\"mt-0.5 h-8 text-xs\"\n                          />\n                        </div>\n                        <div>\n                          <Label htmlFor=\"city\" className=\"text-[10px] text-slate-500 uppercase tracking-wide\">{txtCity}</Label>\n                          <Input\n                            id=\"city\"\n                            value={businessData.city || ''}\n                            onChange={(e) => handleChange('city', e.target.value)}\n                            placeholder=\"Lisboa\"\n                            className=\"mt-0.5 h-8 text-xs\"\n                          />\n                        </div>\n                      </div>\n\n                      <div className=\"grid grid-cols-2 gap-1.5\">\n                        <div>\n                          <Label htmlFor=\"postal_code\" className=\"text-[10px] text-slate-500 uppercase tracking-wide\">{txtPostalCode}</Label>\n                          <Input\n                            id=\"postal_code\"\n                            value={businessData.postal_code || ''}\n                            onChange={(e) => handleChange('postal_code', e.target.value)}\n                            placeholder=\"1000-001\"\n                            className=\"mt-0.5 h-8 text-xs\"\n                          />\n                        </div>\n                        <div>\n                          <Label htmlFor=\"door_number\" className=\"text-[10px] text-slate-500 uppercase tracking-wide\">{txtDoorNumber}</Label>\n                          <Input\n                            id=\"door_number\"\n                            value={businessData.door_number || ''}\n                            onChange={(e) => handleChange('door_number', e.target.value)}\n                            placeholder=\"123\"\n                            className=\"mt-0.5 h-8 text-xs\"\n                          />\n                        </div>\n                      </div>\n\n                      <div>\n                        <Label htmlFor=\"street_name\" className=\"text-[10px] text-slate-500 uppercase tracking-wide\">{txtStreetName}</Label>\n                        <Input\n                          id=\"street_name\"\n                          value={businessData.street_name || ''}\n                          onChange={(e) => handleChange('street_name', e.target.value)}\n                          placeholder=\"Rua das Flores\"\n                          className=\"mt-0.5 h-8 text-xs\"\n                        />\n                      </div>\n                      \n                      <p className=\"text-[9px] text-slate-400\">{txtAddressRequired}</p>\n                    </div>\n                  </AccordionContent>\n                </AccordionItem>\n\n                <AccordionItem value=\"media\" className=\"border rounded-lg bg-white shadow-sm overflow-hidden\">\n                  <AccordionTrigger className=\"px-3 py-2 hover:no-underline hover:bg-slate-50 text-left\">\n                    <div className=\"flex items-center gap-2\">\n                      <Image className=\"w-3.5 h-3.5 text-purple-600\" />\n                      <span className=\"text-xs font-medium\">{txtMediaInfo}</span>\n                    </div>\n                  </AccordionTrigger>\n                  <AccordionContent className=\"px-3 pb-2.5 pt-0\">\n                    <div className=\"space-y-3\">\n                      <div>\n                        <Label className=\"text-[10px] text-slate-500 uppercase tracking-wide\">{txtCompanyLogo}</Label>\n                        <div className=\"mt-1\">\n                          <ImageUpload\n                            label=\"\"\n                            value={businessData.logo_url}\n                            onChange={(url) => handleChange('logo_url', url)}\n                            required={false}\n                          />\n                        </div>\n                      </div>\n\n                      <div>\n                        <MultiImageUpload\n                          label={txtPhotoGallery}\n                          value={businessData.media_gallery || []}\n                          onChange={(images) => handleChange('media_gallery', images)}\n                          maxImages={10}\n                          helpText={txtPhotoGalleryHelp}\n                        />\n                      </div>\n                    </div>\n                  </AccordionContent>\n                </AccordionItem>\n              </Accordion>\n\n              <div className=\"fixed bottom-16 left-0 right-0 p-2 lg:p-4 bg-white border-t shadow-lg z-40 lg:bottom-0\">\n                <div className=\"max-w-lg lg:max-w-3xl xl:max-w-4xl mx-auto\">\n                  <Button\n                    size=\"sm\"\n                    onClick={handleBusinessUpdate}\n                    disabled={updateBusinessMutation.isPending}\n                    className=\"w-full gap-1.5 lg:gap-2 bg-gradient-to-r from-sky-500 to-blue-600 hover:from-sky-600 hover:to-blue-700 h-9 lg:h-11 text-xs lg:text-base\"\n                  >\n                    <Save className=\"w-3.5 h-3.5 lg:w-5 lg:h-5\" />\n                    {updateBusinessMutation.isPending ? txtSaving : txtSaveChanges}\n                  </Button>\n                </div>\n              </div>\n            </div>\n          )}\n\n          {activeSection === 'feedback' && (\n            <div>\n              <div className=\"flex items-center gap-2 lg:gap-3 px-1 mb-2 lg:mb-4\">\n                <div className=\"w-7 h-7 lg:w-10 lg:h-10 rounded-lg bg-gradient-to-br from-amber-500 to-orange-500 flex items-center justify-center\">\n                  <MessageSquare className=\"w-3.5 h-3.5 lg:w-5 lg:h-5 text-white\" />\n                </div>\n                <h1 className=\"text-sm lg:text-xl font-bold text-slate-900\">{txtFeedback}</h1>\n              </div>\n              <FeedbackManager businessId={user.business_id} />\n            </div>\n          )}\n        </div>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"bg-slate-50\">\n      <div className=\"max-w-lg lg:max-w-3xl xl:max-w-4xl mx-auto px-2 lg:px-4 py-2 lg:py-4\">\n        <Button\n          variant=\"ghost\"\n          size=\"sm\"\n          className=\"mb-2 lg:mb-4 gap-1 lg:gap-2 h-7 lg:h-9 text-xs lg:text-sm px-2 lg:px-4\"\n          onClick={() => navigate(createPageUrl(\"BusinessDashboard\"))}\n        >\n          <ArrowLeft className=\"w-3 h-3 lg:w-4 lg:h-4\" />\n          {txtBackToDashboard}\n        </Button>\n\n        <div className=\"mb-3 lg:mb-6 px-1\">\n          <h1 className=\"text-lg lg:text-2xl font-bold text-slate-900\">\n            {txtBusinessSettings}\n          </h1>\n          <p className=\"text-[11px] lg:text-sm text-slate-500\">\n            {txtChooseSettings}\n          </p>\n        </div>\n\n        <div className=\"space-y-1.5 lg:space-y-3 lg:grid lg:grid-cols-2 lg:gap-4 lg:space-y-0\">\n          {sections.map((section) => (\n            <Card\n              key={section.id}\n              className=\"border-0 shadow-sm lg:shadow-md active:scale-[0.98] transition-transform cursor-pointer hover:shadow-lg\"\n              onClick={() => setActiveSection(section.id)}\n            >\n              <CardContent className=\"p-2.5 lg:p-5\">\n                <div className=\"flex items-center gap-2.5 lg:gap-4\">\n                  <div className={`w-9 h-9 lg:w-14 lg:h-14 rounded-xl lg:rounded-2xl bg-gradient-to-br ${section.color} flex items-center justify-center flex-shrink-0`}>\n                    <section.icon className=\"w-4 h-4 lg:w-7 lg:h-7 text-white\" />\n                  </div>\n                  <div className=\"flex-1 min-w-0\">\n                    <h3 className=\"font-semibold text-xs lg:text-lg text-slate-900\">\n                      {section.title}\n                    </h3>\n                    <p className=\"text-[10px] lg:text-sm text-slate-500 truncate\">\n                      {section.description}\n                    </p>\n                  </div>\n                  <ChevronRight className=\"w-4 h-4 lg:w-6 lg:h-6 text-slate-300 flex-shrink-0\" />\n                </div>\n              </CardContent>\n            </Card>\n          ))}\n        </div>\n      </div>\n    </div>\n  );\n}\n","path":null,"size_bytes":31642,"size_tokens":null},"src/components/ui/table.jsx":{"content":"import * as React from \"react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Table = React.forwardRef(({ className, ...props }, ref) => (\n  <div className=\"relative w-full overflow-auto\">\n    <table\n      ref={ref}\n      className={cn(\"w-full caption-bottom text-sm\", className)}\n      {...props} />\n  </div>\n))\nTable.displayName = \"Table\"\n\nconst TableHeader = React.forwardRef(({ className, ...props }, ref) => (\n  <thead ref={ref} className={cn(\"[&_tr]:border-b\", className)} {...props} />\n))\nTableHeader.displayName = \"TableHeader\"\n\nconst TableBody = React.forwardRef(({ className, ...props }, ref) => (\n  <tbody\n    ref={ref}\n    className={cn(\"[&_tr:last-child]:border-0\", className)}\n    {...props} />\n))\nTableBody.displayName = \"TableBody\"\n\nconst TableFooter = React.forwardRef(({ className, ...props }, ref) => (\n  <tfoot\n    ref={ref}\n    className={cn(\"border-t bg-muted/50 font-medium [&>tr]:last:border-b-0\", className)}\n    {...props} />\n))\nTableFooter.displayName = \"TableFooter\"\n\nconst TableRow = React.forwardRef(({ className, ...props }, ref) => (\n  <tr\n    ref={ref}\n    className={cn(\n      \"border-b transition-colors hover:bg-muted/50 data-[state=selected]:bg-muted\",\n      className\n    )}\n    {...props} />\n))\nTableRow.displayName = \"TableRow\"\n\nconst TableHead = React.forwardRef(({ className, ...props }, ref) => (\n  <th\n    ref={ref}\n    className={cn(\n      \"h-10 px-2 text-left align-middle font-medium text-muted-foreground [&:has([role=checkbox])]:pr-0 [&>[role=checkbox]]:translate-y-[2px]\",\n      className\n    )}\n    {...props} />\n))\nTableHead.displayName = \"TableHead\"\n\nconst TableCell = React.forwardRef(({ className, ...props }, ref) => (\n  <td\n    ref={ref}\n    className={cn(\n      \"p-2 align-middle [&:has([role=checkbox])]:pr-0 [&>[role=checkbox]]:translate-y-[2px]\",\n      className\n    )}\n    {...props} />\n))\nTableCell.displayName = \"TableCell\"\n\nconst TableCaption = React.forwardRef(({ className, ...props }, ref) => (\n  <caption\n    ref={ref}\n    className={cn(\"mt-4 text-sm text-muted-foreground\", className)}\n    {...props} />\n))\nTableCaption.displayName = \"TableCaption\"\n\nexport {\n  Table,\n  TableHeader,\n  TableBody,\n  TableFooter,\n  TableHead,\n  TableRow,\n  TableCell,\n  TableCaption,\n}\n","path":null,"size_bytes":2231,"size_tokens":null},"src/components/ui/use-toast.jsx":{"content":"// Inspired by react-hot-toast library\nimport { useState, useEffect, createContext, useContext } from \"react\";\n\nconst TOAST_LIMIT = 5;\nconst TOAST_REMOVE_DELAY = 2000;\n\nconst actionTypes = {\n  ADD_TOAST: \"ADD_TOAST\",\n  UPDATE_TOAST: \"UPDATE_TOAST\",\n  DISMISS_TOAST: \"DISMISS_TOAST\",\n  REMOVE_TOAST: \"REMOVE_TOAST\",\n};\n\nlet count = 0;\n\nfunction genId() {\n  count = (count + 1) % Number.MAX_VALUE;\n  return count.toString();\n}\n\nconst toastTimeouts = new Map();\n\nconst addToRemoveQueue = (toastId) => {\n  if (toastTimeouts.has(toastId)) {\n    return;\n  }\n\n  const timeout = setTimeout(() => {\n    toastTimeouts.delete(toastId);\n    dispatch({\n      type: actionTypes.REMOVE_TOAST,\n      toastId,\n    });\n  }, TOAST_REMOVE_DELAY);\n\n  toastTimeouts.set(toastId, timeout);\n};\n\nconst clearFromRemoveQueue = (toastId) => {\n  const timeout = toastTimeouts.get(toastId);\n  if (timeout) {\n    clearTimeout(timeout);\n    toastTimeouts.delete(toastId);\n  }\n};\n\nexport const reducer = (state, action) => {\n  switch (action.type) {\n    case actionTypes.ADD_TOAST:\n      return {\n        ...state,\n        toasts: [action.toast, ...state.toasts].slice(0, TOAST_LIMIT),\n      };\n\n    case actionTypes.UPDATE_TOAST:\n      return {\n        ...state,\n        toasts: state.toasts.map((t) =>\n          t.id === action.toast.id ? { ...t, ...action.toast } : t\n        ),\n      };\n\n    case actionTypes.DISMISS_TOAST: {\n      const { toastId } = action;\n\n      // ! Side effects ! - This could be extracted into a dismissToast() action,\n      // but I'll keep it here for simplicity\n      if (toastId) {\n        addToRemoveQueue(toastId);\n      } else {\n        state.toasts.forEach((toast) => {\n          addToRemoveQueue(toast.id);\n        });\n      }\n\n      return {\n        ...state,\n        toasts: state.toasts.map((t) =>\n          t.id === toastId || toastId === undefined\n            ? {\n                ...t,\n                open: false,\n              }\n            : t\n        ),\n      };\n    }\n    case actionTypes.REMOVE_TOAST:\n      if (action.toastId === undefined) {\n        return {\n          ...state,\n          toasts: [],\n        };\n      }\n      return {\n        ...state,\n        toasts: state.toasts.filter((t) => t.id !== action.toastId),\n      };\n  }\n};\n\nconst listeners = [];\n\nlet memoryState = { toasts: [] };\n\nfunction dispatch(action) {\n  memoryState = reducer(memoryState, action);\n  listeners.forEach((listener) => {\n    listener(memoryState);\n  });\n}\n\nfunction toast({ ...props }) {\n  const id = genId();\n\n  const update = (props) =>\n    dispatch({\n      type: actionTypes.UPDATE_TOAST,\n      toast: { ...props, id },\n    });\n\n  const dismiss = () =>\n    dispatch({ type: actionTypes.DISMISS_TOAST, toastId: id });\n\n  dispatch({\n    type: actionTypes.ADD_TOAST,\n    toast: {\n      ...props,\n      id,\n      open: true,\n      onOpenChange: (open) => {\n        if (!open) dismiss();\n      },\n    },\n  });\n\n  return {\n    id,\n    dismiss,\n    update,\n  };\n}\n\nfunction useToast() {\n  const [state, setState] = useState(memoryState);\n\n  useEffect(() => {\n    listeners.push(setState);\n    return () => {\n      const index = listeners.indexOf(setState);\n      if (index > -1) {\n        listeners.splice(index, 1);\n      }\n    };\n  }, [state]);\n\n  return {\n    ...state,\n    toast,\n    dismiss: (toastId) => dispatch({ type: actionTypes.DISMISS_TOAST, toastId }),\n  };\n}\n\nexport { useToast, toast }; ","path":null,"size_bytes":3401,"size_tokens":null},"src/App.jsx":{"content":"import './App.css'\nimport Pages from \"@/pages/index.jsx\"\nimport { Toaster } from \"sonner\"\nimport { QueryClient, QueryClientProvider } from '@tanstack/react-query'\nimport { UserProvider } from '@/contexts/UserContext'\nimport { CheckCircle2, XCircle, AlertCircle, Info } from 'lucide-react'\n\nconst queryClient = new QueryClient({\n  defaultOptions: {\n    queries: {\n      retry: 1,\n      refetchOnWindowFocus: false,\n    },\n  },\n})\n\nfunction App() {\n  return (\n    <QueryClientProvider client={queryClient}>\n      <UserProvider>\n        <Pages />\n        <Toaster \n          position=\"bottom-center\"\n          gap={8}\n          visibleToasts={3}\n          duration={2000}\n          toastOptions={{\n            unstyled: true,\n            classNames: {\n              toast: 'whatsapp-toast',\n              title: 'whatsapp-toast-title',\n              description: 'whatsapp-toast-description',\n              success: 'whatsapp-toast-success',\n              error: 'whatsapp-toast-error',\n              warning: 'whatsapp-toast-warning',\n              info: 'whatsapp-toast-info',\n            },\n          }}\n          icons={{\n            success: <CheckCircle2 className=\"w-5 h-5\" />,\n            error: <XCircle className=\"w-5 h-5\" />,\n            warning: <AlertCircle className=\"w-5 h-5\" />,\n            info: <Info className=\"w-5 h-5\" />,\n          }}\n        />\n      </UserProvider>\n    </QueryClientProvider>\n  )\n}\n\nexport default App ","path":null,"size_bytes":1439,"size_tokens":null},"src/components/shared/StatCard.jsx":{"content":"import React from \"react\";\nimport { Card, CardContent } from \"@/components/ui/card\";\nimport { Badge } from \"@/components/ui/badge\";\n\nexport default function StatCard({ icon: Icon, value, label, color, badge, bgGradient }) {\n  return (\n    <Card className={`border-0 shadow-lg ${bgGradient || 'bg-white'}`}>\n      <CardContent className=\"p-6\">\n        <div className=\"flex items-center justify-between mb-4\">\n          <div className={`w-12 h-12 rounded-xl bg-gradient-to-br ${color} flex items-center justify-center`}>\n            <Icon className=\"w-6 h-6 text-white\" />\n          </div>\n          {badge && <Badge className={badge.className}>{badge.text}</Badge>}\n        </div>\n        <div className=\"text-3xl font-bold text-slate-900 mb-1\">{value}</div>\n        <p className=\"text-slate-600 text-sm\">{label}</p>\n      </CardContent>\n    </Card>\n  );\n}","path":null,"size_bytes":855,"size_tokens":null},"src/pages/TicketView.jsx":{"content":"import React, { useState, useEffect } from \"react\";\nimport { base44 } from \"@/api/base44Client\";\nimport { useQuery, useMutation, useQueryClient } from \"@tanstack/react-query\";\nimport { useNavigate } from \"react-router-dom\";\nimport { createPageUrl } from \"@/utils\";\nimport { getUploadUrl } from \"@/utils/apiConfig\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Skeleton } from \"@/components/ui/skeleton\";\nimport { \n  Clock, \n  MapPin, \n  Users, \n  TrendingUp,\n  CheckCircle2,\n  XCircle,\n  AlertCircle,\n  Phone,\n  ArrowLeft,\n  Star,\n  Timer\n} from \"lucide-react\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport { Label } from \"@/components/ui/label\";\nimport { useConfirm } from \"@/hooks/useConfirm\";\nimport { toast } from \"sonner\";\nimport { useAutoTranslate } from \"@/hooks/useTranslate\";\nimport { navigateBackOrFallback } from '@/hooks/useNavigateBack';\n\nconst statusColors = {\n  aguardando: { icon: Clock, color: \"bg-blue-100 text-blue-700 border-blue-200\" },\n  chamado: { icon: Phone, color: \"bg-amber-100 text-amber-700 border-amber-200\" },\n  atendendo: { icon: Users, color: \"bg-purple-100 text-purple-700 border-purple-200\" },\n  concluido: { icon: CheckCircle2, color: \"bg-green-100 text-green-700 border-green-200\" },\n  cancelado: { icon: XCircle, color: \"bg-red-100 text-red-700 border-red-200\" }\n};\n\nexport default function TicketViewPage() {\n  const navigate = useNavigate();\n  const queryClient = useQueryClient();\n  const urlParams = new URLSearchParams(window.location.search);\n  const ticketId = urlParams.get('id');\n  const [showFeedback, setShowFeedback] = useState(false);\n  const [rating, setRating] = useState(0);\n  const [feedback, setFeedback] = useState('');\n  const [, forceUpdate] = useState(0);\n  const { confirm, ConfirmDialog } = useConfirm();\n\n  const txtWaiting = useAutoTranslate('Aguardando', 'pt');\n  const txtCalled = useAutoTranslate('Chamado', 'pt');\n  const txtInService = useAutoTranslate('Em Atendimento', 'pt');\n  const txtCompleted = useAutoTranslate('Concluído', 'pt');\n  const txtCancelled = useAutoTranslate('Cancelado', 'pt');\n  const txtCancelSuccess = useAutoTranslate('Senha cancelada com sucesso', 'pt');\n  const txtCancelError = useAutoTranslate('Erro ao cancelar senha', 'pt');\n  const txtBack = useAutoTranslate('Anterior', 'pt');\n  const txtBackToDashboard = useAutoTranslate('Voltar ao Dashboard', 'pt');\n  const txtCancelTicket = useAutoTranslate('Cancelar Senha', 'pt');\n  const txtCancelTicketConfirm = useAutoTranslate('Tem certeza que deseja cancelar esta senha? Esta ação não pode ser desfeita.', 'pt');\n  const txtTicketNotFound = useAutoTranslate('Senha não encontrada', 'pt');\n  const txtTicketNotFoundDesc = useAutoTranslate('Não foi possível encontrar esta senha', 'pt');\n  const txtCanceling = useAutoTranslate('Cancelando...', 'pt');\n  const txtHowWasService = useAutoTranslate('Como foi o atendimento?', 'pt');\n  const txtRating = useAutoTranslate('Avaliação', 'pt');\n  const txtCommentOptional = useAutoTranslate('Comentário (opcional)', 'pt');\n  const txtTellExperience = useAutoTranslate('Conte-nos sobre sua experiência...', 'pt');\n  const txtSending = useAutoTranslate('Enviando...', 'pt');\n  const txtSubmitRating = useAutoTranslate('Enviar Avaliação', 'pt');\n  const txtYourRating = useAutoTranslate('Sua avaliação:', 'pt');\n  const txtTips = useAutoTranslate('Dicas', 'pt');\n  const txtAutoUpdate = useAutoTranslate('Esta página atualiza automaticamente', 'pt');\n  const txtAutoUpdateDesc = useAutoTranslate('Não precisa recarregar, as informações são atualizadas em tempo real', 'pt');\n  const txtStayAlert = useAutoTranslate('Fique atento às notificações', 'pt');\n  const txtStayAlertDesc = useAutoTranslate('Você receberá um aviso quando estiver próximo da sua vez', 'pt');\n  const txtCanLeave = useAutoTranslate('Pode sair e voltar', 'pt');\n  const txtCanLeaveDesc = useAutoTranslate('Aproveite o tempo de espera para fazer outras coisas', 'pt');\n  const txtInQueue = useAutoTranslate('Você está na fila', 'pt');\n  const txtYourTurn = useAutoTranslate('É a sua vez! Dirija-se ao atendimento', 'pt');\n  const txtBeingServed = useAutoTranslate('Você está sendo atendido', 'pt');\n  const txtServiceFinished = useAutoTranslate('Atendimento finalizado', 'pt');\n  const txtTicketCancelled = useAutoTranslate('Senha cancelada', 'pt');\n  const txtAheadOfYou = useAutoTranslate('Na sua frente', 'pt');\n  const txtMinutes = useAutoTranslate('Minutos', 'pt');\n  const txtBeingAttended = useAutoTranslate('Sendo atendido', 'pt');\n  const txtItsYourTurn = useAutoTranslate('É A SUA VEZ!', 'pt');\n  const txtGoToService = useAutoTranslate('Dirija-se ao local de atendimento agora', 'pt');\n  const txtTimeRemaining = useAutoTranslate('Tempo restante', 'pt');\n  const txtMinutesToPresent = useAutoTranslate('minutos para se apresentar', 'pt');\n  const txtSecondsRemaining = useAutoTranslate('segundos restantes', 'pt');\n\n  useEffect(() => {\n    const interval = setInterval(() => {\n      forceUpdate(prev => prev + 1);\n    }, 60000);\n    return () => clearInterval(interval);\n  }, []);\n\n  const { data: ticket, isLoading: loadingTicket } = useQuery({\n    queryKey: ['ticket', ticketId],\n    queryFn: async () => {\n      const tickets = await base44.entities.Ticket.filter({ id: ticketId });\n      const t = tickets[0];\n      \n      if (t?.status === 'concluido' && !t.rating) {\n        setShowFeedback(true);\n      }\n      \n      return t;\n    },\n    enabled: !!ticketId,\n    refetchInterval: 5000,\n  });\n\n  const { data: business } = useQuery({\n    queryKey: ['business', ticket?.business_id],\n    queryFn: async () => {\n      const businesses = await base44.entities.Business.filter({ id: ticket.business_id });\n      return businesses[0];\n    },\n    enabled: !!ticket?.business_id,\n  });\n\n  const { data: queue } = useQuery({\n    queryKey: ['queue', ticket?.queue_id],\n    queryFn: async () => {\n      const queues = await base44.entities.Queue.filter({ id: ticket.queue_id });\n      return queues[0];\n    },\n    enabled: !!ticket?.queue_id,\n    refetchInterval: 5000,\n  });\n\n  const { data: allTickets } = useQuery({\n    queryKey: ['queue-tickets', ticket?.queue_id],\n    queryFn: () => base44.entities.Ticket.filter({ \n      queue_id: ticket.queue_id,\n      status: { $in: ['aguardando', 'chamado', 'atendendo'] }\n    }),\n    enabled: !!ticket?.queue_id,\n    refetchInterval: 5000,\n    initialData: [],\n  });\n\n  const expireTicketMutation = useMutation({\n    mutationFn: async () => {\n      await base44.entities.Ticket.update(ticketId, {\n        status: 'cancelado',\n        completed_at: new Date().toISOString()\n      });\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['ticket'] });\n    }\n  });\n\n  useEffect(() => {\n    if (!ticket || !queue || !['aguardando', 'chamado'].includes(ticket.status)) return;\n\n    const checkExpiration = () => {\n      const now = new Date();\n\n      if (ticket.status === 'chamado' && ticket.called_at) {\n        const calledAt = new Date(ticket.called_at);\n        const toleranceMs = (queue.tolerance_time || 15) * 60 * 1000;\n        if (now - calledAt > toleranceMs) {\n          expireTicketMutation.mutate();\n        }\n      }\n\n      if (ticket.status === 'aguardando') {\n        const currentNumber = queue.current_number;\n        if (ticket.ticket_number < currentNumber) {\n          expireTicketMutation.mutate();\n        }\n      }\n    };\n\n    checkExpiration();\n    const interval = setInterval(checkExpiration, 5000);\n\n    return () => clearInterval(interval);\n  }, [ticket, queue, expireTicketMutation]);\n\n  const cancelMutation = useMutation({\n    mutationFn: async () => {\n      await base44.entities.Ticket.update(ticketId, {\n        status: 'cancelado'\n      });\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['ticket'] });\n      toast.success(txtCancelSuccess);\n    },\n    onError: () => {\n      toast.error(txtCancelError);\n    }\n  });\n\n  const submitFeedbackMutation = useMutation({\n    mutationFn: async () => {\n      await base44.entities.Ticket.update(ticketId, {\n        rating,\n        feedback\n      });\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['ticket'] });\n      setShowFeedback(false);\n    },\n  });\n\n  const handleCancel = async () => {\n    const confirmed = await confirm({\n      title: txtCancelTicket,\n      description: txtCancelTicketConfirm,\n    });\n    if (confirmed) {\n      cancelMutation.mutate();\n    }\n  };\n\n  if (loadingTicket) {\n    return (\n      <div className=\"bg-gradient-to-br from-slate-50 via-blue-50 to-sky-50 px-4 sm:px-6 py-4 sm:py-6 lg:py-8\">\n        <div className=\"max-w-2xl mx-auto\">\n          <Skeleton className=\"h-96 w-full\" />\n        </div>\n      </div>\n    );\n  }\n\n  if (!ticket) {\n    return (\n      <div className=\"bg-gradient-to-br from-slate-50 via-blue-50 to-sky-50 px-4 sm:px-6 py-4 sm:py-6 lg:py-8\">\n        <div className=\"max-w-2xl mx-auto\">\n          <Card>\n            <CardContent className=\"py-12 sm:py-16 text-center px-4 sm:px-6\">\n              <AlertCircle className=\"w-12 h-12 sm:w-16 sm:h-16 text-slate-400 mx-auto mb-4\" />\n              <h3 className=\"text-xl sm:text-2xl font-bold text-slate-900 mb-2\">{txtTicketNotFound}</h3>\n              <p className=\"text-sm sm:text-base text-slate-600 mb-6\">{txtTicketNotFoundDesc}</p>\n              <Button className=\"sm:h-11\" onClick={() => navigate(createPageUrl('Dashboard'))}>\n                {txtBackToDashboard}\n              </Button>\n            </CardContent>\n          </Card>\n        </div>\n      </div>\n    );\n  }\n\n  const statusInfo = statusColors[ticket.status] || statusColors.aguardando;\n  const StatusIcon = statusInfo.icon;\n  \n  // Mapeamento dinâmico de labels e descrições traduzidas\n  const statusLabels = {\n    aguardando: txtWaiting,\n    chamado: txtCalled,\n    atendendo: txtInService,\n    concluido: txtCompleted,\n    cancelado: txtCancelled\n  };\n  \n  const statusDescriptions = {\n    aguardando: txtInQueue,\n    chamado: txtYourTurn,\n    atendendo: txtBeingServed,\n    concluido: txtServiceFinished,\n    cancelado: txtTicketCancelled\n  };\n  \n  const currentLabel = statusLabels[ticket.status] || txtWaiting;\n  const currentDescription = statusDescriptions[ticket.status] || txtInQueue;\n  \n  const position = queue ? Math.max(0, ticket.ticket_number - queue.current_number) : 0;\n  \n  const elapsedMinutes = ticket.created_date \n    ? Math.floor((Date.now() - new Date(ticket.created_date).getTime()) / (1000 * 60))\n    : 0;\n  const baseEstimatedTime = queue ? (position * (queue.average_service_time || 10)) : 0;\n  const estimatedTime = Math.max(0, baseEstimatedTime - elapsedMinutes);\n\n  // Calcular tempo de tolerância restante quando chamado\n  const toleranceTimeMinutes = queue?.tolerance_time || 15;\n  const toleranceRemainingSeconds = ticket.status === 'chamado' && ticket.called_at\n    ? Math.max(0, (toleranceTimeMinutes * 60) - Math.floor((Date.now() - new Date(ticket.called_at).getTime()) / 1000))\n    : toleranceTimeMinutes * 60;\n  const toleranceMinutes = Math.floor(toleranceRemainingSeconds / 60);\n  const toleranceSeconds = toleranceRemainingSeconds % 60;\n\n  return (\n    <div className=\"bg-gradient-to-br from-slate-50 via-blue-50 to-sky-50\">\n      <div className=\"max-w-2xl mx-auto px-4 sm:px-6 py-4 sm:py-6 lg:py-8\">\n        <Button\n          variant=\"outline\"\n          className=\"mb-3 sm:mb-6 gap-2 h-9 sm:h-11 text-sm\"\n          onClick={() => navigateBackOrFallback(navigate, '/dashboard')}\n        >\n          <ArrowLeft className=\"w-4 h-4\" />\n          {txtBack}\n        </Button>\n\n        <Card className=\"border-0 shadow-2xl mb-3 sm:mb-6 overflow-hidden\">\n          <div className={`h-1.5 sm:h-2 bg-gradient-to-r ${\n            ticket.status === 'aguardando' ? 'from-blue-500 to-cyan-500' :\n            ticket.status === 'chamado' ? 'from-amber-500 to-orange-500' :\n            ticket.status === 'atendendo' ? 'from-purple-500 to-pink-500' :\n            ticket.status === 'concluido' ? 'from-green-500 to-emerald-500' :\n            'from-red-500 to-rose-500'\n          }`} />\n          \n          <CardContent className=\"p-4 sm:p-6\">\n            <div className=\"text-center mb-4 sm:mb-6\">\n              <div className=\"inline-flex items-center justify-center w-18 h-18 sm:w-24 sm:h-24 rounded-full bg-gradient-to-br from-sky-500 to-blue-600 mb-3 sm:mb-4\" style={{width: '72px', height: '72px'}}>\n                <span className=\"text-2xl sm:text-4xl font-bold text-white\">#{ticket.ticket_number}</span>\n              </div>\n              \n              <Badge className={`${statusInfo.color} text-sm px-3 py-1 mb-1.5 sm:mb-2`}>\n                <StatusIcon className=\"w-3.5 h-3.5 mr-1.5\" />\n                {currentLabel}\n              </Badge>\n              \n              <p className=\"text-slate-600 text-sm sm:text-lg\">{currentDescription}</p>\n            </div>\n\n            <div className=\"bg-slate-50 rounded-xl p-3 sm:p-6 mb-3 sm:mb-6\">\n              <div className=\"flex items-start gap-3\">\n                {business?.logo_url && (\n                  <img \n                    src={getUploadUrl(business.logo_url)} \n                    alt={business.name}\n                    className=\"w-10 h-10 sm:w-16 sm:h-16 rounded-lg object-contain bg-white p-1 sm:p-2 flex-shrink-0\"\n                    onError={(e) => { e.target.style.display = 'none'; }}\n                  />\n                )}\n                <div className=\"flex-1 min-w-0\">\n                  <h3 className=\"font-bold text-base sm:text-xl text-slate-900 mb-0.5 sm:mb-1 truncate\">{business?.name}</h3>\n                  <p className=\"text-xs sm:text-base text-slate-600 mb-1 sm:mb-2 truncate\">{queue?.name}</p>\n                  {business?.address && (\n                    <div className=\"flex items-center gap-1.5 text-[11px] sm:text-sm text-slate-500\">\n                      <MapPin className=\"w-3 h-3 sm:w-4 sm:h-4 flex-shrink-0\" />\n                      <span className=\"truncate\">{business.address}</span>\n                    </div>\n                  )}\n                </div>\n              </div>\n            </div>\n\n            {['aguardando', 'chamado'].includes(ticket.status) && (\n              <div className=\"grid grid-cols-3 gap-2 sm:gap-4 mb-3 sm:mb-6\">\n                <div className=\"bg-gradient-to-br from-blue-50 to-cyan-50 rounded-xl p-2.5 sm:p-4 text-center\">\n                  <Users className=\"w-4 h-4 sm:w-5 sm:h-5 text-blue-600 mx-auto mb-1 sm:mb-2\" />\n                  <div className=\"text-lg sm:text-2xl font-bold text-blue-600\">{position}</div>\n                  <div className=\"text-[10px] sm:text-xs text-slate-600 leading-tight\">{txtAheadOfYou}</div>\n                </div>\n                \n                <div className=\"bg-gradient-to-br from-purple-50 to-pink-50 rounded-xl p-2.5 sm:p-4 text-center\">\n                  <Clock className=\"w-4 h-4 sm:w-5 sm:h-5 text-purple-600 mx-auto mb-1 sm:mb-2\" />\n                  <div className=\"text-lg sm:text-2xl font-bold text-purple-600\">~{estimatedTime}</div>\n                  <div className=\"text-[10px] sm:text-xs text-slate-600 leading-tight\">{txtMinutes}</div>\n                </div>\n                \n                <div className=\"bg-gradient-to-br from-green-50 to-emerald-50 rounded-xl p-2.5 sm:p-4 text-center\">\n                  <TrendingUp className=\"w-4 h-4 sm:w-5 sm:h-5 text-green-600 mx-auto mb-1 sm:mb-2\" />\n                  <div className=\"text-lg sm:text-2xl font-bold text-green-600\">#{queue?.current_number || 0}</div>\n                  <div className=\"text-[10px] sm:text-xs text-slate-600 leading-tight\">{txtBeingAttended}</div>\n                </div>\n              </div>\n            )}\n\n            {ticket.status === 'chamado' && (\n              <div className=\"bg-gradient-to-r from-amber-500 to-orange-500 text-white rounded-xl p-4 sm:p-6 mb-3 sm:mb-6 text-center animate-pulse\">\n                <Phone className=\"w-8 h-8 sm:w-12 sm:h-12 mx-auto mb-2 sm:mb-3\" />\n                <h4 className=\"text-lg sm:text-2xl font-bold mb-1.5 sm:mb-2\">{txtItsYourTurn}</h4>\n                <p className=\"text-sm sm:text-lg mb-2 sm:mb-4\">{txtGoToService}</p>\n                \n                <div className=\"bg-white/20 rounded-lg p-2.5 sm:p-4 mt-2 sm:mt-4\">\n                  <div className=\"flex items-center justify-center gap-1.5 sm:gap-2 mb-1 sm:mb-2\">\n                    <Timer className=\"w-3.5 h-3.5 sm:w-5 sm:h-5\" />\n                    <span className=\"text-xs sm:text-base font-medium\">{txtTimeRemaining}</span>\n                  </div>\n                  <div className=\"text-xl sm:text-3xl font-bold\">\n                    {toleranceMinutes}:{toleranceSeconds.toString().padStart(2, '0')}\n                  </div>\n                  <div className=\"text-[10px] sm:text-sm opacity-90\">{txtMinutesToPresent}</div>\n                </div>\n              </div>\n            )}\n\n            {['aguardando', 'chamado'].includes(ticket.status) && (\n              <Button\n                variant=\"outline\"\n                className=\"w-full border-red-200 text-red-600 hover:bg-red-50 h-10 sm:h-11 text-sm\"\n                onClick={handleCancel}\n                disabled={cancelMutation.isPending}\n              >\n                <XCircle className=\"w-4 h-4 mr-2\" />\n                {cancelMutation.isPending ? txtCanceling : txtCancelTicket}\n              </Button>\n            )}\n\n            {showFeedback && (\n              <div className=\"mt-3 sm:mt-6 p-3 sm:p-6 bg-gradient-to-br from-amber-50 to-orange-50 rounded-xl\">\n                <h4 className=\"font-bold text-sm sm:text-lg text-slate-900 mb-2 sm:mb-4\">{txtHowWasService}</h4>\n                \n                <Label className=\"mb-1.5 block text-xs sm:text-base\">{txtRating}</Label>\n                <div className=\"flex gap-1 sm:gap-2 mb-3 sm:mb-4\">\n                  {[1, 2, 3, 4, 5].map(star => (\n                    <button\n                      key={star}\n                      onClick={() => setRating(star)}\n                      className={`p-2 rounded-lg transition-all min-w-[40px] min-h-[40px] sm:min-w-[44px] sm:min-h-[44px] flex items-center justify-center ${\n                        rating >= star \n                          ? 'bg-amber-500 text-white' \n                          : 'bg-white text-slate-400 hover:bg-slate-100'\n                      }`}\n                    >\n                      <Star className=\"w-4 h-4 sm:w-6 sm:h-6\" fill={rating >= star ? 'currentColor' : 'none'} />\n                    </button>\n                  ))}\n                </div>\n\n                <Label htmlFor=\"feedback\" className=\"mb-1.5 block text-xs sm:text-base\">{txtCommentOptional}</Label>\n                <Textarea\n                  id=\"feedback\"\n                  value={feedback}\n                  onChange={(e) => setFeedback(e.target.value)}\n                  placeholder={txtTellExperience}\n                  rows={2}\n                  className=\"mb-3 sm:mb-4 text-sm sm:text-base\"\n                />\n\n                <Button\n                  className=\"w-full bg-gradient-to-r from-amber-500 to-orange-500 hover:from-amber-600 hover:to-orange-600 h-10 sm:h-11 text-sm\"\n                  onClick={() => submitFeedbackMutation.mutate()}\n                  disabled={rating === 0 || submitFeedbackMutation.isPending}\n                >\n                  {submitFeedbackMutation.isPending ? txtSending : txtSubmitRating}\n                </Button>\n              </div>\n            )}\n\n            {ticket.rating && !showFeedback && (\n              <div className=\"mt-3 sm:mt-6 p-3 sm:p-4 bg-slate-50 rounded-xl\">\n                <div className=\"flex items-center gap-2 mb-1.5 sm:mb-2\">\n                  <span className=\"text-xs text-slate-600\">{txtYourRating}</span>\n                  <div className=\"flex gap-0.5\">\n                    {[1, 2, 3, 4, 5].map(star => (\n                      <Star \n                        key={star} \n                        className={`w-3.5 h-3.5 sm:w-4 sm:h-4 ${ticket.rating >= star ? 'text-amber-500 fill-amber-500' : 'text-slate-300'}`}\n                      />\n                    ))}\n                  </div>\n                </div>\n                {ticket.feedback && (\n                  <p className=\"text-xs sm:text-sm text-slate-700 italic\">&quot;{ticket.feedback}&quot;</p>\n                )}\n              </div>\n            )}\n          </CardContent>\n        </Card>\n\n        {['aguardando', 'chamado'].includes(ticket.status) && (\n          <Card className=\"border-0 shadow-lg\">\n            <CardHeader className=\"px-4 py-3 sm:py-4\">\n              <CardTitle className=\"text-sm sm:text-lg\">{txtTips}</CardTitle>\n            </CardHeader>\n            <CardContent className=\"space-y-2 sm:space-y-3 px-4 pb-4 pt-0\">\n              <div className=\"flex gap-2 sm:gap-3\">\n                <CheckCircle2 className=\"w-4 h-4 text-green-600 flex-shrink-0 mt-0.5\" />\n                <div>\n                  <p className=\"font-semibold text-xs sm:text-base text-slate-900\">{txtAutoUpdate}</p>\n                  <p className=\"text-[10px] sm:text-sm text-slate-600\">{txtAutoUpdateDesc}</p>\n                </div>\n              </div>\n              \n              <div className=\"flex gap-2 sm:gap-3\">\n                <CheckCircle2 className=\"w-4 h-4 text-green-600 flex-shrink-0 mt-0.5\" />\n                <div>\n                  <p className=\"font-semibold text-xs sm:text-base text-slate-900\">{txtStayAlert}</p>\n                  <p className=\"text-[10px] sm:text-sm text-slate-600\">{txtStayAlertDesc}</p>\n                </div>\n              </div>\n              \n              <div className=\"flex gap-2 sm:gap-3\">\n                <CheckCircle2 className=\"w-4 h-4 text-green-600 flex-shrink-0 mt-0.5\" />\n                <div>\n                  <p className=\"font-semibold text-xs sm:text-base text-slate-900\">{txtCanLeave}</p>\n                  <p className=\"text-[10px] sm:text-sm text-slate-600\">{txtCanLeaveDesc}</p>\n                </div>\n              </div>\n            </CardContent>\n          </Card>\n        )}\n      </div>\n      <ConfirmDialog />\n    </div>\n  );\n}","path":null,"size_bytes":22202,"size_tokens":null},"src/components/business/NotificationSettings.jsx":{"content":"import React, { useState } from \"react\";\nimport { base44 } from \"@/api/base44Client\";\nimport { useMutation, useQueryClient } from \"@tanstack/react-query\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Label } from \"@/components/ui/label\";\nimport { Switch } from \"@/components/ui/switch\";\nimport { Input } from \"@/components/ui/input\";\nimport { Bell, Save } from \"lucide-react\";\nimport { useAutoTranslate } from \"@/hooks/useTranslate\";\n\nexport default function NotificationSettings({ queue }) {\n  const txtAutoNotifications = useAutoTranslate('Notificações Automáticas', 'pt');\n  const txtEnableNotifications = useAutoTranslate('Ativar Notificações', 'pt');\n  const txtWarnWhenRemaining = useAutoTranslate('Avisar quando faltarem (senhas)', 'pt');\n  const txtClientNotified = useAutoTranslate('O cliente será notificado quando faltarem esta quantidade de senhas', 'pt');\n  const txtSaving = useAutoTranslate('Salvando...', 'pt');\n  const txtSaveSettings = useAutoTranslate('Salvar Configurações', 'pt');\n  const queryClient = useQueryClient();\n  const [enabled, setEnabled] = useState(queue.notifications_enabled ?? true);\n  const [settings, setSettings] = useState(queue.notification_settings || {\n    email: true,\n    sms: false,\n    advance_notice: 2\n  });\n\n  const updateMutation = useMutation({\n    mutationFn: (data) => base44.entities.Queue.update(queue.id, data),\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['business-queues'] });\n    },\n  });\n\n  const handleSave = () => {\n    updateMutation.mutate({\n      notifications_enabled: enabled,\n      notification_settings: settings\n    });\n  };\n\n  return (\n    <Card className=\"border-0 shadow-lg\">\n      <CardHeader>\n        <CardTitle className=\"flex items-center gap-2\">\n          <Bell className=\"w-5 h-5\" />\n          {txtAutoNotifications}\n        </CardTitle>\n      </CardHeader>\n      <CardContent className=\"space-y-4\">\n        <div className=\"flex items-center justify-between p-3 bg-slate-50 rounded-lg\">\n          <Label className=\"font-semibold\">{txtEnableNotifications}</Label>\n          <Switch checked={enabled} onCheckedChange={setEnabled} />\n        </div>\n\n        {enabled && (\n          <div>\n            <Label>{txtWarnWhenRemaining}</Label>\n            <Input\n              type=\"number\"\n              min=\"1\"\n              max=\"10\"\n              value={settings.advance_notice}\n              onChange={(e) => setSettings({...settings, advance_notice: parseInt(e.target.value)})}\n              className=\"mt-2\"\n            />\n            <p className=\"text-xs text-slate-500 mt-1\">\n              {txtClientNotified}\n            </p>\n          </div>\n        )}\n\n        <Button \n          onClick={handleSave}\n          disabled={updateMutation.isPending}\n          className=\"w-full gap-2\"\n        >\n          <Save className=\"w-4 h-4\" />\n          {updateMutation.isPending ? txtSaving : txtSaveSettings}\n        </Button>\n      </CardContent>\n    </Card>\n  );\n}","path":null,"size_bytes":3069,"size_tokens":null},"src/hooks/use-mobile.jsx":{"content":"import * as React from \"react\"\n\nconst MOBILE_BREAKPOINT = 768\n\nexport function useIsMobile() {\n  const [isMobile, setIsMobile] = React.useState(undefined)\n\n  React.useEffect(() => {\n    const mql = window.matchMedia(`(max-width: ${MOBILE_BREAKPOINT - 1}px)`)\n    const onChange = () => {\n      setIsMobile(window.innerWidth < MOBILE_BREAKPOINT)\n    }\n    mql.addEventListener(\"change\", onChange)\n    setIsMobile(window.innerWidth < MOBILE_BREAKPOINT)\n    return () => mql.removeEventListener(\"change\", onChange);\n  }, [])\n\n  return !!isMobile\n}\n","path":null,"size_bytes":545,"size_tokens":null},"src/components/ui/textarea.jsx":{"content":"import * as React from \"react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Textarea = React.forwardRef(({ className, ...props }, ref) => {\n  return (\n    (<textarea\n      className={cn(\n        \"flex min-h-[60px] w-full rounded-md border border-input bg-transparent px-3 py-2 text-base shadow-sm placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:cursor-not-allowed disabled:opacity-50 md:text-sm\",\n        className\n      )}\n      ref={ref}\n      {...props} />)\n  );\n})\nTextarea.displayName = \"Textarea\"\n\nexport { Textarea }\n","path":null,"size_bytes":587,"size_tokens":null},"src/components/ui/accordion.jsx":{"content":"import * as React from \"react\"\nimport * as AccordionPrimitive from \"@radix-ui/react-accordion\"\nimport { ChevronDown } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Accordion = AccordionPrimitive.Root\n\nconst AccordionItem = React.forwardRef(({ className, ...props }, ref) => (\n  <AccordionPrimitive.Item ref={ref} className={cn(\"border-b\", className)} {...props} />\n))\nAccordionItem.displayName = \"AccordionItem\"\n\nconst AccordionTrigger = React.forwardRef(({ className, children, ...props }, ref) => (\n  <AccordionPrimitive.Header className=\"flex\">\n    <AccordionPrimitive.Trigger\n      ref={ref}\n      className={cn(\n        \"flex flex-1 items-center justify-between py-4 text-sm font-medium transition-all hover:underline text-left [&[data-state=open]>svg]:rotate-180\",\n        className\n      )}\n      {...props}>\n      {children}\n      <ChevronDown\n        className=\"h-4 w-4 shrink-0 text-muted-foreground transition-transform duration-200\" />\n    </AccordionPrimitive.Trigger>\n  </AccordionPrimitive.Header>\n))\nAccordionTrigger.displayName = AccordionPrimitive.Trigger.displayName\n\nconst AccordionContent = React.forwardRef(({ className, children, ...props }, ref) => (\n  <AccordionPrimitive.Content\n    ref={ref}\n    className=\"overflow-hidden text-sm data-[state=closed]:animate-accordion-up data-[state=open]:animate-accordion-down\"\n    {...props}>\n    <div className={cn(\"pb-4 pt-0\", className)}>{children}</div>\n  </AccordionPrimitive.Content>\n))\nAccordionContent.displayName = AccordionPrimitive.Content.displayName\n\nexport { Accordion, AccordionItem, AccordionTrigger, AccordionContent }\n","path":null,"size_bytes":1615,"size_tokens":null},"src/components/ui/dropdown-menu.jsx":{"content":"import * as React from \"react\"\nimport * as DropdownMenuPrimitive from \"@radix-ui/react-dropdown-menu\"\nimport { Check, ChevronRight, Circle } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst DropdownMenu = DropdownMenuPrimitive.Root\n\nconst DropdownMenuTrigger = DropdownMenuPrimitive.Trigger\n\nconst DropdownMenuGroup = DropdownMenuPrimitive.Group\n\nconst DropdownMenuPortal = DropdownMenuPrimitive.Portal\n\nconst DropdownMenuSub = DropdownMenuPrimitive.Sub\n\nconst DropdownMenuRadioGroup = DropdownMenuPrimitive.RadioGroup\n\nconst DropdownMenuSubTrigger = React.forwardRef(({ className, inset, children, ...props }, ref) => (\n  <DropdownMenuPrimitive.SubTrigger\n    ref={ref}\n    className={cn(\n      \"flex cursor-default gap-2 select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none focus:bg-accent data-[state=open]:bg-accent [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}>\n    {children}\n    <ChevronRight className=\"ml-auto\" />\n  </DropdownMenuPrimitive.SubTrigger>\n))\nDropdownMenuSubTrigger.displayName =\n  DropdownMenuPrimitive.SubTrigger.displayName\n\nconst DropdownMenuSubContent = React.forwardRef(({ className, ...props }, ref) => (\n  <DropdownMenuPrimitive.SubContent\n    ref={ref}\n    className={cn(\n      \"z-50 min-w-[8rem] overflow-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-lg data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2\",\n      className\n    )}\n    {...props} />\n))\nDropdownMenuSubContent.displayName =\n  DropdownMenuPrimitive.SubContent.displayName\n\nconst DropdownMenuContent = React.forwardRef(({ className, sideOffset = 4, ...props }, ref) => (\n  <DropdownMenuPrimitive.Portal>\n    <DropdownMenuPrimitive.Content\n      ref={ref}\n      sideOffset={sideOffset}\n      className={cn(\n        \"z-50 min-w-[8rem] overflow-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-md\",\n        \"data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2\",\n        className\n      )}\n      {...props} />\n  </DropdownMenuPrimitive.Portal>\n))\nDropdownMenuContent.displayName = DropdownMenuPrimitive.Content.displayName\n\nconst DropdownMenuItem = React.forwardRef(({ className, inset, ...props }, ref) => (\n  <DropdownMenuPrimitive.Item\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center gap-2 rounded-sm px-2 py-1.5 text-sm outline-none transition-colors focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50 [&>svg]:size-4 [&>svg]:shrink-0\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props} />\n))\nDropdownMenuItem.displayName = DropdownMenuPrimitive.Item.displayName\n\nconst DropdownMenuCheckboxItem = React.forwardRef(({ className, children, checked, ...props }, ref) => (\n  <DropdownMenuPrimitive.CheckboxItem\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none transition-colors focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      className\n    )}\n    checked={checked}\n    {...props}>\n    <span className=\"absolute left-2 flex h-3.5 w-3.5 items-center justify-center\">\n      <DropdownMenuPrimitive.ItemIndicator>\n        <Check className=\"h-4 w-4\" />\n      </DropdownMenuPrimitive.ItemIndicator>\n    </span>\n    {children}\n  </DropdownMenuPrimitive.CheckboxItem>\n))\nDropdownMenuCheckboxItem.displayName =\n  DropdownMenuPrimitive.CheckboxItem.displayName\n\nconst DropdownMenuRadioItem = React.forwardRef(({ className, children, ...props }, ref) => (\n  <DropdownMenuPrimitive.RadioItem\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none transition-colors focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      className\n    )}\n    {...props}>\n    <span className=\"absolute left-2 flex h-3.5 w-3.5 items-center justify-center\">\n      <DropdownMenuPrimitive.ItemIndicator>\n        <Circle className=\"h-2 w-2 fill-current\" />\n      </DropdownMenuPrimitive.ItemIndicator>\n    </span>\n    {children}\n  </DropdownMenuPrimitive.RadioItem>\n))\nDropdownMenuRadioItem.displayName = DropdownMenuPrimitive.RadioItem.displayName\n\nconst DropdownMenuLabel = React.forwardRef(({ className, inset, ...props }, ref) => (\n  <DropdownMenuPrimitive.Label\n    ref={ref}\n    className={cn(\"px-2 py-1.5 text-sm font-semibold\", inset && \"pl-8\", className)}\n    {...props} />\n))\nDropdownMenuLabel.displayName = DropdownMenuPrimitive.Label.displayName\n\nconst DropdownMenuSeparator = React.forwardRef(({ className, ...props }, ref) => (\n  <DropdownMenuPrimitive.Separator\n    ref={ref}\n    className={cn(\"-mx-1 my-1 h-px bg-muted\", className)}\n    {...props} />\n))\nDropdownMenuSeparator.displayName = DropdownMenuPrimitive.Separator.displayName\n\nconst DropdownMenuShortcut = ({\n  className,\n  ...props\n}) => {\n  return (\n    (<span\n      className={cn(\"ml-auto text-xs tracking-widest opacity-60\", className)}\n      {...props} />)\n  );\n}\nDropdownMenuShortcut.displayName = \"DropdownMenuShortcut\"\n\nexport {\n  DropdownMenu,\n  DropdownMenuTrigger,\n  DropdownMenuContent,\n  DropdownMenuItem,\n  DropdownMenuCheckboxItem,\n  DropdownMenuRadioItem,\n  DropdownMenuLabel,\n  DropdownMenuSeparator,\n  DropdownMenuShortcut,\n  DropdownMenuGroup,\n  DropdownMenuPortal,\n  DropdownMenuSub,\n  DropdownMenuSubContent,\n  DropdownMenuSubTrigger,\n  DropdownMenuRadioGroup,\n}\n","path":null,"size_bytes":6157,"size_tokens":null},"src/components/shared/TrialBanner.jsx":{"content":"import React, { useState, useEffect } from \"react\";\nimport { base44 } from \"@/api/base44Client\";\nimport { useQuery } from \"@tanstack/react-query\";\nimport { Card, CardContent } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Link } from \"react-router-dom\";\nimport { createPageUrl } from \"@/utils\";\nimport { Clock, AlertCircle, Crown, Globe } from \"lucide-react\";\nimport { useAutoTranslate } from \"@/hooks/useTranslate\";\nimport { Capacitor } from \"@capacitor/core\";\n\nexport default function TrialBanner({ user }) {\n  const isNativeApp = Capacitor.isNativePlatform();\n  \n  // Traduções\n  const txtTrialExpired = useAutoTranslate('Trial Expirado', 'pt');\n  const txtTrialExpiredDesc = useAutoTranslate('O seu período gratuito terminou. Subscreva para continuar a usar a plataforma.', 'pt');\n  const txtSubscribeMonth = useAutoTranslate('Subscrever', 'pt');\n  const txtFreeTrial = useAutoTranslate('Trial Gratuito', 'pt');\n  const txtDay = useAutoTranslate('dia', 'pt');\n  const txtDays = useAutoTranslate('dias', 'pt');\n  const txtRemaining = useAutoTranslate('restantes', 'pt');\n  const txtEnjoyPremium = useAutoTranslate('Aproveite todas as funcionalidades premium gratuitamente.', 'pt');\n  const txtThenOnly = useAutoTranslate('Depois apenas', 'pt');\n  const txtSubscribeNow = useAutoTranslate('Subscrever Agora', 'pt');\n  const txtVisitWebsite = useAutoTranslate('Subscreva em waitless-qzero.com', 'pt');\n  // CORREÇÃO: Mover useQuery ANTES do early return para garantir que hooks são sempre chamados\n  const { data: subscription } = useQuery({\n    queryKey: ['subscription', user?.email],\n    queryFn: async () => {\n      if (!user?.email) return null;\n      const subs = await base44.entities.Subscription.filter({ \n        user_email: user.email,\n        status: \"active\"\n      });\n      return subs[0] || null;\n    },\n    enabled: !!user?.email, // Só executar quando user existe\n  });\n\n  // Early return DEPOIS de todos os hooks\n  if (!user) return null;\n\n  // User already has active subscription\n  if (subscription) return null;\n\n  // Calculate trial days remaining\n  const trialStarted = user.trial_started_at ? new Date(user.trial_started_at) : new Date(user.created_date);\n  const now = new Date();\n  const daysElapsed = Math.floor((now - trialStarted) / (1000 * 60 * 60 * 24));\n  const daysRemaining = Math.max(0, 7 - daysElapsed);\n  const trialExpired = daysRemaining === 0;\n\n  // Don't show if trial just started (give them time to explore)\n  if (daysElapsed < 1 && !trialExpired) return null;\n\n  const isBusinessUser = user.is_business_user;\n  const planPrice = isBusinessUser ? 50 : 5;\n  const planType = isBusinessUser ? 'business' : 'premium';\n\n  if (trialExpired) {\n    return (\n      <Card className=\"border-2 border-red-200 bg-gradient-to-r from-red-50 to-orange-50 mb-6\">\n        <CardContent className=\"p-4\">\n          <div className=\"flex items-center justify-between gap-4\">\n            <div className=\"flex items-center gap-3\">\n              <AlertCircle className=\"w-6 h-6 text-red-600 flex-shrink-0\" />\n              <div>\n                <h3 className=\"font-bold text-red-900\">{txtTrialExpired}</h3>\n                <p className=\"text-sm text-red-700\">\n                  {txtTrialExpiredDesc}\n                </p>\n              </div>\n            </div>\n            \n            {/* 🍎🤖 B2B COMPLIANCE: Apps nativas NÃO podem ter botões de pagamento */}\n            {isNativeApp ? (\n              <div className=\"flex items-center gap-2 text-red-700\">\n                <Globe className=\"w-5 h-5\" />\n                <span className=\"text-sm font-semibold whitespace-nowrap\">{txtVisitWebsite}</span>\n              </div>\n            ) : (\n              <Link to={createPageUrl(`StripeCheckout?plan=${planType}`)}>\n                <Button className=\"bg-red-600 hover:bg-red-700 whitespace-nowrap\">\n                  {txtSubscribeMonth} €{planPrice}/mês\n                </Button>\n              </Link>\n            )}\n          </div>\n        </CardContent>\n      </Card>\n    );\n  }\n\n  return (\n    <Card className=\"border-2 border-amber-200 bg-gradient-to-r from-amber-50 to-orange-50 mb-6\">\n      <CardContent className=\"p-4\">\n        <div className=\"flex items-center justify-between gap-4\">\n          <div className=\"flex items-center gap-3\">\n            <Clock className=\"w-6 h-6 text-amber-600 flex-shrink-0\" />\n            <div>\n              <div className=\"flex items-center gap-2 mb-1\">\n                <h3 className=\"font-bold text-amber-900\">{txtFreeTrial}</h3>\n                <Badge className=\"bg-amber-600 text-white\">\n                  {daysRemaining} {daysRemaining === 1 ? txtDay : txtDays} {txtRemaining}\n                </Badge>\n              </div>\n              <p className=\"text-sm text-amber-700\">\n                {txtEnjoyPremium} {!isNativeApp && `${txtThenOnly} €${planPrice}/mês.`}\n              </p>\n            </div>\n          </div>\n          \n          {/* 🍎🤖 B2B COMPLIANCE: Apps nativas NÃO podem ter botões de pagamento */}\n          {isNativeApp ? (\n            <div className=\"flex items-center gap-2 text-amber-700\">\n              <Globe className=\"w-5 h-5\" />\n              <span className=\"text-sm font-semibold whitespace-nowrap\">{txtVisitWebsite}</span>\n            </div>\n          ) : (\n            <Link to={createPageUrl(`StripeCheckout?plan=${planType}`)}>\n              <Button className=\"bg-gradient-to-r from-amber-500 to-orange-600 hover:from-amber-600 hover:to-orange-700 whitespace-nowrap\">\n                <Crown className=\"w-4 h-4 mr-2\" />\n                {txtSubscribeNow}\n              </Button>\n            </Link>\n          )}\n        </div>\n      </CardContent>\n    </Card>\n  );\n}","path":null,"size_bytes":5778,"size_tokens":null},"src/components/ui/sidebar.jsx":{"content":"import * as React from \"react\"\nimport { Slot } from \"@radix-ui/react-slot\"\nimport { cva } from \"class-variance-authority\";\nimport { PanelLeft } from \"lucide-react\"\n\nimport { useIsMobile } from \"@/hooks/use-mobile\"\nimport { cn } from \"@/lib/utils\"\nimport { Button } from \"@/components/ui/button\"\nimport { Input } from \"@/components/ui/input\"\nimport { Separator } from \"@/components/ui/separator\"\nimport { Sheet, SheetContent, SheetTitle, SheetDescription } from \"@/components/ui/sheet\"\nimport { VisuallyHidden } from \"@radix-ui/react-visually-hidden\"\nimport { Skeleton } from \"@/components/ui/skeleton\"\nimport {\n  Tooltip,\n  TooltipContent,\n  TooltipProvider,\n  TooltipTrigger,\n} from \"@/components/ui/tooltip\"\n\nconst SIDEBAR_COOKIE_NAME = \"sidebar_state\"\nconst SIDEBAR_COOKIE_MAX_AGE = 60 * 60 * 24 * 7\nconst SIDEBAR_WIDTH = \"16rem\"\nconst SIDEBAR_WIDTH_MOBILE = \"18rem\"\nconst SIDEBAR_WIDTH_ICON = \"3rem\"\nconst SIDEBAR_KEYBOARD_SHORTCUT = \"b\"\n\nconst SidebarContext = React.createContext(null)\n\nfunction useSidebar() {\n  const context = React.useContext(SidebarContext)\n  if (!context) {\n    throw new Error(\"useSidebar must be used within a SidebarProvider.\")\n  }\n\n  return context\n}\n\nconst SidebarProvider = React.forwardRef((\n  {\n    defaultOpen = true,\n    open: openProp,\n    onOpenChange: setOpenProp,\n    className,\n    style,\n    children,\n    ...props\n  },\n  ref\n) => {\n  const isMobile = useIsMobile()\n  const [openMobile, setOpenMobile] = React.useState(false)\n\n  // This is the internal state of the sidebar.\n  // We use openProp and setOpenProp for control from outside the component.\n  const [_open, _setOpen] = React.useState(defaultOpen)\n  const open = openProp ?? _open\n  const setOpen = React.useCallback((value) => {\n    const openState = typeof value === \"function\" ? value(open) : value\n    if (setOpenProp) {\n      setOpenProp(openState)\n    } else {\n      _setOpen(openState)\n    }\n\n    // This sets the cookie to keep the sidebar state.\n    document.cookie = `${SIDEBAR_COOKIE_NAME}=${openState}; path=/; max-age=${SIDEBAR_COOKIE_MAX_AGE}`\n  }, [setOpenProp, open])\n\n  // Helper to toggle the sidebar.\n  const toggleSidebar = React.useCallback(() => {\n    return isMobile\n      ? setOpenMobile((open) => !open)\n      : setOpen((open) => !open);\n  }, [isMobile, setOpen, setOpenMobile])\n\n  // Adds a keyboard shortcut to toggle the sidebar.\n  React.useEffect(() => {\n    const handleKeyDown = (event) => {\n      if (\n        event.key === SIDEBAR_KEYBOARD_SHORTCUT &&\n        (event.metaKey || event.ctrlKey)\n      ) {\n        event.preventDefault()\n        toggleSidebar()\n      }\n    }\n\n    window.addEventListener(\"keydown\", handleKeyDown)\n    return () => window.removeEventListener(\"keydown\", handleKeyDown);\n  }, [toggleSidebar])\n\n  // We add a state so that we can do data-state=\"expanded\" or \"collapsed\".\n  // This makes it easier to style the sidebar with Tailwind classes.\n  const state = open ? \"expanded\" : \"collapsed\"\n\n  const contextValue = React.useMemo(() => ({\n    state,\n    open,\n    setOpen,\n    isMobile,\n    openMobile,\n    setOpenMobile,\n    toggleSidebar,\n  }), [state, open, setOpen, isMobile, openMobile, setOpenMobile, toggleSidebar])\n\n  return (\n    (<SidebarContext.Provider value={contextValue}>\n      <TooltipProvider delayDuration={0}>\n        <div\n          style={\n            {\n              \"--sidebar-width\": SIDEBAR_WIDTH,\n              \"--sidebar-width-icon\": SIDEBAR_WIDTH_ICON,\n              ...style\n            }\n          }\n          className={cn(\n            \"group/sidebar-wrapper flex min-h-svh w-full has-[[data-variant=inset]]:bg-sidebar\",\n            className\n          )}\n          ref={ref}\n          {...props}>\n          {children}\n        </div>\n      </TooltipProvider>\n    </SidebarContext.Provider>)\n  );\n})\nSidebarProvider.displayName = \"SidebarProvider\"\n\nconst Sidebar = React.forwardRef((\n  {\n    side = \"left\",\n    variant = \"sidebar\",\n    collapsible = \"offcanvas\",\n    className,\n    children,\n    ...props\n  },\n  ref\n) => {\n  const { isMobile, state, openMobile, setOpenMobile } = useSidebar()\n\n  if (collapsible === \"none\") {\n    return (\n      (<div\n        className={cn(\n          \"flex h-full w-[--sidebar-width] flex-col bg-sidebar text-sidebar-foreground\",\n          className\n        )}\n        ref={ref}\n        {...props}>\n        {children}\n      </div>)\n    );\n  }\n\n  if (isMobile) {\n    return (\n      (<Sheet open={openMobile} onOpenChange={setOpenMobile} {...props}>\n        <SheetContent\n          data-sidebar=\"sidebar\"\n          data-mobile=\"true\"\n          className=\"w-[--sidebar-width] bg-sidebar p-0 text-sidebar-foreground [&>button]:hidden\"\n          style={\n            {\n              \"--sidebar-width\": SIDEBAR_WIDTH_MOBILE\n            }\n          }\n          side={side}>\n          <VisuallyHidden>\n            <SheetTitle>Navigation Sidebar</SheetTitle>\n            <SheetDescription>Mobile navigation menu</SheetDescription>\n          </VisuallyHidden>\n          <div className=\"flex h-full w-full flex-col\">{children}</div>\n        </SheetContent>\n      </Sheet>)\n    );\n  }\n\n  return (\n    (<div\n      ref={ref}\n      className=\"group peer hidden text-sidebar-foreground md:block\"\n      data-state={state}\n      data-collapsible={state === \"collapsed\" ? collapsible : \"\"}\n      data-variant={variant}\n      data-side={side}>\n      {/* This is what handles the sidebar gap on desktop */}\n      <div\n        className={cn(\n          \"relative h-svh w-[--sidebar-width] bg-transparent transition-[width] duration-200 ease-linear\",\n          \"group-data-[collapsible=offcanvas]:w-0\",\n          \"group-data-[side=right]:rotate-180\",\n          variant === \"floating\" || variant === \"inset\"\n            ? \"group-data-[collapsible=icon]:w-[calc(var(--sidebar-width-icon)_+_theme(spacing.4))]\"\n            : \"group-data-[collapsible=icon]:w-[--sidebar-width-icon]\"\n        )} />\n      <div\n        className={cn(\n          \"fixed inset-y-0 z-10 hidden h-svh w-[--sidebar-width] transition-[left,right,width] duration-200 ease-linear md:flex\",\n          side === \"left\"\n            ? \"left-0 group-data-[collapsible=offcanvas]:left-[calc(var(--sidebar-width)*-1)]\"\n            : \"right-0 group-data-[collapsible=offcanvas]:right-[calc(var(--sidebar-width)*-1)]\",\n          // Adjust the padding for floating and inset variants.\n          variant === \"floating\" || variant === \"inset\"\n            ? \"p-2 group-data-[collapsible=icon]:w-[calc(var(--sidebar-width-icon)_+_theme(spacing.4)_+2px)]\"\n            : \"group-data-[collapsible=icon]:w-[--sidebar-width-icon] group-data-[side=left]:border-r group-data-[side=right]:border-l\",\n          className\n        )}\n        {...props}>\n        <div\n          data-sidebar=\"sidebar\"\n          className=\"flex h-full w-full flex-col bg-sidebar group-data-[variant=floating]:rounded-lg group-data-[variant=floating]:border group-data-[variant=floating]:border-sidebar-border group-data-[variant=floating]:shadow\">\n          {children}\n        </div>\n      </div>\n    </div>)\n  );\n})\nSidebar.displayName = \"Sidebar\"\n\nconst SidebarTrigger = React.forwardRef(({ className, onClick, ...props }, ref) => {\n  const { toggleSidebar } = useSidebar()\n\n  return (\n    (<Button\n      ref={ref}\n      data-sidebar=\"trigger\"\n      variant=\"ghost\"\n      size=\"icon\"\n      className={cn(\"h-7 w-7\", className)}\n      onClick={(event) => {\n        onClick?.(event)\n        toggleSidebar()\n      }}\n      {...props}>\n      <PanelLeft />\n      <span className=\"sr-only\">Toggle Sidebar</span>\n    </Button>)\n  );\n})\nSidebarTrigger.displayName = \"SidebarTrigger\"\n\nconst SidebarRail = React.forwardRef(({ className, ...props }, ref) => {\n  const { toggleSidebar } = useSidebar()\n\n  return (\n    (<button\n      ref={ref}\n      data-sidebar=\"rail\"\n      aria-label=\"Toggle Sidebar\"\n      tabIndex={-1}\n      onClick={toggleSidebar}\n      title=\"Toggle Sidebar\"\n      className={cn(\n        \"absolute inset-y-0 z-20 hidden w-4 -translate-x-1/2 transition-all ease-linear after:absolute after:inset-y-0 after:left-1/2 after:w-[2px] hover:after:bg-sidebar-border group-data-[side=left]:-right-4 group-data-[side=right]:left-0 sm:flex\",\n        \"[[data-side=left]_&]:cursor-w-resize [[data-side=right]_&]:cursor-e-resize\",\n        \"[[data-side=left][data-state=collapsed]_&]:cursor-e-resize [[data-side=right][data-state=collapsed]_&]:cursor-w-resize\",\n        \"group-data-[collapsible=offcanvas]:translate-x-0 group-data-[collapsible=offcanvas]:after:left-full group-data-[collapsible=offcanvas]:hover:bg-sidebar\",\n        \"[[data-side=left][data-collapsible=offcanvas]_&]:-right-2\",\n        \"[[data-side=right][data-collapsible=offcanvas]_&]:-left-2\",\n        className\n      )}\n      {...props} />)\n  );\n})\nSidebarRail.displayName = \"SidebarRail\"\n\nconst SidebarInset = React.forwardRef(({ className, ...props }, ref) => {\n  return (\n    (<main\n      ref={ref}\n      className={cn(\n        \"relative flex min-h-svh flex-1 flex-col bg-background\",\n        \"peer-data-[variant=inset]:min-h-[calc(100svh-theme(spacing.4))] md:peer-data-[variant=inset]:m-2 md:peer-data-[state=collapsed]:peer-data-[variant=inset]:ml-2 md:peer-data-[variant=inset]:ml-0 md:peer-data-[variant=inset]:rounded-xl md:peer-data-[variant=inset]:shadow\",\n        className\n      )}\n      {...props} />)\n  );\n})\nSidebarInset.displayName = \"SidebarInset\"\n\nconst SidebarInput = React.forwardRef(({ className, ...props }, ref) => {\n  return (\n    (<Input\n      ref={ref}\n      data-sidebar=\"input\"\n      className={cn(\n        \"h-8 w-full bg-background shadow-none focus-visible:ring-2 focus-visible:ring-sidebar-ring\",\n        className\n      )}\n      {...props} />)\n  );\n})\nSidebarInput.displayName = \"SidebarInput\"\n\nconst SidebarHeader = React.forwardRef(({ className, ...props }, ref) => {\n  return (\n    (<div\n      ref={ref}\n      data-sidebar=\"header\"\n      className={cn(\"flex flex-col gap-2 p-2\", className)}\n      {...props} />)\n  );\n})\nSidebarHeader.displayName = \"SidebarHeader\"\n\nconst SidebarFooter = React.forwardRef(({ className, ...props }, ref) => {\n  return (\n    (<div\n      ref={ref}\n      data-sidebar=\"footer\"\n      className={cn(\"flex flex-col gap-2 p-2\", className)}\n      {...props} />)\n  );\n})\nSidebarFooter.displayName = \"SidebarFooter\"\n\nconst SidebarSeparator = React.forwardRef(({ className, ...props }, ref) => {\n  return (\n    (<Separator\n      ref={ref}\n      data-sidebar=\"separator\"\n      className={cn(\"mx-2 w-auto bg-sidebar-border\", className)}\n      {...props} />)\n  );\n})\nSidebarSeparator.displayName = \"SidebarSeparator\"\n\nconst SidebarContent = React.forwardRef(({ className, ...props }, ref) => {\n  return (\n    (<div\n      ref={ref}\n      data-sidebar=\"content\"\n      className={cn(\n        \"flex min-h-0 flex-1 flex-col gap-2 overflow-auto group-data-[collapsible=icon]:overflow-hidden\",\n        className\n      )}\n      {...props} />)\n  );\n})\nSidebarContent.displayName = \"SidebarContent\"\n\nconst SidebarGroup = React.forwardRef(({ className, ...props }, ref) => {\n  return (\n    (<div\n      ref={ref}\n      data-sidebar=\"group\"\n      className={cn(\"relative flex w-full min-w-0 flex-col p-2\", className)}\n      {...props} />)\n  );\n})\nSidebarGroup.displayName = \"SidebarGroup\"\n\nconst SidebarGroupLabel = React.forwardRef(({ className, asChild = false, ...props }, ref) => {\n  const Comp = asChild ? Slot : \"div\"\n\n  return (\n    (<Comp\n      ref={ref}\n      data-sidebar=\"group-label\"\n      className={cn(\n        \"flex h-8 shrink-0 items-center rounded-md px-2 text-xs font-medium text-sidebar-foreground/70 outline-none ring-sidebar-ring transition-[margin,opacity] duration-200 ease-linear focus-visible:ring-2 [&>svg]:size-4 [&>svg]:shrink-0\",\n        \"group-data-[collapsible=icon]:-mt-8 group-data-[collapsible=icon]:opacity-0\",\n        className\n      )}\n      {...props} />)\n  );\n})\nSidebarGroupLabel.displayName = \"SidebarGroupLabel\"\n\nconst SidebarGroupAction = React.forwardRef(({ className, asChild = false, ...props }, ref) => {\n  const Comp = asChild ? Slot : \"button\"\n\n  return (\n    (<Comp\n      ref={ref}\n      data-sidebar=\"group-action\"\n      className={cn(\n        \"absolute right-3 top-3.5 flex aspect-square w-5 items-center justify-center rounded-md p-0 text-sidebar-foreground outline-none ring-sidebar-ring transition-transform hover:bg-sidebar-accent hover:text-sidebar-accent-foreground focus-visible:ring-2 [&>svg]:size-4 [&>svg]:shrink-0\",\n        // Increases the hit area of the button on mobile.\n        \"after:absolute after:-inset-2 after:md:hidden\",\n        \"group-data-[collapsible=icon]:hidden\",\n        className\n      )}\n      {...props} />)\n  );\n})\nSidebarGroupAction.displayName = \"SidebarGroupAction\"\n\nconst SidebarGroupContent = React.forwardRef(({ className, ...props }, ref) => (\n  <div\n    ref={ref}\n    data-sidebar=\"group-content\"\n    className={cn(\"w-full text-sm\", className)}\n    {...props} />\n))\nSidebarGroupContent.displayName = \"SidebarGroupContent\"\n\nconst SidebarMenu = React.forwardRef(({ className, ...props }, ref) => (\n  <ul\n    ref={ref}\n    data-sidebar=\"menu\"\n    className={cn(\"flex w-full min-w-0 flex-col gap-1\", className)}\n    {...props} />\n))\nSidebarMenu.displayName = \"SidebarMenu\"\n\nconst SidebarMenuItem = React.forwardRef(({ className, ...props }, ref) => (\n  <li\n    ref={ref}\n    data-sidebar=\"menu-item\"\n    className={cn(\"group/menu-item relative\", className)}\n    {...props} />\n))\nSidebarMenuItem.displayName = \"SidebarMenuItem\"\n\nconst sidebarMenuButtonVariants = cva(\n  \"peer/menu-button flex w-full items-center gap-2 overflow-hidden rounded-md p-2 text-left text-sm outline-none ring-sidebar-ring transition-[width,height,padding] hover:bg-sidebar-accent hover:text-sidebar-accent-foreground focus-visible:ring-2 active:bg-sidebar-accent active:text-sidebar-accent-foreground disabled:pointer-events-none disabled:opacity-50 group-has-[[data-sidebar=menu-action]]/menu-item:pr-8 aria-disabled:pointer-events-none aria-disabled:opacity-50 data-[active=true]:bg-sidebar-accent data-[active=true]:font-medium data-[active=true]:text-sidebar-accent-foreground data-[state=open]:hover:bg-sidebar-accent data-[state=open]:hover:text-sidebar-accent-foreground group-data-[collapsible=icon]:!size-8 group-data-[collapsible=icon]:!p-2 [&>span:last-child]:truncate [&>svg]:size-4 [&>svg]:shrink-0\",\n  {\n    variants: {\n      variant: {\n        default: \"hover:bg-sidebar-accent hover:text-sidebar-accent-foreground\",\n        outline:\n          \"bg-background shadow-[0_0_0_1px_hsl(var(--sidebar-border))] hover:bg-sidebar-accent hover:text-sidebar-accent-foreground hover:shadow-[0_0_0_1px_hsl(var(--sidebar-accent))]\",\n      },\n      size: {\n        default: \"h-8 text-sm\",\n        sm: \"h-7 text-xs\",\n        lg: \"h-12 text-sm group-data-[collapsible=icon]:!p-0\",\n      },\n    },\n    defaultVariants: {\n      variant: \"default\",\n      size: \"default\",\n    },\n  }\n)\n\nconst SidebarMenuButton = React.forwardRef((\n  {\n    asChild = false,\n    isActive = false,\n    variant = \"default\",\n    size = \"default\",\n    tooltip,\n    className,\n    ...props\n  },\n  ref\n) => {\n  const Comp = asChild ? Slot : \"button\"\n  const { isMobile, state } = useSidebar()\n\n  const button = (\n    <Comp\n      ref={ref}\n      data-sidebar=\"menu-button\"\n      data-size={size}\n      data-active={isActive}\n      className={cn(sidebarMenuButtonVariants({ variant, size }), className)}\n      {...props} />\n  )\n\n  if (!tooltip) {\n    return button\n  }\n\n  if (typeof tooltip === \"string\") {\n    tooltip = {\n      children: tooltip,\n    }\n  }\n\n  return (\n    (<Tooltip>\n      <TooltipTrigger asChild>{button}</TooltipTrigger>\n      <TooltipContent\n        side=\"right\"\n        align=\"center\"\n        hidden={state !== \"collapsed\" || isMobile}\n        {...tooltip} />\n    </Tooltip>)\n  );\n})\nSidebarMenuButton.displayName = \"SidebarMenuButton\"\n\nconst SidebarMenuAction = React.forwardRef(({ className, asChild = false, showOnHover = false, ...props }, ref) => {\n  const Comp = asChild ? Slot : \"button\"\n\n  return (\n    (<Comp\n      ref={ref}\n      data-sidebar=\"menu-action\"\n      className={cn(\n        \"absolute right-1 top-1.5 flex aspect-square w-5 items-center justify-center rounded-md p-0 text-sidebar-foreground outline-none ring-sidebar-ring transition-transform hover:bg-sidebar-accent hover:text-sidebar-accent-foreground focus-visible:ring-2 peer-hover/menu-button:text-sidebar-accent-foreground [&>svg]:size-4 [&>svg]:shrink-0\",\n        // Increases the hit area of the button on mobile.\n        \"after:absolute after:-inset-2 after:md:hidden\",\n        \"peer-data-[size=sm]/menu-button:top-1\",\n        \"peer-data-[size=default]/menu-button:top-1.5\",\n        \"peer-data-[size=lg]/menu-button:top-2.5\",\n        \"group-data-[collapsible=icon]:hidden\",\n        showOnHover &&\n          \"group-focus-within/menu-item:opacity-100 group-hover/menu-item:opacity-100 data-[state=open]:opacity-100 peer-data-[active=true]/menu-button:text-sidebar-accent-foreground md:opacity-0\",\n        className\n      )}\n      {...props} />)\n  );\n})\nSidebarMenuAction.displayName = \"SidebarMenuAction\"\n\nconst SidebarMenuBadge = React.forwardRef(({ className, ...props }, ref) => (\n  <div\n    ref={ref}\n    data-sidebar=\"menu-badge\"\n    className={cn(\n      \"pointer-events-none absolute right-1 flex h-5 min-w-5 select-none items-center justify-center rounded-md px-1 text-xs font-medium tabular-nums text-sidebar-foreground\",\n      \"peer-hover/menu-button:text-sidebar-accent-foreground peer-data-[active=true]/menu-button:text-sidebar-accent-foreground\",\n      \"peer-data-[size=sm]/menu-button:top-1\",\n      \"peer-data-[size=default]/menu-button:top-1.5\",\n      \"peer-data-[size=lg]/menu-button:top-2.5\",\n      \"group-data-[collapsible=icon]:hidden\",\n      className\n    )}\n    {...props} />\n))\nSidebarMenuBadge.displayName = \"SidebarMenuBadge\"\n\nconst SidebarMenuSkeleton = React.forwardRef(({ className, showIcon = false, ...props }, ref) => {\n  // Random width between 50 to 90%.\n  const width = React.useMemo(() => {\n    return `${Math.floor(Math.random() * 40) + 50}%`;\n  }, [])\n\n  return (\n    (<div\n      ref={ref}\n      data-sidebar=\"menu-skeleton\"\n      className={cn(\"flex h-8 items-center gap-2 rounded-md px-2\", className)}\n      {...props}>\n      {showIcon && (\n        <Skeleton className=\"size-4 rounded-md\" data-sidebar=\"menu-skeleton-icon\" />\n      )}\n      <Skeleton\n        className=\"h-4 max-w-[--skeleton-width] flex-1\"\n        data-sidebar=\"menu-skeleton-text\"\n        style={\n          {\n            \"--skeleton-width\": width\n          }\n        } />\n    </div>)\n  );\n})\nSidebarMenuSkeleton.displayName = \"SidebarMenuSkeleton\"\n\nconst SidebarMenuSub = React.forwardRef(({ className, ...props }, ref) => (\n  <ul\n    ref={ref}\n    data-sidebar=\"menu-sub\"\n    className={cn(\n      \"mx-3.5 flex min-w-0 translate-x-px flex-col gap-1 border-l border-sidebar-border px-2.5 py-0.5\",\n      \"group-data-[collapsible=icon]:hidden\",\n      className\n    )}\n    {...props} />\n))\nSidebarMenuSub.displayName = \"SidebarMenuSub\"\n\nconst SidebarMenuSubItem = React.forwardRef(({ ...props }, ref) => <li ref={ref} {...props} />)\nSidebarMenuSubItem.displayName = \"SidebarMenuSubItem\"\n\nconst SidebarMenuSubButton = React.forwardRef(\n  ({ asChild = false, size = \"md\", isActive, className, ...props }, ref) => {\n    const Comp = asChild ? Slot : \"a\"\n\n    return (\n      (<Comp\n        ref={ref}\n        data-sidebar=\"menu-sub-button\"\n        data-size={size}\n        data-active={isActive}\n        className={cn(\n          \"flex h-7 min-w-0 -translate-x-px items-center gap-2 overflow-hidden rounded-md px-2 text-sidebar-foreground outline-none ring-sidebar-ring hover:bg-sidebar-accent hover:text-sidebar-accent-foreground focus-visible:ring-2 active:bg-sidebar-accent active:text-sidebar-accent-foreground disabled:pointer-events-none disabled:opacity-50 aria-disabled:pointer-events-none aria-disabled:opacity-50 [&>span:last-child]:truncate [&>svg]:size-4 [&>svg]:shrink-0 [&>svg]:text-sidebar-accent-foreground\",\n          \"data-[active=true]:bg-sidebar-accent data-[active=true]:text-sidebar-accent-foreground\",\n          size === \"sm\" && \"text-xs\",\n          size === \"md\" && \"text-sm\",\n          \"group-data-[collapsible=icon]:hidden\",\n          className\n        )}\n        {...props} />)\n    );\n  }\n)\nSidebarMenuSubButton.displayName = \"SidebarMenuSubButton\"\n\nexport {\n  Sidebar,\n  SidebarContent,\n  SidebarFooter,\n  SidebarGroup,\n  SidebarGroupAction,\n  SidebarGroupContent,\n  SidebarGroupLabel,\n  SidebarHeader,\n  SidebarInput,\n  SidebarInset,\n  SidebarMenu,\n  SidebarMenuAction,\n  SidebarMenuBadge,\n  SidebarMenuButton,\n  SidebarMenuItem,\n  SidebarMenuSkeleton,\n  SidebarMenuSub,\n  SidebarMenuSubButton,\n  SidebarMenuSubItem,\n  SidebarProvider,\n  SidebarRail,\n  SidebarSeparator,\n  SidebarTrigger,\n  useSidebar,\n}\n","path":null,"size_bytes":20789,"size_tokens":null},"src/api/entities.js":{"content":"import { base44 } from './base44Client';\n\n\nexport const Business = base44.entities.Business;\n\nexport const Queue = base44.entities.Queue;\n\nexport const Ticket = base44.entities.Ticket;\n\nexport const Notification = base44.entities.Notification;\n\nexport const Service = base44.entities.Service;\n\nexport const Appointment = base44.entities.Appointment;\n\nexport const Staff = base44.entities.Staff;\n\nexport const Review = base44.entities.Review;\n\nexport const SupportMessage = base44.entities.SupportMessage;\n\nexport const Subscription = base44.entities.Subscription;\n\nexport const StaffInvite = base44.entities.StaffInvite;\n\n\n\n// auth sdk:\nexport const User = base44.auth;","path":null,"size_bytes":669,"size_tokens":null},"src/utils/index.ts":{"content":"\n\n\nexport function createPageUrl(pageName: string) {\n    // Convert PascalCase to kebab-case and lowercase\n    return '/' + pageName\n        .replace(/([a-z])([A-Z])/g, '$1-$2')\n        .replace(/ /g, '-')\n        .toLowerCase();\n}","path":null,"size_bytes":231,"size_tokens":null},"src/components/ui/radio-group.jsx":{"content":"import * as React from \"react\"\nimport * as RadioGroupPrimitive from \"@radix-ui/react-radio-group\"\nimport { Circle } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst RadioGroup = React.forwardRef(({ className, ...props }, ref) => {\n  return (<RadioGroupPrimitive.Root className={cn(\"grid gap-2\", className)} {...props} ref={ref} />);\n})\nRadioGroup.displayName = RadioGroupPrimitive.Root.displayName\n\nconst RadioGroupItem = React.forwardRef(({ className, ...props }, ref) => {\n  return (\n    (<RadioGroupPrimitive.Item\n      ref={ref}\n      className={cn(\n        \"aspect-square h-4 w-4 rounded-full border border-primary text-primary shadow focus:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:cursor-not-allowed disabled:opacity-50\",\n        className\n      )}\n      {...props}>\n      <RadioGroupPrimitive.Indicator className=\"flex items-center justify-center\">\n        <Circle className=\"h-3.5 w-3.5 fill-primary\" />\n      </RadioGroupPrimitive.Indicator>\n    </RadioGroupPrimitive.Item>)\n  );\n})\nRadioGroupItem.displayName = RadioGroupPrimitive.Item.displayName\n\nexport { RadioGroup, RadioGroupItem }\n","path":null,"size_bytes":1135,"size_tokens":null},"src/components/ui/context-menu.jsx":{"content":"import * as React from \"react\"\nimport * as ContextMenuPrimitive from \"@radix-ui/react-context-menu\"\nimport { Check, ChevronRight, Circle } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst ContextMenu = ContextMenuPrimitive.Root\n\nconst ContextMenuTrigger = ContextMenuPrimitive.Trigger\n\nconst ContextMenuGroup = ContextMenuPrimitive.Group\n\nconst ContextMenuPortal = ContextMenuPrimitive.Portal\n\nconst ContextMenuSub = ContextMenuPrimitive.Sub\n\nconst ContextMenuRadioGroup = ContextMenuPrimitive.RadioGroup\n\nconst ContextMenuSubTrigger = React.forwardRef(({ className, inset, children, ...props }, ref) => (\n  <ContextMenuPrimitive.SubTrigger\n    ref={ref}\n    className={cn(\n      \"flex cursor-default select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[state=open]:bg-accent data-[state=open]:text-accent-foreground\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}>\n    {children}\n    <ChevronRight className=\"ml-auto h-4 w-4\" />\n  </ContextMenuPrimitive.SubTrigger>\n))\nContextMenuSubTrigger.displayName = ContextMenuPrimitive.SubTrigger.displayName\n\nconst ContextMenuSubContent = React.forwardRef(({ className, ...props }, ref) => (\n  <ContextMenuPrimitive.SubContent\n    ref={ref}\n    className={cn(\n      \"z-50 min-w-[8rem] overflow-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-lg data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2\",\n      className\n    )}\n    {...props} />\n))\nContextMenuSubContent.displayName = ContextMenuPrimitive.SubContent.displayName\n\nconst ContextMenuContent = React.forwardRef(({ className, ...props }, ref) => (\n  <ContextMenuPrimitive.Portal>\n    <ContextMenuPrimitive.Content\n      ref={ref}\n      className={cn(\n        \"z-50 min-w-[8rem] overflow-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-md data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2\",\n        className\n      )}\n      {...props} />\n  </ContextMenuPrimitive.Portal>\n))\nContextMenuContent.displayName = ContextMenuPrimitive.Content.displayName\n\nconst ContextMenuItem = React.forwardRef(({ className, inset, ...props }, ref) => (\n  <ContextMenuPrimitive.Item\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props} />\n))\nContextMenuItem.displayName = ContextMenuPrimitive.Item.displayName\n\nconst ContextMenuCheckboxItem = React.forwardRef(({ className, children, checked, ...props }, ref) => (\n  <ContextMenuPrimitive.CheckboxItem\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      className\n    )}\n    checked={checked}\n    {...props}>\n    <span className=\"absolute left-2 flex h-3.5 w-3.5 items-center justify-center\">\n      <ContextMenuPrimitive.ItemIndicator>\n        <Check className=\"h-4 w-4\" />\n      </ContextMenuPrimitive.ItemIndicator>\n    </span>\n    {children}\n  </ContextMenuPrimitive.CheckboxItem>\n))\nContextMenuCheckboxItem.displayName =\n  ContextMenuPrimitive.CheckboxItem.displayName\n\nconst ContextMenuRadioItem = React.forwardRef(({ className, children, ...props }, ref) => (\n  <ContextMenuPrimitive.RadioItem\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      className\n    )}\n    {...props}>\n    <span className=\"absolute left-2 flex h-3.5 w-3.5 items-center justify-center\">\n      <ContextMenuPrimitive.ItemIndicator>\n        <Circle className=\"h-4 w-4 fill-current\" />\n      </ContextMenuPrimitive.ItemIndicator>\n    </span>\n    {children}\n  </ContextMenuPrimitive.RadioItem>\n))\nContextMenuRadioItem.displayName = ContextMenuPrimitive.RadioItem.displayName\n\nconst ContextMenuLabel = React.forwardRef(({ className, inset, ...props }, ref) => (\n  <ContextMenuPrimitive.Label\n    ref={ref}\n    className={cn(\n      \"px-2 py-1.5 text-sm font-semibold text-foreground\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props} />\n))\nContextMenuLabel.displayName = ContextMenuPrimitive.Label.displayName\n\nconst ContextMenuSeparator = React.forwardRef(({ className, ...props }, ref) => (\n  <ContextMenuPrimitive.Separator\n    ref={ref}\n    className={cn(\"-mx-1 my-1 h-px bg-border\", className)}\n    {...props} />\n))\nContextMenuSeparator.displayName = ContextMenuPrimitive.Separator.displayName\n\nconst ContextMenuShortcut = ({\n  className,\n  ...props\n}) => {\n  return (\n    (<span\n      className={cn(\"ml-auto text-xs tracking-widest text-muted-foreground\", className)}\n      {...props} />)\n  );\n}\nContextMenuShortcut.displayName = \"ContextMenuShortcut\"\n\nexport {\n  ContextMenu,\n  ContextMenuTrigger,\n  ContextMenuContent,\n  ContextMenuItem,\n  ContextMenuCheckboxItem,\n  ContextMenuRadioItem,\n  ContextMenuLabel,\n  ContextMenuSeparator,\n  ContextMenuShortcut,\n  ContextMenuGroup,\n  ContextMenuPortal,\n  ContextMenuSub,\n  ContextMenuSubContent,\n  ContextMenuSubTrigger,\n  ContextMenuRadioGroup,\n}\n","path":null,"size_bytes":5995,"size_tokens":null},"src/components/ui/toggle.jsx":{"content":"import * as React from \"react\"\nimport * as TogglePrimitive from \"@radix-ui/react-toggle\"\nimport { cva } from \"class-variance-authority\";\n\nimport { cn } from \"@/lib/utils\"\n\nconst toggleVariants = cva(\n  \"inline-flex items-center justify-center gap-2 rounded-md text-sm font-medium transition-colors hover:bg-muted hover:text-muted-foreground focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:pointer-events-none disabled:opacity-50 data-[state=on]:bg-accent data-[state=on]:text-accent-foreground [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0\",\n  {\n    variants: {\n      variant: {\n        default: \"bg-transparent\",\n        outline:\n          \"border border-input bg-transparent shadow-sm hover:bg-accent hover:text-accent-foreground\",\n      },\n      size: {\n        default: \"h-9 px-2 min-w-9\",\n        sm: \"h-8 px-1.5 min-w-8\",\n        lg: \"h-10 px-2.5 min-w-10\",\n      },\n    },\n    defaultVariants: {\n      variant: \"default\",\n      size: \"default\",\n    },\n  }\n)\n\nconst Toggle = React.forwardRef(({ className, variant, size, ...props }, ref) => (\n  <TogglePrimitive.Root\n    ref={ref}\n    className={cn(toggleVariants({ variant, size, className }))}\n    {...props} />\n))\n\nToggle.displayName = TogglePrimitive.Root.displayName\n\nexport { Toggle, toggleVariants }\n","path":null,"size_bytes":1310,"size_tokens":null},"src/pages/BusinessAccess.jsx":{"content":"import React, { useState, useEffect } from \"react\";\nimport { base44 } from \"@/api/base44Client\";\nimport { useQuery, useMutation, useQueryClient } from \"@tanstack/react-query\";\nimport { Button } from \"@/components/ui/button\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { useNavigate } from \"react-router-dom\";\nimport { createPageUrl } from \"@/utils\";\nimport { getUploadUrl } from \"@/utils/apiConfig\";\nimport { \n  Building2,\n  MapPin,\n  ArrowRight,\n  CheckCircle2\n} from \"lucide-react\";\nimport { Skeleton } from \"@/components/ui/skeleton\";\nimport { useAutoTranslate } from \"@/hooks/useTranslate\";\n\nexport default function BusinessAccessPage() {\n  // Traduções\n  const txtSelectCompany = useAutoTranslate('Selecione a Sua Empresa', 'pt');\n  const txtChooseCompany = useAutoTranslate('Escolha a empresa que deseja gerir para aceder ao painel empresarial', 'pt');\n  const txtNoCompanies = useAutoTranslate('Nenhuma Empresa Disponível', 'pt');\n  const txtContactAdmin = useAutoTranslate('Contacte o administrador para criar uma empresa', 'pt');\n  const txtProcessing = useAutoTranslate('A processar...', 'pt');\n  const txtAccessAsManager = useAutoTranslate('Aceder como Gestor', 'pt');\n\n  const navigate = useNavigate();\n  const queryClient = useQueryClient();\n  const [user, setUser] = useState(null);\n\n  useEffect(() => {\n    base44.auth.me().then(setUser).catch(() => {\n      base44.auth.redirectToLogin();\n    });\n  }, []);\n\n  const { data: businesses, isLoading } = useQuery({\n    queryKey: ['businesses'],\n    queryFn: () => base44.entities.Business.filter({ is_active: true }),\n    initialData: [],\n  });\n\n  const selectBusinessMutation = useMutation({\n    mutationFn: async (businessId) => {\n      await base44.auth.updateMe({\n        business_id: businessId,\n        is_business_user: true\n      });\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['user'] });\n      navigate(createPageUrl(\"BusinessDashboard\"));\n    },\n  });\n\n  if (!user || isLoading) {\n    return (\n      <div className=\"bg-gradient-to-br from-slate-50 via-blue-50 to-sky-50 p-4\">\n        <div className=\"max-w-6xl mx-auto\">\n          <Skeleton className=\"h-12 w-96 mb-8\" />\n          <div className=\"grid md:grid-cols-2 lg:grid-cols-3 gap-6\">\n            {[1, 2, 3, 4, 5, 6].map(i => <Skeleton key={i} className=\"h-64\" />)}\n          </div>\n        </div>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"bg-gradient-to-br from-slate-50 via-blue-50 to-sky-50\">\n      <div className=\"max-w-6xl mx-auto px-4 py-4\">\n        {/* Header */}\n        <div className=\"text-center mb-12\">\n          <div className=\"inline-flex items-center justify-center w-16 h-16 bg-gradient-to-br from-indigo-500 to-purple-600 rounded-2xl mb-6\">\n            <Building2 className=\"w-8 h-8 text-white\" />\n          </div>\n          <h1 className=\"text-4xl md:text-5xl font-bold text-slate-900 mb-4\">\n            {txtSelectCompany}\n          </h1>\n          <p className=\"text-xl text-slate-600 max-w-2xl mx-auto\">\n            {txtChooseCompany}\n          </p>\n        </div>\n\n        {businesses.length === 0 ? (\n          <Card className=\"border-0 shadow-lg\">\n            <CardContent className=\"py-16 text-center\">\n              <Building2 className=\"w-16 h-16 text-slate-300 mx-auto mb-4\" />\n              <h3 className=\"text-2xl font-bold text-slate-900 mb-2\">\n                {txtNoCompanies}\n              </h3>\n              <p className=\"text-slate-600 mb-6\">\n                {txtContactAdmin}\n              </p>\n            </CardContent>\n          </Card>\n        ) : (\n          <div className=\"grid md:grid-cols-2 lg:grid-cols-3 gap-6\">\n            {businesses.map(business => (\n              <Card key={business.id} className=\"border-0 shadow-lg hover:shadow-2xl transition-all\">\n                <CardHeader className=\"pb-4\">\n                  <div className=\"flex items-start gap-3 mb-3\">\n                    {business.logo_url ? (\n                      <img \n                        src={getUploadUrl(business.logo_url)} \n                        alt={business.name}\n                        className=\"w-14 h-14 rounded-xl object-contain bg-slate-50 p-2\"\n                        onError={(e) => { e.target.style.display = 'none'; }}\n                      />\n                    ) : (\n                      <div className=\"w-14 h-14 rounded-xl bg-gradient-to-br from-indigo-500 to-purple-600 flex items-center justify-center\">\n                        <span className=\"text-white text-xl font-bold\">\n                          {business.name[0]}\n                        </span>\n                      </div>\n                    )}\n                    <div className=\"flex-1\">\n                      <CardTitle className=\"text-lg mb-1\">{business.name}</CardTitle>\n                      <Badge className=\"bg-blue-100 text-blue-700 border-blue-200 text-xs\">\n                        {business.category}\n                      </Badge>\n                    </div>\n                  </div>\n                  \n                  {business.description && (\n                    <p className=\"text-sm text-slate-600 line-clamp-2\">\n                      {business.description}\n                    </p>\n                  )}\n                </CardHeader>\n                \n                <CardContent>\n                  {business.address && (\n                    <div className=\"flex items-center gap-2 text-sm text-slate-600 mb-4\">\n                      <MapPin className=\"w-4 h-4 flex-shrink-0\" />\n                      <span className=\"truncate\">{business.address}</span>\n                    </div>\n                  )}\n\n                  <Button\n                    className=\"w-full bg-gradient-to-r from-indigo-500 to-purple-600 hover:from-indigo-600 hover:to-purple-700\"\n                    onClick={() => selectBusinessMutation.mutate(business.id)}\n                    disabled={selectBusinessMutation.isPending}\n                  >\n                    {selectBusinessMutation.isPending ? (\n                      txtProcessing\n                    ) : (\n                      <>\n                        {txtAccessAsManager}\n                        <ArrowRight className=\"w-4 h-4 ml-2\" />\n                      </>\n                    )}\n                  </Button>\n                </CardContent>\n              </Card>\n            ))}\n          </div>\n        )}\n      </div>\n    </div>\n  );\n}","path":null,"size_bytes":6472,"size_tokens":null},"src/components/portal/NotificationSettings.jsx":{"content":"import React, { useState } from \"react\";\nimport { base44 } from \"@/api/base44Client\";\nimport { useMutation, useQueryClient } from \"@tanstack/react-query\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Switch } from \"@/components/ui/switch\";\nimport { Input } from \"@/components/ui/input\";\nimport { Label } from \"@/components/ui/label\";\nimport { Bell, Mail, Smartphone, Clock, Calendar, AlertCircle, Save, Crown } from \"lucide-react\";\nimport { toast } from \"sonner\";\nimport { useAutoTranslate } from \"@/hooks/useTranslate\";\n\nconst defaultPreferences = {\n  ticket_almost_ready: {\n    enabled: true,\n    advance_positions: 5,\n    channels: [\"push\"]\n  },\n  ticket_ready: {\n    enabled: true,\n    channels: [\"push\", \"email\"]\n  },\n  appointment_reminder: {\n    enabled: true,\n    advance_hours: 24,\n    channels: [\"push\", \"email\"]\n  },\n  queue_paused: {\n    enabled: true,\n    channels: [\"push\"]\n  }\n};\n\nexport default function NotificationSettings({ user }) {\n  // Traduções\n  const txtSavedSuccess = useAutoTranslate('Preferências guardadas com sucesso!', 'pt');\n  const txtSaveError = useAutoTranslate('Erro ao guardar preferências', 'pt');\n  const txtNotificationSettings = useAutoTranslate('Configurar Notificações', 'pt');\n  const txtCustomizeAlerts = useAutoTranslate('Personalize como e quando quer receber alertas', 'pt');\n  const txtSavePreferences = useAutoTranslate('Guardar Preferências', 'pt');\n  const txtAlmostYourTurn = useAutoTranslate('Quase a Sua Vez', 'pt');\n  const txtReceiveAlertAlmost = useAutoTranslate('Receber alerta quando estiver quase na sua vez', 'pt');\n  const txtYourTurn = useAutoTranslate('É a Sua Vez', 'pt');\n  const txtReceiveAlertCalled = useAutoTranslate('Receber alerta quando for chamado', 'pt');\n  const txtAppointmentReminder = useAutoTranslate('Lembrete de Marcação', 'pt');\n  const txtReminderBefore = useAutoTranslate('Lembrete antes das suas marcações', 'pt');\n  const txtQueuePaused = useAutoTranslate('Fila Pausada', 'pt');\n  const txtAlertPaused = useAutoTranslate('Alertas quando a fila for pausada', 'pt');\n  const txtPositionsBefore = useAutoTranslate('Posições antes', 'pt');\n  const txtHoursBefore = useAutoTranslate('Horas antes', 'pt');\n  const txtActivateNotifications = useAutoTranslate('Ativar notificações', 'pt');\n  const txtPremiumOnly = useAutoTranslate('Disponível apenas para utilizadores Premium', 'pt');\n  const txtReceiveVia = useAutoTranslate('Receber via:', 'pt');\n  const txtSaving = useAutoTranslate('A guardar...', 'pt');\n\n  const queryClient = useQueryClient();\n  const [preferences, setPreferences] = useState(\n    user.notification_preferences || defaultPreferences\n  );\n\n  const updateMutation = useMutation({\n    mutationFn: (data) => base44.auth.updateMe(data),\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['user'] });\n      toast.success(txtSavedSuccess);\n    },\n    onError: () => {\n      toast.error(txtSaveError);\n    }\n  });\n\n  const handleSave = () => {\n    updateMutation.mutate({ notification_preferences: preferences });\n  };\n\n  const updatePreference = (key, field, value) => {\n    setPreferences(prev => ({\n      ...prev,\n      [key]: {\n        ...prev[key],\n        [field]: value\n      }\n    }));\n  };\n\n  const toggleChannel = (key, channel) => {\n    const currentChannels = preferences[key]?.channels || [];\n    const newChannels = currentChannels.includes(channel)\n      ? currentChannels.filter(c => c !== channel)\n      : [...currentChannels, channel];\n    \n    updatePreference(key, 'channels', newChannels);\n  };\n\n  const notificationTypes = [\n    {\n      key: \"ticket_almost_ready\",\n      title: txtAlmostYourTurn,\n      description: txtReceiveAlertAlmost,\n      icon: Clock,\n      color: \"from-blue-500 to-cyan-500\",\n      hasCustomValue: true,\n      customLabel: txtPositionsBefore,\n      customField: \"advance_positions\",\n      customMin: 1,\n      customMax: 20\n    },\n    {\n      key: \"ticket_ready\",\n      title: txtYourTurn,\n      description: txtReceiveAlertCalled,\n      icon: Bell,\n      color: \"from-green-500 to-emerald-500\"\n    },\n    {\n      key: \"appointment_reminder\",\n      title: txtAppointmentReminder,\n      description: txtReminderBefore,\n      icon: Calendar,\n      color: \"from-purple-500 to-pink-500\",\n      hasCustomValue: true,\n      customLabel: txtHoursBefore,\n      customField: \"advance_hours\",\n      customMin: 1,\n      customMax: 72\n    },\n    {\n      key: \"queue_paused\",\n      title: txtQueuePaused,\n      description: txtAlertPaused,\n      icon: AlertCircle,\n      color: \"from-amber-500 to-orange-500\"\n    }\n  ];\n\n  return (\n    <div className=\"space-y-6\">\n      <Card className=\"border-0 shadow-lg\">\n        <CardHeader>\n          <CardTitle className=\"flex items-center gap-2\">\n            <Bell className=\"w-5 h-5\" />\n            {txtNotificationSettings}\n          </CardTitle>\n          <p className=\"text-sm text-slate-600\">\n            {txtCustomizeAlerts}\n          </p>\n        </CardHeader>\n      </Card>\n\n      {notificationTypes.map((type) => {\n        const pref = preferences[type.key] || {};\n        const isLocked = type.isPremium && !user.is_premium;\n\n        return (\n          <Card key={type.key} className={`border-0 shadow-md ${isLocked ? 'opacity-60' : ''}`}>\n            <CardContent className=\"p-6\">\n              <div className=\"flex items-start gap-4\">\n                <div className={`w-12 h-12 rounded-xl bg-gradient-to-br ${type.color} flex items-center justify-center flex-shrink-0`}>\n                  <type.icon className=\"w-6 h-6 text-white\" />\n                </div>\n\n                <div className=\"flex-1\">\n                  <div className=\"flex items-center gap-2 mb-2\">\n                    <h3 className=\"font-semibold text-slate-900\">{type.title}</h3>\n                    {type.isPremium && (\n                      <Badge className=\"bg-gradient-to-r from-purple-600 to-pink-600 text-white text-xs\">\n                        <Crown className=\"w-3 h-3 mr-1\" />\n                        Premium\n                      </Badge>\n                    )}\n                  </div>\n                  <p className=\"text-sm text-slate-600 mb-4\">{type.description}</p>\n\n                  {isLocked ? (\n                    <div className=\"flex items-center gap-2 text-sm text-purple-600\">\n                      <Crown className=\"w-4 h-4\" />\n                      <span>{txtPremiumOnly}</span>\n                    </div>\n                  ) : (\n                    <div className=\"space-y-4\">\n                      <div className=\"flex items-center justify-between\">\n                        <Label className=\"text-sm font-medium\">{txtActivateNotifications}</Label>\n                        <Switch\n                          checked={pref.enabled}\n                          onCheckedChange={(checked) => updatePreference(type.key, 'enabled', checked)}\n                        />\n                      </div>\n\n                      {pref.enabled && (\n                        <>\n                          {type.hasCustomValue && (\n                            <div className=\"flex items-center gap-3\">\n                              <Label className=\"text-sm text-slate-600 whitespace-nowrap\">\n                                {type.customLabel}:\n                              </Label>\n                              <Input\n                                type=\"number\"\n                                min={type.customMin}\n                                max={type.customMax}\n                                value={pref[type.customField] || type.customMin}\n                                onChange={(e) => updatePreference(type.key, type.customField, parseInt(e.target.value))}\n                                className=\"w-24\"\n                              />\n                            </div>\n                          )}\n\n                          <div>\n                            <Label className=\"text-sm font-medium mb-2 block\">\n                              {txtReceiveVia}\n                            </Label>\n                            <div className=\"flex gap-3\">\n                              <Button\n                                variant={pref.channels?.includes('push') ? 'default' : 'outline'}\n                                size=\"sm\"\n                                onClick={() => toggleChannel(type.key, 'push')}\n                                className=\"gap-2\"\n                              >\n                                <Smartphone className=\"w-4 h-4\" />\n                                Push\n                              </Button>\n                              <Button\n                                variant={pref.channels?.includes('email') ? 'default' : 'outline'}\n                                size=\"sm\"\n                                onClick={() => toggleChannel(type.key, 'email')}\n                                className=\"gap-2\"\n                              >\n                                <Mail className=\"w-4 h-4\" />\n                                Email\n                              </Button>\n                            </div>\n                          </div>\n                        </>\n                      )}\n                    </div>\n                  )}\n                </div>\n              </div>\n            </CardContent>\n          </Card>\n        );\n      })}\n\n      <Card className=\"border-0 shadow-lg bg-gradient-to-br from-blue-50 to-sky-50\">\n        <CardContent className=\"p-6\">\n          <Button\n            onClick={handleSave}\n            disabled={updateMutation.isPending}\n            className=\"w-full bg-gradient-to-r from-blue-600 to-cyan-600 hover:from-blue-700 hover:to-cyan-700\"\n          >\n            <Save className=\"w-4 h-4 mr-2\" />\n            {updateMutation.isPending ? txtSaving : txtSavePreferences}\n          </Button>\n        </CardContent>\n      </Card>\n    </div>\n  );\n}","path":null,"size_bytes":9987,"size_tokens":null},"src/components/ui/alert-dialog.jsx":{"content":"import * as React from \"react\"\nimport * as AlertDialogPrimitive from \"@radix-ui/react-alert-dialog\"\n\nimport { cn } from \"@/lib/utils\"\nimport { buttonVariants } from \"@/components/ui/button\"\n\nconst AlertDialog = AlertDialogPrimitive.Root\n\nconst AlertDialogTrigger = AlertDialogPrimitive.Trigger\n\nconst AlertDialogPortal = AlertDialogPrimitive.Portal\n\nconst AlertDialogOverlay = React.forwardRef(({ className, ...props }, ref) => (\n  <AlertDialogPrimitive.Overlay\n    className={cn(\n      \"fixed inset-0 z-50 bg-black/80 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0\",\n      className\n    )}\n    {...props}\n    ref={ref} />\n))\nAlertDialogOverlay.displayName = AlertDialogPrimitive.Overlay.displayName\n\nconst AlertDialogContent = React.forwardRef(({ className, ...props }, ref) => (\n  <AlertDialogPortal>\n    <AlertDialogOverlay />\n    <AlertDialogPrimitive.Content\n      ref={ref}\n      className={cn(\n        \"fixed left-[50%] top-[50%] z-50 grid w-full max-w-lg translate-x-[-50%] translate-y-[-50%] gap-4 border bg-background p-6 shadow-lg duration-200 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[state=closed]:slide-out-to-left-1/2 data-[state=closed]:slide-out-to-top-[48%] data-[state=open]:slide-in-from-left-1/2 data-[state=open]:slide-in-from-top-[48%] sm:rounded-lg\",\n        className\n      )}\n      {...props} />\n  </AlertDialogPortal>\n))\nAlertDialogContent.displayName = AlertDialogPrimitive.Content.displayName\n\nconst AlertDialogHeader = ({\n  className,\n  ...props\n}) => (\n  <div\n    className={cn(\"flex flex-col space-y-2 text-center sm:text-left\", className)}\n    {...props} />\n)\nAlertDialogHeader.displayName = \"AlertDialogHeader\"\n\nconst AlertDialogFooter = ({\n  className,\n  ...props\n}) => (\n  <div\n    className={cn(\"flex flex-col-reverse sm:flex-row sm:justify-end sm:space-x-2\", className)}\n    {...props} />\n)\nAlertDialogFooter.displayName = \"AlertDialogFooter\"\n\nconst AlertDialogTitle = React.forwardRef(({ className, ...props }, ref) => (\n  <AlertDialogPrimitive.Title ref={ref} className={cn(\"text-lg font-semibold\", className)} {...props} />\n))\nAlertDialogTitle.displayName = AlertDialogPrimitive.Title.displayName\n\nconst AlertDialogDescription = React.forwardRef(({ className, ...props }, ref) => (\n  <AlertDialogPrimitive.Description\n    ref={ref}\n    className={cn(\"text-sm text-muted-foreground\", className)}\n    {...props} />\n))\nAlertDialogDescription.displayName =\n  AlertDialogPrimitive.Description.displayName\n\nconst AlertDialogAction = React.forwardRef(({ className, ...props }, ref) => (\n  <AlertDialogPrimitive.Action ref={ref} className={cn(buttonVariants(), className)} {...props} />\n))\nAlertDialogAction.displayName = AlertDialogPrimitive.Action.displayName\n\nconst AlertDialogCancel = React.forwardRef(({ className, ...props }, ref) => (\n  <AlertDialogPrimitive.Cancel\n    ref={ref}\n    className={cn(buttonVariants({ variant: \"outline\" }), \"mt-2 sm:mt-0\", className)}\n    {...props} />\n))\nAlertDialogCancel.displayName = AlertDialogPrimitive.Cancel.displayName\n\nexport {\n  AlertDialog,\n  AlertDialogPortal,\n  AlertDialogOverlay,\n  AlertDialogTrigger,\n  AlertDialogContent,\n  AlertDialogHeader,\n  AlertDialogFooter,\n  AlertDialogTitle,\n  AlertDialogDescription,\n  AlertDialogAction,\n  AlertDialogCancel,\n}\n","path":null,"size_bytes":3461,"size_tokens":null},"src/lib/utils.js":{"content":"import { clsx } from \"clsx\"\nimport { twMerge } from \"tailwind-merge\"\n\nexport function cn(...inputs) {\n  return twMerge(clsx(inputs))\n} ","path":null,"size_bytes":135,"size_tokens":null},"src/components/shared/EmptyState.jsx":{"content":"import React from \"react\";\nimport { Card, CardContent } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\n\nexport default function EmptyState({ icon: Icon, title, description, action }) {\n  return (\n    <Card className=\"border-0 shadow-lg\">\n      <CardContent className=\"py-16 text-center\">\n        {Icon && <Icon className=\"w-16 h-16 text-slate-400 mx-auto mb-4\" />}\n        <h3 className=\"text-xl font-bold text-slate-900 mb-2\">{title}</h3>\n        {description && <p className=\"text-slate-600 mb-6\">{description}</p>}\n        {action && (\n          <Button onClick={action.onClick} variant={action.variant || \"default\"}>\n            {action.label}\n          </Button>\n        )}\n      </CardContent>\n    </Card>\n  );\n}","path":null,"size_bytes":749,"size_tokens":null},"src/components/ui/label.jsx":{"content":"import * as React from \"react\"\nimport * as LabelPrimitive from \"@radix-ui/react-label\"\nimport { cva } from \"class-variance-authority\";\n\nimport { cn } from \"@/lib/utils\"\n\nconst labelVariants = cva(\n  \"text-sm font-medium leading-none peer-disabled:cursor-not-allowed peer-disabled:opacity-70\"\n)\n\nconst Label = React.forwardRef(({ className, ...props }, ref) => (\n  <LabelPrimitive.Root ref={ref} className={cn(labelVariants(), className)} {...props} />\n))\nLabel.displayName = LabelPrimitive.Root.displayName\n\nexport { Label }\n","path":null,"size_bytes":525,"size_tokens":null},"src/pages/ManageSubscription.jsx":{"content":"import React, { useState, useEffect } from \"react\";\nimport { base44 } from \"@/api/base44Client\";\nimport { safeFetch } from \"@/utils/apiConfig\";\nimport { useQuery, useMutation, useQueryClient } from \"@tanstack/react-query\";\nimport { Button } from \"@/components/ui/button\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Alert, AlertDescription } from \"@/components/ui/alert\";\nimport { Switch } from \"@/components/ui/switch\";\nimport { useNavigate } from \"react-router-dom\";\nimport { createPageUrl } from \"@/utils\";\nimport { \n  ArrowLeft,\n  Crown,\n  CreditCard,\n  Calendar,\n  CheckCircle2,\n  XCircle,\n  AlertTriangle,\n  Download,\n  Settings,\n  Bell,\n  Sparkles,\n  Lock\n} from \"lucide-react\";\nimport { Skeleton } from \"@/components/ui/skeleton\";\nimport { useBusinessRole } from \"@/hooks/useBusinessRole\";\nimport { useAutoTranslate } from \"@/hooks/useTranslate\";\n\nexport default function ManageSubscriptionPage() {\n  // Traduções\n  const txtBack = useAutoTranslate('Anterior', 'pt');\n  const txtManageSubscription = useAutoTranslate('Gerir Subscrição', 'pt');\n  const txtManageAllAspects = useAutoTranslate('Controle todos os aspetos da sua conta Premium', 'pt');\n  const txtSubscriptionCancelled = useAutoTranslate('Subscrição Cancelada', 'pt');\n  const txtAccessUntil = useAutoTranslate('Terá acesso Premium até', 'pt');\n  const txtAfterDate = useAutoTranslate('Após essa data, voltará ao plano gratuito', 'pt');\n  const txtRenewsIn = useAutoTranslate('Sua subscrição renova em', 'pt');\n  const txtDay = useAutoTranslate('dia', 'pt');\n  const txtDays = useAutoTranslate('dias', 'pt');\n  const txtPlan = useAutoTranslate('Plano', 'pt');\n  const txtPremium = useAutoTranslate('Premium', 'pt');\n  const txtFree = useAutoTranslate('Gratuito', 'pt');\n  const txtActive = useAutoTranslate('Ativa', 'pt');\n  const txtCancelled = useAutoTranslate('Cancelada', 'pt');\n  const txtPerMonth = useAutoTranslate('/mês', 'pt');\n  const txtStartDate = useAutoTranslate('Data de Início', 'pt');\n  const txtExpiresIn = useAutoTranslate('Expira em', 'pt');\n  const txtNextRenewal = useAutoTranslate('Próxima Renovação', 'pt');\n  const txtPaymentMethod = useAutoTranslate('Método de Pagamento', 'pt');\n  const txtCreditCard = useAutoTranslate('Cartão de Crédito', 'pt');\n  const txtAutoRenewal = useAutoTranslate('Renovação Automática', 'pt');\n  const txtEnabled = useAutoTranslate('Ativada', 'pt');\n  const txtDisabled = useAutoTranslate('Desativada', 'pt');\n  const txtFeaturesIncluded = useAutoTranslate('Funcionalidades Incluídas', 'pt');\n  const txtUpdatePayment = useAutoTranslate('Atualizar Pagamento', 'pt');\n  const txtDownloadInvoices = useAutoTranslate('Descarregar Faturas', 'pt');\n  const txtCancelSubscription = useAutoTranslate('Cancelar Subscrição', 'pt');\n  const txtAreYouSure = useAutoTranslate('Tem a certeza? Perderá todos os benefícios Premium', 'pt');\n  const txtNo = useAutoTranslate('Não', 'pt');\n  const txtYesCancel = useAutoTranslate('Sim, Cancelar', 'pt');\n  const txtCancelling = useAutoTranslate('Cancelando...', 'pt');\n  const txtReactivatePremium = useAutoTranslate('Reativar Premium', 'pt');\n  const txtReactivating = useAutoTranslate('Reativando...', 'pt');\n  const txtUpgradeToPremium = useAutoTranslate('Upgrade para Premium', 'pt');\n  const txtUnlockFeatures = useAutoTranslate('Desbloqueie fila expressa, IA preditiva e muito mais', 'pt');\n  const txtViewPremiumPlans = useAutoTranslate('Ver Planos Premium', 'pt');\n  const txtNoActiveSubscription = useAutoTranslate('Sem Subscrição Ativa', 'pt');\n  const txtUpgradeMessage = useAutoTranslate('Faça upgrade para Premium e desfrute de benefícios exclusivos', 'pt');\n  const txtProfileNotFound = useAutoTranslate('Perfil da empresa não encontrado', 'pt');\n  const txtErrorCancelling = useAutoTranslate('Erro ao cancelar subscrição', 'pt');\n  \n  const navigate = useNavigate();\n  const queryClient = useQueryClient();\n  const [user, setUser] = useState(null);\n  const [showCancelConfirm, setShowCancelConfirm] = useState(false);\n\n  useEffect(() => {\n    base44.auth.me().then(userData => {\n      setUser(userData);\n      const isStaff = userData.is_staff_member === true;\n      if (isStaff) {\n        navigate(createPageUrl(\"BusinessHome\"), { replace: true });\n      }\n    }).catch(() => base44.auth.redirectToLogin());\n  }, [navigate]);\n\n  // ✅ Buscar dados REAIS do companyProfile (PostgreSQL) em vez do localStorage\n  const { data: subscription, isLoading } = useQuery({\n    queryKey: ['subscription', user?.business_id],\n    queryFn: async () => {\n      if (!user || !user.business_id) return null;\n      \n      // Buscar company profile da API real\n      const profiles = await base44.entities.CompanyProfile.filter({\n        id: user.business_id\n      });\n      \n      if (!profiles || profiles.length === 0) return null;\n      \n      const profile = profiles[0];\n      \n      // ✅ Verificar se está cancelado (aceitar ambas grafias: 'canceled' e 'cancelled')\n      const isCancelledStatus = profile.subscription_status === 'canceled' || \n                                 profile.subscription_status === 'cancelled' ||\n                                 profile.subscriptionStatus === 'canceled' ||\n                                 profile.subscriptionStatus === 'cancelled';\n      \n      console.log('📊 ManageSubscription - Dados do perfil:', {\n        subscription_status: profile.subscription_status,\n        subscriptionStatus: profile.subscriptionStatus,\n        status: profile.status,\n        isCancelledStatus,\n        current_period_end: profile.current_period_end\n      });\n      \n      // Converter dados do companyProfile para formato de subscrição\n      return {\n        id: profile.subscription_id || profile.subscriptionId || profile.id,\n        user_email: user.email,\n        plan: profile.status === 'active' || profile.status === 'pending_payment' ? 'premium' : 'free',\n        status: isCancelledStatus ? 'cancelled' : \n                profile.status === 'active' ? 'active' : \n                profile.status === 'pending_payment' ? 'active' : 'cancelled',\n        amount: 49.99,\n        currency: 'EUR',\n        created_date: profile.created_at || profile.createdAt,\n        start_date: profile.trial_start || profile.trialStart || profile.created_at || profile.createdAt,\n        end_date: profile.current_period_end || profile.currentPeriodEnd || profile.trial_end || profile.trialEnd,\n        trial_end_date: profile.trial_end || profile.trialEnd,\n        auto_renew: !isCancelledStatus,  // ✅ Corrigido: false se cancelado\n        stripe_subscription_id: profile.subscription_id || profile.subscriptionId,\n        payment_method: 'stripe'\n      };\n    },\n    enabled: !!user?.business_id,\n  });\n\n  const toggleAutoRenewMutation = useMutation({\n    mutationFn: async (autoRenew) => {\n      // Toggle auto-renew via Stripe API\n      console.log('Toggle auto-renew:', autoRenew);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['subscription', user?.business_id] });\n    },\n  });\n\n  // ✅ CANCELAMENTO REAL VIA STRIPE API\n  const cancelSubscriptionMutation = useMutation({\n    mutationFn: async () => {\n      // Buscar company profile do utilizador para obter companyProfileId\n      const profiles = await base44.entities.CompanyProfile.filter({\n        ownerEmail: user.email\n      });\n      \n      if (!profiles || profiles.length === 0) {\n        throw new Error(txtProfileNotFound);\n      }\n      \n      const companyProfileId = profiles[0].id;\n      \n      // ✅ CANCELAR NO STRIPE (NÃO apenas no DB local)\n      const { response, data } = await safeFetch('/api/stripe/cancel-subscription', {\n        method: 'POST',\n        body: JSON.stringify({ companyProfileId })\n      });\n      \n      if (!response.ok) {\n        throw new Error(data?.error || txtErrorCancelling);\n      }\n      \n      return data;\n    },\n    onSuccess: (data) => {\n      queryClient.invalidateQueries({ queryKey: ['subscription', user?.business_id] });\n      queryClient.invalidateQueries({ queryKey: ['company-profile'] });\n      setShowCancelConfirm(false);\n      \n      // Mostrar mensagem de sucesso com data de acesso\n      if (data.message) {\n        console.log('✅ Subscrição cancelada:', data.message);\n      }\n    },\n    onError: (error) => {\n      console.error('❌ Erro ao cancelar subscrição:', error);\n      alert(error.message || 'Erro ao cancelar subscrição. Por favor, tente novamente.');\n    }\n  });\n\n  const reactivateSubscriptionMutation = useMutation({\n    mutationFn: async () => {\n      // Buscar company profile do utilizador\n      const profiles = await base44.entities.CompanyProfile.filter({\n        id: user.business_id\n      });\n      \n      if (!profiles || profiles.length === 0) {\n        throw new Error(txtProfileNotFound);\n      }\n      \n      const companyProfileId = profiles[0].id;\n      \n      // ✅ REATIVAR VIA STRIPE API\n      const { response, data } = await safeFetch('/api/stripe/reactivate-subscription', {\n        method: 'POST',\n        body: JSON.stringify({ companyProfileId })\n      });\n      \n      if (!response.ok) {\n        throw new Error(data?.error || 'Erro ao reativar subscrição');\n      }\n      \n      return data;\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['subscription', user?.business_id] });\n      queryClient.invalidateQueries({ queryKey: ['company-profile'] });\n    },\n  });\n\n  if (isLoading || !user) {\n    return (\n      <div className=\"bg-gradient-to-br from-slate-50 via-blue-50 to-sky-50 p-4\">\n        <div className=\"max-w-4xl mx-auto\">\n          <Skeleton className=\"h-12 w-64 mb-8\" />\n          <Skeleton className=\"h-96 w-full rounded-2xl\" />\n        </div>\n      </div>\n    );\n  }\n\n  if (!subscription) {\n    return (\n      <div className=\"bg-gradient-to-br from-slate-50 via-blue-50 to-sky-50 p-4\">\n        <div className=\"max-w-4xl mx-auto text-center py-8\">\n          <div className=\"text-6xl mb-4\">👑</div>\n          <h2 className=\"text-3xl font-bold text-slate-900 mb-4\">{txtNoActiveSubscription}</h2>\n          <p className=\"text-xl text-slate-600 mb-8\">\n            {txtUpgradeMessage}\n          </p>\n          <Button \n            size=\"lg\"\n            className=\"bg-gradient-to-r from-amber-500 to-orange-500 hover:from-amber-600 hover:to-orange-600 px-8 py-6 text-lg\"\n            onClick={() => navigate(createPageUrl(\"Premium\"))}\n          >\n            <Sparkles className=\"w-5 h-5 mr-2\" />\n            {txtViewPremiumPlans}\n          </Button>\n        </div>\n      </div>\n    );\n  }\n\n  const isPremium = subscription.plan === \"premium\";\n  const isActive = subscription.status === \"active\";\n  const isCancelled = subscription.status === \"cancelled\";\n  const daysRemaining = Math.ceil((new Date(subscription.end_date) - new Date()) / (1000 * 60 * 60 * 24));\n\n  return (\n    <div className=\"bg-gradient-to-br from-slate-50 via-blue-50 to-sky-50\">\n      <div className=\"max-w-4xl mx-auto px-4 py-4\">\n        {/* Header */}\n        <Button\n          variant=\"outline\"\n          className=\"mb-6 gap-2\"\n          onClick={() => navigate(createPageUrl(\"Home\"))}\n        >\n          <ArrowLeft className=\"w-4 h-4\" />\n          {txtBack}\n        </Button>\n\n        <div className=\"mb-8\">\n          <h1 className=\"text-4xl font-bold text-slate-900 mb-2\">\n            {txtManageSubscription}\n          </h1>\n          <p className=\"text-xl text-slate-600\">\n            {txtManageAllAspects}\n          </p>\n        </div>\n\n        {/* Alerts */}\n        {isCancelled && (\n          <Alert className=\"mb-6 border-amber-200 bg-amber-50\">\n            <AlertTriangle className=\"h-5 w-5 text-amber-600\" />\n            <AlertDescription className=\"text-amber-900\">\n              <strong>{txtSubscriptionCancelled}:</strong> {txtAccessUntil} {new Date(subscription.end_date).toLocaleDateString('pt-PT')}. \n              {txtAfterDate}.\n            </AlertDescription>\n          </Alert>\n        )}\n\n        {isActive && daysRemaining <= 7 && (\n          <Alert className=\"mb-6 border-blue-200 bg-blue-50\">\n            <Bell className=\"h-5 w-5 text-blue-600\" />\n            <AlertDescription className=\"text-blue-900\">\n              {txtRenewsIn} <strong>{daysRemaining} {daysRemaining === 1 ? txtDay : txtDays}</strong>\n            </AlertDescription>\n          </Alert>\n        )}\n\n        {/* Subscription Card */}\n        <Card className=\"mb-8 border-0 shadow-xl overflow-hidden\">\n          <div className={`h-3 ${\n            isPremium \n              ? 'bg-gradient-to-r from-amber-400 via-orange-500 to-amber-400' \n              : 'bg-gradient-to-r from-slate-400 to-gray-500'\n          }`} />\n          \n          <CardContent className=\"p-8\">\n            <div className=\"flex flex-col md:flex-row justify-between items-start md:items-center gap-6 mb-8\">\n              <div className=\"flex items-center gap-4\">\n                <div className={`w-16 h-16 rounded-2xl bg-gradient-to-br ${\n                  isPremium ? 'from-amber-500 to-orange-600' : 'from-slate-500 to-gray-600'\n                } flex items-center justify-center shadow-xl`}>\n                  <Crown className=\"w-8 h-8 text-white\" />\n                </div>\n                <div>\n                  <h2 className=\"text-3xl font-bold text-slate-900\">\n                    {txtPlan} {subscription.plan === \"premium\" ? txtPremium : txtFree}\n                  </h2>\n                  <Badge className={\n                    isActive \n                      ? \"bg-green-100 text-green-700 border-green-200 mt-2\" \n                      : \"bg-red-100 text-red-700 border-red-200 mt-2\"\n                  }>\n                    {isActive ? (\n                      <>\n                        <CheckCircle2 className=\"w-3 h-3 mr-1\" />\n                        {txtActive}\n                      </>\n                    ) : (\n                      <>\n                        <XCircle className=\"w-3 h-3 mr-1\" />\n                        {txtCancelled}\n                      </>\n                    )}\n                  </Badge>\n                </div>\n              </div>\n\n              <div className=\"text-right\">\n                <div className=\"text-4xl font-bold text-slate-900\">\n                  €{subscription.price}\n                  <span className=\"text-lg text-slate-500\">{txtPerMonth}</span>\n                </div>\n              </div>\n            </div>\n\n            {/* Subscription Details */}\n            <div className=\"grid md:grid-cols-2 gap-6 mb-8\">\n              <div className=\"p-4 bg-slate-50 rounded-xl\">\n                <div className=\"flex items-center gap-2 text-slate-600 mb-2\">\n                  <Calendar className=\"w-4 h-4\" />\n                  <span className=\"text-sm font-medium\">{txtStartDate}</span>\n                </div>\n                <div className=\"text-lg font-bold text-slate-900\">\n                  {new Date(subscription.start_date).toLocaleDateString('pt-PT', {\n                    day: 'numeric',\n                    month: 'long',\n                    year: 'numeric'\n                  })}\n                </div>\n              </div>\n\n              <div className=\"p-4 bg-slate-50 rounded-xl\">\n                <div className=\"flex items-center gap-2 text-slate-600 mb-2\">\n                  <Calendar className=\"w-4 h-4\" />\n                  <span className=\"text-sm font-medium\">\n                    {isCancelled ? txtExpiresIn : txtNextRenewal}\n                  </span>\n                </div>\n                <div className=\"text-lg font-bold text-slate-900\">\n                  {new Date(subscription.end_date).toLocaleDateString('pt-PT', {\n                    day: 'numeric',\n                    month: 'long',\n                    year: 'numeric'\n                  })}\n                </div>\n              </div>\n\n              <div className=\"p-4 bg-slate-50 rounded-xl\">\n                <div className=\"flex items-center gap-2 text-slate-600 mb-2\">\n                  <CreditCard className=\"w-4 h-4\" />\n                  <span className=\"text-sm font-medium\">{txtPaymentMethod}</span>\n                </div>\n                <div className=\"text-lg font-bold text-slate-900\">\n                  {subscription.payment_method || txtCreditCard}\n                </div>\n              </div>\n\n              <div className=\"p-4 bg-slate-50 rounded-xl\">\n                <div className=\"flex items-center gap-2 text-slate-600 mb-2\">\n                  <Settings className=\"w-4 h-4\" />\n                  <span className=\"text-sm font-medium\">{txtAutoRenewal}</span>\n                </div>\n                <div className=\"flex items-center gap-3\">\n                  <Switch\n                    checked={subscription.auto_renew}\n                    onCheckedChange={(checked) => toggleAutoRenewMutation.mutate(checked)}\n                    disabled={isCancelled || toggleAutoRenewMutation.isPending}\n                  />\n                  <span className=\"font-semibold text-slate-900\">\n                    {subscription.auto_renew ? txtEnabled : txtDisabled}\n                  </span>\n                </div>\n              </div>\n            </div>\n\n            {/* Features Included */}\n            {subscription.features && subscription.features.length > 0 && (\n              <div className=\"mb-8\">\n                <h3 className=\"font-bold text-lg text-slate-900 mb-4\">{txtFeaturesIncluded}</h3>\n                <div className=\"grid md:grid-cols-2 gap-3\">\n                  {subscription.features.map((feature, idx) => (\n                    <div key={idx} className=\"flex items-center gap-2 text-slate-700\">\n                      <CheckCircle2 className=\"w-5 h-5 text-green-500 flex-shrink-0\" />\n                      <span>{feature}</span>\n                    </div>\n                  ))}\n                </div>\n              </div>\n            )}\n\n            {/* Actions */}\n            <div className=\"flex flex-col sm:flex-row gap-4\">\n              {isActive ? (\n                <>\n                  <Button\n                    variant=\"outline\"\n                    className=\"flex-1 gap-2\"\n                    onClick={() => {/* Update payment method */}}\n                  >\n                    <CreditCard className=\"w-4 h-4\" />\n                    {txtUpdatePayment}\n                  </Button>\n                  \n                  <Button\n                    variant=\"outline\"\n                    className=\"flex-1 gap-2\"\n                    onClick={() => {/* Download invoice */}}\n                  >\n                    <Download className=\"w-4 h-4\" />\n                    {txtDownloadInvoices}\n                  </Button>\n\n                  {!showCancelConfirm ? (\n                    <Button\n                      variant=\"outline\"\n                      className=\"flex-1 border-red-200 text-red-600 hover:bg-red-50 gap-2\"\n                      onClick={() => setShowCancelConfirm(true)}\n                    >\n                      <XCircle className=\"w-4 h-4\" />\n                      {txtCancelSubscription}\n                    </Button>\n                  ) : (\n                    <div className=\"flex-1 p-4 bg-red-50 border-2 border-red-200 rounded-xl\">\n                      <p className=\"text-sm text-red-900 mb-3 font-medium\">\n                        {txtAreYouSure}.\n                      </p>\n                      <div className=\"flex gap-2\">\n                        <Button\n                          size=\"sm\"\n                          variant=\"outline\"\n                          onClick={() => setShowCancelConfirm(false)}\n                        >\n                          {txtNo}\n                        </Button>\n                        <Button\n                          size=\"sm\"\n                          variant=\"destructive\"\n                          onClick={() => cancelSubscriptionMutation.mutate()}\n                          disabled={cancelSubscriptionMutation.isPending}\n                        >\n                          {cancelSubscriptionMutation.isPending ? txtCancelling : txtYesCancel}\n                        </Button>\n                      </div>\n                    </div>\n                  )}\n                </>\n              ) : (\n                <Button\n                  className=\"flex-1 bg-gradient-to-r from-amber-500 to-orange-500 hover:from-amber-600 hover:to-orange-600 gap-2 py-6 text-lg\"\n                  onClick={() => reactivateSubscriptionMutation.mutate()}\n                  disabled={reactivateSubscriptionMutation.isPending}\n                >\n                  <Sparkles className=\"w-5 h-5\" />\n                  {reactivateSubscriptionMutation.isPending ? txtReactivating : txtReactivatePremium}\n                </Button>\n              )}\n            </div>\n          </CardContent>\n        </Card>\n\n        {/* Upgrade CTA for Free Users */}\n        {!isPremium && (\n          <Card className=\"border-0 shadow-xl bg-gradient-to-br from-amber-50 to-orange-50\">\n            <CardContent className=\"p-8 text-center\">\n              <Crown className=\"w-16 h-16 text-amber-600 mx-auto mb-4\" />\n              <h3 className=\"text-2xl font-bold text-slate-900 mb-2\">\n                {txtUpgradeToPremium}\n              </h3>\n              <p className=\"text-slate-700 mb-6\">\n                {txtUnlockFeatures}\n              </p>\n              <Button\n                size=\"lg\"\n                className=\"bg-gradient-to-r from-amber-500 to-orange-500 hover:from-amber-600 hover:to-orange-600\"\n                onClick={() => navigate(createPageUrl(\"Premium\"))}\n              >\n                <Sparkles className=\"w-5 h-5 mr-2\" />\n                {txtViewPremiumPlans}\n              </Button>\n            </CardContent>\n          </Card>\n        )}\n      </div>\n    </div>\n  );\n}","path":null,"size_bytes":21796,"size_tokens":null},"src/components/business/PerformanceCharts.jsx":{"content":"import React from \"react\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { LineChart, Line, BarChart, Bar, PieChart, Pie, Cell, XAxis, YAxis, CartesianGrid, Tooltip, Legend, ResponsiveContainer, Area, AreaChart } from \"recharts\";\nimport { TrendingUp, Activity, PieChart as PieChartIcon } from \"lucide-react\";\nimport { useAutoTranslate } from \"@/hooks/useTranslate\";\n\nexport default function PerformanceCharts({ tickets, queues, timePeriod }) {\n  // Traduções\n  const txtTemporalEvolution = useAutoTranslate('Evolução Temporal', 'pt');\n  const txtTotal = useAutoTranslate('Total', 'pt');\n  const txtCompleted = useAutoTranslate('Concluídas', 'pt');\n  const txtCancelled = useAutoTranslate('Canceladas', 'pt');\n  const txtQueueDistribution = useAutoTranslate('Distribuição por Fila', 'pt');\n  const txtStatusDistribution = useAutoTranslate('Distribuição por Estado', 'pt');\n  const txtHourlyPerformance = useAutoTranslate('Desempenho por Hora', 'pt');\n  const txtTickets = useAutoTranslate('Senhas', 'pt');\n  const txtUnknown = useAutoTranslate('Desconhecida', 'pt');\n  const txtWaiting = useAutoTranslate('Aguardando', 'pt');\n  const txtInService = useAutoTranslate('Atendendo', 'pt');\n  // Prepare daily trend data\n  const dailyData = React.useMemo(() => {\n    const dataMap = {};\n    \n    tickets.forEach(ticket => {\n      const date = new Date(ticket.created_date).toLocaleDateString('pt-PT', { \n        day: '2-digit', \n        month: '2-digit' \n      });\n      \n      if (!dataMap[date]) {\n        dataMap[date] = { \n          date, \n          total: 0, \n          concluidas: 0, \n          canceladas: 0 \n        };\n      }\n      \n      dataMap[date].total++;\n      if (ticket.status === 'concluido') dataMap[date].concluidas++;\n      if (ticket.status === 'cancelado') dataMap[date].canceladas++;\n    });\n\n    return Object.values(dataMap).sort((a, b) => {\n      const [dayA, monthA] = a.date.split('/');\n      const [dayB, monthB] = b.date.split('/');\n      return new Date(2024, monthA - 1, dayA) - new Date(2024, monthB - 1, dayB);\n    });\n  }, [tickets]);\n\n  // Queue distribution\n  const queueDistribution = React.useMemo(() => {\n    const distribution = {};\n    \n    tickets.forEach(ticket => {\n      const queue = queues.find(q => q.id === ticket.queue_id);\n      const queueName = queue?.name || txtUnknown;\n      \n      if (!distribution[queueName]) {\n        distribution[queueName] = 0;\n      }\n      distribution[queueName]++;\n    });\n\n    return Object.entries(distribution).map(([name, value]) => ({\n      name,\n      value\n    }));\n  }, [tickets, queues]);\n\n  // Status distribution\n  const statusDistribution = React.useMemo(() => {\n    const statuses = {\n      'Concluído': tickets.filter(t => t.status === 'concluido').length,\n      'Cancelado': tickets.filter(t => t.status === 'cancelado').length,\n      'Aguardando': tickets.filter(t => t.status === 'aguardando').length,\n      'Atendendo': tickets.filter(t => t.status === 'atendendo').length,\n    };\n\n    return Object.entries(statuses)\n      .filter(([_, value]) => value > 0)\n      .map(([name, value]) => ({ name, value }));\n  }, [tickets]);\n\n  // Hourly performance\n  const hourlyPerformance = React.useMemo(() => {\n    const hours = Array(24).fill(0).map((_, i) => ({\n      hora: `${i}h`,\n      senhas: 0,\n      concluidas: 0\n    }));\n\n    tickets.forEach(ticket => {\n      const hour = new Date(ticket.created_date).getHours();\n      hours[hour].senhas++;\n      if (ticket.status === 'concluido') hours[hour].concluidas++;\n    });\n\n    return hours.filter(h => h.senhas > 0);\n  }, [tickets]);\n\n  const COLORS = ['#0ea5e9', '#8b5cf6', '#f59e0b', '#10b981', '#ef4444', '#ec4899'];\n\n  return (\n    <>\n      {/* Trend Chart */}\n      <Card className=\"border-0 shadow-lg\">\n        <CardHeader>\n          <CardTitle className=\"flex items-center gap-2\">\n            <TrendingUp className=\"w-5 h-5\" />\n            Evolução Temporal\n          </CardTitle>\n        </CardHeader>\n        <CardContent>\n          <ResponsiveContainer width=\"100%\" height={300}>\n            <AreaChart data={dailyData}>\n              <defs>\n                <linearGradient id=\"colorTotal\" x1=\"0\" y1=\"0\" x2=\"0\" y2=\"1\">\n                  <stop offset=\"5%\" stopColor=\"#0ea5e9\" stopOpacity={0.8}/>\n                  <stop offset=\"95%\" stopColor=\"#0ea5e9\" stopOpacity={0}/>\n                </linearGradient>\n                <linearGradient id=\"colorConcluidas\" x1=\"0\" y1=\"0\" x2=\"0\" y2=\"1\">\n                  <stop offset=\"5%\" stopColor=\"#10b981\" stopOpacity={0.8}/>\n                  <stop offset=\"95%\" stopColor=\"#10b981\" stopOpacity={0}/>\n                </linearGradient>\n              </defs>\n              <CartesianGrid strokeDasharray=\"3 3\" stroke=\"#e5e7eb\" />\n              <XAxis dataKey=\"date\" stroke=\"#64748b\" style={{ fontSize: '12px' }} />\n              <YAxis stroke=\"#64748b\" style={{ fontSize: '12px' }} />\n              <Tooltip \n                contentStyle={{ \n                  backgroundColor: '#fff', \n                  border: '1px solid #e5e7eb',\n                  borderRadius: '8px',\n                  boxShadow: '0 4px 6px -1px rgb(0 0 0 / 0.1)'\n                }}\n              />\n              <Legend />\n              <Area \n                type=\"monotone\" \n                dataKey=\"total\" \n                stroke=\"#0ea5e9\" \n                fillOpacity={1} \n                fill=\"url(#colorTotal)\"\n                name=\"Total\"\n              />\n              <Area \n                type=\"monotone\" \n                dataKey=\"concluidas\" \n                stroke=\"#10b981\" \n                fillOpacity={1} \n                fill=\"url(#colorConcluidas)\"\n                name=\"Concluídas\"\n              />\n            </AreaChart>\n          </ResponsiveContainer>\n        </CardContent>\n      </Card>\n\n      <div className=\"grid md:grid-cols-2 gap-6\">\n        {/* Queue Distribution */}\n        <Card className=\"border-0 shadow-lg\">\n          <CardHeader>\n            <CardTitle className=\"flex items-center gap-2\">\n              <PieChartIcon className=\"w-5 h-5\" />\n              Distribuição por Senha\n            </CardTitle>\n          </CardHeader>\n          <CardContent>\n            <ResponsiveContainer width=\"100%\" height={300}>\n              <PieChart>\n                <Pie\n                  data={queueDistribution}\n                  cx=\"50%\"\n                  cy=\"50%\"\n                  labelLine={false}\n                  label={({ name, percent }) => `${name}: ${(percent * 100).toFixed(0)}%`}\n                  outerRadius={80}\n                  fill=\"#8884d8\"\n                  dataKey=\"value\"\n                >\n                  {queueDistribution.map((entry, index) => (\n                    <Cell key={`cell-${index}`} fill={COLORS[index % COLORS.length]} />\n                  ))}\n                </Pie>\n                <Tooltip />\n              </PieChart>\n            </ResponsiveContainer>\n          </CardContent>\n        </Card>\n\n        {/* Status Distribution */}\n        <Card className=\"border-0 shadow-lg\">\n          <CardHeader>\n            <CardTitle className=\"flex items-center gap-2\">\n              <Activity className=\"w-5 h-5\" />\n              Status das Senhas\n            </CardTitle>\n          </CardHeader>\n          <CardContent>\n            <ResponsiveContainer width=\"100%\" height={300}>\n              <BarChart data={statusDistribution}>\n                <CartesianGrid strokeDasharray=\"3 3\" stroke=\"#e5e7eb\" />\n                <XAxis dataKey=\"name\" stroke=\"#64748b\" style={{ fontSize: '12px' }} />\n                <YAxis stroke=\"#64748b\" style={{ fontSize: '12px' }} />\n                <Tooltip \n                  contentStyle={{ \n                    backgroundColor: '#fff', \n                    border: '1px solid #e5e7eb',\n                    borderRadius: '8px',\n                    boxShadow: '0 4px 6px -1px rgb(0 0 0 / 0.1)'\n                  }}\n                />\n                <Bar dataKey=\"value\" fill=\"#0ea5e9\" radius={[8, 8, 0, 0]} />\n              </BarChart>\n            </ResponsiveContainer>\n          </CardContent>\n        </Card>\n      </div>\n\n      {/* Hourly Performance */}\n      {hourlyPerformance.length > 0 && (\n        <Card className=\"border-0 shadow-lg\">\n          <CardHeader>\n            <CardTitle className=\"flex items-center gap-2\">\n              <Activity className=\"w-5 h-5\" />\n              Desempenho por Hora\n            </CardTitle>\n          </CardHeader>\n          <CardContent>\n            <ResponsiveContainer width=\"100%\" height={300}>\n              <LineChart data={hourlyPerformance}>\n                <CartesianGrid strokeDasharray=\"3 3\" stroke=\"#e5e7eb\" />\n                <XAxis dataKey=\"hora\" stroke=\"#64748b\" style={{ fontSize: '12px' }} />\n                <YAxis stroke=\"#64748b\" style={{ fontSize: '12px' }} />\n                <Tooltip \n                  contentStyle={{ \n                    backgroundColor: '#fff', \n                    border: '1px solid #e5e7eb',\n                    borderRadius: '8px',\n                    boxShadow: '0 4px 6px -1px rgb(0 0 0 / 0.1)'\n                  }}\n                />\n                <Legend />\n                <Line \n                  type=\"monotone\" \n                  dataKey=\"senhas\" \n                  stroke=\"#0ea5e9\" \n                  strokeWidth={2}\n                  dot={{ fill: '#0ea5e9', r: 4 }}\n                  name=\"Senhas Emitidas\"\n                />\n                <Line \n                  type=\"monotone\" \n                  dataKey=\"concluidas\" \n                  stroke=\"#10b981\" \n                  strokeWidth={2}\n                  dot={{ fill: '#10b981', r: 4 }}\n                  name=\"Senhas Concluídas\"\n                />\n              </LineChart>\n            </ResponsiveContainer>\n          </CardContent>\n        </Card>\n      )}\n    </>\n  );\n}","path":null,"size_bytes":9847,"size_tokens":null},"src/pages/CustomerPortal.jsx":{"content":"import React, { useState, useEffect } from \"react\";\nimport { base44 } from \"@/api/base44Client\";\nimport { Card, CardContent } from \"@/components/ui/card\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Tabs, TabsList, TabsTrigger, TabsContent } from \"@/components/ui/tabs\";\nimport { Ticket, Calendar } from \"lucide-react\";\nimport { Skeleton } from \"@/components/ui/skeleton\";\nimport TicketHistory from \"../components/portal/TicketHistory\";\nimport AppointmentHistory from \"../components/portal/AppointmentHistory\";\nimport { useAutoTranslate } from \"@/hooks/useTranslate\";\n\nexport default function CustomerPortalPage() {\n  const txtPortal = useAutoTranslate('Portal', 'pt');\n  const txtWelcome = useAutoTranslate('Bem-vindo', 'pt');\n  const txtManageTicketsAppointments = useAutoTranslate('Gerir as suas senhas e marcações num único local', 'pt');\n  const txtTickets = useAutoTranslate('Senhas', 'pt');\n  const txtAppointments = useAutoTranslate('Marcações', 'pt');\n  \n  const [user, setUser] = useState(null);\n\n  useEffect(() => {\n    base44.auth.me().then(setUser).catch(() => {\n      base44.auth.redirectToLogin();\n    });\n  }, []);\n\n  if (!user) {\n    return (\n      <div className=\"bg-gradient-to-br from-slate-50 via-blue-50 to-sky-50 flex items-center justify-center p-3\">\n        <div className=\"max-w-6xl mx-auto w-full\">\n          <Skeleton className=\"h-20 w-full mb-3 rounded-xl\" />\n          <Skeleton className=\"h-64 w-full rounded-xl\" />\n        </div>\n      </div>\n    );\n  }\n\n  const displayName = user?.nome_completo || user?.full_name || 'Utilizador';\n\n  return (\n    <div className=\"bg-gradient-to-br from-slate-50 via-blue-50 to-sky-50\">\n      <div className=\"max-w-7xl mx-auto px-3 md:px-4 py-4\">\n        <div className=\"text-center mb-4 md:mb-6\">\n          <Badge className=\"bg-gradient-to-r from-sky-600 to-blue-600 text-white mb-2 text-[10px] px-2 py-0.5\">\n            <Ticket className=\"w-2.5 h-2.5 mr-0.5\" />\n            {txtPortal}\n          </Badge>\n          <h1 className=\"text-xl md:text-2xl font-bold text-slate-900 mb-1\">\n            {txtWelcome},\n            <span className=\"text-transparent bg-clip-text bg-gradient-to-r from-sky-600 to-blue-600 ml-1\">\n              {displayName}\n            </span>\n          </h1>\n          <p className=\"text-xs md:text-sm text-slate-600 max-w-2xl mx-auto\">\n            {txtManageTicketsAppointments}\n          </p>\n        </div>\n\n        <Card className=\"border-0 shadow-lg\">\n          <div className=\"h-1 bg-gradient-to-r from-sky-500 to-blue-600\" />\n          <CardContent className=\"p-3 md:p-5\">\n            <Tabs defaultValue=\"tickets\" className=\"space-y-3 md:space-y-4\">\n              <TabsList className=\"bg-slate-100 border-0 w-full grid grid-cols-2 p-0.5 h-8\">\n                <TabsTrigger value=\"tickets\" className=\"gap-1 text-xs h-7 data-[state=active]:bg-white data-[state=active]:shadow-sm\">\n                  <Ticket className=\"w-3.5 h-3.5\" />\n                  {txtTickets}\n                </TabsTrigger>\n                <TabsTrigger value=\"appointments\" className=\"gap-1 text-xs h-7 data-[state=active]:bg-white data-[state=active]:shadow-sm\">\n                  <Calendar className=\"w-3.5 h-3.5\" />\n                  {txtAppointments}\n                </TabsTrigger>\n              </TabsList>\n\n              <TabsContent value=\"tickets\">\n                <TicketHistory user={user} />\n              </TabsContent>\n\n              <TabsContent value=\"appointments\">\n                <AppointmentHistory user={user} />\n              </TabsContent>\n            </Tabs>\n          </CardContent>\n        </Card>\n      </div>\n    </div>\n  );\n}","path":null,"size_bytes":3635,"size_tokens":null},"src/components/ui/progress.jsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as ProgressPrimitive from \"@radix-ui/react-progress\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Progress = React.forwardRef(({ className, value, ...props }, ref) => (\n  <ProgressPrimitive.Root\n    ref={ref}\n    className={cn(\n      \"relative h-2 w-full overflow-hidden rounded-full bg-primary/20\",\n      className\n    )}\n    {...props}>\n    <ProgressPrimitive.Indicator\n      className=\"h-full w-full flex-1 bg-primary transition-all\"\n      style={{ transform: `translateX(-${100 - (value || 0)}%)` }} />\n  </ProgressPrimitive.Root>\n))\nProgress.displayName = ProgressPrimitive.Root.displayName\n\nexport { Progress }\n","path":null,"size_bytes":667,"size_tokens":null},"src/pages/BusinessSupport.jsx":{"content":"import React, { useState, useEffect } from \"react\";\nimport { base44 } from \"@/api/base44Client\";\nimport { useNavigate } from \"react-router-dom\";\nimport { createPageUrl } from \"@/utils\";\nimport { SupportContent } from \"@/components/support/SupportContent\";\nimport { Skeleton } from \"@/components/ui/skeleton\";\nimport { TranslatedText } from \"@/components/translation/TranslatedText\";\n\nexport default function BusinessSupportPage() {\n  const navigate = useNavigate();\n  const [user, setUser] = useState(null);\n  const [loading, setLoading] = useState(true);\n\n  useEffect(() => {\n    base44.auth.me().then(userData => {\n      setUser(userData);\n      if (!userData.is_business_user || !userData.business_id) {\n        navigate(createPageUrl(\"Home\"));\n      }\n      setLoading(false);\n    }).catch(() => {\n      base44.auth.redirectToLogin();\n    });\n  }, [navigate]);\n\n  if (!user || loading) {\n    return (\n      <div className=\"bg-gradient-to-br from-slate-50 via-blue-50 to-sky-50 p-3 md:p-4\">\n        <div className=\"max-w-4xl mx-auto\">\n          <Skeleton className=\"h-16 w-64 mb-8\" />\n          <Skeleton className=\"h-96 w-full\" />\n        </div>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"bg-gradient-to-br from-slate-50 via-blue-50 to-sky-50\">\n      <div className=\"max-w-4xl mx-auto px-3 md:px-4 py-4 pb-24 md:pb-4\">\n        <div className=\"mb-6 md:mb-8\">\n          <h1 className=\"text-2xl md:text-4xl font-bold text-slate-900 mb-2\">\n            <TranslatedText text=\"Suporte\" sourceLang=\"pt\" />\n          </h1>\n          <p className=\"text-sm md:text-xl text-slate-600\">\n            <TranslatedText text=\"Estamos aqui para ajudar\" sourceLang=\"pt\" />\n          </p>\n        </div>\n\n        <SupportContent />\n      </div>\n    </div>\n  );\n}\n","path":null,"size_bytes":1759,"size_tokens":null},"src/components/business/AppointmentReminders.jsx":{"content":"import { useEffect } from \"react\";\nimport { base44 } from \"@/api/base44Client\";\nimport { useQuery } from \"@tanstack/react-query\";\nimport { useAutoTranslate } from \"@/hooks/useTranslate\";\n\nexport default function AppointmentReminders({ businessId }) {\n  // Traduções para templates de email/SMS\n  const txtSMSSent = useAutoTranslate('SMS Enviado', 'pt');\n  const txtDefaultEmailTemplate = useAutoTranslate('Lembrete: Tem uma marcação amanhã às', 'pt');\n  const txtReminderSubject = useAutoTranslate('Lembrete de Marcação', 'pt');\n  const txtDefaultSMSTemplate = useAutoTranslate('Lembrete: Marcação amanhã às', 'pt');\n  const { data: appointments } = useQuery({\n    queryKey: ['upcoming-appointments', businessId],\n    queryFn: () => base44.entities.Appointment.filter({\n      business_id: businessId,\n      status: { $in: ['agendado', 'confirmado'] }\n    }),\n    initialData: [],\n    refetchInterval: 60000, // Check every minute\n  });\n\n  const { data: business } = useQuery({\n    queryKey: ['business', businessId],\n    queryFn: async () => {\n      const businesses = await base44.entities.Business.filter({ id: businessId });\n      return businesses[0];\n    },\n    enabled: !!businessId,\n  });\n\n  const sendSMS = async (phone, message) => {\n    if (!business?.sms_gateway || business.sms_gateway === 'none') {\n      return; // SMS not configured\n    }\n\n    // In production, this would make actual API calls to Twilio/Vonage\n    // For now, we simulate it via email notification\n    await base44.integrations.Core.SendEmail({\n      to: business.email,\n      subject: txtSMSSent,\n      body: `[SMS] Para: ${phone}\\nMensagem: ${message}\\nGateway: ${business.sms_gateway}`\n    });\n  };\n\n  useEffect(() => {\n    // Guard: Wait for translations to load before sending reminders\n    if (!appointments || !business) return;\n    if (!txtDefaultEmailTemplate || !txtReminderSubject || !txtDefaultSMSTemplate || !txtSMSSent) return;\n\n    appointments.forEach(async (appointment) => {\n      const appointmentDate = new Date(appointment.appointment_date);\n      const now = new Date();\n      const hoursUntil = (appointmentDate - now) / (1000 * 60 * 60);\n\n      // Send reminder 24 hours before\n      if (hoursUntil <= 24 && hoursUntil > 23.5 && !appointment.reminder_sent) {\n        // Send email reminder\n        const emailBody = business.reminder_email_template || \n          `${txtDefaultEmailTemplate} ${appointment.appointment_time} - ${business.name}`;\n\n        await base44.integrations.Core.SendEmail({\n          to: appointment.user_email,\n          subject: `${txtReminderSubject} - ${business.name}`,\n          body: emailBody\n        });\n\n        // Send SMS reminder if configured\n        if (business.sms_gateway !== 'none') {\n          const smsBody = business.reminder_sms_template || \n            `${txtDefaultSMSTemplate} ${appointment.appointment_time} em ${business.name}`;\n          \n          await sendSMS(appointment.user_email, smsBody);\n        }\n\n        // Mark as sent\n        await base44.entities.Appointment.update(appointment.id, {\n          reminder_sent: true\n        });\n      }\n    });\n  }, [appointments, business, txtDefaultEmailTemplate, txtReminderSubject, txtDefaultSMSTemplate, txtSMSSent]);\n\n  return null; // This is a background component\n}","path":null,"size_bytes":3290,"size_tokens":null},"src/pages/AppointmentManage.jsx":{"content":"import React, { useState } from \"react\";\nimport { base44 } from \"@/api/base44Client\";\nimport { useQuery, useMutation, useQueryClient } from \"@tanstack/react-query\";\nimport { useNavigate } from \"react-router-dom\";\nimport { createPageUrl } from \"@/utils\";\nimport { getUploadUrl } from \"@/utils/apiConfig\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Skeleton } from \"@/components/ui/skeleton\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport { Label } from \"@/components/ui/label\";\nimport { Calendar } from \"@/components/ui/calendar\";\nimport { \n  Calendar as CalendarIcon,\n  Clock,\n  MapPin,\n  CheckCircle2,\n  XCircle,\n  AlertCircle,\n  Star,\n  ArrowLeft\n} from \"lucide-react\";\nimport { format } from \"date-fns\";\nimport { pt } from \"date-fns/locale\";\nimport { useAutoTranslate } from \"@/hooks/useTranslate\";\n\nexport default function AppointmentManagePage() {\n  const txtAppointmentNotFound = useAutoTranslate('Marcação não encontrada', 'pt');\n  const txtInvalidToken = useAutoTranslate('Token inválido ou marcação já foi removida', 'pt');\n  const txtBackToDashboard = useAutoTranslate('Voltar ao Dashboard', 'pt');\n  const txtConfirmCancel = useAutoTranslate('Tem certeza que deseja cancelar esta marcação?', 'pt');\n  const txtMyAppointments = useAutoTranslate('Minhas Marcações', 'pt');\n  const txtAppointmentDetails = useAutoTranslate('Detalhes da Marcação', 'pt');\n  const txtDate = useAutoTranslate('Data', 'pt');\n  const txtDateNotAvailable = useAutoTranslate('Data não disponível', 'pt');\n  const txtHour = useAutoTranslate('Hora', 'pt');\n  const txtService = useAutoTranslate('Serviço', 'pt');\n  const txtDuration = useAutoTranslate('Duração:', 'pt');\n  const txtMinutes = useAutoTranslate('minutos', 'pt');\n  const txtTolerance = useAutoTranslate('Tolerância:', 'pt');\n  const txtMinutesToAppear = useAutoTranslate('minutos para comparecer', 'pt');\n  const txtNotes = useAutoTranslate('Observações', 'pt');\n  const txtCancelling = useAutoTranslate('Cancelando...', 'pt');\n  const txtCancelAppointment = useAutoTranslate('Cancelar Marcação', 'pt');\n  const txtHowWasService = useAutoTranslate('Como foi o atendimento?', 'pt');\n  const txtRating = useAutoTranslate('Avaliação', 'pt');\n  const txtCommentOptional = useAutoTranslate('Comentário (opcional)', 'pt');\n  const txtTellExperience = useAutoTranslate('Conte-nos sobre sua experiência...', 'pt');\n  const txtSending = useAutoTranslate('Enviando...', 'pt');\n  const txtSubmitRating = useAutoTranslate('Enviar Avaliação', 'pt');\n  const txtYourRating = useAutoTranslate('Sua avaliação:', 'pt');\n  const navigate = useNavigate();\n  const queryClient = useQueryClient();\n  const urlParams = new URLSearchParams(window.location.search);\n  const token = urlParams.get('token');\n  const [showFeedback, setShowFeedback] = useState(false);\n  const [rating, setRating] = useState(0);\n  const [feedback, setFeedback] = useState('');\n\n  const { data: appointment, isLoading } = useQuery({\n    queryKey: ['appointment-by-token', token],\n    queryFn: async () => {\n      const appointments = await base44.entities.Appointment.filter({ management_token: token });\n      const apt = appointments[0];\n      \n      // Show feedback form if completed and no rating yet\n      if (apt?.status === 'concluido' && !apt.rating) {\n        setShowFeedback(true);\n      }\n      \n      return apt;\n    },\n    enabled: !!token,\n  });\n\n  const { data: business } = useQuery({\n    queryKey: ['business', appointment?.business_id],\n    queryFn: async () => {\n      const businesses = await base44.entities.Business.filter({ id: appointment.business_id });\n      return businesses[0];\n    },\n    enabled: !!appointment?.business_id,\n  });\n\n  const { data: service } = useQuery({\n    queryKey: ['service', appointment?.service_id],\n    queryFn: async () => {\n      const services = await base44.entities.Service.filter({ id: appointment.service_id });\n      return services[0];\n    },\n    enabled: !!appointment?.service_id,\n  });\n\n  const cancelMutation = useMutation({\n    mutationFn: async () => {\n      await base44.entities.Appointment.update(appointment.id, {\n        status: 'cancelado'\n      });\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['appointment-by-token'] });\n    },\n  });\n\n  const submitFeedbackMutation = useMutation({\n    mutationFn: async () => {\n      await base44.entities.Appointment.update(appointment.id, {\n        rating,\n        feedback\n      });\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['appointment-by-token'] });\n      setShowFeedback(false);\n    },\n  });\n\n  const handleCancel = () => {\n    if (confirm(txtConfirmCancel)) {\n      cancelMutation.mutate();\n    }\n  };\n\n  if (isLoading) {\n    return (\n      <div className=\"bg-gradient-to-br from-slate-50 via-blue-50 to-sky-50 p-4\">\n        <div className=\"max-w-2xl mx-auto\">\n          <Skeleton className=\"h-96 w-full\" />\n        </div>\n      </div>\n    );\n  }\n\n  if (!appointment) {\n    return (\n      <div className=\"bg-gradient-to-br from-slate-50 via-blue-50 to-sky-50 p-4\">\n        <div className=\"max-w-2xl mx-auto\">\n          <Card>\n            <CardContent className=\"py-16 text-center\">\n              <AlertCircle className=\"w-16 h-16 text-slate-400 mx-auto mb-4\" />\n              <h3 className=\"text-2xl font-bold text-slate-900 mb-2\">{txtAppointmentNotFound}</h3>\n              <p className=\"text-slate-600 mb-6\">{txtInvalidToken}</p>\n              <Button onClick={() => navigate(createPageUrl('Dashboard'))}>\n                {txtBackToDashboard}\n              </Button>\n            </CardContent>\n          </Card>\n        </div>\n      </div>\n    );\n  }\n\n  const appointmentDate = (() => {\n    try {\n      if (!appointment.appointment_date) return new Date();\n      const date = new Date(appointment.appointment_date);\n      if (isNaN(date.getTime())) return new Date();\n      return date;\n    } catch (e) {\n      console.warn('Erro ao criar data da marcação:', e);\n      return new Date();\n    }\n  })();\n  const isPast = appointmentDate < new Date();\n\n  return (\n    <div className=\"bg-gradient-to-br from-slate-50 via-blue-50 to-sky-50\">\n      <div className=\"max-w-2xl mx-auto px-4 py-4\">\n        <Button\n          variant=\"outline\"\n          className=\"mb-6 gap-2\"\n          onClick={() => navigate(createPageUrl('MyAppointments'))}\n        >\n          <ArrowLeft className=\"w-4 h-4\" />\n          {txtMyAppointments}\n        </Button>\n\n        <Card className=\"border-0 shadow-2xl mb-6\">\n          <div className={`h-2 bg-gradient-to-r ${\n            appointment.status === 'agendado' ? 'from-blue-500 to-cyan-500' :\n            appointment.status === 'confirmado' ? 'from-green-500 to-emerald-500' :\n            appointment.status === 'concluido' ? 'from-purple-500 to-pink-500' :\n            'from-red-500 to-rose-500'\n          }`} />\n          \n          <CardHeader>\n            <div className=\"flex items-center justify-between\">\n              <CardTitle>{txtAppointmentDetails}</CardTitle>\n              <Badge className={\n                appointment.status === 'agendado' ? 'bg-blue-100 text-blue-700' :\n                appointment.status === 'confirmado' ? 'bg-green-100 text-green-700' :\n                appointment.status === 'concluido' ? 'bg-purple-100 text-purple-700' :\n                'bg-red-100 text-red-700'\n              }>\n                {appointment.status.charAt(0).toUpperCase() + appointment.status.slice(1)}\n              </Badge>\n            </div>\n          </CardHeader>\n\n          <CardContent className=\"space-y-6\">\n            {/* Business Info */}\n            <div className=\"bg-slate-50 rounded-xl p-6\">\n              <div className=\"flex items-start gap-4\">\n                {business?.logo_url && (\n                  <img \n                    src={getUploadUrl(business.logo_url)} \n                    alt={business.name}\n                    className=\"w-16 h-16 rounded-lg object-contain bg-white p-2\"\n                    onError={(e) => { e.target.style.display = 'none'; }}\n                  />\n                )}\n                <div className=\"flex-1\">\n                  <h3 className=\"font-bold text-xl text-slate-900 mb-1\">{business?.name}</h3>\n                  {business?.address && (\n                    <div className=\"flex items-center gap-2 text-sm text-slate-500\">\n                      <MapPin className=\"w-4 h-4\" />\n                      <span>{business.address}</span>\n                    </div>\n                  )}\n                </div>\n              </div>\n            </div>\n\n            {/* Appointment Details */}\n            <div className=\"grid md:grid-cols-2 gap-4\">\n              <div className=\"p-4 bg-gradient-to-br from-blue-50 to-cyan-50 rounded-xl\">\n                <div className=\"flex items-center gap-2 mb-2\">\n                  <CalendarIcon className=\"w-5 h-5 text-blue-600\" />\n                  <span className=\"text-sm text-slate-600\">{txtDate}</span>\n                </div>\n                <div className=\"text-xl font-bold text-blue-900\">\n                  {(() => {\n                    try {\n                      if (!appointmentDate || isNaN(appointmentDate.getTime())) return txtDateNotAvailable;\n                      return format(appointmentDate, \"dd 'de' MMMM 'de' yyyy\", { locale: pt });\n                    } catch (e) {\n                      console.warn('Erro ao formatar data:', e);\n                      return txtDateNotAvailable;\n                    }\n                  })()}\n                </div>\n              </div>\n\n              <div className=\"p-4 bg-gradient-to-br from-purple-50 to-pink-50 rounded-xl\">\n                <div className=\"flex items-center gap-2 mb-2\">\n                  <Clock className=\"w-5 h-5 text-purple-600\" />\n                  <span className=\"text-sm text-slate-600\">{txtHour}</span>\n                </div>\n                <div className=\"text-xl font-bold text-purple-900\">\n                  {appointment.appointment_time}\n                </div>\n              </div>\n            </div>\n\n            <div className=\"p-4 bg-slate-50 rounded-xl\">\n              <h4 className=\"font-semibold text-slate-900 mb-2\">{txtService}</h4>\n              <p className=\"text-slate-700\">{service?.name}</p>\n              {service?.description && (\n                <p className=\"text-sm text-slate-600 mt-1\">{service.description}</p>\n              )}\n              <div className=\"flex flex-col gap-2 mt-2\">\n                {service?.duration && (\n                  <div className=\"flex items-center gap-2 text-sm text-slate-600\">\n                    <Clock className=\"w-4 h-4\" />\n                    <span>{txtDuration} {service.duration} {txtMinutes}</span>\n                  </div>\n                )}\n                {service?.tolerance_time && appointment.status === 'confirmado' && (\n                  <div className=\"flex items-center gap-2 text-sm text-green-600 font-medium\">\n                    <Clock className=\"w-4 h-4\" />\n                    <span>{txtTolerance} {service.tolerance_time} {txtMinutesToAppear}</span>\n                  </div>\n                )}\n              </div>\n            </div>\n\n            {appointment.notes && (\n              <div className=\"p-4 bg-slate-50 rounded-xl\">\n                <h4 className=\"font-semibold text-slate-900 mb-2\">{txtNotes}</h4>\n                <p className=\"text-slate-700\">{appointment.notes}</p>\n              </div>\n            )}\n\n            {/* Actions */}\n            {['agendado', 'confirmado'].includes(appointment.status) && !isPast && (\n              <Button\n                variant=\"outline\"\n                className=\"w-full border-red-200 text-red-600 hover:bg-red-50\"\n                onClick={handleCancel}\n                disabled={cancelMutation.isPending}\n              >\n                <XCircle className=\"w-4 h-4 mr-2\" />\n                {cancelMutation.isPending ? txtCancelling : txtCancelAppointment}\n              </Button>\n            )}\n\n            {/* Feedback Form */}\n            {showFeedback && (\n              <div className=\"p-6 bg-gradient-to-br from-amber-50 to-orange-50 rounded-xl\">\n                <h4 className=\"font-bold text-lg text-slate-900 mb-4\">{txtHowWasService}</h4>\n                \n                <Label className=\"mb-2 block\">{txtRating}</Label>\n                <div className=\"flex gap-2 mb-4\">\n                  {[1, 2, 3, 4, 5].map(star => (\n                    <button\n                      key={star}\n                      onClick={() => setRating(star)}\n                      className={`p-2 rounded-lg transition-all ${\n                        rating >= star \n                          ? 'bg-amber-500 text-white' \n                          : 'bg-white text-slate-400 hover:bg-slate-100'\n                      }`}\n                    >\n                      <Star className=\"w-6 h-6\" fill={rating >= star ? 'currentColor' : 'none'} />\n                    </button>\n                  ))}\n                </div>\n\n                <Label htmlFor=\"feedback\" className=\"mb-2 block\">{txtCommentOptional}</Label>\n                <Textarea\n                  id=\"feedback\"\n                  value={feedback}\n                  onChange={(e) => setFeedback(e.target.value)}\n                  placeholder={txtTellExperience}\n                  rows={3}\n                  className=\"mb-4\"\n                />\n\n                <Button\n                  className=\"w-full bg-gradient-to-r from-amber-500 to-orange-500 hover:from-amber-600 hover:to-orange-600\"\n                  onClick={() => submitFeedbackMutation.mutate()}\n                  disabled={rating === 0 || submitFeedbackMutation.isPending}\n                >\n                  {submitFeedbackMutation.isPending ? txtSending : txtSubmitRating}\n                </Button>\n              </div>\n            )}\n\n            {/* Show rating if already submitted */}\n            {appointment.rating && !showFeedback && (\n              <div className=\"p-4 bg-slate-50 rounded-xl\">\n                <div className=\"flex items-center gap-2 mb-2\">\n                  <span className=\"text-sm text-slate-600\">{txtYourRating}</span>\n                  <div className=\"flex gap-1\">\n                    {[1, 2, 3, 4, 5].map(star => (\n                      <Star \n                        key={star} \n                        className={`w-4 h-4 ${appointment.rating >= star ? 'text-amber-500 fill-amber-500' : 'text-slate-300'}`}\n                      />\n                    ))}\n                  </div>\n                </div>\n                {appointment.feedback && (\n                  <p className=\"text-sm text-slate-700 italic\">&quot;{appointment.feedback}&quot;</p>\n                )}\n              </div>\n            )}\n          </CardContent>\n        </Card>\n      </div>\n    </div>\n  );\n}","path":null,"size_bytes":14935,"size_tokens":null},"src/components/ui/resizable.jsx":{"content":"\"use client\"\n\nimport { GripVertical } from \"lucide-react\"\nimport * as ResizablePrimitive from \"react-resizable-panels\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst ResizablePanelGroup = ({\n  className,\n  ...props\n}) => (\n  <ResizablePrimitive.PanelGroup\n    className={cn(\n      \"flex h-full w-full data-[panel-group-direction=vertical]:flex-col\",\n      className\n    )}\n    {...props} />\n)\n\nconst ResizablePanel = ResizablePrimitive.Panel\n\nconst ResizableHandle = ({\n  withHandle,\n  className,\n  ...props\n}) => (\n  <ResizablePrimitive.PanelResizeHandle\n    className={cn(\n      \"relative flex w-px items-center justify-center bg-border after:absolute after:inset-y-0 after:left-1/2 after:w-1 after:-translate-x-1/2 focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring focus-visible:ring-offset-1 data-[panel-group-direction=vertical]:h-px data-[panel-group-direction=vertical]:w-full data-[panel-group-direction=vertical]:after:left-0 data-[panel-group-direction=vertical]:after:h-1 data-[panel-group-direction=vertical]:after:w-full data-[panel-group-direction=vertical]:after:-translate-y-1/2 data-[panel-group-direction=vertical]:after:translate-x-0 [&[data-panel-group-direction=vertical]>div]:rotate-90\",\n      className\n    )}\n    {...props}>\n    {withHandle && (\n      <div\n        className=\"z-10 flex h-4 w-3 items-center justify-center rounded-sm border bg-border\">\n        <GripVertical className=\"h-2.5 w-2.5\" />\n      </div>\n    )}\n  </ResizablePrimitive.PanelResizeHandle>\n)\n\nexport { ResizablePanelGroup, ResizablePanel, ResizableHandle }\n","path":null,"size_bytes":1570,"size_tokens":null},"src/components/ui/menubar.jsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as MenubarPrimitive from \"@radix-ui/react-menubar\"\nimport { Check, ChevronRight, Circle } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nfunction MenubarMenu({\n  ...props\n}) {\n  return <MenubarPrimitive.Menu {...props} />;\n}\n\nfunction MenubarGroup({\n  ...props\n}) {\n  return <MenubarPrimitive.Group {...props} />;\n}\n\nfunction MenubarPortal({\n  ...props\n}) {\n  return <MenubarPrimitive.Portal {...props} />;\n}\n\nfunction MenubarRadioGroup({\n  ...props\n}) {\n  return <MenubarPrimitive.RadioGroup {...props} />;\n}\n\nfunction MenubarSub({\n  ...props\n}) {\n  return <MenubarPrimitive.Sub data-slot=\"menubar-sub\" {...props} />;\n}\n\nconst Menubar = React.forwardRef(({ className, ...props }, ref) => (\n  <MenubarPrimitive.Root\n    ref={ref}\n    className={cn(\n      \"flex h-9 items-center space-x-1 rounded-md border bg-background p-1 shadow-sm\",\n      className\n    )}\n    {...props} />\n))\nMenubar.displayName = MenubarPrimitive.Root.displayName\n\nconst MenubarTrigger = React.forwardRef(({ className, ...props }, ref) => (\n  <MenubarPrimitive.Trigger\n    ref={ref}\n    className={cn(\n      \"flex cursor-default select-none items-center rounded-sm px-3 py-1 text-sm font-medium outline-none focus:bg-accent focus:text-accent-foreground data-[state=open]:bg-accent data-[state=open]:text-accent-foreground\",\n      className\n    )}\n    {...props} />\n))\nMenubarTrigger.displayName = MenubarPrimitive.Trigger.displayName\n\nconst MenubarSubTrigger = React.forwardRef(({ className, inset, children, ...props }, ref) => (\n  <MenubarPrimitive.SubTrigger\n    ref={ref}\n    className={cn(\n      \"flex cursor-default select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[state=open]:bg-accent data-[state=open]:text-accent-foreground\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}>\n    {children}\n    <ChevronRight className=\"ml-auto h-4 w-4\" />\n  </MenubarPrimitive.SubTrigger>\n))\nMenubarSubTrigger.displayName = MenubarPrimitive.SubTrigger.displayName\n\nconst MenubarSubContent = React.forwardRef(({ className, ...props }, ref) => (\n  <MenubarPrimitive.SubContent\n    ref={ref}\n    className={cn(\n      \"z-50 min-w-[8rem] overflow-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-lg data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2\",\n      className\n    )}\n    {...props} />\n))\nMenubarSubContent.displayName = MenubarPrimitive.SubContent.displayName\n\nconst MenubarContent = React.forwardRef((\n  { className, align = \"start\", alignOffset = -4, sideOffset = 8, ...props },\n  ref\n) => (\n  <MenubarPrimitive.Portal>\n    <MenubarPrimitive.Content\n      ref={ref}\n      align={align}\n      alignOffset={alignOffset}\n      sideOffset={sideOffset}\n      className={cn(\n        \"z-50 min-w-[12rem] overflow-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-md data-[state=open]:animate-in data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2\",\n        className\n      )}\n      {...props} />\n  </MenubarPrimitive.Portal>\n))\nMenubarContent.displayName = MenubarPrimitive.Content.displayName\n\nconst MenubarItem = React.forwardRef(({ className, inset, ...props }, ref) => (\n  <MenubarPrimitive.Item\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props} />\n))\nMenubarItem.displayName = MenubarPrimitive.Item.displayName\n\nconst MenubarCheckboxItem = React.forwardRef(({ className, children, checked, ...props }, ref) => (\n  <MenubarPrimitive.CheckboxItem\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      className\n    )}\n    checked={checked}\n    {...props}>\n    <span className=\"absolute left-2 flex h-3.5 w-3.5 items-center justify-center\">\n      <MenubarPrimitive.ItemIndicator>\n        <Check className=\"h-4 w-4\" />\n      </MenubarPrimitive.ItemIndicator>\n    </span>\n    {children}\n  </MenubarPrimitive.CheckboxItem>\n))\nMenubarCheckboxItem.displayName = MenubarPrimitive.CheckboxItem.displayName\n\nconst MenubarRadioItem = React.forwardRef(({ className, children, ...props }, ref) => (\n  <MenubarPrimitive.RadioItem\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      className\n    )}\n    {...props}>\n    <span className=\"absolute left-2 flex h-3.5 w-3.5 items-center justify-center\">\n      <MenubarPrimitive.ItemIndicator>\n        <Circle className=\"h-4 w-4 fill-current\" />\n      </MenubarPrimitive.ItemIndicator>\n    </span>\n    {children}\n  </MenubarPrimitive.RadioItem>\n))\nMenubarRadioItem.displayName = MenubarPrimitive.RadioItem.displayName\n\nconst MenubarLabel = React.forwardRef(({ className, inset, ...props }, ref) => (\n  <MenubarPrimitive.Label\n    ref={ref}\n    className={cn(\"px-2 py-1.5 text-sm font-semibold\", inset && \"pl-8\", className)}\n    {...props} />\n))\nMenubarLabel.displayName = MenubarPrimitive.Label.displayName\n\nconst MenubarSeparator = React.forwardRef(({ className, ...props }, ref) => (\n  <MenubarPrimitive.Separator\n    ref={ref}\n    className={cn(\"-mx-1 my-1 h-px bg-muted\", className)}\n    {...props} />\n))\nMenubarSeparator.displayName = MenubarPrimitive.Separator.displayName\n\nconst MenubarShortcut = ({\n  className,\n  ...props\n}) => {\n  return (\n    (<span\n      className={cn(\"ml-auto text-xs tracking-widest text-muted-foreground\", className)}\n      {...props} />)\n  );\n}\nMenubarShortcut.displayname = \"MenubarShortcut\"\n\nexport {\n  Menubar,\n  MenubarMenu,\n  MenubarTrigger,\n  MenubarContent,\n  MenubarItem,\n  MenubarSeparator,\n  MenubarLabel,\n  MenubarCheckboxItem,\n  MenubarRadioGroup,\n  MenubarRadioItem,\n  MenubarPortal,\n  MenubarSubContent,\n  MenubarSubTrigger,\n  MenubarGroup,\n  MenubarSub,\n  MenubarShortcut,\n}\n","path":null,"size_bytes":6790,"size_tokens":null},"src/pages/BusinessDashboard.jsx":{"content":"import React, { useState, useEffect } from \"react\";\nimport { base44 } from \"@/api/base44Client\";\nimport { useQuery } from \"@tanstack/react-query\";\nimport { Card, CardContent } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Tabs, TabsList, TabsTrigger, TabsContent } from \"@/components/ui/tabs\";\nimport { Link, useNavigate } from \"react-router-dom\";\nimport { createPageUrl } from \"@/utils\";\nimport { Capacitor } from \"@capacitor/core\";\nimport { \n  LayoutDashboard,\n  Clock,\n  Users,\n  Settings,\n  BarChart3,\n  CheckCircle2,\n  Crown,\n  CreditCard,\n  MessageSquare,\n  ChevronRight,\n  Ticket,\n  Calendar,\n  Globe\n} from \"lucide-react\";\nimport { Skeleton } from \"@/components/ui/skeleton\";\nimport QueueManager from \"../components/business/QueueManager\";\nimport Statistics from \"../components/business/Statistics\";\nimport AppointmentManager from \"../components/business/AppointmentManager\";\nimport AppointmentReminders from \"../components/business/AppointmentReminders\";\nimport FeedbackManager from \"../components/business/FeedbackManager\";\nimport { PaymentPendingBanner } from \"../components/business/PaymentPendingBanner\";\nimport { BusinessFeatureGuard } from \"../components/business/BusinessFeatureGuard\";\nimport { useBusinessAccess } from \"../hooks/useBusinessAccess\";\nimport { ExpiredBanner } from \"../components/business/ExpiredBanner\";\nimport { TranslatedText } from \"@/components/translation/TranslatedText\";\nimport { useAutoTranslate } from \"@/hooks/useTranslate\";\n\n// 🌐 URL externa para compra B2B (Apple/Google compliance)\nconst EXTERNAL_SUBSCRIPTION_URL = 'https://waitless-qzero.com';\n\nexport default function BusinessDashboardPage() {\n  const navigate = useNavigate();\n  const [user, setUser] = useState(null);\n  const { hasAccess, companyProfile, isLoading: loadingAccess, isExpired } = useBusinessAccess();\n  \n  // 🍎🤖 B2B COMPLIANCE: Detectar app nativa (iOS/Android)\n  const isNativeApp = Capacitor.isNativePlatform();\n  \n  // Traduções dinâmicas via Google Translate\n  const txtDashboard = useAutoTranslate('Painel Empresa', 'pt');\n  const txtYourCompany = useAutoTranslate('Sua Empresa', 'pt');\n  const txtTrialActive = useAutoTranslate('Período de Teste Ativo', 'pt');\n  const txtFreeTrialUntil = useAutoTranslate('Teste grátis até', 'pt');\n  const txtSubscription = useAutoTranslate('Subscrição', 'pt');\n  const txtActivatePro = useAutoTranslate('Ativar Pro', 'pt');\n  const txtConfig = useAutoTranslate('Config', 'pt');\n  const txtQueues = useAutoTranslate('Senhas', 'pt');\n  const txtPeople = useAutoTranslate('Pessoas', 'pt');\n  const txtIssued = useAutoTranslate('Emitidas', 'pt');\n  const txtCompleted = useAutoTranslate('Concluídas', 'pt');\n  const txtActive = useAutoTranslate('Ativas', 'pt');\n  const txtToday = useAutoTranslate('Hoje', 'pt');\n  const txtNoQueues = useAutoTranslate('Nenhuma senha configurada', 'pt');\n  const txtAppointments = useAutoTranslate('Marcações', 'pt');\n  const txtBusinessPanel = useAutoTranslate('o painel empresarial', 'pt');\n  const txtSubscriptionRequired = useAutoTranslate('Subscrição Necessária', 'pt');\n  const txtActivateProQueues = useAutoTranslate('Ative a subscrição Pro para gerir senhas', 'pt');\n  const txtActivateProAppointments = useAutoTranslate('Ative a subscrição Pro para gerir marcações', 'pt');\n  const txtViewPlans = useAutoTranslate('Ver Planos', 'pt');\n  const txtSubscriptionExpired = useAutoTranslate('Subscrição Expirada', 'pt');\n  const txtSubscriptionExpiredDesc = useAutoTranslate('A sua subscrição expirou. Renove para continuar a usar todas as funcionalidades.', 'pt');\n  const txtRenewNow = useAutoTranslate('Renovar Agora', 'pt');\n  const txtVisitWebsite = useAutoTranslate('Visite waitless-qzero.com', 'pt');\n  const txtManageOnWebsite = useAutoTranslate('Gestão disponível em waitless-qzero.com', 'pt');\n\n  useEffect(() => {\n    base44.auth.me().then(userData => {\n      setUser(userData);\n      console.log('User loaded:', {\n        email: userData.email,\n        is_business_user: userData.is_business_user,\n        has_business_subscription: userData.has_business_subscription,\n        business_id: userData.business_id\n      });\n      \n      if (!userData.is_business_user || !userData.business_id) {\n        navigate(createPageUrl(\"Home\"));\n      }\n    }).catch(() => {\n      base44.auth.redirectToLogin();\n    });\n  }, [navigate]);\n\n  const { data: subscription, isLoading: loadingSubscription } = useQuery({\n    queryKey: ['business-subscription', user?.email],\n    queryFn: async () => {\n      if (!user) return null;\n      const subs = await base44.entities.Subscription.filter({\n        user_email: user.email,\n        plan: \"business\"\n      });\n      const activeSub = subs.find(s => s.status === 'active' || s.status === 'trialing');\n      return activeSub || null;\n    },\n    enabled: !!user,\n    staleTime: 60000, // Cache por 60 segundos\n    refetchOnMount: false,\n    refetchOnWindowFocus: false\n  });\n\n  const { data: queues = [] } = useQuery({\n    queryKey: ['business-queues', user?.business_id],\n    queryFn: () => base44.entities.Queue.filter({ business_id: user.business_id }),\n    enabled: !!user?.business_id,\n    staleTime: 30000, // Cache por 30 segundos\n    refetchOnMount: false,\n    refetchOnWindowFocus: false\n  });\n\n  const { data: tickets = [] } = useQuery({\n    queryKey: ['business-tickets', user?.business_id],\n    queryFn: () => base44.entities.Ticket.filter({ business_id: user.business_id }, '-created_date'),\n    enabled: !!user?.business_id,\n    staleTime: 15000, // Cache por 15 segundos\n    refetchOnMount: false,\n    refetchOnWindowFocus: false\n  });\n\n  if (!user || loadingSubscription) {\n    return (\n      <div className=\"bg-gradient-to-br from-slate-50 via-blue-50 to-sky-50 p-2 sm:p-4 lg:p-6\">\n        <div className=\"max-w-full mx-auto px-1.5\">\n          <Skeleton className=\"h-10 w-40 mb-3\" />\n          <div className=\"grid grid-cols-2 gap-2 mb-3\">\n            {[1, 2, 3, 4].map(i => <Skeleton key={i} className=\"h-20\" />)}\n          </div>\n        </div>\n      </div>\n    );\n  }\n\n  // Verificar subscrição: user tem flag OU existe subscription ativa\n  // ✅ Subscrição ATIVA se status é active ou trialing\n  const hasActiveSubscription = companyProfile?.subscriptionStatus === 'active' || companyProfile?.subscriptionStatus === 'trialing';\n  const hasSubscription = user.has_business_subscription || !!subscription;\n  const isTrialing = subscription?.status === 'trialing';\n\n  const activeQueues = queues.filter(q => q.is_active && q.status === \"aberta\");\n  const todayTickets = tickets.filter(t => {\n    const created = new Date(t.created_date);\n    const today = new Date();\n    return created.toDateString() === today.toDateString();\n  });\n  const activeTickets = tickets.filter(t => ['aguardando', 'chamado', 'atendendo'].includes(t.status));\n  const todayCompleted = todayTickets.filter(t => t.status === \"concluido\");\n\n  return (\n    <BusinessFeatureGuard \n      companyProfile={companyProfile}\n      hasAccess={hasAccess}\n      isExpired={isExpired}\n      feature={txtBusinessPanel}\n      isLoading={loadingAccess}\n    >\n      <div className=\"bg-gradient-to-br from-slate-50 via-blue-50 to-sky-50 w-full overflow-x-hidden\">\n        {user?.business_id && <AppointmentReminders businessId={user.business_id} />}\n        \n        <div className=\"w-full max-w-full px-2 sm:px-3 lg:px-8 py-2 sm:py-3 lg:py-6\">\n          <div className=\"mb-2 sm:mb-3 lg:mb-6 animate-slide-in-down\">\n            <h1 className=\"text-base sm:text-lg lg:text-2xl xl:text-3xl font-bold text-slate-900 mb-0.5 lg:mb-1\">\n              {txtDashboard}\n            </h1>\n            <p className=\"text-xs lg:text-base text-slate-500 truncate\">\n              {companyProfile?.name || txtYourCompany}\n            </p>\n          </div>\n\n        {/* 🚫 BANNER DE SUBSCRIÇÃO EXPIRADA */}\n        {isExpired && (\n          <Card className=\"border-0 shadow-lg bg-gradient-to-r from-red-50 to-orange-50 border-l-4 border-red-500 mb-3 animate-slide-in-left\">\n            <CardContent className=\"p-4\">\n              <div className=\"flex items-center justify-between gap-3\">\n                <div className=\"flex items-center gap-3\">\n                  <div className=\"w-10 h-10 rounded-full bg-red-100 flex items-center justify-center\">\n                    <CreditCard className=\"w-5 h-5 text-red-600\" />\n                  </div>\n                  <div>\n                    <h3 className=\"font-bold text-red-900\">{txtSubscriptionExpired}</h3>\n                    <p className=\"text-sm text-red-700\">{txtSubscriptionExpiredDesc}</p>\n                  </div>\n                </div>\n                {/* 🍎🤖 B2B COMPLIANCE: Apps nativas redirecionam para website externo */}\n                {isNativeApp ? (\n                  <Button \n                    className=\"bg-red-600 hover:bg-red-700 text-white whitespace-nowrap\"\n                    onClick={() => window.open(EXTERNAL_SUBSCRIPTION_URL, '_system')}\n                  >\n                    <Globe className=\"w-4 h-4 mr-2\" />\n                    {txtVisitWebsite}\n                  </Button>\n                ) : (\n                  <Button \n                    className=\"bg-red-600 hover:bg-red-700 text-white whitespace-nowrap\"\n                    onClick={() => navigate(createPageUrl(\"BusinessSubscription\"), { state: { isReactivation: true, existingProfileId: companyProfile?.id } })}\n                  >\n                    {txtRenewNow}\n                  </Button>\n                )}\n              </div>\n            </CardContent>\n          </Card>\n        )}\n\n        {isTrialing && subscription?.trial_end_date && (\n          <Card className=\"border-0 shadow-sm bg-gradient-to-r from-amber-50 to-orange-50 border-l-4 border-amber-500 mb-2 animate-slide-in-left\">\n            <CardContent className=\"p-2\">\n              <div className=\"flex items-center gap-2\">\n                <Crown className=\"w-4 h-4 text-amber-600 flex-shrink-0 animate-pulse-slow\" />\n                <div className=\"flex-1 min-w-0\">\n                  <p className=\"text-xs text-slate-700\">\n                    <span className=\"font-medium\">{txtTrialActive}</span> · {txtFreeTrialUntil} {new Date(subscription.trial_end_date).toLocaleDateString('pt-PT')}\n                  </p>\n                </div>\n              </div>\n            </CardContent>\n          </Card>\n        )}\n        \n        <div className=\"flex gap-1.5 sm:gap-2 lg:gap-3 mb-2 sm:mb-3 lg:mb-4 overflow-x-auto pb-1 hide-scrollbar animate-slide-in-right\">\n          {/* 🍎🤖 B2B COMPLIANCE: Botões de subscrição escondidos em apps nativas */}\n          {!isNativeApp && (\n            hasActiveSubscription ? (\n              <Link to={createPageUrl(\"BusinessManageSubscription\")}>\n                <Button size=\"sm\" variant=\"outline\" className=\"gap-1 lg:gap-2 text-xs lg:text-sm h-7 lg:h-10 whitespace-nowrap px-2 lg:px-4 smooth-transition hover-lift\">\n                  <CreditCard className=\"w-3 h-3 lg:w-4 lg:h-4\" />\n                  {txtSubscription}\n                </Button>\n              </Link>\n            ) : (\n              <Button \n                size=\"sm\" \n                className=\"gap-1 lg:gap-2 bg-gradient-to-r from-amber-500 to-orange-600 hover:from-amber-600 hover:to-orange-700 text-xs lg:text-sm h-7 lg:h-10 whitespace-nowrap px-2 lg:px-4 smooth-transition hover-lift\"\n                onClick={() => navigate(createPageUrl(\"BusinessSubscription\"), { state: { isReactivation: true, existingProfileId: companyProfile?.id } })}\n              >\n                <Crown className=\"w-3 h-3 lg:w-4 lg:h-4\" />\n                {txtActivatePro}\n              </Button>\n            )\n          )}\n          <Link to={createPageUrl(\"BusinessSettings\")}>\n            <Button size=\"sm\" variant=\"outline\" className=\"gap-1 lg:gap-2 text-xs lg:text-sm h-7 lg:h-10 whitespace-nowrap px-2 lg:px-4 smooth-transition hover-lift\">\n              <Settings className=\"w-3 h-3 lg:w-4 lg:h-4\" />\n              {txtConfig}\n            </Button>\n          </Link>\n        </div>\n\n        <div className=\"grid grid-cols-2 lg:grid-cols-4 gap-2 lg:gap-4 mb-3 lg:mb-6 w-full max-w-full\">\n          {[\n            { icon: LayoutDashboard, value: hasAccess ? activeQueues.length : '—', label: txtQueues, color: 'from-green-500 to-emerald-500' },\n            { icon: Users, value: hasAccess ? activeTickets.length : '—', label: txtPeople, color: 'from-blue-500 to-cyan-500' },\n            { icon: Clock, value: hasAccess ? todayTickets.length : '—', label: txtIssued, color: 'from-purple-500 to-pink-500' },\n            { icon: CheckCircle2, value: hasAccess ? todayCompleted.length : '—', label: txtCompleted, color: 'from-amber-500 to-orange-500' }\n          ].map((stat, idx) => (\n            <Card key={idx} className=\"border-0 shadow-sm lg:shadow-md stagger-item\" style={{ animationDelay: `${idx * 0.05}s` }}>\n              <CardContent className=\"p-3 lg:p-4\">\n                <div className={`w-7 h-7 lg:w-10 lg:h-10 rounded-lg bg-gradient-to-br ${stat.color} flex items-center justify-center mb-1.5 lg:mb-2`}>\n                  <stat.icon className=\"w-4 h-4 lg:w-5 lg:h-5 text-white\" />\n                </div>\n                <div className=\"text-lg lg:text-2xl xl:text-3xl font-bold text-slate-900 leading-tight\">\n                  {stat.value}\n                </div>\n                <p className=\"text-slate-500 text-xs lg:text-sm truncate\">{stat.label}</p>\n              </CardContent>\n            </Card>\n          ))}\n        </div>\n\n        <Tabs defaultValue=\"senhas\" className=\"w-full\">\n          <TabsList className=\"w-full grid grid-cols-2 mb-2 lg:mb-4 h-auto p-0.5 lg:p-1 bg-white/80 backdrop-blur-sm shadow-sm rounded-lg lg:rounded-xl\">\n            <TabsTrigger \n              value=\"senhas\" \n              className=\"flex items-center gap-1 lg:gap-2 text-xs lg:text-base py-1.5 lg:py-3 rounded-md lg:rounded-lg data-[state=active]:bg-gradient-to-r data-[state=active]:from-green-500 data-[state=active]:to-emerald-500 data-[state=active]:text-white\"\n            >\n              <Ticket className=\"w-3 h-3 lg:w-5 lg:h-5\" />\n              {txtQueues}\n            </TabsTrigger>\n            <TabsTrigger \n              value=\"marcacoes\" \n              className=\"flex items-center gap-1 lg:gap-2 text-xs lg:text-base py-1.5 lg:py-3 rounded-md lg:rounded-lg data-[state=active]:bg-gradient-to-r data-[state=active]:from-blue-500 data-[state=active]:to-cyan-500 data-[state=active]:text-white\"\n            >\n              <Calendar className=\"w-3 h-3 lg:w-5 lg:h-5\" />\n              {txtAppointments}\n            </TabsTrigger>\n          </TabsList>\n\n          <TabsContent value=\"senhas\" className=\"mt-0 w-full\">\n            {hasAccess ? (\n              queues.length === 0 ? (\n                <Card className=\"border-0 shadow-sm\">\n                  <CardContent className=\"p-4 text-center\">\n                    <Ticket className=\"w-10 h-10 text-slate-300 mx-auto mb-1.5\" />\n                    <p className=\"text-xs text-slate-600\">{txtNoQueues}</p>\n                  </CardContent>\n                </Card>\n              ) : (\n                <div className=\"space-y-1.5 w-full\">\n                  {queues.map(queue => (\n                    <QueueManager \n                      key={queue.id} \n                      queue={queue} \n                      tickets={tickets.filter(t => t.queue_id === queue.id)}\n                      hasAccess={hasAccess}\n                    />\n                  ))}\n                </div>\n              )\n            ) : (\n              <Card className=\"border-0 shadow-sm\">\n                <CardContent className=\"p-4 text-center\">\n                  <Crown className=\"w-10 h-10 text-amber-600 mx-auto mb-1.5 animate-pulse-slow\" />\n                  <h3 className=\"font-semibold text-xs text-slate-900 mb-0.5\">{txtSubscriptionRequired}</h3>\n                  <p className=\"text-[10px] text-slate-600 mb-2\">{txtActivateProQueues}</p>\n                  <Link to={createPageUrl(\"BusinessSubscription\")}>\n                    <Button size=\"sm\" className=\"bg-gradient-to-r from-amber-500 to-orange-600 text-xs h-7 hover-lift\">\n                      {txtViewPlans}\n                    </Button>\n                  </Link>\n                </CardContent>\n              </Card>\n            )}\n          </TabsContent>\n\n          <TabsContent value=\"marcacoes\" className=\"mt-0 w-full\">\n            {hasAccess ? (\n              <AppointmentManager businessId={user.business_id} hasAccess={hasAccess} companyProfile={companyProfile} />\n            ) : (\n              <Card className=\"border-0 shadow-sm\">\n                <CardContent className=\"p-4 text-center\">\n                  <Crown className=\"w-10 h-10 text-amber-600 mx-auto mb-1.5 animate-pulse-slow\" />\n                  <h3 className=\"font-semibold text-xs text-slate-900 mb-0.5\">{txtSubscriptionRequired}</h3>\n                  <p className=\"text-[10px] text-slate-600 mb-2\">{txtActivateProAppointments}</p>\n                  <Link to={createPageUrl(\"BusinessSubscription\")}>\n                    <Button size=\"sm\" className=\"bg-gradient-to-r from-amber-500 to-orange-600 text-xs h-7 hover-lift\">\n                      {txtViewPlans}\n                    </Button>\n                  </Link>\n                </CardContent>\n              </Card>\n            )}\n          </TabsContent>\n        </Tabs>\n      </div>\n      <style>{`\n        .hide-scrollbar::-webkit-scrollbar {\n          display: none;\n        }\n        .hide-scrollbar {\n          -ms-overflow-style: none;\n          scrollbar-width: none;\n        }\n      `}</style>\n    </div>\n    </BusinessFeatureGuard>\n  );\n}","path":null,"size_bytes":17715,"size_tokens":null},"src/components/business/QueueManager.jsx":{"content":"import React, { useState, useEffect } from \"react\";\nimport { base44 } from \"@/api/base44Client\";\nimport { useMutation, useQueryClient, useQuery } from \"@tanstack/react-query\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Input } from \"@/components/ui/input\";\nimport { Label } from \"@/components/ui/label\";\nimport { Tabs, TabsList, TabsTrigger, TabsContent } from \"@/components/ui/tabs\";\nimport { \n  PlayCircle, \n  PauseCircle, \n  StopCircle,\n  PhoneCall,\n  CheckCircle2,\n  Users,\n  Clock,\n  Settings,\n  TrendingUp,\n  UserPlus,\n  Copy,\n  ExternalLink\n} from \"lucide-react\";\nimport { QRCodeSVG } from \"qrcode.react\";\nimport TicketPanel from \"./TicketPanel\";\nimport NotificationSettings from \"./NotificationSettings\";\nimport { toast } from \"sonner\";\nimport { createPageUrl } from \"@/utils\";\nimport { validateQueueOperating } from \"@/utils/queueValidation\";\nimport { checkAndResetQueueForNewDay } from \"@/utils/queueReset\";\nimport { sendEmail } from \"@/services/emailService\";\nimport { sendSMS } from \"@/api/functions\"; // CORREÇÃO: Importar sendSMS\nimport TicketHistory from \"./TicketHistory\";\nimport { useAutoTranslate } from \"@/hooks/useTranslate\";\n\nexport default function QueueManager({ queue, tickets }) {\n  const queryClient = useQueryClient();\n  const [showSettings, setShowSettings] = useState(false);\n  const [avgTime, setAvgTime] = useState(queue.average_service_time);\n  const [toleranceTime, setToleranceTime] = useState(queue.tolerance_time || 15);\n  const [showManualTicket, setShowManualTicket] = useState(false);\n  const [manualEmail, setManualEmail] = useState(\"\");\n  const [manualName, setManualName] = useState(\"\");\n  const [createdTicketId, setCreatedTicketId] = useState(null);\n  \n  // Traduções\n  const txtQueuePaused = useAutoTranslate('Senha pausada com sucesso', 'pt');\n  const txtQueueResumed = useAutoTranslate('Senha retomada com sucesso', 'pt');\n  const txtSettingsUpdated = useAutoTranslate('Configurações atualizadas', 'pt');\n  const txtErrorUpdatingQueue = useAutoTranslate('Erro ao atualizar senha', 'pt');\n  const txtEmailRequired = useAutoTranslate('Email é obrigatório para criar senha manual', 'pt');\n  const txtInPersonCustomer = useAutoTranslate('Cliente Presencial', 'pt');\n  const txtTicketDeleted = useAutoTranslate('Senha eliminada com sucesso', 'pt');\n  const txtErrorDeletingTicket = useAutoTranslate('Erro ao eliminar senha', 'pt');\n  const txtLinkCopied = useAutoTranslate('Link copiado!', 'pt');\n  const txtOpen = useAutoTranslate('Aberta', 'pt');\n  const txtPaused = useAutoTranslate('Pausada', 'pt');\n  const txtClosed = useAutoTranslate('Fechada', 'pt');\n  const txtAverageTime = useAutoTranslate('Tempo Médio (min)', 'pt');\n  const txtTolerance = useAutoTranslate('Tolerância (min)', 'pt');\n  const txtSave = useAutoTranslate('Guardar', 'pt');\n  const txtManagement = useAutoTranslate('Gestão', 'pt');\n  const txtHistory = useAutoTranslate('Histórico', 'pt');\n  const txtWaiting = useAutoTranslate('Aguardando', 'pt');\n  const txtAttending = useAutoTranslate('Atendendo', 'pt');\n  const txtCurrent = useAutoTranslate('Atual', 'pt');\n  const txtLast = useAutoTranslate('Última', 'pt');\n  const txtNoTickets = useAutoTranslate('Sem senhas', 'pt');\n  const txtCalling = useAutoTranslate('A chamar...', 'pt');\n  const txtCall = useAutoTranslate('Chamar', 'pt');\n  const txtManualTicket = useAutoTranslate('Senha Manual', 'pt');\n  const txtEmailRequired2 = useAutoTranslate('Email *', 'pt');\n  const txtNameOptional = useAutoTranslate('Nome (opcional)', 'pt');\n  const txtCreating = useAutoTranslate('Criando...', 'pt');\n  const txtCreate = useAutoTranslate('Criar', 'pt');\n  const txtTicketCreatedEmailSent = useAutoTranslate('criada! Email enviado com sucesso.', 'pt');\n  const txtTicketCreatedEmailError = useAutoTranslate('criada, mas houve erro ao enviar o email. Partilhe o link manualmente.', 'pt');\n  const txtTicketCreatedSuccess = useAutoTranslate('criada com sucesso!', 'pt');\n  const txtTicketCreatedQR = useAutoTranslate('Senha Criada! Mostre este QR Code ao cliente:', 'pt');\n  const txtClientCanScan = useAutoTranslate('O cliente pode escanear para acompanhar a senha', 'pt');\n  const txtCopyLinkAlt = useAutoTranslate('Copiar Link (alternativa)', 'pt');\n  const txtTickets = useAutoTranslate('Senhas', 'pt');\n\n  const activeTickets = tickets.filter(t => ['aguardando', 'chamado'].includes(t.status));\n  const attendingTickets = tickets.filter(t => t.status === 'atendendo');\n\n  useEffect(() => {\n    if (!queue || !tickets?.length) return;\n\n    const expireOldTickets = async () => {\n      const now = new Date();\n      const currentToleranceTime = queue.tolerance_time || 15;\n      const expirationTimeMs = currentToleranceTime * 60 * 1000;\n      \n      const oldTickets = tickets.filter(t => {\n        if (!t || t.status !== 'chamado' || !t.called_at) return false;\n        \n        const calledAt = new Date(t.called_at);\n        const ageMs = now - calledAt;\n        \n        return ageMs > expirationTimeMs;\n      });\n\n      for (const ticket of oldTickets) {\n        await base44.entities.Ticket.update(ticket.id, {\n          status: 'cancelado',\n          completed_at: new Date().toISOString()\n        });\n      }\n\n      if (oldTickets.length > 0) {\n        queryClient.invalidateQueries({ queryKey: ['business-tickets'] });\n        queryClient.invalidateQueries({ queryKey: ['business-ticket-history'] });\n      }\n    };\n\n    expireOldTickets();\n    const interval = setInterval(expireOldTickets, 2 * 60 * 1000);\n\n    return () => clearInterval(interval);\n  }, [tickets, queryClient, queue]);\n\n  useEffect(() => {\n    if (!queue || !tickets?.length) return;\n\n    const autoCompleteAttendingTickets = async () => {\n      const now = new Date();\n      const avgServiceTimeMs = (queue.average_service_time || 15) * 60 * 1000;\n      \n      const attendingTickets = tickets.filter(t => t && t.status === 'atendendo');\n      \n      const ticketsNeedingTimestamp = attendingTickets.filter(t => !t.attending_started_at);\n      for (const ticket of ticketsNeedingTimestamp) {\n        console.log(`⏰ Migrando senha #${ticket.ticket_number} - adicionando attending_started_at`);\n        await base44.entities.Ticket.update(ticket.id, {\n          attending_started_at: new Date().toISOString()\n        });\n      }\n      \n      const ticketsToComplete = attendingTickets.filter(t => {\n        if (!t.attending_started_at) return false;\n        \n        const attendingStartedAt = new Date(t.attending_started_at);\n        const attendingDuration = now - attendingStartedAt;\n        const shouldComplete = attendingDuration >= avgServiceTimeMs;\n        \n        if (shouldComplete) {\n          console.log(`✅ Auto-concluindo senha #${t.ticket_number} - em atendimento há ${Math.round(attendingDuration / 60000)} minutos`);\n        }\n        \n        return shouldComplete;\n      });\n\n      for (const ticket of ticketsToComplete) {\n        await base44.entities.Ticket.update(ticket.id, {\n          status: 'concluido',\n          completed_at: new Date().toISOString()\n        });\n      }\n\n      if (ticketsNeedingTimestamp.length > 0 || ticketsToComplete.length > 0) {\n        queryClient.invalidateQueries({ queryKey: ['business-tickets'] });\n        queryClient.invalidateQueries({ queryKey: ['business-ticket-history'] });\n      }\n    };\n\n    autoCompleteAttendingTickets();\n    const interval = setInterval(autoCompleteAttendingTickets, 30 * 1000);\n\n    return () => clearInterval(interval);\n  }, [tickets, queryClient, queue]);\n\n  useEffect(() => {\n    if (!queue?.notifications_enabled || !queue?.notification_settings || !activeTickets?.length) return;\n    \n    const advanceNotice = queue.notification_settings.advance_notice || 2;\n    const nextNumber = queue.current_number + 1;\n    \n    activeTickets.forEach(async (ticket) => {\n      if (!ticket || !ticket.ticket_number) return;\n      \n      const ticketsAhead = ticket.ticket_number - nextNumber;\n      \n      if (ticketsAhead === advanceNotice && ticket.status === 'aguardando') {\n        const message = `Quase sua vez! Faltam ${advanceNotice} senhas. Senha #${ticket.ticket_number} - ${queue.name}`;\n        \n        if (queue.notification_settings.email && ticket.user_email) {\n          try {\n            await base44.integrations.Core.SendEmail({\n              to: ticket.user_email,\n              subject: `Quase sua vez - ${queue.name}`,\n              body: message\n            });\n            console.log(`📧 Email enviado para ${ticket.user_email}: ${message}`);\n          } catch (error) {\n            console.error('Email error:', error);\n          }\n        }\n        \n        if (queue.notification_settings.sms && ticket.user_phone) {\n          await sendSMS(ticket.user_phone, message);\n          console.log(`📱 SMS enviado para ${ticket.user_phone}: ${message}`);\n        }\n        \n        // ✅ Push notifications são enviadas via Firebase (não via entity local)\n      }\n    });\n  }, [queue?.current_number, activeTickets, queue?.notifications_enabled, queue?.notification_settings]);\n\n  const updateQueueMutation = useMutation({\n    mutationFn: async (updates) => {\n      await base44.entities.Queue.update(queue.id, updates);\n    },\n    onSuccess: (_, variables) => {\n      queryClient.invalidateQueries({ queryKey: ['business-queues'] });\n      \n      // Feedback específico baseado na atualização\n      if (variables.status === 'pausada') {\n        toast.success(txtQueuePaused);\n      } else if (variables.status === 'aberta') {\n        toast.success(txtQueueResumed);\n      } else if (variables.average_service_time || variables.tolerance_time) {\n        toast.success(txtSettingsUpdated);\n      }\n    },\n    onError: (error) => {\n      console.error('Error updating queue:', error);\n      toast.error(txtErrorUpdatingQueue);\n    },\n  });\n\n  const updateTicketMutation = useMutation({\n    mutationFn: async ({ ticketId, updates }) => {\n      await base44.entities.Ticket.update(ticketId, updates);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['business-tickets'] });\n      queryClient.invalidateQueries({ queryKey: ['business-ticket-history'] });\n    },\n  });\n\n  const createManualTicketMutation = useMutation({\n    mutationFn: async () => {\n      if (!manualEmail || !manualEmail.includes('@')) {\n        toast.error(txtEmailRequired);\n        throw new Error('Email obrigatório');\n      }\n\n      const validation = validateQueueOperating(queue);\n      if (!validation.isOperating) {\n        toast.error(validation.reason);\n        throw new Error(validation.reason);\n      }\n      \n      // Resetar fila se for um novo dia\n      const updatedQueue = await checkAndResetQueueForNewDay(queue);\n      \n      // Atualizar cache do React Query para evitar resets múltiplos\n      queryClient.setQueryData(['business-queues'], (oldQueues) => \n        oldQueues?.map(q => q.id === updatedQueue.id ? updatedQueue : q) || oldQueues\n      );\n      \n      const nextNumber = updatedQueue.last_issued_number + 1;\n      const position = activeTickets.length + 1;\n      const estimatedTime = position * queue.average_service_time;\n\n      const ticket = await base44.entities.Ticket.create({\n        queue_id: queue.id,\n        business_id: queue.business_id,\n        user_email: manualEmail,\n        user_phone: null,\n        ticket_number: nextNumber,\n        status: 'aguardando',\n        estimated_time: estimatedTime,\n        position: position,\n        is_manual: true,\n        manual_name: manualName || txtInPersonCustomer\n      });\n\n      await base44.entities.Queue.update(updatedQueue.id, {\n        last_issued_number: nextNumber\n      });\n\n      const publicUrl = `${window.location.origin}${createPageUrl(`TicketPublic?id=${ticket.id}`)}`;\n      const attemptedEmail = !!(manualEmail && manualEmail.includes('@'));\n      let notificationSent = { email: false };\n\n      if (attemptedEmail) {\n        const emailBody = `Olá ${manualName || 'Cliente'}!\\n\\nA sua senha foi criada com sucesso.\\n\\nDetalhes:\\nSenha: #${ticket.ticket_number}\\nFila: ${queue.name}\\nPosição: ${position}\\nTempo Estimado: ~${estimatedTime} minutos\\n\\nAcompanhe sua senha em tempo real:\\n${publicUrl}\\n\\nMantenha esta página aberta para receber atualizações.\\n\\nObrigado!`;\n\n        console.log('📧 Tentando enviar email via Resend para:', manualEmail);\n        const emailResult = await sendEmail({\n          to: manualEmail,\n          subject: `Senha #${ticket.ticket_number} - ${queue.name}`,\n          body: emailBody\n        });\n        \n        notificationSent.email = emailResult.success;\n        if (emailResult.success) {\n          console.log('✅ Email enviado com sucesso via Resend');\n        } else {\n          console.error('❌ Erro ao enviar email:', emailResult.error);\n        }\n      }\n\n      return { ticket, notificationSent, attemptedEmail };\n    },\n    onSuccess: (data) => {\n      const { ticket, notificationSent, attemptedEmail } = data;\n      queryClient.invalidateQueries({ queryKey: ['business-tickets'] });\n      queryClient.invalidateQueries({ queryKey: ['business-queues'] });\n      setManualEmail(\"\");\n      setManualName(\"\");\n      setCreatedTicketId(ticket.id);\n      \n      if (attemptedEmail && notificationSent.email) {\n        toast.success(`Senha #${ticket.ticket_number} ${txtTicketCreatedEmailSent}`);\n      } else if (attemptedEmail && !notificationSent.email) {\n        toast.warning(`Senha #${ticket.ticket_number} ${txtTicketCreatedEmailError}`);\n      } else {\n        toast.success(`Senha #${ticket.ticket_number} ${txtTicketCreatedSuccess}`);\n      }\n    },\n  });\n\n  const deleteTicketMutation = useMutation({\n    mutationFn: async (ticketId) => {\n      await base44.entities.Ticket.delete(ticketId);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['business-tickets'] });\n      toast.success(txtTicketDeleted);\n    },\n    onError: () => {\n      toast.error(txtErrorDeletingTicket);\n    },\n  });\n\n  const callNextMutation = useMutation({\n    mutationFn: async () => {\n      const nextNumber = queue.current_number + 1;\n      \n      const skippedTickets = tickets.filter(t => \n        t && t.ticket_number < nextNumber && \n        ['aguardando', 'chamado'].includes(t.status)\n      );\n\n      for (const ticket of skippedTickets) {\n        await base44.entities.Ticket.update(ticket.id, {\n          status: 'cancelado',\n          completed_at: new Date().toISOString()\n        });\n      }\n      \n      const nextTicket = tickets.find(t => \n        t && t.ticket_number === nextNumber && \n        t.status === 'aguardando'\n      );\n\n      if (nextTicket) {\n        await base44.entities.Ticket.update(nextTicket.id, {\n          status: 'chamado',\n          called_at: new Date().toISOString()\n        });\n\n        const message = `É sua vez! Senha #${nextNumber} chamada. Dirija-se ao ${queue.name}.`;\n\n        if (queue.notifications_enabled) {\n          if (queue.notification_settings?.email && nextTicket.user_email) {\n            try {\n              await base44.integrations.Core.SendEmail({\n                to: nextTicket.user_email,\n                subject: 'É a sua vez!',\n                body: `Senha #${nextNumber} foi chamada! Dirija-se ao atendimento em ${queue.name}.`\n              });\n              console.log(`📧 Email \"É a sua vez!\" enviado para ${nextTicket.user_email}`);\n            } catch (error) {\n              console.error('Email error:', error);\n            }\n          }\n          \n          if (queue.notification_settings?.sms && nextTicket.user_phone) {\n            await sendSMS(nextTicket.user_phone, message);\n            console.log(`📱 SMS \"É a sua vez!\" enviado para ${nextTicket.user_phone}`);\n          }\n        }\n\n        // 📱 PUSH NOTIFICATION: \"A sua senha foi chamada!\" (com tempo de tolerância)\n        if (nextTicket.user_email) {\n          try {\n            await fetch('/api/push-notifications/ticket-called', {\n              method: 'POST',\n              headers: { 'Content-Type': 'application/json' },\n              credentials: 'include',\n              body: JSON.stringify({\n                userEmail: nextTicket.user_email,\n                queueName: queue.name,\n                ticketNumber: nextNumber,\n                businessName: queue.company_name || '',\n                toleranceMinutes: queue.tolerance_time || 15\n              })\n            });\n            console.log(`📱 Push \"A sua senha foi chamada!\" enviado para ${nextTicket.user_email} (tolerância: ${queue.tolerance_time || 15}min)`);\n          } catch (error) {\n            console.error('Push notification error:', error);\n          }\n        }\n      }\n\n      // 📱 PUSH NOTIFICATION: \"A sua vez está a chegar!\" - 2 senhas antes\n      const ticketTwoAhead = tickets.find(t => \n        t && t.ticket_number === (nextNumber + 2) && \n        t.status === 'aguardando'\n      );\n\n      if (ticketTwoAhead && ticketTwoAhead.user_email) {\n        try {\n          await fetch('/api/push-notifications/queue-alert', {\n            method: 'POST',\n            headers: { 'Content-Type': 'application/json' },\n            credentials: 'include',\n            body: JSON.stringify({\n              userEmail: ticketTwoAhead.user_email,\n              queueName: queue.name,\n              ticketNumber: ticketTwoAhead.ticket_number,\n              position: 2,\n              businessName: queue.company_name || ''\n            })\n          });\n          console.log(`📱 Push \"A sua vez está a chegar!\" enviado para ${ticketTwoAhead.user_email} (faltam 2 senhas)`);\n        } catch (error) {\n          console.error('Push notification error:', error);\n        }\n      }\n\n      await base44.entities.Queue.update(queue.id, {\n        current_number: nextNumber\n      });\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['business-tickets'] });\n      queryClient.invalidateQueries({ queryKey: ['business-queues'] });\n    },\n  });\n\n  const toggleQueueStatus = () => {\n    const newStatus = queue.status === \"aberta\" ? \"pausada\" : \"aberta\";\n    updateQueueMutation.mutate({ status: newStatus });\n  };\n\n  const updateSettings = () => {\n    updateQueueMutation.mutate({ \n      average_service_time: parseInt(avgTime),\n      tolerance_time: parseInt(toleranceTime)\n    });\n    setShowSettings(false);\n  };\n\n  const copyTicketLink = (ticketId) => {\n    const link = `${window.location.origin}${createPageUrl('TicketPublic')}?id=${ticketId}`;\n    navigator.clipboard.writeText(link);\n    toast.success(txtLinkCopied);\n  };\n\n  const statusConfig = {\n    aberta: { \n      color: \"bg-green-100 text-green-700 border-green-200\", \n      icon: PlayCircle,\n      label: txtOpen \n    },\n    pausada: { \n      color: \"bg-amber-100 text-amber-700 border-amber-200\", \n      icon: PauseCircle,\n      label: txtPaused \n    },\n    fechada: { \n      color: \"bg-red-100 text-red-700 border-red-200\", \n      icon: StopCircle,\n      label: txtClosed \n    }\n  };\n\n  const status = statusConfig[queue.status] || statusConfig.aberta;\n  const StatusIcon = status.icon;\n\n  return (\n    <Card className=\"border-0 shadow-sm w-full overflow-hidden\">\n      <CardHeader className=\"pb-1 border-b p-1.5\">\n        <div className=\"flex justify-between items-start gap-1 w-full\">\n          <div className=\"flex-1 min-w-0\">\n            <div className=\"flex items-center gap-1 mb-0.5 flex-wrap\">\n              <CardTitle className=\"text-xs truncate\">{queue.name}</CardTitle>\n              <Badge className={`${status.color} text-xs h-4 px-1 py-0 flex-shrink-0`}>\n                <StatusIcon className=\"w-2 h-2 mr-0.5\" />\n                {status.label}\n              </Badge>\n            </div>\n          </div>\n          \n          <div className=\"flex gap-0.5 flex-shrink-0\">\n            <Button\n              variant=\"outline\"\n              size=\"sm\"\n              onClick={() => setShowSettings(!showSettings)}\n              className=\"h-5 w-5 p-0\"\n            >\n              <Settings className=\"w-2.5 h-2.5\" />\n            </Button>\n            <Button\n              variant={queue.status === \"aberta\" ? \"outline\" : \"default\"}\n              size=\"sm\"\n              onClick={toggleQueueStatus}\n              disabled={updateQueueMutation.isPending}\n              className={`h-5 w-5 p-0 ${queue.status === \"aberta\" ? \"border-amber-300 text-amber-700\" : \"\"}`}\n            >\n              {queue.status === \"aberta\" ? (\n                <PauseCircle className=\"w-2.5 h-2.5\" />\n              ) : (\n                <PlayCircle className=\"w-2.5 h-2.5\" />\n              )}\n            </Button>\n          </div>\n        </div>\n      </CardHeader>\n\n      {showSettings && (\n        <div className=\"p-1.5 bg-slate-50 border-b space-y-1\">\n          <div>\n            <Label htmlFor=\"avgTime\" className=\"mb-0.5 block text-xs\">{txtAverageTime}</Label>\n            <Input\n              id=\"avgTime\"\n              type=\"number\"\n              min=\"1\"\n              value={avgTime}\n              onChange={(e) => setAvgTime(e.target.value)}\n              className=\"h-6 text-xs\"\n            />\n          </div>\n          <div>\n            <Label htmlFor=\"toleranceTime\" className=\"mb-0.5 block text-xs\">{txtTolerance}</Label>\n            <Input\n              id=\"toleranceTime\"\n              type=\"number\"\n              min=\"5\"\n              value={toleranceTime}\n              onChange={(e) => setToleranceTime(e.target.value)}\n              className=\"h-6 text-xs\"\n            />\n          </div>\n          <Button onClick={updateSettings} size=\"sm\" className=\"w-full h-6 text-xs\">\n            <CheckCircle2 className=\"w-3 h-3 mr-1\" />\n            {txtSave}\n          </Button>\n        </div>\n      )}\n\n      <CardContent className=\"p-0 w-full\">\n        <Tabs defaultValue=\"main\" className=\"w-full\">\n          <TabsList className=\"w-full justify-start rounded-none border-b px-1 h-6 bg-transparent\">\n            <TabsTrigger value=\"main\" className=\"text-xs px-1 h-5\">{txtManagement}</TabsTrigger>\n            <TabsTrigger value=\"history\" className=\"text-xs px-1 h-5\">{txtHistory}</TabsTrigger>\n          </TabsList>\n\n          <TabsContent value=\"main\" className=\"p-1.5 w-full\">\n            <div className=\"grid grid-cols-2 gap-1 mb-1.5\">\n              <div className=\"p-1 bg-gradient-to-br from-blue-50 to-sky-50 rounded\">\n                <div className=\"flex items-center gap-0.5 mb-0.5\">\n                  <Users className=\"w-2 h-2 text-blue-600\" />\n                  <div className=\"text-sm font-bold text-blue-600\">{activeTickets.length}</div>\n                </div>\n                <div className=\"text-xs text-slate-600 leading-none\">{txtWaiting}</div>\n              </div>\n\n              <div className=\"p-1 bg-gradient-to-br from-purple-50 to-pink-50 rounded\">\n                <div className=\"flex items-center gap-0.5 mb-0.5\">\n                  <Clock className=\"w-2 h-2 text-purple-600\" />\n                  <div className=\"text-sm font-bold text-purple-600\">{attendingTickets.length}</div>\n                </div>\n                <div className=\"text-xs text-slate-600 leading-none\">{txtAttending}</div>\n              </div>\n\n              <div className=\"p-1 bg-gradient-to-br from-green-50 to-emerald-50 rounded\">\n                <div className=\"flex items-center gap-0.5 mb-0.5\">\n                  <TrendingUp className=\"w-2 h-2 text-green-600\" />\n                  <div className=\"text-sm font-bold text-green-600\">#{queue.current_number}</div>\n                </div>\n                <div className=\"text-xs text-slate-600 leading-none\">{txtCurrent}</div>\n              </div>\n\n              <div className=\"p-1 bg-gradient-to-br from-amber-50 to-orange-50 rounded\">\n                <div className=\"flex items-center gap-0.5 mb-0.5\">\n                  <Clock className=\"w-2 h-2 text-amber-600\" />\n                  <div className=\"text-sm font-bold text-amber-600\">#{queue.last_issued_number}</div>\n                </div>\n                <div className=\"text-xs text-slate-600 leading-none\">{txtLast}</div>\n              </div>\n            </div>\n\n            <div className=\"space-y-1 mb-1.5\">\n              <Button\n                className=\"w-full h-7 text-xs bg-gradient-to-r from-green-500 to-emerald-500 hover:from-green-600 hover:to-emerald-600 px-1\"\n                onClick={() => callNextMutation.mutate()}\n                disabled={callNextMutation.isPending || activeTickets.length === 0 || queue.status !== \"aberta\"}\n              >\n                <PhoneCall className=\"w-2.5 h-2.5 mr-1\" />\n                {callNextMutation.isPending ? txtCalling : `${txtCall} #${queue.current_number + 1}`}\n              </Button>\n\n              <Button\n                variant=\"outline\"\n                className=\"w-full h-7 text-xs border-blue-300 text-blue-700 hover:bg-blue-50 px-1\"\n                onClick={() => setShowManualTicket(!showManualTicket)}\n              >\n                <UserPlus className=\"w-2.5 h-2.5 mr-1\" />\n                {txtManualTicket}\n              </Button>\n            </div>\n\n            {showManualTicket && (\n              <Card className=\"mb-1.5 border-blue-200 bg-blue-50\">\n                <CardContent className=\"p-1.5\">\n                  <div className=\"space-y-1\">\n                    <Input\n                      value={manualEmail}\n                      onChange={(e) => setManualEmail(e.target.value)}\n                      placeholder={txtEmailRequired2}\n                      type=\"text\"\n                      inputMode=\"email\"\n                      className=\"h-6 text-xs\"\n                      autoComplete=\"off\"\n                    />\n                    <Input\n                      value={manualName}\n                      onChange={(e) => setManualName(e.target.value)}\n                      placeholder={txtNameOptional}\n                      className=\"h-6 text-xs\"\n                    />\n                    <div className=\"flex gap-1\">\n                      <Button\n                        onClick={() => createManualTicketMutation.mutate()}\n                        disabled={createManualTicketMutation.isPending}\n                        className=\"flex-1 h-6 text-xs px-1\"\n                      >\n                        {createManualTicketMutation.isPending ? txtCreating : txtCreate}\n                      </Button>\n                      <Button\n                        variant=\"outline\"\n                        onClick={() => {\n                          setShowManualTicket(false);\n                          setCreatedTicketId(null);\n                        }}\n                        className=\"h-6 text-xs px-2\"\n                      >\n                        X\n                      </Button>\n                    </div>\n                    {createdTicketId && (() => {\n                      const qrCodeUrl = `${window.location.origin}${createPageUrl('TicketPublic')}?id=${createdTicketId}`;\n                      console.log('🔗 QR Code URL gerado:', qrCodeUrl);\n                      console.log('🆔 Ticket ID:', createdTicketId);\n                      return (\n                        <div className=\"pt-2 border-t border-blue-200\">\n                          <div className=\"bg-white rounded p-3 flex flex-col items-center\">\n                            <p className=\"text-xs font-medium text-slate-700 mb-2\">\n                              {txtTicketCreatedQR}\n                            </p>\n                            <div className=\"bg-white p-2 rounded border-2 border-slate-200\">\n                              <QRCodeSVG \n                                value={qrCodeUrl}\n                                size={140}\n                                level=\"M\"\n                                includeMargin={false}\n                              />\n                            </div>\n                            <p className=\"text-xs text-slate-600 mt-2 text-center\">\n                              {txtClientCanScan}\n                            </p>\n                            <Button\n                              variant=\"outline\"\n                              size=\"sm\"\n                              onClick={() => copyTicketLink(createdTicketId)}\n                              className=\"mt-2 h-6 text-xs w-full\"\n                            >\n                              <Copy className=\"w-2.5 h-2.5 mr-1\" />\n                              {txtCopyLinkAlt}\n                            </Button>\n                          </div>\n                        </div>\n                      );\n                    })()}\n                  </div>\n                </CardContent>\n              </Card>\n            )}\n\n            {activeTickets.length > 0 ? (\n              <div>\n                <h4 className=\"font-bold text-slate-900 mb-1 text-xs\">{txtTickets}</h4>\n                <div className=\"space-y-1 max-h-40 overflow-y-auto\">\n                  {activeTickets.slice(0, 5).map(ticket => (\n                    <TicketPanel \n                      key={ticket.id} \n                      ticket={ticket} \n                      onUpdateTicket={updateTicketMutation.mutate}\n                      onDeleteTicket={deleteTicketMutation.mutate}\n                    />\n                  ))}\n                </div>\n                {activeTickets.length > 5 && (\n                  <p className=\"text-xs text-slate-500 mt-1 text-center\">\n                    +{activeTickets.length - 5}\n                  </p>\n                )}\n              </div>\n            ) : (\n              <div className=\"text-center py-3 text-slate-500\">\n                <Users className=\"w-6 h-6 mx-auto mb-1 opacity-50\" />\n                <p className=\"text-xs\">{txtNoTickets}</p>\n              </div>\n            )}\n          </TabsContent>\n\n          <TabsContent value=\"history\" className=\"p-1.5\">\n            <TicketHistory businessId={queue.business_id} />\n          </TabsContent>\n        </Tabs>\n      </CardContent>\n    </Card>\n  );\n}","path":null,"size_bytes":30004,"size_tokens":null},"src/index.css":{"content":"@tailwind base;\n@tailwind components;\n@tailwind utilities;\n\n@layer components {\n  .required::after {\n    content: \" *\";\n    color: #ef4444;\n  }\n  \n  .scrollbar-hide::-webkit-scrollbar {\n    display: none;\n  }\n  \n  .scrollbar-hide {\n    -ms-overflow-style: none;\n    scrollbar-width: none;\n  }\n}\n\n/* Mobile Optimizations - Mobile First Approach */\n\n/* iOS Safe Area Insets - Full screen support for iPhone X+ */\n:root {\n  --safe-area-inset-top: env(safe-area-inset-top, 0px);\n  --safe-area-inset-bottom: env(safe-area-inset-bottom, 0px);\n  --safe-area-inset-left: env(safe-area-inset-left, 0px);\n  --safe-area-inset-right: env(safe-area-inset-right, 0px);\n}\n\n/* Prevent horizontal overflow on all screen sizes */\nhtml, body {\n  max-width: 100vw;\n  overflow-x: hidden;\n  min-height: 100vh;\n  min-height: -webkit-fill-available;\n  -webkit-text-size-adjust: 100%;\n  -ms-text-size-adjust: 100%;\n  -webkit-tap-highlight-color: transparent;\n}\n\n/* Prevent zoom on input focus - iOS requires 16px minimum font size */\n/* Scoped to interactive elements to preserve pinch-zoom on maps */\ninput, select, textarea, button, a, [role=\"button\"] {\n  font-size: 16px !important;\n  touch-action: manipulation;\n}\n\n#root {\n  min-height: 100vh;\n  min-height: -webkit-fill-available;\n}\n\n/* Safe areas ONLY for Capacitor/iOS/Android native apps */\n@supports (padding: env(safe-area-inset-top)) {\n  html.capacitor body,\n  html.ios body,\n  html.android body {\n    padding-top: max(0px, env(safe-area-inset-top));\n    padding-left: max(0px, env(safe-area-inset-left));\n    padding-right: max(0px, env(safe-area-inset-right));\n    padding-bottom: max(0px, env(safe-area-inset-bottom));\n  }\n}\n\n/* Mobile-only styles (< 640px) */\n@media (max-width: 639px) {\n  /* Modal dialogs - smaller on mobile */\n  [role=\"dialog\"] {\n    max-width: 95vw !important;\n    margin: 0.5rem !important;\n  }\n  \n  /* Prevent zoom on input focus (iOS) */\n  input[type=\"text\"],\n  input[type=\"email\"],\n  input[type=\"tel\"],\n  input[type=\"number\"],\n  input[type=\"password\"],\n  textarea,\n  select {\n    font-size: 16px !important;\n  }\n\n  /* Touch targets - 40px for mobile */\n  button:not(.p-0):not(.h-auto), \n  a:not(.inline):not(.text-inherit), \n  [role=\"button\"]:not(.p-0) {\n    min-height: 40px;\n  }\n  \n  /* Smooth scrolling */\n  html {\n    scroll-behavior: smooth;\n    -webkit-overflow-scrolling: touch;\n  }\n  \n  /* Prevent text overflow */\n  h1, h2, h3, h4, h5, h6, p {\n    overflow-wrap: break-word;\n    word-wrap: break-word;\n  }\n  \n  /* Better image responsiveness */\n  img {\n    max-width: 100%;\n    height: auto;\n  }\n  \n  /* Ensure buttons/inputs don't exceed screen width */\n  input, button, select, textarea {\n    max-width: 100%;\n  }\n  \n  /* Bottom padding for fixed navigation - REMOVIDO: Layout.jsx já controla isto */\n  /* O padding duplicado estava a causar scroll desnecessário nas apps nativas */\n}\n\n/* Tablet styles (640px - 1024px) */\n@media (min-width: 640px) and (max-width: 1024px) {\n  /* Touch targets - 48px minimum for tablets (WCAG 2.5.5) */\n  button:not(.p-0):not(.h-auto):not(.h-7):not(.h-8), \n  [role=\"button\"]:not(.p-0):not(.h-7):not(.h-8) {\n    min-height: 48px;\n  }\n  \n  /* Modal dialogs - better tablet sizing */\n  [role=\"dialog\"] {\n    max-width: 80vw;\n    max-height: 85vh;\n    margin: 1.5rem auto;\n  }\n  \n  /* Bottom nav adjustments - REMOVIDO: Layout.jsx já controla isto */\n}\n\n/* Large tablet and small desktop (1024px+) */\n@media (min-width: 1024px) {\n  /* Reset touch targets for desktop */\n  button, a, [role=\"button\"] {\n    min-height: auto;\n  }\n}\n\n@layer base {\n  :root {\n    --background: 0 0% 100%;\n    --foreground: 0 0% 3.9%;\n    --card: 0 0% 100%;\n    --card-foreground: 0 0% 3.9%;\n    --popover: 0 0% 100%;\n    --popover-foreground: 0 0% 3.9%;\n    --primary: 0 0% 9%;\n    --primary-foreground: 0 0% 98%;\n    --secondary: 0 0% 96.1%;\n    --secondary-foreground: 0 0% 9%;\n    --muted: 0 0% 96.1%;\n    --muted-foreground: 0 0% 45.1%;\n    --accent: 0 0% 96.1%;\n    --accent-foreground: 0 0% 9%;\n    --destructive: 0 84.2% 60.2%;\n    --destructive-foreground: 0 0% 98%;\n    --border: 0 0% 89.8%;\n    --input: 0 0% 89.8%;\n    --ring: 0 0% 3.9%;\n    --chart-1: 12 76% 61%;\n    --chart-2: 173 58% 39%;\n    --chart-3: 197 37% 24%;\n    --chart-4: 43 74% 66%;\n    --chart-5: 27 87% 67%;\n    --radius: 0.5rem;\n    --sidebar-background: 0 0% 98%;\n    --sidebar-foreground: 240 5.3% 26.1%;\n    --sidebar-primary: 240 5.9% 10%;\n    --sidebar-primary-foreground: 0 0% 98%;\n    --sidebar-accent: 240 4.8% 95.9%;\n    --sidebar-accent-foreground: 240 5.9% 10%;\n    --sidebar-border: 220 13% 91%;\n    --sidebar-ring: 217.2 91.2% 59.8%;\n    \n    /* Modern Design Tokens */\n    --shadow-soft: 0 2px 8px rgba(0, 0, 0, 0.04);\n    --shadow-medium: 0 4px 16px rgba(0, 0, 0, 0.08);\n    --shadow-large: 0 8px 32px rgba(0, 0, 0, 0.12);\n    --shadow-xl: 0 20px 48px rgba(0, 0, 0, 0.16);\n    \n    --duration-fast: 150ms;\n    --duration-normal: 300ms;\n    --duration-slow: 500ms;\n  }\n  .dark {\n    --background: 0 0% 3.9%;\n    --foreground: 0 0% 98%;\n    --card: 0 0% 3.9%;\n    --card-foreground: 0 0% 98%;\n    --popover: 0 0% 3.9%;\n    --popover-foreground: 0 0% 98%;\n    --primary: 0 0% 98%;\n    --primary-foreground: 0 0% 9%;\n    --secondary: 0 0% 14.9%;\n    --secondary-foreground: 0 0% 98%;\n    --muted: 0 0% 14.9%;\n    --muted-foreground: 0 0% 63.9%;\n    --accent: 0 0% 14.9%;\n    --accent-foreground: 0 0% 98%;\n    --destructive: 0 62.8% 30.6%;\n    --destructive-foreground: 0 0% 98%;\n    --border: 0 0% 14.9%;\n    --input: 0 0% 14.9%;\n    --ring: 0 0% 83.1%;\n    --chart-1: 220 70% 50%;\n    --chart-2: 160 60% 45%;\n    --chart-3: 30 80% 55%;\n    --chart-4: 280 65% 60%;\n    --chart-5: 340 75% 55%;\n    --sidebar-background: 240 5.9% 10%;\n    --sidebar-foreground: 240 4.8% 95.9%;\n    --sidebar-primary: 224.3 76.3% 48%;\n    --sidebar-primary-foreground: 0 0% 100%;\n    --sidebar-accent: 240 3.7% 15.9%;\n    --sidebar-accent-foreground: 240 4.8% 95.9%;\n    --sidebar-border: 240 3.7% 15.9%;\n    --sidebar-ring: 217.2 91.2% 59.8%;\n  }\n}\n\n@layer base {\n  * {\n    @apply border-border outline-ring/50;\n  }\n  body {\n    @apply bg-background text-foreground;\n  }\n}\n","path":null,"size_bytes":6132,"size_tokens":null},"src/components/business/ServiceManager.jsx":{"content":"import React, { useState } from \"react\";\nimport { base44 } from \"@/api/base44Client\";\nimport { useQuery, useMutation, useQueryClient } from \"@tanstack/react-query\";\nimport { Button } from \"@/components/ui/button\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Input } from \"@/components/ui/input\";\nimport { Label } from \"@/components/ui/label\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Switch } from \"@/components/ui/switch\";\nimport { Plus, Edit, Trash2, Clock, Euro, Calendar, Timer } from \"lucide-react\";\nimport ServiceScheduleConfig from \"./ServiceScheduleConfig\";\nimport { useAutoTranslate } from \"@/hooks/useTranslate\";\n\nexport default function ServiceManager({ businessId }) {\n  // Traduções\n  const txtSun = useAutoTranslate('Dom', 'pt');\n  const txtMon = useAutoTranslate('Seg', 'pt');\n  const txtTue = useAutoTranslate('Ter', 'pt');\n  const txtWed = useAutoTranslate('Qua', 'pt');\n  const txtThu = useAutoTranslate('Qui', 'pt');\n  const txtFri = useAutoTranslate('Sex', 'pt');\n  const txtSat = useAutoTranslate('Sáb', 'pt');\n  const txtServices = useAutoTranslate('Serviços', 'pt');\n  const txtManageAppointments = useAutoTranslate('Gerir marcações', 'pt');\n  const txtNew = useAutoTranslate('Novo', 'pt');\n  const txtEdit = useAutoTranslate('Editar', 'pt');\n  const txtNewService = useAutoTranslate('Novo Serviço', 'pt');\n  const txtEditService = useAutoTranslate('Editar Serviço', 'pt');\n  const txtName = useAutoTranslate('Nome *', 'pt');\n  const txtCategory = useAutoTranslate('Categoria', 'pt');\n  const txtDescription = useAutoTranslate('Descrição', 'pt');\n  const txtMin = useAutoTranslate('Min *', 'pt');\n  const txtTolerance = useAutoTranslate('Tolerância', 'pt');\n  const txtOptional = useAutoTranslate('(opcional)', 'pt');\n  const txtToler = useAutoTranslate('Toler.', 'pt');\n  const txtPrice = useAutoTranslate('Preço €', 'pt');\n  const txtDailySlots = useAutoTranslate('Slots Diários', 'pt');\n  const txtDays = useAutoTranslate('Dias', 'pt');\n  const txtActive = useAutoTranslate('Ativo', 'pt');\n  const txtUpdate = useAutoTranslate('Atualizar', 'pt');\n  const txtCreate = useAutoTranslate('Criar', 'pt');\n  const txtCancel = useAutoTranslate('Cancelar', 'pt');\n  const txtNoServices = useAutoTranslate('Nenhum serviço criado', 'pt');\n  const txtDeleteConfirm = useAutoTranslate('Eliminar?', 'pt');\n  const txtTol = useAutoTranslate('tol:', 'pt');\n  \n  const daysOfWeek = [\n    { value: 0, label: txtSun },\n    { value: 1, label: txtMon },\n    { value: 2, label: txtTue },\n    { value: 3, label: txtWed },\n    { value: 4, label: txtThu },\n    { value: 5, label: txtFri },\n    { value: 6, label: txtSat }\n  ];\n  const queryClient = useQueryClient();\n  const [showForm, setShowForm] = useState(false);\n  const [editingService, setEditingService] = useState(null);\n  const [formData, setFormData] = useState({\n    name: '',\n    description: '',\n    duration: 30,\n    buffer_time: 0,\n    tolerance_time: 15,\n    price: 0,\n    category: '',\n    start_time: '09:00',\n    end_time: '18:00',\n    available_days: [1, 2, 3, 4, 5],\n    max_daily_slots: 10,\n    custom_schedules: {},\n    blocked_dates: [],\n    is_active: true\n  });\n\n  const { data: services, isLoading } = useQuery({\n    queryKey: ['services', businessId],\n    queryFn: () => base44.entities.Service.filter({ business_id: businessId }),\n  });\n\n  const createMutation = useMutation({\n    mutationFn: (data) => base44.entities.Service.create({ ...data, business_id: businessId }),\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['services', businessId] });\n      resetForm();\n    },\n  });\n\n  const updateMutation = useMutation({\n    mutationFn: ({ id, data }) => base44.entities.Service.update(id, data),\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['services', businessId] });\n      resetForm();\n    },\n  });\n\n  const deleteMutation = useMutation({\n    mutationFn: (id) => base44.entities.Service.delete(id),\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['services', businessId] });\n    },\n  });\n\n  const resetForm = () => {\n    setFormData({\n      name: '',\n      description: '',\n      duration: 30,\n      buffer_time: 0,\n      tolerance_time: 15,\n      price: 0,\n      category: '',\n      start_time: '09:00',\n      end_time: '18:00',\n      available_days: [1, 2, 3, 4, 5],\n      max_daily_slots: 10,\n      custom_schedules: {},\n      blocked_dates: [],\n      is_active: true\n    });\n    setEditingService(null);\n    setShowForm(false);\n  };\n\n  const handleEdit = (service) => {\n    setFormData({\n      ...service,\n      buffer_time: service.buffer_time || 0,\n      tolerance_time: service.tolerance_time || 15,\n      available_days: service.available_days || [1, 2, 3, 4, 5],\n      custom_schedules: service.custom_schedules || {},\n      blocked_dates: service.blocked_dates || []\n    });\n    setEditingService(service);\n    setShowForm(true);\n  };\n\n  const handleSubmit = (e) => {\n    e.preventDefault();\n    if (editingService) {\n      updateMutation.mutate({ id: editingService.id, data: formData });\n    } else {\n      createMutation.mutate(formData);\n    }\n  };\n\n  const toggleDay = (day) => {\n    const days = formData.available_days || [];\n    if (days.includes(day)) {\n      setFormData({ ...formData, available_days: days.filter(d => d !== day) });\n    } else {\n      setFormData({ ...formData, available_days: [...days, day].sort() });\n    }\n  };\n\n  return (\n    <div className=\"space-y-4 md:space-y-6\">\n      <div className=\"flex flex-col sm:flex-row justify-between items-start sm:items-center gap-3\">\n        <div>\n          <h3 className=\"text-base md:text-xl font-bold text-slate-900\">{txtServices}</h3>\n          <p className=\"text-xs md:text-sm text-slate-600\">{txtManageAppointments}</p>\n        </div>\n        {!showForm && (\n          <Button size=\"sm\" onClick={() => setShowForm(true)} className=\"gap-2 w-full sm:w-auto h-9\">\n            <Plus className=\"w-3 h-3 md:w-4 md:h-4\" />\n            {txtNew}\n          </Button>\n        )}\n      </div>\n\n      {showForm && (\n        <Card className=\"border-2 border-sky-200 shadow-lg\">\n          <CardHeader className=\"bg-sky-50 p-3 md:p-6\">\n            <CardTitle className=\"text-sm md:text-lg\">\n              {editingService ? txtEditService : txtNewService}\n            </CardTitle>\n          </CardHeader>\n          <CardContent className=\"p-3 md:p-6\">\n            <form onSubmit={handleSubmit} className=\"space-y-4 md:space-y-6\" noValidate>\n              <div className=\"space-y-3 md:space-y-4\">\n                <div className=\"grid md:grid-cols-2 gap-3 md:gap-4\">\n                  <div>\n                    <Label htmlFor=\"name\" className=\"text-xs md:text-sm\">{txtName}</Label>\n                    <Input\n                      id=\"name\"\n                      value={formData.name}\n                      onChange={(e) => setFormData({ ...formData, name: e.target.value })}\n                      className=\"h-9 text-sm\"\n                    />\n                  </div>\n\n                  <div>\n                    <Label htmlFor=\"category\" className=\"text-xs md:text-sm\">{txtCategory}</Label>\n                    <Input\n                      id=\"category\"\n                      value={formData.category}\n                      onChange={(e) => setFormData({ ...formData, category: e.target.value })}\n                      className=\"h-9 text-sm\"\n                    />\n                  </div>\n                </div>\n\n                <div>\n                  <Label htmlFor=\"description\" className=\"text-xs md:text-sm\">{txtDescription}</Label>\n                  <Textarea\n                    id=\"description\"\n                    value={formData.description}\n                    onChange={(e) => setFormData({ ...formData, description: e.target.value })}\n                    rows={2}\n                    className=\"resize-none text-sm\"\n                  />\n                </div>\n\n                <div className=\"grid grid-cols-2 md:grid-cols-4 gap-3 md:gap-4\">\n                  <div>\n                    <Label htmlFor=\"duration\" className=\"text-xs md:text-sm\">{txtMin}</Label>\n                    <Input\n                      id=\"duration\"\n                      type=\"number\"\n                      min=\"15\"\n                      step=\"15\"\n                      value={formData.duration}\n                      onChange={(e) => setFormData({ ...formData, duration: parseInt(e.target.value) })}\n                      className=\"h-9 text-sm\"\n                    />\n                  </div>\n\n                  <div>\n                    <Label htmlFor=\"buffer_time\" className=\"text-xs md:text-sm\">\n                      {txtTolerance} <span className=\"text-xs text-slate-400\">{txtOptional}</span>\n                    </Label>\n                    <Input\n                      id=\"buffer_time\"\n                      type=\"number\"\n                      min=\"0\"\n                      step=\"5\"\n                      value={formData.buffer_time}\n                      onChange={(e) => setFormData({ ...formData, buffer_time: parseInt(e.target.value) })}\n                      className=\"h-9 text-sm\"\n                      placeholder=\"0\"\n                    />\n                  </div>\n\n                  <div>\n                    <Label htmlFor=\"tolerance_time\" className=\"text-xs md:text-sm\">{txtToler}</Label>\n                    <Input\n                      id=\"tolerance_time\"\n                      type=\"number\"\n                      min=\"5\"\n                      step=\"5\"\n                      value={formData.tolerance_time}\n                      onChange={(e) => setFormData({ ...formData, tolerance_time: parseInt(e.target.value) })}\n                      className=\"h-9 text-sm\"\n                    />\n                  </div>\n\n                  <div>\n                    <Label htmlFor=\"price\" className=\"text-xs md:text-sm\">{txtPrice}</Label>\n                    <Input\n                      id=\"price\"\n                      type=\"number\"\n                      step=\"0.01\"\n                      min=\"0\"\n                      value={formData.price}\n                      onChange={(e) => setFormData({ ...formData, price: parseFloat(e.target.value) })}\n                      className=\"h-9 text-sm\"\n                    />\n                  </div>\n                </div>\n\n                <div>\n                  <Label htmlFor=\"slots\" className=\"text-xs md:text-sm\">{txtDailySlots}</Label>\n                  <Input\n                    id=\"slots\"\n                    type=\"number\"\n                    min=\"1\"\n                    value={formData.max_daily_slots}\n                    onChange={(e) => setFormData({ ...formData, max_daily_slots: parseInt(e.target.value) })}\n                    className=\"h-9 text-sm\"\n                  />\n                </div>\n\n                <div>\n                  <Label className=\"mb-2 block text-xs md:text-sm\">{txtDays}</Label>\n                  <div className=\"grid grid-cols-4 md:grid-cols-7 gap-2\">\n                    {daysOfWeek.map(day => (\n                      <Button\n                        key={day.value}\n                        type=\"button\"\n                        variant={formData.available_days?.includes(day.value) ? \"default\" : \"outline\"}\n                        size=\"sm\"\n                        onClick={() => toggleDay(day.value)}\n                        className=\"w-full h-8 text-xs px-1\"\n                      >\n                        {day.label}\n                      </Button>\n                    ))}\n                  </div>\n                </div>\n              </div>\n\n              <ServiceScheduleConfig formData={formData} setFormData={setFormData} />\n\n              <div className=\"flex items-center gap-2 pt-3 md:pt-4 border-t\">\n                <Switch\n                  checked={formData.is_active}\n                  onCheckedChange={(checked) => setFormData({ ...formData, is_active: checked })}\n                />\n                <Label className=\"text-xs md:text-sm\">{txtActive}</Label>\n              </div>\n\n              <div className=\"flex gap-2 md:gap-3\">\n                <Button type=\"submit\" size=\"sm\" className=\"gap-2 flex-1 h-9\">\n                  {editingService ? txtUpdate : txtCreate}\n                </Button>\n                <Button type=\"button\" size=\"sm\" variant=\"outline\" onClick={resetForm} className=\"flex-1 h-9\">\n                  {txtCancel}\n                </Button>\n              </div>\n            </form>\n          </CardContent>\n        </Card>\n      )}\n\n      {services.length === 0 ? (\n        <Card>\n          <CardContent className=\"py-8 md:py-12 text-center text-slate-500 text-sm\">\n            {txtNoServices}\n          </CardContent>\n        </Card>\n      ) : (\n        <div className=\"grid md:grid-cols-2 gap-3 md:gap-4\">\n          {services.map(service => (\n            <Card key={service.id} className=\"hover:shadow-lg transition-shadow\">\n              <CardContent className=\"p-3 md:p-4\">\n                <div className=\"flex justify-between items-start mb-2 md:mb-3\">\n                  <div className=\"flex-1 min-w-0\">\n                    <h4 className=\"font-bold text-sm md:text-base text-slate-900 mb-1 truncate\">{service.name}</h4>\n                    {service.category && (\n                      <Badge variant=\"secondary\" className=\"text-xs\">{service.category}</Badge>\n                    )}\n                  </div>\n                  <div className=\"flex gap-1 ml-2\">\n                    <Button size=\"sm\" variant=\"outline\" onClick={() => handleEdit(service)} className=\"h-7 w-7 p-0\">\n                      <Edit className=\"w-3 h-3\" />\n                    </Button>\n                    <Button \n                      size=\"sm\" \n                      variant=\"outline\"\n                      className=\"border-red-200 text-red-600 hover:bg-red-50 h-7 w-7 p-0\"\n                      onClick={() => {\n                        if (confirm(txtDeleteConfirm)) {\n                          deleteMutation.mutate(service.id);\n                        }\n                      }}\n                    >\n                      <Trash2 className=\"w-3 h-3\" />\n                    </Button>\n                  </div>\n                </div>\n\n                <p className=\"text-xs md:text-sm text-slate-600 mb-2 md:mb-3 line-clamp-2\">{service.description}</p>\n\n                <div className=\"flex flex-wrap gap-2 md:gap-3 text-xs text-slate-600 mb-2\">\n                  <div className=\"flex items-center gap-1\">\n                    <Clock className=\"w-3 h-3\" />\n                    {service.duration}min\n                  </div>\n                  {(service.buffer_time > 0 || service.tolerance_time > 0) && (\n                    <div className=\"flex items-center gap-1\">\n                      <Timer className=\"w-3 h-3\" />\n                      {service.buffer_time > 0 && `+${service.buffer_time}min`}\n                      {service.tolerance_time > 0 && ` (${txtTol} ${service.tolerance_time}min)`}\n                    </div>\n                  )}\n                  {service.price > 0 && (\n                    <div className=\"flex items-center gap-1\">\n                      <Euro className=\"w-3 h-3\" />\n                      {service.price.toFixed(2)}\n                    </div>\n                  )}\n                  <div className=\"flex items-center gap-1\">\n                    <Calendar className=\"w-3 h-3\" />\n                    {service.start_time}-{service.end_time}\n                  </div>\n                </div>\n\n                {service.available_days && service.available_days.length > 0 && (\n                  <div className=\"flex flex-wrap gap-1 mb-2\">\n                    {service.available_days.map(dayNum => {\n                      const day = daysOfWeek.find(d => d.value === dayNum);\n                      return day ? (\n                        <Badge key={dayNum} variant=\"secondary\" className=\"text-xs px-1.5 py-0\">\n                          {day.label}\n                        </Badge>\n                      ) : null;\n                    })}\n                  </div>\n                )}\n\n                {!service.is_active && (\n                  <Badge variant=\"secondary\" className=\"bg-red-100 text-red-700 text-xs\">\n                    Inativo\n                  </Badge>\n                )}\n              </CardContent>\n            </Card>\n          ))}\n        </div>\n      )}\n    </div>\n  );\n}","path":null,"size_bytes":16472,"size_tokens":null},"src/components/ui/carousel.jsx":{"content":"import * as React from \"react\"\nimport useEmblaCarousel from \"embla-carousel-react\";\nimport { ArrowLeft, ArrowRight } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\nimport { Button } from \"@/components/ui/button\"\n\nconst CarouselContext = React.createContext(null)\n\nfunction useCarousel() {\n  const context = React.useContext(CarouselContext)\n\n  if (!context) {\n    throw new Error(\"useCarousel must be used within a <Carousel />\")\n  }\n\n  return context\n}\n\nconst Carousel = React.forwardRef((\n  {\n    orientation = \"horizontal\",\n    opts,\n    setApi,\n    plugins,\n    className,\n    children,\n    ...props\n  },\n  ref\n) => {\n  const [carouselRef, api] = useEmblaCarousel({\n    ...opts,\n    axis: orientation === \"horizontal\" ? \"x\" : \"y\",\n  }, plugins)\n  const [canScrollPrev, setCanScrollPrev] = React.useState(false)\n  const [canScrollNext, setCanScrollNext] = React.useState(false)\n\n  const onSelect = React.useCallback((api) => {\n    if (!api) {\n      return\n    }\n\n    setCanScrollPrev(api.canScrollPrev())\n    setCanScrollNext(api.canScrollNext())\n  }, [])\n\n  const scrollPrev = React.useCallback(() => {\n    api?.scrollPrev()\n  }, [api])\n\n  const scrollNext = React.useCallback(() => {\n    api?.scrollNext()\n  }, [api])\n\n  const handleKeyDown = React.useCallback((event) => {\n    if (event.key === \"ArrowLeft\") {\n      event.preventDefault()\n      scrollPrev()\n    } else if (event.key === \"ArrowRight\") {\n      event.preventDefault()\n      scrollNext()\n    }\n  }, [scrollPrev, scrollNext])\n\n  React.useEffect(() => {\n    if (!api || !setApi) {\n      return\n    }\n\n    setApi(api)\n  }, [api, setApi])\n\n  React.useEffect(() => {\n    if (!api) {\n      return\n    }\n\n    onSelect(api)\n    api.on(\"reInit\", onSelect)\n    api.on(\"select\", onSelect)\n\n    return () => {\n      api?.off(\"select\", onSelect)\n    };\n  }, [api, onSelect])\n\n  return (\n    (<CarouselContext.Provider\n      value={{\n        carouselRef,\n        api: api,\n        opts,\n        orientation:\n          orientation || (opts?.axis === \"y\" ? \"vertical\" : \"horizontal\"),\n        scrollPrev,\n        scrollNext,\n        canScrollPrev,\n        canScrollNext,\n      }}>\n      <div\n        ref={ref}\n        onKeyDownCapture={handleKeyDown}\n        className={cn(\"relative\", className)}\n        role=\"region\"\n        aria-roledescription=\"carousel\"\n        {...props}>\n        {children}\n      </div>\n    </CarouselContext.Provider>)\n  );\n})\nCarousel.displayName = \"Carousel\"\n\nconst CarouselContent = React.forwardRef(({ className, ...props }, ref) => {\n  const { carouselRef, orientation } = useCarousel()\n\n  return (\n    (<div ref={carouselRef} className=\"overflow-hidden\">\n      <div\n        ref={ref}\n        className={cn(\n          \"flex\",\n          orientation === \"horizontal\" ? \"-ml-4\" : \"-mt-4 flex-col\",\n          className\n        )}\n        {...props} />\n    </div>)\n  );\n})\nCarouselContent.displayName = \"CarouselContent\"\n\nconst CarouselItem = React.forwardRef(({ className, ...props }, ref) => {\n  const { orientation } = useCarousel()\n\n  return (\n    (<div\n      ref={ref}\n      role=\"group\"\n      aria-roledescription=\"slide\"\n      className={cn(\n        \"min-w-0 shrink-0 grow-0 basis-full\",\n        orientation === \"horizontal\" ? \"pl-4\" : \"pt-4\",\n        className\n      )}\n      {...props} />)\n  );\n})\nCarouselItem.displayName = \"CarouselItem\"\n\nconst CarouselPrevious = React.forwardRef(({ className, variant = \"outline\", size = \"icon\", ...props }, ref) => {\n  const { orientation, scrollPrev, canScrollPrev } = useCarousel()\n\n  return (\n    (<Button\n      ref={ref}\n      variant={variant}\n      size={size}\n      className={cn(\"absolute  h-8 w-8 rounded-full\", orientation === \"horizontal\"\n        ? \"-left-12 top-1/2 -translate-y-1/2\"\n        : \"-top-12 left-1/2 -translate-x-1/2 rotate-90\", className)}\n      disabled={!canScrollPrev}\n      onClick={scrollPrev}\n      {...props}>\n      <ArrowLeft className=\"h-4 w-4\" />\n      <span className=\"sr-only\">Previous slide</span>\n    </Button>)\n  );\n})\nCarouselPrevious.displayName = \"CarouselPrevious\"\n\nconst CarouselNext = React.forwardRef(({ className, variant = \"outline\", size = \"icon\", ...props }, ref) => {\n  const { orientation, scrollNext, canScrollNext } = useCarousel()\n\n  return (\n    (<Button\n      ref={ref}\n      variant={variant}\n      size={size}\n      className={cn(\"absolute h-8 w-8 rounded-full\", orientation === \"horizontal\"\n        ? \"-right-12 top-1/2 -translate-y-1/2\"\n        : \"-bottom-12 left-1/2 -translate-x-1/2 rotate-90\", className)}\n      disabled={!canScrollNext}\n      onClick={scrollNext}\n      {...props}>\n      <ArrowRight className=\"h-4 w-4\" />\n      <span className=\"sr-only\">Next slide</span>\n    </Button>)\n  );\n})\nCarouselNext.displayName = \"CarouselNext\"\n\nexport { Carousel, CarouselContent, CarouselItem, CarouselPrevious, CarouselNext };\n","path":null,"size_bytes":4821,"size_tokens":null},"src/components/ui/input.jsx":{"content":"import * as React from \"react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Input = React.forwardRef(({ className, type, error, success, ...props }, ref) => {\n  return (\n    (<input\n      type={type}\n      className={cn(\n        \"flex h-9 w-full rounded-md border border-input bg-transparent px-3 py-1 text-base shadow-sm transition-all duration-300 file:border-0 file:bg-transparent file:text-sm file:font-medium file:text-foreground placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-1 focus-visible:border-primary disabled:cursor-not-allowed disabled:opacity-50 md:text-sm\",\n        error && \"border-destructive focus-visible:ring-destructive\",\n        success && \"border-green-500 focus-visible:ring-green-500\",\n        className\n      )}\n      ref={ref}\n      {...props} />)\n  );\n})\nInput.displayName = \"Input\"\n\nexport { Input }\n","path":null,"size_bytes":911,"size_tokens":null},"src/components/business/Statistics.jsx":{"content":"\nimport React, { useState } from \"react\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Tabs, TabsList, TabsTrigger } from \"@/components/ui/tabs\";\nimport { Button } from \"@/components/ui/button\";\nimport { \n  BarChart3,\n  TrendingUp,\n  Clock,\n  Users,\n  Star,\n  Calendar,\n  Download,\n  TrendingDown,\n  Activity\n} from \"lucide-react\";\nimport { Badge } from \"@/components/ui/badge\";\nimport PerformanceCharts from \"./PerformanceCharts\";\nimport UserBehaviorAnalytics from \"./UserBehaviorAnalytics\";\nimport PredictiveAnalytics from \"./PredictiveAnalytics\";\nimport AIAnalytics from \"./AIAnalytics\";\nimport { useAutoTranslate } from \"@/hooks/useTranslate\";\n\nexport default function Statistics({ business, queues, tickets }) {\n  const [timePeriod, setTimePeriod] = useState(\"hoje\");\n  \n  const txtStatsAnalytics = useAutoTranslate('Estatísticas e Analytics', 'pt');\n  const txtDetailedAnalysis = useAutoTranslate('Análise detalhada do desempenho', 'pt');\n  const txtToday = useAutoTranslate('Hoje', 'pt');\n  const txt7Days = useAutoTranslate('7 Dias', 'pt');\n  const txt30Days = useAutoTranslate('30 Dias', 'pt');\n  const txtTotalTickets = useAutoTranslate('Total de Senhas', 'pt');\n  const txtCompleted = useAutoTranslate('concluídas', 'pt');\n  const txtCompletionRate = useAutoTranslate('Taxa de Conclusão', 'pt');\n  const txtCancelled = useAutoTranslate('canceladas', 'pt');\n  const txtAverageTime = useAutoTranslate('Tempo Médio', 'pt');\n  const txtMin = useAutoTranslate('min', 'pt');\n  const txtAverageWaitTime = useAutoTranslate('Tempo de espera médio', 'pt');\n  const txtAverageRating = useAutoTranslate('Avaliação Média', 'pt');\n  const txtRatings = useAutoTranslate('avaliações', 'pt');\n  const txtPeakHour = useAutoTranslate('Horário de Pico', 'pt');\n  const txtHighestDemand = useAutoTranslate('Maior procura', 'pt');\n  const txtQueuePerformance = useAutoTranslate('Desempenho por Senha', 'pt');\n  const txtQueue = useAutoTranslate('Fila', 'pt');\n  const txtTickets = useAutoTranslate('Senhas', 'pt');\n  const txtNoDataToDisplay = useAutoTranslate('Sem dados para exibir', 'pt');\n  const txtTicketsServed = useAutoTranslate('senhas atendidas', 'pt');\n  const txtOf = useAutoTranslate('de', 'pt');\n  const txtBusiest = useAutoTranslate('Horário Mais Movimentado', 'pt');\n  const txtTicketsIssued = useAutoTranslate('senhas emitidas', 'pt');\n  const txtAveragePerHour = useAutoTranslate('Média por Hora', 'pt');\n  const txtTicketsPerHourToday = useAutoTranslate('senhas/hora hoje', 'pt');\n\n  // Calculate date ranges\n  const now = new Date();\n  const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());\n  const weekAgo = new Date(today);\n  weekAgo.setDate(weekAgo.getDate() - 7);\n  const monthAgo = new Date(today);\n  monthAgo.setMonth(monthAgo.getMonth() - 1);\n\n  // Filter tickets by period\n  const filterByPeriod = (ticket) => {\n    const ticketDate = new Date(ticket.created_date);\n    switch(timePeriod) {\n      case \"hoje\":\n        return ticketDate >= today;\n      case \"semana\":\n        return ticketDate >= weekAgo;\n      case \"mes\":\n        return ticketDate >= monthAgo;\n      default:\n        return true;\n    }\n  };\n\n  const filteredTickets = tickets.filter(filterByPeriod);\n  const completedTickets = filteredTickets.filter(t => t.status === \"concluido\");\n  const cancelledTickets = filteredTickets.filter(t => t.status === \"cancelado\");\n  \n  // Calculate average wait time\n  const ticketsWithTime = completedTickets.filter(t => t.called_at && t.created_date);\n  const avgWaitTime = ticketsWithTime.length > 0\n    ? Math.round(\n        ticketsWithTime.reduce((sum, t) => {\n          const wait = (new Date(t.called_at) - new Date(t.created_date)) / (1000 * 60);\n          return sum + wait;\n        }, 0) / ticketsWithTime.length\n      )\n    : 0;\n\n  // Calculate ratings\n  const ratedTickets = completedTickets.filter(t => t.rating);\n  const avgRating = ratedTickets.length > 0\n    ? (ratedTickets.reduce((sum, t) => sum + t.rating, 0) / ratedTickets.length).toFixed(1)\n    : \"N/A\";\n\n  // Queue performance\n  const queueStats = queues.map(queue => {\n    const queueTickets = filteredTickets.filter(t => t.queue_id === queue.id);\n    const queueCompleted = queueTickets.filter(t => t.status === \"concluido\");\n    \n    return {\n      id: queue.id,\n      name: queue.name,\n      total: queueTickets.length,\n      completed: queueCompleted.length,\n      completionRate: queueTickets.length > 0 \n        ? Math.round((queueCompleted.length / queueTickets.length) * 100)\n        : 0\n    };\n  }).sort((a, b) => b.total - a.total);\n\n  // Hourly distribution\n  const hourlyDistribution = Array(24).fill(0);\n  filteredTickets.forEach(ticket => {\n    const hour = new Date(ticket.created_date).getHours();\n    hourlyDistribution[hour]++;\n  });\n\n  const peakHour = hourlyDistribution.indexOf(Math.max(...hourlyDistribution));\n  const peakHourText = peakHour >= 0 ? `${peakHour}:00 - ${peakHour + 1}:00` : \"N/A\";\n\n  // Export functions\n  const exportToCSV = () => {\n    const headers = [\"Data\", \"Senha\", \"Tipo Senha\", \"Status\", \"Tempo Espera (min)\", \"Avaliação\"];\n    const rows = filteredTickets.map(t => [\n      new Date(t.created_date).toLocaleString('pt-PT'),\n      `#${t.ticket_number}`,\n      queues.find(q => q.id === t.queue_id)?.name || 'N/A',\n      t.status,\n      t.called_at ? Math.round((new Date(t.called_at) - new Date(t.created_date)) / (1000 * 60)) : 'N/A',\n      t.rating || 'N/A'\n    ]);\n\n    const csv = [headers, ...rows].map(row => row.join(',')).join('\\n');\n    const blob = new Blob([csv], { type: 'text/csv' });\n    const url = window.URL.createObjectURL(blob);\n    const a = document.createElement('a');\n    a.href = url;\n    a.download = `relatorio-${business.name}-${timePeriod}.csv`;\n    a.click();\n  };\n\n  const exportSummary = () => {\n    const summary = {\n      empresa: business.name,\n      periodo: timePeriod,\n      data_geracao: new Date().toLocaleString('pt-PT'),\n      metricas: {\n        total_senhas: filteredTickets.length,\n        senhas_concluidas: completedTickets.length,\n        senhas_canceladas: cancelledTickets.length,\n        taxa_conclusao: `${Math.round((completedTickets.length / filteredTickets.length) * 100)}%`,\n        tempo_medio_espera: `${avgWaitTime} min`,\n        avaliacao_media: avgRating\n      },\n      filas: queueStats\n    };\n\n    const json = JSON.stringify(summary, null, 2);\n    const blob = new Blob([json], { type: 'application/json' });\n    const url = window.URL.createObjectURL(blob);\n    const a = document.createElement('a');\n    a.href = url;\n    a.download = `resumo-${business.name}-${timePeriod}.json`;\n    a.click();\n  };\n\n  return (\n    <div className=\"space-y-6\">\n      {/* AI Analytics - New Component */}\n      <AIAnalytics \n        tickets={tickets}\n        queues={queues}\n        business={business}\n      />\n\n      {/* Period Selector & Export */}\n      <div className=\"flex flex-col md:flex-row justify-between items-start md:items-center gap-4\">\n        <div>\n          <h2 className=\"text-2xl font-bold text-slate-900\">{txtStatsAnalytics}</h2>\n          <p className=\"text-slate-600 text-sm\">{txtDetailedAnalysis}</p>\n        </div>\n        <div className=\"flex flex-wrap gap-3\">\n          <Tabs value={timePeriod} onValueChange={setTimePeriod}>\n            <TabsList className=\"bg-white border border-slate-200\">\n              <TabsTrigger value=\"hoje\">{txtToday}</TabsTrigger>\n              <TabsTrigger value=\"semana\">{txt7Days}</TabsTrigger>\n              <TabsTrigger value=\"mes\">{txt30Days}</TabsTrigger>\n            </TabsList>\n          </Tabs>\n          <Button variant=\"outline\" size=\"sm\" onClick={exportToCSV} className=\"gap-2\">\n            <Download className=\"w-4 h-4\" />\n            CSV\n          </Button>\n          <Button variant=\"outline\" size=\"sm\" onClick={exportSummary} className=\"gap-2\">\n            <Download className=\"w-4 h-4\" />\n            JSON\n          </Button>\n        </div>\n      </div>\n\n      {/* Main Stats */}\n      <div className=\"grid md:grid-cols-2 lg:grid-cols-4 gap-6\">\n        <Card className=\"border-0 shadow-lg\">\n          <CardContent className=\"p-6\">\n            <div className=\"flex items-center gap-3 mb-4\">\n              <div className=\"w-12 h-12 rounded-xl bg-gradient-to-br from-blue-500 to-cyan-500 flex items-center justify-center\">\n                <Users className=\"w-6 h-6 text-white\" />\n              </div>\n              <div>\n                <p className=\"text-sm text-slate-600\">{txtTotalTickets}</p>\n                <p className=\"text-3xl font-bold text-slate-900\">{filteredTickets.length}</p>\n              </div>\n            </div>\n            <div className=\"flex items-center gap-2 text-sm\">\n              <Badge className=\"bg-green-100 text-green-700 border-green-200\">\n                <TrendingUp className=\"w-3 h-3 mr-1\" />\n                {completedTickets.length} {txtCompleted}\n              </Badge>\n            </div>\n          </CardContent>\n        </Card>\n\n        <Card className=\"border-0 shadow-lg\">\n          <CardContent className=\"p-6\">\n            <div className=\"flex items-center gap-3 mb-4\">\n              <div className=\"w-12 h-12 rounded-xl bg-gradient-to-br from-green-500 to-emerald-500 flex items-center justify-center\">\n                <BarChart3 className=\"w-6 h-6 text-white\" />\n              </div>\n              <div>\n                <p className=\"text-sm text-slate-600\">{txtCompletionRate}</p>\n                <p className=\"text-3xl font-bold text-slate-900\">\n                  {filteredTickets.length > 0 \n                    ? Math.round((completedTickets.length / filteredTickets.length) * 100)\n                    : 0}%\n                </p>\n              </div>\n            </div>\n            <div className=\"text-sm text-slate-600\">\n              {cancelledTickets.length} {txtCancelled}\n            </div>\n          </CardContent>\n        </Card>\n\n        <Card className=\"border-0 shadow-lg\">\n          <CardContent className=\"p-6\">\n            <div className=\"flex items-center gap-3 mb-4\">\n              <div className=\"w-12 h-12 rounded-xl bg-gradient-to-br from-purple-500 to-pink-500 flex items-center justify-center\">\n                <Clock className=\"w-6 h-6 text-white\" />\n              </div>\n              <div>\n                <p className=\"text-sm text-slate-600\">{txtAverageTime}</p>\n                <p className=\"text-3xl font-bold text-slate-900\">\n                  {avgWaitTime}\n                  <span className=\"text-lg text-slate-500\">{txtMin}</span>\n                </p>\n              </div>\n            </div>\n            <div className=\"text-sm text-slate-600\">\n              {txtAverageWaitTime}\n            </div>\n          </CardContent>\n        </Card>\n\n        <Card className=\"border-0 shadow-lg\">\n          <CardContent className=\"p-6\">\n            <div className=\"flex items-center gap-3 mb-4\">\n              <div className=\"w-12 h-12 rounded-xl bg-gradient-to-br from-amber-500 to-orange-500 flex items-center justify-center\">\n                <Star className=\"w-6 h-6 text-white\" />\n              </div>\n              <div>\n                <p className=\"text-sm text-slate-600\">{txtAverageRating}</p>\n                <p className=\"text-3xl font-bold text-slate-900\">\n                  {avgRating}\n                  {avgRating !== \"N/A\" && <span className=\"text-lg text-slate-500\">/5</span>}\n                </p>\n              </div>\n            </div>\n            <div className=\"text-sm text-slate-600\">\n              {ratedTickets.length} {txtRatings}\n            </div>\n          </CardContent>\n        </Card>\n      </div>\n\n      {/* Performance Charts */}\n      <PerformanceCharts \n        tickets={filteredTickets}\n        queues={queues}\n        timePeriod={timePeriod}\n      />\n\n      {/* User Behavior Analytics */}\n      <UserBehaviorAnalytics \n        tickets={filteredTickets}\n        completedTickets={completedTickets}\n        cancelledTickets={cancelledTickets}\n      />\n\n      {/* Predictive Analytics */}\n      <PredictiveAnalytics \n        tickets={tickets}\n        queues={queues}\n        business={business}\n      />\n\n      {/* Queue Performance */}\n      <Card className=\"border-0 shadow-lg\">\n        <CardHeader>\n          <CardTitle className=\"flex items-center gap-2\">\n            <BarChart3 className=\"w-5 h-5\" />\n            {txtQueuePerformance}\n          </CardTitle>\n        </CardHeader>\n        <CardContent>\n          {queueStats.length === 0 ? (\n            <p className=\"text-center text-slate-500 py-8\">{txtNoDataToDisplay}</p>\n          ) : (\n            <div className=\"space-y-4\">\n              {queueStats.map((stat, idx) => (\n                <div key={idx} className=\"p-4 bg-slate-50 rounded-xl\">\n                  <div className=\"flex justify-between items-start mb-3\">\n                    <div>\n                      <h4 className=\"font-bold text-slate-900\">{stat.name}</h4>\n                      <p className=\"text-sm text-slate-600\">\n                        {stat.completed} {txtOf} {stat.total} {txtTicketsServed}\n                      </p>\n                    </div>\n                    <Badge className=\"bg-blue-100 text-blue-700 border-blue-200\">\n                      {stat.completionRate}%\n                    </Badge>\n                  </div>\n                  \n                  <div className=\"w-full bg-slate-200 rounded-full h-3 overflow-hidden\">\n                    <div \n                      className=\"h-full bg-gradient-to-r from-blue-500 to-cyan-500 transition-all duration-500\"\n                      style={{ width: `${stat.completionRate}%` }}\n                    />\n                  </div>\n                </div>\n              ))}\n            </div>\n          )}\n        </CardContent>\n      </Card>\n\n      {/* Peak Hours */}\n      {timePeriod === \"hoje\" && (\n        <Card className=\"border-0 shadow-lg\">\n          <CardHeader>\n            <CardTitle className=\"flex items-center gap-2\">\n              <Calendar className=\"w-5 h-5\" />\n              {txtPeakHour}\n            </CardTitle>\n          </CardHeader>\n          <CardContent>\n            <div className=\"grid md:grid-cols-2 gap-6\">\n              <div className=\"p-6 bg-gradient-to-br from-amber-50 to-orange-50 rounded-xl\">\n                <div className=\"flex items-center gap-3 mb-2\">\n                  <Clock className=\"w-5 h-5 text-amber-600\" />\n                  <span className=\"text-sm font-medium text-amber-900\">{txtBusiest}</span>\n                </div>\n                <p className=\"text-3xl font-bold text-amber-700\">{peakHourText}</p>\n                <p className=\"text-sm text-amber-600 mt-1\">\n                  {Math.max(...hourlyDistribution)} {txtTicketsIssued}\n                </p>\n              </div>\n\n              <div className=\"p-6 bg-gradient-to-br from-blue-50 to-sky-50 rounded-xl\">\n                <div className=\"flex items-center gap-3 mb-2\">\n                  <TrendingUp className=\"w-5 h-5 text-blue-600\" />\n                  <span className=\"text-sm font-medium text-blue-900\">{txtAveragePerHour}</span>\n                </div>\n                <p className=\"text-3xl font-bold text-blue-700\">\n                  {Math.round(filteredTickets.length / 24)}\n                </p>\n                <p className=\"text-sm text-blue-600 mt-1\">\n                  {txtTicketsPerHourToday}\n                </p>\n              </div>\n            </div>\n\n            <div className=\"mt-6\">\n              <div className=\"flex items-end gap-1 h-32\">\n                {hourlyDistribution.map((count, hour) => {\n                  const maxCount = Math.max(...hourlyDistribution);\n                  const height = maxCount > 0 ? (count / maxCount) * 100 : 0;\n                  \n                  return (\n                    <div key={hour} className=\"flex-1 flex flex-col items-center gap-1\">\n                      <div \n                        className=\"w-full bg-gradient-to-t from-blue-500 to-cyan-400 rounded-t transition-all hover:opacity-80\"\n                        style={{ height: `${height}%`, minHeight: count > 0 ? '4px' : '0' }}\n                        title={`${hour}:00 - ${count} senhas`}\n                      />\n                      {hour % 3 === 0 && (\n                        <span className=\"text-[10px] text-slate-500\">{hour}h</span>\n                      )}\n                    </div>\n                  );\n                })}\n              </div>\n            </div>\n          </CardContent>\n        </Card>\n      )}\n    </div>\n  );\n}\n","path":null,"size_bytes":16501,"size_tokens":null},"src/pages/BusinessStaff.jsx":{"content":"import React, { useState, useEffect } from \"react\";\nimport { base44 } from \"@/api/base44Client\";\nimport { useQuery, useMutation, useQueryClient } from \"@tanstack/react-query\";\nimport { useNavigate } from \"react-router-dom\";\nimport { createPageUrl } from \"@/utils\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Label } from \"@/components/ui/label\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Users, Mail, Trash2, CheckCircle2, Clock, X } from \"lucide-react\";\nimport { Skeleton } from \"@/components/ui/skeleton\";\nimport { toast } from \"sonner\";\nimport PageHeader from \"../components/shared/PageHeader\";\nimport { useConfirm } from \"@/hooks/useConfirm\";\nimport { sendEmail } from \"@/services/emailService\";\nimport { useAutoTranslate } from \"@/hooks/useTranslate\";\n\nexport default function BusinessStaffPage() {\n  const navigate = useNavigate();\n  const queryClient = useQueryClient();\n  const [user, setUser] = useState(null);\n  const [showInviteForm, setShowInviteForm] = useState(false);\n  const [inviteEmail, setInviteEmail] = useState(\"\");\n  const { confirm, ConfirmDialog } = useConfirm();\n\n  const txtTeamManagement = useAutoTranslate('Gestão da Equipa', 'pt');\n  const txtInviteEmployee = useAutoTranslate('Convidar Funcionário', 'pt');\n  const txtInviteTeamMember = useAutoTranslate('Convide funcionários para gerir a conta em conjunto', 'pt');\n  const txtInviteSentSuccess = useAutoTranslate('Convite enviado com sucesso!', 'pt');\n  const txtErrorSendingInvite = useAutoTranslate('Erro ao enviar convite', 'pt');\n  const txtInviteRevokedSuccess = useAutoTranslate('Convite revogado com sucesso', 'pt');\n  const txtMemberRemovedSuccess = useAutoTranslate('Membro removido com sucesso', 'pt');\n  const txtInvalidEmail = useAutoTranslate('Email inválido', 'pt');\n  const txtNewInvite = useAutoTranslate('Novo Convite', 'pt');\n  const txtEmployeeEmail = useAutoTranslate('Email do Funcionário', 'pt');\n  const txtFullAccess = useAutoTranslate('O funcionário terá acesso total à gestão da conta', 'pt');\n  const txtCancel = useAutoTranslate('Cancelar', 'pt');\n  const txtSending = useAutoTranslate('A enviar...', 'pt');\n  const txtSendInvite = useAutoTranslate('Enviar Convite', 'pt');\n  const txtPendingInvites = useAutoTranslate('Convites Pendentes', 'pt');\n  const txtFullManagementAccess = useAutoTranslate('Acesso total à gestão', 'pt');\n  const txtActiveEmployees = useAutoTranslate('Funcionários Ativos', 'pt');\n  const txtNoEmployees = useAutoTranslate('Nenhum funcionário', 'pt');\n  const txtInviteHelp = useAutoTranslate('Convide funcionários para ajudar na gestão', 'pt');\n  const txtInviteFirstEmployee = useAutoTranslate('Convidar Primeiro Funcionário', 'pt');\n\n  useEffect(() => {\n    base44.auth.me().then(userData => {\n      setUser(userData);\n      if (!userData.is_business_user || !userData.business_id) {\n        navigate(createPageUrl(\"Home\"));\n      }\n    }).catch(() => base44.auth.redirectToLogin());\n  }, [navigate]);\n\n  const { data: business } = useQuery({\n    queryKey: ['business', user?.business_id],\n    queryFn: async () => {\n      const businesses = await base44.entities.Business.filter({ id: user.business_id });\n      return businesses[0];\n    },\n    enabled: !!user?.business_id,\n  });\n\n  const { data: staffMembers, isLoading } = useQuery({\n    queryKey: ['staff-members', user?.business_id],\n    queryFn: async () => {\n      const users = await base44.entities.User.filter({\n        business_id: user.business_id,\n        is_staff_member: true\n      });\n      return users;\n    },\n    initialData: [],\n    enabled: !!user?.business_id,\n  });\n\n  const { data: invites } = useQuery({\n    queryKey: ['staff-invites', user?.business_id],\n    queryFn: () => base44.entities.StaffInvite.filter({\n      business_id: user.business_id,\n      status: \"pendente\"\n    }),\n    initialData: [],\n    enabled: !!user?.business_id,\n  });\n\n  const inviteStaffMutation = useMutation({\n    mutationFn: async () => {\n      try {\n        console.log('🔄 Iniciando convite para:', inviteEmail);\n        \n        // Garantir que temos o business carregado\n        let businessData = business;\n        if (!businessData) {\n          console.log('📦 Carregando dados da empresa...');\n          const businesses = await base44.entities.Business.filter({ id: user.business_id });\n          businessData = businesses[0];\n          console.log('✅ Empresa carregada:', businessData?.name);\n        }\n\n        const token = Math.random().toString(36).substring(2, 15) + Math.random().toString(36).substring(2, 15);\n        const expiresAt = new Date();\n        expiresAt.setDate(expiresAt.getDate() + 7);\n\n        console.log('💾 Criando convite na base de dados...');\n        const invite = await base44.entities.StaffInvite.create({\n          business_id: user.business_id,\n          email: inviteEmail,\n          permissions: null,\n          token: token,\n          status: \"pendente\",\n          expires_at: expiresAt.toISOString(),\n          invited_by: user.email\n        });\n        console.log('✅ Convite criado:', invite.id);\n\n        const inviteUrl = `${window.location.origin}${createPageUrl(`StaffInviteAccept?token=${token}`)}`;\n\n        console.log('📧 Enviando email para:', inviteEmail);\n        const emailResult = await sendEmail({\n          to: inviteEmail,\n          subject: `Convite para Equipa - ${businessData?.name || 'Empresa'}`,\n          body: `Olá!\\n\\nFoi convidado para fazer parte da equipa de ${businessData?.name || 'a empresa'}.\\n\\nTerá acesso total à gestão da conta, incluindo senhas, marcações e serviços.\\n\\nClique para aceitar: ${inviteUrl}\\n\\nO convite expira em 7 dias.`\n        });\n        console.log('📬 Resultado do email:', emailResult);\n\n        if (!emailResult.success) {\n          throw new Error(emailResult.error || 'Erro ao enviar email');\n        }\n\n        console.log('✅ Convite enviado com sucesso!');\n        return invite;\n      } catch (error) {\n        console.error('❌ Erro detalhado ao enviar convite:', error);\n        throw error;\n      }\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['staff-invites'] });\n      setShowInviteForm(false);\n      setInviteEmail(\"\");\n      toast.success(txtInviteSentSuccess);\n    },\n    onError: (error) => {\n      console.error('Erro ao enviar convite:', error);\n      toast.error(error.message || txtErrorSendingInvite);\n    }\n  });\n\n  const deleteInviteMutation = useMutation({\n    mutationFn: (inviteId) => base44.entities.StaffInvite.delete(inviteId),\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['staff-invites'] });\n      toast.success(txtInviteRevokedSuccess);\n    },\n  });\n\n  const removeStaffMutation = useMutation({\n    mutationFn: async (staffId) => {\n      await base44.entities.User.update(staffId, {\n        is_staff_member: false,\n        business_id: null,\n        staff_permissions: null\n      });\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['staff-members'] });\n      toast.success(txtMemberRemovedSuccess);\n    },\n  });\n\n  const handleInvite = () => {\n    if (!inviteEmail || !inviteEmail.includes('@')) {\n      toast.error(txtInvalidEmail);\n      return;\n    }\n\n    inviteStaffMutation.mutate();\n  };\n\n  if (!user || isLoading) {\n    return (\n      <div className=\"bg-gradient-to-br from-slate-50 via-blue-50 to-sky-50 p-4\">\n        <div className=\"max-w-6xl mx-auto\">\n          <Skeleton className=\"h-16 w-64 mb-8\" />\n          <Skeleton className=\"h-96 w-full\" />\n        </div>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"bg-gradient-to-br from-slate-50 via-blue-50 to-sky-50\">\n      <div className=\"max-w-6xl mx-auto px-4 py-4\">\n        <PageHeader\n          title={txtTeamManagement}\n          subtitle={txtInviteTeamMember}\n          backTo=\"BusinessSettings\"\n          actions={\n            <Button onClick={() => setShowInviteForm(!showInviteForm)} className=\"gap-2\">\n              <Mail className=\"w-4 h-4\" />\n              {txtInviteEmployee}\n            </Button>\n          }\n        />\n\n        {showInviteForm && (\n          <Card className=\"border-0 shadow-xl mb-8\">\n            <CardHeader>\n              <div className=\"flex justify-between items-center\">\n                <CardTitle>{txtNewInvite}</CardTitle>\n                <Button variant=\"ghost\" size=\"icon\" onClick={() => setShowInviteForm(false)}>\n                  <X className=\"w-4 h-4\" />\n                </Button>\n              </div>\n            </CardHeader>\n            <CardContent className=\"space-y-6\">\n              <div>\n                <Label htmlFor=\"email\">{txtEmployeeEmail}</Label>\n                <Input\n                  id=\"email\"\n                  type=\"text\"\n                  inputMode=\"email\"\n                  value={inviteEmail}\n                  onChange={(e) => setInviteEmail(e.target.value)}\n                  placeholder=\"funcionario@exemplo.com\"\n                  className=\"mb-2\"\n                  autoComplete=\"off\"\n                />\n                <p className=\"text-xs text-slate-600\">\n                  {txtFullAccess}\n                </p>\n              </div>\n\n              <div className=\"flex gap-3 justify-end pt-4\">\n                <Button variant=\"outline\" onClick={() => setShowInviteForm(false)}>\n                  {txtCancel}\n                </Button>\n                <Button \n                  onClick={handleInvite}\n                  disabled={inviteStaffMutation.isPending}\n                >\n                  {inviteStaffMutation.isPending ? txtSending : txtSendInvite}\n                </Button>\n              </div>\n            </CardContent>\n          </Card>\n        )}\n\n        {invites.length > 0 && (\n          <Card className=\"border-0 shadow-lg mb-8\">\n            <CardHeader>\n              <CardTitle className=\"flex items-center gap-2\">\n                <Clock className=\"w-5 h-5\" />\n                {txtPendingInvites}\n              </CardTitle>\n            </CardHeader>\n            <CardContent>\n              <div className=\"space-y-3\">\n                {invites.map(invite => (\n                  <div key={invite.id} className=\"flex items-center justify-between p-4 bg-amber-50 rounded-lg border border-amber-200\">\n                    <div className=\"flex-1\">\n                      <p className=\"font-semibold text-slate-900\">{invite.email}</p>\n                      <p className=\"text-xs text-slate-600 mt-1\">{txtFullManagementAccess}</p>\n                    </div>\n                    <Button\n                      variant=\"ghost\"\n                      size=\"sm\"\n                      className=\"text-red-600 hover:text-red-700 hover:bg-red-50\"\n                      onClick={() => deleteInviteMutation.mutate(invite.id)}\n                    >\n                      <Trash2 className=\"w-4 h-4\" />\n                    </Button>\n                  </div>\n                ))}\n              </div>\n            </CardContent>\n          </Card>\n        )}\n\n        <Card className=\"border-0 shadow-lg\">\n          <CardHeader>\n            <CardTitle className=\"flex items-center gap-2\">\n              <Users className=\"w-5 h-5\" />\n              {txtActiveEmployees} ({staffMembers.length})\n            </CardTitle>\n          </CardHeader>\n          <CardContent>\n            {staffMembers.length === 0 ? (\n              <div className=\"text-center py-12\">\n                <Users className=\"w-16 h-16 text-slate-300 mx-auto mb-4\" />\n                <h3 className=\"text-lg font-semibold text-slate-900 mb-2\">\n                  {txtNoEmployees}\n                </h3>\n                <p className=\"text-slate-600 mb-6\">\n                  {txtInviteHelp}\n                </p>\n                <Button onClick={() => setShowInviteForm(true)}>\n                  <Mail className=\"w-4 h-4 mr-2\" />\n                  {txtInviteFirstEmployee}\n                </Button>\n              </div>\n            ) : (\n              <div className=\"grid md:grid-cols-2 gap-6\">\n                {staffMembers.map(member => (\n                  <Card key={member.id} className=\"border shadow-sm\">\n                    <CardContent className=\"p-6\">\n                      <div className=\"flex items-start justify-between mb-6\">\n                        <div>\n                          <h4 className=\"font-bold text-slate-900 mb-1\">\n                            {member.full_name || 'Sem nome'}\n                          </h4>\n                          <p className=\"text-sm text-slate-600\">{member.email}</p>\n                          <p className=\"text-xs text-slate-500 mt-1\">Acesso total à gestão</p>\n                        </div>\n                        <Badge className=\"bg-green-100 text-green-700 border-green-200\">\n                          <CheckCircle2 className=\"w-3 h-3 mr-1\" />\n                          Ativo\n                        </Badge>\n                      </div>\n\n                      <Button\n                        variant=\"outline\"\n                        size=\"sm\"\n                        className=\"w-full border-red-200 text-red-600 hover:bg-red-50\"\n                        onClick={async () => {\n                          const confirmed = await confirm({\n                            title: 'Remover Membro',\n                            description: `Tem certeza que deseja remover ${member.full_name || member.email} da equipa? Esta ação não pode ser desfeita.`,\n                          });\n                          if (confirmed) {\n                            removeStaffMutation.mutate(member.id);\n                          }\n                        }}\n                      >\n                        <Trash2 className=\"w-4 h-4 mr-2\" />\n                        Remover da Equipa\n                      </Button>\n                    </CardContent>\n                  </Card>\n                ))}\n              </div>\n            )}\n          </CardContent>\n        </Card>\n      </div>\n      <ConfirmDialog />\n    </div>\n  );\n}","path":null,"size_bytes":14091,"size_tokens":null},"src/components/business/AIAnalytics.jsx":{"content":"import React, { useState } from \"react\";\nimport { base44 } from \"@/api/base44Client\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { \n  Brain, \n  Sparkles, \n  TrendingUp, \n  Users, \n  Clock, \n  AlertCircle,\n  CheckCircle2,\n  Zap,\n  Calendar,\n  Target,\n  Activity,\n  Loader2\n} from \"lucide-react\";\n\nexport default function AIAnalytics({ tickets, queues, business }) {\n  const [insights, setInsights] = useState(null);\n  const [loading, setLoading] = useState(false);\n\n  const generateInsights = async () => {\n    setLoading(true);\n    \n    try {\n      // Prepare historical data for AI analysis\n      const historicalData = {\n        business_name: business.name,\n        business_category: business.category,\n        total_tickets: tickets.length,\n        queues: queues.map(q => ({\n          name: q.name,\n          average_service_time: q.average_service_time,\n          max_capacity: q.max_capacity,\n          status: q.status\n        })),\n        ticket_stats: {\n          total: tickets.length,\n          completed: tickets.filter(t => t.status === 'concluido').length,\n          cancelled: tickets.filter(t => t.status === 'cancelado').length,\n          active: tickets.filter(t => ['aguardando', 'chamado', 'atendendo'].includes(t.status)).length\n        },\n        hourly_distribution: calculateHourlyDistribution(),\n        daily_distribution: calculateDailyDistribution(),\n        avg_wait_time: calculateAvgWaitTime(),\n        avg_rating: calculateAvgRating(),\n        peak_hours: findPeakHours(),\n        busiest_days: findBusiestDays()\n      };\n\n      // Call AI for deep insights\n      const result = await base44.integrations.Core.InvokeLLM({\n        prompt: `Você é um consultor especialista em gestão de filas e otimização de atendimento ao cliente. \n        \nAnalise os seguintes dados históricos de uma empresa:\n\n${JSON.stringify(historicalData, null, 2)}\n\nForneça uma análise profunda e acionável com:\n\n1. **peak_hours_analysis**: Análise detalhada dos horários de pico e padrões\n2. **optimal_staffing**: Recomendações específicas de número de funcionários por horário\n3. **flow_optimization**: Sugestões para melhorar o fluxo de clientes\n4. **customer_satisfaction**: Insights sobre satisfação e como melhorar\n5. **forecasting**: Previsões para próxima semana com números específicos\n6. **action_items**: Lista de 5 ações prioritárias e imediatas\n\nSeja específico com números, horários e recomendações práticas.`,\n        response_json_schema: {\n          type: \"object\",\n          properties: {\n            peak_hours_analysis: {\n              type: \"object\",\n              properties: {\n                summary: { type: \"string\" },\n                peak_periods: {\n                  type: \"array\",\n                  items: {\n                    type: \"object\",\n                    properties: {\n                      time_range: { type: \"string\" },\n                      expected_volume: { type: \"string\" },\n                      recommendation: { type: \"string\" }\n                    }\n                  }\n                }\n              }\n            },\n            optimal_staffing: {\n              type: \"object\",\n              properties: {\n                summary: { type: \"string\" },\n                recommendations: {\n                  type: \"array\",\n                  items: {\n                    type: \"object\",\n                    properties: {\n                      time_range: { type: \"string\" },\n                      staff_needed: { type: \"string\" },\n                      rationale: { type: \"string\" }\n                    }\n                  }\n                }\n              }\n            },\n            flow_optimization: {\n              type: \"object\",\n              properties: {\n                summary: { type: \"string\" },\n                suggestions: {\n                  type: \"array\",\n                  items: {\n                    type: \"object\",\n                    properties: {\n                      area: { type: \"string\" },\n                      issue: { type: \"string\" },\n                      solution: { type: \"string\" },\n                      impact: { type: \"string\" }\n                    }\n                  }\n                }\n              }\n            },\n            customer_satisfaction: {\n              type: \"object\",\n              properties: {\n                current_score: { type: \"string\" },\n                analysis: { type: \"string\" },\n                improvement_areas: {\n                  type: \"array\",\n                  items: {\n                    type: \"object\",\n                    properties: {\n                      metric: { type: \"string\" },\n                      current_value: { type: \"string\" },\n                      target_value: { type: \"string\" },\n                      action: { type: \"string\" }\n                    }\n                  }\n                }\n              }\n            },\n            forecasting: {\n              type: \"object\",\n              properties: {\n                next_week_prediction: { type: \"string\" },\n                daily_breakdown: {\n                  type: \"array\",\n                  items: {\n                    type: \"object\",\n                    properties: {\n                      day: { type: \"string\" },\n                      expected_tickets: { type: \"string\" },\n                      confidence: { type: \"string\" }\n                    }\n                  }\n                },\n                trends: { type: \"string\" }\n              }\n            },\n            action_items: {\n              type: \"array\",\n              items: {\n                type: \"object\",\n                properties: {\n                  priority: { type: \"string\" },\n                  action: { type: \"string\" },\n                  expected_impact: { type: \"string\" },\n                  implementation_time: { type: \"string\" }\n                }\n              }\n            }\n          }\n        }\n      });\n\n      setInsights(result);\n    } catch (error) {\n      console.error('Error generating AI insights:', error);\n    } finally {\n      setLoading(false);\n    }\n  };\n\n  const calculateHourlyDistribution = () => {\n    const dist = Array(24).fill(0);\n    tickets.forEach(t => {\n      const hour = new Date(t.created_date).getHours();\n      dist[hour]++;\n    });\n    return dist;\n  };\n\n  const calculateDailyDistribution = () => {\n    const dist = Array(7).fill(0);\n    tickets.forEach(t => {\n      const day = new Date(t.created_date).getDay();\n      dist[day]++;\n    });\n    return dist;\n  };\n\n  const calculateAvgWaitTime = () => {\n    const withTime = tickets.filter(t => t.called_at && t.created_date);\n    if (withTime.length === 0) return 0;\n    const total = withTime.reduce((sum, t) => {\n      return sum + (new Date(t.called_at) - new Date(t.created_date)) / (1000 * 60);\n    }, 0);\n    return Math.round(total / withTime.length);\n  };\n\n  const calculateAvgRating = () => {\n    const rated = tickets.filter(t => t.rating);\n    if (rated.length === 0) return 0;\n    return (rated.reduce((sum, t) => sum + t.rating, 0) / rated.length).toFixed(1);\n  };\n\n  const findPeakHours = () => {\n    const dist = calculateHourlyDistribution();\n    const max = Math.max(...dist);\n    return dist\n      .map((count, hour) => ({ hour, count }))\n      .filter(h => h.count >= max * 0.8)\n      .map(h => `${h.hour}:00-${h.hour + 1}:00`);\n  };\n\n  const findBusiestDays = () => {\n    const days = ['Domingo', 'Segunda', 'Terça', 'Quarta', 'Quinta', 'Sexta', 'Sábado'];\n    const dist = calculateDailyDistribution();\n    return dist\n      .map((count, day) => ({ day: days[day], count }))\n      .sort((a, b) => b.count - a.count)\n      .slice(0, 3)\n      .map(d => d.day);\n  };\n\n  if (tickets.length < 10) {\n    return (\n      <Card className=\"border-0 shadow-lg bg-gradient-to-br from-purple-50 to-pink-50\">\n        <CardContent className=\"p-12 text-center\">\n          <Brain className=\"w-16 h-16 text-purple-300 mx-auto mb-4\" />\n          <h3 className=\"text-xl font-bold text-slate-900 mb-2\">\n            Analytics com IA Não Disponível\n          </h3>\n          <p className=\"text-slate-600\">\n            Colete pelo menos 10 senhas para desbloquear análises avançadas com IA\n          </p>\n        </CardContent>\n      </Card>\n    );\n  }\n\n  return (\n    <div className=\"space-y-6\">\n      <Card className=\"border-0 shadow-xl bg-gradient-to-br from-purple-600 via-pink-600 to-purple-700 text-white overflow-hidden\">\n        <div className=\"absolute top-0 right-0 w-64 h-64 bg-white/10 rounded-full -mr-32 -mt-32\" />\n        <div className=\"absolute bottom-0 left-0 w-48 h-48 bg-white/10 rounded-full -ml-24 -mb-24\" />\n        \n        <CardContent className=\"relative p-8\">\n          <div className=\"flex items-start justify-between mb-6\">\n            <div className=\"flex items-center gap-3\">\n              <div className=\"w-14 h-14 rounded-2xl bg-white/20 backdrop-blur-sm flex items-center justify-center\">\n                <Sparkles className=\"w-7 h-7\" />\n              </div>\n              <div>\n                <h2 className=\"text-2xl font-bold mb-1\">Analytics com IA Avançada</h2>\n                <p className=\"text-purple-100\">Insights profundos para otimizar seu negócio</p>\n              </div>\n            </div>\n          </div>\n\n          <div className=\"grid md:grid-cols-3 gap-4 mb-6\">\n            <div className=\"p-4 bg-white/10 backdrop-blur-sm rounded-xl\">\n              <Users className=\"w-5 h-5 mb-2\" />\n              <div className=\"text-2xl font-bold\">{tickets.length}</div>\n              <div className=\"text-sm text-purple-100\">Total de Senhas</div>\n            </div>\n            <div className=\"p-4 bg-white/10 backdrop-blur-sm rounded-xl\">\n              <Clock className=\"w-5 h-5 mb-2\" />\n              <div className=\"text-2xl font-bold\">{calculateAvgWaitTime()}min</div>\n              <div className=\"text-sm text-purple-100\">Tempo Médio</div>\n            </div>\n            <div className=\"p-4 bg-white/10 backdrop-blur-sm rounded-xl\">\n              <Activity className=\"w-5 h-5 mb-2\" />\n              <div className=\"text-2xl font-bold\">{calculateAvgRating()}/5</div>\n              <div className=\"text-sm text-purple-100\">Satisfação</div>\n            </div>\n          </div>\n\n          <Button\n            onClick={generateInsights}\n            disabled={loading}\n            className=\"w-full bg-white text-purple-600 hover:bg-purple-50 font-semibold py-6 text-lg\"\n          >\n            {loading ? (\n              <>\n                <Loader2 className=\"w-5 h-5 mr-2 animate-spin\" />\n                Analisando com IA...\n              </>\n            ) : (\n              <>\n                <Brain className=\"w-5 h-5 mr-2\" />\n                Gerar Análise com IA\n              </>\n            )}\n          </Button>\n        </CardContent>\n      </Card>\n\n      {insights && (\n        <>\n          {/* Peak Hours Analysis */}\n          <Card className=\"border-0 shadow-lg\">\n            <CardHeader>\n              <CardTitle className=\"flex items-center gap-2\">\n                <Clock className=\"w-5 h-5 text-purple-600\" />\n                Análise de Horários de Pico\n              </CardTitle>\n            </CardHeader>\n            <CardContent className=\"space-y-4\">\n              <p className=\"text-slate-700 leading-relaxed\">{insights.peak_hours_analysis.summary}</p>\n              <div className=\"grid gap-3\">\n                {insights.peak_hours_analysis.peak_periods.map((period, idx) => (\n                  <div key={idx} className=\"p-4 bg-gradient-to-r from-purple-50 to-pink-50 rounded-xl\">\n                    <div className=\"flex items-start justify-between mb-2\">\n                      <div className=\"flex items-center gap-2\">\n                        <Badge className=\"bg-purple-600 text-white\">{period.time_range}</Badge>\n                        <span className=\"text-sm font-medium text-slate-600\">{period.expected_volume}</span>\n                      </div>\n                    </div>\n                    <p className=\"text-sm text-slate-700\">{period.recommendation}</p>\n                  </div>\n                ))}\n              </div>\n            </CardContent>\n          </Card>\n\n          {/* Optimal Staffing */}\n          <Card className=\"border-0 shadow-lg\">\n            <CardHeader>\n              <CardTitle className=\"flex items-center gap-2\">\n                <Users className=\"w-5 h-5 text-blue-600\" />\n                Dimensionamento de Equipa\n              </CardTitle>\n            </CardHeader>\n            <CardContent className=\"space-y-4\">\n              <p className=\"text-slate-700 leading-relaxed\">{insights.optimal_staffing.summary}</p>\n              <div className=\"space-y-3\">\n                {insights.optimal_staffing.recommendations.map((rec, idx) => (\n                  <div key={idx} className=\"p-4 bg-blue-50 rounded-xl border-l-4 border-blue-500\">\n                    <div className=\"flex items-center gap-3 mb-2\">\n                      <Badge className=\"bg-blue-600 text-white\">{rec.time_range}</Badge>\n                      <span className=\"font-bold text-blue-900\">{rec.staff_needed}</span>\n                    </div>\n                    <p className=\"text-sm text-slate-700\">{rec.rationale}</p>\n                  </div>\n                ))}\n              </div>\n            </CardContent>\n          </Card>\n\n          {/* Flow Optimization */}\n          <Card className=\"border-0 shadow-lg\">\n            <CardHeader>\n              <CardTitle className=\"flex items-center gap-2\">\n                <Zap className=\"w-5 h-5 text-amber-600\" />\n                Otimização de Fluxo\n              </CardTitle>\n            </CardHeader>\n            <CardContent className=\"space-y-4\">\n              <p className=\"text-slate-700 leading-relaxed\">{insights.flow_optimization.summary}</p>\n              <div className=\"grid gap-4\">\n                {insights.flow_optimization.suggestions.map((sug, idx) => (\n                  <div key={idx} className=\"p-5 bg-gradient-to-br from-amber-50 to-orange-50 rounded-xl border border-amber-200\">\n                    <div className=\"flex items-start gap-3\">\n                      <div className=\"w-10 h-10 rounded-lg bg-amber-500 flex items-center justify-center flex-shrink-0\">\n                        <Target className=\"w-5 h-5 text-white\" />\n                      </div>\n                      <div className=\"flex-1\">\n                        <h4 className=\"font-bold text-slate-900 mb-1\">{sug.area}</h4>\n                        <p className=\"text-sm text-slate-700 mb-2\">\n                          <span className=\"font-medium\">Problema:</span> {sug.issue}\n                        </p>\n                        <p className=\"text-sm text-slate-700 mb-2\">\n                          <span className=\"font-medium\">Solução:</span> {sug.solution}\n                        </p>\n                        <Badge className=\"bg-green-100 text-green-700 border-green-200\">\n                          Impacto: {sug.impact}\n                        </Badge>\n                      </div>\n                    </div>\n                  </div>\n                ))}\n              </div>\n            </CardContent>\n          </Card>\n\n          {/* Customer Satisfaction */}\n          <Card className=\"border-0 shadow-lg\">\n            <CardHeader>\n              <CardTitle className=\"flex items-center gap-2\">\n                <Activity className=\"w-5 h-5 text-green-600\" />\n                Análise de Satisfação\n              </CardTitle>\n            </CardHeader>\n            <CardContent className=\"space-y-4\">\n              <div className=\"p-4 bg-green-50 rounded-xl\">\n                <div className=\"text-3xl font-bold text-green-700 mb-1\">\n                  {insights.customer_satisfaction.current_score}\n                </div>\n                <p className=\"text-sm text-slate-600\">Score Atual</p>\n              </div>\n              <p className=\"text-slate-700 leading-relaxed\">{insights.customer_satisfaction.analysis}</p>\n              <div className=\"space-y-3\">\n                {insights.customer_satisfaction.improvement_areas.map((area, idx) => (\n                  <div key={idx} className=\"p-4 bg-slate-50 rounded-xl\">\n                    <div className=\"flex items-center justify-between mb-2\">\n                      <span className=\"font-bold text-slate-900\">{area.metric}</span>\n                      <div className=\"flex gap-2\">\n                        <Badge variant=\"outline\">{area.current_value}</Badge>\n                        <span className=\"text-slate-400\">→</span>\n                        <Badge className=\"bg-green-100 text-green-700\">{area.target_value}</Badge>\n                      </div>\n                    </div>\n                    <p className=\"text-sm text-slate-700\">{area.action}</p>\n                  </div>\n                ))}\n              </div>\n            </CardContent>\n          </Card>\n\n          {/* Forecasting */}\n          <Card className=\"border-0 shadow-lg bg-gradient-to-br from-indigo-50 to-purple-50\">\n            <CardHeader>\n              <CardTitle className=\"flex items-center gap-2\">\n                <TrendingUp className=\"w-5 h-5 text-indigo-600\" />\n                Previsão Próxima Semana\n              </CardTitle>\n            </CardHeader>\n            <CardContent className=\"space-y-4\">\n              <div className=\"p-4 bg-white rounded-xl border-2 border-indigo-200\">\n                <p className=\"font-bold text-indigo-900 mb-2\">{insights.forecasting.next_week_prediction}</p>\n                <p className=\"text-sm text-slate-600\">{insights.forecasting.trends}</p>\n              </div>\n              <div className=\"grid md:grid-cols-2 gap-3\">\n                {insights.forecasting.daily_breakdown.map((day, idx) => (\n                  <div key={idx} className=\"p-4 bg-white rounded-xl\">\n                    <div className=\"flex items-center justify-between\">\n                      <span className=\"font-medium text-slate-900\">{day.day}</span>\n                      <Badge className=\"bg-indigo-100 text-indigo-700\">{day.expected_tickets}</Badge>\n                    </div>\n                    <p className=\"text-xs text-slate-500 mt-1\">Confiança: {day.confidence}</p>\n                  </div>\n                ))}\n              </div>\n            </CardContent>\n          </Card>\n\n          {/* Action Items */}\n          <Card className=\"border-0 shadow-lg border-2 border-amber-200\">\n            <CardHeader className=\"bg-gradient-to-r from-amber-50 to-orange-50\">\n              <CardTitle className=\"flex items-center gap-2\">\n                <CheckCircle2 className=\"w-5 h-5 text-amber-600\" />\n                Ações Prioritárias\n              </CardTitle>\n            </CardHeader>\n            <CardContent className=\"p-6\">\n              <div className=\"space-y-4\">\n                {insights.action_items.map((item, idx) => (\n                  <div key={idx} className=\"flex gap-4 p-4 bg-white rounded-xl border border-slate-200 hover:shadow-md transition-shadow\">\n                    <div className=\"flex-shrink-0\">\n                      <div className={`w-10 h-10 rounded-lg flex items-center justify-center font-bold text-white ${\n                        item.priority === 'Alta' ? 'bg-red-500' :\n                        item.priority === 'Média' ? 'bg-amber-500' : 'bg-blue-500'\n                      }`}>\n                        {idx + 1}\n                      </div>\n                    </div>\n                    <div className=\"flex-1\">\n                      <div className=\"flex items-center gap-2 mb-2\">\n                        <Badge className={\n                          item.priority === 'Alta' ? 'bg-red-100 text-red-700' :\n                          item.priority === 'Média' ? 'bg-amber-100 text-amber-700' :\n                          'bg-blue-100 text-blue-700'\n                        }>\n                          {item.priority}\n                        </Badge>\n                        <span className=\"text-xs text-slate-500\">{item.implementation_time}</span>\n                      </div>\n                      <p className=\"font-medium text-slate-900 mb-2\">{item.action}</p>\n                      <p className=\"text-sm text-slate-600\">\n                        <span className=\"font-medium\">Impacto esperado:</span> {item.expected_impact}\n                      </p>\n                    </div>\n                  </div>\n                ))}\n              </div>\n            </CardContent>\n          </Card>\n        </>\n      )}\n    </div>\n  );\n}","path":null,"size_bytes":20613,"size_tokens":null},"src/components/business/Reviews.jsx":{"content":"import React, { useState } from \"react\";\nimport { base44 } from \"@/api/base44Client\";\nimport { useQuery, useMutation, useQueryClient } from \"@tanstack/react-query\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport { Star, MessageSquare, CheckCircle2 } from \"lucide-react\";\nimport { Skeleton } from \"@/components/ui/skeleton\";\nimport { toast } from \"sonner\";\nimport { useAutoTranslate } from \"@/hooks/useTranslate\";\n\nexport default function Reviews({ business, user }) {\n  // Traduções\n  const txtReviews = useAutoTranslate('Avaliações', 'pt');\n  const txtReview = useAutoTranslate('avaliação', 'pt');\n  const txtReviewsPlural = useAutoTranslate('avaliações', 'pt');\n  const txtLeaveReview = useAutoTranslate('Deixar Avaliação', 'pt');\n  const txtYourReview = useAutoTranslate('A Sua Avaliação', 'pt');\n  const txtSelectRating = useAutoTranslate('Selecione uma Avaliação', 'pt');\n  const txtComment = useAutoTranslate('Comentário (opcional)', 'pt');\n  const txtSubmit = useAutoTranslate('Enviar', 'pt');\n  const txtCancel = useAutoTranslate('Cancelar', 'pt');\n  const txtReviewSent = useAutoTranslate('Avaliação enviada com sucesso!', 'pt');\n  const txtPleaseSelectRating = useAutoTranslate('Por favor, selecione uma avaliação', 'pt');\n  const txtNoReviews = useAutoTranslate('Nenhuma avaliação ainda', 'pt');\n  const txtFirstReview = useAutoTranslate('Seja o primeiro a avaliar!', 'pt');\n  const [showForm, setShowForm] = useState(false);\n  const [rating, setRating] = useState(0);\n  const [hoveredRating, setHoveredRating] = useState(0);\n  const [comment, setComment] = useState(\"\");\n  const queryClient = useQueryClient();\n\n  const { data: reviews, isLoading } = useQuery({\n    queryKey: ['reviews', business.id],\n    queryFn: () => base44.entities.Review.filter({ business_id: business.id }, '-created_date'),\n    initialData: [],\n  });\n\n  const { data: userReview } = useQuery({\n    queryKey: ['user-review', business.id, user?.email],\n    queryFn: async () => {\n      if (!user) return null;\n      const userReviews = await base44.entities.Review.filter({\n        business_id: business.id,\n        user_email: user.email\n      });\n      return userReviews[0] || null;\n    },\n    enabled: !!user,\n  });\n\n  const createReviewMutation = useMutation({\n    mutationFn: async (data) => {\n      if (!user) {\n        base44.auth.redirectToLogin(window.location.href);\n        return;\n      }\n      return await base44.entities.Review.create({\n        business_id: business.id,\n        user_email: user.email,\n        user_name: user.full_name || user.email.split('@')[0],\n        rating: data.rating,\n        comment: data.comment,\n        is_verified: false\n      });\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['reviews', business.id] });\n      queryClient.invalidateQueries({ queryKey: ['user-review', business.id, user?.email] });\n      setShowForm(false);\n      setRating(0);\n      setComment(\"\");\n      toast.success(txtReviewSent);\n    },\n  });\n\n  const handleSubmit = (e) => {\n    e.preventDefault();\n    if (rating === 0) {\n      toast.error(txtPleaseSelectRating);\n      return;\n    }\n    createReviewMutation.mutate({ rating, comment });\n  };\n\n  const avgRating = reviews.length > 0 \n    ? (reviews.reduce((sum, r) => sum + r.rating, 0) / reviews.length).toFixed(1)\n    : business.rating || '4.8';\n\n  const ratingCounts = [5, 4, 3, 2, 1].map(stars => \n    reviews.filter(r => r.rating === stars).length\n  );\n\n  return (\n    <div className=\"space-y-2\">\n      <Card className=\"border-0 shadow-md\">\n        <CardHeader className=\"pb-2\">\n          <div className=\"flex items-center justify-between\">\n            <CardTitle className=\"text-sm flex items-center gap-1\">\n              <Star className=\"w-4 h-4 text-amber-500 fill-amber-500\" />\n              {txtReviews}\n            </CardTitle>\n            <div className=\"text-right\">\n              <div className=\"text-xl font-bold text-slate-900\">{avgRating}</div>\n              <div className=\"text-xs text-slate-500\">\n                {reviews.length} {reviews.length === 1 ? txtReview : txtReviewsPlural}\n              </div>\n            </div>\n          </div>\n        </CardHeader>\n        <CardContent>\n          <div className=\"space-y-1 mb-3\">\n            {ratingCounts.map((count, idx) => {\n              const stars = 5 - idx;\n              const percentage = reviews.length > 0 ? (count / reviews.length) * 100 : 0;\n              return (\n                <div key={stars} className=\"flex items-center gap-2 text-xs\">\n                  <span className=\"w-8 text-slate-600\">{stars} ★</span>\n                  <div className=\"flex-1 h-1.5 bg-slate-100 rounded-full overflow-hidden\">\n                    <div \n                      className=\"h-full bg-amber-400\"\n                      style={{ width: `${percentage}%` }}\n                    />\n                  </div>\n                  <span className=\"w-8 text-right text-slate-500\">{count}</span>\n                </div>\n              );\n            })}\n          </div>\n\n          {!user ? (\n            <Button \n              size=\"sm\" \n              variant=\"outline\" \n              className=\"w-full h-7 text-xs\"\n              onClick={() => base44.auth.redirectToLogin(window.location.href)}\n            >\n              Entrar para Avaliar\n            </Button>\n          ) : userReview ? (\n            <div className=\"p-2 bg-green-50 rounded-lg border border-green-200\">\n              <div className=\"flex items-center gap-1 mb-1\">\n                <CheckCircle2 className=\"w-3 h-3 text-green-600\" />\n                <span className=\"text-xs font-semibold text-green-900\">Já avaliou</span>\n              </div>\n              <div className=\"flex items-center gap-0.5 mb-1\">\n                {[1, 2, 3, 4, 5].map(star => (\n                  <Star\n                    key={star}\n                    className={`w-3 h-3 ${\n                      star <= userReview.rating\n                        ? 'text-amber-400 fill-amber-400'\n                        : 'text-slate-300'\n                    }`}\n                  />\n                ))}\n              </div>\n              {userReview.comment && (\n                <p className=\"text-xs text-slate-700\">{userReview.comment}</p>\n              )}\n            </div>\n          ) : showForm ? (\n            <form onSubmit={handleSubmit} className=\"space-y-2\">\n              <div>\n                <p className=\"text-xs text-slate-600 mb-1\">Sua avaliação:</p>\n                <div className=\"flex gap-0.5\">\n                  {[1, 2, 3, 4, 5].map(star => (\n                    <button\n                      key={star}\n                      type=\"button\"\n                      onClick={() => setRating(star)}\n                      onMouseEnter={() => setHoveredRating(star)}\n                      onMouseLeave={() => setHoveredRating(0)}\n                    >\n                      <Star\n                        className={`w-5 h-5 transition-all ${\n                          star <= (hoveredRating || rating)\n                            ? 'text-amber-400 fill-amber-400'\n                            : 'text-slate-300'\n                        }`}\n                      />\n                    </button>\n                  ))}\n                </div>\n              </div>\n              <Textarea\n                placeholder=\"Comente sua experiência (opcional)\"\n                value={comment}\n                onChange={(e) => setComment(e.target.value)}\n                className=\"text-xs h-16\"\n              />\n              <div className=\"flex gap-1\">\n                <Button \n                  type=\"button\" \n                  size=\"sm\" \n                  variant=\"outline\"\n                  className=\"flex-1 h-7 text-xs\"\n                  onClick={() => {\n                    setShowForm(false);\n                    setRating(0);\n                    setComment(\"\");\n                  }}\n                >\n                  Cancelar\n                </Button>\n                <Button \n                  type=\"submit\" \n                  size=\"sm\"\n                  className=\"flex-1 h-7 text-xs bg-gradient-to-r from-sky-500 to-blue-600\"\n                  disabled={createReviewMutation.isPending}\n                >\n                  {createReviewMutation.isPending ? 'Enviando...' : 'Enviar'}\n                </Button>\n              </div>\n            </form>\n          ) : (\n            <Button \n              size=\"sm\" \n              variant=\"outline\" \n              className=\"w-full h-7 text-xs\"\n              onClick={() => setShowForm(true)}\n            >\n              <MessageSquare className=\"w-3 h-3 mr-1\" />\n              Deixar Avaliação\n            </Button>\n          )}\n        </CardContent>\n      </Card>\n\n      {isLoading ? (\n        <div className=\"space-y-2\">\n          {[1, 2].map(i => (\n            <Skeleton key={i} className=\"h-20 w-full\" />\n          ))}\n        </div>\n      ) : reviews.length > 0 ? (\n        <div className=\"space-y-2\">\n          {reviews.map(review => (\n            <Card key={review.id} className=\"border-0 shadow-sm\">\n              <CardContent className=\"p-2\">\n                <div className=\"flex items-start justify-between mb-1\">\n                  <div>\n                    <p className=\"font-semibold text-xs text-slate-900\">\n                      {review.user_name}\n                    </p>\n                    <div className=\"flex items-center gap-0.5\">\n                      {[1, 2, 3, 4, 5].map(star => (\n                        <Star\n                          key={star}\n                          className={`w-2.5 h-2.5 ${\n                            star <= review.rating\n                              ? 'text-amber-400 fill-amber-400'\n                              : 'text-slate-300'\n                          }`}\n                        />\n                      ))}\n                    </div>\n                  </div>\n                  {review.is_verified && (\n                    <div className=\"flex items-center gap-0.5 px-1.5 py-0.5 bg-green-100 rounded text-xs text-green-700\">\n                      <CheckCircle2 className=\"w-2.5 h-2.5\" />\n                      <span>Verificado</span>\n                    </div>\n                  )}\n                </div>\n                {review.comment && (\n                  <p className=\"text-xs text-slate-700 leading-relaxed mb-2\">\n                    {review.comment}\n                  </p>\n                )}\n                {review.business_response && (\n                  <div className=\"p-2 bg-blue-50 rounded-lg border border-blue-200 mb-2\">\n                    <div className=\"flex items-center gap-1 mb-1\">\n                      <MessageSquare className=\"w-3 h-3 text-blue-600\" />\n                      <span className=\"text-xs font-semibold text-blue-900\">Resposta da empresa:</span>\n                    </div>\n                    <p className=\"text-xs text-blue-800\">{review.business_response}</p>\n                  </div>\n                )}\n                <p className=\"text-xs text-slate-400 mt-1\">\n                  {new Date(review.created_date).toLocaleDateString('pt-PT')}\n                </p>\n              </CardContent>\n            </Card>\n          ))}\n        </div>\n      ) : (\n        <Card className=\"border-0 shadow-sm\">\n          <CardContent className=\"py-6 text-center\">\n            <MessageSquare className=\"w-8 h-8 text-slate-300 mx-auto mb-2\" />\n            <p className=\"text-xs text-slate-600\">Ainda sem avaliações</p>\n          </CardContent>\n        </Card>\n      )}\n    </div>\n  );\n}","path":null,"size_bytes":11689,"size_tokens":null},"src/components/business/UserBehaviorAnalytics.jsx":{"content":"import React from \"react\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Users, Clock, TrendingUp, AlertCircle } from \"lucide-react\";\nimport { BarChart, Bar, XAxis, YAxis, CartesianGrid, Tooltip, ResponsiveContainer } from \"recharts\";\n\nexport default function UserBehaviorAnalytics({ tickets, completedTickets, cancelledTickets }) {\n  // Calculate user behavior metrics\n  const metrics = React.useMemo(() => {\n    // User frequency\n    const userFrequency = {};\n    tickets.forEach(ticket => {\n      if (ticket.user_email) {\n        userFrequency[ticket.user_email] = (userFrequency[ticket.user_email] || 0) + 1;\n      }\n    });\n\n    const uniqueUsers = Object.keys(userFrequency).length;\n    const repeatUsers = Object.values(userFrequency).filter(count => count > 1).length;\n    const repeatRate = uniqueUsers > 0 ? (repeatUsers / uniqueUsers * 100).toFixed(1) : 0;\n\n    // Average service time\n    const completedWithTime = completedTickets.filter(t => t.completed_at && t.called_at);\n    const avgServiceTime = completedWithTime.length > 0\n      ? Math.round(\n          completedWithTime.reduce((sum, t) => {\n            const time = (new Date(t.completed_at) - new Date(t.called_at)) / (1000 * 60);\n            return sum + time;\n          }, 0) / completedWithTime.length\n        )\n      : 0;\n\n    // Cancellation analysis\n    const cancelledWithReason = cancelledTickets.filter(t => t.position);\n    const avgCancellationPosition = cancelledWithReason.length > 0\n      ? Math.round(\n          cancelledWithReason.reduce((sum, t) => sum + (t.position || 0), 0) / cancelledWithReason.length\n        )\n      : 0;\n\n    // Peak waiting times\n    const waitTimes = completedTickets\n      .filter(t => t.called_at && t.created_date)\n      .map(t => ({\n        time: Math.round((new Date(t.called_at) - new Date(t.created_date)) / (1000 * 60)),\n        hour: new Date(t.created_date).getHours()\n      }));\n\n    const maxWaitTime = waitTimes.length > 0 ? Math.max(...waitTimes.map(w => w.time)) : 0;\n    const minWaitTime = waitTimes.length > 0 ? Math.min(...waitTimes.map(w => w.time)) : 0;\n\n    return {\n      uniqueUsers,\n      repeatUsers,\n      repeatRate,\n      avgServiceTime,\n      avgCancellationPosition,\n      maxWaitTime,\n      minWaitTime,\n      userFrequency\n    };\n  }, [tickets, completedTickets, cancelledTickets]);\n\n  // Top users data\n  const topUsersData = React.useMemo(() => {\n    return Object.entries(metrics.userFrequency)\n      .sort(([, a], [, b]) => b - a)\n      .slice(0, 10)\n      .map(([email, count]) => ({\n        email: email.split('@')[0],\n        visitas: count\n      }));\n  }, [metrics.userFrequency]);\n\n  // Wait time distribution\n  const waitTimeDistribution = React.useMemo(() => {\n    const ranges = {\n      '0-5 min': 0,\n      '5-10 min': 0,\n      '10-20 min': 0,\n      '20-30 min': 0,\n      '30+ min': 0\n    };\n\n    completedTickets.forEach(ticket => {\n      if (ticket.called_at && ticket.created_date) {\n        const wait = (new Date(ticket.called_at) - new Date(ticket.created_date)) / (1000 * 60);\n        if (wait <= 5) ranges['0-5 min']++;\n        else if (wait <= 10) ranges['5-10 min']++;\n        else if (wait <= 20) ranges['10-20 min']++;\n        else if (wait <= 30) ranges['20-30 min']++;\n        else ranges['30+ min']++;\n      }\n    });\n\n    return Object.entries(ranges).map(([range, count]) => ({\n      range,\n      count\n    }));\n  }, [completedTickets]);\n\n  return (\n    <>\n      {/* Behavior Metrics */}\n      <div className=\"grid md:grid-cols-2 lg:grid-cols-4 gap-6\">\n        <Card className=\"border-0 shadow-lg bg-gradient-to-br from-blue-50 to-sky-50\">\n          <CardContent className=\"p-6\">\n            <div className=\"flex items-center gap-3 mb-3\">\n              <Users className=\"w-8 h-8 text-blue-600\" />\n              <div>\n                <p className=\"text-sm text-slate-600\">Utilizadores Únicos</p>\n                <p className=\"text-3xl font-bold text-slate-900\">{metrics.uniqueUsers}</p>\n              </div>\n            </div>\n            <div className=\"text-xs text-slate-600\">\n              {metrics.repeatUsers} utilizadores recorrentes\n            </div>\n          </CardContent>\n        </Card>\n\n        <Card className=\"border-0 shadow-lg bg-gradient-to-br from-purple-50 to-pink-50\">\n          <CardContent className=\"p-6\">\n            <div className=\"flex items-center gap-3 mb-3\">\n              <TrendingUp className=\"w-8 h-8 text-purple-600\" />\n              <div>\n                <p className=\"text-sm text-slate-600\">Taxa de Retorno</p>\n                <p className=\"text-3xl font-bold text-slate-900\">{metrics.repeatRate}%</p>\n              </div>\n            </div>\n            <div className=\"text-xs text-slate-600\">\n              Clientes que voltaram\n            </div>\n          </CardContent>\n        </Card>\n\n        <Card className=\"border-0 shadow-lg bg-gradient-to-br from-green-50 to-emerald-50\">\n          <CardContent className=\"p-6\">\n            <div className=\"flex items-center gap-3 mb-3\">\n              <Clock className=\"w-8 h-8 text-green-600\" />\n              <div>\n                <p className=\"text-sm text-slate-600\">Tempo de Serviço</p>\n                <p className=\"text-3xl font-bold text-slate-900\">{metrics.avgServiceTime}<span className=\"text-lg\">m</span></p>\n              </div>\n            </div>\n            <div className=\"text-xs text-slate-600\">\n              Média de atendimento\n            </div>\n          </CardContent>\n        </Card>\n\n        <Card className=\"border-0 shadow-lg bg-gradient-to-br from-amber-50 to-orange-50\">\n          <CardContent className=\"p-6\">\n            <div className=\"flex items-center gap-3 mb-3\">\n              <AlertCircle className=\"w-8 h-8 text-amber-600\" />\n              <div>\n                <p className=\"text-sm text-slate-600\">Cancelamentos</p>\n                <p className=\"text-3xl font-bold text-slate-900\">{cancelledTickets.length}</p>\n              </div>\n            </div>\n            <div className=\"text-xs text-slate-600\">\n              Posição média: #{metrics.avgCancellationPosition}\n            </div>\n          </CardContent>\n        </Card>\n      </div>\n\n      <div className=\"grid md:grid-cols-2 gap-6\">\n        {/* Top Users */}\n        {topUsersData.length > 0 && (\n          <Card className=\"border-0 shadow-lg\">\n            <CardHeader>\n              <CardTitle className=\"flex items-center gap-2\">\n                <Users className=\"w-5 h-5\" />\n                Top 10 Utilizadores\n              </CardTitle>\n            </CardHeader>\n            <CardContent>\n              <ResponsiveContainer width=\"100%\" height={300}>\n                <BarChart data={topUsersData} layout=\"vertical\">\n                  <CartesianGrid strokeDasharray=\"3 3\" stroke=\"#e5e7eb\" />\n                  <XAxis type=\"number\" stroke=\"#64748b\" style={{ fontSize: '12px' }} />\n                  <YAxis \n                    type=\"category\" \n                    dataKey=\"email\" \n                    stroke=\"#64748b\" \n                    style={{ fontSize: '11px' }}\n                    width={100}\n                  />\n                  <Tooltip \n                    contentStyle={{ \n                      backgroundColor: '#fff', \n                      border: '1px solid #e5e7eb',\n                      borderRadius: '8px'\n                    }}\n                  />\n                  <Bar dataKey=\"visitas\" fill=\"#8b5cf6\" radius={[0, 8, 8, 0]} />\n                </BarChart>\n              </ResponsiveContainer>\n            </CardContent>\n          </Card>\n        )}\n\n        {/* Wait Time Distribution */}\n        <Card className=\"border-0 shadow-lg\">\n          <CardHeader>\n            <CardTitle className=\"flex items-center gap-2\">\n              <Clock className=\"w-5 h-5\" />\n              Distribuição de Tempo de Espera\n            </CardTitle>\n          </CardHeader>\n          <CardContent>\n            <ResponsiveContainer width=\"100%\" height={300}>\n              <BarChart data={waitTimeDistribution}>\n                <CartesianGrid strokeDasharray=\"3 3\" stroke=\"#e5e7eb\" />\n                <XAxis dataKey=\"range\" stroke=\"#64748b\" style={{ fontSize: '11px' }} />\n                <YAxis stroke=\"#64748b\" style={{ fontSize: '12px' }} />\n                <Tooltip \n                  contentStyle={{ \n                    backgroundColor: '#fff', \n                    border: '1px solid #e5e7eb',\n                    borderRadius: '8px'\n                  }}\n                />\n                <Bar dataKey=\"count\" fill=\"#0ea5e9\" radius={[8, 8, 0, 0]} />\n              </BarChart>\n            </ResponsiveContainer>\n          </CardContent>\n        </Card>\n      </div>\n\n      {/* Insights */}\n      <Card className=\"border-0 shadow-lg bg-gradient-to-br from-blue-50 to-sky-50\">\n        <CardHeader>\n          <CardTitle className=\"flex items-center gap-2\">\n            <TrendingUp className=\"w-5 h-5\" />\n            Insights de Comportamento\n          </CardTitle>\n        </CardHeader>\n        <CardContent>\n          <div className=\"grid md:grid-cols-3 gap-4\">\n            <div className=\"p-4 bg-white rounded-xl\">\n              <div className=\"flex items-center gap-2 mb-2\">\n                <Badge className=\"bg-blue-600 text-white\">Espera</Badge>\n              </div>\n              <p className=\"text-2xl font-bold text-slate-900 mb-1\">\n                {metrics.minWaitTime} - {metrics.maxWaitTime} min\n              </p>\n              <p className=\"text-sm text-slate-600\">Variação de tempo de espera</p>\n            </div>\n\n            <div className=\"p-4 bg-white rounded-xl\">\n              <div className=\"flex items-center gap-2 mb-2\">\n                <Badge className=\"bg-purple-600 text-white\">Fidelização</Badge>\n              </div>\n              <p className=\"text-2xl font-bold text-slate-900 mb-1\">\n                {metrics.repeatRate}%\n              </p>\n              <p className=\"text-sm text-slate-600\">Clientes retornam ao serviço</p>\n            </div>\n\n            <div className=\"p-4 bg-white rounded-xl\">\n              <div className=\"flex items-center gap-2 mb-2\">\n                <Badge className=\"bg-amber-600 text-white\">Abandono</Badge>\n              </div>\n              <p className=\"text-2xl font-bold text-slate-900 mb-1\">\n                Posição #{metrics.avgCancellationPosition}\n              </p>\n              <p className=\"text-sm text-slate-600\">Ponto médio de desistência</p>\n            </div>\n          </div>\n        </CardContent>\n      </Card>\n    </>\n  );\n}","path":null,"size_bytes":10585,"size_tokens":null},"src/components/shared/PhoneInput.jsx":{"content":"import React, { useState } from \"react\";\nimport { Input } from \"@/components/ui/input\";\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\nimport { Phone } from \"lucide-react\";\n\nconst countryCodes = [\n  { code: \"+351\", country: \"Portugal\", flag: \"🇵🇹\" },\n  { code: \"+34\", country: \"España\", flag: \"🇪🇸\" },\n  { code: \"+33\", country: \"France\", flag: \"🇫🇷\" },\n  { code: \"+49\", country: \"Deutschland\", flag: \"🇩🇪\" },\n  { code: \"+39\", country: \"Italia\", flag: \"🇮🇹\" },\n  { code: \"+44\", country: \"United Kingdom\", flag: \"🇬🇧\" },\n  { code: \"+1\", country: \"USA/Canada\", flag: \"🇺🇸\" },\n  { code: \"+55\", country: \"Brasil\", flag: \"🇧🇷\" },\n  { code: \"+52\", country: \"México\", flag: \"🇲🇽\" },\n  { code: \"+54\", country: \"Argentina\", flag: \"🇦🇷\" },\n  { code: \"+56\", country: \"Chile\", flag: \"🇨🇱\" },\n  { code: \"+57\", country: \"Colombia\", flag: \"🇨🇴\" },\n  { code: \"+58\", country: \"Venezuela\", flag: \"🇻🇪\" },\n  { code: \"+51\", country: \"Perú\", flag: \"🇵🇪\" },\n  { code: \"+593\", country: \"Ecuador\", flag: \"🇪🇨\" },\n  { code: \"+591\", country: \"Bolivia\", flag: \"🇧🇴\" },\n  { code: \"+595\", country: \"Paraguay\", flag: \"🇵🇾\" },\n  { code: \"+598\", country: \"Uruguay\", flag: \"🇺🇾\" },\n  { code: \"+31\", country: \"Netherlands\", flag: \"🇳🇱\" },\n  { code: \"+32\", country: \"Belgium\", flag: \"🇧🇪\" },\n  { code: \"+41\", country: \"Switzerland\", flag: \"🇨🇭\" },\n  { code: \"+43\", country: \"Austria\", flag: \"🇦🇹\" },\n  { code: \"+45\", country: \"Denmark\", flag: \"🇩🇰\" },\n  { code: \"+46\", country: \"Sweden\", flag: \"🇸🇪\" },\n  { code: \"+47\", country: \"Norway\", flag: \"🇳🇴\" },\n  { code: \"+48\", country: \"Poland\", flag: \"🇵🇱\" },\n  { code: \"+353\", country: \"Ireland\", flag: \"🇮🇪\" },\n  { code: \"+354\", country: \"Iceland\", flag: \"🇮🇸\" },\n  { code: \"+358\", country: \"Finland\", flag: \"🇫🇮\" },\n  { code: \"+420\", country: \"Czech Republic\", flag: \"🇨🇿\" },\n  { code: \"+421\", country: \"Slovakia\", flag: \"🇸🇰\" },\n  { code: \"+30\", country: \"Greece\", flag: \"🇬🇷\" },\n  { code: \"+370\", country: \"Lithuania\", flag: \"🇱🇹\" },\n  { code: \"+371\", country: \"Latvia\", flag: \"🇱🇻\" },\n  { code: \"+372\", country: \"Estonia\", flag: \"🇪🇪\" },\n  { code: \"+40\", country: \"Romania\", flag: \"🇷🇴\" },\n  { code: \"+359\", country: \"Bulgaria\", flag: \"🇧🇬\" },\n  { code: \"+385\", country: \"Croatia\", flag: \"🇭🇷\" },\n  { code: \"+386\", country: \"Slovenia\", flag: \"🇸🇮\" },\n  { code: \"+381\", country: \"Serbia\", flag: \"🇷🇸\" },\n  { code: \"+7\", country: \"Russia\", flag: \"🇷🇺\" },\n  { code: \"+380\", country: \"Ukraine\", flag: \"🇺🇦\" },\n  { code: \"+90\", country: \"Turkey\", flag: \"🇹🇷\" },\n  { code: \"+971\", country: \"UAE\", flag: \"🇦🇪\" },\n  { code: \"+966\", country: \"Saudi Arabia\", flag: \"🇸🇦\" },\n  { code: \"+972\", country: \"Israel\", flag: \"🇮🇱\" },\n  { code: \"+20\", country: \"Egypt\", flag: \"🇪🇬\" },\n  { code: \"+27\", country: \"South Africa\", flag: \"🇿🇦\" },\n  { code: \"+234\", country: \"Nigeria\", flag: \"🇳🇬\" },\n  { code: \"+254\", country: \"Kenya\", flag: \"🇰🇪\" },\n  { code: \"+91\", country: \"India\", flag: \"🇮🇳\" },\n  { code: \"+92\", country: \"Pakistan\", flag: \"🇵🇰\" },\n  { code: \"+880\", country: \"Bangladesh\", flag: \"🇧🇩\" },\n  { code: \"+86\", country: \"China\", flag: \"🇨🇳\" },\n  { code: \"+81\", country: \"Japan\", flag: \"🇯🇵\" },\n  { code: \"+82\", country: \"South Korea\", flag: \"🇰🇷\" },\n  { code: \"+65\", country: \"Singapore\", flag: \"🇸🇬\" },\n  { code: \"+60\", country: \"Malaysia\", flag: \"🇲🇾\" },\n  { code: \"+62\", country: \"Indonesia\", flag: \"🇮🇩\" },\n  { code: \"+63\", country: \"Philippines\", flag: \"🇵🇭\" },\n  { code: \"+66\", country: \"Thailand\", flag: \"🇹🇭\" },\n  { code: \"+84\", country: \"Vietnam\", flag: \"🇻🇳\" },\n  { code: \"+61\", country: \"Australia\", flag: \"🇦🇺\" },\n  { code: \"+64\", country: \"New Zealand\", flag: \"🇳🇿\" }\n];\n\nexport default function PhoneInput({ value, onChange, placeholder, required, className }) {\n  const [countryCode, setCountryCode] = useState(\"+351\");\n  const [phoneNumber, setPhoneNumber] = useState(\"\");\n\n  React.useEffect(() => {\n    if (value) {\n      const match = countryCodes.find(c => value.startsWith(c.code));\n      if (match) {\n        setCountryCode(match.code);\n        setPhoneNumber(value.replace(match.code, \"\").trim());\n      } else {\n        setPhoneNumber(value);\n      }\n    }\n  }, []);\n\n  const handlePhoneChange = (newPhone) => {\n    setPhoneNumber(newPhone);\n    onChange(`${countryCode}${newPhone}`);\n  };\n\n  const handleCountryCodeChange = (newCode) => {\n    setCountryCode(newCode);\n    onChange(`${newCode}${phoneNumber}`);\n  };\n\n  return (\n    <div className={`flex gap-2 ${className || ''}`}>\n      <Phone className=\"w-5 h-5 text-slate-400 mt-2.5 flex-shrink-0\" />\n      <Select value={countryCode} onValueChange={handleCountryCodeChange}>\n        <SelectTrigger className=\"w-32 flex-shrink-0\">\n          <SelectValue />\n        </SelectTrigger>\n        <SelectContent className=\"max-h-60\">\n          {countryCodes.map((country) => (\n            <SelectItem key={country.code + country.country} value={country.code}>\n              <span className=\"flex items-center gap-2\">\n                <span>{country.flag}</span>\n                <span className=\"text-xs\">{country.code}</span>\n              </span>\n            </SelectItem>\n          ))}\n        </SelectContent>\n      </Select>\n      <Input\n        type=\"tel\"\n        value={phoneNumber}\n        onChange={(e) => handlePhoneChange(e.target.value)}\n        placeholder={placeholder || \"912 345 678\"}\n        className=\"flex-1\"\n        required={required}\n      />\n    </div>\n  );\n}","path":null,"size_bytes":5736,"size_tokens":null},"src/components/ui/collapsible.jsx":{"content":"\"use client\"\n\nimport * as CollapsiblePrimitive from \"@radix-ui/react-collapsible\"\n\nconst Collapsible = CollapsiblePrimitive.Root\n\nconst CollapsibleTrigger = CollapsiblePrimitive.CollapsibleTrigger\n\nconst CollapsibleContent = CollapsiblePrimitive.CollapsibleContent\n\nexport { Collapsible, CollapsibleTrigger, CollapsibleContent }\n","path":null,"size_bytes":329,"size_tokens":null},"src/components/ui/form.jsx":{"content":"\"use client\";\nimport * as React from \"react\"\nimport { Slot } from \"@radix-ui/react-slot\"\nimport { Controller, FormProvider, useFormContext } from \"react-hook-form\";\n\nimport { cn } from \"@/lib/utils\"\nimport { Label } from \"@/components/ui/label\"\n\nconst Form = FormProvider\n\nconst FormFieldContext = React.createContext({})\n\nconst FormField = (\n  {\n    ...props\n  }\n) => {\n  return (\n    (<FormFieldContext.Provider value={{ name: props.name }}>\n      <Controller {...props} />\n    </FormFieldContext.Provider>)\n  );\n}\n\nconst useFormField = () => {\n  const fieldContext = React.useContext(FormFieldContext)\n  const itemContext = React.useContext(FormItemContext)\n  const { getFieldState, formState } = useFormContext()\n\n  const fieldState = getFieldState(fieldContext.name, formState)\n\n  if (!fieldContext) {\n    throw new Error(\"useFormField should be used within <FormField>\")\n  }\n\n  const { id } = itemContext\n\n  return {\n    id,\n    name: fieldContext.name,\n    formItemId: `${id}-form-item`,\n    formDescriptionId: `${id}-form-item-description`,\n    formMessageId: `${id}-form-item-message`,\n    ...fieldState,\n  }\n}\n\nconst FormItemContext = React.createContext({})\n\nconst FormItem = React.forwardRef(({ className, ...props }, ref) => {\n  const id = React.useId()\n\n  return (\n    (<FormItemContext.Provider value={{ id }}>\n      <div ref={ref} className={cn(\"space-y-2\", className)} {...props} />\n    </FormItemContext.Provider>)\n  );\n})\nFormItem.displayName = \"FormItem\"\n\nconst FormLabel = React.forwardRef(({ className, ...props }, ref) => {\n  const { error, formItemId } = useFormField()\n\n  return (\n    (<Label\n      ref={ref}\n      className={cn(error && \"text-destructive\", className)}\n      htmlFor={formItemId}\n      {...props} />)\n  );\n})\nFormLabel.displayName = \"FormLabel\"\n\nconst FormControl = React.forwardRef(({ ...props }, ref) => {\n  const { error, formItemId, formDescriptionId, formMessageId } = useFormField()\n\n  return (\n    (<Slot\n      ref={ref}\n      id={formItemId}\n      aria-describedby={\n        !error\n          ? `${formDescriptionId}`\n          : `${formDescriptionId} ${formMessageId}`\n      }\n      aria-invalid={!!error}\n      {...props} />)\n  );\n})\nFormControl.displayName = \"FormControl\"\n\nconst FormDescription = React.forwardRef(({ className, ...props }, ref) => {\n  const { formDescriptionId } = useFormField()\n\n  return (\n    (<p\n      ref={ref}\n      id={formDescriptionId}\n      className={cn(\"text-[0.8rem] text-muted-foreground\", className)}\n      {...props} />)\n  );\n})\nFormDescription.displayName = \"FormDescription\"\n\nconst FormMessage = React.forwardRef(({ className, children, ...props }, ref) => {\n  const { error, formMessageId } = useFormField()\n  const body = error ? String(error?.message) : children\n\n  if (!body) {\n    return null\n  }\n\n  return (\n    (<p\n      ref={ref}\n      id={formMessageId}\n      className={cn(\"text-[0.8rem] font-medium text-destructive\", className)}\n      {...props}>\n      {body}\n    </p>)\n  );\n})\nFormMessage.displayName = \"FormMessage\"\n\nexport {\n  useFormField,\n  Form,\n  FormItem,\n  FormLabel,\n  FormControl,\n  FormDescription,\n  FormMessage,\n  FormField,\n}\n","path":null,"size_bytes":3141,"size_tokens":null},"src/pages/AdminSupport.jsx":{"content":"import React, { useState, useEffect } from \"react\";\nimport { base44 } from \"@/api/base44Client\";\nimport { useQuery, useMutation, useQueryClient } from \"@tanstack/react-query\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport { Label } from \"@/components/ui/label\";\nimport { Input } from \"@/components/ui/input\";\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\nimport { Tabs, TabsList, TabsTrigger, TabsContent } from \"@/components/ui/tabs\";\nimport { \n  MessageSquare, \n  Send, \n  Clock, \n  CheckCircle2, \n  AlertCircle,\n  FileText,\n  Download,\n  Paperclip,\n  StickyNote,\n  User\n} from \"lucide-react\";\nimport { Skeleton } from \"@/components/ui/skeleton\";\nimport { format } from \"date-fns\";\nimport { pt } from \"date-fns/locale\";\nimport { toast } from \"sonner\";\n\nconst statusConfig = {\n  pendente: { icon: Clock, color: \"bg-amber-100 text-amber-700 border-amber-200\", label: \"Pendente\" },\n  em_analise: { icon: AlertCircle, color: \"bg-blue-100 text-blue-700 border-blue-200\", label: \"Em Análise\" },\n  resolvido: { icon: CheckCircle2, color: \"bg-green-100 text-green-700 border-green-200\", label: \"Resolvido\" }\n};\n\nexport default function AdminSupportPage() {\n  const queryClient = useQueryClient();\n  const [user, setUser] = useState(null);\n  const [selectedMessage, setSelectedMessage] = useState(null);\n  const [responseText, setResponseText] = useState(\"\");\n  const [internalNote, setInternalNote] = useState(\"\");\n  const [responseFiles, setResponseFiles] = useState([]);\n  const [filterStatus, setFilterStatus] = useState(\"all\");\n\n  useEffect(() => {\n    base44.auth.me().then(userData => {\n      setUser(userData);\n      if (userData.role !== 'admin') {\n        window.location.href = '/';\n      }\n    }).catch(() => base44.auth.redirectToLogin());\n  }, []);\n\n  const { data: messages, isLoading } = useQuery({\n    queryKey: ['admin-support-messages', filterStatus],\n    queryFn: async () => {\n      if (filterStatus === \"all\") {\n        return await base44.entities.SupportMessage.list('-created_date');\n      }\n      return await base44.entities.SupportMessage.filter({ status: filterStatus }, '-created_date');\n    },\n    initialData: [],\n    enabled: !!user,\n    refetchInterval: 30000,\n  });\n\n  const { data: businesses } = useQuery({\n    queryKey: ['all-businesses'],\n    queryFn: () => base44.entities.Business.list(),\n    initialData: [],\n    enabled: !!user,\n  });\n\n  const updateMessageMutation = useMutation({\n    mutationFn: ({ id, data }) => base44.entities.SupportMessage.update(id, data),\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['admin-support-messages'] });\n      toast.success('Mensagem atualizada!');\n    },\n  });\n\n  const handleFileUpload = async (e) => {\n    const files = Array.from(e.target.files);\n    const uploadedUrls = [];\n    \n    for (const file of files) {\n      const { file_url } = await base44.integrations.Core.UploadFile({ file });\n      uploadedUrls.push(file_url);\n    }\n    \n    setResponseFiles([...responseFiles, ...uploadedUrls]);\n  };\n\n  const handleSendResponse = async () => {\n    if (!selectedMessage || !responseText.trim()) {\n      toast.error('Escreva uma resposta');\n      return;\n    }\n\n    await updateMessageMutation.mutate({\n      id: selectedMessage.id,\n      data: {\n        response: responseText,\n        response_date: new Date().toISOString(),\n        response_attachments: responseFiles,\n        status: 'resolvido'\n      }\n    });\n\n    try {\n      await base44.integrations.Core.SendEmail({\n        from_name: 'QZero Suporte',\n        to: selectedMessage.user_email,\n        subject: `Re: ${selectedMessage.subject}`,\n        body: `Olá ${selectedMessage.user_name},\n\nRecebemos a sua mensagem e aqui está a nossa resposta:\n\n${responseText}\n\n${responseFiles.length > 0 ? `\\nAnexos: ${responseFiles.join('\\n')}` : ''}\n\n---\nEquipa QZero\nsuporteqzero@gmail.com`\n      });\n    } catch (e) {\n      console.error('Email error:', e);\n    }\n\n    setResponseText(\"\");\n    setResponseFiles([]);\n    setSelectedMessage(null);\n  };\n\n  const handleAddNote = async () => {\n    if (!selectedMessage || !internalNote.trim()) {\n      toast.error('Escreva uma nota');\n      return;\n    }\n\n    const notes = selectedMessage.internal_notes || [];\n    notes.push({\n      note: internalNote,\n      created_by: user.email,\n      created_at: new Date().toISOString()\n    });\n\n    await updateMessageMutation.mutate({\n      id: selectedMessage.id,\n      data: { internal_notes: notes }\n    });\n\n    setInternalNote(\"\");\n  };\n\n  const handleStatusChange = async (messageId, newStatus) => {\n    await updateMessageMutation.mutate({\n      id: messageId,\n      data: { status: newStatus }\n    });\n  };\n\n  const getBusinessName = (businessId) => {\n    const business = businesses.find(b => b.id === businessId);\n    return business?.name || 'N/A';\n  };\n\n  if (!user || isLoading) {\n    return (\n      <div className=\"bg-gradient-to-br from-slate-50 via-blue-50 to-sky-50 p-4\">\n        <div className=\"max-w-7xl mx-auto\">\n          <Skeleton className=\"h-16 w-64 mb-8\" />\n          <Skeleton className=\"h-96 w-full\" />\n        </div>\n      </div>\n    );\n  }\n\n  const pendingCount = messages.filter(m => m.status === 'pendente').length;\n  const inAnalysisCount = messages.filter(m => m.status === 'em_analise').length;\n  const resolvedCount = messages.filter(m => m.status === 'resolvido').length;\n\n  return (\n    <div className=\"bg-gradient-to-br from-slate-50 via-blue-50 to-sky-50\">\n      <div className=\"max-w-7xl mx-auto px-4 py-4\">\n        <div className=\"mb-8\">\n          <h1 className=\"text-4xl font-bold text-slate-900 mb-2\">Dashboard de Suporte</h1>\n          <p className=\"text-slate-600\">Gestão de mensagens de suporte dos clientes</p>\n        </div>\n\n        <div className=\"grid md:grid-cols-4 gap-4 mb-8\">\n          <Card className=\"border-0 shadow-lg\">\n            <CardContent className=\"p-6\">\n              <div className=\"flex items-center justify-between mb-2\">\n                <MessageSquare className=\"w-8 h-8 text-slate-600\" />\n                <Badge className=\"bg-slate-100 text-slate-700\">Total</Badge>\n              </div>\n              <div className=\"text-3xl font-bold text-slate-900\">{messages.length}</div>\n              <p className=\"text-sm text-slate-600\">Mensagens</p>\n            </CardContent>\n          </Card>\n\n          <Card className=\"border-0 shadow-lg\">\n            <CardContent className=\"p-6\">\n              <div className=\"flex items-center justify-between mb-2\">\n                <Clock className=\"w-8 h-8 text-amber-600\" />\n                <Badge className=\"bg-amber-100 text-amber-700\">Pendente</Badge>\n              </div>\n              <div className=\"text-3xl font-bold text-amber-600\">{pendingCount}</div>\n              <p className=\"text-sm text-slate-600\">Por responder</p>\n            </CardContent>\n          </Card>\n\n          <Card className=\"border-0 shadow-lg\">\n            <CardContent className=\"p-6\">\n              <div className=\"flex items-center justify-between mb-2\">\n                <AlertCircle className=\"w-8 h-8 text-blue-600\" />\n                <Badge className=\"bg-blue-100 text-blue-700\">Em Análise</Badge>\n              </div>\n              <div className=\"text-3xl font-bold text-blue-600\">{inAnalysisCount}</div>\n              <p className=\"text-sm text-slate-600\">Em progresso</p>\n            </CardContent>\n          </Card>\n\n          <Card className=\"border-0 shadow-lg\">\n            <CardContent className=\"p-6\">\n              <div className=\"flex items-center justify-between mb-2\">\n                <CheckCircle2 className=\"w-8 h-8 text-green-600\" />\n                <Badge className=\"bg-green-100 text-green-700\">Resolvido</Badge>\n              </div>\n              <div className=\"text-3xl font-bold text-green-600\">{resolvedCount}</div>\n              <p className=\"text-sm text-slate-600\">Concluídas</p>\n            </CardContent>\n          </Card>\n        </div>\n\n        <div className=\"grid lg:grid-cols-3 gap-6\">\n          <div className=\"lg:col-span-2\">\n            <Card className=\"border-0 shadow-lg\">\n              <CardHeader className=\"bg-slate-50 border-b\">\n                <div className=\"flex justify-between items-center\">\n                  <CardTitle>Mensagens</CardTitle>\n                  <Select value={filterStatus} onValueChange={setFilterStatus}>\n                    <SelectTrigger className=\"w-40\">\n                      <SelectValue />\n                    </SelectTrigger>\n                    <SelectContent>\n                      <SelectItem value=\"all\">Todas</SelectItem>\n                      <SelectItem value=\"pendente\">Pendentes</SelectItem>\n                      <SelectItem value=\"em_analise\">Em Análise</SelectItem>\n                      <SelectItem value=\"resolvido\">Resolvidas</SelectItem>\n                    </SelectContent>\n                  </Select>\n                </div>\n              </CardHeader>\n              <CardContent className=\"p-0\">\n                <div className=\"divide-y max-h-[600px] overflow-y-auto\">\n                  {messages.map(msg => {\n                    const status = statusConfig[msg.status];\n                    const StatusIcon = status.icon;\n\n                    return (\n                      <div\n                        key={msg.id}\n                        className={`p-4 hover:bg-slate-50 cursor-pointer transition-colors ${\n                          selectedMessage?.id === msg.id ? 'bg-blue-50' : ''\n                        }`}\n                        onClick={() => setSelectedMessage(msg)}\n                      >\n                        <div className=\"flex justify-between items-start mb-2\">\n                          <div className=\"flex-1\">\n                            <h4 className=\"font-bold text-slate-900\">{msg.subject}</h4>\n                            <p className=\"text-sm text-slate-600\">{getBusinessName(msg.business_id)} • {msg.user_name}</p>\n                          </div>\n                          <Badge className={status.color}>\n                            <StatusIcon className=\"w-3 h-3 mr-1\" />\n                            {status.label}\n                          </Badge>\n                        </div>\n                        <p className=\"text-sm text-slate-700 line-clamp-2 mb-2\">{msg.message}</p>\n                        <div className=\"flex items-center gap-3 text-xs text-slate-500\">\n                          <span>{format(new Date(msg.created_date), \"dd MMM 'às' HH:mm\", { locale: pt })}</span>\n                          {msg.attachments?.length > 0 && (\n                            <span className=\"flex items-center gap-1\">\n                              <Paperclip className=\"w-3 h-3\" />\n                              {msg.attachments.length}\n                            </span>\n                          )}\n                        </div>\n                      </div>\n                    );\n                  })}\n                </div>\n              </CardContent>\n            </Card>\n          </div>\n\n          <div>\n            {selectedMessage ? (\n              <Card className=\"border-0 shadow-lg\">\n                <CardHeader className=\"bg-gradient-to-r from-sky-500 to-blue-600 text-white\">\n                  <CardTitle className=\"text-lg\">Detalhes da Mensagem</CardTitle>\n                </CardHeader>\n                <CardContent className=\"p-4\">\n                  <Tabs defaultValue=\"response\" className=\"w-full\">\n                    <TabsList className=\"w-full grid grid-cols-2\">\n                      <TabsTrigger value=\"response\">Responder</TabsTrigger>\n                      <TabsTrigger value=\"notes\">Notas</TabsTrigger>\n                    </TabsList>\n\n                    <TabsContent value=\"response\" className=\"space-y-4\">\n                      <div>\n                        <Label>Estado</Label>\n                        <Select\n                          value={selectedMessage.status}\n                          onValueChange={(value) => handleStatusChange(selectedMessage.id, value)}\n                        >\n                          <SelectTrigger>\n                            <SelectValue />\n                          </SelectTrigger>\n                          <SelectContent>\n                            <SelectItem value=\"pendente\">Pendente</SelectItem>\n                            <SelectItem value=\"em_analise\">Em Análise</SelectItem>\n                            <SelectItem value=\"resolvido\">Resolvido</SelectItem>\n                          </SelectContent>\n                        </Select>\n                      </div>\n\n                      <div className=\"p-3 bg-slate-50 rounded-lg\">\n                        <p className=\"text-sm text-slate-700 whitespace-pre-wrap\">{selectedMessage.message}</p>\n                      </div>\n\n                      {selectedMessage.attachments?.length > 0 && (\n                        <div>\n                          <Label>Anexos do Cliente</Label>\n                          <div className=\"space-y-2 mt-2\">\n                            {selectedMessage.attachments.map((url, idx) => (\n                              <a\n                                key={idx}\n                                href={url}\n                                target=\"_blank\"\n                                rel=\"noopener noreferrer\"\n                                className=\"flex items-center gap-2 p-2 bg-slate-50 rounded hover:bg-slate-100 text-sm\"\n                              >\n                                <FileText className=\"w-4 h-4\" />\n                                Ficheiro {idx + 1}\n                                <Download className=\"w-3 h-3 ml-auto\" />\n                              </a>\n                            ))}\n                          </div>\n                        </div>\n                      )}\n\n                      <div>\n                        <Label htmlFor=\"response\">Resposta</Label>\n                        <Textarea\n                          id=\"response\"\n                          value={responseText}\n                          onChange={(e) => setResponseText(e.target.value)}\n                          placeholder=\"Escreva a sua resposta...\"\n                          rows={6}\n                        />\n                      </div>\n\n                      <div>\n                        <Label>Anexar Ficheiros</Label>\n                        <Input\n                          type=\"file\"\n                          multiple\n                          onChange={handleFileUpload}\n                          className=\"mt-2\"\n                        />\n                        {responseFiles.length > 0 && (\n                          <p className=\"text-xs text-slate-600 mt-2\">{responseFiles.length} ficheiro(s) anexado(s)</p>\n                        )}\n                      </div>\n\n                      <Button\n                        onClick={handleSendResponse}\n                        className=\"w-full bg-gradient-to-r from-sky-500 to-blue-600 gap-2\"\n                        disabled={updateMessageMutation.isPending}\n                      >\n                        <Send className=\"w-4 h-4\" />\n                        Enviar Resposta\n                      </Button>\n                    </TabsContent>\n\n                    <TabsContent value=\"notes\" className=\"space-y-4\">\n                      <div>\n                        <Label htmlFor=\"note\">Nova Nota Interna</Label>\n                        <Textarea\n                          id=\"note\"\n                          value={internalNote}\n                          onChange={(e) => setInternalNote(e.target.value)}\n                          placeholder=\"Adicione uma nota interna...\"\n                          rows={4}\n                        />\n                        <Button\n                          onClick={handleAddNote}\n                          className=\"w-full mt-2 gap-2\"\n                          variant=\"outline\"\n                        >\n                          <StickyNote className=\"w-4 h-4\" />\n                          Adicionar Nota\n                        </Button>\n                      </div>\n\n                      {selectedMessage.internal_notes?.length > 0 && (\n                        <div className=\"space-y-2\">\n                          <Label>Histórico de Notas</Label>\n                          {selectedMessage.internal_notes.map((note, idx) => (\n                            <div key={idx} className=\"p-3 bg-amber-50 border-l-4 border-amber-400 rounded\">\n                              <div className=\"flex items-center gap-2 mb-1\">\n                                <User className=\"w-3 h-3 text-amber-700\" />\n                                <span className=\"text-xs font-semibold text-amber-900\">{note.created_by}</span>\n                                <span className=\"text-xs text-amber-700\">\n                                  {format(new Date(note.created_at), \"dd MMM 'às' HH:mm\", { locale: pt })}\n                                </span>\n                              </div>\n                              <p className=\"text-sm text-amber-900 whitespace-pre-wrap\">{note.note}</p>\n                            </div>\n                          ))}\n                        </div>\n                      )}\n                    </TabsContent>\n                  </Tabs>\n                </CardContent>\n              </Card>\n            ) : (\n              <Card className=\"border-0 shadow-lg\">\n                <CardContent className=\"p-12 text-center\">\n                  <MessageSquare className=\"w-16 h-16 text-slate-400 mx-auto mb-4\" />\n                  <p className=\"text-slate-600\">Selecione uma mensagem para responder</p>\n                </CardContent>\n              </Card>\n            )}\n          </div>\n        </div>\n      </div>\n    </div>\n  );\n}","path":null,"size_bytes":17944,"size_tokens":null},"src/pages/BusinessSubscription.jsx":{"content":"import React, { useState, useEffect } from \"react\";\nimport { base44 } from \"@/api/base44Client\";\nimport { safeFetch, isCapacitorApp, getBaseUrl } from \"@/utils/apiConfig\";\nimport { Button } from \"@/components/ui/button\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Alert, AlertDescription } from \"@/components/ui/alert\";\nimport { useNavigate, useLocation } from \"react-router-dom\";\nimport { createPageUrl } from \"@/utils\";\nimport {\n  CheckCircle2,\n  Building2,\n  Users,\n  BarChart3,\n  Calendar,\n  Clock,\n  Shield,\n  Zap,\n  ArrowRight,\n  Loader2,\n  ArrowLeft,\n  CreditCard,\n  AlertCircle,\n  Mail,\n  MapPin,\n  Phone,\n  ExternalLink,\n  Globe\n} from \"lucide-react\";\nimport { toast } from \"sonner\";\nimport { companyProfileStorage } from '@/models/companyProfile';\nimport { stripeService } from '@/services/stripeService';\nimport { businessAccessService } from '@/services/businessAccessService';\nimport { useAutoTranslate } from '@/hooks/useTranslate';\nimport { navigateBackOrFallback } from '@/hooks/useNavigateBack';\nimport { Capacitor } from '@capacitor/core';\n\nconst EXTERNAL_SUBSCRIPTION_URL = 'https://waitless-qzero.com';\n\nexport default function BusinessSubscriptionPage() {\n  const navigate = useNavigate();\n  const location = useLocation();\n  const [user, setUser] = useState(null);\n  const [isProcessingPayment, setIsProcessingPayment] = useState(false);\n  const [companyProfile, setCompanyProfile] = useState(null);\n  const [isEligibleForTrial, setIsEligibleForTrial] = useState(null);\n  \n  const isNativeApp = isCapacitorApp();\n  const platform = Capacitor.getPlatform();\n\n  const txtProfileNotFound = useAutoTranslate('Perfil da empresa não encontrado', 'pt');\n  const txtDemoSimulating = useAutoTranslate('Modo Demo: Simulando pagamento Stripe...', 'pt');\n  const txtDemoDescription = useAutoTranslate('Em produção, você seria redirecionado para o Stripe Checkout.', 'pt');\n  const txtErrorCreatingSession = useAutoTranslate('Erro ao criar sessão de pagamento', 'pt');\n  const txtCheckConnection = useAutoTranslate('Por favor, verifique sua conexão e tente novamente em alguns segundos.', 'pt');\n  const txtErrorProcessing = useAutoTranslate('Erro ao processar pagamento', 'pt');\n  const txtTryAgain = useAutoTranslate('Tentar Novamente', 'pt');\n  const txtQueueManagement = useAutoTranslate('Gestão de Filas', 'pt');\n  const txtQueueDesc = useAutoTranslate('Crie e gira múltiplas filas de atendimento simultaneamente', 'pt');\n  const txtAppointmentSystem = useAutoTranslate('Sistema de Marcações', 'pt');\n  const txtAppointmentDesc = useAutoTranslate('Permita aos clientes agendar serviços com horários personalizados', 'pt');\n  const txtAdvancedAnalytics = useAutoTranslate('Análise Avançada', 'pt');\n  const txtAnalyticsDesc = useAutoTranslate('Estatísticas detalhadas e previsões com IA para otimizar o atendimento', 'pt');\n  const txtRealTime = useAutoTranslate('Tempo Real', 'pt');\n  const txtRealTimeDesc = useAutoTranslate('Atualizações instantâneas e notificações automáticas para clientes', 'pt');\n  const txtPrioritySupport = useAutoTranslate('Suporte Prioritário', 'pt');\n  const txtSupportDesc = useAutoTranslate('Atendimento dedicado para resolver qualquer questão rapidamente', 'pt');\n  const txtUnlimited = useAutoTranslate('Sem Limites', 'pt');\n  const txtUnlimitedDesc = useAutoTranslate('Atendimentos, filas e marcações ilimitadas', 'pt');\n  const txtLoading = useAutoTranslate('A carregar...', 'pt');\n  const txtBack = useAutoTranslate('Anterior', 'pt');\n  const txtReactivation = useAutoTranslate('Reativação de Plano', 'pt');\n  const txtStep2of2 = useAutoTranslate('Passo 2 de 2', 'pt');\n  const txtReactivatePlan = useAutoTranslate('Reativar Plano Empresarial', 'pt');\n  const txtActivatePlan = useAutoTranslate('Ative o Plano Empresarial', 'pt');\n  const txtReactivateText = useAutoTranslate('Vamos criar uma nova subscrição para a sua empresa', 'pt');\n  const txtActivateText = useAutoTranslate('Após o pagamento, sua conta empresarial será ativada com todas as funcionalidades', 'pt');\n  const txtProfileSummary = useAutoTranslate('Resumo do Perfil:', 'pt');\n  const txtFreeTrialBadge = useAutoTranslate('🎉 7 Dias Totalmente GRÁTIS para Testar', 'pt');\n  const txtMonthlyPlan = useAutoTranslate('💼 Plano Empresarial Mensal', 'pt');\n  const txtPerMonth = useAutoTranslate('/mês', 'pt');\n  const txtMonthlyBilling = useAutoTranslate('Faturação mensal • Cancele quando quiser', 'pt');\n  const txtNoCostsNow = useAutoTranslate('✅ Sem custos agora! Teste durante 7 dias completamente grátis.', 'pt');\n  const txtPaymentAfter7Days = useAutoTranslate('O pagamento só será processado após 7 dias. Cancele a qualquer momento durante o período de teste sem qualquer custo.', 'pt');\n  const txtImmediateCharge = useAutoTranslate('Cobrança imediata', 'pt');\n  const txtPaymentProcessedNow = useAutoTranslate('O pagamento será processado agora.', 'pt');\n  const txtAlreadyUsedTrial = useAutoTranslate('Você já utilizou o período de teste gratuito anteriormente. A subscrição será ativada imediatamente após o pagamento.', 'pt');\n  const txtFeature1 = useAutoTranslate('Gestão de filas ilimitadas', 'pt');\n  const txtFeature2 = useAutoTranslate('Sistema completo de marcações', 'pt');\n  const txtFeature3 = useAutoTranslate('Horários personalizados e pausas', 'pt');\n  const txtFeature4 = useAutoTranslate('Bloqueio de datas (férias/feriados)', 'pt');\n  const txtFeature5 = useAutoTranslate('Análise e estatísticas avançadas', 'pt');\n  const txtFeature6 = useAutoTranslate('Notificações automáticas', 'pt');\n  const txtFeature7 = useAutoTranslate('Painel de controlo completo', 'pt');\n  const txtFeature8 = useAutoTranslate('Suporte prioritário', 'pt');\n  const txtFeature9 = useAutoTranslate('Sem limite de atendimentos', 'pt');\n  const txtProcessing = useAutoTranslate('A processar...', 'pt');\n  const txtPayBusinessPlan = useAutoTranslate('Pagar Plano Empresarial', 'pt');\n  const txtPayShort = useAutoTranslate('Pagar', 'pt');\n  const txtSecurePayment = useAutoTranslate('Pagamento seguro via Stripe • Sem compromissos', 'pt');\n  const txtFreeTrialPeriod = useAutoTranslate('Período de Teste Gratuito:', 'pt');\n  const txtFreeTrialDesc = useAutoTranslate('Os primeiros 7 dias são completamente grátis! Pode cancelar a qualquer momento durante o período de teste sem qualquer cobrança. Após os 7 dias, será cobrado €49,99/mês automaticamente.', 'pt');\n  const txtReactivationAlert = useAutoTranslate('Reativação de Plano', 'pt');\n  const txtReactivationAlertDesc = useAutoTranslate('Está a reativar o plano para a empresa', 'pt');\n  const txtDataKept = useAutoTranslate('Os dados da sua empresa serão mantidos - apenas a subscrição será renovada.', 'pt');\n  const txtActiveSubscription = useAutoTranslate('Subscrição Ativa!', 'pt');\n  const txtActiveSubscriptionDesc = useAutoTranslate('Você já tem uma subscrição empresarial ativa. Esta página está disponível apenas para teste do fluxo de pagamento.', 'pt');\n  const txtSubscriptionActivatedSuccess = useAutoTranslate('Subscrição ativada com sucesso!', 'pt');\n  const txtFAQ = useAutoTranslate('Perguntas Frequentes', 'pt');\n  const txtFAQ1Question = useAutoTranslate('Posso cancelar a qualquer momento?', 'pt');\n  const txtFAQ1Answer = useAutoTranslate('Sim, pode cancelar a subscrição a qualquer momento sem penalizações. O acesso permanece ativo até ao final do período pago.', 'pt');\n  const txtFAQ2Question = useAutoTranslate('Há limite de atendimentos?', 'pt');\n  const txtFAQ2Answer = useAutoTranslate('Não, não há qualquer limite. Pode ter quantas filas, marcações e atendimentos precisar.', 'pt');\n  const txtFAQ3Question = useAutoTranslate('Como funciona o pagamento?', 'pt');\n  const txtFAQ3Answer = useAutoTranslate('O pagamento é processado mensalmente de forma automática via Stripe. Pode atualizar o método de pagamento a qualquer momento na área de gestão da subscrição.', 'pt');\n  const txtFAQ4Question = useAutoTranslate('O que acontece se o pagamento falhar?', 'pt');\n  const txtFAQ4Answer = useAutoTranslate('Se o pagamento falhar, receberá notificações para atualizar o método de pagamento. As funcionalidades empresariais ficam bloqueadas até que o pagamento seja regularizado.', 'pt');\n  \n  const txtExternalPurchaseTitle = useAutoTranslate('Quase lá!', 'pt');\n  const txtExternalPurchaseDesc = useAutoTranslate('Para ativar todas as funcionalidades, visite o nosso site no seu browser ou computador.', 'pt');\n  const txtExternalPurchaseButton = useAutoTranslate('Ir ao Site', 'pt');\n  const txtExternalPurchaseNote = useAutoTranslate('Depois de comprar lá, volte aqui e faça login. Tudo estará desbloqueado!', 'pt');\n  const txtB2BNote = useAutoTranslate('A compra é feita no site waitless-qzero.com para maior segurança e comodidade.', 'pt');\n  const txtExternalPurchasePromo = useAutoTranslate('7 dias grátis + €19,99 (1º mês) + €49,99/mês', 'pt');\n  const txtExploreFirst = useAutoTranslate('Explorar Primeiro', 'pt');\n  const txtExploreFirstDesc = useAutoTranslate('Pode explorar o painel empresarial sem pagar agora. Algumas funcionalidades terão acesso restrito.', 'pt');\n  \n  const txtCatHealth = useAutoTranslate('Saúde', 'pt');\n  const txtCatFinance = useAutoTranslate('Financeiro', 'pt');\n  const txtCatGovernment = useAutoTranslate('Governo', 'pt');\n  const txtCatRestaurant = useAutoTranslate('Restauração', 'pt');\n  const txtCatBeauty = useAutoTranslate('Beleza', 'pt');\n  const txtCatRetail = useAutoTranslate('Retalho', 'pt');\n  const txtCatOther = useAutoTranslate('Outros', 'pt');\n  \n  const translatedCategories = {\n    'saude': txtCatHealth,\n    'financeiro': txtCatFinance,\n    'governo': txtCatGovernment,\n    'restauracao': txtCatRestaurant,\n    'beleza': txtCatBeauty,\n    'retalho': txtCatRetail,\n    'outros': txtCatOther\n  };\n\n  useEffect(() => {\n    base44.auth.me().then(async (userData) => {\n      setUser(userData);\n      \n      // ✅ REATIVAÇÃO: Usar perfil existente se fornecido\n      let profile = null;\n      \n      if (location.state?.existingProfileId) {\n        console.log('🔄 Reativação: Usando perfil existente:', location.state.existingProfileId);\n        // Buscar perfil existente por ID\n        const { response, data } = await safeFetch(`/api/company-profiles/${location.state.existingProfileId}`);\n        if (response.ok) {\n          profile = data;\n        }\n      } else {\n        // Buscar perfil normal\n        profile = location.state?.profile || await companyProfileStorage.getByUserId(userData.id);\n      }\n      \n      if (!profile) {\n        navigate(createPageUrl('BusinessProfileSetup'));\n        return;\n      }\n      \n      // Verificar se já tem subscrição ativa (exceto se for reativação)\n      if (!location.state?.isReactivation) {\n        const access = await businessAccessService.getUserBusinessAccess(userData);\n        \n        if (access.hasAccess) {\n          console.log('✅ Subscrição ativa - redirecionando para BusinessHome');\n          navigate(createPageUrl('BusinessHome'), { replace: true });\n          return;\n        }\n      }\n      \n      setCompanyProfile(profile);\n      \n      // 🎁 Verificar se utilizador é elegível para trial de 2 dias\n      try {\n        const profileIdParam = profile?.id ? `&profileId=${encodeURIComponent(profile.id)}` : '';\n        const { response, data } = await safeFetch(`/api/check-trial-eligibility?email=${encodeURIComponent(userData.email)}${profileIdParam}`);\n        if (response.ok) {\n          const { isEligibleForTrial: eligible } = data || {};\n          setIsEligibleForTrial(eligible);\n          console.log(`🎁 Trial eligibility: ${eligible ? 'ELIGIBLE (first time)' : 'NOT ELIGIBLE (already used)'}`);\n        } else {\n          // Em caso de erro, assumir que NÃO é elegível por segurança\n          setIsEligibleForTrial(false);\n        }\n      } catch (error) {\n        console.error('❌ Error checking trial eligibility:', error);\n        setIsEligibleForTrial(false);\n      }\n    }).catch(() => {\n      base44.auth.redirectToLogin();\n    });\n  }, [navigate, location]);\n\n  // ✅ ABRIR SITE EXTERNO (iOS/Android - B2B)\n  const handleExternalPurchase = () => {\n    const url = EXTERNAL_SUBSCRIPTION_URL;\n    console.log('🌐 Abrindo site externo para compra B2B:', url);\n    \n    if (Capacitor.isNativePlatform()) {\n      window.open(url, '_system');\n    } else {\n      window.open(url, '_blank');\n    }\n  };\n\n  // ✅ PAGAMENTO VIA STRIPE (Web browser)\n  const handleStripePayment = async () => {\n    if (!companyProfile) {\n      toast.error(txtProfileNotFound);\n      return;\n    }\n\n    setIsProcessingPayment(true);\n    \n    try {\n      const baseUrl = getBaseUrl();\n      console.log('💳 Stripe checkout - Base URL:', baseUrl);\n      \n      const data = await stripeService.createSubscriptionCheckout(\n        companyProfile.id,\n        companyProfile.companyEmail,\n        `${baseUrl}${createPageUrl('PaymentSuccess')}?session_id={CHECKOUT_SESSION_ID}`,\n        `${baseUrl}${createPageUrl('BusinessSubscription')}`\n      );\n      \n      if (data.isMock) {\n        const profileId = companyProfile.id;\n        \n        toast.info(txtDemoSimulating, {\n          description: txtDemoDescription,\n          duration: 3000\n        });\n        \n        setTimeout(() => {\n          console.log('💳 Modo Demo: Redirecionando para confirmação de pagamento');\n          const mockSessionId = `mock_session_${Date.now()}`;\n          navigate(createPageUrl('PaymentSuccess') + `?session_id=${mockSessionId}&profile_id=${profileId}`);\n        }, 2000);\n      } else if (data.url) {\n        await companyProfileStorage.update(companyProfile.id, {\n          paymentRetry: {\n            failureCount: 0,\n            lastFailureAt: null,\n            lastFailureReason: null,\n            canRetry: true\n          }\n        });\n        \n        window.location.href = data.url;\n      } else {\n        console.error('❌ Erro: Nenhuma URL de checkout retornada pelo backend');\n        \n        const updatedProfile = await companyProfileStorage.update(companyProfile.id, {\n          paymentRetry: {\n            failureCount: (companyProfile.paymentRetry?.failureCount || 0) + 1,\n            lastFailureAt: new Date().toISOString(),\n            lastFailureReason: 'No checkout URL returned from backend',\n            canRetry: true\n          }\n        });\n        \n        setCompanyProfile(updatedProfile);\n        \n        toast.error(txtErrorCreatingSession, {\n          description: txtCheckConnection,\n          duration: 5000\n        });\n      }\n    } catch (error) {\n      console.error('❌ Payment error:', error);\n      \n      const updatedProfile = await companyProfileStorage.update(companyProfile.id, {\n        paymentRetry: {\n          failureCount: (companyProfile.paymentRetry?.failureCount || 0) + 1,\n          lastFailureAt: new Date().toISOString(),\n          lastFailureReason: error.message || 'Unknown payment error',\n          canRetry: true\n        }\n      });\n      \n      setCompanyProfile(updatedProfile);\n      \n      toast.error(txtErrorProcessing, {\n        description: error.message || txtCheckConnection,\n        duration: 5000,\n        action: {\n          label: txtTryAgain,\n          onClick: () => handlePayNow()\n        }\n      });\n    } finally {\n      setIsProcessingPayment(false);\n    }\n  };\n\n  // ✅ HANDLER PRINCIPAL - Stripe para web (iOS/Android usa tela externa)\n  const handlePayNow = async () => {\n    // Web: Usar Stripe\n    console.log('🌐 Web browser detectado - usando Stripe');\n    await handleStripePayment();\n  };\n\n  const features = [\n    {\n      icon: Users,\n      title: txtQueueManagement,\n      description: txtQueueDesc\n    },\n    {\n      icon: Calendar,\n      title: txtAppointmentSystem,\n      description: txtAppointmentDesc\n    },\n    {\n      icon: BarChart3,\n      title: txtAdvancedAnalytics,\n      description: txtAnalyticsDesc\n    },\n    {\n      icon: Clock,\n      title: txtRealTime,\n      description: txtRealTimeDesc\n    },\n    {\n      icon: Shield,\n      title: txtPrioritySupport,\n      description: txtSupportDesc\n    },\n    {\n      icon: Zap,\n      title: txtUnlimited,\n      description: txtUnlimitedDesc\n    }\n  ];\n\n  if (!user || !companyProfile) {\n    return (\n      <div className=\"bg-gradient-to-br from-slate-50 via-blue-50 to-sky-50 flex items-center justify-center p-4\">\n        <div className=\"text-center\">\n          <Loader2 className=\"w-12 h-12 animate-spin text-indigo-600 mx-auto mb-4\" />\n          <p className=\"text-slate-600\">{txtLoading}</p>\n        </div>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"bg-gradient-to-br from-slate-50 via-blue-50 to-sky-50\">\n      <div className=\"max-w-6xl mx-auto px-4 py-4 sm:py-8\">\n        <div className=\"mb-6\">\n          <Button\n            variant=\"ghost\"\n            onClick={() => navigate(createPageUrl('BusinessHome'))}\n            className=\"gap-2\"\n          >\n            <ArrowLeft className=\"w-4 h-4\" />\n            {txtBack}\n          </Button>\n        </div>\n\n        <div className=\"text-center mb-6 sm:mb-8\">\n          <Badge className=\"bg-indigo-100 text-indigo-700 border-indigo-200 mb-3 sm:mb-4\">\n            <Building2 className=\"w-3 h-3 mr-1\" />\n            {location.state?.isReactivation ? txtReactivation : txtStep2of2}\n          </Badge>\n          <h1 className=\"text-2xl sm:text-3xl md:text-4xl font-bold text-slate-900 mb-2 px-2\">\n            {location.state?.isReactivation ? txtReactivatePlan : txtActivatePlan}\n          </h1>\n          <p className=\"text-base sm:text-lg text-slate-600 px-2\">\n            {location.state?.isReactivation \n              ? `${txtReactivateText} \"${companyProfile?.name}\"`\n              : txtActivateText\n            }\n          </p>\n        </div>\n\n        {location.state?.isReactivation && (\n          <Alert className=\"max-w-3xl mx-auto mb-8 border-blue-200 bg-blue-50\">\n            <AlertCircle className=\"h-4 w-4 text-blue-600\" />\n            <AlertDescription className=\"text-blue-900\">\n              <strong>{txtReactivationAlert}</strong><br />\n              {txtReactivationAlertDesc} <strong>{companyProfile?.name}</strong>. \n              {txtDataKept}\n            </AlertDescription>\n          </Alert>\n        )}\n\n        {companyProfile?.status === 'active' && !location.state?.isReactivation && (\n          <Alert className=\"max-w-3xl mx-auto mb-8 border-green-200 bg-green-50\">\n            <CheckCircle2 className=\"h-4 w-4 text-green-600\" />\n            <AlertDescription className=\"text-green-900\">\n              <strong>{txtActiveSubscription}</strong> {txtActiveSubscriptionDesc}\n            </AlertDescription>\n          </Alert>\n        )}\n\n        <Alert className=\"max-w-3xl mx-auto mb-6 sm:mb-8 border-blue-200 bg-blue-50\">\n          <AlertCircle className=\"h-4 w-4 text-blue-600 flex-shrink-0\" />\n          <AlertDescription className=\"text-blue-900\">\n            <strong className=\"text-sm sm:text-base\">{txtProfileSummary}</strong>\n            <div className=\"mt-2 space-y-2 text-xs sm:text-sm\">\n              <div className=\"flex items-start gap-2\">\n                <Building2 className=\"w-4 h-4 flex-shrink-0 mt-0.5\" />\n                <span className=\"break-words\"><strong>{companyProfile.companyName}</strong> - {translatedCategories[companyProfile.companyCategory] || companyProfile.companyCategory}</span>\n              </div>\n              <div className=\"flex items-start gap-2\">\n                <Mail className=\"w-4 h-4 flex-shrink-0 mt-0.5\" />\n                <span className=\"break-all overflow-wrap-anywhere\">{companyProfile.companyEmail}</span>\n              </div>\n              <div className=\"flex items-start gap-2\">\n                <MapPin className=\"w-4 h-4 flex-shrink-0 mt-0.5\" />\n                <span className=\"break-words\">{companyProfile.companyAddress}, {companyProfile.companyCity}</span>\n              </div>\n              {companyProfile.companyPhone && (\n                <div className=\"flex items-start gap-2\">\n                  <Phone className=\"w-4 h-4 flex-shrink-0 mt-0.5\" />\n                  <span className=\"break-words\">{companyProfile.companyPhone}</span>\n                </div>\n              )}\n            </div>\n          </AlertDescription>\n        </Alert>\n\n        {/* ============================================ */}\n        {/* iOS/Android: Tela Informativa (B2B) - Sem botão externo */}\n        {/* ============================================ */}\n        {isNativeApp ? (\n          <Card className=\"border-0 shadow-2xl mb-8 sm:mb-12 overflow-hidden max-w-2xl mx-auto\">\n            <div className=\"h-2 bg-gradient-to-r from-indigo-600 to-purple-600\" />\n            <CardContent className=\"p-6 sm:p-8\">\n              <div className=\"text-center mb-6\">\n                <div className=\"w-16 h-16 mx-auto mb-4 rounded-full bg-gradient-to-br from-indigo-500 to-purple-600 flex items-center justify-center\">\n                  <Globe className=\"w-8 h-8 text-white\" />\n                </div>\n                \n                <h2 className=\"text-xl sm:text-2xl font-bold text-slate-900 mb-2\">\n                  {txtExternalPurchaseTitle}\n                </h2>\n                \n                <p className=\"text-slate-600 mb-4\">\n                  {txtExternalPurchaseDesc}\n                </p>\n                \n                <div className=\"inline-block px-4 py-2 bg-gradient-to-r from-green-500 to-emerald-500 text-white text-sm font-semibold rounded-full\">\n                  {txtExternalPurchasePromo}\n                </div>\n              </div>\n\n              <div className=\"bg-indigo-50 rounded-xl p-4 mb-6 text-center\">\n                <p className=\"text-indigo-900 font-semibold mb-1\">\n                  Visite no seu browser:\n                </p>\n                <p className=\"text-indigo-700 text-lg font-bold\">\n                  waitless-qzero.com\n                </p>\n              </div>\n\n              <div className=\"space-y-3 mb-6\">\n                {[\n                  txtFeature1,\n                  txtFeature2,\n                  txtFeature5,\n                  txtFeature6,\n                  txtFeature9\n                ].map((feature, idx) => (\n                  <div key={idx} className=\"flex items-center gap-2\">\n                    <CheckCircle2 className=\"w-4 h-4 text-green-600 flex-shrink-0\" />\n                    <span className=\"text-slate-700 text-sm\">{feature}</span>\n                  </div>\n                ))}\n              </div>\n\n              <Alert className=\"border-blue-200 bg-blue-50\">\n                <AlertCircle className=\"h-4 w-4 text-blue-600\" />\n                <AlertDescription className=\"text-blue-900 text-sm\">\n                  <strong>{txtB2BNote}</strong>\n                  <br /><br />\n                  {txtExternalPurchaseNote}\n                </AlertDescription>\n              </Alert>\n\n              {/* 🔓 BOTÃO EXPLORAR PRIMEIRO - Apps nativas também podem explorar */}\n              <div className=\"mt-6 pt-4 border-t-2 border-dashed border-indigo-200\">\n                <div className=\"bg-gradient-to-r from-indigo-50 to-purple-50 rounded-xl p-4 border border-indigo-200\">\n                  <p className=\"text-center text-sm text-indigo-700 font-medium mb-3\">\n                    {txtExploreFirstDesc}\n                  </p>\n                  <Button\n                    variant=\"outline\"\n                    onClick={() => navigate(createPageUrl('BusinessHome'))}\n                    className=\"w-full border-2 border-indigo-400 text-indigo-700 hover:bg-indigo-100 hover:border-indigo-500 font-semibold py-5 text-base\"\n                  >\n                    {txtExploreFirst}\n                    <ArrowRight className=\"w-5 h-5 ml-2\" />\n                  </Button>\n                </div>\n              </div>\n              \n              <div className=\"mt-4 text-center text-xs text-slate-500\">\n                <p>Cancelamento e gestão da subscrição: waitless-qzero.com</p>\n              </div>\n            </CardContent>\n          </Card>\n        ) : (\n          /* ============================================ */\n          /* Web: Fluxo Stripe Normal */\n          /* ============================================ */\n          <Card className=\"border-0 shadow-2xl mb-8 sm:mb-12 overflow-hidden max-w-2xl mx-auto\">\n            <div className=\"h-2 bg-gradient-to-r from-indigo-600 to-purple-600\" />\n            <CardContent className=\"p-4 sm:p-6 md:p-8\">\n              <div className=\"text-center mb-6 sm:mb-8\">\n                {isEligibleForTrial && (\n                  <div className=\"inline-block px-3 sm:px-4 py-1 bg-gradient-to-r from-green-500 to-emerald-600 text-white text-xs sm:text-sm font-semibold rounded-full mb-3\">\n                    {txtFreeTrialBadge}\n                  </div>\n                )}\n                {isEligibleForTrial === false && (\n                  <div className=\"inline-block px-3 sm:px-4 py-1 bg-gradient-to-r from-indigo-600 to-purple-600 text-white text-xs sm:text-sm font-semibold rounded-full mb-3\">\n                    {txtMonthlyPlan}\n                  </div>\n                )}\n                {isEligibleForTrial ? (\n                  <div className=\"mb-2\">\n                    <div className=\"flex items-center justify-center gap-3 mb-1\">\n                      <span className=\"text-2xl sm:text-3xl text-slate-400 line-through font-medium\">\n                        €49,99\n                      </span>\n                      <span className=\"text-4xl sm:text-5xl md:text-6xl font-bold text-green-600\">\n                        €19,99\n                      </span>\n                    </div>\n                    <p className=\"text-sm sm:text-base text-slate-600 font-medium\">\n                      1º mês com <span className=\"text-green-600 font-bold\">60% desconto</span>\n                    </p>\n                    <p className=\"text-xs text-slate-500 mt-1\">\n                      Depois €49,99{txtPerMonth}\n                    </p>\n                  </div>\n                ) : (\n                  <div className=\"text-4xl sm:text-5xl md:text-6xl font-bold text-slate-900 mb-2\">\n                    €49,99\n                    <span className=\"text-xl sm:text-2xl text-slate-600 font-normal\">{txtPerMonth}</span>\n                  </div>\n                )}\n                <p className=\"text-sm sm:text-base text-slate-600\">{txtMonthlyBilling}</p>\n                \n                {isEligibleForTrial && (\n                  <div className=\"mt-4 p-4 bg-green-50 border border-green-200 rounded-lg\">\n                    <p className=\"text-sm text-green-800 font-semibold\">\n                      {txtNoCostsNow}\n                    </p>\n                    <p className=\"text-xs text-green-700 mt-1\">\n                      {txtPaymentAfter7Days}\n                    </p>\n                  </div>\n                )}\n                \n                {isEligibleForTrial === false && (\n                  <div className=\"mt-4 p-4 bg-blue-50 border border-blue-200 rounded-lg\">\n                    <p className=\"text-sm text-blue-800 font-semibold\">\n                      💳 <strong>{txtImmediateCharge}</strong> - {txtPaymentProcessedNow}\n                    </p>\n                    <p className=\"text-xs text-blue-700 mt-1\">\n                      {txtAlreadyUsedTrial}\n                    </p>\n                  </div>\n                )}\n              </div>\n\n              <div className=\"space-y-4 mb-8\">\n                {[\n                  txtFeature1,\n                  txtFeature2,\n                  txtFeature3,\n                  txtFeature4,\n                  txtFeature5,\n                  txtFeature6,\n                  txtFeature7,\n                  txtFeature8,\n                  txtFeature9\n                ].map((feature, idx) => (\n                  <div key={idx} className=\"flex items-start gap-3\">\n                    <CheckCircle2 className=\"w-5 h-5 text-green-600 flex-shrink-0 mt-0.5\" />\n                    <span className=\"text-slate-700\">{feature}</span>\n                  </div>\n                ))}\n              </div>\n\n              <Button\n                onClick={handlePayNow}\n                disabled={isProcessingPayment}\n                className=\"w-full bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-700 hover:to-purple-700 py-4 sm:py-6 text-sm sm:text-base md:text-lg\"\n              >\n                {isProcessingPayment ? (\n                  <>\n                    <Loader2 className=\"w-4 h-4 sm:w-5 sm:h-5 mr-2 animate-spin\" />\n                    <span>{txtProcessing}</span>\n                  </>\n                ) : (\n                  <>\n                    <CreditCard className=\"w-4 h-4 sm:w-5 sm:h-5 mr-2\" />\n                    {isEligibleForTrial ? (\n                      <>\n                        <span className=\"hidden sm:inline\">{txtPayBusinessPlan} - €19,99 (1º mês)</span>\n                        <span className=\"sm:hidden\">{txtPayShort} €19,99</span>\n                      </>\n                    ) : (\n                      <>\n                        <span className=\"hidden sm:inline\">{txtPayBusinessPlan} - €49,99{txtPerMonth}</span>\n                        <span className=\"sm:hidden\">{txtPayShort} €49,99{txtPerMonth}</span>\n                      </>\n                    )}\n                    <ArrowRight className=\"w-4 h-4 sm:w-5 sm:h-5 ml-2\" />\n                  </>\n                )}\n              </Button>\n\n              <p className=\"text-center text-sm text-slate-500 mt-4\">\n                {txtSecurePayment}\n              </p>\n\n              {/* 🔓 BOTÃO EXPLORAR PRIMEIRO - Permite ir ao BusinessHome sem pagar */}\n              <div className=\"mt-6 pt-4 border-t-2 border-dashed border-indigo-200\">\n                <div className=\"bg-gradient-to-r from-indigo-50 to-purple-50 rounded-xl p-4 border border-indigo-200\">\n                  <p className=\"text-center text-sm text-indigo-700 font-medium mb-3\">\n                    {txtExploreFirstDesc}\n                  </p>\n                  <Button\n                    variant=\"outline\"\n                    onClick={() => navigate(createPageUrl('BusinessHome'))}\n                    className=\"w-full border-2 border-indigo-400 text-indigo-700 hover:bg-indigo-100 hover:border-indigo-500 font-semibold py-5 text-base\"\n                  >\n                    {txtExploreFirst}\n                    <ArrowRight className=\"w-5 h-5 ml-2\" />\n                  </Button>\n                </div>\n              </div>\n              \n              <Alert className=\"mt-6 border-green-200 bg-green-50\">\n                <CheckCircle2 className=\"h-4 w-4 text-green-600\" />\n                <AlertDescription className=\"text-green-900 text-sm\">\n                  <strong>{txtFreeTrialPeriod}</strong> {txtFreeTrialDesc}\n                </AlertDescription>\n              </Alert>\n\n              <div className=\"mt-6 p-4 bg-slate-50 rounded-lg border border-slate-200\">\n                <h4 className=\"font-semibold text-slate-900 mb-3 text-sm\">\n                  Termos da Subscrição (Stripe)\n                </h4>\n                <div className=\"text-xs text-slate-600 space-y-2\">\n                  <p><strong>Plano:</strong> Plano Empresarial QZero</p>\n                  <p><strong>Duração:</strong> Mensal (renovação automática)</p>\n                  <p><strong>Preço:</strong> €49,99/mês</p>\n                  <p className=\"mt-3\">O pagamento é processado de forma segura através do Stripe.</p>\n                  <p>A subscrição renova-se automaticamente a menos que seja cancelada antes do fim do período atual.</p>\n                  <p>Pode cancelar a qualquer momento através do seu Perfil {\">\"} Gerir Subscrição.</p>\n                </div>\n                \n                <div className=\"mt-4 pt-3 border-t border-slate-200 flex flex-wrap gap-3 text-xs\">\n                  <a \n                    href=\"/privacy-policy\" \n                    target=\"_blank\"\n                    className=\"text-indigo-600 hover:text-indigo-700 underline\"\n                  >\n                    Política de Privacidade\n                  </a>\n                  <span className=\"text-slate-300\">|</span>\n                  <a \n                    href=\"/terms-of-use\" \n                    target=\"_blank\"\n                    className=\"text-indigo-600 hover:text-indigo-700 underline\"\n                  >\n                    Termos de Utilização\n                  </a>\n                </div>\n              </div>\n            </CardContent>\n          </Card>\n        )}\n\n        <div className=\"grid md:grid-cols-2 lg:grid-cols-3 gap-6 mb-12\">\n          {features.map((feature, idx) => (\n            <Card key={idx} className=\"border-0 shadow-lg hover:shadow-xl transition-shadow\">\n              <CardContent className=\"p-6\">\n                <div className=\"w-12 h-12 rounded-xl bg-gradient-to-br from-indigo-500 to-purple-600 flex items-center justify-center mb-4\">\n                  <feature.icon className=\"w-6 h-6 text-white\" />\n                </div>\n                <h3 className=\"font-bold text-lg text-slate-900 mb-2\">{feature.title}</h3>\n                <p className=\"text-slate-600 text-sm\">{feature.description}</p>\n              </CardContent>\n            </Card>\n          ))}\n        </div>\n\n        <Card className=\"border-0 shadow-xl max-w-3xl mx-auto\">\n          <CardHeader>\n            <CardTitle>{txtFAQ}</CardTitle>\n          </CardHeader>\n          <CardContent className=\"space-y-6\">\n            <div>\n              <h4 className=\"font-semibold text-slate-900 mb-2\">{txtFAQ1Question}</h4>\n              <p className=\"text-slate-600\">{txtFAQ1Answer}</p>\n            </div>\n            <div>\n              <h4 className=\"font-semibold text-slate-900 mb-2\">{txtFAQ2Question}</h4>\n              <p className=\"text-slate-600\">{txtFAQ2Answer}</p>\n            </div>\n            <div>\n              <h4 className=\"font-semibold text-slate-900 mb-2\">{txtFAQ3Question}</h4>\n              <p className=\"text-slate-600\">{txtFAQ3Answer}</p>\n            </div>\n            <div>\n              <h4 className=\"font-semibold text-slate-900 mb-2\">{txtFAQ4Question}</h4>\n              <p className=\"text-slate-600\">{txtFAQ4Answer}</p>\n            </div>\n          </CardContent>\n        </Card>\n      </div>\n    </div>\n  );\n}","path":null,"size_bytes":34456,"size_tokens":null},"src/pages/index.jsx":{"content":"import Layout from \"./Layout.jsx\";\n\nimport RootRedirect from \"./RootRedirect\";\n\nimport Home from \"./Home\";\n\nimport Businesses from \"./Businesses\";\n\nimport BusinessDetail from \"./BusinessDetail\";\n\nimport MyTickets from \"./MyTickets\";\n\nimport TicketView from \"./TicketView\";\n\nimport ManageSubscription from \"./ManageSubscription\";\n\nimport BusinessDashboard from \"./BusinessDashboard\";\n\nimport BusinessHome from \"./BusinessHome\";\n\nimport BusinessSettings from \"./BusinessSettings\";\n\nimport BusinessAccess from \"./BusinessAccess\";\n\nimport Settings from \"./Settings\";\n\nimport Dashboard from \"./Dashboard\";\n\nimport Onboarding from \"./Onboarding\";\n\nimport MyAppointments from \"./MyAppointments\";\n\nimport BusinessSubscription from \"./BusinessSubscription\";\n\nimport AppointmentManage from \"./AppointmentManage\";\n\nimport StripeCheckout from \"./StripeCheckout\";\n\nimport BusinessManageSubscription from \"./BusinessManageSubscription\";\n\nimport CustomerPortal from \"./CustomerPortal\";\n\nimport BusinessQueues from \"./BusinessQueues\";\n\nimport BusinessServices from \"./BusinessServices\";\n\nimport PaymentSuccess from \"./PaymentSuccess\";\n\nimport Profile from \"./Profile\";\n\nimport TicketPublic from \"./TicketPublic\";\n\nimport BusinessSupport from \"./BusinessSupport\";\n\nimport Support from \"./Support\";\n\nimport AdminSupport from \"./AdminSupport\";\n\nimport BusinessStaff from \"./BusinessStaff\";\n\nimport StaffInviteAccept from \"./StaffInviteAccept\";\n\nimport BusinessProfileSetup from \"./BusinessProfileSetup\";\n\nimport AdminActivate from \"./AdminActivate\";\n\nimport PainelTV from \"./PainelTV\";\n\nimport Login from \"./Login\";\n\nimport Register from \"./Register\";\n\nimport ForgotPassword from \"./ForgotPassword\";\n\nimport ResetPassword from \"./ResetPassword\";\n\nimport PrivacyPolicy from \"./PrivacyPolicy\";\n\nimport TermsOfUse from \"./TermsOfUse\";\n\nimport { BrowserRouter as Router, Route, Routes, useLocation } from 'react-router-dom';\n\nconst PAGES = {\n    \n    Home: Home,\n    \n    Businesses: Businesses,\n    \n    BusinessDetail: BusinessDetail,\n    \n    MyTickets: MyTickets,\n    \n    TicketView: TicketView,\n    \n    ManageSubscription: ManageSubscription,\n    \n    BusinessDashboard: BusinessDashboard,\n    \n    BusinessHome: BusinessHome,\n    \n    BusinessSettings: BusinessSettings,\n    \n    BusinessAccess: BusinessAccess,\n    \n    Settings: Settings,\n    \n    Dashboard: Dashboard,\n    \n    Onboarding: Onboarding,\n    \n    MyAppointments: MyAppointments,\n    \n    BusinessSubscription: BusinessSubscription,\n    \n    AppointmentManage: AppointmentManage,\n    \n    StripeCheckout: StripeCheckout,\n    \n    BusinessManageSubscription: BusinessManageSubscription,\n    \n    CustomerPortal: CustomerPortal,\n    \n    BusinessQueues: BusinessQueues,\n    \n    BusinessServices: BusinessServices,\n    \n    PaymentSuccess: PaymentSuccess,\n    \n    Profile: Profile,\n    \n    TicketPublic: TicketPublic,\n    \n    BusinessSupport: BusinessSupport,\n    \n    Support: Support,\n    \n    AdminSupport: AdminSupport,\n    \n    BusinessStaff: BusinessStaff,\n    \n    StaffInviteAccept: StaffInviteAccept,\n    \n    BusinessProfileSetup: BusinessProfileSetup,\n    \n    AdminActivate: AdminActivate,\n    \n    PainelTV: PainelTV,\n    \n    Login: Login,\n    \n    Register: Register,\n    \n    PrivacyPolicy: PrivacyPolicy,\n    \n    TermsOfUse: TermsOfUse,\n    \n}\n\nfunction _getCurrentPage(url) {\n    if (url.endsWith('/')) {\n        url = url.slice(0, -1);\n    }\n    let urlLastPart = url.split('/').pop();\n    if (urlLastPart.includes('?')) {\n        urlLastPart = urlLastPart.split('?')[0];\n    }\n\n    // Convert kebab-case to PascalCase for matching with PAGES keys\n    const urlInPascalCase = urlLastPart\n        .split('-')\n        .map(word => word.charAt(0).toUpperCase() + word.slice(1))\n        .join('');\n    \n    const pageName = Object.keys(PAGES).find(page => \n        page.toLowerCase() === urlLastPart.toLowerCase() || \n        page === urlInPascalCase\n    );\n    return pageName || Object.keys(PAGES)[0];\n}\n\n// Create a wrapper component that uses useLocation inside the Router context\nfunction PagesContent() {\n    const location = useLocation();\n    const currentPage = _getCurrentPage(location.pathname);\n    \n    // Painel TV sem Layout (fullscreen)\n    if (location.pathname === '/painel-tv') {\n        return <PainelTV />;\n    }\n    \n    // Login e Register sem Layout\n    if (location.pathname === '/login') {\n        return <Login />;\n    }\n    \n    if (location.pathname === '/register') {\n        return <Register />;\n    }\n    \n    // Forgot Password e Reset Password sem Layout\n    if (location.pathname === '/forgot-password') {\n        return <ForgotPassword />;\n    }\n    \n    if (location.pathname === '/reset-password') {\n        return <ResetPassword />;\n    }\n    \n    // Ticket Public sem Layout (página pública para QR codes)\n    if (location.pathname === '/ticket-public') {\n        return <TicketPublic />;\n    }\n    \n    // Privacy Policy e Terms of Use sem Layout (páginas públicas)\n    if (location.pathname === '/privacy-policy') {\n        return <PrivacyPolicy />;\n    }\n    \n    if (location.pathname === '/terms-of-use') {\n        return <TermsOfUse />;\n    }\n    \n    return (\n        <Layout currentPageName={currentPage}>\n            <Routes>            \n                \n                    <Route path=\"/\" element={<RootRedirect />} />\n                \n                \n                <Route path=\"/home\" element={<Home />} />\n                <Route path=\"/Home\" element={<Home />} />\n                \n                <Route path=\"/businesses\" element={<Businesses />} />\n                <Route path=\"/Businesses\" element={<Businesses />} />\n                \n                <Route path=\"/business-detail\" element={<BusinessDetail />} />\n                <Route path=\"/BusinessDetail\" element={<BusinessDetail />} />\n                \n                <Route path=\"/my-tickets\" element={<MyTickets />} />\n                <Route path=\"/MyTickets\" element={<MyTickets />} />\n                \n                <Route path=\"/ticket-view\" element={<TicketView />} />\n                <Route path=\"/TicketView\" element={<TicketView />} />\n                \n                <Route path=\"/manage-subscription\" element={<ManageSubscription />} />\n                <Route path=\"/ManageSubscription\" element={<ManageSubscription />} />\n                \n                <Route path=\"/business-dashboard\" element={<BusinessDashboard />} />\n                <Route path=\"/BusinessDashboard\" element={<BusinessDashboard />} />\n                \n                <Route path=\"/business-home\" element={<BusinessHome />} />\n                <Route path=\"/BusinessHome\" element={<BusinessHome />} />\n                \n                <Route path=\"/business-settings\" element={<BusinessSettings />} />\n                <Route path=\"/BusinessSettings\" element={<BusinessSettings />} />\n                \n                <Route path=\"/business-access\" element={<BusinessAccess />} />\n                <Route path=\"/BusinessAccess\" element={<BusinessAccess />} />\n                \n                <Route path=\"/settings\" element={<Settings />} />\n                <Route path=\"/Settings\" element={<Settings />} />\n                \n                <Route path=\"/dashboard\" element={<Dashboard />} />\n                <Route path=\"/Dashboard\" element={<Dashboard />} />\n                \n                <Route path=\"/onboarding\" element={<Onboarding />} />\n                <Route path=\"/Onboarding\" element={<Onboarding />} />\n                \n                <Route path=\"/my-appointments\" element={<MyAppointments />} />\n                <Route path=\"/MyAppointments\" element={<MyAppointments />} />\n                \n                <Route path=\"/business-subscription\" element={<BusinessSubscription />} />\n                <Route path=\"/BusinessSubscription\" element={<BusinessSubscription />} />\n                \n                <Route path=\"/appointment-manage\" element={<AppointmentManage />} />\n                <Route path=\"/AppointmentManage\" element={<AppointmentManage />} />\n                \n                <Route path=\"/stripe-checkout\" element={<StripeCheckout />} />\n                <Route path=\"/StripeCheckout\" element={<StripeCheckout />} />\n                \n                <Route path=\"/business-manage-subscription\" element={<BusinessManageSubscription />} />\n                <Route path=\"/BusinessManageSubscription\" element={<BusinessManageSubscription />} />\n                \n                <Route path=\"/customer-portal\" element={<CustomerPortal />} />\n                <Route path=\"/CustomerPortal\" element={<CustomerPortal />} />\n                \n                <Route path=\"/business-queues\" element={<BusinessQueues />} />\n                <Route path=\"/BusinessQueues\" element={<BusinessQueues />} />\n                \n                <Route path=\"/business-services\" element={<BusinessServices />} />\n                <Route path=\"/BusinessServices\" element={<BusinessServices />} />\n                \n                <Route path=\"/payment-success\" element={<PaymentSuccess />} />\n                <Route path=\"/PaymentSuccess\" element={<PaymentSuccess />} />\n                \n                <Route path=\"/profile\" element={<Profile />} />\n                <Route path=\"/Profile\" element={<Profile />} />\n                \n                <Route path=\"/support\" element={<Support />} />\n                <Route path=\"/Support\" element={<Support />} />\n                \n                <Route path=\"/business-support\" element={<BusinessSupport />} />\n                <Route path=\"/BusinessSupport\" element={<BusinessSupport />} />\n                \n                <Route path=\"/admin-support\" element={<AdminSupport />} />\n                <Route path=\"/AdminSupport\" element={<AdminSupport />} />\n                \n                <Route path=\"/business-staff\" element={<BusinessStaff />} />\n                <Route path=\"/BusinessStaff\" element={<BusinessStaff />} />\n                \n                <Route path=\"/staff-invite-accept\" element={<StaffInviteAccept />} />\n                <Route path=\"/StaffInviteAccept\" element={<StaffInviteAccept />} />\n                \n                <Route path=\"/business-profile-setup\" element={<BusinessProfileSetup />} />\n                <Route path=\"/BusinessProfileSetup\" element={<BusinessProfileSetup />} />\n                \n                <Route path=\"/admin-activate\" element={<AdminActivate />} />\n                <Route path=\"/AdminActivate\" element={<AdminActivate />} />\n                \n                \n            </Routes>\n        </Layout>\n    );\n}\n\nexport default function Pages() {\n    return (\n        <Router>\n            <PagesContent />\n        </Router>\n    );\n}","path":null,"size_bytes":10714,"size_tokens":null},"src/components/ui/aspect-ratio.jsx":{"content":"import * as AspectRatioPrimitive from \"@radix-ui/react-aspect-ratio\"\n\nconst AspectRatio = AspectRatioPrimitive.Root\n\nexport { AspectRatio }\n","path":null,"size_bytes":140,"size_tokens":null},"src/components/ui/scroll-area.jsx":{"content":"import * as React from \"react\"\nimport * as ScrollAreaPrimitive from \"@radix-ui/react-scroll-area\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst ScrollArea = React.forwardRef(({ className, children, ...props }, ref) => (\n  <ScrollAreaPrimitive.Root\n    ref={ref}\n    className={cn(\"relative overflow-hidden\", className)}\n    {...props}>\n    <ScrollAreaPrimitive.Viewport className=\"h-full w-full rounded-[inherit]\">\n      {children}\n    </ScrollAreaPrimitive.Viewport>\n    <ScrollBar />\n    <ScrollAreaPrimitive.Corner />\n  </ScrollAreaPrimitive.Root>\n))\nScrollArea.displayName = ScrollAreaPrimitive.Root.displayName\n\nconst ScrollBar = React.forwardRef(({ className, orientation = \"vertical\", ...props }, ref) => (\n  <ScrollAreaPrimitive.ScrollAreaScrollbar\n    ref={ref}\n    orientation={orientation}\n    className={cn(\n      \"flex touch-none select-none transition-colors\",\n      orientation === \"vertical\" &&\n        \"h-full w-2.5 border-l border-l-transparent p-[1px]\",\n      orientation === \"horizontal\" &&\n        \"h-2.5 flex-col border-t border-t-transparent p-[1px]\",\n      className\n    )}\n    {...props}>\n    <ScrollAreaPrimitive.ScrollAreaThumb className=\"relative flex-1 rounded-full bg-border\" />\n  </ScrollAreaPrimitive.ScrollAreaScrollbar>\n))\nScrollBar.displayName = ScrollAreaPrimitive.ScrollAreaScrollbar.displayName\n\nexport { ScrollArea, ScrollBar }\n","path":null,"size_bytes":1362,"size_tokens":null},"src/components/ui/tabs.jsx":{"content":"import * as React from \"react\"\nimport * as TabsPrimitive from \"@radix-ui/react-tabs\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Tabs = TabsPrimitive.Root\n\nconst TabsList = React.forwardRef(({ className, ...props }, ref) => (\n  <TabsPrimitive.List\n    ref={ref}\n    className={cn(\n      \"inline-flex h-9 items-center justify-center rounded-lg bg-muted p-1 text-muted-foreground\",\n      className\n    )}\n    {...props} />\n))\nTabsList.displayName = TabsPrimitive.List.displayName\n\nconst TabsTrigger = React.forwardRef(({ className, ...props }, ref) => (\n  <TabsPrimitive.Trigger\n    ref={ref}\n    className={cn(\n      \"inline-flex items-center justify-center whitespace-nowrap rounded-md px-3 py-1 text-sm font-medium ring-offset-background transition-all focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 data-[state=active]:bg-background data-[state=active]:text-foreground data-[state=active]:shadow\",\n      className\n    )}\n    {...props} />\n))\nTabsTrigger.displayName = TabsPrimitive.Trigger.displayName\n\nconst TabsContent = React.forwardRef(({ className, ...props }, ref) => (\n  <TabsPrimitive.Content\n    ref={ref}\n    className={cn(\n      \"mt-2 ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2\",\n      className\n    )}\n    {...props} />\n))\nTabsContent.displayName = TabsPrimitive.Content.displayName\n\nexport { Tabs, TabsList, TabsTrigger, TabsContent }\n","path":null,"size_bytes":1529,"size_tokens":null},"src/components/ui/toaster.jsx":{"content":"import { useToast } from \"@/components/ui/use-toast\";\nimport {\n  Toast,\n  ToastClose,\n  ToastDescription,\n  ToastProvider,\n  ToastTitle,\n  ToastViewport,\n} from \"@/components/ui/toast\";\n\nexport function Toaster() {\n  const { toasts } = useToast();\n\n  return (\n    <ToastProvider>\n      {toasts.map(function ({ id, title, description, action, ...props }) {\n        return (\n          <Toast key={id} {...props}>\n            <div className=\"grid gap-1\">\n              {title && <ToastTitle>{title}</ToastTitle>}\n              {description && (\n                <ToastDescription>{description}</ToastDescription>\n              )}\n            </div>\n            {action}\n            <ToastClose />\n          </Toast>\n        );\n      })}\n      <ToastViewport />\n    </ToastProvider>\n  );\n} ","path":null,"size_bytes":785,"size_tokens":null},"src/components/ui/select.jsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as SelectPrimitive from \"@radix-ui/react-select\"\nimport { Check, ChevronDown, ChevronUp } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Select = SelectPrimitive.Root\n\nconst SelectGroup = SelectPrimitive.Group\n\nconst SelectValue = SelectPrimitive.Value\n\nconst SelectTrigger = React.forwardRef(({ className, children, ...props }, ref) => (\n  <SelectPrimitive.Trigger\n    ref={ref}\n    className={cn(\n      \"flex h-9 w-full items-center justify-between whitespace-nowrap rounded-md border border-input bg-transparent px-3 py-2 text-sm shadow-sm ring-offset-background data-[placeholder]:text-muted-foreground focus:outline-none focus:ring-1 focus:ring-ring disabled:cursor-not-allowed disabled:opacity-50 [&>span]:line-clamp-1\",\n      className\n    )}\n    {...props}>\n    {children}\n    <SelectPrimitive.Icon asChild>\n      <ChevronDown className=\"h-4 w-4 opacity-50\" />\n    </SelectPrimitive.Icon>\n  </SelectPrimitive.Trigger>\n))\nSelectTrigger.displayName = SelectPrimitive.Trigger.displayName\n\nconst SelectScrollUpButton = React.forwardRef(({ className, ...props }, ref) => (\n  <SelectPrimitive.ScrollUpButton\n    ref={ref}\n    className={cn(\"flex cursor-default items-center justify-center py-1\", className)}\n    {...props}>\n    <ChevronUp className=\"h-4 w-4\" />\n  </SelectPrimitive.ScrollUpButton>\n))\nSelectScrollUpButton.displayName = SelectPrimitive.ScrollUpButton.displayName\n\nconst SelectScrollDownButton = React.forwardRef(({ className, ...props }, ref) => (\n  <SelectPrimitive.ScrollDownButton\n    ref={ref}\n    className={cn(\"flex cursor-default items-center justify-center py-1\", className)}\n    {...props}>\n    <ChevronDown className=\"h-4 w-4\" />\n  </SelectPrimitive.ScrollDownButton>\n))\nSelectScrollDownButton.displayName =\n  SelectPrimitive.ScrollDownButton.displayName\n\nconst SelectContent = React.forwardRef(({ className, children, position = \"popper\", ...props }, ref) => (\n  <SelectPrimitive.Portal>\n    <SelectPrimitive.Content\n      ref={ref}\n      className={cn(\n        \"relative z-50 max-h-96 min-w-[8rem] overflow-hidden rounded-md border bg-popover text-popover-foreground shadow-md data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2\",\n        position === \"popper\" &&\n          \"data-[side=bottom]:translate-y-1 data-[side=left]:-translate-x-1 data-[side=right]:translate-x-1 data-[side=top]:-translate-y-1\",\n        className\n      )}\n      position={position}\n      {...props}>\n      <SelectScrollUpButton />\n      <SelectPrimitive.Viewport\n        className={cn(\"p-1\", position === \"popper\" &&\n          \"h-[var(--radix-select-trigger-height)] w-full min-w-[var(--radix-select-trigger-width)]\")}>\n        {children}\n      </SelectPrimitive.Viewport>\n      <SelectScrollDownButton />\n    </SelectPrimitive.Content>\n  </SelectPrimitive.Portal>\n))\nSelectContent.displayName = SelectPrimitive.Content.displayName\n\nconst SelectLabel = React.forwardRef(({ className, ...props }, ref) => (\n  <SelectPrimitive.Label\n    ref={ref}\n    className={cn(\"px-2 py-1.5 text-sm font-semibold\", className)}\n    {...props} />\n))\nSelectLabel.displayName = SelectPrimitive.Label.displayName\n\nconst SelectItem = React.forwardRef(({ className, children, ...props }, ref) => (\n  <SelectPrimitive.Item\n    ref={ref}\n    className={cn(\n      \"relative flex w-full cursor-default select-none items-center rounded-sm py-1.5 pl-2 pr-8 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      className\n    )}\n    {...props}>\n    <span className=\"absolute right-2 flex h-3.5 w-3.5 items-center justify-center\">\n      <SelectPrimitive.ItemIndicator>\n        <Check className=\"h-4 w-4\" />\n      </SelectPrimitive.ItemIndicator>\n    </span>\n    <SelectPrimitive.ItemText>{children}</SelectPrimitive.ItemText>\n  </SelectPrimitive.Item>\n))\nSelectItem.displayName = SelectPrimitive.Item.displayName\n\nconst SelectSeparator = React.forwardRef(({ className, ...props }, ref) => (\n  <SelectPrimitive.Separator\n    ref={ref}\n    className={cn(\"-mx-1 my-1 h-px bg-muted\", className)}\n    {...props} />\n))\nSelectSeparator.displayName = SelectPrimitive.Separator.displayName\n\nexport {\n  Select,\n  SelectGroup,\n  SelectValue,\n  SelectTrigger,\n  SelectContent,\n  SelectLabel,\n  SelectItem,\n  SelectSeparator,\n  SelectScrollUpButton,\n  SelectScrollDownButton,\n}\n","path":null,"size_bytes":4677,"size_tokens":null},"src/pages/PaymentSuccess.jsx":{"content":"import React, { useState, useEffect } from \"react\";\nimport { base44 } from \"@/api/base44Client\";\nimport { safeFetch } from \"@/utils/apiConfig\";\nimport { Card, CardContent } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { CheckCircle2, Loader2, ArrowRight, Building2, Mail } from \"lucide-react\";\nimport { createPageUrl } from \"@/utils\";\nimport { companyProfileStorage, normalizeCategory, normalizeCountry } from '@/models/companyProfile';\nimport { toast } from \"sonner\";\nimport { useAutoTranslate } from '@/hooks/useTranslate';\n\nexport default function PaymentSuccessPage() {\n  const [status, setStatus] = useState('checking');\n  const [companyProfile, setCompanyProfile] = useState(null);\n  const [retryCount, setRetryCount] = useState(0);\n\n  // Translations\n  const txtProcessingPayment = useAutoTranslate('A processar pagamento...', 'pt');\n  const txtPleaseWait = useAutoTranslate('Por favor aguarde enquanto confirmamos o seu pagamento', 'pt');\n  const txtAttempt = useAutoTranslate('Tentativa', 'pt');\n  const txtPaymentProcessing = useAutoTranslate('Pagamento em Processamento', 'pt');\n  const txtPaymentBeingProcessed = useAutoTranslate('O seu pagamento está a ser processado. Pode demorar alguns minutos. Por favor, tente aceder ao painel empresarial dentro de momentos.', 'pt');\n  const txtGoToDashboard = useAutoTranslate('Ir para Dashboard', 'pt');\n  const txtAccountActivated = useAutoTranslate('Conta Ativada!', 'pt');\n  const txtCongratulations = useAutoTranslate('Parabéns! A sua conta empresarial está ativa.', 'pt');\n  const txtFreeTrialActive = useAutoTranslate('Período de Teste Grátis Ativo!', 'pt');\n  const txtFreeTrialDetails = useAutoTranslate('Tem 7 dias para testar todas as funcionalidades GRATUITAMENTE. O pagamento só será processado após este período. Pode cancelar a qualquer momento sem qualquer custo.', 'pt');\n  const txtPlan = useAutoTranslate('Plano:', 'pt');\n  const txtBusinessPlan = useAutoTranslate('Empresarial', 'pt');\n  const txtStatus = useAutoTranslate('Status:', 'pt');\n  const txtFreeTrial = useAutoTranslate('Teste Grátis (7 dias)', 'pt');\n  const txtEmail = useAutoTranslate('Email:', 'pt');\n  const txtRedirecting = useAutoTranslate('A redirecionar para o seu painel empresarial...', 'pt');\n  const txtGoToBusinessPanel = useAutoTranslate('Ir para Painel Empresarial', 'pt');\n  const txtErrorProfile = useAutoTranslate('Erro: Perfil empresarial não encontrado.', 'pt');\n  const txtTryAgain = useAutoTranslate('Por favor, tente criar sua conta novamente.', 'pt');\n  const txtGoBack = useAutoTranslate('Anterior', 'pt');\n  const txtErrorConfigProfile = useAutoTranslate('Erro ao configurar perfil empresarial. Por favor, contacte o suporte.', 'pt');\n  const txtSecurityError = useAutoTranslate('Erro de Segurança', 'pt');\n  const txtInvalidSession = useAutoTranslate('Sessão inválida detectada. Use o fluxo de pagamento oficial.', 'pt');\n\n  const urlParams = new URLSearchParams(window.location.search);\n  const sessionId = urlParams.get('session_id');\n  const profileId = urlParams.get('profile_id'); // Para modo demo\n\n  useEffect(() => {\n    const checkPayment = async () => {\n      try {\n        console.log('=== PAYMENT SUCCESS - INICIANDO VERIFICAÇÃO ===');\n        console.log('Session ID:', sessionId);\n        console.log('Profile ID (query):', profileId);\n        console.log('LocalStorage mock_user:', localStorage.getItem('mock_user'));\n        console.log('LocalStorage company_profiles:', localStorage.getItem('company_profiles'));\n        \n        if (!sessionId) {\n          console.error('❌ Sem session_id!');\n          setStatus('error');\n          return;\n        }\n\n        // SEGURANÇA: Verificar se é modo demo (session_id começa com \"mock_\")\n        // EM PRODUÇÃO, mock sessions SÃO REJEITADAS automaticamente\n        const isMockSession = sessionId.startsWith('mock_session_');\n        const isDevelopment = import.meta.env.DEV;\n        \n        console.log('🔍 Verificando pagamento:', { \n          sessionId, \n          isMockSession, \n          isDevelopment,\n          allowMock: isDevelopment && isMockSession \n        });\n\n        // PROTEÇÃO DE SEGURANÇA: Rejeitar mock sessions em produção\n        if (isMockSession && !isDevelopment) {\n          console.error('❌ SEGURANÇA: Tentativa de usar mock session em PRODUÇÃO bloqueada!');\n          console.error('Session ID suspeito:', sessionId);\n          toast.error(txtSecurityError, {\n            description: txtInvalidSession,\n            duration: 5000\n          });\n          setStatus('error');\n          return;\n        }\n\n        let verifyData;\n        \n        if (isMockSession && isDevelopment) {\n          // Modo demo: APENAS em desenvolvimento\n          console.log('💡 Modo Demo (DEV only): Pagamento simulado');\n          \n          if (!profileId) {\n            console.error('❌ Modo demo mas sem profile_id no query string!');\n            setStatus('error');\n            return;\n          }\n          \n          verifyData = {\n            success: true,\n            status: 'active',\n            companyProfileId: profileId\n          };\n          \n          console.log('✅ Modo Demo: Usando profile_id do query string:', profileId);\n        } else {\n          // Modo real: SEMPRE verificar com backend Stripe em produção\n          console.log('🔒 Modo Produção: Verificando com Stripe backend...');\n          const { response: verifyResponse, data } = await safeFetch('/api/verify-payment', {\n            method: 'POST',\n            body: JSON.stringify({ sessionId })\n          });\n\n          verifyData = data || {};\n          console.log('📊 Resposta da verificação Stripe:', verifyData);\n        }\n\n        // ✅ Aceitar tanto 'active' quanto 'trialing' (período de teste grátis)\n        const isValidStatus = verifyData.success && (\n          verifyData.status === 'active' || \n          verifyData.status === 'trialing' ||\n          verifyData.isTrialing === true\n        );\n\n        if (isValidStatus) {\n          const paymentStatusMessage = verifyData.status === 'trialing' || verifyData.isTrialing\n            ? '✅ Período de teste grátis ativado (2 dias)'\n            : '✅ Pagamento verificado como PAGO';\n          console.log(paymentStatusMessage);\n          \n          let profile = null;\n          \n          // No modo mock, buscar DIRETAMENTE pelo ID sem depender do email\n          if (isMockSession && verifyData.companyProfileId) {\n            console.log('🔍 Modo Mock: Buscando perfil diretamente pelo ID:', verifyData.companyProfileId);\n            profile = await companyProfileStorage.getById(verifyData.companyProfileId);\n            \n            if (!profile) {\n              console.error('❌ Modo Mock: Perfil não encontrado pelo ID:', verifyData.companyProfileId);\n              toast.error(txtErrorProfile, {\n                description: txtTryAgain,\n                action: {\n                  label: txtGoBack,\n                  onClick: () => window.location.href = createPageUrl('BusinessProfileSetup')\n                }\n              });\n              setStatus('error');\n              return;\n            }\n            \n            console.log('✅ Modo Mock: Perfil encontrado:', {\n              id: profile.id,\n              name: profile.companyName,\n              status: profile.status,\n              adminUserId: profile.adminUserId\n            });\n            \n            // CRÍTICO: No modo mock, SEMPRE ativar o perfil independente do status atual\n            // Isso resolve race conditions com simulateSuccessfulPayment\n            console.log('💳 Modo Mock: Ativando perfil automaticamente (status atual:', profile.status + ')');\n            await companyProfileStorage.update(profile.id, {\n              status: 'active',\n              subscriptionStatus: 'active'\n            });\n            \n            // Recarregar o perfil atualizado\n            profile = await companyProfileStorage.getById(profile.id);\n            console.log('✅ Modo Mock: Perfil ativado:', profile.status);\n          } else {\n            // Modo real Stripe: buscar pelo ID do usuário\n            const user = await base44.auth.me();\n            console.log('👤 Utilizador atual:', {\n              id: user.id,\n              email: user.email,\n              account_type: user.account_type,\n              has_business_subscription: user.has_business_subscription,\n              business_profile_completed: user.business_profile_completed,\n              business_id: user.business_id\n            });\n            \n            profile = await companyProfileStorage.getByUserId(user.id);\n            console.log('🏢 Perfil da empresa:', profile ? {\n              id: profile.id,\n              name: profile.companyName,\n              status: profile.status,\n              adminUserId: profile.adminUserId\n            } : 'NÃO ENCONTRADO');\n            \n            // Se não encontrar perfil para este email, procurar pelo companyProfileId retornado pela Stripe\n            if (!profile && verifyData.companyProfileId) {\n              console.log('🔍 Procurando perfil pelo ID retornado pela Stripe:', verifyData.companyProfileId);\n              profile = await companyProfileStorage.getById(verifyData.companyProfileId);\n              \n              if (profile) {\n                console.log('⚠️ Perfil encontrado mas com email diferente!');\n                console.log('Email do perfil:', profile.adminUserId);\n                console.log('Email do utilizador:', user.email);\n                console.log('🔧 Corrigindo email do perfil...');\n                \n                // CORRIGIR: Atualizar o ID do admin do perfil para corresponder ao utilizador atual\n                await companyProfileStorage.update(profile.id, {\n                  adminUserId: user.id\n                });\n                \n                // Recarregar o perfil atualizado\n                profile = await companyProfileStorage.getById(profile.id);\n                console.log('✅ Email do perfil corrigido para:', profile.adminUserId);\n              }\n            }\n            \n            if (!profile) {\n              console.error('❌ ERRO: Perfil da empresa não encontrado!');\n              console.error('Email do utilizador:', user.email);\n              console.error('Company Profile ID da Stripe:', verifyData.companyProfileId);\n              toast.error(txtErrorProfile + ' ' + txtTryAgain);\n              setStatus('error');\n              return;\n            }\n          }\n          \n          // Determinar subscriptionStatus baseado na resposta Stripe\n          const subscriptionStatus = verifyData.status || 'active';\n          const profileStatusMessage = subscriptionStatus === 'trialing'\n            ? 'TRIAL (2 dias grátis)'\n            : 'ACTIVE';\n          \n          console.log(`🔄 Atualizando perfil da empresa para ${profileStatusMessage}...`);\n          const activatedProfile = await companyProfileStorage.update(profile.id, {\n            status: 'active', // Status da conta sempre 'active' (features habilitadas)\n            subscriptionStatus: subscriptionStatus // 'trialing' ou 'active' do Stripe\n          });\n          console.log(`✅ Perfil da empresa ativado com status: ${subscriptionStatus}`);\n          \n          // 🏢 CRIAR ENTIDADE BUSINESS (usada em toda a aplicação)\n          console.log('🏢 Criando entidade Business a partir do CompanyProfile...');\n          \n          // Função de normalização: CompanyProfile (camelCase) → Business (snake_case)\n          const normalizeProfileForBusiness = (profile) => {\n            // Validar campos obrigatórios\n            const requiredFields = {\n              companyName: 'Nome da empresa',\n              companyEmail: 'Email',\n              companyCategory: 'Categoria',\n              companyCity: 'Cidade',\n              companyPostalCode: 'Código postal',\n              companyStreetName: 'Nome da rua',\n              companyDoorNumber: 'Número da porta',\n              companyDistrict: 'Distrito/Região'\n            };\n            \n            const missingFields = [];\n            for (const [field, label] of Object.entries(requiredFields)) {\n              if (!profile[field]) {\n                missingFields.push(label);\n              }\n            }\n            \n            if (missingFields.length > 0) {\n              throw new Error(`Campos obrigatórios faltando: ${missingFields.join(', ')}`);\n            }\n            \n            // Mapear camelCase → snake_case com valores garantidos\n            // Normalizar categoria e país (legado → códigos)\n            const normalizedCategory = normalizeCategory(profile.companyCategory);\n            const normalizedCountry = normalizeCountry(profile.companyCountry);\n            \n            return {\n              id: profile.id,\n              name: profile.companyName,\n              description: profile.companyDescription || '',\n              category: normalizedCategory,\n              address: profile.companyAddress || `${profile.companyStreetName} ${profile.companyDoorNumber}`,\n              street_name: profile.companyStreetName,\n              door_number: profile.companyDoorNumber,\n              postal_code: profile.companyPostalCode,\n              city: profile.companyCity,\n              district: profile.companyDistrict,\n              country: normalizedCountry,\n              phone: profile.companyPhone || '',\n              email: profile.companyEmail,\n              logo_url: profile.logoUrl || '',\n              photo_url: profile.photoUrl || '',\n              is_active: true,\n              owner_email: profile.adminUserId,\n              latitude: profile.companyCoordinates?.lat || null,\n              longitude: profile.companyCoordinates?.lng || null\n            };\n          };\n          \n          try {\n            // Verificar se já existe Business com este ID\n            const existingBusinesses = await base44.entities.Business.filter({ id: profile.id });\n            \n            if (existingBusinesses.length === 0) {\n              // Criar Business entity com normalização\n              const businessData = normalizeProfileForBusiness(profile);\n              await base44.entities.Business.create(businessData);\n              console.log('✅ Entidade Business criada com sucesso:', profile.id);\n            } else {\n              console.log('⚠️ Business já existe, atualizando dados...');\n              const businessData = normalizeProfileForBusiness(profile);\n              await base44.entities.Business.update(profile.id, businessData);\n              console.log('✅ Entidade Business atualizada');\n            }\n          } catch (businessError) {\n            console.error('❌ Erro ao criar/atualizar Business:', businessError);\n            toast.error(txtErrorConfigProfile);\n            // Não bloquear o fluxo, mas mostrar erro ao utilizador\n          }\n          \n          // ⚠️ CRÍTICO: Sincronizar mock_user IMEDIATAMENTE para prevenir loops\n          // Layout.jsx usa mock_user.has_business_subscription para decidir redirecionamentos\n          // Se não atualizarmos ANTES de redirecionar, Layout causará loop infinito\n          console.log('🔄 Atualizando utilizador com todas as flags...');\n          const currentUser = JSON.parse(localStorage.getItem('mock_user') || '{}');\n          currentUser.has_business_subscription = true;\n          currentUser.business_profile_completed = true;\n          currentUser.business_id = profile.id;\n          currentUser.is_business_user = true;\n          currentUser.account_type = currentUser.account_type || 'empresa';\n          currentUser.onboarding_completed = true;\n          \n          // ⚠️ IMPORTANTE: Persistir ANTES de redirecionar\n          localStorage.setItem('mock_user', JSON.stringify(currentUser));\n          console.log('✅ Utilizador atualizado no localStorage ANTES do redirect');\n          console.log('✅ Flags atualizadas:', {\n            has_business_subscription: currentUser.has_business_subscription,\n            business_profile_completed: currentUser.business_profile_completed,\n            business_id: currentUser.business_id\n          });\n          \n          console.log('📊 Dados finais:', {\n            profile_id: profile.id,\n            profile_status: 'active',\n            user_email: currentUser.email,\n            has_subscription: true,\n            profile_completed: true,\n            account_type: currentUser.account_type\n          });\n          \n          setCompanyProfile(activatedProfile || profile);\n          setStatus('success');\n          \n          console.log('⏱️ Aguardando 3 segundos antes de redirecionar...');\n          setTimeout(() => {\n            console.log('🚀 Redirecionando para BusinessDashboard...');\n            console.log('🔍 Verificação final antes do redirect:', {\n              localStorage_user: JSON.parse(localStorage.getItem('mock_user') || '{}'),\n              profile_id: profile.id\n            });\n            window.location.href = createPageUrl('BusinessDashboard');\n          }, 3000);\n        } else if (retryCount < 10) {\n          setTimeout(() => {\n            setRetryCount(prev => prev + 1);\n          }, 1000);\n        } else {\n          setStatus('pending');\n        }\n      } catch (error) {\n        console.error('Payment check error:', error);\n        if (retryCount < 5) {\n          setTimeout(() => {\n            setRetryCount(prev => prev + 1);\n          }, 2000);\n        } else {\n          setStatus('error');\n        }\n      }\n    };\n\n    checkPayment();\n  }, [retryCount, sessionId]);\n\n  if (status === 'checking') {\n    return (\n      <div className=\"bg-gradient-to-br from-slate-50 via-blue-50 to-sky-50 flex items-center justify-center p-4\">\n        <Card className=\"border-0 shadow-2xl max-w-md w-full\">\n          <CardContent className=\"p-12 text-center\">\n            <Loader2 className=\"w-16 h-16 animate-spin text-purple-600 mx-auto mb-6\" />\n            <h2 className=\"text-2xl font-bold text-slate-900 mb-2\">\n              {txtProcessingPayment}\n            </h2>\n            <p className=\"text-slate-600\">\n              {txtPleaseWait}\n            </p>\n            {retryCount > 0 && (\n              <p className=\"text-sm text-slate-500 mt-2\">\n                {txtAttempt} {retryCount}/5\n              </p>\n            )}\n          </CardContent>\n        </Card>\n      </div>\n    );\n  }\n\n  if (status === 'pending' || status === 'error') {\n    return (\n      <div className=\"bg-gradient-to-br from-slate-50 via-blue-50 to-sky-50 flex items-center justify-center p-4\">\n        <Card className=\"border-0 shadow-2xl max-w-md w-full\">\n          <CardContent className=\"p-12 text-center\">\n            <div className=\"w-16 h-16 rounded-full bg-amber-100 flex items-center justify-center mx-auto mb-6\">\n              <div className=\"text-4xl\">⚠️</div>\n            </div>\n            <h2 className=\"text-2xl font-bold text-slate-900 mb-2\">\n              {txtPaymentProcessing}\n            </h2>\n            <p className=\"text-slate-600 mb-6\">\n              {txtPaymentBeingProcessed}\n            </p>\n            <Button \n              onClick={() => window.location.href = createPageUrl('BusinessDashboard')}\n              className=\"w-full\"\n            >\n              {txtGoToDashboard}\n            </Button>\n          </CardContent>\n        </Card>\n      </div>\n    );\n  }\n\n  const handleContinue = () => {\n    window.location.href = createPageUrl('BusinessDashboard');\n  };\n\n  return (\n    <div className=\"bg-gradient-to-br from-slate-50 via-blue-50 to-sky-50 flex items-center justify-center p-4\">\n      <Card className=\"border-0 shadow-2xl max-w-md w-full overflow-hidden\">\n        <div className=\"h-2 bg-gradient-to-r from-green-500 to-emerald-500\" />\n        <CardContent className=\"p-12 text-center\">\n          <div className=\"w-20 h-20 rounded-full bg-gradient-to-br from-green-500 to-emerald-500 flex items-center justify-center mx-auto mb-6 animate-scale-in\">\n            <CheckCircle2 className=\"w-10 h-10 text-white\" />\n          </div>\n          <h1 className=\"text-3xl font-bold text-slate-900 mb-3\">\n            {txtAccountActivated} 🎉\n          </h1>\n          <p className=\"text-lg text-slate-600 mb-4\">\n            {txtCongratulations}\n          </p>\n          \n          <div className=\"bg-green-50 border border-green-200 rounded-lg p-4 mb-6\">\n            <p className=\"text-sm text-green-800 font-semibold\">\n              ✨ <strong>{txtFreeTrialActive}</strong>\n            </p>\n            <p className=\"text-xs text-green-700 mt-1\">\n              {txtFreeTrialDetails}\n            </p>\n          </div>\n\n          {companyProfile && (\n            <div className=\"bg-slate-50 rounded-lg p-4 mb-6 text-left\">\n              <div className=\"flex items-center gap-2 mb-3\">\n                <Building2 className=\"w-5 h-5 text-indigo-600\" />\n                <span className=\"font-semibold text-slate-900\">{companyProfile.companyName}</span>\n              </div>\n              <div className=\"space-y-2 text-sm\">\n                <div className=\"flex justify-between\">\n                  <span className=\"text-slate-600\">{txtPlan}</span>\n                  <span className=\"font-semibold text-slate-900\">{txtBusinessPlan} - €49,99/mês</span>\n                </div>\n                <div className=\"flex justify-between\">\n                  <span className=\"text-slate-600\">{txtStatus}</span>\n                  <span className=\"text-green-600 font-semibold\">{txtFreeTrial}</span>\n                </div>\n                <div className=\"flex items-center justify-between\">\n                  <span className=\"text-slate-600\">{txtEmail}</span>\n                  <span className=\"font-semibold text-slate-900 text-xs flex items-center gap-1\">\n                    <Mail className=\"w-3 h-3\" />\n                    {companyProfile.companyEmail}\n                  </span>\n                </div>\n              </div>\n            </div>\n          )}\n\n          <p className=\"text-sm text-slate-500 mb-6\">\n            {txtRedirecting}\n          </p>\n\n          <Button\n            onClick={handleContinue}\n            className=\"w-full bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-700 hover:to-purple-700\"\n          >\n            {txtGoToBusinessPanel}\n            <ArrowRight className=\"w-4 h-4 ml-2\" />\n          </Button>\n        </CardContent>\n      </Card>\n    </div>\n  );\n}","path":null,"size_bytes":22508,"size_tokens":null},"src/components/business/ServiceScheduleConfig.jsx":{"content":"import React, { useState, useEffect } from \"react\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Label } from \"@/components/ui/label\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Calendar } from \"@/components/ui/calendar\";\nimport { Popover, PopoverContent, PopoverTrigger } from \"@/components/ui/popover\";\nimport { Switch } from \"@/components/ui/switch\";\nimport { Plus, X, Clock, CalendarX } from \"lucide-react\";\nimport { format } from \"date-fns\";\nimport { pt } from \"date-fns/locale\";\nimport { useAutoTranslate } from \"@/hooks/useTranslate\";\n\nexport default function ServiceScheduleConfig({ formData, setFormData }) {\n  const txtSunday = useAutoTranslate('Domingo', 'pt');\n  const txtMonday = useAutoTranslate('Segunda-feira', 'pt');\n  const txtTuesday = useAutoTranslate('Terça-feira', 'pt');\n  const txtWednesday = useAutoTranslate('Quarta-feira', 'pt');\n  const txtThursday = useAutoTranslate('Quinta-feira', 'pt');\n  const txtFriday = useAutoTranslate('Sexta-feira', 'pt');\n  const txtSaturday = useAutoTranslate('Sábado', 'pt');\n  const txtWorkingHours = useAutoTranslate('Horários de Funcionamento', 'pt');\n  const txtStart = useAutoTranslate('Início', 'pt');\n  const txtEnd = useAutoTranslate('Fim', 'pt');\n  const txtBreakStart = useAutoTranslate('Pausa Início', 'pt');\n  const txtBreakEnd = useAutoTranslate('Pausa Fim', 'pt');\n  const txtOptional = useAutoTranslate('opcional', 'pt');\n  const txtBlockedDates = useAutoTranslate('Datas Bloqueadas (Férias/Feriados)', 'pt');\n  const txtSelectDate = useAutoTranslate('Selecionar data', 'pt');\n\n  const daysOfWeek = [\n    { value: 'sunday', label: txtSunday },\n    { value: 'monday', label: txtMonday },\n    { value: 'tuesday', label: txtTuesday },\n    { value: 'wednesday', label: txtWednesday },\n    { value: 'thursday', label: txtThursday },\n    { value: 'friday', label: txtFriday },\n    { value: 'saturday', label: txtSaturday }\n  ];\n  const [blockDate, setBlockDate] = useState(null);\n\n  useEffect(() => {\n    const dayNames = ['sunday', 'monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday'];\n    \n    const hasCustomSchedules = formData.custom_schedules && Object.keys(formData.custom_schedules).length > 0;\n    \n    const hasLegacyAvailableDays = () => {\n      if (!formData.available_days || formData.available_days.length === 0) return false;\n      if (!formData.working_hours || Object.keys(formData.working_hours).length === 0) return true;\n      \n      return formData.available_days.some(dayNum => {\n        const dayName = dayNames[dayNum];\n        return !formData.working_hours[dayName] || typeof formData.working_hours[dayName].enabled === 'undefined';\n      });\n    };\n    \n    const isWorkingHoursNormalized = () => {\n      if (!formData.working_hours || Object.keys(formData.working_hours).length === 0) return false;\n      if (!hasCustomSchedules) return true;\n      \n      return Object.entries(formData.custom_schedules).every(([dayNum, schedule]) => {\n        const dayName = dayNames[parseInt(dayNum)];\n        const wh = formData.working_hours[dayName];\n        return wh && typeof wh.enabled !== 'undefined';\n      });\n    };\n    \n    const needsMigration = (hasCustomSchedules && !isWorkingHoursNormalized()) || hasLegacyAvailableDays();\n    \n    if (!needsMigration) return;\n    \n    const working_hours = { ...(formData.working_hours || {}) };\n    \n    if (hasCustomSchedules) {\n      Object.entries(formData.custom_schedules).forEach(([dayNum, schedule]) => {\n        const dayName = dayNames[parseInt(dayNum)];\n        working_hours[dayName] = {\n          enabled: true,\n          start: schedule.start || '09:00',\n          end: schedule.end || '18:00',\n          break_start: schedule.breaks?.[0]?.start || '',\n          break_end: schedule.breaks?.[0]?.end || ''\n        };\n      });\n    }\n    \n    if (formData.available_days && formData.available_days.length > 0) {\n      formData.available_days.forEach(dayNum => {\n        const dayName = dayNames[dayNum];\n        if (!working_hours[dayName] || typeof working_hours[dayName].enabled === 'undefined') {\n          working_hours[dayName] = {\n            enabled: true,\n            start: formData.start_time || '09:00',\n            end: formData.end_time || '18:00',\n            break_start: '',\n            break_end: ''\n          };\n        }\n      });\n    }\n    \n    const available_days = [];\n    dayNames.forEach((dayName, index) => {\n      if (working_hours[dayName]?.enabled) {\n        available_days.push(index);\n      }\n    });\n    \n    const currentAvailableDays = formData.available_days || [];\n    const workingHoursChanged = JSON.stringify(working_hours) !== JSON.stringify(formData.working_hours || {});\n    const availableDaysChanged = \n      available_days.length !== currentAvailableDays.length ||\n      !available_days.every(day => currentAvailableDays.includes(day));\n    \n    if (workingHoursChanged || availableDaysChanged) {\n      const { custom_schedules, ...cleanedFormData } = formData;\n      setFormData({ ...cleanedFormData, working_hours, available_days });\n    }\n  }, [formData.id]);\n\n  useEffect(() => {\n    if (formData.working_hours && Object.keys(formData.working_hours).length > 0) {\n      const dayNames = ['sunday', 'monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday'];\n      const computed_available_days = [];\n      dayNames.forEach((dayName, index) => {\n        if (formData.working_hours[dayName]?.enabled) {\n          computed_available_days.push(index);\n        }\n      });\n      \n      const current_available_days = formData.available_days || [];\n      const needsSync = \n        computed_available_days.length !== current_available_days.length ||\n        !computed_available_days.every(day => current_available_days.includes(day));\n      \n      if (needsSync) {\n        setFormData({ ...formData, available_days: computed_available_days });\n      }\n    }\n  }, [formData.working_hours]);\n\n  const workingHours = formData.working_hours || {};\n\n  const syncWorkingHoursToAvailableDays = (working_hours) => {\n    const dayNames = ['sunday', 'monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday'];\n    const available_days = [];\n    dayNames.forEach((dayName, index) => {\n      if (working_hours[dayName]?.enabled) {\n        available_days.push(index);\n      }\n    });\n    return available_days;\n  };\n\n  const toggleDay = (day) => {\n    const newWorkingHours = { ...workingHours };\n    if (newWorkingHours[day]) {\n      newWorkingHours[day] = {\n        ...newWorkingHours[day],\n        enabled: !newWorkingHours[day].enabled\n      };\n    } else {\n      newWorkingHours[day] = {\n        enabled: true,\n        start: '09:00',\n        end: '18:00',\n        break_start: '',\n        break_end: ''\n      };\n    }\n    const available_days = syncWorkingHoursToAvailableDays(newWorkingHours);\n    setFormData({ ...formData, working_hours: newWorkingHours, available_days });\n  };\n\n  const updateDaySchedule = (day, field, value) => {\n    const newWorkingHours = {\n      ...workingHours,\n      [day]: {\n        ...workingHours[day],\n        [field]: value\n      }\n    };\n    const available_days = syncWorkingHoursToAvailableDays(newWorkingHours);\n    setFormData({ ...formData, working_hours: newWorkingHours, available_days });\n  };\n\n  const addBlockedDate = () => {\n    if (!blockDate) return;\n    const blocked = formData.blocked_dates || [];\n    const dateStr = format(blockDate, 'yyyy-MM-dd');\n    if (!blocked.includes(dateStr)) {\n      setFormData({ ...formData, blocked_dates: [...blocked, dateStr] });\n    }\n    setBlockDate(null);\n  };\n\n  const removeBlockedDate = (date) => {\n    const blocked = formData.blocked_dates.filter(d => d !== date);\n    setFormData({ ...formData, blocked_dates: blocked });\n  };\n\n  return (\n    <div className=\"space-y-6\">\n      {/* Horários por Dia */}\n      <Card>\n        <CardHeader>\n          <CardTitle className=\"text-base flex items-center gap-2\">\n            <Clock className=\"w-4 h-4\" />\n            {txtWorkingHours}\n          </CardTitle>\n        </CardHeader>\n        <CardContent className=\"space-y-4\">\n          {daysOfWeek.map((day) => (\n            <div key={day.value} className=\"space-y-3 p-4 border rounded-lg bg-slate-50\">\n              <div className=\"flex items-center justify-between\">\n                <div className=\"flex items-center gap-3\">\n                  <Switch\n                    checked={workingHours[day.value]?.enabled ?? false}\n                    onCheckedChange={() => toggleDay(day.value)}\n                  />\n                  <Label className=\"font-semibold text-base\">{day.label}</Label>\n                </div>\n              </div>\n\n              {workingHours[day.value]?.enabled && (\n                <div className=\"grid grid-cols-2 gap-4 pl-10\">\n                  <div>\n                    <Label htmlFor={`${day.value}-start`} className=\"text-sm\">{txtStart}</Label>\n                    <Input\n                      id={`${day.value}-start`}\n                      type=\"time\"\n                      value={workingHours[day.value].start}\n                      onChange={(e) => updateDaySchedule(day.value, 'start', e.target.value)}\n                      className=\"mt-1\"\n                    />\n                  </div>\n                  <div>\n                    <Label htmlFor={`${day.value}-end`} className=\"text-sm\">{txtEnd}</Label>\n                    <Input\n                      id={`${day.value}-end`}\n                      type=\"time\"\n                      value={workingHours[day.value].end}\n                      onChange={(e) => updateDaySchedule(day.value, 'end', e.target.value)}\n                      className=\"mt-1\"\n                    />\n                  </div>\n                  <div>\n                    <Label htmlFor={`${day.value}-break-start`} className=\"text-sm\">\n                      {txtBreakStart} <span className=\"text-slate-400\">({txtOptional})</span>\n                    </Label>\n                    <Input\n                      id={`${day.value}-break-start`}\n                      type=\"time\"\n                      value={workingHours[day.value].break_start || ''}\n                      onChange={(e) => updateDaySchedule(day.value, 'break_start', e.target.value)}\n                      className=\"mt-1\"\n                    />\n                  </div>\n                  <div>\n                    <Label htmlFor={`${day.value}-break-end`} className=\"text-sm\">\n                      {txtBreakEnd} <span className=\"text-slate-400\">({txtOptional})</span>\n                    </Label>\n                    <Input\n                      id={`${day.value}-break-end`}\n                      type=\"time\"\n                      value={workingHours[day.value].break_end || ''}\n                      onChange={(e) => updateDaySchedule(day.value, 'break_end', e.target.value)}\n                      className=\"mt-1\"\n                    />\n                  </div>\n                </div>\n              )}\n            </div>\n          ))}\n        </CardContent>\n      </Card>\n\n      {/* Datas Bloqueadas */}\n      <Card>\n        <CardHeader>\n          <CardTitle className=\"text-base flex items-center gap-2\">\n            <CalendarX className=\"w-4 h-4\" />\n            {txtBlockedDates}\n          </CardTitle>\n        </CardHeader>\n        <CardContent className=\"space-y-4\">\n          <div className=\"flex gap-2\">\n            <Popover>\n              <PopoverTrigger asChild>\n                <Button type=\"button\" variant=\"outline\" className=\"flex-1 justify-start text-left font-normal\">\n                  <CalendarX className=\"mr-2 h-4 w-4 text-slate-500\" />\n                  {blockDate ? format(blockDate, 'PPP', { locale: pt }) : txtSelectDate}\n                </Button>\n              </PopoverTrigger>\n              <PopoverContent className=\"w-auto p-0 shadow-xl border-slate-200\" align=\"start\">\n                <Calendar\n                  mode=\"single\"\n                  selected={blockDate}\n                  onSelect={setBlockDate}\n                  locale={pt}\n                  className=\"rounded-xl\"\n                />\n              </PopoverContent>\n            </Popover>\n            <Button type=\"button\" onClick={addBlockedDate} disabled={!blockDate} className=\"shrink-0\">\n              <Plus className=\"w-4 h-4\" />\n            </Button>\n          </div>\n\n          {formData.blocked_dates && formData.blocked_dates.length > 0 && (\n            <div className=\"flex flex-wrap gap-2\">\n              {formData.blocked_dates.map(date => (\n                <Badge key={date} variant=\"secondary\" className=\"gap-2\">\n                  {format(new Date(date + 'T00:00:00'), 'dd/MM/yyyy')}\n                  <button\n                    type=\"button\"\n                    onClick={() => removeBlockedDate(date)}\n                    className=\"hover:text-red-600\"\n                  >\n                    <X className=\"w-3 h-3\" />\n                  </button>\n                </Badge>\n              ))}\n            </div>\n          )}\n        </CardContent>\n      </Card>\n    </div>\n  );\n}\n","path":null,"size_bytes":13169,"size_tokens":null},"src/components/ui/navigation-menu.jsx":{"content":"import * as React from \"react\"\nimport * as NavigationMenuPrimitive from \"@radix-ui/react-navigation-menu\"\nimport { cva } from \"class-variance-authority\"\nimport { ChevronDown } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst NavigationMenu = React.forwardRef(({ className, children, ...props }, ref) => (\n  <NavigationMenuPrimitive.Root\n    ref={ref}\n    className={cn(\n      \"relative z-10 flex max-w-max flex-1 items-center justify-center\",\n      className\n    )}\n    {...props}>\n    {children}\n    <NavigationMenuViewport />\n  </NavigationMenuPrimitive.Root>\n))\nNavigationMenu.displayName = NavigationMenuPrimitive.Root.displayName\n\nconst NavigationMenuList = React.forwardRef(({ className, ...props }, ref) => (\n  <NavigationMenuPrimitive.List\n    ref={ref}\n    className={cn(\n      \"group flex flex-1 list-none items-center justify-center space-x-1\",\n      className\n    )}\n    {...props} />\n))\nNavigationMenuList.displayName = NavigationMenuPrimitive.List.displayName\n\nconst NavigationMenuItem = NavigationMenuPrimitive.Item\n\nconst navigationMenuTriggerStyle = cva(\n  \"group inline-flex h-9 w-max items-center justify-center rounded-md bg-background px-4 py-2 text-sm font-medium transition-colors hover:bg-accent hover:text-accent-foreground focus:bg-accent focus:text-accent-foreground focus:outline-none disabled:pointer-events-none disabled:opacity-50 data-[active]:bg-accent/50 data-[state=open]:bg-accent/50\"\n)\n\nconst NavigationMenuTrigger = React.forwardRef(({ className, children, ...props }, ref) => (\n  <NavigationMenuPrimitive.Trigger\n    ref={ref}\n    className={cn(navigationMenuTriggerStyle(), \"group\", className)}\n    {...props}>\n    {children}{\" \"}\n    <ChevronDown\n      className=\"relative top-[1px] ml-1 h-3 w-3 transition duration-300 group-data-[state=open]:rotate-180\"\n      aria-hidden=\"true\" />\n  </NavigationMenuPrimitive.Trigger>\n))\nNavigationMenuTrigger.displayName = NavigationMenuPrimitive.Trigger.displayName\n\nconst NavigationMenuContent = React.forwardRef(({ className, ...props }, ref) => (\n  <NavigationMenuPrimitive.Content\n    ref={ref}\n    className={cn(\n      \"left-0 top-0 w-full data-[motion^=from-]:animate-in data-[motion^=to-]:animate-out data-[motion^=from-]:fade-in data-[motion^=to-]:fade-out data-[motion=from-end]:slide-in-from-right-52 data-[motion=from-start]:slide-in-from-left-52 data-[motion=to-end]:slide-out-to-right-52 data-[motion=to-start]:slide-out-to-left-52 md:absolute md:w-auto \",\n      className\n    )}\n    {...props} />\n))\nNavigationMenuContent.displayName = NavigationMenuPrimitive.Content.displayName\n\nconst NavigationMenuLink = NavigationMenuPrimitive.Link\n\nconst NavigationMenuViewport = React.forwardRef(({ className, ...props }, ref) => (\n  <div className={cn(\"absolute left-0 top-full flex justify-center\")}>\n    <NavigationMenuPrimitive.Viewport\n      className={cn(\n        \"origin-top-center relative mt-1.5 h-[var(--radix-navigation-menu-viewport-height)] w-full overflow-hidden rounded-md border bg-popover text-popover-foreground shadow data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-90 md:w-[var(--radix-navigation-menu-viewport-width)]\",\n        className\n      )}\n      ref={ref}\n      {...props} />\n  </div>\n))\nNavigationMenuViewport.displayName =\n  NavigationMenuPrimitive.Viewport.displayName\n\nconst NavigationMenuIndicator = React.forwardRef(({ className, ...props }, ref) => (\n  <NavigationMenuPrimitive.Indicator\n    ref={ref}\n    className={cn(\n      \"top-full z-[1] flex h-1.5 items-end justify-center overflow-hidden data-[state=visible]:animate-in data-[state=hidden]:animate-out data-[state=hidden]:fade-out data-[state=visible]:fade-in\",\n      className\n    )}\n    {...props}>\n    <div\n      className=\"relative top-[60%] h-2 w-2 rotate-45 rounded-tl-sm bg-border shadow-md\" />\n  </NavigationMenuPrimitive.Indicator>\n))\nNavigationMenuIndicator.displayName =\n  NavigationMenuPrimitive.Indicator.displayName\n\nexport {\n  navigationMenuTriggerStyle,\n  NavigationMenu,\n  NavigationMenuList,\n  NavigationMenuItem,\n  NavigationMenuContent,\n  NavigationMenuTrigger,\n  NavigationMenuLink,\n  NavigationMenuIndicator,\n  NavigationMenuViewport,\n}\n","path":null,"size_bytes":4217,"size_tokens":null},"src/components/business/AppointmentManager.jsx":{"content":"\nimport React, { useState, useMemo } from \"react\";\nimport { base44 } from \"@/api/base44Client\";\nimport { useQuery, useMutation, useQueryClient } from \"@tanstack/react-query\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Label } from \"@/components/ui/label\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\nimport { Tabs, TabsList, TabsTrigger, TabsContent } from \"@/components/ui/tabs\";\nimport { \n  Calendar, \n  Clock, \n  User, \n  CheckCircle2, \n  XCircle, \n  AlertCircle,\n  UserPlus,\n  Trash2,\n  Edit\n} from \"lucide-react\";\nimport { format } from \"date-fns\";\nimport { toast } from \"sonner\";\nimport AppointmentHistory from \"./AppointmentHistory\";\nimport { useAutoTranslate } from \"@/hooks/useTranslate\";\n\nexport default function AppointmentManager({ businessId, companyProfile }) {\n  // Traduções\n  const txtScheduled = useAutoTranslate('Agendado', 'pt');\n  const txtConfirmed = useAutoTranslate('Confirmado', 'pt');\n  const txtInService = useAutoTranslate('Em Atendimento', 'pt');\n  const txtCompleted = useAutoTranslate('Concluído', 'pt');\n  const txtCancelled = useAutoTranslate('Cancelado', 'pt');\n  const txtNoShow = useAutoTranslate('Faltou', 'pt');\n  const txtLoading = useAutoTranslate('A carregar...', 'pt');\n  const txtToday = useAutoTranslate('Hoje', 'pt');\n  const txtUpcoming = useAutoTranslate('Próximas', 'pt');\n  const txtHistory = useAutoTranslate('Histórico', 'pt');\n  const txtName = useAutoTranslate('Nome', 'pt');\n  const txtNameOptional = useAutoTranslate('Nome (opcional)', 'pt');\n  const txtEmail = useAutoTranslate('Email', 'pt');\n  const txtEmailOptional = useAutoTranslate('Email (opcional)', 'pt');\n  const txtService = useAutoTranslate('Serviço', 'pt');\n  const txtServiceRequired = useAutoTranslate('Serviço *', 'pt');\n  const txtDate = useAutoTranslate('Data', 'pt');\n  const txtDateRequired = useAutoTranslate('Data *', 'pt');\n  const txtTime = useAutoTranslate('Hora', 'pt');\n  const txtTimeRequired = useAutoTranslate('Hora *', 'pt');\n  const txtNotes = useAutoTranslate('Notas', 'pt');\n  const txtObservations = useAutoTranslate('Observações...', 'pt');\n  const txtSelect = useAutoTranslate('Selecione', 'pt');\n  const txtCreate = useAutoTranslate('Criar', 'pt');\n  const txtEdit = useAutoTranslate('Editar', 'pt');\n  const txtDelete = useAutoTranslate('Eliminar marcação', 'pt');\n  const txtCancel = useAutoTranslate('Cancelar', 'pt');\n  const txtSave = useAutoTranslate('Guardar', 'pt');\n  const txtAvailableTime = useAutoTranslate('Horário Disponível *', 'pt');\n  const txtNoAvailableSlots = useAutoTranslate('Sem horários disponíveis', 'pt');\n  const txtEmailPlaceholder = useAutoTranslate('email@exemplo.com', 'pt');\n  const txtNamePlaceholder = useAutoTranslate('Nome do cliente', 'pt');\n  const txtNoAppointmentsToday = useAutoTranslate('Sem marcações hoje', 'pt');\n  const txtNoUpcomingAppointments = useAutoTranslate('Sem marcações futuras', 'pt');\n  const txtManualAppointment = useAutoTranslate('Marcação Manual', 'pt');\n  const txtNewAppointment = useAutoTranslate('Nova Marcação', 'pt');\n\n  const statusConfig = {\n    agendado: { icon: Calendar, color: \"bg-blue-100 text-blue-700\", label: txtScheduled },\n    confirmado: { icon: CheckCircle2, color: \"bg-green-100 text-green-700\", label: txtConfirmed },\n    em_atendimento: { icon: Clock, color: \"bg-purple-100 text-purple-700\", label: txtInService },\n    concluido: { icon: CheckCircle2, color: \"bg-green-100 text-green-700\", label: txtCompleted },\n    cancelado: { icon: XCircle, color: \"bg-red-100 text-red-700\", label: txtCancelled },\n    falta: { icon: AlertCircle, color: \"bg-orange-100 text-orange-700\", label: txtNoShow }\n  };\n  const queryClient = useQueryClient();\n  const [activeTab, setActiveTab] = useState(\"hoje\");\n  const [showManualForm, setShowManualForm] = useState(false);\n  const [editingAppointment, setEditingAppointment] = useState(null);\n  const [manualData, setManualData] = useState({\n    user_email: \"\",\n    user_phone: \"\",\n    service_id: \"\",\n    appointment_date: \"\",\n    appointment_time: \"\",\n    notes: \"\",\n    user_name: \"\"\n  });\n\n  const { data: appointments, isLoading } = useQuery({\n    queryKey: ['business-appointments', businessId],\n    queryFn: () => base44.entities.Appointment.filter({ business_id: businessId }, '-appointment_date'),\n    initialData: [],\n    refetchInterval: 30000,\n  });\n\n  const { data: services } = useQuery({\n    queryKey: ['services', businessId],\n    queryFn: () => base44.entities.Service.filter({ business_id: businessId }),\n    initialData: [],\n  });\n\n  const { data: dateAppointments } = useQuery({\n    queryKey: ['appointments-for-date', businessId, manualData.service_id, manualData.appointment_date],\n    queryFn: async () => {\n      if (!manualData.service_id || !manualData.appointment_date) return [];\n      return await base44.entities.Appointment.filter({\n        business_id: businessId,\n        service_id: manualData.service_id,\n        appointment_date: manualData.appointment_date,\n        status: { $in: ['agendado', 'confirmado'] }\n      });\n    },\n    enabled: !!manualData.service_id && !!manualData.appointment_date,\n    initialData: [],\n  });\n\n  const sendSMS = async (phone, message) => {\n    console.log('📱 SMS enviado para:', phone);\n    console.log('   Mensagem:', message);\n    \n    if (companyProfile?.sms_gateway && companyProfile.sms_gateway !== 'none') {\n      await base44.integrations.Core.SendEmail({\n        to: companyProfile.companyEmail,\n        subject: 'SMS Enviado',\n        body: `[SMS] Para: ${phone}\\nMensagem: ${message}\\nGateway: ${companyProfile.sms_gateway}`\n      });\n    }\n  };\n\n  const getScheduleForDate = (date) => {\n    const selectedService = services.find(s => s.id === manualData.service_id);\n    if (!selectedService || !date) return null;\n    \n    const dateObj = new Date(date + 'T00:00:00');\n    const dayOfWeek = dateObj.getDay();\n    \n    const dayNames = ['sunday', 'monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday'];\n    const dayName = dayNames[dayOfWeek];\n    \n    const daySchedule = selectedService.working_hours?.[dayName];\n    \n    console.log('📅 getScheduleForDate:', {\n      date,\n      dayOfWeek,\n      dayName,\n      serviceName: selectedService.name,\n      daySchedule,\n      working_hours: selectedService.working_hours\n    });\n    \n    if (daySchedule && daySchedule.enabled) {\n      const breaks = [];\n      if (daySchedule.break_start && daySchedule.break_end) {\n        breaks.push({\n          start: daySchedule.break_start,\n          end: daySchedule.break_end\n        });\n      }\n      \n      return {\n        start: daySchedule.start,\n        end: daySchedule.end,\n        breaks: breaks\n      };\n    }\n    \n    return null;\n  };\n\n  const isTimeInBreak = (timeStr, breaks) => {\n    if (!breaks || breaks.length === 0) return false;\n    \n    const [hour, min] = timeStr.split(':').map(Number);\n    const timeMinutes = hour * 60 + min;\n    \n    return breaks.some(brk => {\n      const [startHour, startMin] = brk.start.split(':').map(Number);\n      const [endHour, endMin] = brk.end.split(':').map(Number);\n      const breakStart = startHour * 60 + startMin;\n      const breakEnd = endHour * 60 + endMin;\n      \n      return timeMinutes >= breakStart && timeMinutes < breakEnd;\n    });\n  };\n\n  const availableTimeSlots = useMemo(() => {\n    if (!manualData.service_id || !manualData.appointment_date) return [];\n\n    const selectedService = services.find(s => s.id === manualData.service_id);\n    if (!selectedService) return [];\n\n    const schedule = getScheduleForDate(manualData.appointment_date);\n    if (!schedule || !schedule.start || !schedule.end) return [];\n\n    const slots = [];\n    const [startHour, startMin] = schedule.start.split(':').map(Number);\n    const [endHour, endMin] = schedule.end.split(':').map(Number);\n    \n    const startTime = startHour * 60 + startMin;\n    const endTime = endHour * 60 + endMin;\n    const duration = selectedService.duration;\n    const bufferTime = selectedService.buffer_time || 0;\n    const slotInterval = duration + bufferTime;\n\n    for (let time = startTime; time < endTime; time += slotInterval) {\n      const hour = Math.floor(time / 60);\n      const min = time % 60;\n      const timeStr = `${String(hour).padStart(2, '0')}:${String(min).padStart(2, '0')}`;\n      \n      if (isTimeInBreak(timeStr, schedule.breaks)) {\n        continue;\n      }\n      \n      const isBooked = dateAppointments.some(apt => {\n        const aptTime = apt.appointment_time;\n        const [aptHour, aptMin] = aptTime.split(':').map(Number);\n        const aptMinutes = aptHour * 60 + aptMin;\n        \n        const aptSlotInterval = apt.duration + (apt.buffer_time || 0);\n\n        const overlaps = (time < (aptMinutes + aptSlotInterval) && aptMinutes < (time + slotInterval));\n        return overlaps;\n      });\n      \n      slots.push({\n        time: timeStr,\n        available: !isBooked\n      });\n    }\n\n    return slots;\n  }, [manualData.service_id, manualData.appointment_date, services, dateAppointments]);\n\n  const updateStatusMutation = useMutation({\n    mutationFn: async ({ id, status }) => {\n      const appointment = await base44.entities.Appointment.update(id, { status });\n      \n      // 📧 Enviar email de confirmação quando status muda para \"confirmado\"\n      if (status === 'confirmado') {\n        const selectedService = services.find(s => s.id === appointment.service_id);\n        \n        // Só enviar email se tiver email válido\n        if (appointment.user_email && appointment.user_email.includes('@') && !appointment.user_email.includes('@temp.local')) {\n          const formattedDate = (() => {\n            try {\n              if (!appointment.appointment_date) return 'Data não disponível';\n              const date = new Date(appointment.appointment_date + 'T00:00:00');\n              if (isNaN(date.getTime())) return 'Data não disponível';\n              return format(date, 'dd/MM/yyyy');\n            } catch (e) {\n              return 'Data não disponível';\n            }\n          })();\n          \n          const emailBody = companyProfile?.confirmation_email_template || \n            `Olá! A sua marcação foi confirmada.\\n\\nDetalhes:\\nServiço: ${selectedService?.name || 'Serviço'}\\nData: ${formattedDate}\\nHora: ${appointment.appointment_time}\\nNotas: ${appointment.notes || 'N/A'}\\n\\n${companyProfile?.name || 'Empresa'}`;\n\n          try {\n            console.log('📧 Enviando email de confirmação para:', appointment.user_email);\n            await base44.integrations.Core.SendEmail({\n              to: appointment.user_email,\n              subject: `Marcação Confirmada - ${selectedService?.name || 'Serviço'}`,\n              body: emailBody\n            });\n            toast.success('Email de confirmação enviado!');\n          } catch (emailError) {\n            console.warn('⚠️ Erro ao enviar email:', emailError);\n            toast.warning('Marcação confirmada, mas não foi possível enviar email');\n          }\n        }\n      }\n      \n      return appointment;\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['business-appointments'] });\n      queryClient.invalidateQueries({ queryKey: ['business-appointment-history'] });\n    },\n  });\n\n  const createManualAppointmentMutation = useMutation({\n    mutationFn: async () => {\n      const selectedService = services.find(s => s.id === manualData.service_id);\n      \n      const appointment = await base44.entities.Appointment.create({\n        business_id: businessId,\n        service_id: manualData.service_id,\n        user_email: manualData.user_email || `presencial_${Date.now()}@temp.local`,\n        appointment_date: manualData.appointment_date,\n        appointment_time: manualData.appointment_time,\n        status: \"agendado\",\n        notes: manualData.notes || `Cliente: ${manualData.user_name || 'Presencial'}`,\n        is_manual: true,\n        manual_name: manualData.user_name || 'Cliente Presencial',\n        duration: selectedService?.duration,\n        buffer_time: selectedService?.buffer_time || 0\n      });\n\n      if (manualData.user_email && manualData.user_email.includes('@')) {\n        const formattedDate = (() => {\n          try {\n            if (!manualData.appointment_date) return 'Data não disponível';\n            const date = new Date(manualData.appointment_date + 'T00:00:00');\n            if (isNaN(date.getTime())) return 'Data não disponível';\n            return format(date, 'dd/MM/yyyy');\n          } catch (e) {\n            return 'Data não disponível';\n          }\n        })();\n        \n        const emailBody = companyProfile?.confirmation_email_template || \n          `Olá! A sua marcação foi confirmada.\\n\\nDetalhes:\\nServiço: ${selectedService.name}\\nData: ${formattedDate}\\nHora: ${manualData.appointment_time}\\nNotas: ${manualData.notes || 'N/A'}\\n\\n${companyProfile?.name || 'Empresa'}`;\n\n        console.log('📧 Email enviado para:', manualData.user_email);\n        await base44.integrations.Core.SendEmail({\n          to: manualData.user_email,\n          subject: `Marcação Confirmada - ${selectedService.name}`,\n          body: emailBody\n        });\n      }\n\n      if (manualData.user_phone) {\n        const formattedDate = (() => {\n          try {\n            if (!manualData.appointment_date) return 'Data não disponível';\n            const date = new Date(manualData.appointment_date + 'T00:00:00');\n            if (isNaN(date.getTime())) return 'Data não disponível';\n            return format(date, 'dd/MM/yyyy');\n          } catch (e) {\n            return 'Data não disponível';\n          }\n        })();\n        \n        const smsBody = companyProfile?.confirmation_sms_template || \n          `Marcação confirmada: ${selectedService.name} em ${formattedDate} às ${manualData.appointment_time} - ${companyProfile?.name || 'Empresa'}`;\n        \n        await sendSMS(manualData.user_phone, smsBody);\n      }\n\n      return appointment;\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['business-appointments'] });\n      queryClient.invalidateQueries({ queryKey: ['business-appointment-history'] });\n      queryClient.invalidateQueries({ queryKey: ['appointments-for-date'] });\n      toast.success('Marcação criada com sucesso!');\n      setManualData({\n        user_email: \"\",\n        user_phone: \"\",\n        service_id: \"\",\n        appointment_date: \"\",\n        appointment_time: \"\",\n        notes: \"\",\n        user_name: \"\"\n      });\n      setShowManualForm(false);\n    },\n    onError: () => {\n      toast.error('Erro ao criar marcação');\n    },\n  });\n\n  const updateAppointmentMutation = useMutation({\n    mutationFn: async ({ id, data }) => {\n      return await base44.entities.Appointment.update(id, data);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['business-appointments'] });\n      queryClient.invalidateQueries({ queryKey: ['business-appointment-history'] });\n      queryClient.invalidateQueries({ queryKey: ['appointments-for-date'] });\n      toast.success('Marcação atualizada com sucesso!');\n      setEditingAppointment(null);\n    },\n    onError: () => {\n      toast.error('Erro ao atualizar marcação');\n    },\n  });\n\n  const deleteAppointmentMutation = useMutation({\n    mutationFn: async (appointmentId) => {\n      await base44.entities.Appointment.delete(appointmentId);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['business-appointments'] });\n      queryClient.invalidateQueries({ queryKey: ['business-appointment-history'] });\n      toast.success('Marcação eliminada com sucesso');\n    },\n    onError: () => {\n      toast.error('Erro ao eliminar marcação');\n    },\n  });\n\n  const getServiceName = (serviceId) => {\n    return services.find(s => s.id === serviceId)?.name || 'Serviço';\n  };\n\n  const upcomingAppointments = appointments.filter(apt => {\n    const aptDate = new Date(`${apt.appointment_date}T${apt.appointment_time}`);\n    return ['agendado', 'confirmado'].includes(apt.status) && aptDate >= new Date();\n  });\n\n  const todayAppointments = appointments.filter(apt => {\n    const today = format(new Date(), 'yyyy-MM-dd');\n    return apt.appointment_date === today && ['agendado', 'confirmado', 'em_atendimento'].includes(apt.status);\n  });\n\n\n  const renderAppointment = (appointment) => {\n    const status = statusConfig[appointment.status];\n    const StatusIcon = status.icon;\n\n    return (\n      <Card key={appointment.id} className=\"hover:shadow-md transition-shadow\">\n        <CardContent className=\"p-3\">\n          <div className=\"flex justify-between items-start mb-2\">\n            <div className=\"flex-1 min-w-0\">\n              <div className=\"flex items-center gap-1.5 mb-1 flex-wrap\">\n                <h4 className=\"font-bold text-slate-900 text-xs truncate\">{getServiceName(appointment.service_id)}</h4>\n                <Badge className={`${status.color} text-xs h-4 px-1`}>\n                  <StatusIcon className=\"w-2.5 h-2.5 mr-0.5\" />\n                  {status.label}\n                </Badge>\n                {appointment.is_manual && (\n                  <Badge variant=\"outline\" className=\"bg-blue-50 text-blue-700 text-xs h-4 px-1\">\n                    Presencial\n                  </Badge>\n                )}\n              </div>\n              <div className=\"space-y-0.5 text-xs text-slate-600\">\n                <div className=\"flex items-center gap-1\">\n                  <User className=\"w-3 h-3\" />\n                  <span className=\"truncate\">{appointment.manual_name || appointment.user_email}</span>\n                </div>\n                <div className=\"flex items-center gap-1\">\n                  <Calendar className=\"w-3 h-3\" />\n                  {(() => {\n                    try {\n                      if (!appointment.appointment_date) return 'Data não disponível';\n                      const date = new Date(appointment.appointment_date + 'T00:00:00');\n                      if (isNaN(date.getTime())) return 'Data não disponível';\n                      return format(date, 'dd/MM/yyyy');\n                    } catch (e) {\n                      console.warn('Erro ao formatar data da marcação:', e);\n                      return 'Data não disponível';\n                    }\n                  })()}\n                </div>\n                <div className=\"flex items-center gap-1\">\n                  <Clock className=\"w-3 h-3\" />\n                  {appointment.appointment_time}\n                </div>\n              </div>\n            </div>\n          </div>\n\n          {appointment.notes && (\n            <div className=\"mb-2 p-1.5 bg-slate-50 rounded text-xs text-slate-600 line-clamp-2\">\n              <strong>Notas:</strong> {appointment.notes}\n            </div>\n          )}\n\n          <div className=\"flex flex-wrap gap-1\">\n            {appointment.status === 'agendado' && (\n              <>\n                <Button\n                  size=\"sm\"\n                  variant=\"outline\"\n                  onClick={() => updateStatusMutation.mutate({ id: appointment.id, status: 'confirmado' })}\n                  className=\"h-7 text-xs flex-1\"\n                >\n                  <CheckCircle2 className=\"w-3 h-3 mr-1\" />\n                  Confirmar\n                </Button>\n                <Button\n                  size=\"sm\"\n                  variant=\"outline\"\n                  className=\"border-red-200 text-red-600 hover:bg-red-50 h-7 text-xs flex-1\"\n                  onClick={() => updateStatusMutation.mutate({ id: appointment.id, status: 'cancelado' })}\n                >\n                  <XCircle className=\"w-3 h-3 mr-1\" />\n                  Cancelar\n                </Button>\n                {appointment.is_manual && (\n                  <Button\n                    size=\"sm\"\n                    variant=\"outline\"\n                    className=\"border-red-300 text-red-700 hover:bg-red-100 h-7 w-7 p-0\"\n                    onClick={() => {\n                      if (confirm(`Eliminar marcação de ${appointment.manual_name || 'Cliente'}?`)) {\n                        deleteAppointmentMutation.mutate(appointment.id);\n                      }\n                    }}\n                    title=\"Eliminar marcação\"\n                  >\n                    <Trash2 className=\"w-3 h-3\" />\n                  </Button>\n                )}\n              </>\n            )}\n\n            {appointment.status === 'confirmado' && (\n              <>\n                <Button\n                  size=\"sm\"\n                  variant=\"outline\"\n                  onClick={() => setEditingAppointment(appointment)}\n                  className=\"h-7 text-xs\"\n                >\n                  <Edit className=\"w-3 h-3 mr-1\" />\n                  Editar\n                </Button>\n                <Button\n                  size=\"sm\"\n                  variant=\"outline\"\n                  onClick={() => updateStatusMutation.mutate({ id: appointment.id, status: 'em_atendimento' })}\n                  className=\"h-7 text-xs flex-1\"\n                >\n                  <Clock className=\"w-3 h-3 mr-1\" />\n                  Iniciar\n                </Button>\n                <Button\n                  size=\"sm\"\n                  variant=\"outline\"\n                  className=\"border-orange-200 text-orange-600 hover:bg-orange-50 h-7 text-xs\"\n                  onClick={() => updateStatusMutation.mutate({ id: appointment.id, status: 'falta' })}\n                >\n                  Faltou\n                </Button>\n              </>\n            )}\n\n            {appointment.status === 'em_atendimento' && (\n              <Button\n                size=\"sm\"\n                variant=\"outline\"\n                className=\"border-green-200 text-green-600 hover:bg-green-50 h-7 text-xs w-full\"\n                onClick={() => updateStatusMutation.mutate({ id: appointment.id, status: 'concluido' })}\n              >\n                <CheckCircle2 className=\"w-3 h-3 mr-1\" />\n                Concluir\n              </Button>\n            )}\n          </div>\n        </CardContent>\n      </Card>\n    );\n  };\n\n  if (isLoading) {\n    return <div className=\"text-center py-6 text-xs\">{txtLoading}</div>;\n  }\n\n  return (\n    <div className=\"space-y-3\">\n      <div className=\"grid grid-cols-2 gap-2\">\n        <Card>\n          <CardContent className=\"p-2\">\n            <div className=\"text-lg font-bold text-slate-900\">{todayAppointments.length}</div>\n            <div className=\"text-xs text-slate-600\">{txtToday}</div>\n          </CardContent>\n        </Card>\n        <Card>\n          <CardContent className=\"p-2\">\n            <div className=\"text-lg font-bold text-slate-900\">{upcomingAppointments.length}</div>\n            <div className=\"text-xs text-slate-600\">{txtUpcoming}</div>\n          </CardContent>\n        </Card>\n      </div>\n\n      <Button\n        onClick={() => setShowManualForm(!showManualForm)}\n        className=\"w-full bg-gradient-to-r from-blue-500 to-cyan-500 hover:from-blue-600 hover:to-cyan-600 h-9 text-xs\"\n      >\n        <UserPlus className=\"w-3 h-3 mr-1\" />\n        {txtManualAppointment}\n      </Button>\n\n      {showManualForm && (\n        <Card className=\"border-blue-200 bg-blue-50\">\n          <CardHeader className=\"p-3 pb-2\">\n            <CardTitle className=\"flex items-center gap-2 text-sm\">\n              <UserPlus className=\"w-4 h-4\" />\n              {txtNewAppointment}\n            </CardTitle>\n          </CardHeader>\n          <CardContent className=\"space-y-2 p-3\">\n            <div>\n              <Label htmlFor=\"userName\" className=\"text-xs\">{txtNameOptional}</Label>\n              <Input\n                id=\"userName\"\n                value={manualData.user_name}\n                onChange={(e) => setManualData({...manualData, user_name: e.target.value})}\n                placeholder={txtName}\n                className=\"h-8 text-xs\"\n              />\n            </div>\n\n            <div>\n              <Label htmlFor=\"userEmail\" className=\"text-xs\">{txtEmailOptional}</Label>\n              <Input\n                id=\"userEmail\"\n                type=\"text\"\n                inputMode=\"email\"\n                value={manualData.user_email}\n                onChange={(e) => setManualData({...manualData, user_email: e.target.value})}\n                placeholder={txtEmailPlaceholder}\n                className=\"h-8 text-xs\"\n                autoComplete=\"off\"\n              />\n            </div>\n\n            <div>\n              <Label htmlFor=\"service\" className=\"text-xs\">{txtServiceRequired}</Label>\n              <Select\n                value={manualData.service_id}\n                onValueChange={(value) => setManualData({...manualData, service_id: value, appointment_date: '', appointment_time: ''})}\n              >\n                <SelectTrigger className=\"h-8 text-xs\">\n                  <SelectValue placeholder={txtSelect} />\n                </SelectTrigger>\n                <SelectContent>\n                  {services.map(service => (\n                    <SelectItem key={service.id} value={service.id} className=\"text-xs\">\n                      {service.name} ({service.duration} min)\n                    </SelectItem>\n                  ))}\n                </SelectContent>\n              </Select>\n            </div>\n\n            <div>\n              <Label htmlFor=\"date\" className=\"text-xs\">{txtDateRequired}</Label>\n              <Input\n                id=\"date\"\n                type=\"date\"\n                value={manualData.appointment_date}\n                onChange={(e) => setManualData({...manualData, appointment_date: e.target.value, appointment_time: ''})}\n                className=\"h-8 text-xs\"\n              />\n            </div>\n\n            {manualData.service_id && manualData.appointment_date && (\n              <div>\n                <Label className=\"text-xs\">{txtAvailableTime}</Label>\n                {availableTimeSlots.length === 0 ? (\n                  <div className=\"bg-amber-50 border border-amber-200 rounded p-2 mt-1\">\n                    <p className=\"text-xs text-amber-700 font-medium mb-1\">⚠️ {txtNoAvailableSlots}</p>\n                    <p className=\"text-xs text-amber-600 mb-1\">\n                      O serviço selecionado não tem horários configurados {(() => {\n                        const dateObj = new Date(manualData.appointment_date + 'T00:00:00');\n                        const dayNames = ['domingo', 'segunda-feira', 'terça-feira', 'quarta-feira', 'quinta-feira', 'sexta-feira', 'sábado'];\n                        return `para ${dayNames[dateObj.getDay()]}`;\n                      })()}.\n                    </p>\n                    <p className=\"text-xs text-amber-600 font-medium\">\n                      → Vá a Serviços e configure os horários de funcionamento.\n                    </p>\n                  </div>\n                ) : (\n                  <div className=\"grid grid-cols-4 sm:grid-cols-5 gap-1.5 mt-2\">\n                    {availableTimeSlots.map(slot => (\n                      <button\n                        key={slot.time}\n                        type=\"button\"\n                        disabled={!slot.available}\n                        onClick={() => setManualData({...manualData, appointment_time: slot.time})}\n                        className={`\n                          relative px-2 py-2 rounded-lg text-xs font-semibold\n                          transition-all duration-200 ease-out\n                          ${manualData.appointment_time === slot.time\n                            ? 'bg-gradient-to-br from-blue-500 to-blue-600 text-white shadow-md shadow-blue-500/25 scale-105'\n                            : slot.available\n                              ? 'bg-white text-slate-700 hover:bg-slate-50 hover:scale-105 border border-slate-200 hover:border-blue-300'\n                              : 'bg-slate-100 text-slate-400 cursor-not-allowed opacity-50 line-through'\n                          }\n                        `}\n                      >\n                        {slot.time}\n                      </button>\n                    ))}\n                  </div>\n                )}\n              </div>\n            )}\n\n            <div>\n              <Label htmlFor=\"notes\" className=\"text-xs\">{txtNotes}</Label>\n              <Textarea\n                id=\"notes\"\n                value={manualData.notes}\n                onChange={(e) => setManualData({...manualData, notes: e.target.value})}\n                placeholder={txtObservations}\n                rows={2}\n                className=\"resize-none text-xs\"\n              />\n            </div>\n\n            <div className=\"flex gap-2\">\n              <Button\n                onClick={() => createManualAppointmentMutation.mutate()}\n                disabled={!manualData.service_id || !manualData.appointment_date || !manualData.appointment_time || createManualAppointmentMutation.isPending}\n                className=\"flex-1 h-8 text-xs\"\n              >\n                {createManualAppointmentMutation.isPending ? `${txtCreate}...` : txtCreate}\n              </Button>\n              <Button\n                variant=\"outline\"\n                onClick={() => setShowManualForm(false)}\n                className=\"h-8 text-xs\"\n              >\n                {txtCancel}\n              </Button>\n            </div>\n          </CardContent>\n        </Card>\n      )}\n\n      {editingAppointment && (\n        <Card className=\"border-amber-200 bg-amber-50\">\n          <CardHeader className=\"p-3 pb-2\">\n            <CardTitle className=\"flex items-center justify-between text-sm\">\n              <div className=\"flex items-center gap-2\">\n                <Edit className=\"w-4 h-4\" />\n                Editar Marcação\n              </div>\n              <Button\n                variant=\"ghost\"\n                size=\"sm\"\n                onClick={() => setEditingAppointment(null)}\n                className=\"h-6 w-6 p-0\"\n              >\n                <XCircle className=\"w-4 h-4\" />\n              </Button>\n            </CardTitle>\n          </CardHeader>\n          <CardContent className=\"space-y-2 p-3\">\n            <div>\n              <Label htmlFor=\"editName\" className=\"text-xs\">Nome</Label>\n              <Input\n                id=\"editName\"\n                defaultValue={editingAppointment.manual_name || ''}\n                onChange={(e) => setEditingAppointment({...editingAppointment, manual_name: e.target.value})}\n                placeholder=\"Nome do cliente\"\n                className=\"h-8 text-xs\"\n              />\n            </div>\n\n            <div>\n              <Label htmlFor=\"editEmail\" className=\"text-xs\">Email</Label>\n              <Input\n                id=\"editEmail\"\n                type=\"text\"\n                inputMode=\"email\"\n                defaultValue={editingAppointment.user_email || ''}\n                onChange={(e) => setEditingAppointment({...editingAppointment, user_email: e.target.value})}\n                placeholder=\"email@exemplo.com\"\n                className=\"h-8 text-xs\"\n                autoComplete=\"off\"\n              />\n            </div>\n\n            <div>\n              <Label htmlFor=\"editDate\" className=\"text-xs\">Data *</Label>\n              <Input\n                id=\"editDate\"\n                type=\"date\"\n                defaultValue={editingAppointment.appointment_date}\n                onChange={(e) => setEditingAppointment({...editingAppointment, appointment_date: e.target.value})}\n                className=\"h-8 text-xs\"\n              />\n            </div>\n\n            <div>\n              <Label htmlFor=\"editTime\" className=\"text-xs\">Hora *</Label>\n              <Input\n                id=\"editTime\"\n                type=\"time\"\n                defaultValue={editingAppointment.appointment_time}\n                onChange={(e) => setEditingAppointment({...editingAppointment, appointment_time: e.target.value})}\n                className=\"h-8 text-xs\"\n              />\n            </div>\n\n            <div>\n              <Label htmlFor=\"editNotes\" className=\"text-xs\">Notas</Label>\n              <Textarea\n                id=\"editNotes\"\n                defaultValue={editingAppointment.notes}\n                onChange={(e) => setEditingAppointment({...editingAppointment, notes: e.target.value})}\n                placeholder=\"Observações...\"\n                rows={2}\n                className=\"resize-none text-xs\"\n              />\n            </div>\n\n            <div className=\"flex gap-2\">\n              <Button\n                onClick={() => updateAppointmentMutation.mutate({ \n                  id: editingAppointment.id, \n                  data: {\n                    manual_name: editingAppointment.manual_name,\n                    user_email: editingAppointment.user_email,\n                    appointment_date: editingAppointment.appointment_date,\n                    appointment_time: editingAppointment.appointment_time,\n                    notes: editingAppointment.notes\n                  }\n                })}\n                disabled={updateAppointmentMutation.isPending}\n                className=\"flex-1 h-8 text-xs bg-amber-600 hover:bg-amber-700\"\n              >\n                {updateAppointmentMutation.isPending ? 'A guardar...' : 'Guardar Alterações'}\n              </Button>\n              <Button\n                variant=\"outline\"\n                onClick={() => setEditingAppointment(null)}\n                className=\"h-8 text-xs\"\n              >\n                Cancelar\n              </Button>\n            </div>\n          </CardContent>\n        </Card>\n      )}\n\n      <Tabs value={activeTab} onValueChange={setActiveTab}>\n        <TabsList className=\"bg-white border border-slate-200 w-full\">\n          <TabsTrigger value=\"hoje\" className=\"text-xs\">{txtToday} ({todayAppointments.length})</TabsTrigger>\n          <TabsTrigger value=\"proximas\" className=\"text-xs\">{txtUpcoming} ({upcomingAppointments.length})</TabsTrigger>\n          <TabsTrigger value=\"historico\" className=\"text-xs\">{txtHistory}</TabsTrigger>\n        </TabsList>\n\n        <TabsContent value=\"hoje\">\n          {todayAppointments.length === 0 ? (\n            <Card>\n              <CardContent className=\"py-6 text-center text-slate-500 text-xs\">\n                {txtNoAppointmentsToday}\n              </CardContent>\n            </Card>\n          ) : (\n            <div className=\"space-y-2\">\n              {todayAppointments.map(renderAppointment)}\n            </div>\n          )}\n        </TabsContent>\n\n        <TabsContent value=\"proximas\">\n          {upcomingAppointments.length === 0 ? (\n            <Card>\n              <CardContent className=\"py-6 text-center text-slate-500 text-xs\">\n                {txtNoUpcomingAppointments}\n              </CardContent>\n            </Card>\n          ) : (\n            <div className=\"space-y-2\">\n              {upcomingAppointments.map(renderAppointment)}\n            </div>\n          )}\n        </TabsContent>\n\n        <TabsContent value=\"historico\">\n          <AppointmentHistory businessId={businessId} />\n        </TabsContent>\n      </Tabs>\n    </div>\n  );\n}\n","path":null,"size_bytes":35338,"size_tokens":null},"src/components/shared/PageHeader.jsx":{"content":"import React from \"react\";\nimport { Button } from \"@/components/ui/button\";\nimport { ArrowLeft } from \"lucide-react\";\nimport { useNavigate } from \"react-router-dom\";\nimport { createPageUrl } from \"@/utils\";\nimport { useAutoTranslate } from \"@/hooks/useTranslate\";\n\nexport default function PageHeader({ title, subtitle, backTo, actions }) {\n  const txtBack = useAutoTranslate('Anterior', 'pt');\n  const navigate = useNavigate();\n\n  return (\n    <div className=\"mb-4 animate-slide-in-down\">\n      {backTo && (\n        <Button\n          variant=\"outline\"\n          size=\"sm\"\n          className=\"mb-2 smooth-transition hover-lift\"\n          onClick={() => navigate(createPageUrl(backTo))}\n        >\n          <ArrowLeft className=\"w-3 h-3 mr-1\" />\n          {txtBack}\n        </Button>\n      )}\n      \n      <div className=\"flex flex-col md:flex-row justify-between items-start md:items-center gap-2\">\n        <div>\n          <h1 className=\"text-xl md:text-2xl font-bold text-slate-900 mb-1 gradient-text\">\n            {title}\n          </h1>\n          {subtitle && (\n            <p className=\"text-sm text-slate-600 animate-fade-in\">{subtitle}</p>\n          )}\n        </div>\n        \n        {actions && (\n          <div className=\"flex gap-2 animate-scale-in\">\n            {actions}\n          </div>\n        )}\n      </div>\n    </div>\n  );\n}","path":null,"size_bytes":1341,"size_tokens":null},"src/pages/MyAppointments.jsx":{"content":"import React, { useState, useEffect } from \"react\";\nimport { base44 } from \"@/api/base44Client\";\nimport { useQuery, useMutation, useQueryClient } from \"@tanstack/react-query\";\nimport { Button } from \"@/components/ui/button\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Tabs, TabsList, TabsTrigger, TabsContent } from \"@/components/ui/tabs\";\nimport { Link } from \"react-router-dom\";\nimport { createPageUrl } from \"@/utils\";\nimport { Calendar, Clock, MapPin, XCircle, CheckCircle2, AlertCircle } from \"lucide-react\";\nimport { format } from \"date-fns\";\nimport { pt } from \"date-fns/locale\";\nimport { useConfirm } from \"@/hooks/useConfirm\";\nimport { toast } from \"sonner\";\nimport { useAutoTranslate } from \"@/hooks/useTranslate\";\n\nconst statusConfig = {\n  agendado: { icon: Calendar, color: \"bg-blue-100 text-blue-700\", label: \"Agendado\" },\n  confirmado: { icon: CheckCircle2, color: \"bg-green-100 text-green-700\", label: \"Confirmado\" },\n  em_atendimento: { icon: Clock, color: \"bg-purple-100 text-purple-700\", label: \"Em Atendimento\" },\n  concluido: { icon: CheckCircle2, color: \"bg-green-100 text-green-700\", label: \"Concluído\" },\n  cancelado: { icon: XCircle, color: \"bg-red-100 text-red-700\", label: \"Cancelado\" },\n  falta: { icon: AlertCircle, color: \"bg-orange-100 text-orange-700\", label: \"Faltou\" }\n};\n\nexport default function MyAppointmentsPage() {\n  const queryClient = useQueryClient();\n  const [user, setUser] = useState(null);\n  const { confirm, ConfirmDialog } = useConfirm();\n\n  const txtScheduled = useAutoTranslate('Agendado', 'pt');\n  const txtConfirmed = useAutoTranslate('Confirmado', 'pt');\n  const txtInService = useAutoTranslate('Em Atendimento', 'pt');\n  const txtCompleted = useAutoTranslate('Concluído', 'pt');\n  const txtCancelled = useAutoTranslate('Cancelado', 'pt');\n  const txtMissed = useAutoTranslate('Faltou', 'pt');\n  const txtCancelSuccess = useAutoTranslate('Marcação cancelada com sucesso', 'pt');\n  const txtCancelError = useAutoTranslate('Erro ao cancelar marcação', 'pt');\n  const txtMyAppointments = useAutoTranslate('Minhas Marcações', 'pt');\n  const txtUpcoming = useAutoTranslate('Próximas', 'pt');\n  const txtPast = useAutoTranslate('Histórico', 'pt');\n  const txtCancelAppointment = useAutoTranslate('Cancelar Marcação', 'pt');\n  const txtCancelAppointmentConfirm = useAutoTranslate('Tem certeza que deseja cancelar esta marcação? Esta ação não pode ser desfeita.', 'pt');\n  const txtCancel = useAutoTranslate('Cancelar', 'pt');\n  const txtViewBusiness = useAutoTranslate('Ver Empresa', 'pt');\n  const txtObservations = useAutoTranslate('Observações:', 'pt');\n  const txtService = useAutoTranslate('Serviço', 'pt');\n  const txtBusiness = useAutoTranslate('Empresa', 'pt');\n  const txtDateNotAvailable = useAutoTranslate('Data não disponível', 'pt');\n  const txtManageAppointments = useAutoTranslate('Gerir as suas marcações', 'pt');\n  const txtNoScheduledAppointments = useAutoTranslate('Sem marcações agendadas', 'pt');\n  const txtExploreAndSchedule = useAutoTranslate('Explore empresas e agende o seu próximo serviço', 'pt');\n  const txtExploreBusiness = useAutoTranslate('Explorar Empresas', 'pt');\n  const txtNoHistory = useAutoTranslate('Sem histórico de marcações', 'pt');\n  const txtLoading = useAutoTranslate('A carregar...', 'pt');\n\n  useEffect(() => {\n    base44.auth.me().then(setUser).catch(() => base44.auth.redirectToLogin());\n  }, []);\n\n  const { data: appointments, isLoading } = useQuery({\n    queryKey: ['my-appointments', user?.email],\n    queryFn: () => user ? base44.entities.Appointment.filter({ \n      user_email: user.email \n    }, '-appointment_date') : [],\n    enabled: !!user,\n    initialData: [],\n  });\n\n  const { data: services } = useQuery({\n    queryKey: ['appointment-services'],\n    queryFn: async () => {\n      const serviceIds = [...new Set(appointments.map(a => a.service_id))];\n      if (serviceIds.length === 0) return [];\n      const services = await Promise.all(\n        serviceIds.map(id => base44.entities.Service.filter({ id }).then(s => s[0]))\n      );\n      return services.filter(Boolean);\n    },\n    enabled: appointments.length > 0,\n    initialData: [],\n  });\n\n  const { data: businesses } = useQuery({\n    queryKey: ['appointment-businesses'],\n    queryFn: async () => {\n      const businessIds = [...new Set(appointments.map(a => a.business_id))];\n      if (businessIds.length === 0) return [];\n      const businesses = await Promise.all(\n        businessIds.map(id => base44.entities.Business.filter({ id }).then(b => b[0]))\n      );\n      return businesses.filter(Boolean);\n    },\n    enabled: appointments.length > 0,\n    initialData: [],\n  });\n\n  const cancelMutation = useMutation({\n    mutationFn: (id) => base44.entities.Appointment.update(id, { status: 'cancelado' }),\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['my-appointments'] });\n      toast.success(txtCancelSuccess);\n    },\n    onError: () => {\n      toast.error(txtCancelError);\n    }\n  });\n\n  const upcomingAppointments = appointments.filter(a => \n    ['agendado', 'confirmado'].includes(a.status) &&\n    new Date(`${a.appointment_date}T${a.appointment_time}`) >= new Date()\n  );\n\n  const pastAppointments = appointments.filter(a =>\n    ['concluido', 'cancelado', 'falta'].includes(a.status) ||\n    new Date(`${a.appointment_date}T${a.appointment_time}`) < new Date()\n  );\n\n  const getServiceName = (serviceId) => {\n    return services.find(s => s.id === serviceId)?.name || txtService;\n  };\n\n  const getBusinessName = (businessId) => {\n    return businesses.find(b => b.id === businessId)?.name || txtBusiness;\n  };\n\n  const renderAppointment = (appointment) => {\n    const status = statusConfig[appointment.status];\n    const StatusIcon = status.icon;\n    const isPast = (() => {\n      try {\n        if (!appointment.appointment_date || !appointment.appointment_time) return false;\n        const dateTime = new Date(`${appointment.appointment_date}T${appointment.appointment_time}`);\n        if (isNaN(dateTime.getTime())) return false;\n        return dateTime < new Date();\n      } catch (e) {\n        console.warn('Erro ao verificar se marcação está no passado:', e);\n        return false;\n      }\n    })();\n    const canCancel = ['agendado', 'confirmado'].includes(appointment.status) && !isPast;\n\n    return (\n      <Card key={appointment.id} className=\"hover:shadow-lg transition-shadow\">\n        <CardContent className=\"p-6\">\n          <div className=\"flex justify-between items-start mb-4\">\n            <div>\n              <h3 className=\"font-bold text-lg text-slate-900 mb-1\">\n                {getServiceName(appointment.service_id)}\n              </h3>\n              <p className=\"text-sm text-slate-600\">{getBusinessName(appointment.business_id)}</p>\n            </div>\n            <Badge className={status.color}>\n              <StatusIcon className=\"w-3 h-3 mr-1\" />\n              {status.label}\n            </Badge>\n          </div>\n\n          <div className=\"space-y-2 text-sm text-slate-700 mb-4\">\n            <div className=\"flex items-center gap-2\">\n              <Calendar className=\"w-4 h-4 text-slate-500\" />\n              {(() => {\n                try {\n                  if (!appointment.appointment_date) return 'Data não disponível';\n                  const date = new Date(appointment.appointment_date);\n                  if (isNaN(date.getTime())) return 'Data não disponível';\n                  return format(date, \"dd 'de' MMMM 'de' yyyy\", { locale: pt });\n                } catch (e) {\n                  console.warn('Erro ao formatar data da marcação:', e);\n                  return 'Data não disponível';\n                }\n              })()}\n            </div>\n            <div className=\"flex items-center gap-2\">\n              <Clock className=\"w-4 h-4 text-slate-500\" />\n              {appointment.appointment_time}\n            </div>\n          </div>\n\n          {appointment.notes && (\n            <div className=\"mb-4 p-3 bg-slate-50 rounded-lg text-sm text-slate-600\">\n              <strong>{txtObservations}</strong> {appointment.notes}\n            </div>\n          )}\n\n          <div className=\"flex gap-2\">\n            {canCancel && (\n              <Button\n                variant=\"outline\"\n                size=\"sm\"\n                className=\"border-red-200 text-red-600 hover:bg-red-50\"\n                onClick={async () => {\n                  const confirmed = await confirm({\n                    title: txtCancelAppointment,\n                    description: txtCancelAppointmentConfirm,\n                  });\n                  if (confirmed) {\n                    cancelMutation.mutate(appointment.id);\n                  }\n                }}\n              >\n                <XCircle className=\"w-3 h-3 mr-1\" />\n                {txtCancel}\n              </Button>\n            )}\n            <Link to={createPageUrl(`BusinessDetail?id=${appointment.business_id}`)}>\n              <Button variant=\"outline\" size=\"sm\">\n                {txtViewBusiness}\n              </Button>\n            </Link>\n          </div>\n        </CardContent>\n      </Card>\n    );\n  };\n\n  if (!user) {\n    return <div className=\"bg-gradient-to-br from-slate-50 via-blue-50 to-sky-50 flex items-center justify-center py-8\">\n      <div className=\"animate-pulse\">{txtLoading}</div>\n    </div>;\n  }\n\n  return (\n    <div className=\"bg-gradient-to-br from-slate-50 via-blue-50 to-sky-50\">\n      <div className=\"max-w-6xl mx-auto px-4 py-4 sm:px-6 sm:py-6\">\n        <div className=\"mb-8\">\n          <h1 className=\"text-4xl font-bold text-slate-900 mb-2\">{txtMyAppointments}</h1>\n          <p className=\"text-xl text-slate-600\">{txtManageAppointments}</p>\n        </div>\n\n        <Tabs defaultValue=\"proximas\" className=\"space-y-6\">\n          <TabsList className=\"bg-white border border-slate-200\">\n            <TabsTrigger value=\"proximas\">\n              {txtUpcoming} ({upcomingAppointments.length})\n            </TabsTrigger>\n            <TabsTrigger value=\"historico\">\n              {txtPast} ({pastAppointments.length})\n            </TabsTrigger>\n          </TabsList>\n\n          <TabsContent value=\"proximas\">\n            {upcomingAppointments.length === 0 ? (\n              <Card>\n                <CardContent className=\"py-16 text-center\">\n                  <Calendar className=\"w-16 h-16 text-slate-300 mx-auto mb-4\" />\n                  <h3 className=\"text-xl font-bold text-slate-900 mb-2\">\n                    {txtNoScheduledAppointments}\n                  </h3>\n                  <p className=\"text-slate-600 mb-6\">\n                    {txtExploreAndSchedule}\n                  </p>\n                  <Link to={createPageUrl(\"Businesses\")}>\n                    <Button>{txtExploreBusiness}</Button>\n                  </Link>\n                </CardContent>\n              </Card>\n            ) : (\n              <div className=\"grid md:grid-cols-2 gap-6\">\n                {upcomingAppointments.map(renderAppointment)}\n              </div>\n            )}\n          </TabsContent>\n\n          <TabsContent value=\"historico\">\n            {pastAppointments.length === 0 ? (\n              <Card>\n                <CardContent className=\"py-16 text-center text-slate-500\">\n                  {txtNoHistory}\n                </CardContent>\n              </Card>\n            ) : (\n              <div className=\"grid md:grid-cols-2 gap-6\">\n                {pastAppointments.map(renderAppointment)}\n              </div>\n            )}\n          </TabsContent>\n        </Tabs>\n      </div>\n      <ConfirmDialog />\n    </div>\n  );\n}","path":null,"size_bytes":11663,"size_tokens":null},"src/components/ui/calendar.jsx":{"content":"import * as React from \"react\"\nimport { ChevronLeft, ChevronRight } from \"lucide-react\"\nimport { DayPicker } from \"react-day-picker\"\n\nimport { cn } from \"@/lib/utils\"\nimport { buttonVariants } from \"@/components/ui/button\"\n\nfunction Calendar({\n  className,\n  classNames,\n  showOutsideDays = true,\n  ...props\n}) {\n  return (\n    (<DayPicker\n      showOutsideDays={showOutsideDays}\n      className={cn(\"p-4 select-none\", className)}\n      classNames={{\n        months: \"flex flex-col sm:flex-row gap-6\",\n        month: \"space-y-5\",\n        caption: \"flex justify-center pt-2 pb-3 relative items-center\",\n        caption_label: \"text-base font-semibold text-slate-800 dark:text-slate-200 capitalize\",\n        nav: \"flex items-center gap-1\",\n        nav_button: cn(\n          \"inline-flex items-center justify-center rounded-full\",\n          \"h-9 w-9 bg-transparent\",\n          \"text-slate-500 hover:text-slate-900 dark:text-slate-400 dark:hover:text-slate-100\",\n          \"hover:bg-slate-100 dark:hover:bg-slate-800\",\n          \"transition-all duration-200 ease-out\",\n          \"focus:outline-none focus:ring-2 focus:ring-blue-500/40 focus:ring-offset-2\",\n          \"disabled:opacity-30 disabled:pointer-events-none\"\n        ),\n        nav_button_previous: \"absolute left-2\",\n        nav_button_next: \"absolute right-2\",\n        table: \"w-full border-collapse\",\n        head_row: \"flex mb-2\",\n        head_cell: cn(\n          \"flex-1 text-center\",\n          \"text-xs font-semibold uppercase tracking-wider\",\n          \"text-slate-400 dark:text-slate-500\",\n          \"py-2\"\n        ),\n        row: \"flex w-full gap-1 mb-1\",\n        cell: cn(\n          \"flex-1 relative text-center\",\n          \"focus-within:relative focus-within:z-20\",\n          \"[&:has([aria-selected])]:bg-transparent\",\n          \"first:[&:has([aria-selected])]:rounded-l-xl\",\n          \"last:[&:has([aria-selected])]:rounded-r-xl\",\n          props.mode === \"range\"\n            ? \"[&:has(>.day-range-end)]:rounded-r-xl [&:has(>.day-range-start)]:rounded-l-xl\"\n            : \"\"\n        ),\n        day: cn(\n          \"inline-flex items-center justify-center\",\n          \"h-10 w-10 sm:h-11 sm:w-11\",\n          \"rounded-xl\",\n          \"text-sm font-medium\",\n          \"text-slate-700 dark:text-slate-300\",\n          \"transition-all duration-200 ease-out\",\n          \"hover:bg-slate-100 dark:hover:bg-slate-800\",\n          \"hover:text-slate-900 dark:hover:text-slate-100\",\n          \"hover:scale-105\",\n          \"focus:outline-none focus:ring-2 focus:ring-blue-500/40\",\n          \"aria-selected:opacity-100\",\n          \"cursor-pointer\"\n        ),\n        day_range_start: \"day-range-start rounded-l-xl rounded-r-none\",\n        day_range_end: \"day-range-end rounded-r-xl rounded-l-none\",\n        day_selected: cn(\n          \"!bg-gradient-to-br from-blue-500 to-blue-600\",\n          \"!text-white font-semibold\",\n          \"shadow-lg shadow-blue-500/30\",\n          \"hover:from-blue-600 hover:to-blue-700\",\n          \"hover:shadow-blue-500/40\",\n          \"hover:scale-105\",\n          \"ring-2 ring-blue-400/30\"\n        ),\n        day_today: cn(\n          \"bg-slate-100 dark:bg-slate-800\",\n          \"text-blue-600 dark:text-blue-400\",\n          \"font-bold\",\n          \"ring-1 ring-blue-200 dark:ring-blue-800\"\n        ),\n        day_outside: cn(\n          \"text-slate-300 dark:text-slate-600\",\n          \"opacity-60\",\n          \"hover:opacity-80\",\n          \"aria-selected:bg-blue-50 dark:aria-selected:bg-blue-900/30\",\n          \"aria-selected:text-blue-400 aria-selected:opacity-80\"\n        ),\n        day_disabled: cn(\n          \"text-slate-300 dark:text-slate-600\",\n          \"opacity-40\",\n          \"cursor-not-allowed\",\n          \"hover:bg-transparent hover:scale-100\"\n        ),\n        day_range_middle: cn(\n          \"aria-selected:bg-blue-50 dark:aria-selected:bg-blue-900/30\",\n          \"aria-selected:text-blue-700 dark:aria-selected:text-blue-300\",\n          \"rounded-none\"\n        ),\n        day_hidden: \"invisible\",\n        ...classNames,\n      }}\n      components={{\n        IconLeft: ({ className, ...props }) => (\n          <ChevronLeft className={cn(\"h-5 w-5\", className)} {...props} />\n        ),\n        IconRight: ({ className, ...props }) => (\n          <ChevronRight className={cn(\"h-5 w-5\", className)} {...props} />\n        ),\n      }}\n      {...props} />)\n  );\n}\nCalendar.displayName = \"Calendar\"\n\nexport { Calendar }\n","path":null,"size_bytes":4400,"size_tokens":null},"src/pages/Onboarding.jsx":{"content":"import React, { useState, useEffect } from \"react\";\nimport { base44 } from \"@/api/base44Client\";\nimport { useMutation } from \"@tanstack/react-query\";\nimport { Button } from \"@/components/ui/button\";\nimport { Card, CardContent } from \"@/components/ui/card\";\nimport { Input } from \"@/components/ui/input\";\nimport { Label } from \"@/components/ui/label\";\nimport { useNavigate } from \"react-router-dom\";\nimport { createPageUrl } from \"@/utils\";\nimport { Building2, User, Check, ArrowRight, Sparkles, UserCircle } from \"lucide-react\";\nimport PhoneInput from \"../components/shared/PhoneInput\";\nimport { toast } from \"sonner\";\nimport { useAutoTranslate } from \"@/hooks/useTranslate\";\n\nexport default function OnboardingPage() {\n  const navigate = useNavigate();\n  \n  const txtLoading = useAutoTranslate('A carregar...', 'pt');\n  const txtCompleteProfile = useAutoTranslate('Complete o Seu Perfil', 'pt');\n  const txtHello = useAutoTranslate('Olá', 'pt');\n  const txtNeedInfo = useAutoTranslate('! Precisamos de algumas informações para começar.', 'pt');\n  const txtFullName = useAutoTranslate('Nome Completo *', 'pt');\n  const txtPlaceholderName = useAutoTranslate('João Silva', 'pt');\n  const txtPhone = useAutoTranslate('Número de Telemóvel *', 'pt');\n  const txtSaving = useAutoTranslate('A guardar...', 'pt');\n  const txtSaveContinue = useAutoTranslate('Guardar e Continuar', 'pt');\n  const txtRequiredFields = useAutoTranslate('* Campos obrigatórios', 'pt');\n  const txtFillAllFields = useAutoTranslate('Por favor preencha todos os campos obrigatórios', 'pt');\n  const txtWelcomeQZero = useAutoTranslate('Bem-vindo ao QZero! 👋', 'pt');\n  const txtHowUsePlatform = useAutoTranslate('Como deseja utilizar a plataforma', 'pt');\n  const txtPersonal = useAutoTranslate('PESSOAL', 'pt');\n  const txtBusiness = useAutoTranslate('EMPRESA', 'pt');\n  const txtPersonalDesc = useAutoTranslate('Retire senhas digitais, acompanhe filas e evite esperas', 'pt');\n  const txtBusinessDesc = useAutoTranslate('Gerir filas, atendimentos e estatísticas da sua empresa', 'pt');\n  const txtPersonalFeature1 = useAutoTranslate('Retirar senhas remotamente', 'pt');\n  const txtPersonalFeature2 = useAutoTranslate('Notificações em tempo real', 'pt');\n  const txtPersonalFeature3 = useAutoTranslate('Histórico de atendimentos', 'pt');\n  const txtPersonalFeature4 = useAutoTranslate('Acesso a todas as empresas', 'pt');\n  const txtBusinessFeature1 = useAutoTranslate('Painel de gestão completo', 'pt');\n  const txtBusinessFeature2 = useAutoTranslate('Estatísticas e analytics', 'pt');\n  const txtBusinessFeature3 = useAutoTranslate('Gestão de múltiplas filas', 'pt');\n  const txtBusinessFeature4 = useAutoTranslate('Relatórios exportáveis', 'pt');\n  const txtSelected = useAutoTranslate('Selecionado', 'pt');\n  const txtSelect = useAutoTranslate('Selecionar', 'pt');\n  const txtConfiguring = useAutoTranslate('A configurar...', 'pt');\n  const txtContinue = useAutoTranslate('Continuar', 'pt');\n  const txtCanChangeSettings = useAutoTranslate('Pode alterar esta configuração a qualquer momento nas definições', 'pt');\n  \n  const [user, setUser] = useState(null);\n  const [step, setStep] = useState('profile');\n  const [selectedMode, setSelectedMode] = useState(null);\n  const [profileData, setProfileData] = useState({\n    full_name: '',\n    phone: ''\n  });\n\n  useEffect(() => {\n    base44.auth.me().then((userData) => {\n      setUser(userData);\n      \n      if (userData.onboarding_completed) {\n        if (userData.account_type === 'empresa') {\n          navigate(createPageUrl(\"BusinessHome\"));\n        } else {\n          navigate(createPageUrl(\"Home\"));\n        }\n        return;\n      }\n      \n      if (userData.profile_completed) {\n        setStep('account_type');\n      }\n      \n      setProfileData({\n        full_name: userData.name || userData.full_name || '',\n        phone: userData.phone || ''\n      });\n    }).catch(() => {\n      base44.auth.redirectToLogin();\n    });\n  }, [navigate]);\n\n  const profileMutation = useMutation({\n    mutationFn: async (data) => {\n      await base44.auth.updateMe({\n        name: data.full_name,\n        phone: data.phone,\n        profile_completed: true\n      });\n    },\n    onSuccess: () => {\n      if (user && user.account_type) {\n        completeMutation.mutate(user.account_type);\n      } else {\n        setStep('account_type');\n      }\n    },\n  });\n\n  const completeMutation = useMutation({\n    mutationFn: async (mode) => {\n      const updates = {\n        onboarding_completed: true,\n        account_type: mode\n      };\n\n      if (mode === 'empresa') {\n        updates.is_business_user = true;\n      }\n\n      await base44.auth.updateMe(updates);\n      return mode;\n    },\n    onSuccess: (mode) => {\n      if (mode === 'empresa') {\n        navigate(createPageUrl(\"BusinessSubscription\"));\n      } else {\n        navigate(createPageUrl(\"Home\"));\n      }\n    },\n  });\n\n  const handleProfileSubmit = (e) => {\n    e.preventDefault();\n    if (!profileData.full_name || !profileData.phone) {\n      toast.error(txtFillAllFields);\n      return;\n    }\n    profileMutation.mutate(profileData);\n  };\n\n  const handleContinue = () => {\n    if (selectedMode) {\n      completeMutation.mutate(selectedMode);\n    }\n  };\n\n  if (!user) {\n    return (\n      <div className=\"bg-gradient-to-br from-slate-50 via-blue-50 to-sky-50 flex items-center justify-center py-8\">\n        <div className=\"animate-pulse text-slate-600\">{txtLoading}</div>\n      </div>\n    );\n  }\n\n  if (step === 'profile') {\n    return (\n      <div className=\"bg-gradient-to-br from-slate-50 via-blue-50 to-sky-50\">\n        <div className=\"max-w-2xl mx-auto px-4 py-6 sm:px-6 sm:py-8\">\n          <div className=\"text-center mb-12\">\n            <div className=\"inline-flex items-center justify-center w-16 h-16 bg-gradient-to-br from-sky-500 to-blue-600 rounded-2xl mb-6\">\n              <UserCircle className=\"w-8 h-8 text-white\" />\n            </div>\n            <h1 className=\"text-4xl md:text-5xl font-bold text-slate-900 mb-4\">\n              {txtCompleteProfile}\n            </h1>\n            <p className=\"text-xl text-slate-600\">\n              {txtHello}, <span className=\"font-semibold text-slate-900\">{user.email}</span>{txtNeedInfo}\n            </p>\n          </div>\n\n          <Card className=\"border-0 shadow-2xl\">\n            <CardContent className=\"p-8\">\n              <form onSubmit={handleProfileSubmit} className=\"space-y-6\" noValidate>\n                <div>\n                  <Label htmlFor=\"full_name\">{txtFullName}</Label>\n                  <Input\n                    id=\"full_name\"\n                    value={profileData.full_name}\n                    onChange={(e) => setProfileData({...profileData, full_name: e.target.value})}\n                    placeholder={txtPlaceholderName}\n                    className=\"mt-2\"\n                    autoComplete=\"name\"\n                  />\n                </div>\n\n                <div>\n                  <Label htmlFor=\"phone\">{txtPhone}</Label>\n                  <PhoneInput\n                    value={profileData.phone}\n                    onChange={(value) => setProfileData({...profileData, phone: value})}\n                    className=\"mt-2\"\n                  />\n                </div>\n\n                <Button\n                  type=\"submit\"\n                  size=\"lg\"\n                  disabled={profileMutation.isPending}\n                  className=\"w-full bg-gradient-to-r from-sky-500 to-blue-600 hover:from-sky-600 hover:to-blue-700 py-6 text-lg\"\n                >\n                  {profileMutation.isPending ? (\n                    txtSaving\n                  ) : (\n                    <>\n                      {txtSaveContinue}\n                      <ArrowRight className=\"w-5 h-5 ml-2\" />\n                    </>\n                  )}\n                </Button>\n              </form>\n            </CardContent>\n          </Card>\n\n          <p className=\"text-sm text-slate-500 mt-6 text-center\">\n            {txtRequiredFields}\n          </p>\n        </div>\n      </div>\n    );\n  }\n\n  const modes = [\n    {\n      id: 'pessoal',\n      title: txtPersonal,\n      description: txtPersonalDesc,\n      icon: User,\n      color: 'from-blue-500 to-cyan-500',\n      features: [\n        txtPersonalFeature1,\n        txtPersonalFeature2,\n        txtPersonalFeature3,\n        txtPersonalFeature4\n      ]\n    },\n    {\n      id: 'empresa',\n      title: txtBusiness,\n      description: txtBusinessDesc,\n      icon: Building2,\n      color: 'from-indigo-500 to-purple-500',\n      features: [\n        txtBusinessFeature1,\n        txtBusinessFeature2,\n        txtBusinessFeature3,\n        txtBusinessFeature4\n      ]\n    }\n  ];\n\n  return (\n    <div className=\"bg-gradient-to-br from-slate-50 via-blue-50 to-sky-50\">\n      <div className=\"max-w-7xl mx-auto px-4 py-4 sm:px-6 sm:py-6\">\n        <div className=\"text-center mb-12\">\n          <div className=\"inline-flex items-center justify-center w-16 h-16 bg-gradient-to-br from-sky-500 to-blue-600 rounded-2xl mb-6\">\n            <Sparkles className=\"w-8 h-8 text-white\" />\n          </div>\n          <h1 className=\"text-4xl md:text-5xl font-bold text-slate-900 mb-4\">\n            {txtWelcomeQZero}\n          </h1>\n          <p className=\"text-xl text-slate-600 max-w-2xl mx-auto\">\n            {txtHowUsePlatform}, <span className=\"font-semibold text-slate-900\">{user.full_name || user.email}</span>?\n          </p>\n        </div>\n\n        <div className=\"grid md:grid-cols-2 gap-6 mb-8 max-w-5xl mx-auto\">\n          {modes.map((mode) => {\n            const Icon = mode.icon;\n            const isSelected = selectedMode === mode.id;\n            \n            return (\n              <Card \n                key={mode.id}\n                className={`cursor-pointer transition-all duration-300 border-2 ${\n                  isSelected \n                    ? 'border-sky-500 shadow-2xl scale-105' \n                    : 'border-slate-200 hover:border-slate-300 hover:shadow-lg'\n                }`}\n                onClick={() => setSelectedMode(mode.id)}\n              >\n                <CardContent className=\"p-6\">\n                  <div className=\"flex items-start justify-between mb-4\">\n                    <div className={`w-14 h-14 rounded-xl bg-gradient-to-br ${mode.color} flex items-center justify-center`}>\n                      <Icon className=\"w-7 h-7 text-white\" />\n                    </div>\n                    {isSelected && (\n                      <div className=\"w-6 h-6 bg-sky-500 rounded-full flex items-center justify-center\">\n                        <Check className=\"w-4 h-4 text-white\" />\n                      </div>\n                    )}\n                  </div>\n\n                  <h3 className=\"text-xl font-bold text-slate-900 mb-2\">\n                    {mode.title}\n                  </h3>\n                  <p className=\"text-sm text-slate-600 mb-4 leading-relaxed\">\n                    {mode.description}\n                  </p>\n\n                  <div className=\"space-y-2\">\n                    {mode.features.map((feature, idx) => (\n                      <div key={idx} className=\"flex items-center gap-2 text-sm text-slate-700\">\n                        <Check className=\"w-4 h-4 text-green-500 flex-shrink-0\" />\n                        <span>{feature}</span>\n                      </div>\n                    ))}\n                  </div>\n\n                  <Button\n                    className={`w-full mt-6 ${\n                      isSelected\n                        ? 'bg-gradient-to-r from-sky-500 to-blue-600 hover:from-sky-600 hover:to-blue-700'\n                        : 'bg-slate-100 text-slate-700 hover:bg-slate-200'\n                    }`}\n                    onClick={() => setSelectedMode(mode.id)}\n                  >\n                    {isSelected ? txtSelected : txtSelect}\n                  </Button>\n                </CardContent>\n              </Card>\n            );\n          })}\n        </div>\n\n        <div className=\"text-center\">\n          <Button\n            size=\"lg\"\n            disabled={!selectedMode || completeMutation.isPending}\n            className=\"bg-gradient-to-r from-sky-500 to-blue-600 hover:from-sky-600 hover:to-blue-700 px-12 py-6 text-lg disabled:opacity-50\"\n            onClick={handleContinue}\n          >\n            {completeMutation.isPending ? (\n              txtConfiguring\n            ) : (\n              <>\n                {txtContinue}\n                <ArrowRight className=\"w-5 h-5 ml-2\" />\n              </>\n            )}\n          </Button>\n          <p className=\"text-sm text-slate-500 mt-4\">\n            {txtCanChangeSettings}\n          </p>\n        </div>\n\n      </div>\n    </div>\n  );\n}","path":null,"size_bytes":12677,"size_tokens":null},"vite.config.js":{"content":"import { defineConfig } from 'vite'\nimport react from '@vitejs/plugin-react'\nimport path from 'path'\n\n// https://vite.dev/config/\nexport default defineConfig({\n  plugins: [react()],\n  server: {\n    host: '0.0.0.0',\n    port: 5000,\n    allowedHosts: true,\n    proxy: {\n      '/api': {\n        target: 'http://localhost:3001',\n        changeOrigin: true,\n      },\n      '/uploads': {\n        target: 'http://localhost:3001',\n        changeOrigin: true,\n      },\n    },\n  },\n  resolve: {\n    alias: {\n      '@': path.resolve(__dirname, './src'),\n      '@assets': path.resolve(__dirname, './attached_assets'),\n    },\n    extensions: ['.mjs', '.js', '.jsx', '.ts', '.tsx', '.json']\n  },\n  optimizeDeps: {\n    esbuildOptions: {\n      loader: {\n        '.js': 'jsx',\n      },\n    },\n  },\n  build: {\n    outDir: 'dist',\n    assetsDir: 'assets',\n    sourcemap: false,\n    rollupOptions: {\n      output: {\n        manualChunks: {\n          vendor: ['react', 'react-dom', 'react-router-dom'],\n          ui: ['@radix-ui/react-dialog', '@radix-ui/react-popover', '@radix-ui/react-select'],\n        },\n      },\n    },\n  },\n}) ","path":null,"size_bytes":1112,"size_tokens":null},"src/components/ui/switch.jsx":{"content":"import * as React from \"react\"\nimport * as SwitchPrimitives from \"@radix-ui/react-switch\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Switch = React.forwardRef(({ className, ...props }, ref) => (\n  <SwitchPrimitives.Root\n    className={cn(\n      \"peer inline-flex h-5 w-9 shrink-0 cursor-pointer items-center rounded-full border-2 border-transparent shadow-sm transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 focus-visible:ring-offset-background disabled:cursor-not-allowed disabled:opacity-50 data-[state=checked]:bg-primary data-[state=unchecked]:bg-input\",\n      className\n    )}\n    {...props}\n    ref={ref}>\n    <SwitchPrimitives.Thumb\n      className={cn(\n        \"pointer-events-none block h-4 w-4 rounded-full bg-background shadow-lg ring-0 transition-transform data-[state=checked]:translate-x-4 data-[state=unchecked]:translate-x-0\"\n      )} />\n  </SwitchPrimitives.Root>\n))\nSwitch.displayName = SwitchPrimitives.Root.displayName\n\nexport { Switch }\n","path":null,"size_bytes":1025,"size_tokens":null},"src/components/ui/toast.jsx":{"content":"import * as React from \"react\";\nimport { cva } from \"class-variance-authority\";\nimport { X } from \"lucide-react\";\nimport { cn } from \"@/lib/utils\";\n\nconst ToastProvider = React.forwardRef(({ ...props }, ref) => (\n  <div\n    ref={ref}\n    className=\"fixed top-0 z-[100] flex max-h-screen w-full flex-col-reverse p-4 sm:bottom-0 sm:right-0 sm:top-auto sm:flex-col md:max-w-[420px]\"\n    {...props}\n  />\n));\nToastProvider.displayName = \"ToastProvider\";\n\nconst ToastViewport = React.forwardRef(({ ...props }, ref) => (\n  <div\n    ref={ref}\n    className=\"fixed top-0 z-[100] flex max-h-screen w-full flex-col-reverse p-4 sm:bottom-0 sm:right-0 sm:top-auto sm:flex-col md:max-w-[420px]\"\n    {...props}\n  />\n));\nToastViewport.displayName = \"ToastViewport\";\n\nconst toastVariants = cva(\n  \"group pointer-events-auto relative flex w-full items-center justify-between space-x-4 overflow-hidden rounded-md border p-6 pr-8 shadow-lg transition-all data-[swipe=cancel]:translate-x-0 data-[swipe=end]:translate-x-[var(--radix-toast-swipe-end-x)] data-[swipe=move]:translate-x-[var(--radix-toast-swipe-move-x)] data-[swipe=move]:transition-none data-[state=open]:animate-in data-[state=closed]:animate-out data-[swipe=end]:animate-out data-[state=closed]:fade-out-80 data-[state=closed]:slide-out-to-right-full data-[state=open]:slide-in-from-top-full data-[state=open]:sm:slide-in-from-bottom-full\",\n  {\n    variants: {\n      variant: {\n        default: \"border bg-background text-foreground\",\n        destructive:\n          \"destructive group border-destructive bg-destructive text-destructive-foreground\",\n      },\n    },\n    defaultVariants: {\n      variant: \"default\",\n    },\n  }\n);\n\nconst Toast = React.forwardRef(({ className, variant, ...props }, ref) => {\n  return (\n    <div\n      ref={ref}\n      className={cn(toastVariants({ variant }), className)}\n      {...props}\n    />\n  );\n});\nToast.displayName = \"Toast\";\n\nconst ToastAction = React.forwardRef(({ className, ...props }, ref) => (\n  <div\n    ref={ref}\n    className={cn(\n      \"inline-flex h-8 shrink-0 items-center justify-center rounded-md border bg-transparent px-3 text-sm font-medium ring-offset-background transition-colors hover:bg-secondary focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 group-[.destructive]:border-muted/40 group-[.destructive]:hover:border-destructive/30 group-[.destructive]:hover:bg-destructive group-[.destructive]:hover:text-destructive-foreground group-[.destructive]:focus:ring-destructive\",\n      className\n    )}\n    {...props}\n  />\n));\nToastAction.displayName = \"ToastAction\";\n\nconst ToastClose = React.forwardRef(({ className, ...props }, ref) => (\n  <button\n    ref={ref}\n    className={cn(\n      \"absolute right-2 top-2 rounded-md p-1 text-foreground/50 opacity-0 transition-opacity hover:text-foreground focus:opacity-100 focus:outline-none focus:ring-2 group-hover:opacity-100 group-[.destructive]:text-red-300 group-[.destructive]:hover:text-red-50 group-[.destructive]:focus:ring-red-400 group-[.destructive]:focus:ring-offset-red-600\",\n      className\n    )}\n    toast-close=\"\"\n    {...props}\n  >\n    <X className=\"h-4 w-4\" />\n  </button>\n));\nToastClose.displayName = \"ToastClose\";\n\nconst ToastTitle = React.forwardRef(({ className, ...props }, ref) => (\n  <div\n    ref={ref}\n    className={cn(\"text-sm font-semibold\", className)}\n    {...props}\n  />\n));\nToastTitle.displayName = \"ToastTitle\";\n\nconst ToastDescription = React.forwardRef(({ className, ...props }, ref) => (\n  <div\n    ref={ref}\n    className={cn(\"text-sm opacity-90\", className)}\n    {...props}\n  />\n));\nToastDescription.displayName = \"ToastDescription\";\n\nexport {\n  ToastProvider,\n  ToastViewport,\n  Toast,\n  ToastTitle,\n  ToastDescription,\n  ToastClose,\n  ToastAction,\n}; ","path":null,"size_bytes":3804,"size_tokens":null},"src/api/integrations.js":{"content":"import { base44 } from './base44Client';\n\n\n\n\nexport const Core = base44.integrations.Core;\n\nexport const InvokeLLM = base44.integrations.Core.InvokeLLM;\n\nexport const SendEmail = base44.integrations.Core.SendEmail;\n\nexport const UploadFile = base44.integrations.Core.UploadFile;\n\nexport const GenerateImage = base44.integrations.Core.GenerateImage;\n\nexport const ExtractDataFromUploadedFile = base44.integrations.Core.ExtractDataFromUploadedFile;\n\nexport const CreateFileSignedUrl = base44.integrations.Core.CreateFileSignedUrl;\n\nexport const UploadPrivateFile = base44.integrations.Core.UploadPrivateFile;\n\n\n\n\n\n\n","path":null,"size_bytes":613,"size_tokens":null},"src/pages/BusinessQueues.jsx":{"content":"import React, { useState, useEffect } from \"react\";\nimport { base44 } from \"@/api/base44Client\";\nimport { useQuery, useMutation, useQueryClient } from \"@tanstack/react-query\";\nimport { Link, useNavigate } from \"react-router-dom\";\nimport { createPageUrl } from \"@/utils\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Plus, Edit, Trash2, Users, Crown, ArrowLeft } from \"lucide-react\";\nimport { Skeleton } from \"@/components/ui/skeleton\";\nimport EmptyState from \"../components/shared/EmptyState\";\nimport QueueForm from \"../components/business/QueueForm\";\nimport { useConfirm } from \"@/hooks/useConfirm\";\nimport { toast } from \"sonner\";\nimport { useBusinessAccess } from \"@/hooks/useBusinessAccess\";\nimport { useAutoTranslate } from \"@/hooks/useTranslate\";\nimport { ExpiredBanner } from \"@/components/business/ExpiredBanner\";\nimport { BusinessFeatureGuard } from \"@/components/business/BusinessFeatureGuard\";\n\nexport default function BusinessQueuesPage() {\n  const navigate = useNavigate();\n  const queryClient = useQueryClient();\n  const [user, setUser] = useState(null);\n  const [showForm, setShowForm] = useState(false);\n  const [editingQueue, setEditingQueue] = useState(null);\n  const { confirm, ConfirmDialog } = useConfirm();\n  \n  // ✅ Usar hook com hasAccess (inclui subscrições canceladas com acesso até currentPeriodEnd)\n  const { hasAccess, hasActiveSubscription, isExpired, companyProfile, isLoading: loadingAccess } = useBusinessAccess();\n\n  const txtQueueManagement = useAutoTranslate('Gestão de Senhas', 'pt');\n  const txtCreateManage = useAutoTranslate('Crie e gerir as suas senhas de atendimento', 'pt');\n  const txtNewQueue = useAutoTranslate('Nova Senha', 'pt');\n  const txtSubscriptionRequired = useAutoTranslate('Subscrição Necessária', 'pt');\n  const txtSubscriptionDesc = useAutoTranslate('Para criar e gerir senhas de atendimento, precisa de ativar o plano empresarial.', 'pt');\n  const txtActivatePlan = useAutoTranslate('Ativar Plano Empresarial - €49,99/mês', 'pt');\n  const txtQueueDeleted = useAutoTranslate('Senha eliminada com sucesso', 'pt');\n  const txtDeleteError = useAutoTranslate('Erro ao eliminar senha', 'pt');\n  const txtDeleteTitle = useAutoTranslate('Eliminar Senha', 'pt');\n  const txtDeleteConfirm = useAutoTranslate('Tem certeza que deseja eliminar esta senha de atendimento? Esta ação não pode ser desfeita.', 'pt');\n  const txtCurrent = useAutoTranslate('Atual', 'pt');\n  const txtLast = useAutoTranslate('Última', 'pt');\n  const txtMin = useAutoTranslate('Min', 'pt');\n  const txtEdit = useAutoTranslate('Editar', 'pt');\n  const txtNoQueuesCreated = useAutoTranslate('Nenhuma senha de atendimento criada', 'pt');\n  const txtCreateFirstQueue = useAutoTranslate('Crie a sua primeira senha de atendimento para começar a gerir o fluxo de clientes', 'pt');\n  const txtCreateFirstQueueBtn = useAutoTranslate('Criar Primeira Senha', 'pt');\n  const txtOpen = useAutoTranslate('aberto', 'pt');\n  const txtPaused = useAutoTranslate('pausado', 'pt');\n  const txtClosed = useAutoTranslate('fechado', 'pt');\n\n  useEffect(() => {\n    base44.auth.me().then(userData => {\n      setUser(userData);\n      if (!userData.is_business_user || !userData.business_id) {\n        navigate(createPageUrl(\"Home\"));\n      }\n    }).catch(() => base44.auth.redirectToLogin());\n  }, [navigate]);\n\n  // ✅ Usar hasAccess (true para subscrições ativas, trial, ou canceladas com currentPeriodEnd futuro)\n  const hasSubscription = hasAccess || hasActiveSubscription || user?.has_business_subscription;\n\n  const { data: queues, isLoading } = useQuery({\n    queryKey: ['business-queues', user?.business_id],\n    queryFn: () => base44.entities.Queue.filter({ business_id: user.business_id }),\n    enabled: !!user?.business_id,\n  });\n\n  const deleteQueueMutation = useMutation({\n    mutationFn: (queueId) => base44.entities.Queue.delete(queueId),\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['business-queues', user?.business_id] });\n      toast.success(txtQueueDeleted);\n    },\n    onError: () => {\n      toast.error(txtDeleteError);\n    }\n  });\n\n  const handleEdit = (queue) => {\n    if (!hasSubscription) return;\n    setEditingQueue(queue);\n    setShowForm(true);\n  };\n\n  const handleDelete = async (queueId) => {\n    if (!hasSubscription) return;\n    const confirmed = await confirm({\n      title: txtDeleteTitle,\n      description: txtDeleteConfirm,\n    });\n    if (confirmed) {\n      deleteQueueMutation.mutate(queueId);\n    }\n  };\n\n  const txtBack = useAutoTranslate('Voltar', 'pt');\n  const txtQueueManagementFeature = useAutoTranslate('a gestão de senhas', 'pt');\n\n  if (!user || isLoading) {\n    return (\n      <div className=\"bg-gradient-to-br from-slate-50 via-blue-50 to-sky-50 p-2\">\n        <div className=\"max-w-full mx-auto px-2\">\n          <Skeleton className=\"h-8 w-40 mb-2\" />\n          <Skeleton className=\"h-48 w-full\" />\n        </div>\n      </div>\n    );\n  }\n\n  return (\n    <BusinessFeatureGuard \n      companyProfile={companyProfile}\n      hasAccess={hasAccess}\n      isExpired={isExpired}\n      feature={txtQueueManagementFeature}\n      isLoading={loadingAccess}\n    >\n    <div className=\"bg-gradient-to-br from-slate-50 via-blue-50 to-sky-50\">\n      {isExpired && <ExpiredBanner companyProfileId={companyProfile?.id} />}\n      <div className=\"max-w-6xl mx-auto px-2 sm:px-4 lg:px-8 py-2 sm:py-3 lg:py-6\">\n        <div className=\"flex items-center justify-between gap-2 lg:gap-4 mb-2 sm:mb-3 lg:mb-6\">\n          <div className=\"flex items-center gap-2 lg:gap-3 min-w-0\">\n            <Button\n              variant=\"ghost\"\n              size=\"sm\"\n              className=\"h-7 w-7 lg:h-10 lg:w-10 p-0 flex-shrink-0\"\n              onClick={() => navigate(createPageUrl(\"BusinessDashboard\"))}\n            >\n              <ArrowLeft className=\"w-4 h-4 lg:w-5 lg:h-5\" />\n            </Button>\n            <div className=\"min-w-0\">\n              <h1 className=\"text-sm sm:text-base lg:text-2xl xl:text-3xl font-bold text-slate-900 truncate\">{txtQueueManagement}</h1>\n              <p className=\"text-[10px] sm:text-xs lg:text-base text-slate-500 truncate hidden sm:block\">{txtCreateManage}</p>\n            </div>\n          </div>\n          {!isExpired && (\n            <Button \n              size=\"sm\" \n              onClick={() => { setEditingQueue(null); setShowForm(true); }} \n              className=\"gap-1 lg:gap-2 h-7 lg:h-10 text-xs lg:text-sm px-2 lg:px-4 flex-shrink-0\"\n            >\n              <Plus className=\"w-3 h-3 lg:w-4 lg:h-4\" />\n              <span className=\"hidden sm:inline\">{txtNewQueue}</span>\n              <span className=\"sm:hidden\">+</span>\n            </Button>\n          )}\n        </div>\n\n        {showForm ? (\n          <Card className=\"border-0 shadow-md mb-3\">\n            <CardHeader className=\"p-3 pb-2\">\n              <CardTitle className=\"text-sm\">{editingQueue ? 'Editar Ticket' : 'Novo Ticket'}</CardTitle>\n            </CardHeader>\n            <CardContent className=\"p-3 pt-0\">\n              <QueueForm\n                queue={editingQueue}\n                businessId={user.business_id}\n                onClose={() => {\n                  setShowForm(false);\n                  setEditingQueue(null);\n                }}\n              />\n            </CardContent>\n          </Card>\n        ) : queues.length === 0 ? (\n          <EmptyState\n            icon={Users}\n            title={txtNoQueuesCreated}\n            description={txtCreateFirstQueue}\n            action={{\n              label: txtCreateFirstQueueBtn,\n              onClick: () => setShowForm(true)\n            }}\n          />\n        ) : (\n          <div className=\"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-2 lg:gap-4\">\n            {queues.map(queue => (\n              <Card key={queue.id} className=\"border-0 shadow-sm lg:shadow-md hover:shadow-md lg:hover:shadow-lg transition-all\">\n                <CardContent className=\"p-3 lg:p-5\">\n                  <div className=\"flex justify-between items-start gap-2 lg:gap-3 mb-2 lg:mb-3\">\n                    <div className=\"min-w-0 flex-1\">\n                      <h3 className=\"font-semibold text-sm lg:text-lg text-slate-900 truncate\">{queue.name}</h3>\n                      {queue.description && (\n                        <p className=\"text-[10px] lg:text-sm text-slate-500 truncate\">{queue.description}</p>\n                      )}\n                    </div>\n                    <div className={`px-1.5 lg:px-3 py-0.5 lg:py-1 rounded-full text-[10px] lg:text-xs font-medium flex-shrink-0 ${\n                      queue.status === 'aberta' ? 'bg-green-100 text-green-700' :\n                      queue.status === 'pausada' ? 'bg-amber-100 text-amber-700' :\n                      'bg-red-100 text-red-700'\n                    }`}>\n                      {queue.status === 'aberta' ? txtOpen : queue.status === 'pausada' ? txtPaused : txtClosed}\n                    </div>\n                  </div>\n\n                  <div className=\"grid grid-cols-3 gap-1.5 lg:gap-3 mb-2 lg:mb-4\">\n                    <div className=\"p-1.5 lg:p-3 bg-blue-50 rounded lg:rounded-lg text-center\">\n                      <div className=\"text-sm lg:text-xl font-bold text-blue-600\">#{queue.current_number}</div>\n                      <div className=\"text-[9px] lg:text-xs text-blue-500\">{txtCurrent}</div>\n                    </div>\n                    <div className=\"p-1.5 lg:p-3 bg-purple-50 rounded lg:rounded-lg text-center\">\n                      <div className=\"text-sm lg:text-xl font-bold text-purple-600\">#{queue.last_issued_number}</div>\n                      <div className=\"text-[9px] lg:text-xs text-purple-500\">{txtLast}</div>\n                    </div>\n                    <div className=\"p-1.5 lg:p-3 bg-green-50 rounded lg:rounded-lg text-center\">\n                      <div className=\"text-sm lg:text-xl font-bold text-green-600\">{queue.average_service_time}</div>\n                      <div className=\"text-[9px] lg:text-xs text-green-500\">{txtMin}</div>\n                    </div>\n                  </div>\n\n                  {!isExpired && (\n                    <div className=\"flex gap-1.5 lg:gap-2\">\n                      <Button\n                        variant=\"outline\"\n                        size=\"sm\"\n                        className=\"flex-1 h-7 lg:h-9 text-xs lg:text-sm\"\n                        onClick={() => handleEdit(queue)}\n                      >\n                        <Edit className=\"w-3 h-3 lg:w-4 lg:h-4 mr-1\" />\n                        {txtEdit}\n                      </Button>\n                      <Button\n                        variant=\"outline\"\n                        size=\"sm\"\n                        className=\"h-7 w-7 p-0 border-red-200 text-red-600 hover:bg-red-50\"\n                        onClick={() => handleDelete(queue.id)}\n                      >\n                        <Trash2 className=\"w-3 h-3\" />\n                      </Button>\n                    </div>\n                  )}\n                </CardContent>\n              </Card>\n            ))}\n          </div>\n        )}\n      </div>\n      <ConfirmDialog />\n    </div>\n    </BusinessFeatureGuard>\n  );\n}","path":null,"size_bytes":11226,"size_tokens":null},"src/components/business/StaffManager.jsx":{"content":"import React, { useState } from \"react\";\nimport { base44 } from \"@/api/base44Client\";\nimport { useQuery, useMutation, useQueryClient } from \"@tanstack/react-query\";\nimport { Button } from \"@/components/ui/button\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Input } from \"@/components/ui/input\";\nimport { Label } from \"@/components/ui/label\";\nimport { Badge } from \"@/components/ui/badge\";\nimport {\n  Select,\n  SelectContent,\n  SelectItem,\n  SelectTrigger,\n  SelectValue,\n} from \"@/components/ui/select\";\nimport { Plus, Edit, Trash2, Users, Mail, Phone } from \"lucide-react\";\nimport { useAutoTranslate } from \"@/hooks/useTranslate\";\n\nexport default function StaffManager({ businessId }) {\n  const txtTeam = useAutoTranslate('Equipa', 'pt');\n  const txtAdd = useAutoTranslate('Adicionar', 'pt');\n  const txtEdit = useAutoTranslate('Editar', 'pt');\n  const txtNew = useAutoTranslate('Novo', 'pt');\n  const txtEmployee = useAutoTranslate('Funcionário', 'pt');\n  const txtName = useAutoTranslate('Nome', 'pt');\n  const txtEmail = useAutoTranslate('Email', 'pt');\n  const txtPhone = useAutoTranslate('Telefone', 'pt');\n  const txtRole = useAutoTranslate('Função', 'pt');\n  const txtAttendant = useAutoTranslate('Atendente', 'pt');\n  const txtSupervisor = useAutoTranslate('Supervisor', 'pt');\n  const txtManager = useAutoTranslate('Gestor', 'pt');\n  const txtUpdate = useAutoTranslate('Atualizar', 'pt');\n  const txtCreate = useAutoTranslate('Criar', 'pt');\n  const txtCancel = useAutoTranslate('Cancelar', 'pt');\n  const txtNoEmployees = useAutoTranslate('Nenhum funcionário', 'pt');\n  const txtDelete = useAutoTranslate('Eliminar?', 'pt');\n\n  const queryClient = useQueryClient();\n  const [showForm, setShowForm] = useState(false);\n  const [editingStaff, setEditingStaff] = useState(null);\n  const [formData, setFormData] = useState({\n    name: \"\",\n    email: \"\",\n    phone: \"\",\n    role: \"atendente\"\n  });\n\n  const { data: staff } = useQuery({\n    queryKey: ['staff', businessId],\n    queryFn: () => base44.entities.Staff.filter({ business_id: businessId }),\n    initialData: [],\n  });\n\n  const createMutation = useMutation({\n    mutationFn: (data) => base44.entities.Staff.create({ ...data, business_id: businessId }),\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['staff'] });\n      resetForm();\n    },\n  });\n\n  const updateMutation = useMutation({\n    mutationFn: ({ id, data }) => base44.entities.Staff.update(id, data),\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['staff'] });\n      resetForm();\n    },\n  });\n\n  const deleteMutation = useMutation({\n    mutationFn: (id) => base44.entities.Staff.delete(id),\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['staff'] });\n    },\n  });\n\n  const resetForm = () => {\n    setFormData({ name: \"\", email: \"\", phone: \"\", role: \"atendente\" });\n    setEditingStaff(null);\n    setShowForm(false);\n  };\n\n  const handleSubmit = (e) => {\n    e.preventDefault();\n    if (editingStaff) {\n      updateMutation.mutate({ id: editingStaff.id, data: formData });\n    } else {\n      createMutation.mutate(formData);\n    }\n  };\n\n  const handleEdit = (member) => {\n    setEditingStaff(member);\n    setFormData({\n      name: member.name,\n      email: member.email || \"\",\n      phone: member.phone || \"\",\n      role: member.role\n    });\n    setShowForm(true);\n  };\n\n  const roleLabels = {\n    atendente: txtAttendant,\n    supervisor: txtSupervisor,\n    manager: txtManager\n  };\n\n  const roleColors = {\n    atendente: \"bg-blue-100 text-blue-700 border-blue-200\",\n    supervisor: \"bg-purple-100 text-purple-700 border-purple-200\",\n    manager: \"bg-amber-100 text-amber-700 border-amber-200\"\n  };\n\n  return (\n    <div className=\"space-y-4 md:space-y-6\">\n      <div className=\"flex flex-col sm:flex-row justify-between items-start sm:items-center gap-3\">\n        <h3 className=\"text-base md:text-lg font-bold text-slate-900\">{txtTeam}</h3>\n        <Button size=\"sm\" onClick={() => setShowForm(!showForm)} className=\"gap-2 w-full sm:w-auto h-9\">\n          <Plus className=\"w-3 h-3 md:w-4 md:h-4\" />\n          {txtAdd}\n        </Button>\n      </div>\n\n      {showForm && (\n        <Card className=\"border-2 border-sky-200\">\n          <CardHeader className=\"p-3 md:p-6\">\n            <CardTitle className=\"text-sm md:text-base\">{editingStaff ? txtEdit : txtNew} {txtEmployee}</CardTitle>\n          </CardHeader>\n          <CardContent className=\"p-3 md:p-6\">\n            <form onSubmit={handleSubmit} className=\"space-y-3 md:space-y-4\" noValidate>\n              <div>\n                <Label className=\"text-xs md:text-sm\">{txtName} *</Label>\n                <Input\n                  value={formData.name}\n                  onChange={(e) => setFormData({...formData, name: e.target.value})}\n                  className=\"h-9 text-sm\"\n                />\n              </div>\n              <div className=\"grid md:grid-cols-2 gap-3 md:gap-4\">\n                <div>\n                  <Label className=\"text-xs md:text-sm\">{txtEmail}</Label>\n                  <Input\n                    type=\"text\"\n                    inputMode=\"email\"\n                    value={formData.email}\n                    onChange={(e) => setFormData({...formData, email: e.target.value})}\n                    className=\"h-9 text-sm\"\n                    autoComplete=\"off\"\n                  />\n                </div>\n                <div>\n                  <Label className=\"text-xs md:text-sm\">{txtPhone}</Label>\n                  <Input\n                    value={formData.phone}\n                    onChange={(e) => setFormData({...formData, phone: e.target.value})}\n                    className=\"h-9 text-sm\"\n                  />\n                </div>\n              </div>\n              <div>\n                <Label className=\"text-xs md:text-sm\">{txtRole}</Label>\n                <Select value={formData.role} onValueChange={(value) => setFormData({...formData, role: value})}>\n                  <SelectTrigger className=\"h-9 text-sm\">\n                    <SelectValue />\n                  </SelectTrigger>\n                  <SelectContent>\n                    <SelectItem value=\"atendente\" className=\"text-sm\">{txtAttendant}</SelectItem>\n                    <SelectItem value=\"supervisor\" className=\"text-sm\">{txtSupervisor}</SelectItem>\n                    <SelectItem value=\"manager\" className=\"text-sm\">{txtManager}</SelectItem>\n                  </SelectContent>\n                </Select>\n              </div>\n              <div className=\"flex gap-2\">\n                <Button type=\"submit\" size=\"sm\" disabled={createMutation.isPending || updateMutation.isPending} className=\"flex-1 h-9\">\n                  {editingStaff ? txtUpdate : txtCreate}\n                </Button>\n                <Button type=\"button\" size=\"sm\" variant=\"outline\" onClick={resetForm} className=\"flex-1 h-9\">\n                  {txtCancel}\n                </Button>\n              </div>\n            </form>\n          </CardContent>\n        </Card>\n      )}\n\n      {staff.length === 0 ? (\n        <Card>\n          <CardContent className=\"py-8 md:py-12 text-center\">\n            <Users className=\"w-10 h-10 md:w-12 md:h-12 text-slate-400 mx-auto mb-2 md:mb-3\" />\n            <p className=\"text-sm text-slate-600\">{txtNoEmployees}</p>\n          </CardContent>\n        </Card>\n      ) : (\n        <div className=\"grid md:grid-cols-2 gap-3 md:gap-4\">\n          {staff.map((member) => (\n            <Card key={member.id}>\n              <CardContent className=\"p-3 md:p-4\">\n                <div className=\"flex justify-between items-start mb-2 md:mb-3\">\n                  <div className=\"flex-1 min-w-0\">\n                    <h4 className=\"font-bold text-sm md:text-base text-slate-900 truncate\">{member.name}</h4>\n                    <Badge className={`${roleColors[member.role]} text-xs mt-1`}>\n                      {roleLabels[member.role]}\n                    </Badge>\n                  </div>\n                  <div className=\"flex gap-1 ml-2\">\n                    <Button size=\"sm\" variant=\"ghost\" onClick={() => handleEdit(member)} className=\"h-7 w-7 p-0\">\n                      <Edit className=\"w-3 h-3 md:w-4 md:h-4\" />\n                    </Button>\n                    <Button \n                      size=\"sm\" \n                      variant=\"ghost\" \n                      onClick={() => {\n                        if (confirm(txtDelete)) {\n                          deleteMutation.mutate(member.id);\n                        }\n                      }}\n                      className=\"text-red-600 hover:text-red-700 hover:bg-red-50 h-7 w-7 p-0\"\n                    >\n                      <Trash2 className=\"w-3 h-3 md:w-4 md:h-4\" />\n                    </Button>\n                  </div>\n                </div>\n                {member.email && (\n                  <div className=\"flex items-center gap-2 text-xs md:text-sm text-slate-600 mb-1\">\n                    <Mail className=\"w-3 h-3\" />\n                    <span className=\"truncate\">{member.email}</span>\n                  </div>\n                )}\n                {member.phone && (\n                  <div className=\"flex items-center gap-2 text-xs md:text-sm text-slate-600\">\n                    <Phone className=\"w-3 h-3\" />\n                    {member.phone}\n                  </div>\n                )}\n              </CardContent>\n            </Card>\n          ))}\n        </div>\n      )}\n    </div>\n  );\n}","path":null,"size_bytes":9472,"size_tokens":null},"src/components/shared/TicketCard.jsx":{"content":"import React from \"react\";\nimport { Link } from \"react-router-dom\";\nimport { createPageUrl } from \"@/utils\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Clock, Loader2, Star } from \"lucide-react\";\nimport { useAutoTranslate } from \"@/hooks/useTranslate\";\n\nexport default function TicketCard({ ticket, showEstimate = true, variant = \"default\" }) {\n  // Traduções\n  const txtWaiting = useAutoTranslate('Aguardando', 'pt');\n  const txtYourTurn = useAutoTranslate('É Sua Vez!', 'pt');\n  const txtInService = useAutoTranslate('Atendendo', 'pt');\n  const txtCompleted = useAutoTranslate('Concluído', 'pt');\n  const txtCancelled = useAutoTranslate('Cancelado', 'pt');\n  const txtPosition = useAutoTranslate('Posição', 'pt');\n  const txtEstimatedTime = useAutoTranslate('Tempo estimado', 'pt');\n  const txtMin = useAutoTranslate('min', 'pt');\n\n  const statusConfig = {\n    aguardando: { icon: Clock, color: \"bg-blue-500 text-white\", label: txtWaiting },\n    chamado: { icon: Clock, color: \"bg-amber-500 text-white animate-pulse\", label: txtYourTurn },\n    atendendo: { icon: Loader2, color: \"bg-purple-500 text-white\", label: txtInService },\n    concluido: { icon: Star, color: \"bg-green-500 text-white\", label: txtCompleted },\n    cancelado: { icon: Clock, color: \"bg-red-500 text-white\", label: txtCancelled }\n  };\n  const status = statusConfig[ticket.status];\n  const StatusIcon = status.icon;\n  const isCompact = variant === \"compact\";\n\n  return (\n    <Link to={createPageUrl(`TicketView?id=${ticket.id}`)}>\n      <div className={`p-4 bg-gradient-to-br ${\n        ticket.status === 'chamado' ? 'from-amber-50 to-orange-50 border-amber-300' :\n        'from-blue-50 to-sky-50 border-blue-200'\n      } rounded-xl border hover:shadow-lg transition-all cursor-pointer`}>\n        <div className=\"flex justify-between items-start mb-3\">\n          <div>\n            <div className=\"text-3xl font-bold text-blue-600\">#{ticket.ticket_number}</div>\n            {showEstimate && ticket.position && (\n              <div className=\"text-sm text-slate-600\">{txtPosition}: {ticket.position}</div>\n            )}\n          </div>\n          <Badge className={status.color}>\n            <StatusIcon className={`w-3 h-3 mr-1 ${status.icon === Loader2 ? 'animate-spin' : ''}`} />\n            {status.label}\n          </Badge>\n        </div>\n        \n        {showEstimate && ticket.estimated_time && (\n          <div className=\"text-sm text-slate-600\">\n            {txtEstimatedTime}: ~{ticket.estimated_time} {txtMin}\n          </div>\n        )}\n\n        {ticket.rating && (\n          <div className=\"flex items-center gap-1 mt-2\">\n            {[...Array(5)].map((_, i) => (\n              <Star\n                key={i}\n                className={`w-3 h-3 ${i < ticket.rating ? 'fill-amber-400 text-amber-400' : 'text-slate-300'}`}\n              />\n            ))}\n          </div>\n        )}\n      </div>\n    </Link>\n  );\n}","path":null,"size_bytes":2916,"size_tokens":null},"src/components/ui/chart.jsx":{"content":"\"use client\";\nimport * as React from \"react\"\nimport * as RechartsPrimitive from \"recharts\"\n\nimport { cn } from \"@/lib/utils\"\n\n// Format: { THEME_NAME: CSS_SELECTOR }\nconst THEMES = {\n  light: \"\",\n  dark: \".dark\"\n}\n\nconst ChartContext = React.createContext(null)\n\nfunction useChart() {\n  const context = React.useContext(ChartContext)\n\n  if (!context) {\n    throw new Error(\"useChart must be used within a <ChartContainer />\")\n  }\n\n  return context\n}\n\nconst ChartContainer = React.forwardRef(({ id, className, children, config, ...props }, ref) => {\n  const uniqueId = React.useId()\n  const chartId = `chart-${id || uniqueId.replace(/:/g, \"\")}`\n\n  return (\n    (<ChartContext.Provider value={{ config }}>\n      <div\n        data-chart={chartId}\n        ref={ref}\n        className={cn(\n          \"flex aspect-video justify-center text-xs [&_.recharts-cartesian-axis-tick_text]:fill-muted-foreground [&_.recharts-cartesian-grid_line[stroke='#ccc']]:stroke-border/50 [&_.recharts-curve.recharts-tooltip-cursor]:stroke-border [&_.recharts-dot[stroke='#fff']]:stroke-transparent [&_.recharts-layer]:outline-none [&_.recharts-polar-grid_[stroke='#ccc']]:stroke-border [&_.recharts-radial-bar-background-sector]:fill-muted [&_.recharts-rectangle.recharts-tooltip-cursor]:fill-muted [&_.recharts-reference-line_[stroke='#ccc']]:stroke-border [&_.recharts-sector[stroke='#fff']]:stroke-transparent [&_.recharts-sector]:outline-none [&_.recharts-surface]:outline-none\",\n          className\n        )}\n        {...props}>\n        <ChartStyle id={chartId} config={config} />\n        <RechartsPrimitive.ResponsiveContainer>\n          {children}\n        </RechartsPrimitive.ResponsiveContainer>\n      </div>\n    </ChartContext.Provider>)\n  );\n})\nChartContainer.displayName = \"Chart\"\n\nconst ChartStyle = ({\n  id,\n  config\n}) => {\n  const colorConfig = Object.entries(config).filter(([, config]) => config.theme || config.color)\n\n  if (!colorConfig.length) {\n    return null\n  }\n\n  return (\n    (<style\n      dangerouslySetInnerHTML={{\n        __html: Object.entries(THEMES)\n          .map(([theme, prefix]) => `\n${prefix} [data-chart=${id}] {\n${colorConfig\n.map(([key, itemConfig]) => {\nconst color =\n  itemConfig.theme?.[theme] ||\n  itemConfig.color\nreturn color ? `  --color-${key}: ${color};` : null\n})\n.join(\"\\n\")}\n}\n`)\n          .join(\"\\n\"),\n      }} />)\n  );\n}\n\nconst ChartTooltip = RechartsPrimitive.Tooltip\n\nconst ChartTooltipContent = React.forwardRef((\n  {\n    active,\n    payload,\n    className,\n    indicator = \"dot\",\n    hideLabel = false,\n    hideIndicator = false,\n    label,\n    labelFormatter,\n    labelClassName,\n    formatter,\n    color,\n    nameKey,\n    labelKey,\n  },\n  ref\n) => {\n  const { config } = useChart()\n\n  const tooltipLabel = React.useMemo(() => {\n    if (hideLabel || !payload?.length) {\n      return null\n    }\n\n    const [item] = payload\n    const key = `${labelKey || item.dataKey || item.name || \"value\"}`\n    const itemConfig = getPayloadConfigFromPayload(config, item, key)\n    const value =\n      !labelKey && typeof label === \"string\"\n        ? config[label]?.label || label\n        : itemConfig?.label\n\n    if (labelFormatter) {\n      return (\n        (<div className={cn(\"font-medium\", labelClassName)}>\n          {labelFormatter(value, payload)}\n        </div>)\n      );\n    }\n\n    if (!value) {\n      return null\n    }\n\n    return <div className={cn(\"font-medium\", labelClassName)}>{value}</div>;\n  }, [\n    label,\n    labelFormatter,\n    payload,\n    hideLabel,\n    labelClassName,\n    config,\n    labelKey,\n  ])\n\n  if (!active || !payload?.length) {\n    return null\n  }\n\n  const nestLabel = payload.length === 1 && indicator !== \"dot\"\n\n  return (\n    (<div\n      ref={ref}\n      className={cn(\n        \"grid min-w-[8rem] items-start gap-1.5 rounded-lg border border-border/50 bg-background px-2.5 py-1.5 text-xs shadow-xl\",\n        className\n      )}>\n      {!nestLabel ? tooltipLabel : null}\n      <div className=\"grid gap-1.5\">\n        {payload.map((item, index) => {\n          const key = `${nameKey || item.name || item.dataKey || \"value\"}`\n          const itemConfig = getPayloadConfigFromPayload(config, item, key)\n          const indicatorColor = color || item.payload.fill || item.color\n\n          return (\n            (<div\n              key={item.dataKey}\n              className={cn(\n                \"flex w-full flex-wrap items-stretch gap-2 [&>svg]:h-2.5 [&>svg]:w-2.5 [&>svg]:text-muted-foreground\",\n                indicator === \"dot\" && \"items-center\"\n              )}>\n              {formatter && item?.value !== undefined && item.name ? (\n                formatter(item.value, item.name, item, index, item.payload)\n              ) : (\n                <>\n                  {itemConfig?.icon ? (\n                    <itemConfig.icon />\n                  ) : (\n                    !hideIndicator && (\n                      <div\n                        className={cn(\"shrink-0 rounded-[2px] border-[--color-border] bg-[--color-bg]\", {\n                          \"h-2.5 w-2.5\": indicator === \"dot\",\n                          \"w-1\": indicator === \"line\",\n                          \"w-0 border-[1.5px] border-dashed bg-transparent\":\n                            indicator === \"dashed\",\n                          \"my-0.5\": nestLabel && indicator === \"dashed\",\n                        })}\n                        style={\n                          {\n                            \"--color-bg\": indicatorColor,\n                            \"--color-border\": indicatorColor\n                          }\n                        } />\n                    )\n                  )}\n                  <div\n                    className={cn(\n                      \"flex flex-1 justify-between leading-none\",\n                      nestLabel ? \"items-end\" : \"items-center\"\n                    )}>\n                    <div className=\"grid gap-1.5\">\n                      {nestLabel ? tooltipLabel : null}\n                      <span className=\"text-muted-foreground\">\n                        {itemConfig?.label || item.name}\n                      </span>\n                    </div>\n                    {item.value && (\n                      <span className=\"font-mono font-medium tabular-nums text-foreground\">\n                        {item.value.toLocaleString()}\n                      </span>\n                    )}\n                  </div>\n                </>\n              )}\n            </div>)\n          );\n        })}\n      </div>\n    </div>)\n  );\n})\nChartTooltipContent.displayName = \"ChartTooltip\"\n\nconst ChartLegend = RechartsPrimitive.Legend\n\nconst ChartLegendContent = React.forwardRef((\n  { className, hideIcon = false, payload, verticalAlign = \"bottom\", nameKey },\n  ref\n) => {\n  const { config } = useChart()\n\n  if (!payload?.length) {\n    return null\n  }\n\n  return (\n    (<div\n      ref={ref}\n      className={cn(\n        \"flex items-center justify-center gap-4\",\n        verticalAlign === \"top\" ? \"pb-3\" : \"pt-3\",\n        className\n      )}>\n      {payload.map((item) => {\n        const key = `${nameKey || item.dataKey || \"value\"}`\n        const itemConfig = getPayloadConfigFromPayload(config, item, key)\n\n        return (\n          (<div\n            key={item.value}\n            className={cn(\n              \"flex items-center gap-1.5 [&>svg]:h-3 [&>svg]:w-3 [&>svg]:text-muted-foreground\"\n            )}>\n            {itemConfig?.icon && !hideIcon ? (\n              <itemConfig.icon />\n            ) : (\n              <div\n                className=\"h-2 w-2 shrink-0 rounded-[2px]\"\n                style={{\n                  backgroundColor: item.color,\n                }} />\n            )}\n            {itemConfig?.label}\n          </div>)\n        );\n      })}\n    </div>)\n  );\n})\nChartLegendContent.displayName = \"ChartLegend\"\n\n// Helper to extract item config from a payload.\nfunction getPayloadConfigFromPayload(\n  config,\n  payload,\n  key\n) {\n  if (typeof payload !== \"object\" || payload === null) {\n    return undefined\n  }\n\n  const payloadPayload =\n    \"payload\" in payload &&\n    typeof payload.payload === \"object\" &&\n    payload.payload !== null\n      ? payload.payload\n      : undefined\n\n  let configLabelKey = key\n\n  if (\n    key in payload &&\n    typeof payload[key] === \"string\"\n  ) {\n    configLabelKey = payload[key]\n  } else if (\n    payloadPayload &&\n    key in payloadPayload &&\n    typeof payloadPayload[key] === \"string\"\n  ) {\n    configLabelKey = payloadPayload[key]\n  }\n\n  return configLabelKey in config\n    ? config[configLabelKey]\n    : config[key];\n}\n\nexport {\n  ChartContainer,\n  ChartTooltip,\n  ChartTooltipContent,\n  ChartLegend,\n  ChartLegendContent,\n  ChartStyle,\n}\n","path":null,"size_bytes":8639,"size_tokens":null},"src/components/business/QueueForm.jsx":{"content":"import React, { useState, useEffect } from \"react\";\nimport { base44 } from \"@/api/base44Client\";\nimport { useMutation, useQueryClient } from \"@tanstack/react-query\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Label } from \"@/components/ui/label\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport { Tabs, TabsList, TabsTrigger, TabsContent } from \"@/components/ui/tabs\";\nimport { X, Save, Info } from \"lucide-react\";\nimport { toast } from \"sonner\";\nimport {\n  Tooltip,\n  TooltipContent,\n  TooltipProvider,\n  TooltipTrigger,\n} from \"@/components/ui/tooltip\";\nimport QueueSchedule from \"./QueueSchedule\";\nimport { useAutoTranslate } from \"@/hooks/useTranslate\";\n\nexport default function QueueForm({ queue, businessId, onClose }) {\n  // Traduções\n  const txtEditQueue = useAutoTranslate('Editar Ticket', 'pt');\n  const txtNewQueue = useAutoTranslate('Novo Ticket', 'pt');\n  const txtInfo = useAutoTranslate('Info', 'pt');\n  const txtConfig = useAutoTranslate('Config', 'pt');\n  const txtSchedule = useAutoTranslate('Horários', 'pt');\n  const txtQueueName = useAutoTranslate('Nome do Ticket', 'pt');\n  const txtDescription = useAutoTranslate('Descrição', 'pt');\n  const txtAvgServiceTime = useAutoTranslate('Tempo Médio de Atendimento (min)', 'pt');\n  const txtToleranceTime = useAutoTranslate('Tempo de Tolerância (min)', 'pt');\n  const txtOptional = useAutoTranslate('(opcional)', 'pt');\n  const txtToleranceTooltip = useAutoTranslate('Tempo que o cliente tem para chegar após ser chamado', 'pt');\n  const txtNoTolerance = useAutoTranslate('0 = sem tolerância', 'pt');\n  const txtMaxCapacity = useAutoTranslate('Capacidade Máxima', 'pt');\n  const txtCancel = useAutoTranslate('Cancelar', 'pt');\n  const txtSave = useAutoTranslate('Salvar', 'pt');\n  const txtQueueUpdated = useAutoTranslate('Ticket atualizado com sucesso!', 'pt');\n  const txtQueueCreated = useAutoTranslate('Ticket criado com sucesso!', 'pt');\n  const txtErrorSaving = useAutoTranslate('Erro ao salvar ticket:', 'pt');\n  const txtPlaceholderGeneral = useAutoTranslate('Ex: Atendimento Geral', 'pt');\n  const queryClient = useQueryClient();\n  const [formData, setFormData] = useState(queue || {\n    name: '',\n    description: '',\n    average_service_time: 10,\n    tolerance_time: 5,\n    max_capacity: 100,\n    current_number: 0,\n    last_issued_number: 0,\n    status: 'aberta',\n    is_active: true,\n    working_hours: {}\n  });\n\n  useEffect(() => {\n    if (queue) {\n      console.log('📝 QueueForm received queue:', queue);\n      console.log('📅 Working hours from queue:', queue.working_hours);\n      setFormData({\n        ...queue,\n        tolerance_time: queue.tolerance_time || 5\n      });\n    } else {\n      setFormData({\n        name: '',\n        description: '',\n        average_service_time: 10,\n        tolerance_time: 5,\n        max_capacity: 100,\n        current_number: 0,\n        last_issued_number: 0,\n        status: 'aberta',\n        is_active: true,\n        working_hours: {}\n      });\n    }\n  }, [queue]);\n\n  const saveMutation = useMutation({\n    mutationFn: async (data) => {\n      console.log('💾 Saving queue...', { queueId: queue?.id, data });\n      if (queue) {\n        const result = await base44.entities.Queue.update(queue.id, data);\n        console.log('✅ Queue updated:', result);\n        return result;\n      } else {\n        const result = await base44.entities.Queue.create({\n          ...data,\n          business_id: businessId\n        });\n        console.log('✅ Queue created:', result);\n        return result;\n      }\n    },\n    onSuccess: async (updatedQueue) => {\n      console.log('✅ onSuccess called, updating cache directly...');\n      \n      queryClient.setQueryData(['business-queues', businessId], (oldData) => {\n        if (!oldData) return [updatedQueue];\n        if (queue) {\n          return oldData.map(q => q.id === updatedQueue.id ? updatedQueue : q);\n        } else {\n          return [...oldData, updatedQueue];\n        }\n      });\n      \n      toast.success(queue ? txtQueueUpdated : txtQueueCreated);\n      onClose();\n    },\n    onError: (error) => {\n      console.error('❌ Error saving queue:', error);\n      toast.error(`${txtErrorSaving} ${error.message}`);\n    }\n  });\n\n  const handleSubmit = (e) => {\n    e.preventDefault();\n    saveMutation.mutate(formData);\n  };\n\n  const handleChange = (field, value) => {\n    setFormData(prev => ({ ...prev, [field]: value }));\n  };\n\n  return (\n    <form onSubmit={handleSubmit} className=\"space-y-6 bg-white p-6 rounded-xl border border-slate-200\" noValidate>\n      <div className=\"flex justify-between items-center mb-4\">\n        <h3 className=\"text-xl font-bold text-slate-900\">\n          {queue ? txtEditQueue : txtNewQueue}\n        </h3>\n        <Button\n          type=\"button\"\n          variant=\"ghost\"\n          size=\"sm\"\n          onClick={onClose}\n        >\n          <X className=\"w-4 h-4\" />\n        </Button>\n      </div>\n\n      <Tabs defaultValue=\"info\" className=\"w-full\">\n        <TabsList className=\"flex flex-row w-full h-auto gap-1 p-1\">\n          <TabsTrigger value=\"info\" className=\"flex-1 text-xs sm:text-sm px-2 py-2\">\n            {txtInfo}\n          </TabsTrigger>\n          <TabsTrigger value=\"config\" className=\"flex-1 text-xs sm:text-sm px-2 py-2\">\n            {txtConfig}\n          </TabsTrigger>\n          <TabsTrigger value=\"schedule\" className=\"flex-1 text-xs sm:text-sm px-2 py-2\">\n            {txtSchedule}\n          </TabsTrigger>\n        </TabsList>\n\n        <TabsContent value=\"info\" className=\"space-y-4 mt-6\">\n          <div>\n            <Label htmlFor=\"queue-name\">{txtQueueName} *</Label>\n            <Input\n              id=\"queue-name\"\n              value={formData.name}\n              onChange={(e) => handleChange('name', e.target.value)}\n              placeholder={txtPlaceholderGeneral}\n            />\n          </div>\n\n          <div>\n            <Label htmlFor=\"queue-description\">{txtDescription}</Label>\n            <Textarea\n              id=\"queue-description\"\n              value={formData.description}\n              onChange={(e) => handleChange('description', e.target.value)}\n              placeholder={txtDescription}\n              rows={2}\n            />\n          </div>\n        </TabsContent>\n\n        <TabsContent value=\"config\" className=\"space-y-4 mt-6\">\n          <div className=\"grid md:grid-cols-2 gap-6\">\n            <div>\n              <Label htmlFor=\"avg-time\">{txtAvgServiceTime} *</Label>\n              <Input\n                id=\"avg-time\"\n                type=\"number\"\n                min=\"1\"\n                value={formData.average_service_time}\n                onChange={(e) => handleChange('average_service_time', parseInt(e.target.value))}\n              />\n            </div>\n\n            <div>\n              <div className=\"flex items-center gap-2 mb-2\">\n                <Label htmlFor=\"tolerance-time\">\n                  {txtToleranceTime} <span className=\"text-xs text-slate-400\">{txtOptional}</span>\n                </Label>\n                <TooltipProvider>\n                  <Tooltip>\n                    <TooltipTrigger asChild>\n                      <Info className=\"w-4 h-4 text-slate-400 cursor-help\" />\n                    </TooltipTrigger>\n                    <TooltipContent>\n                      <p className=\"max-w-xs\">{txtToleranceTooltip}</p>\n                    </TooltipContent>\n                  </Tooltip>\n                </TooltipProvider>\n              </div>\n              <Input\n                id=\"tolerance-time\"\n                type=\"number\"\n                min=\"0\"\n                step=\"5\"\n                value={formData.tolerance_time}\n                onChange={(e) => handleChange('tolerance_time', parseInt(e.target.value))}\n                placeholder={txtNoTolerance}\n              />\n            </div>\n          </div>\n\n          <div className=\"grid md:grid-cols-2 gap-6\">\n            <div>\n              <Label htmlFor=\"max-capacity\">{txtMaxCapacity} *</Label>\n              <Input\n                id=\"max-capacity\"\n                type=\"number\"\n                min=\"1\"\n                value={formData.max_capacity}\n                onChange={(e) => handleChange('max_capacity', parseInt(e.target.value))}\n              />\n            </div>\n          </div>\n        </TabsContent>\n\n        <TabsContent value=\"schedule\" className=\"mt-6\">\n          <QueueSchedule \n            queue={queue || { working_hours: formData.working_hours }} \n            onChange={!queue ? (schedule) => handleChange('working_hours', schedule) : undefined}\n            onSaveComplete={queue ? (schedule) => handleChange('working_hours', schedule) : undefined}\n          />\n        </TabsContent>\n      </Tabs>\n\n      <div className=\"flex gap-3 pt-4 border-t\">\n        <Button\n          type=\"button\"\n          variant=\"outline\"\n          onClick={onClose}\n          className=\"flex-1\"\n        >\n          {txtCancel}\n        </Button>\n        <Button\n          type=\"submit\"\n          disabled={saveMutation.isPending}\n          className=\"flex-1 gap-2 bg-gradient-to-r from-sky-500 to-blue-600 hover:from-sky-600 hover:to-blue-700\"\n        >\n          <Save className=\"w-4 h-4\" />\n          {txtSave}\n        </Button>\n      </div>\n    </form>\n  );\n}","path":null,"size_bytes":9298,"size_tokens":null},"src/components/ui/avatar.jsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as AvatarPrimitive from \"@radix-ui/react-avatar\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Avatar = React.forwardRef(({ className, ...props }, ref) => (\n  <AvatarPrimitive.Root\n    ref={ref}\n    className={cn(\"relative flex h-10 w-10 shrink-0 overflow-hidden rounded-full\", className)}\n    {...props} />\n))\nAvatar.displayName = AvatarPrimitive.Root.displayName\n\nconst AvatarImage = React.forwardRef(({ className, ...props }, ref) => (\n  <AvatarPrimitive.Image\n    ref={ref}\n    className={cn(\"aspect-square h-full w-full\", className)}\n    {...props} />\n))\nAvatarImage.displayName = AvatarPrimitive.Image.displayName\n\nconst AvatarFallback = React.forwardRef(({ className, ...props }, ref) => (\n  <AvatarPrimitive.Fallback\n    ref={ref}\n    className={cn(\n      \"flex h-full w-full items-center justify-center rounded-full bg-muted\",\n      className\n    )}\n    {...props} />\n))\nAvatarFallback.displayName = AvatarPrimitive.Fallback.displayName\n\nexport { Avatar, AvatarImage, AvatarFallback }\n","path":null,"size_bytes":1043,"size_tokens":null},"src/components/ui/card.jsx":{"content":"import * as React from \"react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Card = React.forwardRef(({ className, hover, ...props }, ref) => (\n  <div\n    ref={ref}\n    className={cn(\n      \"rounded-xl border bg-card text-card-foreground shadow-sm transition-all duration-300\",\n      hover && \"hover:shadow-lg hover:-translate-y-1 cursor-pointer\",\n      className\n    )}\n    {...props} />\n))\nCard.displayName = \"Card\"\n\nconst CardHeader = React.forwardRef(({ className, ...props }, ref) => (\n  <div\n    ref={ref}\n    className={cn(\"flex flex-col space-y-1.5 p-6\", className)}\n    {...props} />\n))\nCardHeader.displayName = \"CardHeader\"\n\nconst CardTitle = React.forwardRef(({ className, ...props }, ref) => (\n  <div\n    ref={ref}\n    className={cn(\"font-semibold leading-none tracking-tight\", className)}\n    {...props} />\n))\nCardTitle.displayName = \"CardTitle\"\n\nconst CardDescription = React.forwardRef(({ className, ...props }, ref) => (\n  <div\n    ref={ref}\n    className={cn(\"text-sm text-muted-foreground\", className)}\n    {...props} />\n))\nCardDescription.displayName = \"CardDescription\"\n\nconst CardContent = React.forwardRef(({ className, ...props }, ref) => (\n  <div ref={ref} className={cn(\"p-6 pt-0\", className)} {...props} />\n))\nCardContent.displayName = \"CardContent\"\n\nconst CardFooter = React.forwardRef(({ className, ...props }, ref) => (\n  <div\n    ref={ref}\n    className={cn(\"flex items-center p-6 pt-0\", className)}\n    {...props} />\n))\nCardFooter.displayName = \"CardFooter\"\n\nexport { Card, CardHeader, CardFooter, CardTitle, CardDescription, CardContent }\n","path":null,"size_bytes":1566,"size_tokens":null},"src/components/ui/separator.jsx":{"content":"import * as React from \"react\"\nimport * as SeparatorPrimitive from \"@radix-ui/react-separator\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Separator = React.forwardRef((\n  { className, orientation = \"horizontal\", decorative = true, ...props },\n  ref\n) => (\n  <SeparatorPrimitive.Root\n    ref={ref}\n    decorative={decorative}\n    orientation={orientation}\n    className={cn(\n      \"shrink-0 bg-border\",\n      orientation === \"horizontal\" ? \"h-[1px] w-full\" : \"h-full w-[1px]\",\n      className\n    )}\n    {...props} />\n))\nSeparator.displayName = SeparatorPrimitive.Root.displayName\n\nexport { Separator }\n","path":null,"size_bytes":600,"size_tokens":null},"src/pages/MyTickets.jsx":{"content":"import React, { useState, useEffect } from \"react\";\nimport { base44 } from \"@/api/base44Client\";\nimport { useQuery, useMutation, useQueryClient } from \"@tanstack/react-query\";\nimport { Card, CardContent } from \"@/components/ui/card\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Tabs, TabsList, TabsTrigger, TabsContent } from \"@/components/ui/tabs\";\nimport { Link } from \"react-router-dom\";\nimport { createPageUrl } from \"@/utils\";\nimport { Clock, CheckCircle2, XCircle, AlertCircle, Ticket as TicketIcon } from \"lucide-react\";\nimport { Skeleton } from \"@/components/ui/skeleton\";\nimport { useAutoTranslate } from \"@/hooks/useTranslate\";\n\nconst statusConfig = {\n  aguardando: { \n    icon: Clock, \n    color: \"bg-blue-100 text-blue-700 border-blue-200\",\n    label: \"Aguardando\"\n  },\n  chamado: { \n    icon: AlertCircle, \n    color: \"bg-amber-100 text-amber-700 border-amber-200\",\n    label: \"Chamado\"\n  },\n  atendendo: { \n    icon: Clock, \n    color: \"bg-purple-100 text-purple-700 border-purple-200\",\n    label: \"Atendendo\"\n  },\n  concluido: { \n    icon: CheckCircle2, \n    color: \"bg-green-100 text-green-700 border-green-200\",\n    label: \"Concluído\"\n  },\n  cancelado: { \n    icon: XCircle, \n    color: \"bg-red-100 text-red-700 border-red-200\",\n    label: \"Cancelado\"\n  }\n};\n\nexport default function MyTicketsPage() {\n  const [user, setUser] = useState(null);\n  const [activeTab, setActiveTab] = useState(\"ativas\");\n  const queryClient = useQueryClient();\n\n  const txtWaiting = useAutoTranslate('Aguardando', 'pt');\n  const txtCalled = useAutoTranslate('Chamado', 'pt');\n  const txtServing = useAutoTranslate('Atendendo', 'pt');\n  const txtCompleted = useAutoTranslate('Concluído', 'pt');\n  const txtCancelled = useAutoTranslate('Cancelado', 'pt');\n  const txtCompany = useAutoTranslate('Empresa', 'pt');\n  const txtQueue = useAutoTranslate('Fila', 'pt');\n  const txtTicket = useAutoTranslate('Senha', 'pt');\n  const txtPosition = useAutoTranslate('Posição', 'pt');\n  const txtEstimatedTime = useAutoTranslate('Tempo Estimado', 'pt');\n  const txtMin = useAutoTranslate('min', 'pt');\n  const txtActiveTickets = useAutoTranslate('Senhas Ativas', 'pt');\n  const txtTicketHistory = useAutoTranslate('Histórico', 'pt');\n  const txtNoActiveTickets = useAutoTranslate('Não tens senhas ativas no momento.', 'pt');\n  const txtNoHistoricTickets = useAutoTranslate('Sem histórico de senhas.', 'pt');\n  const txtExploreBusinesses = useAutoTranslate('Explorar Empresas', 'pt');\n  const txtMyTickets = useAutoTranslate('Minhas Senhas', 'pt');\n  const txtTrackRealtime = useAutoTranslate('Acompanhe todas as suas senhas em tempo real', 'pt');\n  const txtActive = useAutoTranslate('Ativas', 'pt');\n  const txtNoActiveTicketsTitle = useAutoTranslate('Nenhuma senha ativa', 'pt');\n  const txtNoActiveTicketsDesc = useAutoTranslate('Você não possui senhas aguardando atendimento', 'pt');\n  const txtNoHistoricTitle = useAutoTranslate('Sem histórico', 'pt');\n  const txtNoHistoricDesc = useAutoTranslate('Você ainda não possui histórico de senhas', 'pt');\n  const txtCreatedAt = useAutoTranslate('Criado em', 'pt');\n  const txtAt = useAutoTranslate('às', 'pt');\n\n  useEffect(() => {\n    base44.auth.me().then(setUser).catch(() => base44.auth.redirectToLogin());\n  }, []);\n\n  const { data: tickets, isLoading } = useQuery({\n    queryKey: ['my-tickets', user?.email],\n    queryFn: () => user ? base44.entities.Ticket.filter({ user_email: user.email }, '-created_date') : [],\n    enabled: !!user,\n    initialData: [],\n    refetchInterval: 5000,\n  });\n\n  const { data: businesses } = useQuery({\n    queryKey: ['businesses-for-tickets'],\n    queryFn: () => base44.entities.Business.list(),\n    initialData: [],\n  });\n\n  const { data: queues } = useQuery({\n    queryKey: ['queues-for-tickets'],\n    queryFn: () => base44.entities.Queue.filter({}),\n    initialData: [],\n  });\n\n  const expireTicketsMutation = useMutation({\n    mutationFn: async (ticketIds) => {\n      for (const ticketId of ticketIds) {\n        await base44.entities.Ticket.update(ticketId, {\n          status: 'cancelado',\n          completed_at: new Date().toISOString()\n        });\n      }\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['my-tickets'] });\n    }\n  });\n\n  useEffect(() => {\n    if (!tickets.length || !queues.length) return;\n\n    const checkExpiredTickets = async () => {\n      const now = new Date();\n      const expiredTicketIds = [];\n\n      for (const ticket of tickets) {\n        if (!['aguardando', 'chamado'].includes(ticket.status)) continue;\n\n        const queue = queues.find(q => q.id === ticket.queue_id);\n        if (!queue) continue;\n\n        if (ticket.status === 'chamado' && ticket.called_at) {\n          const calledAt = new Date(ticket.called_at);\n          const toleranceMs = (queue.tolerance_time || 15) * 60 * 1000;\n          if (now - calledAt > toleranceMs) {\n            expiredTicketIds.push(ticket.id);\n          }\n        }\n\n        if (ticket.status === 'aguardando') {\n          const currentNumber = queue.current_number;\n          if (ticket.ticket_number < currentNumber) {\n            expiredTicketIds.push(ticket.id);\n          }\n        }\n      }\n\n      if (expiredTicketIds.length > 0) {\n        expireTicketsMutation.mutate(expiredTicketIds);\n      }\n    };\n\n    checkExpiredTickets();\n    const interval = setInterval(checkExpiredTickets, 5000);\n\n    return () => clearInterval(interval);\n  }, [tickets, queues, expireTicketsMutation]);\n\n  const activeTickets = tickets.filter(t => ['aguardando', 'chamado', 'atendendo'].includes(t.status));\n  const historicTickets = tickets.filter(t => ['concluido', 'cancelado'].includes(t.status));\n\n  const getBusinessName = (businessId) => {\n    if (!businessId) return txtCompany;\n    const business = businesses.find(b => b.id === businessId || String(b.id) === String(businessId));\n    return business?.name || txtCompany;\n  };\n\n  const getQueueName = (queueId) => {\n    if (!queueId) return txtQueue;\n    const queue = queues.find(q => q.id === queueId || String(q.id) === String(queueId));\n    return queue?.name || txtQueue;\n  };\n\n  const TicketCard = ({ ticket }) => {\n    const [now, setNow] = useState(new Date());\n    const status = statusConfig[ticket.status];\n    const StatusIcon = status.icon;\n    const queue = queues.find(q => q.id === ticket.queue_id);\n    const position = queue ? (ticket.ticket_number - queue.current_number) : 0;\n    \n    const elapsedMinutes = Math.floor((now - new Date(ticket.created_date)) / (1000 * 60));\n    const baseEstimatedTime = queue ? (position * queue.average_service_time) : 0;\n    const estimatedTime = Math.max(0, baseEstimatedTime - elapsedMinutes);\n\n    useEffect(() => {\n      const interval = setInterval(() => {\n        setNow(new Date());\n      }, 60000);\n      return () => clearInterval(interval);\n    }, []);\n\n    return (\n      <Link to={createPageUrl(`TicketView?id=${ticket.id}`)}>\n        <Card className=\"hover:shadow-xl transition-all duration-300 border-0 cursor-pointer\">\n          <CardContent className=\"p-4 sm:p-6\">\n            <div className=\"flex justify-between items-start mb-3 sm:mb-4 gap-2\">\n              <div className=\"min-w-0 flex-1\">\n                <h3 className=\"font-bold text-xl sm:text-2xl text-slate-900 mb-1\">\n                  {txtTicket} #{ticket.ticket_number}\n                </h3>\n                <p className=\"text-sm sm:text-base text-slate-600 font-medium truncate\">{getBusinessName(ticket.business_id)}</p>\n                <p className=\"text-xs sm:text-sm text-slate-500 truncate\">{getQueueName(ticket.queue_id)}</p>\n              </div>\n              <Badge className={`${status.color} text-xs sm:text-sm flex-shrink-0`}>\n                <StatusIcon className=\"w-3 h-3 mr-1\" />\n                {ticket.status === 'aguardando' && txtWaiting}\n                {ticket.status === 'chamado' && txtCalled}\n                {ticket.status === 'atendendo' && txtServing}\n                {ticket.status === 'concluido' && txtCompleted}\n                {ticket.status === 'cancelado' && txtCancelled}\n              </Badge>\n            </div>\n\n            {ticket.status === 'aguardando' && (\n              <div className=\"grid grid-cols-2 gap-3 sm:gap-4 mb-3 sm:mb-4\">\n                <div className=\"p-2.5 sm:p-3 bg-blue-50 rounded-lg\">\n                  <div className=\"text-xs text-slate-600 mb-1\">{txtPosition}</div>\n                  <div className=\"text-xl sm:text-2xl font-bold text-blue-600\">#{position > 0 ? position : '...'}</div>\n                </div>\n                <div className=\"p-2.5 sm:p-3 bg-purple-50 rounded-lg\">\n                  <div className=\"text-xs text-slate-600 mb-1\">{txtEstimatedTime}</div>\n                  <div className=\"text-xl sm:text-2xl font-bold text-purple-600\">~{estimatedTime > 0 ? estimatedTime : '...'}{txtMin}</div>\n                </div>\n              </div>\n            )}\n\n            <div className=\"text-xs text-slate-500\">\n              {txtCreatedAt} {new Date(ticket.created_date).toLocaleDateString('pt-PT')} {txtAt} {new Date(ticket.created_date).toLocaleTimeString('pt-PT', { hour: '2-digit', minute: '2-digit' })}\n            </div>\n          </CardContent>\n        </Card>\n      </Link>\n    );\n  };\n\n  if (!user) {\n    return (\n      <div className=\"bg-gradient-to-br from-slate-50 via-blue-50 to-sky-50 flex items-center justify-center px-4 sm:px-6 py-8\">\n        <Card className=\"p-6 sm:p-8 text-center\">\n          <Skeleton className=\"h-10 sm:h-12 w-40 sm:w-48 mx-auto mb-4\" />\n          <Skeleton className=\"h-4 w-56 sm:w-64 mx-auto\" />\n        </Card>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"bg-gradient-to-br from-slate-50 via-blue-50 to-sky-50\">\n      <div className=\"max-w-6xl mx-auto px-4 sm:px-6 py-4 sm:py-6\">\n        <div className=\"mb-6 sm:mb-8\">\n          <h1 className=\"text-3xl sm:text-4xl md:text-5xl font-bold text-slate-900 mb-2 sm:mb-3\">\n            {txtMyTickets}\n          </h1>\n          <p className=\"text-base sm:text-lg md:text-xl text-slate-600\">\n            {txtTrackRealtime}\n          </p>\n        </div>\n\n        <Tabs value={activeTab} onValueChange={setActiveTab} className=\"mb-6\">\n          <TabsList className=\"bg-white border border-slate-200 p-1\">\n            <TabsTrigger \n              value=\"ativas\"\n              className=\"data-[state=active]:bg-gradient-to-r data-[state=active]:from-sky-500 data-[state=active]:to-blue-600 data-[state=active]:text-white\"\n            >\n              <Clock className=\"w-4 h-4 mr-2\" />\n              {txtActive} ({activeTickets.length})\n            </TabsTrigger>\n            <TabsTrigger \n              value=\"historico\"\n              className=\"data-[state=active]:bg-gradient-to-r data-[state=active]:from-sky-500 data-[state=active]:to-blue-600 data-[state=active]:text-white\"\n            >\n              <TicketIcon className=\"w-4 h-4 mr-2\" />\n              {txtTicketHistory} ({historicTickets.length})\n            </TabsTrigger>\n          </TabsList>\n\n          <TabsContent value=\"ativas\" className=\"mt-4 sm:mt-6\">\n            {isLoading ? (\n              <div className=\"grid grid-cols-1 sm:grid-cols-2 gap-4 sm:gap-6\">\n                {[1, 2].map(i => (\n                  <Skeleton key={i} className=\"h-44 sm:h-48 w-full rounded-xl\" />\n                ))}\n              </div>\n            ) : activeTickets.length === 0 ? (\n              <Card className=\"border-0 shadow-lg\">\n                <CardContent className=\"py-12 sm:py-16 text-center px-4 sm:px-6\">\n                  <div className=\"text-5xl sm:text-6xl mb-4\">🎫</div>\n                  <h3 className=\"text-xl sm:text-2xl font-bold text-slate-900 mb-2\">{txtNoActiveTicketsTitle}</h3>\n                  <p className=\"text-sm sm:text-base text-slate-600 mb-6\">{txtNoActiveTicketsDesc}</p>\n                  <Link to={createPageUrl(\"Businesses\")}>\n                    <button className=\"px-5 sm:px-6 py-3 bg-gradient-to-r from-sky-500 to-blue-600 text-white rounded-xl hover:from-sky-600 hover:to-blue-700 min-h-[44px] text-sm sm:text-base\">\n                      {txtExploreBusinesses}\n                    </button>\n                  </Link>\n                </CardContent>\n              </Card>\n            ) : (\n              <div className=\"grid grid-cols-1 sm:grid-cols-2 gap-4 sm:gap-6\">\n                {activeTickets.map(ticket => (\n                  <TicketCard key={ticket.id} ticket={ticket} />\n                ))}\n              </div>\n            )}\n          </TabsContent>\n\n          <TabsContent value=\"historico\" className=\"mt-4 sm:mt-6\">\n            {isLoading ? (\n              <div className=\"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 sm:gap-6\">\n                {[1, 2, 3, 4, 5, 6].map(i => (\n                  <Skeleton key={i} className=\"h-36 sm:h-40 w-full rounded-xl\" />\n                ))}\n              </div>\n            ) : historicTickets.length === 0 ? (\n              <Card className=\"border-0 shadow-lg\">\n                <CardContent className=\"py-12 sm:py-16 text-center px-4 sm:px-6\">\n                  <div className=\"text-5xl sm:text-6xl mb-4\">📋</div>\n                  <h3 className=\"text-xl sm:text-2xl font-bold text-slate-900 mb-2\">{txtNoHistoricTitle}</h3>\n                  <p className=\"text-sm sm:text-base text-slate-600\">{txtNoHistoricDesc}</p>\n                </CardContent>\n              </Card>\n            ) : (\n              <div className=\"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 sm:gap-6\">\n                {historicTickets.map(ticket => (\n                  <TicketCard key={ticket.id} ticket={ticket} />\n                ))}\n              </div>\n            )}\n          </TabsContent>\n        </Tabs>\n      </div>\n    </div>\n  );\n}","path":null,"size_bytes":13715,"size_tokens":null},"src/components/business/CalendarSync.jsx":{"content":"import React from \"react\";\nimport { base44 } from \"@/api/base44Client\";\nimport { useMutation, useQueryClient } from \"@tanstack/react-query\";\nimport { Button } from \"@/components/ui/button\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Calendar, CheckCircle2, Link as LinkIcon } from \"lucide-react\";\nimport { toast } from \"sonner\";\nimport { useAutoTranslate } from \"@/hooks/useTranslate\";\n\nexport default function CalendarSync({ business }) {\n  const queryClient = useQueryClient();\n  \n  const txtCalendarSync = useAutoTranslate('Sincronização de Calendário', 'pt');\n  const txtConnected = useAutoTranslate('Conectado', 'pt');\n  const txtNotConnected = useAutoTranslate('Não conectado', 'pt');\n  const txtActive = useAutoTranslate('Ativo', 'pt');\n  const txtInactive = useAutoTranslate('Inativo', 'pt');\n  const txtAutoSync = useAutoTranslate('Sincronização automática de marcações', 'pt');\n  const txtAvoidDoubleBooking = useAutoTranslate('Evite double-booking entre plataformas', 'pt');\n  const txtRealTimeUpdates = useAutoTranslate('Atualizações em tempo real', 'pt');\n  const txtDisconnect = useAutoTranslate('Desconectar Google Calendar', 'pt');\n  const txtConnect = useAutoTranslate('Conectar Google Calendar', 'pt');\n  const txtConnectedSuccess = useAutoTranslate('Calendário Google conectado com sucesso!', 'pt');\n  const txtDisconnectedSuccess = useAutoTranslate('Calendário Google desconectado', 'pt');\n\n  const connectMutation = useMutation({\n    mutationFn: async () => {\n      await base44.entities.Business.update(business.id, {\n        google_calendar_connected: true,\n        google_calendar_id: 'primary'\n      });\n      return true;\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['business'] });\n      toast.success(txtConnectedSuccess);\n    },\n  });\n\n  const disconnectMutation = useMutation({\n    mutationFn: async () => {\n      await base44.entities.Business.update(business.id, {\n        google_calendar_connected: false,\n        google_calendar_id: null\n      });\n      return true;\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['business'] });\n      toast.success(txtDisconnectedSuccess);\n    },\n  });\n\n  return (\n    <Card className=\"border-0 shadow-lg\">\n      <CardHeader>\n        <CardTitle className=\"flex items-center gap-2\">\n          <Calendar className=\"w-5 h-5\" />\n          {txtCalendarSync}\n        </CardTitle>\n      </CardHeader>\n      <CardContent className=\"space-y-4\">\n        <div className=\"flex items-center justify-between p-4 bg-slate-50 rounded-lg\">\n          <div className=\"flex items-center gap-3\">\n            <div className=\"w-10 h-10 rounded-lg bg-white flex items-center justify-center border\">\n              <Calendar className=\"w-5 h-5 text-blue-600\" />\n            </div>\n            <div>\n              <h4 className=\"font-semibold text-slate-900\">Google Calendar</h4>\n              <p className=\"text-sm text-slate-600\">\n                {business.google_calendar_connected ? txtConnected : txtNotConnected}\n              </p>\n            </div>\n          </div>\n          {business.google_calendar_connected ? (\n            <Badge className=\"bg-green-100 text-green-700 border-green-200\">\n              <CheckCircle2 className=\"w-3 h-3 mr-1\" />\n              {txtActive}\n            </Badge>\n          ) : (\n            <Badge variant=\"outline\">{txtInactive}</Badge>\n          )}\n        </div>\n\n        <div className=\"space-y-2 text-sm text-slate-600\">\n          <p className=\"flex items-start gap-2\">\n            <CheckCircle2 className=\"w-4 h-4 text-green-600 mt-0.5 flex-shrink-0\" />\n            {txtAutoSync}\n          </p>\n          <p className=\"flex items-start gap-2\">\n            <CheckCircle2 className=\"w-4 h-4 text-green-600 mt-0.5 flex-shrink-0\" />\n            {txtAvoidDoubleBooking}\n          </p>\n          <p className=\"flex items-start gap-2\">\n            <CheckCircle2 className=\"w-4 h-4 text-green-600 mt-0.5 flex-shrink-0\" />\n            {txtRealTimeUpdates}\n          </p>\n        </div>\n\n        {business.google_calendar_connected ? (\n          <Button\n            onClick={() => disconnectMutation.mutate()}\n            disabled={disconnectMutation.isPending}\n            variant=\"outline\"\n            className=\"w-full\"\n          >\n            {txtDisconnect}\n          </Button>\n        ) : (\n          <Button\n            onClick={() => connectMutation.mutate()}\n            disabled={connectMutation.isPending}\n            className=\"w-full bg-gradient-to-r from-blue-600 to-indigo-600 hover:from-blue-700 hover:to-indigo-700\"\n          >\n            <LinkIcon className=\"w-4 h-4 mr-2\" />\n            {txtConnect}\n          </Button>\n        )}\n      </CardContent>\n    </Card>\n  );\n}","path":null,"size_bytes":4842,"size_tokens":null},"src/components/ui/sheet.jsx":{"content":"\"use client\";\nimport * as React from \"react\"\nimport * as SheetPrimitive from \"@radix-ui/react-dialog\"\nimport { cva } from \"class-variance-authority\";\nimport { X } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Sheet = SheetPrimitive.Root\n\nconst SheetTrigger = SheetPrimitive.Trigger\n\nconst SheetClose = SheetPrimitive.Close\n\nconst SheetPortal = SheetPrimitive.Portal\n\nconst SheetOverlay = React.forwardRef(({ className, ...props }, ref) => (\n  <SheetPrimitive.Overlay\n    className={cn(\n      \"fixed inset-0 z-50 bg-black/80  data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0\",\n      className\n    )}\n    {...props}\n    ref={ref} />\n))\nSheetOverlay.displayName = SheetPrimitive.Overlay.displayName\n\nconst sheetVariants = cva(\n  \"fixed z-50 gap-4 bg-background p-6 shadow-lg transition ease-in-out data-[state=closed]:duration-300 data-[state=open]:duration-500 data-[state=open]:animate-in data-[state=closed]:animate-out\",\n  {\n    variants: {\n      side: {\n        top: \"inset-x-0 top-0 border-b data-[state=closed]:slide-out-to-top data-[state=open]:slide-in-from-top\",\n        bottom:\n          \"inset-x-0 bottom-0 border-t data-[state=closed]:slide-out-to-bottom data-[state=open]:slide-in-from-bottom\",\n        left: \"inset-y-0 left-0 h-full w-3/4 border-r data-[state=closed]:slide-out-to-left data-[state=open]:slide-in-from-left sm:max-w-sm\",\n        right:\n          \"inset-y-0 right-0 h-full w-3/4 border-l data-[state=closed]:slide-out-to-right data-[state=open]:slide-in-from-right sm:max-w-sm\",\n      },\n    },\n    defaultVariants: {\n      side: \"right\",\n    },\n  }\n)\n\nconst SheetContent = React.forwardRef(({ side = \"right\", className, children, ...props }, ref) => (\n  <SheetPortal>\n    <SheetOverlay />\n    <SheetPrimitive.Content ref={ref} className={cn(sheetVariants({ side }), className)} {...props}>\n      <SheetPrimitive.Close\n        className=\"absolute right-4 top-4 rounded-sm opacity-70 ring-offset-background transition-opacity hover:opacity-100 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:pointer-events-none data-[state=open]:bg-secondary\">\n        <X className=\"h-4 w-4\" />\n        <span className=\"sr-only\">Close</span>\n      </SheetPrimitive.Close>\n      {children}\n    </SheetPrimitive.Content>\n  </SheetPortal>\n))\nSheetContent.displayName = SheetPrimitive.Content.displayName\n\nconst SheetHeader = ({\n  className,\n  ...props\n}) => (\n  <div\n    className={cn(\"flex flex-col space-y-2 text-center sm:text-left\", className)}\n    {...props} />\n)\nSheetHeader.displayName = \"SheetHeader\"\n\nconst SheetFooter = ({\n  className,\n  ...props\n}) => (\n  <div\n    className={cn(\"flex flex-col-reverse sm:flex-row sm:justify-end sm:space-x-2\", className)}\n    {...props} />\n)\nSheetFooter.displayName = \"SheetFooter\"\n\nconst SheetTitle = React.forwardRef(({ className, ...props }, ref) => (\n  <SheetPrimitive.Title\n    ref={ref}\n    className={cn(\"text-lg font-semibold text-foreground\", className)}\n    {...props} />\n))\nSheetTitle.displayName = SheetPrimitive.Title.displayName\n\nconst SheetDescription = React.forwardRef(({ className, ...props }, ref) => (\n  <SheetPrimitive.Description\n    ref={ref}\n    className={cn(\"text-sm text-muted-foreground\", className)}\n    {...props} />\n))\nSheetDescription.displayName = SheetPrimitive.Description.displayName\n\nexport {\n  Sheet,\n  SheetPortal,\n  SheetOverlay,\n  SheetTrigger,\n  SheetClose,\n  SheetContent,\n  SheetHeader,\n  SheetFooter,\n  SheetTitle,\n  SheetDescription,\n}\n","path":null,"size_bytes":3549,"size_tokens":null},"src/pages/Businesses.jsx":{"content":"import React, { useState, useMemo, useEffect } from \"react\";\nimport { base44 } from \"@/api/base44Client\";\nimport { safeFetch, getUploadUrl } from \"@/utils/apiConfig\";\nimport { useAutoTranslate } from \"@/hooks/useTranslate\";\nimport { useQuery } from \"@tanstack/react-query\";\nimport { useNavigate } from \"react-router-dom\";\nimport { createPageUrl } from \"@/utils\";\nimport { Button } from \"@/components/ui/button\";\nimport { Card, CardContent } from \"@/components/ui/card\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Input } from \"@/components/ui/input\";\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\nimport { Alert, AlertDescription } from \"@/components/ui/alert\";\nimport { \n  Search, \n  MapPin, \n  Star, \n  Sparkles,\n  Navigation,\n  AlertCircle\n} from \"lucide-react\";\nimport { Skeleton } from \"@/components/ui/skeleton\";\nimport { calculateDistance, useUserLocation } from \"@/components/shared/LocationService\";\n\n// Categories will be translated dynamically in the component\n\nconst categoryColors = {\n  saude: 'from-red-500 to-pink-500',\n  financeiro: 'from-blue-500 to-cyan-500',\n  governo: 'from-purple-500 to-indigo-500',\n  restauracao: 'from-orange-500 to-amber-500',\n  beleza: 'from-pink-500 to-rose-500',\n  outros: 'from-slate-500 to-gray-500'\n};\n\n// Categories helper moved to component\n\nexport default function BusinessesPage() {\n  const navigate = useNavigate();\n  const [searchTerm, setSearchTerm] = useState(\"\");\n  const [selectedCategory, setSelectedCategory] = useState(\"todos\");\n  const [user, setUser] = useState(null);\n  const { location: gpsLocation, country: gpsCountry, loading: loadingLocation, error: locationError, refetch: refetchLocation } = useUserLocation();\n\n  const txtFindBusinesses = useAutoTranslate('Encontre Empresas', 'pt');\n  const txtSearchBusinesses = useAutoTranslate('Pesquisar empresas...', 'pt');\n  const txtAllCategories = useAutoTranslate('Todas as Categorias', 'pt');\n  const txtBusinessFound = useAutoTranslate('empresa encontrada', 'pt');\n  const txtBusinessesFound = useAutoTranslate('empresas encontradas', 'pt');\n  const txtNearYou = useAutoTranslate('perto de si', 'pt');\n  const txtBusinessesNearYou = useAutoTranslate('Empresas perto de si', 'pt');\n  const txtClosest = useAutoTranslate('mais próximas', 'pt');\n  const txtNoBusinesses = useAutoTranslate('Nenhuma empresa encontrada', 'pt');\n  const txtTryDifferentSearch = useAutoTranslate('Tente ajustar sua pesquisa ou categoria', 'pt');\n  const txtLoading = useAutoTranslate('A carregar...', 'pt');\n  const txtSeeDetails = useAutoTranslate('Ver Detalhes', 'pt');\n  const txtOpenNow = useAutoTranslate('Aberto Agora', 'pt');\n  const txtClosed = useAutoTranslate('Fechado', 'pt');\n  const txtLocationError = useAutoTranslate('Erro ao obter localização', 'pt');\n  const txtEnableLocation = useAutoTranslate('Ative a localização para ver empresas próximas', 'pt');\n  const txtTryAgain = useAutoTranslate('Tentar Novamente', 'pt');\n  const txtNoName = useAutoTranslate('Empresa sem nome', 'pt');\n  const txtNoCountry = useAutoTranslate('Não há empresas disponíveis no seu país com os filtros selecionados', 'pt');\n  const txtConfigureCountry = useAutoTranslate('Configure o seu país no perfil para ver empresas próximas', 'pt');\n  \n  // Categories translations\n  const txtAll = useAutoTranslate('Todas', 'pt');\n  const txtHealth = useAutoTranslate('Saúde', 'pt');\n  const txtFinancial = useAutoTranslate('Financeiro', 'pt');\n  const txtGovernment = useAutoTranslate('Governo', 'pt');\n  const txtRestaurant = useAutoTranslate('Restauração', 'pt');\n  const txtBeauty = useAutoTranslate('Beleza', 'pt');\n  const txtOthers = useAutoTranslate('Outros', 'pt');\n  \n  // Location/GPS translations\n  const txtGettingLocation = useAutoTranslate('A obter a sua localização...', 'pt');\n  const txtLocationActiveIn = useAutoTranslate('Localização ativa em', 'pt');\n  const txtShowingNearby = useAutoTranslate('- a mostrar empresas próximas', 'pt');\n  const txtAllowLocation = useAutoTranslate('Permita o acesso à localização para ver empresas próximas no seu país', 'pt');\n  const txtEnableLocationBtn = useAutoTranslate('Ativar Localização', 'pt');\n  const txtEnableLocationDesc = useAutoTranslate('Ative a localização para ver empresas do seu país ordenadas por proximidade', 'pt');\n  \n  // Action buttons\n  const txtTakeTicket = useAutoTranslate('Tirar Senha', 'pt');\n  const txtMakeAppointment = useAutoTranslate('Fazer Marcação', 'pt');\n  const txtViewBusiness = useAutoTranslate('Ver Empresa', 'pt');\n\n  const categories = [\n    { value: 'todos', label: txtAll, icon: '📍' },\n    { value: 'saude', label: txtHealth, icon: '🏥' },\n    { value: 'financeiro', label: txtFinancial, icon: '🏦' },\n    { value: 'governo', label: txtGovernment, icon: '🏛️' },\n    { value: 'restauracao', label: txtRestaurant, icon: '🍽️' },\n    { value: 'beleza', label: txtBeauty, icon: '💇' },\n    { value: 'outros', label: txtOthers, icon: '📍' }\n  ];\n\n  const getCategoryDisplay = (business) => {\n    if (business.category === 'outros' && business.custom_category) {\n      return business.custom_category;\n    }\n    const category = categories.find(c => c.value === business.category);\n    return category ? category.label : business.category || txtOthers;\n  };\n\n  useEffect(() => {\n    base44.auth.me().then(setUser).catch(() => {});\n  }, []);\n\n  const { data: businesses = [], isLoading: businessesLoading } = useQuery({\n    queryKey: ['active-businesses'],\n    queryFn: async () => {\n      // 🔄 FORÇAR API em vez de localStorage\n      const { response, data } = await safeFetch('/api/public/businesses', {\n        method: 'GET',\n      });\n      \n      if (!response.ok) {\n        console.error('❌ Erro ao buscar empresas da API');\n        return [];\n      }\n      \n      console.log(`✅ ${data?.length || 0} empresas carregadas da API (PostgreSQL)`);\n      return data || [];\n    },\n    initialData: [],\n  });\n\n  const { data: queues = [] } = useQuery({\n    queryKey: ['all-queues'],\n    queryFn: () => base44.entities.Queue.list(),\n    initialData: [],\n  });\n\n  const { data: services = [] } = useQuery({\n    queryKey: ['all-services'],\n    queryFn: () => base44.entities.Service.list(),\n    initialData: [],\n  });\n\n  // Usar país da geolocalização GPS\n  const userCountry = gpsCountry?.code;\n\n  const filteredBusinesses = useMemo(() => {\n    if (!businesses.length) return [];\n\n    let filtered = businesses;\n\n    // ✅ FILTRO OBRIGATÓRIO: Só mostrar empresas do país do utilizador\n    // Se não tiver país detectado via GPS, não mostrar nenhuma empresa\n    if (userCountry) {\n      filtered = filtered.filter(business => {\n        if (!business) return false;\n        const businessCountry = business.country?.toUpperCase();\n        const userCountryUpper = userCountry.toUpperCase();\n        return businessCountry === userCountryUpper;\n      });\n    } else {\n      // Sem GPS/país detectado = não mostrar empresas (forçar activar localização)\n      filtered = [];\n    }\n\n    // Filtrar por categoria (inclui categorias customizadas quando \"outros\" selecionado)\n    if (selectedCategory !== 'todos') {\n      filtered = filtered.filter(b => {\n        // ✅ PROTEÇÃO: Verificar se b existe\n        if (!b) return false;\n        // Categoria padrão corresponde exatamente\n        if (b.category === selectedCategory) return true;\n        \n        // Quando filtro é \"outros\", incluir todas as empresas com custom_category\n        if (selectedCategory === 'outros' && b.custom_category) return true;\n        \n        return false;\n      });\n    }\n\n    // Filtrar por termo de pesquisa (inclui categoria customizada)\n    if (searchTerm) {\n      filtered = filtered.filter(b =>\n        b && ( // ✅ PROTEÇÃO: Verificar se b existe\n          b.name?.toLowerCase().includes(searchTerm.toLowerCase()) ||\n          b.description?.toLowerCase().includes(searchTerm.toLowerCase()) ||\n          b.custom_category?.toLowerCase().includes(searchTerm.toLowerCase())\n        )\n      );\n    }\n\n    // Ordenar por distância usando geolocalização GPS\n    filtered = filtered.map(business => {\n      let distance = null;\n      \n      // Calcular distância usando GPS em tempo real\n      if (business.latitude && business.longitude && gpsLocation?.lat && gpsLocation?.lng) {\n        distance = calculateDistance(gpsLocation.lat, gpsLocation.lng, business.latitude, business.longitude);\n      }\n      \n      return { ...business, distance };\n    }).sort((a, b) => {\n      // Empresas sem coordenadas vão para o fim\n      if (a.distance === null) return 1;\n      if (b.distance === null) return -1;\n      // Ordenar da mais próxima para a mais longe\n      return a.distance - b.distance;\n    });\n\n    return filtered;\n  }, [businesses, searchTerm, selectedCategory, userCountry, gpsLocation]);\n\n  // CORREÇÃO: Mover useMemo ANTES do early return para garantir que hooks são sempre chamados\n  // Empresas mais próximas (top 4) - em destaque\n  const nearbyBusinesses = useMemo(() => {\n    return filteredBusinesses.filter(b => b.distance !== null).slice(0, 4);\n  }, [filteredBusinesses]);\n  \n  // Indica se as distâncias vêm do GPS\n  const hasLocationData = gpsLocation !== null;\n\n  const formatDistance = (distance) => {\n    if (!distance) return null;\n    if (distance < 1) return `${Math.round(distance * 1000)}m`;\n    return `${distance.toFixed(1)}km`;\n  };\n\n  // Early return DEPOIS de todos os hooks\n  if (businessesLoading) {\n    return (\n      <div className=\"bg-gradient-to-br from-slate-50 to-blue-50 p-4\">\n        <div className=\"max-w-6xl mx-auto\">\n          <Skeleton className=\"h-12 w-64 mb-6\" />\n          <div className=\"grid md:grid-cols-2 gap-4\">\n            {[1, 2, 3, 4].map(i => <Skeleton key={i} className=\"h-40\" />)}\n          </div>\n        </div>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"bg-gradient-to-br from-slate-50 to-blue-50 p-4\">\n      <div className=\"max-w-6xl mx-auto\">\n        <div className=\"mb-6\">\n          <h1 className=\"text-3xl font-bold text-slate-900 mb-2\">\n            {txtFindBusinesses}\n          </h1>\n          \n          {/* Indicador de Localização GPS */}\n          {loadingLocation ? (\n            <div className=\"flex items-center gap-2 text-sm text-slate-600\">\n              <div className=\"w-4 h-4 border-2 border-blue-500 border-t-transparent rounded-full animate-spin\" />\n              {txtGettingLocation}\n            </div>\n          ) : gpsLocation && userCountry ? (\n            <p className=\"text-slate-600 flex items-center gap-2\">\n              <Navigation className=\"w-4 h-4 text-green-600\" />\n              {txtLocationActiveIn} {gpsCountry?.name} {txtShowingNearby}\n            </p>\n          ) : locationError ? (\n            <Alert className=\"mt-2 border-orange-200 bg-orange-50\">\n              <AlertCircle className=\"h-4 w-4 text-orange-600\" />\n              <AlertDescription className=\"text-orange-800 flex items-center justify-between\">\n                <span>{txtAllowLocation}</span>\n                <Button\n                  size=\"sm\"\n                  variant=\"outline\"\n                  className=\"ml-2 h-7 text-xs border-orange-300 hover:bg-orange-100\"\n                  onClick={refetchLocation}\n                >\n                  {txtEnableLocationBtn}\n                </Button>\n              </AlertDescription>\n            </Alert>\n          ) : (\n            <Alert className=\"mt-4 border-blue-200 bg-blue-50\">\n              <AlertCircle className=\"h-4 w-4 text-blue-600\" />\n              <AlertDescription className=\"text-blue-800 flex items-center justify-between\">\n                <span>{txtEnableLocationDesc}</span>\n                <Button\n                  size=\"sm\"\n                  variant=\"outline\"\n                  className=\"ml-2 h-7 text-xs border-blue-300 hover:bg-blue-100\"\n                  onClick={refetchLocation}\n                >\n                  {txtEnableLocationBtn}\n                </Button>\n              </AlertDescription>\n            </Alert>\n          )}\n        </div>\n\n        <div className=\"grid md:grid-cols-2 gap-4 mb-6\">\n          <div className=\"relative\">\n            <Search className=\"absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-slate-400\" />\n            <Input\n              placeholder={txtSearchBusinesses}\n              value={searchTerm}\n              onChange={(e) => setSearchTerm(e.target.value)}\n              className=\"pl-10\"\n            />\n          </div>\n          \n          <Select value={selectedCategory} onValueChange={setSelectedCategory}>\n            <SelectTrigger>\n              <SelectValue />\n            </SelectTrigger>\n            <SelectContent>\n              {categories.map(cat => (\n                <SelectItem key={cat.value} value={cat.value}>\n                  {cat.icon} {cat.label}\n                </SelectItem>\n              ))}\n            </SelectContent>\n          </Select>\n        </div>\n\n        {/* Seção: TOP 4 Empresas mais próximas - EM DESTAQUE */}\n        {nearbyBusinesses.length > 0 && (\n          <div className=\"mb-8\">\n            <div className=\"flex items-center gap-2 mb-4\">\n              <Sparkles className=\"w-5 h-5 text-green-600\" />\n              <h2 className=\"text-xl font-bold text-slate-900\">{txtBusinessesNearYou}</h2>\n              <div className=\"ml-auto flex items-center gap-2\">\n                <Badge variant=\"outline\" className=\"bg-green-50 text-green-700 border-green-200\">\n                  <Navigation className=\"w-3 h-3 mr-1\" />\n                  {nearbyBusinesses.length} {txtClosest}\n                </Badge>\n              </div>\n            </div>\n            <div className=\"grid md:grid-cols-2 gap-4\">\n              {nearbyBusinesses.map(business => {\n                // ✅ PROTEÇÃO: Garantir que business existe\n                if (!business || !business.id) return null;\n                \n                const businessQueues = queues.filter(q => q?.business_id === business.id);\n                const businessServices = services.filter(s => s?.business_id === business.id);\n                const hasQueues = businessQueues.length > 0;\n                const hasServices = businessServices.length > 0;\n\n                return (\n                  <Card key={business.id} className=\"border-2 border-green-200 shadow-lg hover:shadow-xl transition-all bg-gradient-to-br from-white to-green-50\">\n                    <CardContent className=\"p-4\">\n                      <div className=\"flex gap-3 mb-3\">\n                        {business.logo_url && (\n                          <img \n                            src={getUploadUrl(business.logo_url)} \n                            alt={business.name}\n                            className=\"w-16 h-16 rounded-lg object-cover flex-shrink-0\"\n                            onError={(e) => { e.target.style.display = 'none'; }}\n                          />\n                        )}\n                        <div className=\"flex-1 min-w-0\">\n                          <h3 className=\"font-bold text-lg text-slate-900 mb-1 truncate\">\n                            {business.name || txtNoName}\n                          </h3>\n                          {business.description && (\n                            <p className=\"text-sm text-slate-600 mb-2 line-clamp-2\">\n                              {business.description}\n                            </p>\n                          )}\n                          <div className=\"flex flex-wrap items-center gap-2 text-xs\">\n                            <Badge className=\"gap-1 bg-green-600 hover:bg-green-700\">\n                              <Navigation className=\"w-3 h-3\" />\n                              {formatDistance(business.distance)}\n                            </Badge>\n                            {business.category && (\n                              <Badge variant=\"outline\" className=\"gap-1\">\n                                {getCategoryDisplay(business)}\n                              </Badge>\n                            )}\n                            {business.address && (\n                              <Badge variant=\"outline\" className=\"gap-1\">\n                                <MapPin className=\"w-3 h-3\" />\n                                {business.address.split(',')[0]}\n                              </Badge>\n                            )}\n                            {business.rating && (\n                              <Badge variant=\"outline\" className=\"gap-1\">\n                                <Star className=\"w-3 h-3 fill-yellow-400 text-yellow-400\" />\n                                {business.rating.toFixed(1)}\n                              </Badge>\n                            )}\n                          </div>\n                        </div>\n                      </div>\n\n                      <div className=\"flex gap-2\">\n                        {hasQueues && (\n                          <Button\n                            onClick={() => navigate(createPageUrl(`BusinessDetail?id=${business.id}`))}\n                            size=\"sm\"\n                            className={`flex-1 bg-gradient-to-r ${categoryColors[business.category] || 'from-sky-500 to-blue-600'} hover:opacity-90 text-xs`}\n                          >\n                            {txtTakeTicket}\n                          </Button>\n                        )}\n                        {hasServices && (\n                          <Button\n                            onClick={() => navigate(createPageUrl(`BusinessDetail?id=${business.id}`))}\n                            size=\"sm\"\n                            variant=\"outline\"\n                            className=\"flex-1 text-xs\"\n                          >\n                            {txtMakeAppointment}\n                          </Button>\n                        )}\n                        {!hasQueues && !hasServices && (\n                          <Button\n                            onClick={() => navigate(createPageUrl(`BusinessDetail?id=${business.id}`))}\n                            size=\"sm\"\n                            variant=\"outline\"\n                            className=\"flex-1 text-xs gap-1\"\n                          >\n                            <Sparkles className=\"w-3 h-3\" />\n                            {txtViewBusiness}\n                          </Button>\n                        )}\n                      </div>\n                    </CardContent>\n                  </Card>\n                );\n              })}\n            </div>\n          </div>\n        )}\n\n        <div className=\"mb-4\">\n          <p className=\"text-sm text-slate-600\">\n            {filteredBusinesses.length} {filteredBusinesses.length === 1 ? txtBusinessFound : txtBusinessesFound}\n          </p>\n        </div>\n\n        {filteredBusinesses.length === 0 ? (\n          <Card className=\"border-0 shadow-lg\">\n            <CardContent className=\"py-16 text-center\">\n              <div className=\"w-16 h-16 bg-slate-100 rounded-full flex items-center justify-center mx-auto mb-4\">\n                <Search className=\"w-8 h-8 text-slate-400\" />\n              </div>\n              <h3 className=\"text-xl font-bold text-slate-900 mb-2\">\n                {txtNoBusinesses}\n              </h3>\n              <p className=\"text-slate-600\">\n                {userCountry ? txtNoCountry : txtConfigureCountry}\n              </p>\n            </CardContent>\n          </Card>\n        ) : (\n          <div className=\"grid md:grid-cols-2 gap-4\">\n            {filteredBusinesses.map(business => {\n              // ✅ PROTEÇÃO: Garantir que business existe\n              if (!business || !business.id) return null;\n              \n              const businessQueues = queues.filter(q => q?.business_id === business.id);\n              const businessServices = services.filter(s => s?.business_id === business.id);\n              const hasQueues = businessQueues.length > 0;\n              const hasServices = businessServices.length > 0;\n\n              return (\n                <Card key={business.id} className=\"border-0 shadow-md hover:shadow-xl transition-all\">\n                  <CardContent className=\"p-4\">\n                    <div className=\"flex gap-3 mb-3\">\n                      {business.logo_url && (\n                        <img \n                          src={getUploadUrl(business.logo_url)} \n                          alt={business.name}\n                          className=\"w-16 h-16 rounded-lg object-cover flex-shrink-0\"\n                          onError={(e) => { e.target.style.display = 'none'; }}\n                        />\n                      )}\n                      <div className=\"flex-1 min-w-0\">\n                        <h3 className=\"font-bold text-lg text-slate-900 mb-1 truncate\">\n                          {business.name || txtNoName}\n                        </h3>\n                        {business.description && (\n                          <p className=\"text-sm text-slate-600 mb-2 line-clamp-2\">\n                            {business.description}\n                          </p>\n                        )}\n                        <div className=\"flex flex-wrap items-center gap-2 text-xs\">\n                          {business.distance !== null && business.distance !== undefined && (\n                            <Badge variant=\"outline\" className=\"gap-1 bg-green-50 text-green-700 border-green-200\">\n                              <Navigation className=\"w-3 h-3\" />\n                              {formatDistance(business.distance)}\n                            </Badge>\n                          )}\n                          {business.category && (\n                            <Badge variant=\"outline\" className=\"gap-1\">\n                              {getCategoryDisplay(business)}\n                            </Badge>\n                          )}\n                          {business.address && (\n                            <Badge variant=\"outline\" className=\"gap-1\">\n                              <MapPin className=\"w-3 h-3\" />\n                              {business.address.split(',')[0]}\n                            </Badge>\n                          )}\n                          {business.rating && (\n                            <Badge variant=\"outline\" className=\"gap-1\">\n                              <Star className=\"w-3 h-3 fill-yellow-400 text-yellow-400\" />\n                              {business.rating.toFixed(1)}\n                            </Badge>\n                          )}\n                        </div>\n                      </div>\n                    </div>\n\n                    <div className=\"flex gap-2\">\n                      {hasQueues && (\n                        <Button\n                          onClick={() => navigate(createPageUrl(`BusinessDetail?id=${business.id}`))}\n                          size=\"sm\"\n                          className={`flex-1 bg-gradient-to-r ${categoryColors[business.category] || 'from-sky-500 to-blue-600'} hover:opacity-90 text-xs`}\n                        >\n                          {txtTakeTicket}\n                        </Button>\n                      )}\n                      {hasServices && (\n                        <Button\n                          onClick={() => navigate(createPageUrl(`BusinessDetail?id=${business.id}`))}\n                          size=\"sm\"\n                          variant=\"outline\"\n                          className=\"flex-1 text-xs\"\n                        >\n                          {txtMakeAppointment}\n                        </Button>\n                      )}\n                      {!hasQueues && !hasServices && (\n                        <Button\n                          onClick={() => navigate(createPageUrl(`BusinessDetail?id=${business.id}`))}\n                          size=\"sm\"\n                          variant=\"outline\"\n                          className=\"flex-1 text-xs gap-1\"\n                        >\n                          <Sparkles className=\"w-3 h-3\" />\n                          {txtViewBusiness}\n                        </Button>\n                      )}\n                    </div>\n                  </CardContent>\n                </Card>\n              );\n            })}\n          </div>\n        )}\n      </div>\n    </div>\n  );\n}","path":null,"size_bytes":24236,"size_tokens":null},"src/pages/TicketPublic.jsx":{"content":"import React, { useState, useEffect } from \"react\";\nimport { base44 } from \"@/api/base44Client\";\nimport { useQuery } from \"@tanstack/react-query\";\nimport { Card, CardContent } from \"@/components/ui/card\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Clock, Users, AlertCircle, CheckCircle2, Phone } from \"lucide-react\";\nimport { Skeleton } from \"@/components/ui/skeleton\";\nimport { useAutoTranslate } from \"@/hooks/useTranslate\";\nimport { getUploadUrl } from \"@/utils/apiConfig\";\n\nexport default function TicketPublicPage() {\n  const txtTicketNotFound = useAutoTranslate('Senha não encontrada', 'pt');\n  const txtVerifyLink = useAutoTranslate('Verifique o link ou contacte o estabelecimento', 'pt');\n  const txtWaiting = useAutoTranslate('Aguardando', 'pt');\n  const txtYourTurn = useAutoTranslate('É a sua vez!', 'pt');\n  const txtInService = useAutoTranslate('Em atendimento', 'pt');\n  const txtCompleted = useAutoTranslate('Concluído', 'pt');\n  const txtCancelled = useAutoTranslate('Cancelado', 'pt');\n  const txtPositionInQueue = useAutoTranslate('Posição na fila', 'pt');\n  const txtCurrentTicket = useAutoTranslate('Senha atual', 'pt');\n  const txtEstimatedTime = useAutoTranslate('Tempo estimado', 'pt');\n  const txtWaitToBeCalled = useAutoTranslate('Aguarde ser chamado', 'pt');\n  const txtKeepPageOpen = useAutoTranslate('Mantenha esta página aberta', 'pt');\n  const txtGoToService = useAutoTranslate('Dirija-se ao atendimento agora', 'pt');\n  const txtYouHaveMinutes = useAutoTranslate('Tem', 'pt');\n  const txtMinutesToAppear = useAutoTranslate('minutos para comparecer', 'pt');\n  const txtServiceCompleted = useAutoTranslate('Atendimento Concluído', 'pt');\n  const txtThanksForVisit = useAutoTranslate('Obrigado pela visita!', 'pt');\n  const txtTicketCancelled = useAutoTranslate('Senha Cancelada', 'pt');\n  const txtContactEstablishment = useAutoTranslate('Contacte o estabelecimento', 'pt');\n  const [now, setNow] = useState(new Date());\n  const urlParams = new URLSearchParams(window.location.search);\n  const ticketId = urlParams.get('id');\n\n  useEffect(() => {\n    const interval = setInterval(() => {\n      setNow(new Date());\n    }, 60000);\n    return () => clearInterval(interval);\n  }, []);\n\n  const { data: ticket, isLoading: loadingTicket } = useQuery({\n    queryKey: ['public-ticket', ticketId],\n    queryFn: async () => {\n      const tickets = await base44.entities.Ticket.filter({ id: ticketId });\n      return tickets[0];\n    },\n    enabled: !!ticketId,\n    refetchInterval: 3000,\n  });\n\n  const { data: queue } = useQuery({\n    queryKey: ['queue', ticket?.queue_id],\n    queryFn: async () => {\n      const queues = await base44.entities.Queue.filter({ id: ticket.queue_id });\n      return queues[0];\n    },\n    enabled: !!ticket?.queue_id,\n    refetchInterval: 3000,\n  });\n\n  const { data: business } = useQuery({\n    queryKey: ['business', ticket?.business_id],\n    queryFn: async () => {\n      const businesses = await base44.entities.Business.filter({ id: ticket.business_id });\n      return businesses[0];\n    },\n    enabled: !!ticket?.business_id,\n  });\n\n  const { data: service } = useQuery({\n    queryKey: ['service', queue?.service_id],\n    queryFn: async () => {\n      const services = await base44.entities.Service.filter({ id: queue.service_id });\n      return services[0];\n    },\n    enabled: !!queue?.service_id,\n  });\n\n  if (loadingTicket) {\n    return (\n      <div className=\"bg-gradient-to-br from-slate-50 via-blue-50 to-sky-50 p-3 sm:p-6\">\n        <div className=\"max-w-md mx-auto\">\n          <Skeleton className=\"h-40 w-full mb-3 rounded-xl\" />\n          <Skeleton className=\"h-32 w-full rounded-xl\" />\n        </div>\n      </div>\n    );\n  }\n\n  if (!ticket) {\n    return (\n      <div className=\"bg-gradient-to-br from-slate-50 via-blue-50 to-sky-50 flex items-center justify-center p-3 sm:p-6\">\n        <Card className=\"border-0 shadow-lg max-w-md w-full\">\n          <CardContent className=\"py-12 sm:py-16 text-center\">\n            <AlertCircle className=\"w-16 h-16 text-red-500 mx-auto mb-4\" />\n            <h2 className=\"text-xl sm:text-2xl font-bold text-slate-900 mb-2\">{txtTicketNotFound}</h2>\n            <p className=\"text-slate-600\">{txtVerifyLink}</p>\n          </CardContent>\n        </Card>\n      </div>\n    );\n  }\n\n  const statusConfig = {\n    aguardando: { \n      icon: Clock, \n      color: 'from-amber-500 to-orange-500',\n      bg: 'bg-amber-100',\n      text: 'text-amber-700',\n      label: txtWaiting \n    },\n    chamado: { \n      icon: Phone, \n      color: 'from-green-500 to-emerald-500',\n      bg: 'bg-green-100',\n      text: 'text-green-700',\n      label: txtYourTurn \n    },\n    atendendo: { \n      icon: Users, \n      color: 'from-blue-500 to-cyan-500',\n      bg: 'bg-blue-100',\n      text: 'text-blue-700',\n      label: txtInService \n    },\n    concluido: { \n      icon: CheckCircle2, \n      color: 'from-green-500 to-emerald-500',\n      bg: 'bg-green-100',\n      text: 'text-green-700',\n      label: txtCompleted \n    },\n    cancelado: { \n      icon: AlertCircle, \n      color: 'from-red-500 to-pink-500',\n      bg: 'bg-red-100',\n      text: 'text-red-700',\n      label: txtCancelled \n    }\n  };\n\n  const status = statusConfig[ticket.status] || statusConfig.aguardando;\n  const StatusIcon = status.icon;\n  const position = queue ? (ticket.ticket_number - queue.current_number) : 0;\n  \n  const elapsedMinutes = Math.floor((now - new Date(ticket.created_date)) / (1000 * 60));\n  const baseEstimatedTime = queue ? (position * queue.average_service_time) : 0;\n  const estimatedTime = Math.max(0, baseEstimatedTime - elapsedMinutes);\n\n  return (\n    <div className=\"bg-gradient-to-br from-slate-50 via-blue-50 to-sky-50 w-full overflow-x-hidden\">\n      <div className=\"w-full max-w-md mx-auto px-4 sm:px-6 py-4 sm:py-6 lg:py-8\">\n        {business && (\n          <div className=\"text-center mb-3 sm:mb-4\">\n            {business.logo_url && (\n              <img \n                src={getUploadUrl(business.logo_url)} \n                alt={business.name}\n                className=\"w-14 h-14 sm:w-16 sm:h-16 mx-auto mb-2 rounded-xl object-contain bg-white p-1\"\n                onError={(e) => { e.target.style.display = 'none'; }}\n              />\n            )}\n            <h1 className=\"text-lg sm:text-xl font-bold text-slate-900 truncate px-2\">{business.name}</h1>\n            {queue && (\n              <p className=\"text-xs sm:text-sm text-slate-600 truncate\">{queue.name}</p>\n            )}\n          </div>\n        )}\n\n        <Card className=\"border-0 shadow-2xl mb-3 sm:mb-4 overflow-hidden\">\n          <div className={`h-1.5 sm:h-2 bg-gradient-to-r ${status.color}`} />\n          <CardContent className=\"py-6 sm:py-8 text-center px-4\">\n            <div className={`w-16 h-16 sm:w-20 sm:h-20 rounded-full bg-gradient-to-br ${status.color} flex items-center justify-center mx-auto mb-3 sm:mb-4 shadow-xl`}>\n              <StatusIcon className=\"w-8 h-8 sm:w-10 sm:h-10 text-white\" />\n            </div>\n            \n            <div className=\"mb-3 sm:mb-4\">\n              <div className=\"text-5xl sm:text-6xl font-bold text-slate-900 mb-2\">\n                #{ticket.ticket_number}\n              </div>\n              <Badge className={`${status.bg} ${status.text} border-0 text-sm sm:text-base px-3 sm:px-4 py-1`}>\n                {status.label}\n              </Badge>\n            </div>\n\n            {ticket.manual_name && (\n              <p className=\"text-sm sm:text-base text-slate-700 mb-2 truncate\">{ticket.manual_name}</p>\n            )}\n          </CardContent>\n        </Card>\n\n        {ticket.status === 'aguardando' && queue && (\n          <div className=\"space-y-2 sm:space-y-3\">\n            <Card className=\"border-0 shadow-lg\">\n              <CardContent className=\"p-3 sm:p-4\">\n                <div className=\"grid grid-cols-3 gap-2 text-center\">\n                  <div className=\"bg-blue-50 rounded-lg p-2 sm:p-3\">\n                    <div className=\"text-xl sm:text-2xl font-bold text-blue-600\">{position}</div>\n                    <div className=\"text-[10px] sm:text-xs text-slate-600 leading-tight\">{txtPositionInQueue}</div>\n                  </div>\n                  <div className=\"bg-slate-50 rounded-lg p-2 sm:p-3\">\n                    <div className=\"text-xl sm:text-2xl font-bold text-slate-900\">#{queue.current_number}</div>\n                    <div className=\"text-[10px] sm:text-xs text-slate-600 leading-tight\">{txtCurrentTicket}</div>\n                  </div>\n                  <div className=\"bg-purple-50 rounded-lg p-2 sm:p-3\">\n                    <div className=\"text-xl sm:text-2xl font-bold text-purple-600\">~{estimatedTime}</div>\n                    <div className=\"text-[10px] sm:text-xs text-slate-600 leading-tight\">{txtEstimatedTime}</div>\n                  </div>\n                </div>\n              </CardContent>\n            </Card>\n\n            <Card className=\"border-0 shadow-lg bg-gradient-to-br from-blue-50 to-sky-50\">\n              <CardContent className=\"p-3 sm:p-4 text-center\">\n                <Clock className=\"w-6 h-6 sm:w-8 sm:h-8 text-blue-600 mx-auto mb-1.5 sm:mb-2\" />\n                <p className=\"text-xs sm:text-sm text-slate-700 font-medium\">\n                  {txtWaitToBeCalled}\n                </p>\n                <p className=\"text-[10px] sm:text-xs text-slate-600 mt-0.5 sm:mt-1\">\n                  {txtKeepPageOpen}\n                </p>\n              </CardContent>\n            </Card>\n          </div>\n        )}\n\n        {ticket.status === 'chamado' && (\n          <Card className=\"border-0 shadow-lg bg-gradient-to-br from-green-50 to-emerald-50 animate-pulse\">\n            <CardContent className=\"p-4 sm:p-6 text-center\">\n              <Phone className=\"w-10 h-10 sm:w-12 sm:h-12 text-green-600 mx-auto mb-2 sm:mb-3\" />\n              <h3 className=\"text-lg sm:text-xl font-bold text-green-700 mb-1.5 sm:mb-2\">\n                {txtYourTurn}\n              </h3>\n              <p className=\"text-sm sm:text-base text-slate-700 mb-2\">\n                {txtGoToService}\n              </p>\n              {service && service.tolerance_time && (\n                <p className=\"text-xs sm:text-sm text-green-700 font-medium flex items-center justify-center gap-1 mt-2 sm:mt-3\">\n                  <Clock className=\"w-3.5 h-3.5 sm:w-4 sm:h-4\" />\n                  {txtYouHaveMinutes} {service.tolerance_time} {txtMinutesToAppear}\n                </p>\n              )}\n            </CardContent>\n          </Card>\n        )}\n\n        {ticket.status === 'concluido' && (\n          <Card className=\"border-0 shadow-lg bg-gradient-to-br from-green-50 to-emerald-50\">\n            <CardContent className=\"p-4 sm:p-6 text-center\">\n              <CheckCircle2 className=\"w-10 h-10 sm:w-12 sm:h-12 text-green-600 mx-auto mb-2 sm:mb-3\" />\n              <h3 className=\"text-lg sm:text-xl font-bold text-green-700 mb-1.5 sm:mb-2\">\n                {txtServiceCompleted}\n              </h3>\n              <p className=\"text-sm sm:text-base text-slate-700\">\n                {txtThanksForVisit}\n              </p>\n            </CardContent>\n          </Card>\n        )}\n\n        {ticket.status === 'cancelado' && (\n          <Card className=\"border-0 shadow-lg bg-gradient-to-br from-red-50 to-pink-50\">\n            <CardContent className=\"p-4 sm:p-6 text-center\">\n              <AlertCircle className=\"w-10 h-10 sm:w-12 sm:h-12 text-red-600 mx-auto mb-2 sm:mb-3\" />\n              <h3 className=\"text-lg sm:text-xl font-bold text-red-700 mb-1.5 sm:mb-2\">\n                {txtTicketCancelled}\n              </h3>\n              <p className=\"text-sm sm:text-base text-slate-700\">\n                {txtContactEstablishment}\n              </p>\n            </CardContent>\n          </Card>\n        )}\n      </div>\n    </div>\n  );\n}","path":null,"size_bytes":11762,"size_tokens":null},"tailwind.config.js":{"content":"/** @type {import('tailwindcss').Config} */\nmodule.exports = {\n    darkMode: [\"class\"],\n    content: [\"./index.html\", \"./src/**/*.{ts,tsx,js,jsx}\"],\n  theme: {\n        extend: {\n                borderRadius: {\n                        lg: 'var(--radius)',\n                        md: 'calc(var(--radius) - 2px)',\n                        sm: 'calc(var(--radius) - 4px)'\n                },\n                colors: {\n                        background: 'hsl(var(--background))',\n                        foreground: 'hsl(var(--foreground))',\n                        card: {\n                                DEFAULT: 'hsl(var(--card))',\n                                foreground: 'hsl(var(--card-foreground))'\n                        },\n                        popover: {\n                                DEFAULT: 'hsl(var(--popover))',\n                                foreground: 'hsl(var(--popover-foreground))'\n                        },\n                        primary: {\n                                DEFAULT: 'hsl(var(--primary))',\n                                foreground: 'hsl(var(--primary-foreground))'\n                        },\n                        secondary: {\n                                DEFAULT: 'hsl(var(--secondary))',\n                                foreground: 'hsl(var(--secondary-foreground))'\n                        },\n                        muted: {\n                                DEFAULT: 'hsl(var(--muted))',\n                                foreground: 'hsl(var(--muted-foreground))'\n                        },\n                        accent: {\n                                DEFAULT: 'hsl(var(--accent))',\n                                foreground: 'hsl(var(--accent-foreground))'\n                        },\n                        destructive: {\n                                DEFAULT: 'hsl(var(--destructive))',\n                                foreground: 'hsl(var(--destructive-foreground))'\n                        },\n                        border: 'hsl(var(--border))',\n                        input: 'hsl(var(--input))',\n                        ring: 'hsl(var(--ring))',\n                        chart: {\n                                '1': 'hsl(var(--chart-1))',\n                                '2': 'hsl(var(--chart-2))',\n                                '3': 'hsl(var(--chart-3))',\n                                '4': 'hsl(var(--chart-4))',\n                                '5': 'hsl(var(--chart-5))'\n                        },\n                        sidebar: {\n                                DEFAULT: 'hsl(var(--sidebar-background))',\n                                foreground: 'hsl(var(--sidebar-foreground))',\n                                primary: 'hsl(var(--sidebar-primary))',\n                                'primary-foreground': 'hsl(var(--sidebar-primary-foreground))',\n                                accent: 'hsl(var(--sidebar-accent))',\n                                'accent-foreground': 'hsl(var(--sidebar-accent-foreground))',\n                                border: 'hsl(var(--sidebar-border))',\n                                ring: 'hsl(var(--sidebar-ring))'\n                        }\n                },\n                keyframes: {\n                        'accordion-down': {\n                                from: {\n                                        height: '0'\n                                },\n                                to: {\n                                        height: 'var(--radix-accordion-content-height)'\n                                }\n                        },\n                        'accordion-up': {\n                                from: {\n                                        height: 'var(--radix-accordion-content-height)'\n                                },\n                                to: {\n                                        height: '0'\n                                }\n                        },\n                        shimmer: {\n                                '0%': {\n                                        transform: 'translateX(-100%)'\n                                },\n                                '100%': {\n                                        transform: 'translateX(100%)'\n                                }\n                        }\n                },\n                animation: {\n                        'accordion-down': 'accordion-down 0.2s ease-out',\n                        'accordion-up': 'accordion-up 0.2s ease-out',\n                        shimmer: 'shimmer 2s infinite'\n                }\n        }\n  },\n  plugins: [require(\"tailwindcss-animate\")],\n}","path":null,"size_bytes":4595,"size_tokens":null},"src/components/portal/QueuesAndServices.jsx":{"content":"import React from \"react\";\nimport { base44 } from \"@/api/base44Client\";\nimport { useQuery } from \"@tanstack/react-query\";\nimport { Link } from \"react-router-dom\";\nimport { createPageUrl } from \"@/utils\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Button } from \"@/components/ui/button\";\nimport { Tabs, TabsList, TabsTrigger, TabsContent } from \"@/components/ui/tabs\";\nimport { Clock, Building2, Calendar, Users, ArrowRight } from \"lucide-react\";\nimport { Skeleton } from \"@/components/ui/skeleton\";\nimport { useAutoTranslate } from \"@/hooks/useTranslate\";\n\nexport default function QueuesAndServices({ user }) {\n  // Traduções\n  const txtCompany = useAutoTranslate('Empresa', 'pt');\n  const txtOpen = useAutoTranslate('Aberta', 'pt');\n  const txtCurrentTicket = useAutoTranslate('Senha Atual', 'pt');\n  const txtWaiting = useAutoTranslate('Aguardando', 'pt');\n  const txtMinService = useAutoTranslate('min/atendimento', 'pt');\n  const txtGetTicket = useAutoTranslate('Retirar Senha', 'pt');\n  const txtScheduleService = useAutoTranslate('Agendar Serviço', 'pt');\n  const txtOpenQueues = useAutoTranslate('Filas Abertas', 'pt');\n  const txtAvailableServices = useAutoTranslate('Serviços Disponíveis', 'pt');\n  const txtNoQueuesOpen = useAutoTranslate('Nenhuma fila aberta', 'pt');\n  const txtNoQueuesAvailable = useAutoTranslate('Não há filas disponíveis no momento', 'pt');\n  const txtNoServicesAvailable = useAutoTranslate('Nenhum serviço disponível', 'pt');\n  const txtNoServicesToSchedule = useAutoTranslate('Não há serviços para agendar no momento', 'pt');\n  const { data: businesses, isLoading: loadingBusinesses } = useQuery({\n    queryKey: ['all-businesses'],\n    queryFn: () => base44.entities.Business.filter({ is_active: true }),\n    initialData: [],\n  });\n\n  const { data: queues, isLoading: loadingQueues } = useQuery({\n    queryKey: ['all-queues'],\n    queryFn: () => base44.entities.Queue.filter({ is_active: true, status: 'aberta' }),\n    initialData: [],\n  });\n\n  const { data: services, isLoading: loadingServices } = useQuery({\n    queryKey: ['all-services'],\n    queryFn: () => base44.entities.Service.filter({ is_active: true }),\n    initialData: [],\n  });\n\n  const getBusinessName = (businessId) => {\n    return businesses.find(b => b.id === businessId)?.name || txtCompany;\n  };\n\n  const QueueCard = ({ queue }) => {\n    const business = businesses.find(b => b.id === queue.business_id);\n    const waitingCount = queue.last_issued_number - queue.current_number;\n\n    return (\n      <Card className=\"border-0 shadow-lg hover:shadow-xl transition-all\">\n        <CardContent className=\"p-6\">\n          <div className=\"flex justify-between items-start mb-4\">\n            <div>\n              <h3 className=\"font-bold text-lg text-slate-900 mb-1\">{queue.name}</h3>\n              <div className=\"flex items-center gap-2 text-slate-600 text-sm\">\n                <Building2 className=\"w-4 h-4\" />\n                <span>{business?.name}</span>\n              </div>\n            </div>\n            <Badge className=\"bg-green-100 text-green-700 border-green-200\">\n              {txtOpen}\n            </Badge>\n          </div>\n\n          {queue.description && (\n            <p className=\"text-sm text-slate-600 mb-4\">{queue.description}</p>\n          )}\n\n          <div className=\"grid grid-cols-2 gap-4 mb-4\">\n            <div className=\"p-3 bg-blue-50 rounded-lg\">\n              <div className=\"text-sm text-blue-600 mb-1\">{txtCurrentTicket}</div>\n              <div className=\"text-2xl font-bold text-blue-900\">#{queue.current_number}</div>\n            </div>\n            <div className=\"p-3 bg-purple-50 rounded-lg\">\n              <div className=\"text-sm text-purple-600 mb-1\">{txtWaiting}</div>\n              <div className=\"text-2xl font-bold text-purple-900\">{waitingCount}</div>\n            </div>\n          </div>\n\n          <div className=\"flex items-center justify-between pt-4 border-t\">\n            <div className=\"flex items-center gap-1 text-sm text-slate-600\">\n              <Clock className=\"w-4 h-4\" />\n              <span>~{queue.average_service_time} {txtMinService}</span>\n            </div>\n            <Link to={createPageUrl(`BusinessDetail?id=${queue.business_id}`)}>\n              <Button size=\"sm\">\n                {txtGetTicket}\n                <ArrowRight className=\"w-4 h-4 ml-2\" />\n              </Button>\n            </Link>\n          </div>\n        </CardContent>\n      </Card>\n    );\n  };\n\n  const ServiceCard = ({ service }) => {\n    const business = businesses.find(b => b.id === service.business_id);\n\n    return (\n      <Card className=\"border-0 shadow-lg hover:shadow-xl transition-all\">\n        <CardContent className=\"p-6\">\n          <div className=\"flex justify-between items-start mb-4\">\n            <div>\n              <h3 className=\"font-bold text-lg text-slate-900 mb-1\">{service.name}</h3>\n              <div className=\"flex items-center gap-2 text-slate-600 text-sm\">\n                <Building2 className=\"w-4 h-4\" />\n                <span>{business?.name}</span>\n              </div>\n            </div>\n            {service.price && (\n              <Badge className=\"bg-sky-100 text-sky-700 border-sky-200\">\n                €{service.price.toFixed(2)}\n              </Badge>\n            )}\n          </div>\n\n          {service.description && (\n            <p className=\"text-sm text-slate-600 mb-4\">{service.description}</p>\n          )}\n\n          <div className=\"flex items-center gap-4 mb-4 text-sm text-slate-600\">\n            <div className=\"flex items-center gap-1\">\n              <Clock className=\"w-4 h-4\" />\n              <span>{service.duration} min</span>\n            </div>\n            {service.category && (\n              <Badge variant=\"secondary\">{service.category}</Badge>\n            )}\n          </div>\n\n          <Link to={createPageUrl(`BusinessDetail?id=${service.business_id}`)}>\n            <Button size=\"sm\" variant=\"outline\" className=\"w-full\">\n              <Calendar className=\"w-4 h-4 mr-2\" />\n              {txtScheduleService}\n            </Button>\n          </Link>\n        </CardContent>\n      </Card>\n    );\n  };\n\n  if (loadingBusinesses || loadingQueues || loadingServices) {\n    return (\n      <div className=\"grid md:grid-cols-2 gap-6\">\n        {[1, 2, 3, 4].map(i => <Skeleton key={i} className=\"h-64\" />)}\n      </div>\n    );\n  }\n\n  return (\n    <Tabs defaultValue=\"queues\">\n      <TabsList className=\"bg-white border border-slate-200 mb-6\">\n        <TabsTrigger value=\"queues\">\n          <Users className=\"w-4 h-4 mr-2\" />\n          {txtOpenQueues} ({queues.length})\n        </TabsTrigger>\n        <TabsTrigger value=\"services\">\n          <Calendar className=\"w-4 h-4 mr-2\" />\n          {txtAvailableServices} ({services.length})\n        </TabsTrigger>\n      </TabsList>\n\n      <TabsContent value=\"queues\">\n        {queues.length === 0 ? (\n          <Card className=\"border-0 shadow-lg\">\n            <CardContent className=\"py-16 text-center\">\n              <Users className=\"w-16 h-16 text-slate-400 mx-auto mb-4\" />\n              <h3 className=\"text-xl font-bold text-slate-900 mb-2\">\n                {txtNoQueuesOpen}\n              </h3>\n              <p className=\"text-slate-600\">\n                {txtNoQueuesAvailable}\n              </p>\n            </CardContent>\n          </Card>\n        ) : (\n          <div className=\"grid md:grid-cols-2 gap-6\">\n            {queues.map(queue => (\n              <QueueCard key={queue.id} queue={queue} />\n            ))}\n          </div>\n        )}\n      </TabsContent>\n\n      <TabsContent value=\"services\">\n        {services.length === 0 ? (\n          <Card className=\"border-0 shadow-lg\">\n            <CardContent className=\"py-16 text-center\">\n              <Calendar className=\"w-16 h-16 text-slate-400 mx-auto mb-4\" />\n              <h3 className=\"text-xl font-bold text-slate-900 mb-2\">\n                {txtNoServicesAvailable}\n              </h3>\n              <p className=\"text-slate-600\">\n                {txtNoServicesToSchedule}\n              </p>\n            </CardContent>\n          </Card>\n        ) : (\n          <div className=\"grid md:grid-cols-2 gap-6\">\n            {services.map(service => (\n              <ServiceCard key={service.id} service={service} />\n            ))}\n          </div>\n        )}\n      </TabsContent>\n    </Tabs>\n  );\n}","path":null,"size_bytes":8408,"size_tokens":null},"src/components/ui/sonner.jsx":{"content":"\"use client\";\nimport { useTheme } from \"next-themes\"\nimport { Toaster as Sonner } from \"sonner\"\n\nconst Toaster = ({\n  ...props\n}) => {\n  const { theme = \"system\" } = useTheme()\n\n  return (\n    (<Sonner\n      theme={theme}\n      className=\"toaster group\"\n      toastOptions={{\n        classNames: {\n          toast:\n            \"group toast group-[.toaster]:bg-background group-[.toaster]:text-foreground group-[.toaster]:border-border group-[.toaster]:shadow-lg\",\n          description: \"group-[.toast]:text-muted-foreground\",\n          actionButton:\n            \"group-[.toast]:bg-primary group-[.toast]:text-primary-foreground\",\n          cancelButton:\n            \"group-[.toast]:bg-muted group-[.toast]:text-muted-foreground\",\n        },\n      }}\n      {...props} />)\n  );\n}\n\nexport { Toaster }\n","path":null,"size_bytes":799,"size_tokens":null},"src/components/ui/toggle-group.jsx":{"content":"\"use client\";\nimport * as React from \"react\"\nimport * as ToggleGroupPrimitive from \"@radix-ui/react-toggle-group\"\n\nimport { cn } from \"@/lib/utils\"\nimport { toggleVariants } from \"@/components/ui/toggle\"\n\nconst ToggleGroupContext = React.createContext({\n  size: \"default\",\n  variant: \"default\",\n})\n\nconst ToggleGroup = React.forwardRef(({ className, variant, size, children, ...props }, ref) => (\n  <ToggleGroupPrimitive.Root\n    ref={ref}\n    className={cn(\"flex items-center justify-center gap-1\", className)}\n    {...props}>\n    <ToggleGroupContext.Provider value={{ variant, size }}>\n      {children}\n    </ToggleGroupContext.Provider>\n  </ToggleGroupPrimitive.Root>\n))\n\nToggleGroup.displayName = ToggleGroupPrimitive.Root.displayName\n\nconst ToggleGroupItem = React.forwardRef(({ className, children, variant, size, ...props }, ref) => {\n  const context = React.useContext(ToggleGroupContext)\n\n  return (\n    (<ToggleGroupPrimitive.Item\n      ref={ref}\n      className={cn(toggleVariants({\n        variant: context.variant || variant,\n        size: context.size || size,\n      }), className)}\n      {...props}>\n      {children}\n    </ToggleGroupPrimitive.Item>)\n  );\n})\n\nToggleGroupItem.displayName = ToggleGroupPrimitive.Item.displayName\n\nexport { ToggleGroup, ToggleGroupItem }\n","path":null,"size_bytes":1284,"size_tokens":null},"src/components/business/QueueSchedule.jsx":{"content":"import React, { useState, useEffect } from \"react\";\nimport { base44 } from \"@/api/base44Client\";\nimport { useMutation, useQueryClient } from \"@tanstack/react-query\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Label } from \"@/components/ui/label\";\nimport { Switch } from \"@/components/ui/switch\";\nimport { Clock, Save } from \"lucide-react\";\nimport { toast } from \"sonner\";\nimport { useAutoTranslate } from \"@/hooks/useTranslate\";\n\nexport default function QueueSchedule({ queue, onChange, onSaveComplete }) {\n  const txtSunday = useAutoTranslate('Domingo', 'pt');\n  const txtMonday = useAutoTranslate('Segunda-feira', 'pt');\n  const txtTuesday = useAutoTranslate('Terça-feira', 'pt');\n  const txtWednesday = useAutoTranslate('Quarta-feira', 'pt');\n  const txtThursday = useAutoTranslate('Quinta-feira', 'pt');\n  const txtFriday = useAutoTranslate('Sexta-feira', 'pt');\n  const txtSaturday = useAutoTranslate('Sábado', 'pt');\n  const txtWorkingHours = useAutoTranslate('Horários de Funcionamento', 'pt');\n  const txtOpening = useAutoTranslate('Abertura', 'pt');\n  const txtClosing = useAutoTranslate('Fecho', 'pt');\n  const txtBreakStart = useAutoTranslate('Pausa Início', 'pt');\n  const txtBreakEnd = useAutoTranslate('Pausa Fim', 'pt');\n  const txtOptional = useAutoTranslate('opcional', 'pt');\n  const txtSaving = useAutoTranslate('Salvando...', 'pt');\n  const txtSaveHours = useAutoTranslate('Salvar Horários', 'pt');\n  const txtHoursSaved = useAutoTranslate('Horários salvos com sucesso!', 'pt');\n  const txtHoursError = useAutoTranslate('Erro ao salvar horários. Tente novamente.', 'pt');\n  const txtSaveHint = useAutoTranslate('Os horários serão salvos ao clicar no botão \"Salvar\" no final', 'pt');\n\n  const daysOfWeek = [\n    { value: \"sunday\", label: txtSunday },\n    { value: \"monday\", label: txtMonday },\n    { value: \"tuesday\", label: txtTuesday },\n    { value: \"wednesday\", label: txtWednesday },\n    { value: \"thursday\", label: txtThursday },\n    { value: \"friday\", label: txtFriday },\n    { value: \"saturday\", label: txtSaturday }\n  ];\n\n  const queryClient = useQueryClient();\n  const [schedule, setSchedule] = useState(queue.working_hours || {});\n\n  useEffect(() => {\n    setSchedule(queue.working_hours || {});\n  }, [queue.id]);\n\n  const updateMutation = useMutation({\n    mutationFn: (data) => base44.entities.Queue.update(queue.id, data),\n    onSuccess: (updatedQueue) => {\n      // Atualiza o cache com businessId correto\n      queryClient.setQueryData(['business-queues', queue.business_id], (oldData) => {\n        if (!oldData) return [updatedQueue];\n        return oldData.map(q => q.id === updatedQueue.id ? updatedQueue : q);\n      });\n      \n      toast.success(txtHoursSaved);\n      if (onSaveComplete) {\n        onSaveComplete(schedule);\n      }\n    },\n    onError: (error) => {\n      console.error('Error saving schedule:', error);\n      toast.error(txtHoursError);\n    }\n  });\n\n  const toggleDay = (day) => {\n    setSchedule(prev => {\n      const newSchedule = { ...prev };\n      if (newSchedule[day]) {\n        delete newSchedule[day];\n      } else {\n        newSchedule[day] = {\n          enabled: true,\n          start: \"09:00\",\n          end: \"18:00\",\n          break_start: \"\",\n          break_end: \"\"\n        };\n      }\n      if (onChange) {\n        onChange(newSchedule);\n      }\n      if (onSaveComplete) {\n        onSaveComplete(newSchedule);\n      }\n      return newSchedule;\n    });\n  };\n\n  const updateDaySchedule = (day, field, value) => {\n    setSchedule(prev => {\n      const newSchedule = {\n        ...prev,\n        [day]: {\n          ...prev[day],\n          [field]: value\n        }\n      };\n      if (onChange) {\n        onChange(newSchedule);\n      }\n      if (onSaveComplete) {\n        onSaveComplete(newSchedule);\n      }\n      return newSchedule;\n    });\n  };\n\n  const updateBreak = (day, field, value) => {\n    setSchedule(prev => {\n      const newSchedule = {\n        ...prev,\n        [day]: {\n          ...prev[day],\n          [field]: value\n        }\n      };\n      if (onChange) {\n        onChange(newSchedule);\n      }\n      if (onSaveComplete) {\n        onSaveComplete(newSchedule);\n      }\n      return newSchedule;\n    });\n  };\n\n  const handleSave = () => {\n    updateMutation.mutate({ working_hours: schedule });\n  };\n\n  return (\n    <Card className=\"border-0 shadow-lg\">\n      <CardHeader>\n        <CardTitle className=\"flex items-center gap-2\">\n          <Clock className=\"w-5 h-5\" />\n          {txtWorkingHours}\n        </CardTitle>\n      </CardHeader>\n      <CardContent className=\"space-y-4\">\n        {daysOfWeek.map(({ value, label }) => (\n          <div key={value} className=\"p-4 bg-slate-50 rounded-lg\">\n            <div className=\"flex items-center justify-between mb-3\">\n              <Label className=\"font-semibold\">{label}</Label>\n              <Switch\n                checked={!!schedule[value]}\n                onCheckedChange={() => toggleDay(value)}\n              />\n            </div>\n            \n            {schedule[value] && (\n              <div className=\"space-y-3 ml-4\">\n                <div className=\"grid grid-cols-2 gap-3\">\n                  <div>\n                    <Label className=\"text-xs\">{txtOpening}</Label>\n                    <Input\n                      type=\"time\"\n                      value={schedule[value].start || \"09:00\"}\n                      onChange={(e) => updateDaySchedule(value, 'start', e.target.value)}\n                      className=\"h-9\"\n                    />\n                  </div>\n                  <div>\n                    <Label className=\"text-xs\">{txtClosing}</Label>\n                    <Input\n                      type=\"time\"\n                      value={schedule[value].end || \"18:00\"}\n                      onChange={(e) => updateDaySchedule(value, 'end', e.target.value)}\n                      className=\"h-9\"\n                    />\n                  </div>\n                </div>\n                \n                <div className=\"grid grid-cols-2 gap-3 pt-2 border-t\">\n                  <div>\n                    <Label className=\"text-xs text-slate-600\">\n                      {txtBreakStart} <span className=\"text-slate-400\">({txtOptional})</span>\n                    </Label>\n                    <Input\n                      type=\"time\"\n                      value={schedule[value].break_start || \"\"}\n                      onChange={(e) => updateBreak(value, 'break_start', e.target.value)}\n                      className=\"h-9\"\n                      placeholder=\"--:--\"\n                    />\n                  </div>\n                  <div>\n                    <Label className=\"text-xs text-slate-600\">\n                      {txtBreakEnd} <span className=\"text-slate-400\">({txtOptional})</span>\n                    </Label>\n                    <Input\n                      type=\"time\"\n                      value={schedule[value].break_end || \"\"}\n                      onChange={(e) => updateBreak(value, 'break_end', e.target.value)}\n                      className=\"h-9\"\n                      placeholder=\"--:--\"\n                    />\n                  </div>\n                </div>\n              </div>\n            )}\n          </div>\n        ))}\n        \n        {!onChange && !onSaveComplete && (\n          <Button \n            onClick={handleSave}\n            disabled={updateMutation.isPending}\n            className=\"w-full gap-2\"\n          >\n            <Save className=\"w-4 h-4\" />\n            {updateMutation.isPending ? txtSaving : txtSaveHours}\n          </Button>\n        )}\n        {(onChange || onSaveComplete) && (\n          <div className=\"text-center text-sm text-slate-600 py-2 bg-blue-50 rounded-md\">\n            💡 {txtSaveHint}\n          </div>\n        )}\n      </CardContent>\n    </Card>\n  );\n}","path":null,"size_bytes":7916,"size_tokens":null},"src/components/business/QueueStaffAssignment.jsx":{"content":"import React, { useState } from \"react\";\nimport { base44 } from \"@/api/base44Client\";\nimport { useQuery, useMutation, useQueryClient } from \"@tanstack/react-query\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Checkbox } from \"@/components/ui/checkbox\";\nimport { Users, Save } from \"lucide-react\";\nimport { useAutoTranslate } from \"@/hooks/useTranslate\";\n\nexport default function QueueStaffAssignment({ queue, businessId }) {\n  // Traduções\n  const txtAssignedStaff = useAutoTranslate('Funcionários Atribuídos', 'pt');\n  const txtNoStaff = useAutoTranslate('Nenhum funcionário cadastrado', 'pt');\n  const txtSaving = useAutoTranslate('Salvando...', 'pt');\n  const txtSaveAssignments = useAutoTranslate('Salvar Atribuições', 'pt');\n\n  const queryClient = useQueryClient();\n  const [selectedStaff, setSelectedStaff] = useState(queue.assigned_staff || []);\n\n  const { data: staff } = useQuery({\n    queryKey: ['staff', businessId],\n    queryFn: () => base44.entities.Staff.filter({ business_id: businessId, is_active: true }),\n    initialData: [],\n  });\n\n  const updateMutation = useMutation({\n    mutationFn: (data) => base44.entities.Queue.update(queue.id, data),\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['business-queues'] });\n    },\n  });\n\n  const toggleStaff = (staffId) => {\n    if (selectedStaff.includes(staffId)) {\n      setSelectedStaff(selectedStaff.filter(id => id !== staffId));\n    } else {\n      setSelectedStaff([...selectedStaff, staffId]);\n    }\n  };\n\n  const handleSave = () => {\n    updateMutation.mutate({ assigned_staff: selectedStaff });\n  };\n\n  const roleColors = {\n    atendente: \"bg-blue-100 text-blue-700 border-blue-200\",\n    supervisor: \"bg-purple-100 text-purple-700 border-purple-200\",\n    manager: \"bg-amber-100 text-amber-700 border-amber-200\"\n  };\n\n  return (\n    <Card className=\"border-0 shadow-lg\">\n      <CardHeader>\n        <CardTitle className=\"flex items-center gap-2\">\n          <Users className=\"w-5 h-5\" />\n          {txtAssignedStaff}\n        </CardTitle>\n      </CardHeader>\n      <CardContent className=\"space-y-4\">\n        {staff.length === 0 ? (\n          <p className=\"text-center text-slate-500 py-4\">\n            {txtNoStaff}\n          </p>\n        ) : (\n          <>\n            <div className=\"space-y-2\">\n              {staff.map((member) => (\n                <div key={member.id} className=\"flex items-center gap-3 p-3 bg-slate-50 rounded-lg hover:bg-slate-100 transition-colors\">\n                  <Checkbox\n                    checked={selectedStaff.includes(member.id)}\n                    onCheckedChange={() => toggleStaff(member.id)}\n                  />\n                  <div className=\"flex-1\">\n                    <div className=\"font-semibold text-slate-900\">{member.name}</div>\n                    <Badge className={`${roleColors[member.role]} text-xs`}>\n                      {member.role}\n                    </Badge>\n                  </div>\n                </div>\n              ))}\n            </div>\n            \n            <Button \n              onClick={handleSave}\n              disabled={updateMutation.isPending}\n              className=\"w-full gap-2\"\n            >\n              <Save className=\"w-4 h-4\" />\n              {updateMutation.isPending ? txtSaving : txtSaveAssignments}\n            </Button>\n          </>\n        )}\n      </CardContent>\n    </Card>\n  );\n}","path":null,"size_bytes":3524,"size_tokens":null},"src/components/business/PredictiveAnalytics.jsx":{"content":"import React from \"react\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { TrendingUp, Brain, AlertTriangle, CheckCircle2, Clock } from \"lucide-react\";\nimport { LineChart, Line, XAxis, YAxis, CartesianGrid, Tooltip, ResponsiveContainer, Legend } from \"recharts\";\n\nexport default function PredictiveAnalytics({ tickets, queues, business }) {\n  // Predict next 7 days based on historical patterns\n  const predictions = React.useMemo(() => {\n    if (tickets.length < 7) return null;\n\n    // Group by day of week\n    const dayPatterns = Array(7).fill(0).map(() => ({ total: 0, count: 0 }));\n    \n    tickets.forEach(ticket => {\n      const date = new Date(ticket.created_date);\n      const dayOfWeek = date.getDay();\n      dayPatterns[dayOfWeek].total++;\n      dayPatterns[dayOfWeek].count++;\n    });\n\n    // Calculate averages\n    const dayNames = ['Dom', 'Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'Sáb'];\n    const predictions = dayPatterns.map((pattern, index) => ({\n      dia: dayNames[index],\n      previsto: pattern.count > 0 ? Math.round(pattern.total / pattern.count) : 0,\n      confianca: pattern.count > 0 ? Math.min(100, (pattern.count / 4) * 100) : 0\n    }));\n\n    return predictions;\n  }, [tickets]);\n\n  // Calculate trend\n  const trend = React.useMemo(() => {\n    if (tickets.length < 14) return null;\n\n    const now = Date.now();\n    const weekAgo = now - (7 * 24 * 60 * 60 * 1000);\n    const twoWeeksAgo = now - (14 * 24 * 60 * 60 * 1000);\n\n    const lastWeek = tickets.filter(t => {\n      const date = new Date(t.created_date).getTime();\n      return date >= weekAgo && date <= now;\n    }).length;\n\n    const previousWeek = tickets.filter(t => {\n      const date = new Date(t.created_date).getTime();\n      return date >= twoWeeksAgo && date < weekAgo;\n    }).length;\n\n    const change = previousWeek > 0 \n      ? ((lastWeek - previousWeek) / previousWeek * 100).toFixed(1)\n      : 0;\n\n    return {\n      lastWeek,\n      previousWeek,\n      change: parseFloat(change),\n      trend: change > 0 ? 'crescimento' : change < 0 ? 'declínio' : 'estável'\n    };\n  }, [tickets]);\n\n  // Recommendations based on data\n  const recommendations = React.useMemo(() => {\n    const recs = [];\n\n    // Check cancellation rate\n    const cancelledRate = tickets.length > 0 \n      ? (tickets.filter(t => t.status === 'cancelado').length / tickets.length) * 100\n      : 0;\n\n    if (cancelledRate > 15) {\n      recs.push({\n        type: 'warning',\n        title: 'Taxa de Cancelamento Alta',\n        description: `${cancelledRate.toFixed(1)}% das senhas são canceladas. Considere reduzir tempo de espera.`,\n        icon: AlertTriangle,\n        color: 'text-amber-600 bg-amber-50'\n      });\n    }\n\n    // Check wait times\n    const avgWait = tickets\n      .filter(t => t.called_at && t.created_date)\n      .reduce((sum, t, _, arr) => {\n        const wait = (new Date(t.called_at) - new Date(t.created_date)) / (1000 * 60);\n        return sum + wait / arr.length;\n      }, 0);\n\n    if (avgWait > 30) {\n      recs.push({\n        type: 'warning',\n        title: 'Tempo de Espera Elevado',\n        description: `Média de ${Math.round(avgWait)} minutos. Aumente a capacidade de atendimento ou optimize o processo.`,\n        icon: Clock,\n        color: 'text-orange-600 bg-orange-50'\n      });\n    }\n\n    // Check growth trend\n    if (trend && trend.change > 20) {\n      recs.push({\n        type: 'success',\n        title: 'Crescimento Acelerado',\n        description: `+${trend.change}% de aumento na última semana. Prepare-se para maior demanda.`,\n        icon: TrendingUp,\n        color: 'text-green-600 bg-green-50'\n      });\n    }\n\n    // Check completion rate\n    const completionRate = tickets.length > 0\n      ? (tickets.filter(t => t.status === 'concluido').length / tickets.length) * 100\n      : 0;\n\n    if (completionRate > 85) {\n      recs.push({\n        type: 'success',\n        title: 'Excelente Desempenho',\n        description: `${completionRate.toFixed(1)}% de taxa de conclusão. Continue o ótimo trabalho!`,\n        icon: CheckCircle2,\n        color: 'text-green-600 bg-green-50'\n      });\n    }\n\n    return recs;\n  }, [tickets, trend]);\n\n  // Peak prediction\n  const peakPrediction = React.useMemo(() => {\n    const hourCounts = Array(24).fill(0);\n    \n    tickets.forEach(ticket => {\n      const hour = new Date(ticket.created_date).getHours();\n      hourCounts[hour]++;\n    });\n\n    const maxHour = hourCounts.indexOf(Math.max(...hourCounts));\n    const maxCount = Math.max(...hourCounts);\n\n    return {\n      hour: maxHour,\n      count: maxCount,\n      timeRange: `${maxHour}:00 - ${maxHour + 1}:00`\n    };\n  }, [tickets]);\n\n  if (!predictions || !trend) {\n    return (\n      <Card className=\"border-0 shadow-lg\">\n        <CardContent className=\"p-12 text-center\">\n          <Brain className=\"w-16 h-16 text-slate-300 mx-auto mb-4\" />\n          <p className=\"text-slate-600\">Dados insuficientes para análise preditiva</p>\n          <p className=\"text-sm text-slate-500 mt-2\">Colete mais dados ao longo do tempo</p>\n        </CardContent>\n      </Card>\n    );\n  }\n\n  return (\n    <>\n      {/* Trend Analysis */}\n      <Card className=\"border-0 shadow-lg bg-gradient-to-br from-indigo-50 to-purple-50\">\n        <CardHeader>\n          <CardTitle className=\"flex items-center gap-2\">\n            <Brain className=\"w-5 h-5\" />\n            Análise Preditiva com IA\n          </CardTitle>\n        </CardHeader>\n        <CardContent>\n          <div className=\"grid md:grid-cols-3 gap-6\">\n            <div className=\"p-6 bg-white rounded-xl\">\n              <div className=\"flex items-center gap-2 mb-3\">\n                <TrendingUp className={trend.change > 0 ? 'w-6 h-6 text-green-600' : 'w-6 h-6 text-red-600'} />\n                <span className=\"text-sm font-medium text-slate-600\">Tendência</span>\n              </div>\n              <p className=\"text-3xl font-bold text-slate-900 mb-2\">\n                {trend.change > 0 ? '+' : ''}{trend.change}%\n              </p>\n              <Badge className={\n                trend.trend === 'crescimento' ? 'bg-green-100 text-green-700' :\n                trend.trend === 'declínio' ? 'bg-red-100 text-red-700' :\n                'bg-slate-100 text-slate-700'\n              }>\n                {trend.trend === 'crescimento' ? '📈 Crescimento' : \n                 trend.trend === 'declínio' ? '📉 Declínio' : '➡️ Estável'}\n              </Badge>\n              <p className=\"text-xs text-slate-500 mt-3\">\n                Última semana: {trend.lastWeek} senhas\n              </p>\n            </div>\n\n            <div className=\"p-6 bg-white rounded-xl\">\n              <div className=\"flex items-center gap-2 mb-3\">\n                <Clock className=\"w-6 h-6 text-purple-600\" />\n                <span className=\"text-sm font-medium text-slate-600\">Horário de Pico</span>\n              </div>\n              <p className=\"text-3xl font-bold text-slate-900 mb-2\">\n                {peakPrediction.timeRange}\n              </p>\n              <Badge className=\"bg-purple-100 text-purple-700\">\n                ~{peakPrediction.count} senhas esperadas\n              </Badge>\n              <p className=\"text-xs text-slate-500 mt-3\">\n                Prepare equipe extra neste horário\n              </p>\n            </div>\n\n            <div className=\"p-6 bg-white rounded-xl\">\n              <div className=\"flex items-center gap-2 mb-3\">\n                <Brain className=\"w-6 h-6 text-indigo-600\" />\n                <span className=\"text-sm font-medium text-slate-600\">Próxima Semana</span>\n              </div>\n              <p className=\"text-3xl font-bold text-slate-900 mb-2\">\n                ~{Math.round(predictions.reduce((sum, p) => sum + p.previsto, 0))}\n              </p>\n              <Badge className=\"bg-indigo-100 text-indigo-700\">\n                Previsão total de senhas\n              </Badge>\n              <p className=\"text-xs text-slate-500 mt-3\">\n                Com base em padrões históricos\n              </p>\n            </div>\n          </div>\n        </CardContent>\n      </Card>\n\n      {/* Weekly Predictions */}\n      <Card className=\"border-0 shadow-lg\">\n        <CardHeader>\n          <CardTitle className=\"flex items-center gap-2\">\n            <TrendingUp className=\"w-5 h-5\" />\n            Previsão Semanal\n          </CardTitle>\n        </CardHeader>\n        <CardContent>\n          <ResponsiveContainer width=\"100%\" height={300}>\n            <LineChart data={predictions}>\n              <CartesianGrid strokeDasharray=\"3 3\" stroke=\"#e5e7eb\" />\n              <XAxis dataKey=\"dia\" stroke=\"#64748b\" style={{ fontSize: '12px' }} />\n              <YAxis stroke=\"#64748b\" style={{ fontSize: '12px' }} />\n              <Tooltip \n                contentStyle={{ \n                  backgroundColor: '#fff', \n                  border: '1px solid #e5e7eb',\n                  borderRadius: '8px'\n                }}\n              />\n              <Legend />\n              <Line \n                type=\"monotone\" \n                dataKey=\"previsto\" \n                stroke=\"#8b5cf6\" \n                strokeWidth={3}\n                dot={{ fill: '#8b5cf6', r: 5 }}\n                name=\"Senhas Previstas\"\n              />\n            </LineChart>\n          </ResponsiveContainer>\n          <div className=\"mt-4 flex items-center justify-center gap-2 text-sm text-slate-600\">\n            <Brain className=\"w-4 h-4\" />\n            Previsão baseada em padrões de {tickets.length} senhas analisadas\n          </div>\n        </CardContent>\n      </Card>\n\n      {/* Recommendations */}\n      {recommendations.length > 0 && (\n        <Card className=\"border-0 shadow-lg\">\n          <CardHeader>\n            <CardTitle className=\"flex items-center gap-2\">\n              <CheckCircle2 className=\"w-5 h-5\" />\n              Recomendações Inteligentes\n            </CardTitle>\n          </CardHeader>\n          <CardContent>\n            <div className=\"space-y-4\">\n              {recommendations.map((rec, idx) => {\n                const Icon = rec.icon;\n                return (\n                  <div key={idx} className={`p-4 rounded-xl ${rec.color}`}>\n                    <div className=\"flex items-start gap-3\">\n                      <Icon className=\"w-5 h-5 flex-shrink-0 mt-0.5\" />\n                      <div>\n                        <h4 className=\"font-bold mb-1\">{rec.title}</h4>\n                        <p className=\"text-sm opacity-90\">{rec.description}</p>\n                      </div>\n                    </div>\n                  </div>\n                );\n              })}\n            </div>\n          </CardContent>\n        </Card>\n      )}\n    </>\n  );\n}","path":null,"size_bytes":10722,"size_tokens":null},"src/pages/BusinessManageSubscription.jsx":{"content":"import React, { useState, useEffect } from \"react\";\nimport { base44 } from \"@/api/base44Client\";\nimport { safeFetch } from \"@/utils/apiConfig\";\nimport { useQuery, useMutation, useQueryClient } from \"@tanstack/react-query\";\nimport { Button } from \"@/components/ui/button\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { useNavigate } from \"react-router-dom\";\nimport { createPageUrl } from \"@/utils\";\nimport { \n  CheckCircle2, \n  Building2, \n  Calendar,\n  CreditCard,\n  AlertCircle,\n  Crown,\n  ArrowLeft,\n  AlertTriangle,\n  XCircle,\n  Globe\n} from \"lucide-react\";\nimport { format, differenceInDays } from \"date-fns\";\nimport { pt } from \"date-fns/locale\";\nimport { toast } from \"sonner\";\nimport { useConfirm } from \"@/hooks/useConfirm\";\nimport { useAutoTranslate } from \"@/hooks/useTranslate\";\nimport { Capacitor } from \"@capacitor/core\";\n\n// 🌐 URL externa para compra B2B (Apple/Google compliance)\nconst EXTERNAL_SUBSCRIPTION_URL = 'https://waitless-qzero.com';\n\nexport default function BusinessManageSubscriptionPage() {\n  // Traduções\n  const txtBack = useAutoTranslate('Voltar ao Painel', 'pt');\n  const txtBusinessSubscription = useAutoTranslate('Subscrição Empresarial', 'pt');\n  const txtManagePlan = useAutoTranslate('Gerir plano e faturação', 'pt');\n  const txtFreeTrialActive = useAutoTranslate('Período de Teste Gratuito Ativo', 'pt');\n  const txtTrialEndsIn = useAutoTranslate('O período de teste termina em', 'pt');\n  const txtDaysRemaining = useAutoTranslate('dias restantes', 'pt');\n  const txtDayRemaining = useAutoTranslate('dia restante', 'pt');\n  const txtAfterTrial = useAutoTranslate('Após o período de teste, será cobrado €49,99/mês automaticamente', 'pt');\n  const txtCancelAnytime = useAutoTranslate('Pode cancelar a qualquer momento sem qualquer cobrança', 'pt');\n  const txtSubscriptionCancelled = useAutoTranslate('Subscrição Cancelada', 'pt');\n  const txtAccessUntilTrial = useAutoTranslate('O seu período de teste gratuito foi cancelado', 'pt');\n  const txtAccessUntil = useAutoTranslate('Tem acesso às funcionalidades até', 'pt');\n  const txtNoCharge = useAutoTranslate('Não será cobrado nada', 'pt');\n  const txtAfterDate = useAutoTranslate('Após essa data, perderá acesso ao plano empresarial', 'pt');\n  const txtReactivateQuestion = useAutoTranslate('Reativar Subscrição?', 'pt');\n  const txtReactivateDescription = useAutoTranslate('Deseja reativar o seu plano empresarial? A renovação automática será retomada', 'pt');\n  const txtYesReactivate = useAutoTranslate('Sim, Reativar', 'pt');\n  const txtCancel = useAutoTranslate('Cancelar', 'pt');\n  const txtReactivating = useAutoTranslate('A reativar...', 'pt');\n  const txtReactivateNow = useAutoTranslate('Reativar Plano Agora', 'pt');\n  const txtBusinessPlan = useAutoTranslate('Plano Empresarial', 'pt');\n  const txtCancelledAccessUntil = useAutoTranslate('Cancelado (acesso até', 'pt');\n  const txtActive = useAutoTranslate('Ativo', 'pt');\n  const txtPerMonth = useAutoTranslate('por mês', 'pt');\n  const txtNextBilling = useAutoTranslate('Próxima Faturação', 'pt');\n  const txtRenewsIn = useAutoTranslate('Renova em', 'pt');\n  const txtDays = useAutoTranslate('dias', 'pt');\n  const txtDay = useAutoTranslate('dia', 'pt');\n  const txtPaymentMethod = useAutoTranslate('Método de Pagamento', 'pt');\n  const txtAutoRenewal = useAutoTranslate('Renovação automática', 'pt');\n  const txtCancelled = useAutoTranslate('Cancelada', 'pt');\n  const txtFeaturesIncluded = useAutoTranslate('Funcionalidades Incluídas', 'pt');\n  const txtBillingHistory = useAutoTranslate('Histórico de Faturação', 'pt');\n  const txtMonthly = useAutoTranslate('Mensalmente', 'pt');\n  const txtPending = useAutoTranslate('Pendente', 'pt');\n  const txtPaid = useAutoTranslate('Paga', 'pt');\n  const txtCancelSubscription = useAutoTranslate('Cancelar Subscrição', 'pt');\n  const txtOnCancelLoseAccess = useAutoTranslate('Ao cancelar, perde acesso imediato a', 'pt');\n  const txtQueueManagement = useAutoTranslate('Gestão de Senhas e Filas', 'pt');\n  const txtAppointmentSystem = useAutoTranslate('Sistema de Marcações', 'pt');\n  const txtTVPanel = useAutoTranslate('Painel TV para Sala de Espera', 'pt');\n  const txtTeamManagement = useAutoTranslate('Gestão de Equipa', 'pt');\n  const txtMarketingMaterials = useAutoTranslate('Material de Marketing Personalizado', 'pt');\n  const txtFullHistory = useAutoTranslate('Histórico Completo de Atendimentos', 'pt');\n  const txtWhatHappens = useAutoTranslate('O que acontece depois do cancelamento', 'pt');\n  const txtYouWillHaveAccess = useAutoTranslate('Terá acesso até', 'pt');\n  const txtNoChargeTrial = useAutoTranslate('Não será cobrado', 'pt');\n  const txtAfterLoseAccess = useAutoTranslate('Após essa data, volta ao modo básico (apenas visualização)', 'pt');\n  const txtCanReactivate = useAutoTranslate('Pode reativar o plano a qualquer momento', 'pt');\n  const txtConfirmCancel = useAutoTranslate('Confirmar Cancelamento', 'pt');\n  const txtCancelDescription = useAutoTranslate('Tem a certeza que deseja cancelar o plano empresarial', 'pt');\n  const txtCancelling = useAutoTranslate('A cancelar...', 'pt');\n  const txtNoActiveSubscription = useAutoTranslate('Sem Subscrição Ativa', 'pt');\n  const txtNoBusinessSubscription = useAutoTranslate('Não tem uma subscrição empresarial ativa', 'pt');\n  const txtViewPlans = useAutoTranslate('Ver Planos', 'pt');\n  const txtLoading = useAutoTranslate('A carregar...', 'pt');\n  const txtProfileNotFound = useAutoTranslate('Perfil da empresa não encontrado', 'pt');\n  const txtErrorCancelling = useAutoTranslate('Erro ao cancelar subscrição', 'pt');\n  const txtCancelSuccess = useAutoTranslate('Subscrição cancelada com sucesso', 'pt');\n  const txtErrorReactivating = useAutoTranslate('Erro ao reativar subscrição. Tente novamente', 'pt');\n  const txtReactivateSuccess = useAutoTranslate('Subscrição reativada com sucesso!', 'pt');\n  const txtCreatingNewSubscription = useAutoTranslate('Vamos criar uma nova subscrição para a sua empresa', 'pt');\n  const txtTestingPlanFree = useAutoTranslate('Está a experimentar o plano empresarial gratuitamente!', 'pt');\n  const txtTrialEndPeriod = useAutoTranslate('fim do período de teste', 'pt');\n  const txtCancelFreeInTrial = useAutoTranslate('o cancelamento é gratuito durante o período de teste', 'pt');\n  const txtConfirmCancelTitle = useAutoTranslate('Cancelar Subscrição Empresarial', 'pt');\n  const txtConfirmCancelTrialDesc = useAutoTranslate('Tem certeza que deseja cancelar o período de teste gratuito? Perderá acesso a TODAS as funcionalidades empresariais após', 'pt');\n  const txtConfirmCancelDesc = useAutoTranslate('Tem certeza que deseja cancelar? Perderá acesso a TODAS as funcionalidades empresariais (gestão de filas, marcações, analytics, painel TV, notificações) após', 'pt');\n  const txtRemainingDays = useAutoTranslate('restantes', 'pt');\n  const txtWillNotBeCharged = useAutoTranslate('Não será cobrado nada', 'pt');\n  const txtBasicPanelOnly = useAutoTranslate('Ficará apenas com acesso ao painel básico', 'pt');\n  const txtReactivateFromPage = useAutoTranslate('Pode reativar indo à página de subscrição', 'pt');\n  const txtReactivatePlan = useAutoTranslate('Reativar Plano', 'pt');\n  const txtVisitWebsite = useAutoTranslate('Visite waitless-qzero.com', 'pt');\n  const txtManageOnWebsite = useAutoTranslate('Gestão disponível em waitless-qzero.com', 'pt');\n  const txtUnlimitedQueues = useAutoTranslate('Gestão de filas ilimitadas', 'pt');\n  const txtAppointmentSys = useAutoTranslate('Sistema de marcações', 'pt');\n  const txtAnalytics = useAutoTranslate('Análise e estatísticas', 'pt');\n  const txtAutoNotifications = useAutoTranslate('Notificações automáticas', 'pt');\n  const txtPrioritySupportFeature = useAutoTranslate('Suporte prioritário', 'pt');\n  const txtDateNotAvailable = useAutoTranslate('Data não disponível', 'pt');\n  \n  const txtJanuary = useAutoTranslate('janeiro', 'pt');\n  const txtFebruary = useAutoTranslate('fevereiro', 'pt');\n  const txtMarch = useAutoTranslate('março', 'pt');\n  const txtApril = useAutoTranslate('abril', 'pt');\n  const txtMay = useAutoTranslate('maio', 'pt');\n  const txtJune = useAutoTranslate('junho', 'pt');\n  const txtJuly = useAutoTranslate('julho', 'pt');\n  const txtAugust = useAutoTranslate('agosto', 'pt');\n  const txtSeptember = useAutoTranslate('setembro', 'pt');\n  const txtOctober = useAutoTranslate('outubro', 'pt');\n  const txtNovember = useAutoTranslate('novembro', 'pt');\n  const txtDecember = useAutoTranslate('dezembro', 'pt');\n  \n  const monthNames = [txtJanuary, txtFebruary, txtMarch, txtApril, txtMay, txtJune, txtJuly, txtAugust, txtSeptember, txtOctober, txtNovember, txtDecember];\n  \n  const formatMonthYear = (date) => {\n    if (!date || isNaN(date.getTime())) return txtDateNotAvailable;\n    const month = monthNames[date.getMonth()];\n    const year = date.getFullYear();\n    return `${month} ${year}`;\n  };\n\n  const navigate = useNavigate();\n  const queryClient = useQueryClient();\n  const [user, setUser] = useState(null);\n  const { confirm, ConfirmDialog } = useConfirm();\n  \n  // 🍎🤖 B2B COMPLIANCE: Detectar app nativa (iOS/Android)\n  const isNativeApp = Capacitor.isNativePlatform();\n  \n  // Função para abrir website externo (B2B compliance)\n  const handleExternalPurchase = () => {\n    if (isNativeApp) {\n      window.open(EXTERNAL_SUBSCRIPTION_URL, '_system');\n    } else {\n      window.open(EXTERNAL_SUBSCRIPTION_URL, '_blank');\n    }\n  };\n\n  useEffect(() => {\n    base44.auth.me().then(setUser).catch(() => {\n      base44.auth.redirectToLogin();\n    });\n  }, []);\n\n  const { data: subscription, isLoading } = useQuery({\n    queryKey: ['business-subscription', user?.email],\n    queryFn: async () => {\n      if (!user || !user.business_id) return null;\n      \n      // Buscar dados direto do perfil da empresa (fonte confiável)\n      const { response, data: profile } = await safeFetch(`/api/company-profiles/${user.business_id}`);\n      \n      if (!response.ok) {\n        console.error('Erro ao buscar perfil da empresa');\n        return null;\n      }\n      \n      // Converter perfil para formato de subscrição\n      // ✅ Verificar se está cancelado (aceitar ambas grafias: 'canceled' e 'cancelled')\n      const isCancelledStatus = profile.subscriptionStatus === 'canceled' || \n                                 profile.subscriptionStatus === 'cancelled' ||\n                                 profile.status === 'cancelled' ||\n                                 profile.status === 'canceled';\n      \n      console.log('📊 BusinessManageSubscription - Dados do perfil:', {\n        subscriptionStatus: profile.subscriptionStatus,\n        status: profile.status,\n        isCancelledStatus,\n        currentPeriodEnd: profile.currentPeriodEnd,\n        trialEnd: profile.trialEnd\n      });\n      \n      return {\n        id: profile.subscriptionId,\n        user_email: user.email,\n        plan: 'business',\n        status: profile.subscriptionStatus || profile.status,\n        auto_renew: !isCancelledStatus,  // ✅ Corrigido: false se cancelado\n        trial_end_date: profile.trialEnd,\n        end_date: profile.currentPeriodEnd,\n        created_date: profile.createdAt,\n        amount: 4999,\n        currency: 'EUR'\n      };\n    },\n    enabled: !!user,\n  });\n\n  // ✅ CANCELAMENTO REAL VIA STRIPE API\n  const cancelMutation = useMutation({\n    mutationFn: async () => {\n      // ✅ Usar business_id do utilizador (já vem do /api/auth/me)\n      const companyProfileId = user.business_id;\n      \n      if (!companyProfileId) {\n        throw new Error(txtProfileNotFound);\n      }\n      \n      // ✅ CANCELAR NO STRIPE (NÃO apenas no DB local)\n      const { response, data } = await safeFetch('/api/stripe/cancel-subscription', {\n        method: 'POST',\n        body: JSON.stringify({ companyProfileId })\n      });\n      \n      if (!response.ok) {\n        throw new Error(data?.error || txtErrorCancelling);\n      }\n      \n      return data;\n    },\n    onSuccess: (data) => {\n      queryClient.invalidateQueries({ queryKey: ['business-subscription'] });\n      \n      // Mostrar mensagem de sucesso com data de acesso\n      if (data.message) {\n        toast.success(data.message);\n      } else {\n        toast.success(txtCancelSuccess);\n      }\n    },\n    onError: (error) => {\n      console.error('Erro ao cancelar subscrição:', error);\n      toast.error(error.message || txtErrorReactivating);\n    }\n  });\n\n  // ✅ REATIVAÇÃO DE SUBSCRIÇÃO CANCELADA\n  const reactivateMutation = useMutation({\n    mutationFn: async () => {\n      const companyProfileId = user.business_id;\n      \n      if (!companyProfileId) {\n        throw new Error(txtProfileNotFound);\n      }\n      \n      const { response, data } = await safeFetch('/api/stripe/reactivate-subscription', {\n        method: 'POST',\n        body: JSON.stringify({ companyProfileId })\n      });\n      \n      if (!response.ok) {\n        throw new Error(data?.error || 'Erro ao reativar subscrição');\n      }\n      \n      return data;\n    },\n    onSuccess: (data) => {\n      if (data.requires_new_checkout) {\n        // Redirecionar para criar nova subscrição PARA A MESMA EMPRESA\n        navigate(createPageUrl(\"BusinessSubscription\"), {\n          state: { \n            existingProfileId: data.existing_profile_id,\n            isReactivation: true \n          }\n        });\n        toast.info(data.message || txtCreatingNewSubscription);\n      } else {\n        queryClient.invalidateQueries({ queryKey: ['business-subscription'] });\n        toast.success(data.message || txtReactivateSuccess);\n        // Recarregar página para atualizar estado\n        window.location.reload();\n      }\n    },\n    onError: (error) => {\n      console.error('Erro ao reativar subscrição:', error);\n      toast.error(error.message || txtErrorReactivating);\n    }\n  });\n\n  if (!user || isLoading) {\n    return (\n      <div className=\"bg-gradient-to-br from-slate-50 via-blue-50 to-sky-50 flex items-center justify-center p-4\">\n        <p>{txtLoading}</p>\n      </div>\n    );\n  }\n\n  if (!subscription) {\n    return (\n      <div className=\"bg-gradient-to-br from-slate-50 via-blue-50 to-sky-50 p-4\">\n        <div className=\"max-w-4xl mx-auto\">\n          <Button\n            variant=\"outline\"\n            onClick={() => navigate(createPageUrl(\"BusinessDashboard\"))}\n            className=\"mb-6\"\n          >\n            <ArrowLeft className=\"w-4 h-4 mr-2\" />\n            {txtBack}\n          </Button>\n\n          <Card className=\"border-0 shadow-xl\">\n            <CardContent className=\"py-16 text-center\">\n              <AlertCircle className=\"w-16 h-16 text-slate-400 mx-auto mb-4\" />\n              <h2 className=\"text-2xl font-bold text-slate-900 mb-2\">\n                {txtNoActiveSubscription}\n              </h2>\n              <p className=\"text-slate-600 mb-6\">\n                {txtNoBusinessSubscription}\n              </p>\n              \n              {/* 🍎🤖 B2B COMPLIANCE: Apps nativas redirecionam para website externo */}\n              {isNativeApp ? (\n                <div className=\"space-y-3\">\n                  <div className=\"flex items-center justify-center gap-2 text-slate-600\">\n                    <Globe className=\"w-5 h-5\" />\n                    <span className=\"font-semibold\">{txtVisitWebsite}</span>\n                  </div>\n                  <Button\n                    onClick={handleExternalPurchase}\n                    className=\"bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-700 hover:to-purple-700\"\n                  >\n                    <Globe className=\"w-4 h-4 mr-2\" />\n                    {txtVisitWebsite}\n                  </Button>\n                </div>\n              ) : (\n                <Button\n                  onClick={() => navigate(createPageUrl(\"BusinessSubscription\"))}\n                  className=\"bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-700 hover:to-purple-700\"\n                >\n                  {txtViewPlans}\n                </Button>\n              )}\n            </CardContent>\n          </Card>\n        </div>\n      </div>\n    );\n  }\n\n  // ✅ Validar e calcular datas com segurança\n  const today = new Date();\n  const isCancelled = subscription.auto_renew === false;\n  \n  // ✅ Verificar se está em período de trial com validação\n  const isTrialing = subscription.status === 'trialing';\n  let trialEndDate = null;\n  let trialDaysRemaining = 0;\n  let trialEndFormatted = '';\n  \n  if (isTrialing && subscription.trial_end_date) {\n    try {\n      trialEndDate = new Date(subscription.trial_end_date);\n      if (!isNaN(trialEndDate.getTime())) {\n        trialDaysRemaining = differenceInDays(trialEndDate, today);\n        trialEndFormatted = format(trialEndDate, \"dd 'de' MMMM 'de' yyyy\", { locale: pt });\n      } else {\n        trialEndDate = null;\n      }\n    } catch (e) {\n      console.warn('Data de fim de trial inválida:', subscription.trial_end_date);\n      trialEndDate = null;\n    }\n  }\n  \n  // ✅ LÓGICA AJUSTADA: Se cancelar durante trial, termina no fim do trial (não no próximo mês)\n  let endDate = null;\n  let nextBillingDate = '';\n  let daysRemaining = 0;\n  let isExpiringSoon = false;\n  \n  // Se estiver em trial E cancelado → usar trial_end_date\n  if (isTrialing && isCancelled && trialEndDate) {\n    endDate = trialEndDate;\n    nextBillingDate = trialEndFormatted;\n    daysRemaining = trialDaysRemaining;\n    isExpiringSoon = daysRemaining <= 2;\n  } else {\n    // Caso contrário, usar end_date normal (próximo mês)\n    // Tentar obter end_date da subscription\n    if (subscription.end_date) {\n      try {\n        endDate = new Date(subscription.end_date);\n        if (isNaN(endDate.getTime())) {\n          endDate = null;\n        }\n      } catch (e) {\n        console.warn('Data de fim inválida:', subscription.end_date);\n        endDate = null;\n      }\n    }\n    \n    // Se não tiver end_date válida, calcular baseado em created_date\n    if (!endDate && subscription.created_date) {\n      try {\n        const createdDate = new Date(subscription.created_date);\n        if (!isNaN(createdDate.getTime())) {\n          endDate = new Date(createdDate);\n          endDate.setMonth(endDate.getMonth() + 1);\n        }\n      } catch (e) {\n        console.warn('Data de criação inválida:', subscription.created_date);\n      }\n    }\n    \n    // Se ainda não tiver data válida, usar hoje + 30 dias (fallback)\n    if (!endDate) {\n      endDate = new Date(today);\n      endDate.setMonth(endDate.getMonth() + 1);\n    }\n    \n    // Calcular dias restantes e formatar data\n    daysRemaining = differenceInDays(endDate, today);\n    isExpiringSoon = daysRemaining <= 7;\n    nextBillingDate = format(endDate, \"dd 'de' MMMM 'de' yyyy\", { locale: pt });\n  }\n\n  return (\n    <div className=\"bg-gradient-to-br from-slate-50 via-blue-50 to-sky-50 p-4\">\n      <div className=\"max-w-4xl mx-auto\">\n        <Button\n          variant=\"outline\"\n          onClick={() => navigate(createPageUrl(\"BusinessDashboard\"))}\n          className=\"mb-6\"\n        >\n          <ArrowLeft className=\"w-4 h-4 mr-2\" />\n          {txtBack}\n        </Button>\n\n        <div className=\"mb-6\">\n          <h1 className=\"text-4xl font-bold text-slate-900 mb-2\">\n            {txtBusinessSubscription}\n          </h1>\n          <p className=\"text-slate-600\">{txtManagePlan}</p>\n        </div>\n\n        {/* Banner de Trial */}\n        {isTrialing && trialDaysRemaining >= 0 && (\n          <Card className=\"border-2 border-green-300 bg-gradient-to-r from-green-50 to-emerald-50 mb-6\">\n            <CardContent className=\"p-6\">\n              <div className=\"flex items-start gap-3\">\n                <CheckCircle2 className=\"w-6 h-6 text-green-600 flex-shrink-0 mt-0.5\" />\n                <div className=\"flex-1\">\n                  <h3 className=\"font-bold text-green-900 mb-2\">🎉 {txtFreeTrialActive}</h3>\n                  <p className=\"text-green-800 text-sm mb-2\">\n                    {txtTestingPlanFree} \n                    {txtTrialEndsIn} <strong>{trialEndFormatted}</strong> ({trialDaysRemaining} {trialDaysRemaining === 1 ? txtDayRemaining : txtDaysRemaining}).\n                  </p>\n                  <p className=\"text-green-700 text-xs\">\n                    {txtAfterTrial}. \n                    {txtCancelAnytime}.\n                  </p>\n                </div>\n              </div>\n            </CardContent>\n          </Card>\n        )}\n\n        {/* Alerta de Cancelamento */}\n        {isCancelled && (\n          <Card className=\"border-2 border-amber-300 bg-gradient-to-r from-amber-50 to-orange-50 mb-6\">\n            <CardContent className=\"p-6\">\n              <div className=\"flex items-start gap-3\">\n                <AlertTriangle className=\"w-6 h-6 text-amber-600 flex-shrink-0 mt-0.5\" />\n                <div>\n                  <h3 className=\"font-bold text-amber-900 mb-2\">{txtSubscriptionCancelled}</h3>\n                  <p className=\"text-amber-800 text-sm mb-3\">\n                    {isTrialing ? (\n                      <>\n                        {txtAccessUntilTrial}. \n                        {txtAccessUntil} <strong>{nextBillingDate}</strong> ({txtTrialEndPeriod}).\n                        {txtNoCharge}.\n                      </>\n                    ) : (\n                      <>\n                        {txtAccessUntil} <strong>{nextBillingDate}</strong>. \n                        {txtAfterDate}.\n                      </>\n                    )}\n                  </p>\n                  {/* 🍎🤖 B2B COMPLIANCE: Apps nativas redirecionam para website externo */}\n                  <div className=\"flex gap-3\">\n                    {isNativeApp ? (\n                      <Button\n                        onClick={handleExternalPurchase}\n                        className=\"bg-gradient-to-r from-green-600 to-emerald-600 hover:from-green-700 hover:to-emerald-700\"\n                      >\n                        <Globe className=\"w-4 h-4 mr-2\" />\n                        {txtVisitWebsite}\n                      </Button>\n                    ) : (\n                      <Button\n                        onClick={async () => {\n                          const confirmed = await confirm({\n                            title: txtReactivateQuestion,\n                            description: txtReactivateDescription,\n                            confirmText: txtYesReactivate,\n                            cancelText: txtCancel\n                          });\n                          \n                          if (confirmed) {\n                            reactivateMutation.mutate();\n                          }\n                        }}\n                        disabled={reactivateMutation.isPending}\n                        className=\"bg-gradient-to-r from-green-600 to-emerald-600 hover:from-green-700 hover:to-emerald-700\"\n                      >\n                        <Crown className=\"w-4 h-4 mr-2\" />\n                        {reactivateMutation.isPending ? txtReactivating : txtReactivateNow}\n                      </Button>\n                    )}\n                  </div>\n                </div>\n              </div>\n            </CardContent>\n          </Card>\n        )}\n\n        {/* Status Card */}\n        <Card className=\"border-0 shadow-xl mb-6\">\n          <CardContent className=\"p-8\">\n            <div className=\"flex items-start justify-between mb-6\">\n              <div className=\"flex items-center gap-4\">\n                <div className=\"w-16 h-16 rounded-2xl bg-gradient-to-br from-indigo-600 to-purple-600 flex items-center justify-center\">\n                  <Building2 className=\"w-8 h-8 text-white\" />\n                </div>\n                <div>\n                  <h3 className=\"text-2xl font-bold text-slate-900 mb-1\">\n                    {txtBusinessPlan}\n                  </h3>\n                  {isCancelled ? (\n                    <Badge className=\"bg-amber-100 text-amber-700 border-amber-200\">\n                      <AlertCircle className=\"w-3 h-3 mr-1\" />\n                      {txtCancelledAccessUntil} {nextBillingDate})\n                    </Badge>\n                  ) : (\n                    <Badge className=\"bg-green-100 text-green-700 border-green-200\">\n                      <CheckCircle2 className=\"w-3 h-3 mr-1\" />\n                      {txtActive}\n                    </Badge>\n                  )}\n                </div>\n              </div>\n              <div className=\"text-right\">\n                <div className=\"text-3xl font-bold text-slate-900\">€49,99</div>\n                <div className=\"text-sm text-slate-600\">{txtPerMonth}</div>\n              </div>\n            </div>\n\n            <div className=\"grid md:grid-cols-2 gap-6 mb-6\">\n              <div className=\"p-4 bg-slate-50 rounded-xl\">\n                <div className=\"flex items-center gap-2 mb-2\">\n                  <Calendar className=\"w-5 h-5 text-slate-600\" />\n                  <span className=\"text-sm text-slate-600\">{txtNextBilling}</span>\n                </div>\n                <div className=\"text-lg font-semibold text-slate-900\">\n                  {nextBillingDate}\n                </div>\n                {isExpiringSoon && (\n                  <div className=\"text-sm text-amber-600 mt-1\">\n                    {txtRenewsIn} {daysRemaining} {daysRemaining === 1 ? txtDay : txtDays}\n                  </div>\n                )}\n              </div>\n\n              <div className=\"p-4 bg-slate-50 rounded-xl\">\n                <div className=\"flex items-center gap-2 mb-2\">\n                  <CreditCard className=\"w-5 h-5 text-slate-600\" />\n                  <span className=\"text-sm text-slate-600\">{txtPaymentMethod}</span>\n                </div>\n                <div className=\"text-lg font-semibold text-slate-900\">\n                  {subscription.payment_method || 'Stripe'}\n                </div>\n                <div className=\"text-sm text-slate-500 mt-1\">\n                  {txtAutoRenewal}: {subscription.auto_renew ? txtActive : txtCancelled}\n                </div>\n              </div>\n            </div>\n\n            <div className=\"p-4 bg-gradient-to-br from-indigo-50 to-purple-50 rounded-xl border border-indigo-100\">\n              <h4 className=\"font-semibold text-slate-900 mb-3\">{txtFeaturesIncluded}:</h4>\n              <div className=\"grid md:grid-cols-2 gap-2\">\n                {subscription.features?.map((feature, idx) => (\n                  <div key={idx} className=\"flex items-center gap-2 text-sm text-slate-700\">\n                    <CheckCircle2 className=\"w-4 h-4 text-indigo-600 flex-shrink-0\" />\n                    {feature}\n                  </div>\n                )) || [\n                  txtUnlimitedQueues,\n                  txtAppointmentSys,\n                  txtAnalytics,\n                  txtAutoNotifications,\n                  txtPrioritySupportFeature\n                ].map((feature, idx) => (\n                  <div key={idx} className=\"flex items-center gap-2 text-sm text-slate-700\">\n                    <CheckCircle2 className=\"w-4 h-4 text-indigo-600 flex-shrink-0\" />\n                    {feature}\n                  </div>\n                ))}\n              </div>\n            </div>\n          </CardContent>\n        </Card>\n\n        {/* Billing History */}\n        <Card className=\"border-0 shadow-xl mb-6\">\n          <CardHeader>\n            <CardTitle>{txtBillingHistory}</CardTitle>\n          </CardHeader>\n          <CardContent>\n            <div className=\"space-y-3\">\n              <div className=\"flex justify-between items-center p-4 bg-slate-50 rounded-lg\">\n                <div>\n                  <div className=\"font-semibold text-slate-900\">\n                    {(() => {\n                      try {\n                        const startDate = subscription.start_date || subscription.created_date;\n                        if (!startDate) return txtDateNotAvailable;\n                        \n                        const date = new Date(startDate);\n                        return formatMonthYear(date);\n                      } catch (e) {\n                        console.warn('Erro ao formatar data de início:', e);\n                        return txtDateNotAvailable;\n                      }\n                    })()}\n                  </div>\n                  <div className=\"text-sm text-slate-600\">\n                    {txtBusinessPlan} • {txtMonthly}\n                  </div>\n                </div>\n                <div className=\"text-right\">\n                  <div className=\"font-bold text-slate-900\">\n                    {isTrialing ? '€0,00 EUR' : '€49,99'}\n                  </div>\n                  {isTrialing ? (\n                    <Badge className=\"bg-amber-100 text-amber-700 border-amber-200 mt-1\">\n                      {txtPending} €49,99\n                    </Badge>\n                  ) : (\n                    <Badge className=\"bg-green-100 text-green-700 border-green-200 mt-1\">\n                      {txtPaid}\n                    </Badge>\n                  )}\n                </div>\n              </div>\n            </div>\n          </CardContent>\n        </Card>\n\n        {/* 🌐 BOTÃO CANCELAR - SÓ APARECE NO WEBSITE (não em iOS/Android) */}\n        {!isCancelled && !Capacitor.isNativePlatform() && (\n          <Card className=\"border-2 border-red-200 bg-red-50/50 mb-6\">\n            <CardContent className=\"p-6\">\n              <div className=\"flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4\">\n                <div>\n                  <h4 className=\"font-semibold text-red-900 mb-1\">{txtCancelSubscription}</h4>\n                  <p className=\"text-sm text-red-700\">\n                    {isTrialing ? txtCancelFreeInTrial : txtOnCancelLoseAccess}\n                  </p>\n                </div>\n                <Button\n                  variant=\"outline\"\n                  className=\"border-red-300 text-red-700 hover:bg-red-100 hover:text-red-800 gap-2 whitespace-nowrap\"\n                  onClick={async () => {\n                    const endDateFormatted = isTrialing && trialEndDate \n                      ? trialEndFormatted \n                      : nextBillingDate;\n                    \n                    const confirmed = await confirm({\n                      title: txtConfirmCancelTitle,\n                      description: `${isTrialing ? txtConfirmCancelTrialDesc : txtConfirmCancelDesc} ${endDateFormatted}. ${txtWillNotBeCharged}. ${txtBasicPanelOnly}. ${txtReactivateFromPage}.`,\n                      confirmText: txtConfirmCancel,\n                      cancelText: txtCancel,\n                      variant: 'destructive'\n                    });\n                    \n                    if (confirmed) {\n                      cancelMutation.mutate();\n                    }\n                  }}\n                  disabled={cancelMutation.isPending}\n                >\n                  <XCircle className=\"w-4 h-4\" />\n                  {cancelMutation.isPending ? txtCancelling : txtCancelSubscription}\n                </Button>\n              </div>\n            </CardContent>\n          </Card>\n        )}\n\n      </div>\n      <ConfirmDialog />\n    </div>\n  );\n}","path":null,"size_bytes":31286,"size_tokens":null},"src/components/portal/TicketHistory.jsx":{"content":"import React, { useEffect } from \"react\";\nimport { useTranslation } from \"react-i18next\";\nimport { base44 } from \"@/api/base44Client\";\nimport { useQuery, useMutation, useQueryClient } from \"@tanstack/react-query\";\nimport { Link } from \"react-router-dom\";\nimport { createPageUrl } from \"@/utils\";\nimport { Card, CardContent } from \"@/components/ui/card\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Button } from \"@/components/ui/button\";\nimport { Tabs, TabsList, TabsTrigger, TabsContent } from \"@/components/ui/tabs\";\nimport { Clock, MapPin, Star, Eye, Loader2, Trash2 } from \"lucide-react\";\nimport { format } from \"date-fns\";\nimport { pt, enUS, de, es, fr, it, nl, pl, sv, da, nb, fi, cs, el, ro, hu, bg, hr, sk, sl, is, ja, th } from \"date-fns/locale\";\nimport { Skeleton } from \"@/components/ui/skeleton\";\nimport { toast } from \"sonner\";\nimport { useConfirm } from \"@/hooks/useConfirm\";\nimport { useAutoTranslate } from \"@/hooks/useTranslate\";\n\nexport default function TicketHistory({ user }) {\n  const { i18n } = useTranslation();\n  \n  const txtWaiting = useAutoTranslate('Aguardando', 'pt');\n  const txtCalled = useAutoTranslate('Chamado', 'pt');\n  const txtServing = useAutoTranslate('Em Atendimento', 'pt');\n  const txtCompleted = useAutoTranslate('Concluído', 'pt');\n  const txtCancelled = useAutoTranslate('Cancelado', 'pt');\n  const txtTicketRemoved = useAutoTranslate('senha removida', 'pt');\n  const txtTicketsRemoved = useAutoTranslate('senhas removidas', 'pt');\n  const txtErrorClearHistory = useAutoTranslate('Erro ao limpar histórico', 'pt');\n  const txtClearTicketHistory = useAutoTranslate('Limpar Histórico de Senhas', 'pt');\n  const txtConfirmClearTickets = useAutoTranslate('Tem a certeza que deseja limpar', 'pt');\n  const txtConfirmClearAction = useAutoTranslate('Sim, limpar histórico', 'pt');\n  const txtCancel = useAutoTranslate('Cancelar', 'pt');\n  const txtBusiness = useAutoTranslate('Empresa', 'pt');\n  const txtQueue = useAutoTranslate('Fila', 'pt');\n  const txtPosition = useAutoTranslate('Posição', 'pt');\n  const txtEstimatedTime = useAutoTranslate('Tempo estimado', 'pt');\n  const txtMinutes = useAutoTranslate('min', 'pt');\n  const txtYourRating = useAutoTranslate('A sua avaliação', 'pt');\n  const txtViewDetails = useAutoTranslate('Ver Detalhes', 'pt');\n  const txtActive = useAutoTranslate('Ativas', 'pt');\n  const txtHistory = useAutoTranslate('Histórico', 'pt');\n  const txtNoActiveTickets = useAutoTranslate('Sem senhas ativas', 'pt');\n  const txtGetTicketPrompt = useAutoTranslate('Tire uma senha para aparecer aqui', 'pt');\n  const txtNoHistory = useAutoTranslate('Sem histórico', 'pt');\n  const txtCompletedTicketsAppearHere = useAutoTranslate('As senhas concluídas aparecerão aqui', 'pt');\n  const txtClearing = useAutoTranslate('A limpar...', 'pt');\n  const txtClearHistory = useAutoTranslate('Limpar Histórico', 'pt');\n  const txtToleranceTime = useAutoTranslate('Tolerância', 'pt');\n  const txtYouWillBeCalled = useAutoTranslate('Será chamado', 'pt');\n  \n  const getDateLocale = () => {\n    const lang = i18n.language.split('-')[0];\n    const localeMap = { \n      pt, en: enUS, de, es, fr, it, nl, pl, sv, da, no: nb, fi, cs, el, ro, hu, bg, hr, sk, sl, is, ja, th\n    };\n    return localeMap[lang] || enUS;\n  };\n  \n  const statusConfig = {\n    aguardando: { icon: Clock, color: \"bg-blue-100 text-blue-700 border-blue-200\", label: txtWaiting },\n    chamado: { icon: Clock, color: \"bg-amber-100 text-amber-700 border-amber-200\", label: txtCalled },\n    atendendo: { icon: Loader2, color: \"bg-purple-100 text-purple-700 border-purple-200\", label: txtServing },\n    concluido: { icon: Star, color: \"bg-green-100 text-green-700 border-green-200\", label: txtCompleted },\n    cancelado: { icon: Clock, color: \"bg-red-100 text-red-700 border-red-200\", label: txtCancelled }\n  };\n  const queryClient = useQueryClient();\n  const { ConfirmDialog, confirm } = useConfirm();\n\n  const { data: tickets, isLoading } = useQuery({\n    queryKey: ['customer-tickets', user?.email],\n    queryFn: () => base44.entities.Ticket.filter({ user_email: user.email }, '-created_date'),\n    initialData: [],\n    refetchInterval: 5000,\n    enabled: !!user?.email,\n  });\n\n  const { data: businesses } = useQuery({\n    queryKey: ['businesses-list'],\n    queryFn: () => base44.entities.Business.list(),\n    initialData: [],\n  });\n\n  const { data: queues } = useQuery({\n    queryKey: ['queues-list'],\n    queryFn: () => base44.entities.Queue.list(),\n    initialData: [],\n  });\n\n  const expireTicketsMutation = useMutation({\n    mutationFn: async (ticketIds) => {\n      for (const ticketId of ticketIds) {\n        await base44.entities.Ticket.update(ticketId, {\n          status: 'concluido',\n          completed_at: new Date().toISOString()\n        });\n      }\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['customer-tickets'] });\n    }\n  });\n\n  const clearHistoryMutation = useMutation({\n    mutationFn: async () => {\n      const ticketsToDelete = tickets.filter(t => \n        t && ['concluido', 'cancelado'].includes(t.status)\n      );\n      \n      for (const ticket of ticketsToDelete) {\n        await base44.entities.Ticket.delete(ticket.id);\n      }\n      \n      return ticketsToDelete.length;\n    },\n    onSuccess: (count) => {\n      queryClient.invalidateQueries({ queryKey: ['customer-tickets'] });\n      const message = count === 1 ? txtTicketRemoved : txtTicketsRemoved;\n      toast.success(`${count} ${message}`);\n    },\n    onError: () => {\n      toast.error(txtErrorClearHistory);\n    }\n  });\n\n  const handleClearHistory = async () => {\n    const confirmed = await confirm({\n      title: txtClearTicketHistory,\n      description: `${txtConfirmClearTickets} ${historyTickets.length} senhas?`,\n      confirmText: txtConfirmClearAction,\n      cancelText: txtCancel\n    });\n\n    if (confirmed) {\n      clearHistoryMutation.mutate();\n    }\n  };\n\n  useEffect(() => {\n    if (!tickets?.length || !queues?.length) return;\n\n    const checkExpiredTickets = async () => {\n      const now = new Date();\n      const expiredTicketIds = [];\n\n      for (const ticket of tickets) {\n        if (!ticket || !['aguardando', 'chamado', 'atendendo'].includes(ticket.status)) continue;\n\n        const queue = queues.find(q => q && q.id === ticket.queue_id);\n        if (!queue) continue;\n\n        if (ticket.status === 'chamado' && ticket.called_at) {\n          const calledAt = new Date(ticket.called_at);\n          const toleranceMs = (queue.tolerance_time || 15) * 60 * 1000;\n          if (now - calledAt > toleranceMs) {\n            expiredTicketIds.push(ticket.id);\n          }\n        }\n\n        if (ticket.status === 'aguardando' && ticket.ticket_number < queue.current_number) {\n          expiredTicketIds.push(ticket.id);\n        }\n\n        if (ticket.status === 'atendendo' && ticket.called_at) {\n          const startedAt = new Date(ticket.called_at);\n          const serviceTimeMs = (queue.average_service_time || 10) * 60 * 1000;\n          const toleranceMs = (queue.tolerance_time || 15) * 60 * 1000;\n          const totalAllowedMs = serviceTimeMs + toleranceMs;\n          \n          if (now - startedAt > totalAllowedMs) {\n            expiredTicketIds.push(ticket.id);\n          }\n        }\n      }\n\n      if (expiredTicketIds.length > 0) {\n        expireTicketsMutation.mutate(expiredTicketIds);\n      }\n    };\n\n    checkExpiredTickets();\n    const interval = setInterval(checkExpiredTickets, 5000);\n\n    return () => clearInterval(interval);\n  }, [tickets, queues, expireTicketsMutation]);\n\n  const activeTickets = tickets.filter(t => t && ['aguardando', 'chamado', 'atendendo'].includes(t.status));\n  const historyTickets = tickets.filter(t => t && ['concluido', 'cancelado'].includes(t.status));\n\n  const getBusinessName = (businessId) => {\n    if (!businessId) return txtBusiness;\n    const business = businesses.find(b => b && (b.id === businessId || String(b.id) === String(businessId)));\n    return business?.name || txtBusiness;\n  };\n\n  const getQueueName = (queueId) => {\n    if (!queueId) return txtQueue;\n    const queue = queues.find(q => q && (q.id === queueId || String(q.id) === String(queueId)));\n    return queue?.name || txtQueue;\n  };\n\n  const TicketCard = ({ ticket }) => {\n    if (!ticket) return null;\n    \n    const status = statusConfig[ticket.status];\n    const StatusIcon = status.icon;\n    const queue = queues.find(q => q && q.id === ticket.queue_id);\n    const toleranceTime = queue?.tolerance_time || 0;\n\n    return (\n      <Card className=\"border-0 shadow-lg hover:shadow-xl transition-all\">\n        <CardContent className=\"p-6\">\n          <div className=\"flex justify-between items-start mb-4\">\n            <div>\n              <div className=\"text-4xl font-bold text-sky-600 mb-1\">\n                #{ticket.ticket_number}\n              </div>\n              <div className=\"flex items-center gap-2 text-slate-600\">\n                <MapPin className=\"w-4 h-4\" />\n                <span className=\"font-semibold\">{getBusinessName(ticket.business_id)}</span>\n              </div>\n              <p className=\"text-sm text-slate-500\">{getQueueName(ticket.queue_id)}</p>\n            </div>\n            <Badge className={status.color}>\n              <StatusIcon className=\"w-3 h-3 mr-1\" />\n              {status.label}\n            </Badge>\n          </div>\n\n          {ticket.status === 'aguardando' && (\n            <div className=\"mb-4 p-3 bg-blue-50 rounded-lg\">\n              <p className=\"text-sm text-blue-800\">\n                <span className=\"font-semibold\">{txtPosition}:</span> {ticket.position || '...'}\n              </p>\n              <p className=\"text-sm text-blue-800\">\n                <span className=\"font-semibold\">{txtEstimatedTime}:</span> ~{ticket.estimated_time || '...'} {txtMinutes}\n              </p>\n              {toleranceTime > 0 && (\n                <p className=\"text-sm text-blue-800\">\n                  <span className=\"font-semibold\">{txtToleranceTime}:</span> {toleranceTime} {txtMinutes}\n                </p>\n              )}\n            </div>\n          )}\n\n          {ticket.status === 'chamado' && (\n            <div className=\"mb-4 p-3 bg-amber-50 rounded-lg border border-amber-200\">\n              <p className=\"text-sm text-amber-800 font-semibold\">\n                🔔 {txtYouWillBeCalled}!\n              </p>\n              {toleranceTime > 0 && (\n                <p className=\"text-xs text-amber-700 mt-1\">\n                  {txtToleranceTime}: {toleranceTime} {txtMinutes}\n                </p>\n              )}\n            </div>\n          )}\n\n          {ticket.rating && (\n            <div className=\"mb-4 flex items-center gap-2\">\n              <div className=\"flex\">\n                {[1, 2, 3, 4, 5].map(star => (\n                  <Star\n                    key={star}\n                    className={`w-4 h-4 ${star <= ticket.rating ? 'fill-amber-400 text-amber-400' : 'text-slate-300'}`}\n                  />\n                ))}\n              </div>\n              <span className=\"text-sm text-slate-600\">{txtYourRating}</span>\n            </div>\n          )}\n\n          <div className=\"flex justify-between items-center pt-4 border-t\">\n            <span className=\"text-xs text-slate-500\">\n              {format(new Date(ticket.created_date), \"dd MMMM, HH:mm\", { locale: getDateLocale() })}\n            </span>\n            <Link to={createPageUrl(`TicketView?id=${ticket.id}`)}>\n              <Button size=\"sm\" variant=\"outline\">\n                <Eye className=\"w-4 h-4 mr-2\" />\n                {txtViewDetails}\n              </Button>\n            </Link>\n          </div>\n        </CardContent>\n      </Card>\n    );\n  };\n\n  if (isLoading) {\n    return (\n      <div className=\"grid md:grid-cols-2 gap-6\">\n        {[1, 2, 3, 4].map(i => <Skeleton key={i} className=\"h-64\" />)}\n      </div>\n    );\n  }\n\n  return (\n    <Tabs defaultValue=\"active\">\n      <TabsList className=\"bg-white border border-slate-200 mb-6\">\n        <TabsTrigger value=\"active\">\n          {txtActive} ({activeTickets.length})\n        </TabsTrigger>\n        <TabsTrigger value=\"history\">\n          {txtHistory} ({historyTickets.length})\n        </TabsTrigger>\n      </TabsList>\n\n      <TabsContent value=\"active\">\n        {activeTickets.length === 0 ? (\n          <Card className=\"border-0 shadow-lg\">\n            <CardContent className=\"py-16 text-center\">\n              <Clock className=\"w-16 h-16 text-slate-400 mx-auto mb-4\" />\n              <h3 className=\"text-xl font-bold text-slate-900 mb-2\">\n                {txtNoActiveTickets}\n              </h3>\n              <p className=\"text-slate-600\">\n                {txtGetTicketPrompt}\n              </p>\n            </CardContent>\n          </Card>\n        ) : (\n          <div className=\"grid md:grid-cols-2 gap-6\">\n            {activeTickets.map(ticket => (\n              <TicketCard key={ticket.id} ticket={ticket} />\n            ))}\n          </div>\n        )}\n      </TabsContent>\n\n      <TabsContent value=\"history\">\n        {historyTickets.length === 0 ? (\n          <Card className=\"border-0 shadow-lg\">\n            <CardContent className=\"py-16 text-center\">\n              <Clock className=\"w-16 h-16 text-slate-400 mx-auto mb-4\" />\n              <h3 className=\"text-xl font-bold text-slate-900 mb-2\">\n                {txtNoHistory}\n              </h3>\n              <p className=\"text-slate-600\">\n                {txtCompletedTicketsAppearHere}\n              </p>\n            </CardContent>\n          </Card>\n        ) : (\n          <div className=\"space-y-4\">\n            <div className=\"flex justify-end\">\n              <Button\n                variant=\"outline\"\n                size=\"sm\"\n                onClick={handleClearHistory}\n                disabled={clearHistoryMutation.isPending}\n                className=\"border-red-200 text-red-600 hover:bg-red-50\"\n              >\n                <Trash2 className=\"w-4 h-4 mr-2\" />\n                {clearHistoryMutation.isPending ? txtClearing : txtClearHistory}\n              </Button>\n            </div>\n            <div className=\"grid md:grid-cols-2 gap-6\">\n              {historyTickets.map(ticket => (\n                <TicketCard key={ticket.id} ticket={ticket} />\n              ))}\n            </div>\n          </div>\n        )}\n      </TabsContent>\n      <ConfirmDialog />\n    </Tabs>\n  );\n}","path":null,"size_bytes":14340,"size_tokens":null},"src/pages/Layout.jsx":{"content":"\nimport React from \"react\";\nimport { Link, useLocation, useNavigate } from \"react-router-dom\";\nimport { createPageUrl } from \"@/utils\";\nimport { base44 } from \"@/api/base44Client\";\nimport { Home, Clock, Building2, User, LogOut, RefreshCw, Calendar, Menu, MessageSquare, LayoutDashboard, History } from \"lucide-react\";\nimport { Button } from \"@/components/ui/button\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Sheet, SheetContent, SheetTrigger, SheetTitle, SheetDescription } from \"@/components/ui/sheet\";\nimport { VisuallyHidden } from \"@radix-ui/react-visually-hidden\";\nimport { LanguageSelector } from \"@/components/settings/LanguageSelector\";\nimport { MobileBottomNav } from \"@/components/navigation/MobileBottomNav\";\nimport { useBusinessAccess } from \"@/hooks/useBusinessAccess\";\nimport { useUser } from \"@/contexts/UserContext\";\nimport { useAutoTranslate } from \"@/hooks/useTranslate\";\nimport { usePushNotifications } from \"@/hooks/usePushNotifications\";\n\n// Lista centralizada de páginas empresariais\nconst BUSINESS_PAGES = [\n  'Onboarding',\n  'BusinessSubscription',\n  'BusinessProfileSetup',\n  'BusinessHome',\n  'BusinessDashboard',\n  'BusinessQueues',\n  'BusinessServices',\n  'BusinessSettings',\n  'BusinessSupport',\n  'BusinessStaff',\n  'BusinessManageSubscription',\n  'Profile'\n];\n\nfunction LayoutContent({ children, currentPageName }) {\n  const location = useLocation();\n  const navigate = useNavigate();\n  \n  const txtDashboard = useAutoTranslate('Dashboard', 'en');\n  const txtQueues = useAutoTranslate('Queues', 'en');\n  const txtAppointments = useAutoTranslate('Appointments', 'en');\n  const txtSettings = useAutoTranslate('Settings', 'en');\n  const txtPortal = useAutoTranslate('Portal', 'en');\n  const txtBusinesses = useAutoTranslate('Businesses', 'en');\n  const txtBusiness = useAutoTranslate('Business', 'en');\n  const txtNoQueues = useAutoTranslate('No queues', 'en');\n  const txtProfile = useAutoTranslate('Profile', 'en');\n  const txtSupport = useAutoTranslate('Suporte', 'pt');\n  const txtLogout = useAutoTranslate('Log out', 'en');\n  const txtLoading = useAutoTranslate('Loading...', 'en');\n  \n  // 🎯 CONTEXTO COMPARTILHADO: Uma única fonte de verdade para user (elimina chamadas duplicadas)\n  const { user, loading: loadingUser, error: userError, authFailed, logout: contextLogout } = useUser();\n  \n  const [currentMode, setCurrentMode] = React.useState('pessoal');\n  const [mobileMenuOpen, setMobileMenuOpen] = React.useState(false);\n  const [headerVisible, setHeaderVisible] = React.useState(true);\n  const [lastScrollY, setLastScrollY] = React.useState(0);\n  const [isRedirecting, setIsRedirecting] = React.useState(false);\n  \n  // 🔓 ADMIN OVERRIDE: Hook consome user do contexto (sem chamadas duplicadas)\n  const { hasActiveSubscription, loading: loadingAccess } = useBusinessAccess();\n  \n  // 📱 PUSH NOTIFICATIONS: Inicializar notificações push para dispositivos nativos (iOS/Android)\n  const { isSupported: pushSupported, isEnabled: pushEnabled } = usePushNotifications();\n\n  React.useEffect(() => {\n    // 🚨 CRÍTICO: Se autenticação falhou após todas tentativas, redirecionar para login\n    // ✅ MAS APENAS se não estamos já na página de login/register (prevenir loop infinito!)\n    // ✅ USAR startsWith para suportar query strings (ex: /login?lang=en)\n    const publicPaths = ['/login', '/register', '/reset-password', '/request-password-reset'];\n    const isOnPublicPage = publicPaths.some(path => location.pathname.startsWith(path));\n    \n    if (!loadingUser && authFailed && !isOnPublicPage) {\n      console.log('❌ Layout: Autenticação falhou após todas tentativas - redirecionando para login');\n      navigate(createPageUrl('Login'), { replace: true });\n      return;\n    }\n    \n    // 🎯 User agora vem do contexto - apenas aplicar lógica de navegação\n    if (loadingUser || !user) {\n      return;\n    }\n    \n    const accountType = user.account_type || 'pessoal';\n        \n        // ⚠️ CRÍTICO: PREVENIR LOOPS - Nunca redirecionar se já estamos nas páginas de setup\n        // BusinessProfileSetup e BusinessSubscription têm sua própria lógica de redirecionamento\n        const onboardingPages = ['Onboarding', 'BusinessProfileSetup', 'BusinessSubscription', 'PaymentSuccess'];\n        \n        // 🔐 PROTEÇÃO DUPLA: Verificar tanto por currentPageName quanto por pathname\n        // Essencial para Safari iOS mobile onde currentPageName pode não estar sincronizado\n        const isOnboardingPage = onboardingPages.includes(currentPageName) || \n          location.pathname.includes('/business-subscription') ||\n          location.pathname.includes('/business-profile-setup') ||\n          location.pathname.includes('/onboarding') ||\n          location.pathname.includes('/payment-success');\n        \n        if (isOnboardingPage) {\n          console.log('🔒 Layout: Página de onboarding detectada (nome ou path), pulando guards:', currentPageName, location.pathname);\n          setCurrentMode(accountType === 'empresa' ? 'empresa' : 'pessoal');\n          setIsRedirecting(false);\n          return;\n        }\n        \n    // ✅ ONBOARDING PESSOAL: Apenas para contas pessoais OU empresariais sem subscrição ativa\n    // Utilizadores empresariais com subscrição ativa não precisam completar perfil pessoal\n    const isBusinessAccountWithSubscription = \n      accountType === 'empresa' && \n      user.has_business_subscription;\n    \n    if (!user.onboarding_completed && !isBusinessAccountWithSubscription) {\n      setIsRedirecting(true);\n      navigate(createPageUrl('Onboarding'));\n      return;\n    }\n    \n    // CONTA EMPRESARIAL\n    const isBusinessAccount = accountType === 'empresa';\n    \n    if (isBusinessAccount) {\n      setCurrentMode('empresa');\n      \n      // GUARD CONSOLIDADO: Uma única verificação sequencial\n      // 1. Se não tem perfil → ProfileSetup\n      // 2. Senão, se não tem subscrição ATIVA (verifica currentPeriodEnd) → Subscription\n      // 3. Senão, permitir acesso\n      \n      // Perfil está completo se business_id existe (já foi linkado a um company profile)\n      const needsProfile = !user.business_id;\n      // ✅ CORRIGIDO: Usar hasActiveSubscription (verifica currentPeriodEnd para cancelados)\n      const needsSubscription = !needsProfile && !hasActiveSubscription && !user.has_business_subscription;\n          \n          // Páginas protegidas que exigem subscrição ativa\n          const protectedPages = [\n            'BusinessDashboard', 'BusinessQueues', 'BusinessServices', \n            'BusinessSupport', 'BusinessStaff', 'BusinessManageSubscription'\n          ];\n          \n          // Páginas que permitem acesso sem subscrição (home, settings, perfil)\n          const allowedWithoutSubscription = ['BusinessHome', 'BusinessSettings', 'Profile'];\n          \n          if (needsProfile) {\n            console.log('🚫 Layout: Perfil incompleto, redirecionando para ProfileSetup');\n            setIsRedirecting(true);\n            navigate(createPageUrl('BusinessProfileSetup'));\n            return;\n          }\n          \n          if (needsSubscription && protectedPages.includes(currentPageName)) {\n            console.log('🚫 Layout: Subscrição necessária para', currentPageName, '- redirecionando');\n            setIsRedirecting(true);\n            navigate(createPageUrl('BusinessSubscription'));\n            return;\n          }\n          \n          // 🚨 PROTEÇÃO ANTI-LOOP CRÍTICA (Safari iOS + Produção)\n          // NUNCA confiar em currentPageName (não-confiável em build produção!)\n          // Usar APENAS location.pathname que é sempre preciso\n          const isOnBusinessRoute = location.pathname.startsWith('/business-');\n          const isOnPublicRoute = ['/', '/login', '/home'].includes(location.pathname);\n          \n          // ⚠️ NUNCA redirecionar se acabou de vir de /register (prevenir loop no mobile)\n          const isComingFromRegister = location.pathname === '/register';\n          \n          // Se está numa rota pública mas é utilizador empresarial → redirecionar para BusinessHome\n          // MAS APENAS se não está a vir de registo (dá tempo para o onboarding carregar)\n          if (isOnPublicRoute && !isComingFromRegister) {\n            console.log('📍 Layout: Utilizador empresarial em rota pública, redirecionando para BusinessHome');\n            setIsRedirecting(true);\n            navigate(createPageUrl('BusinessHome'));\n            return;\n          }\n          \n      // Se JÁ está numa rota business, NUNCA redirecionar (prevenir loop!)\n      if (isOnBusinessRoute) {\n        console.log('✅ Layout: Utilizador empresarial já numa rota /business-*, permitindo acesso');\n        // Não redirecionar - está onde deve estar\n      }\n    } \n    // CONTA PESSOAL\n    else {\n      setCurrentMode('pessoal');\n    }\n    \n    setIsRedirecting(false);\n  }, [user, loadingUser, navigate, currentPageName]);\n\n  React.useEffect(() => {\n    const controlHeader = () => {\n      const currentScrollY = window.scrollY;\n      \n      if (currentScrollY < lastScrollY || currentScrollY < 10) {\n        setHeaderVisible(true);\n      } else if (currentScrollY > lastScrollY && currentScrollY > 50) {\n        setHeaderVisible(false);\n      }\n      \n      setLastScrollY(currentScrollY);\n    };\n\n    window.addEventListener('scroll', controlHeader);\n    return () => window.removeEventListener('scroll', controlHeader);\n  }, [lastScrollY]);\n\n  const isBusinessMode = currentMode === 'empresa' || user?.account_type === 'empresa';\n\n  // Mostrar loading se estiver a redirecionar ou ainda sem user\n  if (isRedirecting || !user) {\n    return (\n      <div className=\"min-h-screen flex items-center justify-center bg-gradient-to-br from-slate-50 to-blue-50\">\n        <div className=\"text-center\">\n          <div className=\"w-12 h-12 border-4 border-sky-500 border-t-transparent rounded-full animate-spin mx-auto mb-4\"></div>\n          <p className=\"text-slate-600\">{txtLoading}</p>\n        </div>\n      </div>\n    );\n  }\n\n  // Layout especial para páginas de subscrição/setup empresarial (sem navegação)\n  const isBusinessOnboarding = ['BusinessSubscription', 'BusinessProfileSetup'].includes(currentPageName);\n  \n  if (user?.account_type === 'empresa' && isBusinessOnboarding) {\n    return (\n      <div className=\"min-h-screen flex bg-gradient-to-br from-slate-50 to-blue-50\">\n        <main className=\"flex-1 flex flex-col animate-fade-in\">\n          <div className=\"flex-1 overflow-auto\">\n            {children}\n          </div>\n        </main>\n      </div>\n    );\n  }\n\n  // Definir itens de navegação baseado no modo e subscrição\n  let navigationItems;\n  \n  if (isBusinessMode) {\n    // 🔓 ADMIN OVERRIDE: Usar hasActiveSubscription do hook (inclui admin override)\n    // Em vez de user.has_business_subscription (apenas base de dados)\n    const hasSubscription = hasActiveSubscription || user?.has_business_subscription;\n    \n    if (hasSubscription) {\n      // Com subscrição OU admin override: mostrar todas as funcionalidades\n      navigationItems = [\n        { title: 'Home', url: createPageUrl(\"BusinessHome\"), icon: Home },\n        { title: txtDashboard, url: createPageUrl(\"BusinessDashboard\"), icon: LayoutDashboard },\n        { title: txtQueues, url: createPageUrl(\"BusinessQueues\"), icon: Clock },\n        { title: txtAppointments, url: createPageUrl(\"BusinessServices\"), icon: Calendar },\n        { title: txtSettings, url: createPageUrl(\"BusinessSettings\"), icon: Building2 }\n      ];\n    } else {\n      // Sem subscrição: apenas Home e Settings\n      navigationItems = [\n        { title: 'Home', url: createPageUrl(\"BusinessHome\"), icon: Home },\n        { title: txtSettings, url: createPageUrl(\"BusinessSettings\"), icon: Building2 }\n      ];\n    }\n  } else if (user) {\n    // Modo pessoal\n    navigationItems = [\n      { title: 'Home', url: createPageUrl(\"Home\"), icon: Home },\n      { title: txtPortal, url: createPageUrl(\"CustomerPortal\"), icon: User },\n      { title: txtBusinesses, url: createPageUrl(\"Businesses\"), icon: Building2 }\n    ];\n  } else {\n    // Não autenticado\n    navigationItems = [\n      { title: 'Home', url: createPageUrl(\"Home\"), icon: Home }\n    ];\n  }\n\n  const displayName = user?.nome_completo || user?.full_name || 'Utilizador';\n\n  const NavContent = () => (\n    <>\n      <div className={`p-3 lg:p-5 border-b animate-slide-in-down ${\n        isBusinessMode \n          ? 'bg-gradient-to-br from-indigo-600 to-purple-700' \n          : 'bg-gradient-to-br from-sky-500 to-blue-600'\n      }`}>\n        <div className=\"flex items-center gap-2 lg:gap-3\">\n          <div className=\"w-8 h-8 lg:w-12 lg:h-12 bg-white rounded-lg lg:rounded-xl flex items-center justify-center shadow-lg hover-lift\">\n            <Clock className={isBusinessMode ? 'w-5 h-5 lg:w-7 lg:h-7 text-indigo-600' : 'w-5 h-5 lg:w-7 lg:h-7 text-sky-600'} />\n          </div>\n          <div>\n            <h2 className=\"font-bold text-base lg:text-xl text-white\">QZero</h2>\n            <p className=\"text-xs lg:text-sm text-white/80\">\n              {isBusinessMode ? txtBusiness : txtNoQueues}\n            </p>\n          </div>\n        </div>\n      </div>\n\n      <nav className=\"flex-1 p-2 lg:p-4\">\n        <div className=\"space-y-1 lg:space-y-2\">\n          {navigationItems.map((item, idx) => (\n            <Link\n              key={item.title}\n              to={item.url}\n              onClick={() => setMobileMenuOpen(false)}\n              className={`flex items-center gap-2 lg:gap-3 px-3 lg:px-4 py-2 lg:py-3 rounded-lg lg:rounded-xl smooth-transition text-sm lg:text-base stagger-item ${\n                location.pathname === item.url \n                  ? 'bg-gradient-to-r from-sky-50 to-blue-50 text-sky-700 font-semibold shadow-sm' \n                  : 'hover:bg-slate-50 hover:scale-[1.02]'\n              }`}\n              style={{ animationDelay: `${idx * 0.05}s` }}\n            >\n              <item.icon className=\"w-4 h-4 lg:w-5 lg:h-5\" />\n              <span>{item.title}</span>\n            </Link>\n          ))}\n\n          {user && (\n            <>\n              <Link\n                to={createPageUrl(\"Profile\")}\n                onClick={() => setMobileMenuOpen(false)}\n                className={`flex items-center gap-2 lg:gap-3 px-3 lg:px-4 py-2 lg:py-3 rounded-lg lg:rounded-xl smooth-transition text-sm lg:text-base ${\n                  location.pathname === createPageUrl(\"Profile\") \n                    ? 'bg-gradient-to-r from-sky-50 to-blue-50 text-sky-700 font-semibold shadow-sm' \n                    : 'hover:bg-slate-50 hover:scale-[1.02]'\n                }`}\n              >\n                <User className=\"w-4 h-4 lg:w-5 lg:h-5\" />\n                <span>{txtProfile}</span>\n              </Link>\n\n              <Link\n                to={createPageUrl(isBusinessMode ? \"BusinessSupport\" : \"Support\")}\n                onClick={() => setMobileMenuOpen(false)}\n                className={`flex items-center gap-2 lg:gap-3 px-3 lg:px-4 py-2 lg:py-3 rounded-lg lg:rounded-xl smooth-transition text-sm lg:text-base ${\n                  location.pathname === createPageUrl(isBusinessMode ? \"BusinessSupport\" : \"Support\") \n                    ? 'bg-gradient-to-r from-sky-50 to-blue-50 text-sky-700 font-semibold shadow-sm' \n                    : 'hover:bg-slate-50 hover:scale-[1.02]'\n                }`}\n              >\n                <MessageSquare className=\"w-4 h-4 lg:w-5 lg:h-5\" />\n                <span>{txtSupport}</span>\n              </Link>\n            </>\n          )}\n        </div>\n      </nav>\n\n      <div className=\"p-2 lg:p-4 border-t\">\n        <LanguageSelector variant=\"outline\" />\n      </div>\n\n      {user && (\n        <div className=\"border-t p-3 lg:p-4 animate-slide-in-up\">\n          <div className=\"flex items-center gap-2 lg:gap-3 mb-2 lg:mb-3\">\n            <div className={`w-8 h-8 lg:w-12 lg:h-12 rounded-full flex items-center justify-center shadow-md relative smooth-transition hover:scale-110 ${\n              isBusinessMode \n                ? 'bg-gradient-to-br from-indigo-400 to-purple-500'\n                : 'bg-gradient-to-br from-sky-400 to-blue-500'\n            }`}>\n              <span className=\"text-white font-bold text-xs lg:text-base\">{displayName[0] || user.email[0].toUpperCase()}</span>\n              {isBusinessMode && (\n                <div className=\"absolute -top-0.5 -right-0.5 w-4 h-4 lg:w-5 lg:h-5 bg-gradient-to-br from-indigo-500 to-purple-600 rounded-full flex items-center justify-center border-2 border-white animate-pulse-slow\">\n                  <Building2 className=\"w-2.5 h-2.5 lg:w-3 lg:h-3 text-white\" />\n                </div>\n              )}\n            </div>\n            <div className=\"flex-1 min-w-0\">\n              <p className=\"font-semibold text-xs lg:text-sm truncate\">{displayName}</p>\n              <p className=\"text-xs lg:text-sm text-slate-500 truncate\">{user.email}</p>\n            </div>\n          </div>\n          <Button \n            variant=\"outline\" \n            size=\"sm\" \n            className=\"w-full justify-start gap-2 hover:bg-red-50 hover:text-red-600 h-8 lg:h-10 text-sm lg:text-base smooth-transition hover:scale-[1.02]\"\n            onClick={() => base44.auth.logout()}\n          >\n            <LogOut className=\"w-3.5 h-3.5 lg:w-4 lg:h-4\" />\n            {txtLogout}\n          </Button>\n        </div>\n      )}\n    </>\n  );\n\n  return (\n    <div className=\"min-h-screen flex bg-gradient-to-br from-slate-50 to-blue-50\">\n      <aside className=\"hidden lg:flex lg:flex-col lg:w-72 xl:w-80 border-r border-slate-200/60 bg-white shadow-sm animate-slide-in-left\">\n        <NavContent />\n      </aside>\n\n      <header className={`lg:hidden fixed top-0 left-0 right-0 z-50 glass-effect border-b border-slate-200/60 px-3 py-2.5 transition-transform duration-300 ${\n        headerVisible ? 'translate-y-0' : '-translate-y-full'\n      }`}>\n        <div className=\"flex items-center justify-between\">\n          <div className=\"flex items-center gap-1.5\">\n            <Clock className=\"w-4 h-4 text-sky-600\" />\n            <h1 className=\"text-base font-bold text-slate-900\">QZero</h1>\n          </div>\n          {isBusinessMode && user && (\n            <Badge className=\"bg-gradient-to-r from-indigo-600 to-purple-700 text-white border-0 text-xs px-2 py-0.5 animate-scale-in\">\n              <Building2 className=\"w-3 h-3 mr-1\" />\n              B2B\n            </Badge>\n          )}\n        </div>\n      </header>\n\n      <main className=\"flex-1 flex flex-col lg:pt-0 pt-12 pb-20 lg:pb-0 min-h-0 animate-fade-in\">\n        <div className=\"flex-1 overflow-auto min-h-0\">\n          {children}\n        </div>\n      </main>\n\n      {/* Menu inferior mobile - estilo Instagram */}\n      <MobileBottomNav isBusinessMode={isBusinessMode} user={user} isRedirecting={isRedirecting} />\n    </div>\n  );\n}\n\nexport default function Layout({ children, currentPageName }) {\n  return <LayoutContent children={children} currentPageName={currentPageName} />;\n}\n","path":null,"size_bytes":19004,"size_tokens":null},"src/api/base44Client.js":{"content":"// ============================================================================\n// QZero - Sistema de Gestão de Filas (Standalone)\n// ============================================================================\n// Sistema completo e independente que usa dados locais persistidos via API.\n// Não requer Base44 ou outras dependências externas.\n// Dados são armazenados localmente e via backend /api/demo/*\n// ============================================================================\n\n// 🔒 PRODUÇÃO: Apenas logs em desenvolvimento\nconst IS_DEV = import.meta.env.DEV;\n\nif (IS_DEV) {\n  console.log('🚀 QZero - Sistema Standalone Iniciado');\n  console.log('💡 Dados são salvos localmente. Para limpar tudo: clearAllMockData()');\n}\n\n// ============================================================================\n// API CLIENT - Persistência via backend local\n// ============================================================================\n\n// ✅ CONFIGURAÇÃO API - SUPORTA WEB E CAPACITOR (Android/iOS)\n// Detecta se está a correr no Capacitor (app nativa) ou no browser\n// Capacitor: Usa URL completo do servidor de produção\n// Web: Usa same-origin para evitar bloqueios CSP\n\n// Detectar Capacitor (Android/iOS app)\nconst isCapacitor = typeof window !== 'undefined' && \n  (window.Capacitor !== undefined || \n   window.location.protocol === 'capacitor:' ||\n   window.location.protocol === 'ionic:' ||\n   window.location.protocol === 'file:' ||\n   (window.location.hostname === 'localhost' && window.navigator.userAgent.includes('Android')) ||\n   window.navigator.userAgent.includes('Capacitor'));\n\n// ✅ CONFIGURAÇÃO DE URLs\n// Produção: https://waitless-qzero.com (domínio personalizado)\n// Replit Published: URL do Replit quando publicado\n// Desenvolvimento: URL do Replit dev\nconst PRODUCTION_API_URL = 'https://waitless-qzero.com';\nconst REPLIT_PUBLISHED_URL = 'https://q-zero-afonsomarques80.replit.app';\n\n// ✅ DETECTAR URL DA API PARA CAPACITOR\n// Ordem de prioridade:\n// 1. VITE_API_URL (definido na build)\n// 2. Domínio de produção (se build de produção)\n// 3. URL do Replit publicado (fallback seguro)\nconst getApiUrl = () => {\n  // 1. URL configurado manualmente (maior prioridade)\n  if (import.meta.env.VITE_API_URL) {\n    return import.meta.env.VITE_API_URL;\n  }\n  \n  // 2. Em produção (build com npm run build)\n  if (import.meta.env.PROD) {\n    // Usar URL do Replit publicado como fallback seguro\n    // (funciona mesmo que waitless-qzero.com não esteja configurado)\n    return REPLIT_PUBLISHED_URL;\n  }\n  \n  // 3. Fallback para URL publicado do Replit\n  return REPLIT_PUBLISHED_URL;\n};\n\n// API_BASE: URL completo para Capacitor, vazio para same-origin na web\nconst API_BASE = isCapacitor ? getApiUrl() : '';\n\n// ✅ FUNÇÃO PARA VERIFICAR SE RESPOSTA É HTML (ERRO)\nasync function parseJsonOrThrow(response, endpoint) {\n  // Lidar com respostas 204 No Content ou respostas vazias\n  if (response.status === 204 || response.headers.get('content-length') === '0') {\n    return undefined;\n  }\n  \n  const contentType = response.headers.get('content-type') || '';\n  \n  // Se não é JSON, provavelmente é uma página de erro HTML\n  if (!contentType.includes('application/json')) {\n    const text = await response.text();\n    \n    // Resposta vazia é válida para alguns endpoints\n    if (!text || text.trim() === '') {\n      return undefined;\n    }\n    \n    // Detectar HTML (erro comum: servidor retorna 404 HTML)\n    if (text.includes('<!DOCTYPE') || text.includes('<html')) {\n      console.error('❌ API ERROR: Servidor retornou HTML em vez de JSON');\n      console.error('📍 Endpoint:', endpoint);\n      console.error('🔍 Content-Type:', contentType);\n      console.error('📄 Primeiros 200 chars:', text.substring(0, 200));\n      \n      throw new Error(\n        `API indisponível: O servidor em ${API_BASE || window.location.origin} não está respondendo corretamente. ` +\n        `Verifique se o servidor está publicado e acessível.`\n      );\n    }\n    \n    // Tentar parsear mesmo assim (alguns servidores não enviam content-type correto)\n    try {\n      return JSON.parse(text);\n    } catch (e) {\n      // Se for texto simples, retornar como objeto\n      return { message: text };\n    }\n  }\n  \n  // Tentar parsear JSON de forma segura\n  try {\n    const text = await response.text();\n    if (!text || text.trim() === '') {\n      return undefined;\n    }\n    return JSON.parse(text);\n  } catch (e) {\n    console.warn('⚠️ Erro ao parsear JSON:', e.message);\n    return undefined;\n  }\n}\n\nif (IS_DEV) {\n  console.log('📱 Ambiente detectado:', isCapacitor ? 'CAPACITOR (App Nativa)' : 'WEB (Browser)');\n  console.log('🌐 API_BASE:', API_BASE || '(same-origin)');\n  console.log('🔧 VITE_API_URL:', import.meta.env.VITE_API_URL || '(não definido)');\n  console.log('🏭 import.meta.env.PROD:', import.meta.env.PROD);\n}\n\n// ============================================================================\n// 🍪 SAFARI iOS FIX: Fallback para localStorage quando cookies bloqueados\n// Safari bloqueia cookies em iframes (Replit preview), então usamos\n// localStorage como fallback + Authorization header\n// ============================================================================\nconst AUTH_TOKEN_KEY = 'qzero_auth_token';\n\nfunction getAuthToken() {\n  try {\n    return localStorage.getItem(AUTH_TOKEN_KEY);\n  } catch (e) {\n    return null;\n  }\n}\n\nfunction clearAuthToken() {\n  try {\n    localStorage.removeItem(AUTH_TOKEN_KEY);\n    console.log('🗑️ Token removido do localStorage');\n  } catch (e) {\n    console.warn('⚠️ Erro ao remover token:', e);\n  }\n}\n\nfunction getAuthHeaders(additionalHeaders = {}) {\n  const headers = { ...additionalHeaders };\n  const token = getAuthToken();\n  if (token) {\n    headers['Authorization'] = `Bearer ${token}`;\n  }\n  return headers;\n}\n\nfunction getAuthFetchOptions(options = {}) {\n  const token = getAuthToken();\n  const fetchOptions = {\n    ...options,\n    credentials: 'include',\n  };\n  if (token) {\n    fetchOptions.headers = {\n      ...fetchOptions.headers,\n      'Authorization': `Bearer ${token}`,\n    };\n  }\n  return fetchOptions;\n}\n\n// 🔍 DEBUG: Log da configuração da API (apenas em desenvolvimento)\nif (IS_DEV) {\n  console.log('🔧 base44Client API CONFIG:', {\n    'API_BASE': API_BASE || '(same origin)',\n    'window.location.origin': window.location.origin,\n    'Exemplo URL': `${window.location.origin}/api/auth/me`\n  });\n}\n\n// ✅ FUNÇÃO HELPER: Processa resposta e lança erro se não OK\n// Evita consumir o body duas vezes usando clone() ou parseamento único\nasync function handleResponse(response, endpoint) {\n  // Parsear o body uma única vez\n  const data = await parseJsonOrThrow(response, endpoint);\n  \n  // Se resposta não é OK, lançar erro com dados parseados\n  if (!response.ok) {\n    const errorMessage = data?.message || data?.error || `API error: ${response.status} ${response.statusText}`;\n    throw new Error(errorMessage);\n  }\n  \n  return data;\n}\n\nconst demoAPI = {\n  async get(endpoint, params = {}) {\n    const fullUrl = `${API_BASE}${endpoint}`;\n    const url = new URL(fullUrl, window.location.origin);\n    Object.keys(params).forEach(key => {\n      if (params[key] !== undefined && params[key] !== null) {\n        url.searchParams.append(key, params[key]);\n      }\n    });\n    try {\n      const response = await fetch(url, {\n        credentials: 'include',\n        headers: { 'Content-Type': 'application/json' }\n      });\n      return await handleResponse(response, endpoint);\n    } catch (error) {\n      console.error(`❌ demoAPI.get(${endpoint}) failed:`, error);\n      throw error;\n    }\n  },\n  \n  async post(endpoint, data) {\n    try {\n      const response = await fetch(`${API_BASE}${endpoint}`, {\n        method: 'POST',\n        credentials: 'include',\n        headers: { 'Content-Type': 'application/json' },\n        body: JSON.stringify(data)\n      });\n      return await handleResponse(response, endpoint);\n    } catch (error) {\n      console.error(`❌ demoAPI.post(${endpoint}) failed:`, error);\n      throw error;\n    }\n  },\n  \n  async put(endpoint, data) {\n    try {\n      const response = await fetch(`${API_BASE}${endpoint}`, {\n        method: 'PUT',\n        credentials: 'include',\n        headers: { 'Content-Type': 'application/json' },\n        body: JSON.stringify(data)\n      });\n      return await handleResponse(response, endpoint);\n    } catch (error) {\n      console.error(`❌ demoAPI.put(${endpoint}) failed:`, error);\n      throw error;\n    }\n  },\n  \n  async delete(endpoint) {\n    try {\n      const response = await fetch(`${API_BASE}${endpoint}`, {\n        method: 'DELETE',\n        credentials: 'include',\n        headers: { 'Content-Type': 'application/json' }\n      });\n      return await handleResponse(response, endpoint);\n    } catch (error) {\n      console.error(`❌ demoAPI.delete(${endpoint}) failed:`, error);\n      throw error;\n    }\n  }\n};\n\n// 🔒 FUNÇÕES DE DEBUG - APENAS EM DESENVOLVIMENTO\n// ⚠️ CRÍTICO: Estas funções NÃO são expostas em produção para prevenir manipulação de dados\nif (IS_DEV) {\n  // Função para limpar TODOS os dados mock\n  window.clearAllMockData = function() {\n    console.log('🧹 Limpando TODOS os dados...');\n    localStorage.clear();\n    console.log('✅ Dados limpos! Recarregando...');\n    alert('✅ Dados limpos!\\n\\nRecarregando...');\n    setTimeout(() => window.location.reload(), 300);\n  };\n\n  // Função para criar NOVA CONTA (simula novo utilizador)\n  window.createNewAccount = function(options = {}) {\n    const newUser = {\n      id: `user_${Date.now()}`,\n      name: options.name || 'Novo Utilizador',\n      email: options.email || `user${Date.now()}@example.com`,\n      account_type: options.account_type || null,\n      onboarding_completed: false,\n      has_business_subscription: false,\n      business_profile_completed: false,\n      business_id: null,\n      is_business_user: false,\n      country: 'PT',\n      city: options.city || 'Lisboa',\n      latitude: 38.7223,\n      longitude: -9.1393,\n      profile_completed: false\n    };\n    \n    console.log('🧹 Limpando dados antigos...');\n    localStorage.clear();\n    \n    console.log('👤 Criando nova conta:', newUser.email);\n    localStorage.setItem('mock_user', JSON.stringify(newUser));\n    \n    alert('✅ Nova conta criada!\\n\\nEmail: ' + newUser.email + '\\n\\nRecarregando...');\n    \n    setTimeout(() => {\n      window.location.reload();\n    }, 300);\n  };\n  \n  console.log('🛠️ Funções de debug disponíveis: clearAllMockData(), createNewAccount()');\n}\n\n\n// Migração automática: Corrige tickets com status inválido\nfunction migrateTicketStatuses() {\n  const stored = localStorage.getItem('mock_tickets');\n  if (!stored) return;\n  \n  const tickets = JSON.parse(stored);\n  let migrated = 0;\n  let attendingMigrated = 0;\n  \n  const updated = tickets.map(ticket => {\n    const updatedTicket = { ...ticket };\n    \n    // Corrige status 'aberta' (de fila) para 'aguardando' (de senha)\n    if (ticket.status === 'aberta') {\n      updatedTicket.status = 'aguardando';\n      migrated++;\n      console.log(`🔧 Migrado ticket ${ticket.id}: status 'aberta' → 'aguardando'`);\n    }\n    \n    // Adiciona attending_started_at para tickets em atendimento sem timestamp\n    if (ticket.status === 'atendendo' && !ticket.attending_started_at) {\n      updatedTicket.attending_started_at = new Date().toISOString();\n      attendingMigrated++;\n      console.log(`⏰ Migrado ticket ${ticket.id}: adicionado attending_started_at`);\n    }\n    \n    return updatedTicket;\n  });\n  \n  if (migrated > 0 || attendingMigrated > 0) {\n    localStorage.setItem('mock_tickets', JSON.stringify(updated));\n    console.log(`✅ Migração concluída: ${migrated} tickets com status corrigido, ${attendingMigrated} com timestamp adicionado`);\n  }\n}\n\n// Executa migração ao carregar\nmigrateTicketStatuses();\n\nconsole.log('💡 Para limpar TODOS os dados e começar do zero, execute no console: clearAllMockData()');\n\n// Função para criar utilizador padrão (novo utilizador sem onboarding)\nfunction createDefaultUser() {\n  return {\n    id: `user_${Date.now()}`,\n    name: 'Novo Utilizador',\n    email: `user${Date.now()}@example.com`,\n    account_type: null,\n    onboarding_completed: false,\n    has_business_subscription: false,\n    business_profile_completed: false,\n    business_id: null,\n    is_business_user: false,\n    country: 'PT',\n    city: 'Lisboa',\n    latitude: 38.7223,\n    longitude: -9.1393,\n    profile_completed: false\n  };\n}\n\n// Utilizador inicial (será substituído pelos dados do localStorage)\nlet mockUser = createDefaultUser();\n\nconst mockBusinesses = [\n  {\n    id: '1',\n    name: 'Clínica Saúde+',\n    description: 'Clínica médica com especialidades diversas',\n    address: 'Rua das Flores, 123, Lisboa, Portugal',\n    logo_url: '',\n    is_active: true,\n    rating: 4.5,\n    owner_email: 'demo@example.com',\n    email: 'contato@clinicasaude.com',\n    phone: '+351 123 456 789',\n    sms_gateway: 'none',\n    subscription_status: 'active',\n    subscription_plan: 'professional',\n    latitude: 38.7223,\n    longitude: -9.1393,\n    category: 'saude'\n  },\n  {\n    id: '2',\n    name: 'Restaurante Sabor',\n    description: 'Cozinha portuguesa tradicional',\n    address: 'Avenida Central, 45, Porto, Portugal',\n    logo_url: '',\n    is_active: true,\n    rating: 4.8,\n    latitude: 41.1579,\n    longitude: -8.6291,\n    category: 'restauracao'\n  },\n  {\n    id: '3',\n    name: 'Banco Digital',\n    description: 'Serviços bancários modernos',\n    address: 'Praça do Comércio, 1, Lisboa, Portugal',\n    logo_url: '',\n    is_active: true,\n    rating: 4.2,\n    latitude: 38.7078,\n    longitude: -9.1365,\n    category: 'financas'\n  }\n];\n\n// Create a comprehensive mock client (para modo demo)\nconst mockBase44Client = {\n  auth: {\n    me: async () => {\n      try {\n        const endpoint = '/api/auth/me';\n        const response = await fetch(`${API_BASE}${endpoint}`, getAuthFetchOptions());\n        \n        if (!response.ok) {\n          // Tentar obter mensagem de erro do servidor\n          const errorData = await parseJsonOrThrow(response, endpoint).catch(() => null);\n          throw new Error(errorData?.message || 'Not authenticated');\n        }\n        \n        const user = await parseJsonOrThrow(response, endpoint);\n        \n        // ✅ USAR VALORES DO BACKEND (já calculados corretamente)\n        const formattedUser = {\n          id: user.id,\n          email: user.email,\n          name: user.full_name,\n          full_name: user.full_name,\n          nome_completo: user.full_name,\n          account_type: user.account_type,\n          onboarding_completed: user.onboarding_completed,  // Do backend\n          has_business_subscription: user.has_business_subscription,  // Do backend (calculado dinamicamente)\n          business_profile_completed: !!user.business_id,\n          business_id: user.business_id,\n          is_business_user: user.is_business_user,\n          is_staff_member: user.is_staff_member,\n          staff_permissions: user.staff_permissions,\n          phone: user.phone,\n          birthdate: user.birthdate,\n          data_nascimento: user.birthdate,\n          country: user.country || 'PT',\n          city: user.city || 'Lisboa',\n          latitude: 38.7223,\n          longitude: -9.1393,\n          profile_completed: !!(user.full_name && user.phone),\n          created_date: user.createdAt || new Date().toISOString()\n        };\n        \n        mockUser = formattedUser;\n        return formattedUser;\n      } catch (error) {\n        throw error;\n      }\n    },\n    updateMe: async (updates) => {\n      try {\n        const updateData = {};\n        \n        // Aceitar tanto português quanto inglês\n        if (updates.name !== undefined) updateData.fullName = updates.name;\n        if (updates.nome_completo !== undefined) updateData.fullName = updates.nome_completo;\n        if (updates.fullName !== undefined) updateData.fullName = updates.fullName;\n        \n        if (updates.phone !== undefined) updateData.phone = updates.phone;\n        \n        if (updates.birthdate !== undefined) updateData.birthdate = updates.birthdate;\n        if (updates.data_nascimento !== undefined) updateData.birthdate = updates.data_nascimento;\n        \n        if (updates.is_business_user !== undefined) updateData.isBusinessUser = updates.is_business_user;\n        if (updates.business_id !== undefined) updateData.businessId = updates.business_id;\n        if (updates.staff_permissions !== undefined) updateData.staffPermissions = updates.staff_permissions;\n        if (updates.is_staff_member !== undefined) updateData.isStaffMember = updates.is_staff_member;\n        \n        // CRÍTICO: Mapear account_type para staff invites\n        if (updates.account_type !== undefined) updateData.accountType = updates.account_type;\n        \n        // Campos extras de localização\n        if (updates.country !== undefined) updateData.country = updates.country;\n        if (updates.city !== undefined) updateData.city = updates.city;\n        \n        if (updates.business_id && !updateData.isBusinessUser) {\n          updateData.isBusinessUser = true;\n        }\n        \n        const endpoint = '/api/auth/update-profile';\n        const response = await fetch(`${API_BASE}${endpoint}`, {\n          method: 'PUT',\n          ...getAuthFetchOptions({\n            headers: { 'Content-Type': 'application/json' },\n          }),\n          body: JSON.stringify(updateData)\n        });\n        \n        if (!response.ok) {\n          const errorData = await parseJsonOrThrow(response, endpoint).catch(() => null);\n          throw new Error(errorData?.message || 'Failed to update profile');\n        }\n        \n        const data = await parseJsonOrThrow(response, endpoint);\n        const user = data.user;\n        \n        // ✅ USAR VALORES DO BACKEND (já calculados corretamente)\n        const formattedUser = {\n          id: user.id,\n          email: user.email,\n          name: user.full_name,\n          full_name: user.full_name,\n          nome_completo: user.full_name,\n          account_type: user.account_type,\n          onboarding_completed: user.onboarding_completed,  // Do backend\n          has_business_subscription: user.has_business_subscription,  // Do backend (calculado dinamicamente)\n          business_profile_completed: !!user.business_id,\n          business_id: user.business_id,\n          is_business_user: user.is_business_user,\n          is_staff_member: user.is_staff_member,\n          staff_permissions: user.staff_permissions,\n          phone: user.phone,\n          birthdate: user.birthdate,\n          data_nascimento: user.birthdate,\n          country: user.country || 'PT',\n          city: user.city || 'Lisboa',\n          latitude: 38.7223,\n          longitude: -9.1393,\n          profile_completed: !!(user.full_name && user.phone),\n          created_date: user.created_at || new Date().toISOString()\n        };\n        \n        mockUser = formattedUser;\n        return formattedUser;\n      } catch (error) {\n        console.error('Error updating profile:', error);\n        throw error;\n      }\n    },\n    changePassword: async (currentPassword, newPassword) => {\n      try {\n        const endpoint = '/api/auth/change-password';\n        const response = await fetch(`${API_BASE}${endpoint}`, {\n          method: 'POST',\n          ...getAuthFetchOptions({\n            headers: { 'Content-Type': 'application/json' },\n          }),\n          body: JSON.stringify({ currentPassword, newPassword })\n        });\n        \n        const data = await parseJsonOrThrow(response, endpoint);\n        \n        if (!response.ok) {\n          throw new Error(data?.error || 'Erro ao alterar senha');\n        }\n        \n        return data;\n      } catch (error) {\n        console.error('Error changing password:', error);\n        throw error;\n      }\n    },\n    redirectToLogin: () => {\n      window.location.href = '/login';\n    },\n    logout: async () => {\n      try {\n        // 🧹 LIMPAR TUDO antes de fazer logout\n        try {\n          // Limpar sessionStorage (2FA login data)\n          sessionStorage.removeItem('2fa_login_email');\n          sessionStorage.removeItem('2fa_login_step');\n          sessionStorage.removeItem('2fa_challenge_token');\n          \n          // Limpar localStorage (cache de empresas, etc)\n          localStorage.removeItem('company_profiles');\n          localStorage.removeItem('businesses');\n          \n          console.log('🧹 SessionStorage e localStorage limpos no logout');\n        } catch (e) {\n          console.warn('⚠️ Erro ao limpar storage:', e);\n        }\n        \n        // 🔌 Chamar endpoint de logout (limpa cookies e DB)\n        await fetch(`${API_BASE}/api/auth/logout`, {\n          method: 'POST',\n          ...getAuthFetchOptions()\n        });\n        \n        // 🍪 SAFARI iOS FIX: Limpar token do localStorage\n        clearAuthToken();\n        \n        console.log('✅ Logout completo - redirecionando...');\n        window.location.href = '/login';\n      } catch (error) {\n        console.error('Logout error:', error);\n        // Mesmo com erro, redirecionar para login\n        window.location.href = '/login';\n      }\n    },\n    deleteAccount: async () => {\n      try {\n        // 🗑️ Eliminar conta permanentemente\n        const response = await fetch(`${API_BASE}/api/auth/delete-account`, {\n          method: 'DELETE',\n          ...getAuthFetchOptions()\n        });\n        \n        if (!response.ok) {\n          const data = await response.json().catch(() => ({}));\n          throw new Error(data.error || 'Erro ao eliminar conta');\n        }\n        \n        // 🧹 Limpar TUDO localmente\n        try {\n          sessionStorage.clear();\n          localStorage.clear();\n          console.log('🧹 Storage limpo após eliminação de conta');\n        } catch (e) {\n          console.warn('⚠️ Erro ao limpar storage:', e);\n        }\n        \n        // 🍪 Limpar token\n        clearAuthToken();\n        \n        console.log('✅ Conta eliminada - redirecionando...');\n        window.location.href = '/login';\n        \n        return { success: true };\n      } catch (error) {\n        console.error('Delete account error:', error);\n        throw error;\n      }\n    }\n  },\n  entities: {\n    Business: {\n      filter: async (filters = {}) => {\n        // ✅ BUSCAR DO POSTGRESQL (endpoint depende dos filtros)\n        try {\n          let endpoint = '/api/public/businesses';  // Default: empresas ativas públicas\n          let needsAuth = false;\n          \n          // Se filtrar por owner_id, usar endpoint autenticado que retorna TODAS as empresas do owner (incluindo inativas)\n          if (filters.owner_id !== undefined) {\n            endpoint = '/api/company-profiles/my-businesses';\n            needsAuth = true;\n          }\n          \n          const fetchOptions = needsAuth ? getAuthFetchOptions() : {};\n          const response = await fetch(endpoint, fetchOptions);\n          \n          if (!response.ok) {\n            console.warn('⚠️ Erro ao buscar empresas do PostgreSQL');\n            return [];\n          }\n          \n          let businesses = await response.json();\n          \n          // Aplicar filtros client-side se necessário\n          if (filters.id !== undefined) {\n            businesses = businesses.filter(b => b.id === filters.id);\n          }\n          \n          // ✅ Servidor já envia campos normalizados - apenas pass-through\n          return businesses.map(b => ({\n            id: b.id,\n            name: b.name || b.companyName || '',\n            description: b.description || b.companyDescription || '',\n            address: b.address || b.companyAddress || '',\n            logo_url: b.logo_url || b.logoUrl || '',\n            is_active: b.is_active !== undefined ? b.is_active : b.status === 'active',\n            rating: b.rating || 4.5,\n            owner_id: b.owner_id || b.admin_user_id,\n            email: b.email || b.companyEmail || '',\n            phone: b.phone || b.companyPhone || '',\n            category: b.category || b.companyCategory || '',\n            latitude: b.latitude || b.companyCoordinates?.lat || 0,\n            longitude: b.longitude || b.companyCoordinates?.lng || 0,\n            media_gallery: b.media_gallery || b.mediaGallery || [],\n            subscription_status: b.subscription_status || 'active',\n            subscription_plan: 'professional'\n          }));\n        } catch (error) {\n          console.error('❌ Erro ao buscar empresas:', error);\n          return [];\n        }\n      },\n      get: async (id) => {\n        try {\n          const response = await fetch(`/api/company-profiles/${id}`, getAuthFetchOptions());\n          if (!response.ok) return null;\n          \n          const b = await response.json();\n          \n          // ✅ Servidor pode enviar campos normalizados ou originais\n          return {\n            id: b.id,\n            name: b.name || b.companyName || '',\n            description: b.description || b.companyDescription || '',\n            address: b.address || b.companyAddress || '',\n            logo_url: b.logo_url || b.logoUrl || '',\n            is_active: b.is_active !== undefined ? b.is_active : b.status === 'active',\n            rating: b.rating || 4.5,\n            owner_id: b.owner_id || b.admin_user_id,\n            email: b.email || b.companyEmail || '',\n            phone: b.phone || b.companyPhone || '',\n            category: b.category || b.companyCategory || '',\n            latitude: b.latitude || b.companyCoordinates?.lat || 0,\n            longitude: b.longitude || b.companyCoordinates?.lng || 0,\n            media_gallery: b.media_gallery || b.mediaGallery || [],\n            subscription_status: b.subscription_status || 'active',\n            subscription_plan: 'professional'\n          };\n        } catch (error) {\n          console.error('❌ Erro ao buscar empresa:', error);\n          return null;\n        }\n      },\n      list: async () => {\n        // Mesmo que filter sem filtros\n        return await mockBase44Client.entities.Business.filter({});\n      },\n      update: async (id, data) => {\n        // ✅ ATUALIZAR NO POSTGRESQL via company-profiles\n        try {\n          const response = await fetch(`${API_BASE}/api/company-profiles/${id}`, {\n            method: 'PUT',\n            ...getAuthFetchOptions({\n              headers: { 'Content-Type': 'application/json' },\n            }),\n            body: JSON.stringify(data)\n          });\n          \n          if (!response.ok) {\n            throw new Error('Failed to update business');\n          }\n          \n          return await response.json();\n        } catch (error) {\n          console.error('❌ Erro ao atualizar empresa:', error);\n          throw error;\n        }\n      },\n      create: async (data) => {\n        // ✅ CRIAR NO POSTGRESQL via company-profiles\n        try {\n          const response = await fetch(`${API_BASE}/api/company-profiles`, {\n            method: 'POST',\n            ...getAuthFetchOptions({\n              headers: { 'Content-Type': 'application/json' },\n            }),\n            body: JSON.stringify(data)\n          });\n          \n          if (!response.ok) {\n            throw new Error('Failed to create business');\n          }\n          \n          return await response.json();\n        } catch (error) {\n          console.error('❌ Erro ao criar empresa:', error);\n          throw error;\n        }\n      }\n    },\n    Queue: {\n      filter: async (filters = {}) => {\n        const params = {};\n        if (filters.business_id) params.business_id = filters.business_id;\n        if (filters.is_active !== undefined) params.is_active = filters.is_active;\n        if (filters.id) params.id = filters.id;\n        \n        const queues = await demoAPI.get('/api/demo/queues', params);\n        return queues;\n      },\n      create: async (data) => {\n        const queue = await demoAPI.post('/api/demo/queues', data);\n        return queue;\n      },\n      update: async (id, data) => {\n        const updated = await demoAPI.put(`/api/demo/queues/${id}`, data);\n        return updated;\n      },\n      delete: async (id) => {\n        await demoAPI.delete(`/api/demo/queues/${id}`);\n        return { success: true };\n      }\n    },\n    Service: {\n      filter: async (filters = {}) => {\n        const params = {};\n        if (filters.id) params.id = filters.id;\n        if (filters.business_id) params.business_id = filters.business_id;\n        if (filters.is_active !== undefined) params.is_active = filters.is_active;\n        \n        const services = await demoAPI.get('/api/demo/services', params);\n        return services;\n      },\n      create: async (data) => {\n        const service = await demoAPI.post('/api/demo/services', data);\n        return service;\n      },\n      update: async (id, data) => {\n        const updated = await demoAPI.put(`/api/demo/services/${id}`, data);\n        return updated;\n      },\n      delete: async (id) => {\n        await demoAPI.delete(`/api/demo/services/${id}`);\n        return { success: true };\n      }\n    },\n    Ticket: {\n      filter: async (filters = {}) => {\n        const params = {};\n        if (filters.id) params.id = filters.id;\n        if (filters.user_email) params.user_email = filters.user_email;\n        if (filters.queue_id) params.queue_id = filters.queue_id;\n        if (filters.business_id) params.business_id = filters.business_id;\n        if (filters.status && filters.status.$in) {\n          params.status = filters.status.$in.join(',');\n        }\n        \n        return await demoAPI.get('/api/demo/tickets', params);\n      },\n      \n      list: async () => {\n        return await demoAPI.get('/api/demo/tickets');\n      },\n      \n      create: async (data) => {\n        return await demoAPI.post('/api/demo/tickets', data);\n      },\n      \n      update: async (id, data) => {\n        return await demoAPI.put(`/api/demo/tickets/${id}`, data);\n      },\n      \n      delete: async (id) => {\n        await demoAPI.delete(`/api/demo/tickets/${id}`);\n        return { success: true };\n      }\n    },\n    Appointment: {\n      filter: async (filters = {}) => {\n        const params = {};\n        if (filters.user_email) params.user_email = filters.user_email;\n        if (filters.business_id) params.business_id = filters.business_id;\n        if (filters.status && filters.status.$in) {\n          params.status = filters.status.$in.join(',');\n        }\n        \n        const appointments = await demoAPI.get('/api/demo/appointments', params);\n        return appointments;\n      },\n      list: async () => {\n        const appointments = await demoAPI.get('/api/demo/appointments');\n        return appointments;\n      },\n      create: async (data) => {\n        const appointment = await demoAPI.post('/api/demo/appointments', data);\n        return appointment;\n      },\n      update: async (id, data) => {\n        const updated = await demoAPI.put(`/api/demo/appointments/${id}`, data);\n        return updated;\n      },\n      delete: async (id) => {\n        await demoAPI.delete(`/api/demo/appointments/${id}`);\n        return { success: true };\n      }\n    },\n    Review: {\n      filter: async (filters = {}) => {\n        const params = {};\n        if (filters.business_id) params.business_id = filters.business_id;\n        if (filters.user_email) params.user_email = filters.user_email;\n        \n        const reviews = await demoAPI.get('/api/demo/reviews', params);\n        return reviews;\n      },\n      list: async () => {\n        const reviews = await demoAPI.get('/api/demo/reviews');\n        return reviews;\n      },\n      create: async (data) => {\n        const review = await demoAPI.post('/api/demo/reviews', data);\n        return review;\n      },\n      update: async (id, data) => {\n        const updated = await demoAPI.put(`/api/demo/reviews/${id}`, data);\n        return updated;\n      },\n      delete: async (id) => {\n        await demoAPI.delete(`/api/demo/reviews/${id}`);\n        return { success: true };\n      }\n    },\n    Subscription: {\n      filter: (filters = {}) => {\n        console.log('Mock: Filtering subscriptions', filters);\n        const stored = JSON.parse(localStorage.getItem('mock_subscriptions') || '[]');\n        let filtered = stored;\n        \n        if (filters.user_email) {\n          filtered = filtered.filter(s => s.user_email === filters.user_email);\n        }\n        if (filters.plan) {\n          filtered = filtered.filter(s => s.plan === filters.plan);\n        }\n        if (filters.status) {\n          filtered = filtered.filter(s => s.status === filters.status);\n        }\n        \n        return Promise.resolve(filtered);\n      },\n      create: (data) => {\n        console.log('Mock: Creating subscription', data);\n        const newSubscription = {\n          id: `sub_${Date.now()}`,\n          ...data,\n          created_date: new Date().toISOString()\n        };\n        \n        const stored = JSON.parse(localStorage.getItem('mock_subscriptions') || '[]');\n        stored.push(newSubscription);\n        localStorage.setItem('mock_subscriptions', JSON.stringify(stored));\n        \n        return Promise.resolve(newSubscription);\n      },\n      update: (id, data) => {\n        console.log('Mock: Updating subscription', id, data);\n        const stored = JSON.parse(localStorage.getItem('mock_subscriptions') || '[]');\n        const index = stored.findIndex(s => s.id === id);\n        \n        if (index !== -1) {\n          stored[index] = { ...stored[index], ...data };\n          localStorage.setItem('mock_subscriptions', JSON.stringify(stored));\n          return Promise.resolve(stored[index]);\n        }\n        \n        return Promise.reject(new Error('Subscription not found'));\n      }\n    },\n    StaffInvite: {\n      filter: async (filters = {}) => {\n        const params = {};\n        if (filters.business_id) params.business_id = filters.business_id;\n        if (filters.email) params.email = filters.email;\n        if (filters.status) params.status = filters.status;\n        if (filters.token) params.token = filters.token;\n        \n        const invites = await demoAPI.get('/api/demo/staff-invites', params);\n        return invites;\n      },\n      create: async (data) => {\n        const invite = await demoAPI.post('/api/demo/staff-invites', data);\n        return invite;\n      },\n      update: async (id, data) => {\n        const updated = await demoAPI.put(`/api/demo/staff-invites/${id}`, data);\n        return updated;\n      },\n      delete: async (id) => {\n        await demoAPI.delete(`/api/demo/staff-invites/${id}`);\n        return { success: true };\n      }\n    },\n    SupportMessage: {\n      filter: async (filters = {}) => {\n        const params = {};\n        if (filters.business_id) params.business_id = filters.business_id;\n        if (filters.user_email) params.user_email = filters.user_email;\n        if (filters.status) params.status = filters.status;\n        \n        const messages = await demoAPI.get('/api/demo/support-messages', params);\n        return messages;\n      },\n      create: async (data) => {\n        const message = await demoAPI.post('/api/demo/support-messages', data);\n        return message;\n      },\n      update: async (id, data) => {\n        const updated = await demoAPI.put(`/api/demo/support-messages/${id}`, data);\n        return updated;\n      },\n      delete: async (id) => {\n        await demoAPI.delete(`/api/demo/support-messages/${id}`);\n        return { success: true };\n      }\n    },\n    User: {\n      filter: async (filters = {}) => {\n        const params = {};\n        if (filters.business_id) params.business_id = filters.business_id;\n        if (filters.is_staff_member !== undefined) params.is_staff_member = filters.is_staff_member;\n        if (filters.email) params.email = filters.email;\n        \n        const users = await demoAPI.get('/api/demo/users', params);\n        return users;\n      },\n      update: async (id, data) => {\n        const updated = await demoAPI.put(`/api/demo/users/${id}`, data);\n        return updated;\n      },\n      delete: async (id) => {\n        await demoAPI.delete(`/api/demo/users/${id}`);\n        return { success: true };\n      }\n    }\n  },\n  // Add any other methods that might be called\n  functions: {},\n  integrations: {\n    Core: {\n      SendEmail: (data) => {\n        console.log('Mock: Sending email', data);\n        return Promise.resolve({ success: true, message: 'Email enviado (simulado)' });\n      },\n      UploadFile: async ({ file }) => {\n        console.log('📤 Uploading file:', file.name, file.size, 'bytes');\n        \n        // 1. Tentar Object Storage primeiro (persistente)\n        try {\n          const uploadUrlResponse = await fetch(`${API_BASE}/api/objects/upload`, {\n            method: 'POST',\n            ...getAuthFetchOptions({\n              headers: { 'Content-Type': 'application/json' },\n            }),\n            body: JSON.stringify({ filename: file.name })\n          });\n          \n          if (uploadUrlResponse.ok) {\n            const { uploadURL, objectPath } = await uploadUrlResponse.json();\n            \n            // Upload direto para Object Storage via presigned URL\n            const uploadResponse = await fetch(uploadURL, {\n              method: 'PUT',\n              headers: { 'Content-Type': file.type || 'application/octet-stream' },\n              body: file\n            });\n            \n            if (uploadResponse.ok) {\n              console.log('✅ Upload concluído (Object Storage):', objectPath);\n              return { file_url: objectPath };\n            }\n            \n            console.warn('⚠️ Object Storage upload failed, falling back to local');\n          } else {\n            const errorData = await uploadUrlResponse.json().catch(() => ({}));\n            if (errorData.fallback) {\n              console.log('ℹ️ Object Storage não configurado, usando upload local');\n            } else {\n              console.warn('⚠️ Object Storage indisponível, usando fallback');\n            }\n          }\n        } catch (error) {\n          console.warn('⚠️ Object Storage erro:', error.message);\n        }\n        \n        // 2. Fallback: Upload local\n        const formData = new FormData();\n        formData.append('file', file);\n        \n        const response = await fetch(`${API_BASE}/api/upload`, {\n          method: 'POST',\n          ...getAuthFetchOptions(),\n          body: formData\n        });\n        \n        if (!response.ok) {\n          const error = await response.json();\n          throw new Error(error.error || 'Erro ao fazer upload do ficheiro');\n        }\n        \n        const data = await response.json();\n        console.log('✅ Upload concluído (local):', data.file_url);\n        \n        return { file_url: data.file_url };\n      },\n      DeleteFile: async ({ fileUrl }) => {\n        console.log('🗑️ Deleting file:', fileUrl);\n        \n        const response = await fetch(`${API_BASE}/api/delete-image`, {\n          method: 'DELETE',\n          ...getAuthFetchOptions({\n            headers: { 'Content-Type': 'application/json' },\n          }),\n          body: JSON.stringify({ fileUrl })\n        });\n        \n        if (!response.ok) {\n          const error = await response.json();\n          throw new Error(error.error || 'Erro ao apagar o ficheiro');\n        }\n        \n        const data = await response.json();\n        console.log('✅ Ficheiro apagado:', fileUrl);\n        \n        return data;\n      }\n    }\n  }\n};\n\n// ============================================================================\n// EXPORT - Cliente único para todo o sistema\n// ============================================================================\n\n// Exporta o client local (mock) como client padrão\nexport const base44 = mockBase44Client;\n\nconsole.log('✅ QZero Client inicializado - Sistema standalone ativo');\n","path":null,"size_bytes":39929,"size_tokens":null},"src/components/ui/drawer.jsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport { Drawer as DrawerPrimitive } from \"vaul\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Drawer = ({\n  shouldScaleBackground = true,\n  ...props\n}) => (\n  <DrawerPrimitive.Root shouldScaleBackground={shouldScaleBackground} {...props} />\n)\nDrawer.displayName = \"Drawer\"\n\nconst DrawerTrigger = DrawerPrimitive.Trigger\n\nconst DrawerPortal = DrawerPrimitive.Portal\n\nconst DrawerClose = DrawerPrimitive.Close\n\nconst DrawerOverlay = React.forwardRef(({ className, ...props }, ref) => (\n  <DrawerPrimitive.Overlay\n    ref={ref}\n    className={cn(\"fixed inset-0 z-50 bg-black/80\", className)}\n    {...props} />\n))\nDrawerOverlay.displayName = DrawerPrimitive.Overlay.displayName\n\nconst DrawerContent = React.forwardRef(({ className, children, ...props }, ref) => (\n  <DrawerPortal>\n    <DrawerOverlay />\n    <DrawerPrimitive.Content\n      ref={ref}\n      className={cn(\n        \"fixed inset-x-0 bottom-0 z-50 mt-24 flex h-auto flex-col rounded-t-[10px] border bg-background\",\n        className\n      )}\n      {...props}>\n      <div className=\"mx-auto mt-4 h-2 w-[100px] rounded-full bg-muted\" />\n      {children}\n    </DrawerPrimitive.Content>\n  </DrawerPortal>\n))\nDrawerContent.displayName = \"DrawerContent\"\n\nconst DrawerHeader = ({\n  className,\n  ...props\n}) => (\n  <div\n    className={cn(\"grid gap-1.5 p-4 text-center sm:text-left\", className)}\n    {...props} />\n)\nDrawerHeader.displayName = \"DrawerHeader\"\n\nconst DrawerFooter = ({\n  className,\n  ...props\n}) => (\n  <div className={cn(\"mt-auto flex flex-col gap-2 p-4\", className)} {...props} />\n)\nDrawerFooter.displayName = \"DrawerFooter\"\n\nconst DrawerTitle = React.forwardRef(({ className, ...props }, ref) => (\n  <DrawerPrimitive.Title\n    ref={ref}\n    className={cn(\"text-lg font-semibold leading-none tracking-tight\", className)}\n    {...props} />\n))\nDrawerTitle.displayName = DrawerPrimitive.Title.displayName\n\nconst DrawerDescription = React.forwardRef(({ className, ...props }, ref) => (\n  <DrawerPrimitive.Description\n    ref={ref}\n    className={cn(\"text-sm text-muted-foreground\", className)}\n    {...props} />\n))\nDrawerDescription.displayName = DrawerPrimitive.Description.displayName\n\nexport {\n  Drawer,\n  DrawerPortal,\n  DrawerOverlay,\n  DrawerTrigger,\n  DrawerClose,\n  DrawerContent,\n  DrawerHeader,\n  DrawerFooter,\n  DrawerTitle,\n  DrawerDescription,\n}\n","path":null,"size_bytes":2359,"size_tokens":null},"src/pages/BusinessDetail.jsx":{"content":"import React, { useState, useEffect } from \"react\";\nimport { base44 } from \"@/api/base44Client\";\nimport { useQuery, useMutation, useQueryClient } from \"@tanstack/react-query\";\nimport { Button } from \"@/components/ui/button\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { useNavigate } from \"react-router-dom\";\nimport { createPageUrl } from \"@/utils\";\nimport { getUploadUrl, safeFetch } from \"@/utils/apiConfig\";\nimport {\n  ArrowLeft,\n  Clock,\n  Users,\n  CheckCircle2,\n  AlertCircle,\n  Sparkles,\n  Info,\n  Star,\n  MessageSquare,\n  Search,\n  Calendar,\n  ChevronLeft,\n  ChevronRight,\n  Play\n} from \"lucide-react\";\nimport { Skeleton } from \"@/components/ui/skeleton\";\nimport AppointmentBooking from \"../components/appointments/AppointmentBooking\";\nimport BusinessInfo from \"../components/business/BusinessInfo\";\nimport Reviews from \"../components/business/Reviews\";\nimport { Tabs, TabsList, TabsTrigger, TabsContent } from \"@/components/ui/tabs\";\nimport { TranslatedText } from \"@/components/translation/TranslatedText\";\nimport { toast } from \"sonner\";\nimport { Input } from \"@/components/ui/input\";\nimport { validateQueueOperating } from \"@/utils/queueValidation\";\nimport { checkAndResetQueueForNewDay } from \"@/utils/queueReset\";\nimport { useAutoTranslate } from \"@/hooks/useTranslate\";\n\nfunction useTranslations() {\n  const txtBack = useAutoTranslate('Anterior', 'pt');\n  const txtBusinessNotFound = useAutoTranslate('Empresa não encontrada', 'pt');\n  const txtVideo = useAutoTranslate('Vídeo', 'pt');\n  const txtBrowserNotSupported = useAutoTranslate('Seu navegador não suporta vídeos.', 'pt');\n  const txtThumbnail = useAutoTranslate('Miniatura', 'pt');\n  const txtCurrent = useAutoTranslate('Atual', 'pt');\n  const txtMin = useAutoTranslate('min', 'pt');\n  const txtQueue = useAutoTranslate('fila', 'pt');\n  const txtOpen = useAutoTranslate('Aberta', 'pt');\n  const txtClosed = useAutoTranslate('fechada', 'pt');\n  const txtQueueNoName = useAutoTranslate('Fila sem nome', 'pt');\n  const txtPhoneOptional = useAutoTranslate('Telefone (opcional, para SMS)', 'pt');\n  const txtIssuing = useAutoTranslate('Emitindo...', 'pt');\n  const txtUnavailable = useAutoTranslate('Indisponível', 'pt');\n  const txtGetTicket = useAutoTranslate('Retirar Ticket', 'pt');\n  const txtTickets = useAutoTranslate('Tickets', 'pt');\n  const txtBook = useAutoTranslate('Marcar', 'pt');\n  const txtReviews = useAutoTranslate('Aval.', 'pt');\n  const txtAvailableQueues = useAutoTranslate('Filas Disponíveis', 'pt');\n  const txtSelectTicket = useAutoTranslate('Selecione e retire o seu ticket', 'pt');\n  const txtSearchQueue = useAutoTranslate('Pesquisar fila...', 'pt');\n  const txtNoQueueFound = useAutoTranslate('Nenhuma fila encontrada', 'pt');\n  const txtNoQueueAvailable = useAutoTranslate('Nenhuma fila disponível', 'pt');\n  const txtTryOtherSearch = useAutoTranslate('Tente outro termo de pesquisa', 'pt');\n  const txtBusinessNoQueues = useAutoTranslate('Esta empresa ainda não configurou filas', 'pt');\n  const txtClearSearch = useAutoTranslate('Limpar pesquisa', 'pt');\n  const txtBookService = useAutoTranslate('Marcar Serviço', 'pt');\n  const txtScheduleAppointment = useAutoTranslate('Agende com hora marcada', 'pt');\n  const txtPhotoGallery = useAutoTranslate('Galeria de Fotos', 'pt');\n  const txtInfo = useAutoTranslate('Info', 'pt');\n  const txtNoServiceAvailable = useAutoTranslate('Nenhum serviço disponível', 'pt');\n  const txtBusinessNoServices = useAutoTranslate('Esta empresa ainda não configurou serviços para marcação', 'pt');\n  const txtLoginRequired = useAutoTranslate('Login Necessário', 'pt');\n  const txtLoginToBook = useAutoTranslate('Faça login para marcar', 'pt');\n  const txtDoLogin = useAutoTranslate('Fazer Login', 'pt');\n  const txtAlreadyHaveTicket = useAutoTranslate('Já tem uma senha ativa para este serviço', 'pt');\n  const txtTicketSuccess = useAutoTranslate('Senha retirada com sucesso!', 'pt');\n  const txtTicketError = useAutoTranslate('Erro ao retirar senha. Tente novamente.', 'pt');\n  \n  return { \n    txtBack, txtBusinessNotFound, txtVideo, txtBrowserNotSupported, txtThumbnail, txtCurrent, txtMin, txtQueue, txtOpen, txtClosed, txtQueueNoName, txtPhoneOptional, txtIssuing, txtUnavailable, txtGetTicket,\n    txtTickets, txtBook, txtReviews, txtAvailableQueues, txtSelectTicket, txtSearchQueue, txtNoQueueFound, txtNoQueueAvailable, txtTryOtherSearch, txtBusinessNoQueues, txtClearSearch,\n    txtBookService, txtScheduleAppointment, txtPhotoGallery, txtInfo, txtNoServiceAvailable, txtBusinessNoServices, txtLoginRequired, txtLoginToBook, txtDoLogin,\n    txtAlreadyHaveTicket, txtTicketSuccess, txtTicketError\n  };\n}\n\nfunction MediaGalleryCarousel({ media, businessName, txtVideo, txtBrowserNotSupported, txtThumbnail }) {\n  const [currentIndex, setCurrentIndex] = useState(0);\n  const [imageErrors, setImageErrors] = useState({});\n\n  const goToNext = () => {\n    setCurrentIndex((prev) => (prev + 1) % media.length);\n  };\n\n  const goToPrevious = () => {\n    setCurrentIndex((prev) => (prev - 1 + media.length) % media.length);\n  };\n\n  const handleImageError = (index) => {\n    setImageErrors(prev => ({ ...prev, [index]: true }));\n  };\n\n  const currentMediaRaw = media[currentIndex];\n  const currentMedia = getUploadUrl(currentMediaRaw);\n  const isVideo = currentMediaRaw?.match(/\\.(mp4|webm|ogg)$/i);\n  const hasMainImageError = imageErrors[currentIndex];\n\n  return (\n    <div className=\"space-y-3\">\n      <div className=\"relative aspect-video bg-slate-100 rounded-lg overflow-hidden shadow-md\">\n        {isVideo ? (\n          <video \n            src={currentMedia} \n            controls\n            className=\"w-full h-full object-cover\"\n            key={currentMedia}\n          >\n            <source src={currentMedia} type=\"video/mp4\" />\n            {txtBrowserNotSupported}\n          </video>\n        ) : hasMainImageError ? (\n          <div className=\"w-full h-full flex items-center justify-center bg-slate-200\">\n            <div className=\"text-center text-slate-500 p-4\">\n              <AlertCircle className=\"w-12 h-12 mx-auto mb-2 text-slate-400\" />\n              <p className=\"text-sm\">{txtThumbnail} {currentIndex + 1}</p>\n            </div>\n          </div>\n        ) : (\n          <img \n            src={currentMedia} \n            alt={`${businessName} - ${txtThumbnail} ${currentIndex + 1}`}\n            className=\"w-full h-full object-cover\"\n            onError={() => handleImageError(currentIndex)}\n          />\n        )}\n        \n        {media.length > 1 && (\n          <>\n            <button\n              onClick={goToPrevious}\n              className=\"absolute left-2 top-1/2 -translate-y-1/2 bg-black/50 hover:bg-black/70 text-white p-2 rounded-full transition-all shadow-lg\"\n            >\n              <ChevronLeft className=\"w-5 h-5\" />\n            </button>\n            <button\n              onClick={goToNext}\n              className=\"absolute right-2 top-1/2 -translate-y-1/2 bg-black/50 hover:bg-black/70 text-white p-2 rounded-full transition-all shadow-lg\"\n            >\n              <ChevronRight className=\"w-5 h-5\" />\n            </button>\n          </>\n        )}\n        \n        {isVideo && (\n          <div className=\"absolute top-2 left-2 bg-black/50 text-white text-xs px-2 py-1 rounded-full flex items-center gap-1\">\n            <Play className=\"w-3 h-3\" />\n            {txtVideo}\n          </div>\n        )}\n        \n        <div className=\"absolute bottom-2 right-2 bg-black/50 text-white text-xs px-2 py-1 rounded-full\">\n          {currentIndex + 1} / {media.length}\n        </div>\n      </div>\n      \n      {media.length > 1 && (\n        <div className=\"relative\">\n          <div className=\"overflow-x-auto scrollbar-hide\">\n            <div className=\"flex gap-2 min-w-max pb-2\">\n              {media.map((item, idx) => {\n                const isVideoThumb = item?.match(/\\.(mp4|webm|ogg)$/i);\n                const thumbUrl = getUploadUrl(item);\n                const hasThumbError = imageErrors[idx];\n                return (\n                  <button\n                    key={idx}\n                    onClick={() => setCurrentIndex(idx)}\n                    className={`flex-shrink-0 w-20 h-20 rounded-lg overflow-hidden border-2 transition-all ${\n                      idx === currentIndex \n                        ? 'border-sky-600 ring-2 ring-sky-200 scale-105' \n                        : 'border-slate-200 hover:border-sky-400 opacity-70 hover:opacity-100'\n                    }`}\n                  >\n                    {isVideoThumb ? (\n                      <div className=\"w-full h-full bg-slate-200 flex items-center justify-center\">\n                        <Play className=\"w-6 h-6 text-slate-500\" />\n                      </div>\n                    ) : hasThumbError ? (\n                      <div className=\"w-full h-full bg-slate-200 flex items-center justify-center\">\n                        <AlertCircle className=\"w-6 h-6 text-slate-400\" />\n                      </div>\n                    ) : (\n                      <img \n                        src={thumbUrl} \n                        alt={`${txtThumbnail} ${idx + 1}`}\n                        className=\"w-full h-full object-cover\"\n                        onError={() => handleImageError(idx)}\n                      />\n                    )}\n                  </button>\n                );\n              })}\n            </div>\n          </div>\n        </div>\n      )}\n    </div>\n  );\n}\n\nexport default function BusinessDetailPage() {\n  const navigate = useNavigate();\n  const queryClient = useQueryClient();\n  const urlParams = new URLSearchParams(window.location.search);\n  const businessId = urlParams.get('id');\n  const [user, setUser] = useState(null);\n  const [userPhone, setUserPhone] = useState(\"\");\n  const [searchTerm, setSearchTerm] = useState(\"\");\n  \n  const { \n    txtBack, txtBusinessNotFound, txtVideo, txtBrowserNotSupported, txtThumbnail, txtCurrent, txtMin, txtQueue, txtOpen, txtClosed, txtQueueNoName, txtPhoneOptional, txtIssuing, txtUnavailable, txtGetTicket,\n    txtTickets, txtBook, txtReviews, txtAvailableQueues, txtSelectTicket, txtSearchQueue, txtNoQueueFound, txtNoQueueAvailable, txtTryOtherSearch, txtBusinessNoQueues, txtClearSearch,\n    txtBookService, txtScheduleAppointment, txtPhotoGallery, txtInfo, txtNoServiceAvailable, txtBusinessNoServices, txtLoginRequired, txtLoginToBook, txtDoLogin,\n    txtAlreadyHaveTicket, txtTicketSuccess, txtTicketError\n  } = useTranslations();\n\n  useEffect(() => {\n    base44.auth.me().then(setUser).catch(() => {});\n  }, []);\n\n  const { data: business, isLoading: loadingBusiness } = useQuery({\n    queryKey: ['business', businessId],\n    queryFn: async () => {\n      // Buscar da API PostgreSQL (mesma fonte que lista de empresas)\n      const { response, data } = await safeFetch(`/api/public/businesses/${businessId}`);\n      if (!response.ok) {\n        console.error('❌ Empresa não encontrada:', businessId);\n        return null;\n      }\n      return data;\n    },\n    enabled: !!businessId,\n  });\n\n  const { data: queues, isLoading: loadingQueues } = useQuery({\n    queryKey: ['queues', businessId],\n    queryFn: () => base44.entities.Queue.filter({ business_id: businessId, is_active: true }),\n    initialData: [],\n    enabled: !!businessId,\n  });\n\n  const { data: services } = useQuery({\n    queryKey: ['services', businessId],\n    queryFn: () => base44.entities.Service.filter({ business_id: businessId, is_active: true }),\n    initialData: [],\n    enabled: !!businessId,\n  });\n\n  const { data: userTickets } = useQuery({\n    queryKey: ['user-tickets', user?.email],\n    queryFn: () => base44.entities.Ticket.filter({ \n      user_email: user.email,\n      status: { $in: ['aguardando', 'chamado', 'atendendo'] }\n    }),\n    initialData: [],\n    enabled: !!user?.email,\n  });\n\n  const createTicketMutation = useMutation({\n    mutationFn: async (queueId) => {\n      if (!user) {\n        base44.auth.redirectToLogin(window.location.href);\n        return;\n      }\n\n      const existingTickets = await base44.entities.Ticket.filter({\n        user_email: user.email,\n        queue_id: queueId\n      });\n\n      const hasActiveTicket = existingTickets.some(t => \n        ['aguardando', 'chamado', 'atendendo'].includes(t.status)\n      );\n\n      if (hasActiveTicket) {\n        toast.error(txtAlreadyHaveTicket);\n        throw new Error('already_has_ticket');\n      }\n\n      let queue = queues.find(q => q.id === queueId);\n      \n      const validation = validateQueueOperating(queue);\n      if (!validation.isOperating) {\n        toast.error(validation.reason);\n        throw new Error(validation.reason);\n      }\n      \n      // Resetar fila se for um novo dia\n      queue = await checkAndResetQueueForNewDay(queue);\n      \n      // Atualizar cache do React Query para evitar resets múltiplos\n      queryClient.setQueryData(['queues', businessId], (oldQueues) => \n        oldQueues?.map(q => q.id === queue.id ? queue : q) || oldQueues\n      );\n      \n      const ticketNumber = queue.last_issued_number + 1;\n      const position = ticketNumber - queue.current_number;\n      const estimatedTime = position * queue.average_service_time;\n\n      const ticket = await base44.entities.Ticket.create({\n        queue_id: queueId,\n        business_id: businessId,\n        user_email: user.email,\n        user_phone: userPhone || user.phone || null,\n        ticket_number: ticketNumber,\n        status: \"aguardando\",\n        estimated_time: estimatedTime,\n        position: position,\n        is_premium: false\n      });\n\n      // Atualizar last_issued_number da fila (não crítico - senha já foi criada)\n      try {\n        await base44.entities.Queue.update(queueId, {\n          last_issued_number: ticketNumber\n        });\n      } catch (err) {\n        console.warn('Erro ao atualizar fila (senha já criada, ignorado):', err);\n      }\n\n      // ✅ Notificações são geridas via Firebase Push Notifications (não via entity local)\n      // O sistema envia push notifications automaticamente quando o ticket é chamado\n\n      return ticket;\n    },\n    onSuccess: (ticket) => {\n      if (ticket) {\n        queryClient.invalidateQueries({ queryKey: ['queues', businessId] });\n        queryClient.invalidateQueries({ queryKey: ['customer-tickets'] });\n        queryClient.invalidateQueries({ queryKey: ['my-tickets'] });\n        toast.success(txtTicketSuccess);\n        navigate(createPageUrl(`TicketView?id=${ticket.id}`));\n      }\n    },\n    onError: (error) => {\n      if (!error.message.includes('already_has_ticket') && !error.message.includes('operando')) {\n        toast.error(txtTicketError);\n      }\n    }\n  });\n\n  if (loadingBusiness) {\n    return (\n      <div className=\"bg-gradient-to-br from-slate-50 via-blue-50 to-sky-50 p-2 md:p-4\">\n        <div className=\"max-w-4xl mx-auto\">\n          <Skeleton className=\"h-8 w-24 mb-3\" />\n          <Skeleton className=\"h-40 w-full mb-3 rounded-xl\" />\n        </div>\n      </div>\n    );\n  }\n\n  if (!business) {\n    return (\n      <div className=\"bg-gradient-to-br from-slate-50 via-blue-50 to-sky-50 p-2 md:p-4\">\n        <div className=\"max-w-4xl mx-auto text-center py-12\">\n          <AlertCircle className=\"w-12 h-12 text-red-500 mx-auto mb-3\" />\n          <h2 className=\"text-lg font-bold text-slate-900 mb-2\">{txtBusinessNotFound}</h2>\n          <Button size=\"sm\" onClick={() => navigate(createPageUrl(\"Businesses\"))}>\n            {txtBack}\n          </Button>\n        </div>\n      </div>\n    );\n  }\n\n  const filteredQueues = queues.filter(queue => \n    queue && ( // ✅ PROTEÇÃO: Verificar se queue existe\n      queue.name?.toLowerCase().includes(searchTerm.toLowerCase()) ||\n      queue.description?.toLowerCase().includes(searchTerm.toLowerCase())\n    )\n  );\n\n  return (\n    <div className=\"bg-gradient-to-br from-slate-50 via-blue-50 to-sky-50\">\n      <div className=\"max-w-4xl mx-auto px-2 md:px-4 py-2 md:py-4\">\n        <Button\n          variant=\"outline\"\n          size=\"sm\"\n          className=\"mb-2 gap-1 h-8 text-xs\"\n          onClick={() => navigate(createPageUrl(\"Businesses\"))}\n        >\n          <ArrowLeft className=\"w-3 h-3\" />\n          {txtBack}\n        </Button>\n\n        <Card className=\"mb-3 border-0 shadow-lg overflow-hidden\">\n          <div className=\"h-24 bg-gradient-to-br from-sky-500 via-blue-600 to-indigo-700 relative\">\n            <div className=\"absolute inset-0 bg-black/20\" />\n            {business.logo_url && (\n              <img\n                src={getUploadUrl(business.logo_url)}\n                alt={business.name}\n                className=\"absolute bottom-2 left-2 w-12 h-12 rounded-lg bg-white p-1.5 object-contain shadow-lg\"\n                onError={(e) => { e.target.style.display = 'none'; }}\n              />\n            )}\n          </div>\n\n          <CardContent className=\"pt-3 pb-3\">\n            <div className=\"mb-3\">\n              <h1 className=\"text-lg font-bold text-slate-900 mb-1\">\n                <TranslatedText text={business.name} />\n              </h1>\n              <div className=\"flex items-center gap-2 mb-1.5\">\n                <div className=\"flex items-center gap-0.5\">\n                  <Star className=\"w-3 h-3 fill-amber-400 text-amber-400\" />\n                  <span className=\"font-semibold text-sm\">{business.rating || '4.8'}</span>\n                </div>\n                <Badge className=\"bg-blue-100 text-blue-700 border-blue-200 text-xs h-5\">\n                  {business.category}\n                </Badge>\n              </div>\n            </div>\n\n            <p className=\"text-xs text-slate-700 mb-3 leading-relaxed\">\n              <TranslatedText \n                text={business.description || 'Serviço de qualidade com atendimento personalizado.'} \n              />\n            </p>\n          </CardContent>\n        </Card>\n\n        <Tabs defaultValue=\"filas\" className=\"space-y-3\">\n          <div className=\"overflow-x-auto -mx-2 px-2 sm:mx-0 sm:px-0\">\n            <TabsList className=\"bg-white border border-slate-200 w-full flex flex-nowrap min-w-max sm:min-w-0 sm:grid sm:grid-cols-4 p-0.5 gap-0.5\">\n              <TabsTrigger value=\"filas\" className=\"text-xs flex-1 min-w-[70px] sm:min-w-0 px-2 sm:px-3\">{txtTickets}</TabsTrigger>\n              <TabsTrigger value=\"agendamento\" className=\"text-xs flex-1 min-w-[70px] sm:min-w-0 px-2 sm:px-3\">{txtBook}</TabsTrigger>\n              <TabsTrigger value=\"info\" className=\"text-xs flex-1 min-w-[70px] sm:min-w-0 px-2 sm:px-3\">\n                <Info className=\"w-3 h-3 mr-0.5\" />\n                {txtInfo}\n              </TabsTrigger>\n              <TabsTrigger value=\"avaliacoes\" className=\"text-xs flex-1 min-w-[70px] sm:min-w-0 px-2 sm:px-3\">\n                <MessageSquare className=\"w-3 h-3 mr-0.5\" />\n                {txtReviews}\n              </TabsTrigger>\n            </TabsList>\n          </div>\n\n          <TabsContent value=\"filas\">\n            <div className=\"mb-3\">\n              <h2 className=\"text-base font-bold text-slate-900 mb-0.5\">{txtAvailableQueues}</h2>\n              <p className=\"text-xs text-slate-600\">{txtSelectTicket}</p>\n            </div>\n\n            {queues.length > 0 && (\n              <div className=\"relative mb-3\">\n                <Search className=\"absolute left-2 top-1/2 transform -translate-y-1/2 text-slate-400 w-4 h-4\" />\n                <Input\n                  placeholder={txtSearchQueue}\n                  value={searchTerm}\n                  onChange={(e) => setSearchTerm(e.target.value)}\n                  className=\"pl-8 h-9 text-xs\"\n                />\n              </div>\n            )}\n\n            {loadingQueues ? (\n              <div className=\"space-y-2\">\n                {[1, 2].map(i => <Skeleton key={i} className=\"h-32 w-full rounded-xl\" />)}\n              </div>\n            ) : filteredQueues.length === 0 ? (\n              <Card className=\"border-0 shadow-md\">\n                <CardContent className=\"py-8 text-center\">\n                  <AlertCircle className=\"w-10 h-10 text-slate-400 mx-auto mb-2\" />\n                  <h3 className=\"text-sm font-bold text-slate-900 mb-1\">\n                    {searchTerm ? txtNoQueueFound : txtNoQueueAvailable}\n                  </h3>\n                  <p className=\"text-xs text-slate-600\">\n                    {searchTerm ? txtTryOtherSearch : txtBusinessNoQueues}\n                  </p>\n                  {searchTerm && (\n                    <Button size=\"sm\" variant=\"outline\" className=\"mt-3 h-7 text-xs\" onClick={() => setSearchTerm('')}>\n                      {txtClearSearch}\n                    </Button>\n                  )}\n                </CardContent>\n              </Card>\n            ) : (\n              <div className=\"space-y-2\">\n                {filteredQueues.map(queue => {\n                  // ✅ PROTEÇÃO EXTRA: Garantir que queue existe E tem propriedades válidas\n                  if (!queue || !queue.id) return null;\n                  \n                  const peopleWaiting = (queue.last_issued_number || 0) - (queue.current_number || 0);\n                  const estimatedTime = peopleWaiting * (queue.average_service_time || 5);\n                  const isAvailable = queue.status === \"aberta\" && peopleWaiting < (queue.max_capacity || 999);\n\n                  return (\n                    <Card key={queue.id} className={`border-0 shadow-md hover:shadow-lg transition-all ${!isAvailable && 'opacity-60'}`}>\n                      <CardHeader className=\"pb-2\">\n                        <div className=\"flex justify-between items-start gap-2\">\n                          <div className=\"flex-1 min-w-0\">\n                            <CardTitle className=\"text-sm mb-0.5 truncate\">{queue.name || txtQueueNoName}</CardTitle>\n                            {queue.description && (\n                              <p className=\"text-slate-600 text-xs line-clamp-1\">{queue.description}</p>\n                            )}\n                          </div>\n                          {queue.status === \"aberta\" ? (\n                            <Badge className=\"bg-green-100 text-green-700 border-green-200 text-xs flex-shrink-0 h-5\">\n                              <CheckCircle2 className=\"w-2.5 h-2.5 mr-0.5\" />\n                              {txtOpen}\n                            </Badge>\n                          ) : (\n                            <Badge className=\"bg-red-100 text-red-700 border-red-200 text-xs flex-shrink-0 h-5\">\n                              {queue.status || txtClosed}\n                            </Badge>\n                          )}\n                        </div>\n                      </CardHeader>\n\n                      <CardContent className=\"pt-0\">\n                        <div className=\"grid grid-cols-2 sm:grid-cols-3 gap-2 mb-2\">\n                          <div className=\"p-2 bg-gradient-to-br from-blue-50 to-sky-50 rounded-lg text-center\">\n                            <Clock className=\"w-3 h-3 text-sky-600 mx-auto mb-0.5\" />\n                            <div className=\"text-base sm:text-lg font-bold text-sky-600\">~{estimatedTime}</div>\n                            <div className=\"text-xs text-slate-600\">{txtMin}</div>\n                          </div>\n\n                          <div className=\"p-2 bg-gradient-to-br from-purple-50 to-pink-50 rounded-lg text-center\">\n                            <Users className=\"w-3 h-3 text-purple-600 mx-auto mb-0.5\" />\n                            <div className=\"text-base sm:text-lg font-bold text-purple-600\">{peopleWaiting}</div>\n                            <div className=\"text-xs text-slate-600\">{txtQueue}</div>\n                          </div>\n\n                          <div className=\"p-2 bg-slate-50 rounded-lg text-center col-span-2 sm:col-span-1\">\n                            <div className=\"text-xs text-slate-600 mb-0.5\">{txtCurrent}</div>\n                            <div className=\"text-sm font-bold text-slate-900\">#{queue.current_number || 0}</div>\n                          </div>\n                        </div>\n\n                        {user && business?.sms_gateway && business.sms_gateway !== 'none' && (\n                          <Input\n                            type=\"tel\"\n                            placeholder={txtPhoneOptional}\n                            value={userPhone}\n                            onChange={(e) => setUserPhone(e.target.value)}\n                            className=\"mb-2 h-8 text-xs\"\n                          />\n                        )}\n\n                        <Button\n                          size=\"sm\"\n                          className=\"w-full bg-gradient-to-r from-sky-500 to-blue-600 hover:from-sky-600 hover:to-blue-700 h-9 text-xs\"\n                          disabled={!isAvailable || createTicketMutation.isPending}\n                          onClick={() => createTicketMutation.mutate(queue.id)}\n                        >\n                          {createTicketMutation.isPending ? (\n                            txtIssuing\n                          ) : !isAvailable ? (\n                            txtUnavailable\n                          ) : (\n                            <>\n                              <Sparkles className=\"w-3 h-3 mr-1\" />\n                              {txtGetTicket}\n                            </>\n                          )}\n                        </Button>\n                      </CardContent>\n                    </Card>\n                  );\n                })}\n              </div>\n            )}\n          </TabsContent>\n\n          <TabsContent value=\"agendamento\">\n            {services.length === 0 ? (\n              <Card className=\"border-0 shadow-md\">\n                <CardContent className=\"py-8 text-center\">\n                  <Calendar className=\"w-10 h-10 text-slate-400 mx-auto mb-2\" />\n                  <h3 className=\"text-sm font-bold text-slate-900 mb-1\">{txtNoServiceAvailable}</h3>\n                  <p className=\"text-xs text-slate-600\">{txtBusinessNoServices}</p>\n                </CardContent>\n              </Card>\n            ) : !user ? (\n              <Card className=\"border-0 shadow-md\">\n                <CardContent className=\"py-8 text-center\">\n                  <AlertCircle className=\"w-10 h-10 text-amber-500 mx-auto mb-2\" />\n                  <h3 className=\"text-sm font-bold text-slate-900 mb-1\">{txtLoginRequired}</h3>\n                  <p className=\"text-xs text-slate-600 mb-3\">\n                    {txtLoginToBook}\n                  </p>\n                  <Button size=\"sm\" onClick={() => base44.auth.redirectToLogin(window.location.href)} className=\"h-8 text-xs\">\n                    {txtDoLogin}\n                  </Button>\n                </CardContent>\n              </Card>\n            ) : (\n              <>\n                <div className=\"mb-3\">\n                  <h2 className=\"text-base font-bold text-slate-900 mb-0.5\">{txtBookService}</h2>\n                  <p className=\"text-xs text-slate-600\">{txtScheduleAppointment}</p>\n                </div>\n                <AppointmentBooking\n                  business={business}\n                  user={user}\n                  onComplete={() => {\n                    navigate(createPageUrl(\"MyAppointments\"));\n                  }}\n                />\n              </>\n            )}\n          </TabsContent>\n\n          <TabsContent value=\"info\">\n            {(() => {\n              // Usar media_gallery se existir, caso contrário usar apenas photo_url (NÃO o logo)\n              const media = business.media_gallery?.length \n                ? business.media_gallery \n                : business.photo_url ? [business.photo_url] : [];\n              \n              return media.length > 0 && (\n                <Card className=\"mb-3 border-0 shadow-md\">\n                  <CardHeader className=\"pb-2\">\n                    <CardTitle className=\"text-sm\">{txtPhotoGallery}</CardTitle>\n                  </CardHeader>\n                  <CardContent>\n                    <MediaGalleryCarousel \n                      media={media} \n                      businessName={business.name} \n                      txtVideo={txtVideo}\n                      txtBrowserNotSupported={txtBrowserNotSupported}\n                      txtThumbnail={txtThumbnail}\n                    />\n                  </CardContent>\n                </Card>\n              );\n            })()}\n            \n            <BusinessInfo business={business} />\n          </TabsContent>\n\n          <TabsContent value=\"avaliacoes\">\n            <Reviews business={business} user={user} />\n          </TabsContent>\n        </Tabs>\n      </div>\n    </div>\n  );\n}","path":null,"size_bytes":28602,"size_tokens":null},"src/components/appointments/AppointmentBooking.jsx":{"content":"import React, { useState } from \"react\";\nimport { base44 } from \"@/api/base44Client\";\nimport { useQuery, useMutation, useQueryClient } from \"@tanstack/react-query\";\nimport { Button } from \"@/components/ui/button\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Calendar } from \"@/components/ui/calendar\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport { Label } from \"@/components/ui/label\";\nimport { Input } from \"@/components/ui/input\";\nimport { Clock, Euro, Calendar as CalendarIcon, CheckCircle2, Search } from \"lucide-react\";\nimport { format } from \"date-fns\";\nimport { pt } from \"date-fns/locale\";\nimport { createPageUrl } from '@/utils';\nimport { toast } from \"sonner\";\nimport { useAutoTranslate } from '@/hooks/useTranslate';\n\nexport default function AppointmentBooking({ business, user, onComplete }) {\n  const queryClient = useQueryClient();\n  const [selectedService, setSelectedService] = useState(null);\n  const [selectedDate, setSelectedDate] = useState(null);\n  const [selectedTime, setSelectedTime] = useState(null);\n  const [notes, setNotes] = useState('');\n  const [searchTerm, setSearchTerm] = useState('');\n\n  // Translations\n  const txtActiveAppointment = useAutoTranslate('Já tem uma marcação ativa. Aguarde alguns minutos.', 'pt');\n  const txtBookingConfirmed = useAutoTranslate('Marcação confirmada com sucesso!', 'pt');\n  const txtSearchService = useAutoTranslate('Pesquisar serviço...', 'pt');\n  const txtNoServiceFound = useAutoTranslate('Nenhum serviço encontrado', 'pt');\n  const txtClearSearch = useAutoTranslate('Limpar pesquisa', 'pt');\n  const txtSelectService = useAutoTranslate('Selecione o Serviço', 'pt');\n  const txtNoServicesAvailable = useAutoTranslate('Sem serviços disponíveis para agendamento', 'pt');\n  const txtTolerance = useAutoTranslate('min tolerância', 'pt');\n  const txtSelectDate = useAutoTranslate('Selecione a Data', 'pt');\n  const txtSelectTime = useAutoTranslate('Selecione o Horário', 'pt');\n  const txtNoSlotsAvailable = useAutoTranslate('Sem horários disponíveis para esta data', 'pt');\n  const txtSummary = useAutoTranslate('Resumo da Marcação', 'pt');\n  const txtService = useAutoTranslate('Serviço:', 'pt');\n  const txtDate = useAutoTranslate('Data:', 'pt');\n  const txtTime = useAutoTranslate('Hora:', 'pt');\n  const txtDuration = useAutoTranslate('Duração:', 'pt');\n  const txtDelayTolerance = useAutoTranslate('Tolerância de atraso:', 'pt');\n  const txtPrice = useAutoTranslate('Preço:', 'pt');\n  const txtNotes = useAutoTranslate('Observações (opcional)', 'pt');\n  const txtAdditionalInfo = useAutoTranslate('Informações adicionais...', 'pt');\n  const txtConfirmBooking = useAutoTranslate('Confirmar Marcação', 'pt');\n  const txtConfirming = useAutoTranslate('A confirmar...', 'pt');\n\n  const { data: rawServices } = useQuery({\n    queryKey: ['services', business.id],\n    queryFn: () => base44.entities.Service.filter({ \n      business_id: business.id,\n      is_active: true \n    }),\n    initialData: [],\n  });\n\n  const services = rawServices.map(service => {\n    if (service.working_hours && Object.keys(service.working_hours).length > 0) {\n      return service;\n    }\n    \n    const dayNames = ['sunday', 'monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday'];\n    const working_hours = {};\n    \n    if (service.custom_schedules && Object.keys(service.custom_schedules).length > 0) {\n      Object.entries(service.custom_schedules).forEach(([dayNum, schedule]) => {\n        const dayName = dayNames[parseInt(dayNum)];\n        working_hours[dayName] = {\n          enabled: true,\n          start: schedule.start || '09:00',\n          end: schedule.end || '18:00',\n          break_start: schedule.breaks?.[0]?.start || '',\n          break_end: schedule.breaks?.[0]?.end || ''\n        };\n      });\n      \n      const available_days = [];\n      dayNames.forEach((dayName, index) => {\n        if (working_hours[dayName]?.enabled) {\n          available_days.push(index);\n        }\n      });\n      \n      return { ...service, working_hours, available_days };\n    }\n    \n    if (service.available_days && service.available_days.length > 0) {\n      service.available_days.forEach(dayNum => {\n        const dayName = dayNames[dayNum];\n        working_hours[dayName] = {\n          enabled: true,\n          start: service.start_time || '09:00',\n          end: service.end_time || '18:00',\n          break_start: '',\n          break_end: ''\n        };\n      });\n      \n      const available_days = [];\n      dayNames.forEach((dayName, index) => {\n        if (working_hours[dayName]?.enabled) {\n          available_days.push(index);\n        }\n      });\n      \n      return { ...service, working_hours, available_days };\n    }\n    \n    return service;\n  });\n\n  const { data: appointments } = useQuery({\n    queryKey: ['appointments', business.id, selectedDate],\n    queryFn: async () => {\n      if (!selectedDate || !selectedService) return [];\n      const dateStr = format(selectedDate, 'yyyy-MM-dd');\n      return await base44.entities.Appointment.filter({\n        business_id: business.id,\n        service_id: selectedService.id,\n        appointment_date: dateStr,\n        status: { $in: ['agendado', 'confirmado'] }\n      });\n    },\n    enabled: !!selectedDate && !!selectedService,\n    initialData: [],\n  });\n\n  const { data: userAppointments } = useQuery({\n    queryKey: ['user-appointments', user?.email],\n    queryFn: () => base44.entities.Appointment.filter({\n      user_email: user.email,\n      status: { $in: ['agendado', 'confirmado', 'em_atendimento'] }\n    }),\n    initialData: [],\n    enabled: !!user?.email,\n  });\n\n  const sendSMS = async (phone, message) => {\n    if (!business?.sms_gateway || business.sms_gateway === 'none') {\n      return;\n    }\n\n    await base44.integrations.Core.SendEmail({\n      to: business.email,\n      subject: 'SMS Enviado',\n      body: `[SMS] Para: ${phone}\\nMensagem: ${message}\\nGateway: ${business.sms_gateway}`\n    });\n  };\n\n  const bookMutation = useMutation({\n    mutationFn: async (data) => {\n      const now = new Date();\n      const twentyMinutesAgo = new Date(now.getTime() - 20 * 60 * 1000);\n\n      const hasRecentAppointment = userAppointments.some(apt => {\n        const createdAt = new Date(apt.created_date);\n        return createdAt >= twentyMinutesAgo && ['agendado', 'confirmado', 'em_atendimento'].includes(apt.status);\n      });\n\n      if (hasRecentAppointment) {\n        toast.error(txtActiveAppointment);\n        throw new Error('Já tem uma marcação ativa');\n      }\n\n      const token = Math.random().toString(36).substring(2, 15) + Math.random().toString(36).substring(2, 15);\n      const appointment = await base44.entities.Appointment.create({\n        ...data,\n        management_token: token\n      });\n\n      const managementUrl = `${window.location.origin}${createPageUrl(`AppointmentManage?token=${token}`)}`;\n      \n      const emailBody = business.confirmation_email_template || \n        `Olá! A sua marcação foi confirmada.\\n\\nDetalhes:\\nServiço: ${selectedService.name}\\nData: ${format(selectedDate, 'dd/MM/yyyy', { locale: pt })}\\nHora: ${selectedTime}\\n\\nGerir marcação: ${managementUrl}`;\n\n      await base44.integrations.Core.SendEmail({\n        to: user.email,\n        subject: `Confirmação de Marcação - ${business.name}`,\n        body: emailBody\n      });\n\n      if (business.sms_gateway !== 'none') {\n        const smsBody = business.confirmation_sms_template || \n          `Marcação confirmada: ${selectedService.name} em ${format(selectedDate, 'dd/MM/yyyy')} às ${selectedTime} - ${business.name}`;\n        \n        await sendSMS(user.email, smsBody); \n      }\n\n      return appointment;\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['appointments'] });\n      queryClient.invalidateQueries({ queryKey: ['user-appointments'] });\n      toast.success(txtBookingConfirmed);\n      onComplete?.();\n    },\n    onError: () => {}\n  });\n\n  const getScheduleForDate = (date) => {\n    if (!selectedService) return null;\n    \n    const dayOfWeek = date.getDay();\n    const dayNames = ['sunday', 'monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday'];\n    const dayName = dayNames[dayOfWeek];\n    \n    const workingHours = selectedService.working_hours || {};\n    const hasWorkingHours = Object.keys(workingHours).length > 0;\n    \n    if (hasWorkingHours) {\n      const daySchedule = workingHours[dayName];\n      if (!daySchedule || !daySchedule.enabled) {\n        return null;\n      }\n      \n      const breaks = [];\n      if (daySchedule.break_start && daySchedule.break_end) {\n        breaks.push({\n          start: daySchedule.break_start,\n          end: daySchedule.break_end\n        });\n      }\n      \n      return {\n        start: daySchedule.start,\n        end: daySchedule.end,\n        breaks: breaks\n      };\n    }\n    \n    return {\n      start: selectedService.start_time || '09:00',\n      end: selectedService.end_time || '18:00',\n      breaks: []\n    };\n  };\n\n  const isTimeInBreak = (timeStr, breaks) => {\n    if (!breaks || breaks.length === 0) return false;\n    \n    const [hour, min] = timeStr.split(':').map(Number);\n    const timeMinutes = hour * 60 + min;\n    \n    return breaks.some(brk => {\n      const [startHour, startMin] = brk.start.split(':').map(Number);\n      const [endHour, endMin] = brk.end.split(':').map(Number);\n      const breakStart = startHour * 60 + startMin;\n      const breakEnd = endHour * 60 + endMin;\n      \n      return timeMinutes >= breakStart && timeMinutes < breakEnd;\n    });\n  };\n\n  const generateTimeSlots = () => {\n    if (!selectedService || !selectedDate) return [];\n\n    const schedule = getScheduleForDate(selectedDate);\n    if (!schedule) return [];\n\n    const slots = [];\n    const [startHour, startMin] = schedule.start.split(':').map(Number);\n    const [endHour, endMin] = schedule.end.split(':').map(Number);\n    \n    const startTime = startHour * 60 + startMin;\n    const endTime = endHour * 60 + endMin;\n    const duration = selectedService.duration;\n    const bufferTime = selectedService.buffer_time || 0;\n    const slotInterval = duration + bufferTime;\n\n    for (let time = startTime; time < endTime; time += slotInterval) {\n      const hour = Math.floor(time / 60);\n      const min = time % 60;\n      const timeStr = `${String(hour).padStart(2, '0')}:${String(min).padStart(2, '0')}`;\n      \n      if (isTimeInBreak(timeStr, schedule.breaks)) {\n        continue;\n      }\n      \n      const isBooked = appointments.some(apt => {\n        const selectedDateStr = format(selectedDate, 'yyyy-MM-dd');\n        if (apt.appointment_date !== selectedDateStr) {\n          return false;\n        }\n        \n        const aptTime = apt.appointment_time;\n        const [aptHour, aptMin] = aptTime.split(':').map(Number);\n        const aptMinutes = aptHour * 60 + aptMin;\n        \n        const aptSlotInterval = apt.duration + (apt.buffer_time || 0);\n\n        const overlaps = (time < (aptMinutes + aptSlotInterval) && aptMinutes < (time + slotInterval));\n        return overlaps;\n      });\n      \n      slots.push({\n        time: timeStr,\n        available: !isBooked\n      });\n    }\n\n    return slots;\n  };\n\n  const handleBook = () => {\n    if (!selectedService || !selectedDate || !selectedTime) return;\n\n    bookMutation.mutate({\n      business_id: business.id,\n      service_id: selectedService.id,\n      user_email: user.email,\n      appointment_date: format(selectedDate, 'yyyy-MM-dd'),\n      appointment_time: selectedTime,\n      status: 'agendado',\n      notes: notes,\n      duration: selectedService.duration,\n      buffer_time: selectedService.buffer_time || 0\n    });\n  };\n\n  const isDayAvailable = (date) => {\n    if (!selectedService) return false;\n    \n    const dateStr = format(date, 'yyyy-MM-dd');\n    if (selectedService.blocked_dates?.includes(dateStr)) {\n      return false;\n    }\n    \n    const dayOfWeek = date.getDay();\n    const dayNames = ['sunday', 'monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday'];\n    const dayName = dayNames[dayOfWeek];\n    \n    const workingHours = selectedService.working_hours || {};\n    const hasWorkingHours = Object.keys(workingHours).length > 0;\n    \n    if (hasWorkingHours) {\n      const daySchedule = workingHours[dayName];\n      return daySchedule && daySchedule.enabled;\n    }\n    \n    return true;\n  };\n\n  const timeSlots = generateTimeSlots();\n  \n  const filteredServices = services.filter(service =>\n    service && ( // ✅ PROTEÇÃO: Verificar se service existe\n      service.name?.toLowerCase().includes(searchTerm.toLowerCase()) ||\n      service.description?.toLowerCase().includes(searchTerm.toLowerCase()) ||\n      service.category?.toLowerCase().includes(searchTerm.toLowerCase())\n    )\n  );\n\n  return (\n    <div className=\"space-y-6\">\n      <Card className=\"border-0 shadow-lg\">\n        <CardHeader>\n          <CardTitle className=\"flex items-center gap-2\">\n            <CalendarIcon className=\"w-5 h-5\" />\n            {txtSelectService}\n          </CardTitle>\n        </CardHeader>\n        <CardContent>\n          {services.length === 0 ? (\n            <p className=\"text-center text-slate-500 py-8\">\n              {txtNoServicesAvailable}\n            </p>\n          ) : (\n            <>\n              <div className=\"relative mb-4\">\n                <Search className=\"absolute left-3 top-1/2 transform -translate-y-1/2 text-slate-400 w-4 h-4\" />\n                <Input\n                  placeholder={txtSearchService}\n                  value={searchTerm}\n                  onChange={(e) => setSearchTerm(e.target.value)}\n                  className=\"pl-10 h-10 text-sm\"\n                />\n              </div>\n              \n              {filteredServices.length === 0 ? (\n                <div className=\"text-center py-8\">\n                  <p className=\"text-slate-500 mb-3\">{txtNoServiceFound}</p>\n                  <Button size=\"sm\" variant=\"outline\" onClick={() => setSearchTerm('')}>\n                    {txtClearSearch}\n                  </Button>\n                </div>\n              ) : (\n                <div className=\"grid md:grid-cols-2 gap-4\">\n                  {filteredServices.map(service => (\n                    <Card\n                      key={service.id}\n                      className={`cursor-pointer transition-all ${\n                        selectedService?.id === service.id\n                          ? 'border-2 border-sky-500 shadow-lg'\n                          : 'border hover:border-slate-300'\n                      }`}\n                      onClick={() => {\n                        setSelectedService(service);\n                        setSelectedDate(null);\n                        setSelectedTime(null);\n                      }}\n                    >\n                      <CardContent className=\"p-4\">\n                        <div className=\"flex justify-between items-start mb-2\">\n                          <h4 className=\"font-bold text-slate-900\">{service.name}</h4>\n                          {selectedService?.id === service.id && (\n                            <CheckCircle2 className=\"w-5 h-5 text-sky-500\" />\n                          )}\n                        </div>\n                        <p className=\"text-sm text-slate-600 mb-3\">{service.description}</p>\n                        <div className=\"flex gap-3 text-xs\">\n                          <Badge variant=\"secondary\" className=\"gap-1\">\n                            <Clock className=\"w-3 h-3\" />\n                            {service.duration} min\n                          </Badge>\n                          {service.buffer_time > 0 && (\n                            <Badge variant=\"outline\" className=\"gap-1 text-amber-700 border-amber-300\">\n                              <Clock className=\"w-3 h-3\" />\n                              {service.buffer_time} {txtTolerance}\n                            </Badge>\n                          )}\n                          {service.price > 0 && (\n                            <Badge variant=\"secondary\" className=\"gap-1\">\n                              <Euro className=\"w-3 h-3\" />\n                              {service.price.toFixed(2)}\n                            </Badge>\n                          )}\n                        </div>\n                      </CardContent>\n                    </Card>\n                  ))}\n                </div>\n              )}\n            </>\n          )}\n        </CardContent>\n      </Card>\n\n      {selectedService && (\n        <Card className=\"border-0 shadow-lg overflow-hidden\">\n          <CardHeader className=\"bg-gradient-to-r from-slate-50 to-blue-50/50 border-b\">\n            <CardTitle className=\"flex items-center gap-2 text-slate-800\">\n              <CalendarIcon className=\"w-5 h-5 text-blue-500\" />\n              {txtSelectDate}\n            </CardTitle>\n          </CardHeader>\n          <CardContent className=\"flex justify-center p-6 bg-white\">\n            <div className=\"w-full max-w-sm\">\n              <Calendar\n                mode=\"single\"\n                selected={selectedDate}\n                onSelect={(date) => {\n                  setSelectedDate(date);\n                  setSelectedTime(null);\n                }}\n                disabled={(date) => {\n                  const today = new Date();\n                  today.setHours(0, 0, 0, 0);\n                  return date < today || !isDayAvailable(date);\n                }}\n                locale={pt}\n                className=\"rounded-2xl border border-slate-200 shadow-sm bg-white p-2\"\n              />\n            </div>\n          </CardContent>\n        </Card>\n      )}\n\n      {selectedDate && (\n        <Card className=\"border-0 shadow-lg overflow-hidden\">\n          <CardHeader className=\"bg-gradient-to-r from-slate-50 to-emerald-50/50 border-b\">\n            <CardTitle className=\"flex items-center gap-2 text-slate-800\">\n              <Clock className=\"w-5 h-5 text-emerald-500\" />\n              {txtSelectTime} - {format(selectedDate, \"dd 'de' MMMM\", { locale: pt })}\n            </CardTitle>\n          </CardHeader>\n          <CardContent className=\"p-6 bg-white\">\n            {timeSlots.length === 0 ? (\n              <div className=\"text-center py-12\">\n                <Clock className=\"w-12 h-12 text-slate-300 mx-auto mb-3\" />\n                <p className=\"text-slate-500\">{txtNoSlotsAvailable}</p>\n              </div>\n            ) : (\n              <div className=\"grid grid-cols-3 sm:grid-cols-4 md:grid-cols-5 lg:grid-cols-6 gap-2\">\n                {timeSlots.map(slot => (\n                  <button\n                    key={slot.time}\n                    disabled={!slot.available}\n                    onClick={() => setSelectedTime(slot.time)}\n                    className={`\n                      relative px-3 py-3 rounded-xl text-sm font-semibold\n                      transition-all duration-200 ease-out\n                      ${selectedTime === slot.time\n                        ? 'bg-gradient-to-br from-blue-500 to-blue-600 text-white shadow-lg shadow-blue-500/30 scale-105 ring-2 ring-blue-400/30'\n                        : slot.available\n                          ? 'bg-slate-50 text-slate-700 hover:bg-slate-100 hover:scale-105 hover:shadow-md border border-slate-200'\n                          : 'bg-slate-100 text-slate-400 cursor-not-allowed opacity-50 line-through'\n                      }\n                    `}\n                  >\n                    {slot.time}\n                    {selectedTime === slot.time && (\n                      <CheckCircle2 className=\"absolute -top-1 -right-1 w-4 h-4 text-white bg-blue-600 rounded-full\" />\n                    )}\n                  </button>\n                ))}\n              </div>\n            )}\n          </CardContent>\n        </Card>\n      )}\n\n      {selectedTime && (\n        <Card className=\"border-0 shadow-lg bg-gradient-to-br from-sky-50 to-blue-50\">\n          <CardHeader>\n            <CardTitle>{txtSummary}</CardTitle>\n          </CardHeader>\n          <CardContent className=\"space-y-4\">\n            <div className=\"p-4 bg-white rounded-xl\">\n              <div className=\"space-y-2 text-sm\">\n                <div className=\"flex justify-between\">\n                  <span className=\"text-slate-600\">{txtService}</span>\n                  <span className=\"font-semibold text-slate-900\">{selectedService.name}</span>\n                </div>\n                <div className=\"flex justify-between\">\n                  <span className=\"text-slate-600\">{txtDate}</span>\n                  <span className=\"font-semibold text-slate-900\">\n                    {format(selectedDate, \"dd/MM/yyyy\", { locale: pt })}\n                  </span>\n                </div>\n                <div className=\"flex justify-between\">\n                  <span className=\"text-slate-600\">{txtTime}</span>\n                  <span className=\"font-semibold text-slate-900\">{selectedTime}</span>\n                </div>\n                <div className=\"flex justify-between\">\n                  <span className=\"text-slate-600\">{txtDuration}</span>\n                  <span className=\"font-semibold text-slate-900\">{selectedService.duration} min</span>\n                </div>\n                {selectedService.buffer_time > 0 && (\n                  <div className=\"flex justify-between text-amber-700\">\n                    <span className=\"text-slate-600\">{txtDelayTolerance}</span>\n                    <span className=\"font-semibold text-amber-700\">{selectedService.buffer_time} min</span>\n                  </div>\n                )}\n                {selectedService.price > 0 && (\n                  <div className=\"flex justify-between pt-2 border-t\">\n                    <span className=\"text-slate-600\">{txtPrice}</span>\n                    <span className=\"font-bold text-slate-900\">€{selectedService.price.toFixed(2)}</span>\n                  </div>\n                )}\n              </div>\n            </div>\n\n            <div>\n              <Label htmlFor=\"notes\">{txtNotes}</Label>\n              <Textarea\n                id=\"notes\"\n                value={notes}\n                onChange={(e) => setNotes(e.target.value)}\n                placeholder={txtAdditionalInfo}\n                rows={3}\n              />\n            </div>\n\n            <Button\n              className=\"w-full bg-gradient-to-r from-sky-500 to-blue-600 hover:from-sky-600 hover:to-blue-700 py-6 text-lg\"\n              onClick={handleBook}\n              disabled={bookMutation.isPending}\n            >\n              {bookMutation.isPending ? txtConfirming : txtConfirmBooking}\n            </Button>\n          </CardContent>\n        </Card>\n      )}\n    </div>\n  );\n}","path":null,"size_bytes":22725,"size_tokens":null},"src/components/portal/ProfileManager.jsx":{"content":"import React, { useState, useEffect } from \"react\";\nimport { useNavigate } from \"react-router-dom\";\nimport { base44 } from \"@/api/base44Client\";\nimport { useMutation, useQuery } from \"@tanstack/react-query\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Label } from \"@/components/ui/label\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { User, Mail, Crown, Save, Phone, Shield, FileText, ExternalLink } from \"lucide-react\";\nimport { Skeleton } from \"@/components/ui/skeleton\";\nimport { toast } from \"sonner\";\nimport { LanguageSelector } from \"@/components/settings/LanguageSelector\";\nimport { TranslatedText } from \"@/components/translation/TranslatedText\";\nimport { useAutoTranslate } from \"@/hooks/useTranslate\";\n\nexport default function ProfileManager({ user, onUpdate }) {\n  const navigate = useNavigate();\n  const displayName = user.nome_completo || user.full_name || '';\n  \n  const [formData, setFormData] = useState({\n    nome_completo: displayName,\n    phone: user.phone || ''\n  });\n  \n  const successMsg = useAutoTranslate('Perfil atualizado com sucesso!', 'pt');\n  const errorMsg = useAutoTranslate('Erro ao atualizar perfil', 'pt');\n  const requiredMsg = useAutoTranslate('Nome completo é obrigatório', 'pt');\n  const namePlaceholder = useAutoTranslate('Seu nome', 'pt');\n\n  useEffect(() => {\n    const newDisplayName = user.nome_completo || user.full_name || '';\n    setFormData({\n      nome_completo: newDisplayName,\n      phone: user.phone || ''\n    });\n  }, [user.id, user.nome_completo, user.full_name, user.phone]);\n\n  const { data: subscription } = useQuery({\n    queryKey: ['user-subscription', user.email],\n    queryFn: async () => {\n      const subs = await base44.entities.Subscription.filter({ \n        user_email: user.email,\n        status: \"active\"\n      });\n      return subs[0] || null;\n    },\n  });\n\n  const updateMutation = useMutation({\n    mutationFn: async (updates) => {\n      return await base44.auth.updateMe(updates);\n    },\n    onSuccess: async () => {\n      toast.success(successMsg);\n      if (onUpdate) {\n        await onUpdate();\n      }\n    },\n    onError: (error) => {\n      console.error('Erro ao atualizar:', error);\n      toast.error(errorMsg);\n    }\n  });\n\n  const handleSubmit = async (e) => {\n    e.preventDefault();\n    \n    if (!formData.nome_completo.trim()) {\n      toast.error(requiredMsg);\n      return;\n    }\n    \n    updateMutation.mutate({\n      nome_completo: formData.nome_completo.trim(),\n      phone: formData.phone.trim()\n    });\n  };\n\n  const isPremium = subscription?.plan === \"premium\";\n\n  return (\n    <div className=\"space-y-3 sm:space-y-4 w-full max-w-full overflow-hidden px-2 sm:px-0\">\n      {/* Seletor de Idioma */}\n      <LanguageSelector />\n      \n      <Card className=\"border-0 shadow-lg\">\n        <CardHeader className=\"pb-3 sm:pb-6\">\n          <CardTitle className=\"flex items-center gap-2 text-sm sm:text-base\">\n            <User className=\"w-4 h-4\" />\n            <TranslatedText text=\"Informações da Conta\" sourceLang=\"pt\" />\n          </CardTitle>\n        </CardHeader>\n        <CardContent className=\"space-y-3 sm:space-y-4\">\n          <div className=\"flex flex-col gap-2 p-2 sm:p-3 bg-slate-50 rounded-lg\">\n            <div className=\"flex flex-wrap items-center gap-2\">\n              <Mail className=\"w-4 h-4 text-slate-600 flex-shrink-0\" />\n              <span className=\"font-semibold text-xs sm:text-sm text-slate-900 break-all overflow-wrap-anywhere min-w-0\">{user.email}</span>\n              {isPremium && (\n                <Badge className=\"bg-gradient-to-r from-purple-500 to-pink-600 text-white border-0 text-xs flex-shrink-0\">\n                  <Crown className=\"w-3 h-3 mr-1\" />\n                  Premium\n                </Badge>\n              )}\n            </div>\n            <p className=\"text-xs text-slate-600\">\n              <TranslatedText text=\"Membro desde\" sourceLang=\"pt\" /> {new Date(user.created_date).toLocaleDateString('pt-PT', { \n                month: 'long', \n                year: 'numeric' \n              })}\n            </p>\n          </div>\n\n          <form onSubmit={handleSubmit} className=\"space-y-2 sm:space-y-3\" noValidate>\n            <div>\n              <Label htmlFor=\"nome_completo\" className=\"text-xs sm:text-sm\">\n                <TranslatedText text=\"Nome Completo\" sourceLang=\"pt\" /> *\n              </Label>\n              <Input\n                id=\"nome_completo\"\n                value={formData.nome_completo}\n                onChange={(e) => setFormData(prev => ({ ...prev, nome_completo: e.target.value }))}\n                placeholder={namePlaceholder}\n                className=\"mt-1 text-sm\"\n                autoComplete=\"name\"\n              />\n            </div>\n\n            <div>\n              <Label htmlFor=\"phone\" className=\"text-xs sm:text-sm\">\n                <TranslatedText text=\"Telefone\" sourceLang=\"pt\" /> *\n              </Label>\n              <div className=\"flex gap-2 items-center\">\n                <Phone className=\"w-4 h-4 text-slate-400 flex-shrink-0\" />\n                <div className=\"flex-1 min-w-0\">\n                  <Input\n                    id=\"phone\"\n                    value={formData.phone}\n                    onChange={(e) => setFormData(prev => ({ ...prev, phone: e.target.value }))}\n                    placeholder=\"+351 912 345 678\"\n                    className=\"w-full text-sm\"\n                    autoComplete=\"tel\"\n                  />\n                </div>\n              </div>\n            </div>\n\n            <Button\n              type=\"submit\"\n              disabled={updateMutation.isPending}\n              className=\"w-full bg-gradient-to-r from-sky-500 to-blue-600 hover:from-sky-600 hover:to-blue-700 py-5 sm:py-6 text-sm sm:text-base\"\n            >\n              <Save className=\"w-4 h-4 mr-2\" />\n              <TranslatedText \n                text={updateMutation.isPending ? 'A guardar...' : 'Guardar Alterações'} \n                sourceLang=\"pt\" \n              />\n            </Button>\n          </form>\n        </CardContent>\n      </Card>\n\n      <Card className=\"border-0 shadow-lg\">\n        <CardHeader className=\"pb-3 sm:pb-6\">\n          <CardTitle className=\"text-sm sm:text-base\">\n            <TranslatedText text=\"Informação Legal\" sourceLang=\"pt\" />\n          </CardTitle>\n        </CardHeader>\n        <CardContent className=\"px-3 sm:px-6 space-y-2\">\n          <button\n            onClick={() => navigate('/privacy-policy')}\n            className=\"w-full flex items-center justify-between p-3 bg-slate-50 hover:bg-slate-100 rounded-lg transition-colors\"\n          >\n            <div className=\"flex items-center gap-3\">\n              <Shield className=\"w-5 h-5 text-blue-600\" />\n              <span className=\"text-sm font-medium text-slate-700\">\n                <TranslatedText text=\"Política de Privacidade\" sourceLang=\"pt\" />\n              </span>\n            </div>\n            <ExternalLink className=\"w-4 h-4 text-slate-400\" />\n          </button>\n          \n          <button\n            onClick={() => navigate('/terms-of-use')}\n            className=\"w-full flex items-center justify-between p-3 bg-slate-50 hover:bg-slate-100 rounded-lg transition-colors\"\n          >\n            <div className=\"flex items-center gap-3\">\n              <FileText className=\"w-5 h-5 text-purple-600\" />\n              <span className=\"text-sm font-medium text-slate-700\">\n                <TranslatedText text=\"Termos de Utilização\" sourceLang=\"pt\" />\n              </span>\n            </div>\n            <ExternalLink className=\"w-4 h-4 text-slate-400\" />\n          </button>\n        </CardContent>\n      </Card>\n    </div>\n  );\n}","path":null,"size_bytes":7782,"size_tokens":null},"src/App.css":{"content":"/* ============================================\n   WhatsApp-Style Toast Notifications\n   Production-Ready with Full Accessibility\n   ============================================ */\n\n.whatsapp-toast {\n  display: flex;\n  align-items: center;\n  gap: 12px;\n  padding: 14px 20px;\n  border-radius: 24px;\n  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;\n  font-size: 14px;\n  font-weight: 500;\n  box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15), 0 2px 8px rgba(0, 0, 0, 0.1);\n  backdrop-filter: blur(10px);\n  -webkit-backdrop-filter: blur(10px);\n  animation: whatsapp-slide-up 0.3s cubic-bezier(0.16, 1, 0.3, 1);\n  max-width: calc(100vw - 32px);\n  margin: 0 16px 16px 16px;\n  min-height: 48px;\n}\n\n@keyframes whatsapp-slide-up {\n  from {\n    opacity: 0;\n    transform: translateY(20px) scale(0.95);\n  }\n  to {\n    opacity: 1;\n    transform: translateY(0) scale(1);\n  }\n}\n\n.whatsapp-toast[data-removed=\"true\"] {\n  animation: whatsapp-slide-down 0.2s ease-out forwards;\n}\n\n@keyframes whatsapp-slide-down {\n  from {\n    opacity: 1;\n    transform: translateY(0) scale(1);\n  }\n  to {\n    opacity: 0;\n    transform: translateY(10px) scale(0.95);\n  }\n}\n\n.whatsapp-toast-title {\n  flex: 1;\n  line-height: 1.4;\n  font-weight: 600;\n}\n\n.whatsapp-toast-description {\n  opacity: 0.9;\n  font-size: 13px;\n  margin-top: 2px;\n  font-weight: 400;\n}\n\n/* Success Toast - Verde WhatsApp (WCAG AA compliant) */\n.whatsapp-toast-success {\n  background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);\n  color: #ffffff;\n  border: 1px solid rgba(255, 255, 255, 0.1);\n}\n\n.whatsapp-toast-success svg {\n  color: #ffffff;\n  flex-shrink: 0;\n}\n\n/* Error Toast - Vermelho (WCAG AA compliant) */\n.whatsapp-toast-error {\n  background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);\n  color: #ffffff;\n  border: 1px solid rgba(255, 255, 255, 0.1);\n}\n\n.whatsapp-toast-error svg {\n  color: #ffffff;\n  flex-shrink: 0;\n}\n\n/* Warning Toast - Laranja/Amber escuro (WCAG AA compliant - white text on dark orange) */\n.whatsapp-toast-warning {\n  background: linear-gradient(135deg, #d97706 0%, #b45309 100%);\n  color: #ffffff;\n  border: 1px solid rgba(255, 255, 255, 0.1);\n}\n\n.whatsapp-toast-warning svg {\n  color: #ffffff;\n  flex-shrink: 0;\n}\n\n/* Info Toast - Azul (WCAG AA compliant) */\n.whatsapp-toast-info {\n  background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);\n  color: #ffffff;\n  border: 1px solid rgba(255, 255, 255, 0.1);\n}\n\n.whatsapp-toast-info svg {\n  color: #ffffff;\n  flex-shrink: 0;\n}\n\n/* Default Toast (sem tipo especificado) - Funciona em modo claro e escuro */\n.whatsapp-toast:not(.whatsapp-toast-success):not(.whatsapp-toast-error):not(.whatsapp-toast-warning):not(.whatsapp-toast-info) {\n  background: linear-gradient(135deg, #374151 0%, #1f2937 100%);\n  color: #ffffff;\n  border: 1px solid rgba(255, 255, 255, 0.1);\n}\n\n/* Mobile responsive - Ajustes para telas pequenas */\n@media (max-width: 480px) {\n  .whatsapp-toast {\n    padding: 12px 16px;\n    font-size: 13px;\n    border-radius: 20px;\n    margin: 0 12px 12px 12px;\n    min-height: 44px;\n  }\n  \n  .whatsapp-toast svg {\n    width: 18px;\n    height: 18px;\n  }\n  \n  .whatsapp-toast-title {\n    font-size: 13px;\n  }\n  \n  .whatsapp-toast-description {\n    font-size: 12px;\n  }\n}\n\n/* Safe area for iOS devices with notch/home indicator */\n@supports (padding-bottom: env(safe-area-inset-bottom)) {\n  [data-sonner-toaster] {\n    padding-bottom: calc(env(safe-area-inset-bottom) + 70px) !important;\n  }\n}\n\n/* Ensure toasts appear above bottom navigation (80px height typical) */\n[data-sonner-toaster] {\n  bottom: 80px !important;\n  z-index: 9999 !important;\n}\n\n/* Focus styles for accessibility (keyboard navigation) */\n.whatsapp-toast:focus-visible {\n  outline: 2px solid #ffffff;\n  outline-offset: 2px;\n}\n\n/* Reduced motion preference */\n@media (prefers-reduced-motion: reduce) {\n  .whatsapp-toast {\n    animation: none;\n  }\n  \n  .whatsapp-toast[data-removed=\"true\"] {\n    animation: none;\n    opacity: 0;\n  }\n}\n\n/* High contrast mode support */\n@media (prefers-contrast: high) {\n  .whatsapp-toast {\n    border: 2px solid #ffffff;\n  }\n  \n  .whatsapp-toast-success {\n    background: #16a34a;\n  }\n  \n  .whatsapp-toast-error {\n    background: #dc2626;\n  }\n  \n  .whatsapp-toast-warning {\n    background: #b45309;\n  }\n  \n  .whatsapp-toast-info {\n    background: #2563eb;\n  }\n}\n","path":null,"size_bytes":4329,"size_tokens":null},"src/main.jsx":{"content":"import React from 'react'\nimport ReactDOM from 'react-dom/client'\nimport App from '@/App.jsx'\nimport '@/index.css'\nimport '@/i18n/config'\nimport { seedDemoCompanyProfile } from '@/utils/demoDataSeeder'\nimport { switchToDemoUser, createBusinessUser } from '@/utils/fixUserAccess'\nimport { createBusinessForLegacyProfiles } from '@/utils/fixLegacyProfiles'\nimport { fixDemoSubscription } from '@/utils/fixDemoSubscription'\nimport { clearDemoData } from '@/utils/clearDemoData'\nimport { retryPendingConsent } from '@/utils/consentRetry'\nimport { safeFetch, isCapacitorApp } from '@/utils/apiConfig'\nimport { StatusBar, Style } from '@capacitor/status-bar'\nimport { Capacitor } from '@capacitor/core'\nimport { App as CapacitorApp } from '@capacitor/app'\n\n// Configurar StatusBar para ocupar ecrã todo (remover barra azul)\nasync function setupStatusBar() {\n  if (Capacitor.isNativePlatform()) {\n    try {\n      await StatusBar.setOverlaysWebView({ overlay: true });\n      await StatusBar.setStyle({ style: Style.Dark });\n      await StatusBar.setBackgroundColor({ color: '#ffffff' });\n      console.log('✅ StatusBar configurada - overlay ativo');\n    } catch (err) {\n      console.warn('StatusBar setup error:', err);\n    }\n  }\n}\nsetupStatusBar();\n\n// Configurar botão de hardware back do Android\nasync function setupAndroidBackButton() {\n  if (Capacitor.isNativePlatform() && Capacitor.getPlatform() === 'android') {\n    CapacitorApp.addListener('backButton', ({ canGoBack }) => {\n      if (canGoBack) {\n        window.history.back();\n      } else {\n        CapacitorApp.exitApp();\n      }\n    });\n    console.log('✅ Android hardware back button configurado');\n  }\n}\nsetupAndroidBackButton();\n\n// ✅ Detectar Capacitor/iOS/Android e adicionar classe ao html para CSS safe-area\n// CRÍTICO: Só adiciona classes se realmente estiver no Capacitor nativo\n// Usa window.Capacitor.isNativePlatform() como verificação definitiva\n(function detectPlatformForSafeArea() {\n  const html = document.documentElement;\n  \n  // Verificação robusta: Capacitor bridge DEVE existir E ser plataforma nativa\n  // window.Capacitor existe apenas em builds Capacitor (não em browsers normais)\n  const isNativeCapacitor = typeof window !== 'undefined' && \n    window.Capacitor && \n    typeof window.Capacitor.isNativePlatform === 'function' &&\n    window.Capacitor.isNativePlatform();\n  \n  // Fallback: verificar protocolos que só existem em Capacitor\n  const isCapacitorProtocol = typeof window !== 'undefined' && \n    (window.location.protocol === 'capacitor:' || \n     window.location.protocol === 'ionic:');\n  \n  if (isNativeCapacitor || isCapacitorProtocol) {\n    html.classList.add('capacitor');\n    \n    // Detectar plataforma específica via Capacitor.getPlatform() se disponível\n    if (window.Capacitor && typeof window.Capacitor.getPlatform === 'function') {\n      const platform = window.Capacitor.getPlatform();\n      if (platform === 'ios') {\n        html.classList.add('ios');\n      } else if (platform === 'android') {\n        html.classList.add('android');\n      }\n    } else {\n      // Fallback para user agent\n      const userAgent = navigator.userAgent || '';\n      if (/iPad|iPhone|iPod/.test(userAgent) || \n          (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1)) {\n        html.classList.add('ios');\n      } else if (/Android/.test(userAgent)) {\n        html.classList.add('android');\n      }\n    }\n    \n    console.log('📱 Capacitor nativo detectado - classes:', html.className);\n  }\n})();\n\n// Seed data (async mas não bloqueante)\nseedDemoCompanyProfile().catch(err => console.warn('Seed error:', err));\n\n// Retry pending consent (async, non-blocking)\nretryPendingConsent().catch(err => console.warn('Consent retry error:', err));\n\n// ✅ FUNÇÃO DE CORREÇÃO: Atualizar flags do utilizador atual\nasync function fixCurrentUserFlags() {\n  try {\n    const mockUser = JSON.parse(localStorage.getItem('mock_user') || '{}');\n    console.log('🔍 Utilizador atual:', mockUser.email);\n    \n    // Buscar perfil da empresa\n    const { response, data: profiles } = await safeFetch('/api/company-profiles');\n    if (!response.ok) {\n      console.log('❌ Erro ao buscar perfis empresariais');\n      return;\n    }\n    const userProfile = profiles?.find(p => p.adminUserId === mockUser.email);\n    \n    if (!userProfile) {\n      console.log('❌ Nenhum perfil empresarial encontrado para este utilizador');\n      return;\n    }\n    \n    console.log('✅ Perfil encontrado:', userProfile.companyName);\n    console.log('📊 Status:', userProfile.status, '| Subscrição:', userProfile.subscriptionStatus);\n    \n    // Atualizar flags\n    mockUser.has_business_subscription = userProfile.status === 'active';\n    mockUser.business_profile_completed = true;\n    mockUser.business_id = userProfile.id;\n    mockUser.is_business_user = true;\n    mockUser.account_type = mockUser.account_type || 'empresa';\n    mockUser.onboarding_completed = true;\n    \n    localStorage.setItem('mock_user', JSON.stringify(mockUser));\n    console.log('✅ Flags do utilizador atualizadas!');\n    console.log('🔄 Recarregando página...');\n    \n    setTimeout(() => {\n      window.location.reload();\n    }, 1000);\n  } catch (error) {\n    console.error('❌ Erro ao corrigir flags:', error);\n  }\n}\n\n// Expor funções de desenvolvimento globalmente\nwindow.switchToDemoUser = switchToDemoUser;\nwindow.createBusinessUser = createBusinessUser;\nwindow.createBusinessForLegacyProfiles = createBusinessForLegacyProfiles;\nwindow.fixDemoSubscription = fixDemoSubscription;\nwindow.clearDemoData = clearDemoData;\nwindow.fixCurrentUserFlags = fixCurrentUserFlags;\n\nconsole.log('');\nconsole.log('🔧 UTILIDADES DE DESENVOLVIMENTO:');\nconsole.log('  fixCurrentUserFlags() - ⚡ CORRIGIR ACESSO EMPRESARIAL (se já tem plano)');\nconsole.log('  clearDemoData() - ⚠️ LIMPAR TODOS OS DADOS DEMO (base limpa)');\nconsole.log('  switchToDemoUser() - Trocar para utilizador demo (se existir)');\nconsole.log('  createBusinessUser(email, companyName) - Criar novo utilizador empresarial');\nconsole.log('  createBusinessForLegacyProfiles() - Corrigir perfis antigos (cria Business entities)');\nconsole.log('  fixDemoSubscription() - Corrigir subscrição do utilizador demo');\nconsole.log('');\n\nReactDOM.createRoot(document.getElementById('root')).render(\n    <App />\n) ","path":null,"size_bytes":6352,"size_tokens":null},"src/components/ui/slider.jsx":{"content":"import * as React from \"react\"\nimport * as SliderPrimitive from \"@radix-ui/react-slider\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Slider = React.forwardRef(({ className, ...props }, ref) => (\n  <SliderPrimitive.Root\n    ref={ref}\n    className={cn(\"relative flex w-full touch-none select-none items-center\", className)}\n    {...props}>\n    <SliderPrimitive.Track\n      className=\"relative h-1.5 w-full grow overflow-hidden rounded-full bg-primary/20\">\n      <SliderPrimitive.Range className=\"absolute h-full bg-primary\" />\n    </SliderPrimitive.Track>\n    <SliderPrimitive.Thumb\n      className=\"block h-4 w-4 rounded-full border border-primary/50 bg-background shadow transition-colors focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:pointer-events-none disabled:opacity-50\" />\n  </SliderPrimitive.Root>\n))\nSlider.displayName = SliderPrimitive.Root.displayName\n\nexport { Slider }\n","path":null,"size_bytes":914,"size_tokens":null},"src/components/business/FeedbackManager.jsx":{"content":"import React, { useState } from \"react\";\nimport { base44 } from \"@/api/base44Client\";\nimport { useQuery, useMutation, useQueryClient } from \"@tanstack/react-query\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport { \n  Star, \n  MessageSquare, \n  TrendingUp, \n  AlertCircle,\n  Send,\n  CheckCircle2,\n  ThumbsUp,\n  ThumbsDown\n} from \"lucide-react\";\nimport { BarChart, Bar, XAxis, YAxis, CartesianGrid, Tooltip, ResponsiveContainer } from \"recharts\";\nimport { useAutoTranslate } from \"@/hooks/useTranslate\";\n\nexport default function FeedbackManager({ businessId }) {\n  // Traduções\n  const txtFeedbackRatings = useAutoTranslate('Avaliações e Feedback', 'pt');\n  const txtAvgRating = useAutoTranslate('Avaliação Média', 'pt');\n  const txtPositive = useAutoTranslate('Positivas', 'pt');\n  const txtNegative = useAutoTranslate('Negativas', 'pt');\n  const txtNeedsResponse = useAutoTranslate('Aguardam Resposta', 'pt');\n  const txtRatingDistribution = useAutoTranslate('Distribuição de Avaliações', 'pt');\n  const txtRecentFeedback = useAutoTranslate('Feedback Recente', 'pt');\n  const txtNoFeedback = useAutoTranslate('Nenhum feedback recebido', 'pt');\n  const txtRespond = useAutoTranslate('Responder', 'pt');\n  const txtSend = useAutoTranslate('Enviar', 'pt');\n  const txtCancel = useAutoTranslate('Cancelar', 'pt');\n  const txtResponseSent = useAutoTranslate('Resposta enviada', 'pt');\n  const txtWriteResponse = useAutoTranslate('Escrever resposta...', 'pt');\n  const txtAverage = useAutoTranslate('Média', 'pt');\n  const txtPositiveLabel = useAutoTranslate('Positivo', 'pt');\n  const txtNegativeLabel = useAutoTranslate('Negativo', 'pt');\n  const txtAwaitingLabel = useAutoTranslate('Aguardam', 'pt');\n  const txtAttention = useAutoTranslate('Atenção', 'pt');\n  const txtDistribution = useAutoTranslate('Distribuição', 'pt');\n  const txtFeedback = useAutoTranslate('Feedback', 'pt');\n  const txtNoFeedbackYet = useAutoTranslate('Nenhum feedback', 'pt');\n  const txtTotal = useAutoTranslate('total', 'pt');\n  const txtRespondPlaceholder = useAutoTranslate('Responder...', 'pt');\n  const queryClient = useQueryClient();\n  const [respondingTo, setRespondingTo] = useState(null);\n  const [response, setResponse] = useState(\"\");\n\n  const { data: tickets } = useQuery({\n    queryKey: ['feedback-tickets', businessId],\n    queryFn: () => base44.entities.Ticket.filter({ \n      business_id: businessId,\n      status: 'concluido'\n    }, '-completed_at'),\n    initialData: [],\n  });\n\n  const { data: appointments } = useQuery({\n    queryKey: ['feedback-appointments', businessId],\n    queryFn: () => base44.entities.Appointment.filter({ \n      business_id: businessId,\n      status: 'concluido'\n    }, '-appointment_date'),\n    initialData: [],\n  });\n\n  const { data: reviews } = useQuery({\n    queryKey: ['feedback-reviews', businessId],\n    queryFn: () => base44.entities.Review.filter({ \n      business_id: businessId\n    }),\n    initialData: [],\n  });\n\n  const allFeedback = [\n    ...tickets.filter(t => t.rating || t.feedback).map(t => ({\n      id: t.id,\n      type: 'ticket',\n      rating: t.rating,\n      feedback: t.feedback,\n      date: t.completed_at,\n      user_email: t.user_email,\n      response: t.business_response\n    })),\n    ...appointments.filter(a => a.rating || a.feedback).map(a => ({\n      id: a.id,\n      type: 'appointment',\n      rating: a.rating,\n      feedback: a.feedback,\n      date: a.appointment_date,\n      user_email: a.user_email,\n      response: a.business_response\n    })),\n    ...reviews.map(r => ({\n      id: r.id,\n      type: 'review',\n      rating: r.rating,\n      feedback: r.comment,\n      date: r.created_date,\n      user_email: r.user_email,\n      response: r.business_response\n    }))\n  ].sort((a, b) => new Date(b.date) - new Date(a.date));\n\n  const respondMutation = useMutation({\n    mutationFn: async ({ id, type, response }) => {\n      if (type === 'ticket') {\n        await base44.entities.Ticket.update(id, { business_response: response });\n      } else if (type === 'appointment') {\n        await base44.entities.Appointment.update(id, { business_response: response });\n      } else if (type === 'review') {\n        await base44.entities.Review.update(id, { business_response: response });\n      }\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['feedback-tickets', businessId] });\n      queryClient.invalidateQueries({ queryKey: ['feedback-appointments', businessId] });\n      queryClient.invalidateQueries({ queryKey: ['feedback-reviews', businessId] });\n      queryClient.invalidateQueries({ queryKey: ['reviews', businessId] });\n      queryClient.invalidateQueries({ queryKey: ['user-review', businessId] });\n      setRespondingTo(null);\n      setResponse(\"\");\n    },\n  });\n\n  const ratedFeedback = allFeedback.filter(f => f.rating);\n  const avgRating = ratedFeedback.length > 0\n    ? (ratedFeedback.reduce((sum, f) => sum + f.rating, 0) / ratedFeedback.length).toFixed(1)\n    : 0;\n\n  const positiveCount = allFeedback.filter(f => f.rating >= 4).length;\n  const negativeCount = allFeedback.filter(f => f.rating <= 2).length;\n  const needsResponseCount = allFeedback.filter(f => !f.response && f.feedback).length;\n\n  const ratingDistribution = [\n    { rating: '5★', count: allFeedback.filter(f => f.rating === 5).length },\n    { rating: '4★', count: allFeedback.filter(f => f.rating === 4).length },\n    { rating: '3★', count: allFeedback.filter(f => f.rating === 3).length },\n    { rating: '2★', count: allFeedback.filter(f => f.rating === 2).length },\n    { rating: '1★', count: allFeedback.filter(f => f.rating === 1).length },\n  ];\n\n  const handleRespond = (feedback) => {\n    setRespondingTo(feedback);\n    setResponse(\"\");\n  };\n\n  const submitResponse = () => {\n    if (response.trim()) {\n      respondMutation.mutate({\n        id: respondingTo.id,\n        type: respondingTo.type,\n        response: response.trim()\n      });\n    }\n  };\n\n  return (\n    <div className=\"space-y-4 md:space-y-6\">\n      <div className=\"grid grid-cols-2 md:grid-cols-4 gap-3 md:gap-6\">\n        <Card className=\"border-0 shadow-lg\">\n          <CardContent className=\"p-3 md:p-6\">\n            <div className=\"flex items-center gap-2 md:gap-3 mb-2 md:mb-4\">\n              <div className=\"w-8 h-8 md:w-12 md:h-12 rounded-lg md:rounded-xl bg-gradient-to-br from-amber-500 to-orange-500 flex items-center justify-center\">\n                <Star className=\"w-4 h-4 md:w-6 md:h-6 text-white\" />\n              </div>\n              <div>\n                <p className=\"text-xs text-slate-600\">{txtAverage}</p>\n                <p className=\"text-xl md:text-3xl font-bold text-slate-900\">{avgRating}</p>\n              </div>\n            </div>\n            <div className=\"text-xs text-slate-600\">\n              {ratedFeedback.length} {txtTotal}\n            </div>\n          </CardContent>\n        </Card>\n\n        <Card className=\"border-0 shadow-lg\">\n          <CardContent className=\"p-3 md:p-6\">\n            <div className=\"flex items-center gap-2 md:gap-3 mb-2 md:mb-4\">\n              <div className=\"w-8 h-8 md:w-12 md:h-12 rounded-lg md:rounded-xl bg-gradient-to-br from-green-500 to-emerald-500 flex items-center justify-center\">\n                <ThumbsUp className=\"w-4 h-4 md:w-6 md:h-6 text-white\" />\n              </div>\n              <div>\n                <p className=\"text-xs text-slate-600\">{txtPositiveLabel}</p>\n                <p className=\"text-xl md:text-3xl font-bold text-slate-900\">{positiveCount}</p>\n              </div>\n            </div>\n            <div className=\"text-xs text-slate-600\">\n              {ratedFeedback.length > 0 ? Math.round((positiveCount / ratedFeedback.length) * 100) : 0}%\n            </div>\n          </CardContent>\n        </Card>\n\n        <Card className=\"border-0 shadow-lg\">\n          <CardContent className=\"p-3 md:p-6\">\n            <div className=\"flex items-center gap-2 md:gap-3 mb-2 md:mb-4\">\n              <div className=\"w-8 h-8 md:w-12 md:h-12 rounded-lg md:rounded-xl bg-gradient-to-br from-red-500 to-pink-500 flex items-center justify-center\">\n                <ThumbsDown className=\"w-4 h-4 md:w-6 md:h-6 text-white\" />\n              </div>\n              <div>\n                <p className=\"text-xs text-slate-600\">{txtNegativeLabel}</p>\n                <p className=\"text-xl md:text-3xl font-bold text-slate-900\">{negativeCount}</p>\n              </div>\n            </div>\n            <div className=\"text-xs text-slate-600\">\n              {txtAttention}\n            </div>\n          </CardContent>\n        </Card>\n\n        <Card className=\"border-0 shadow-lg\">\n          <CardContent className=\"p-3 md:p-6\">\n            <div className=\"flex items-center gap-2 md:gap-3 mb-2 md:mb-4\">\n              <div className=\"w-8 h-8 md:w-12 md:h-12 rounded-lg md:rounded-xl bg-gradient-to-br from-purple-500 to-pink-500 flex items-center justify-center\">\n                <MessageSquare className=\"w-4 h-4 md:w-6 md:h-6 text-white\" />\n              </div>\n              <div>\n                <p className=\"text-xs text-slate-600\">{txtAwaitingLabel}</p>\n                <p className=\"text-xl md:text-3xl font-bold text-slate-900\">{needsResponseCount}</p>\n              </div>\n            </div>\n            <div className=\"text-xs text-slate-600\">\n              {txtRespond}\n            </div>\n          </CardContent>\n        </Card>\n      </div>\n\n      <Card className=\"border-0 shadow-lg\">\n        <CardHeader className=\"p-3 md:p-6\">\n          <CardTitle className=\"flex items-center gap-2 text-sm md:text-base\">\n            <TrendingUp className=\"w-4 h-4 md:w-5 md:h-5\" />\n            {txtDistribution}\n          </CardTitle>\n        </CardHeader>\n        <CardContent className=\"p-3 md:p-6\">\n          <ResponsiveContainer width=\"100%\" height={200}>\n            <BarChart data={ratingDistribution}>\n              <CartesianGrid strokeDasharray=\"3 3\" stroke=\"#e5e7eb\" />\n              <XAxis dataKey=\"rating\" stroke=\"#64748b\" style={{ fontSize: '10px' }} />\n              <YAxis stroke=\"#64748b\" style={{ fontSize: '10px' }} />\n              <Tooltip \n                contentStyle={{ \n                  backgroundColor: '#fff', \n                  border: '1px solid #e5e7eb',\n                  borderRadius: '8px',\n                  fontSize: '12px'\n                }}\n              />\n              <Bar dataKey=\"count\" fill=\"#8b5cf6\" radius={[8, 8, 0, 0]} />\n            </BarChart>\n          </ResponsiveContainer>\n        </CardContent>\n      </Card>\n\n      <Card className=\"border-0 shadow-lg\">\n        <CardHeader className=\"p-3 md:p-6\">\n          <CardTitle className=\"flex items-center gap-2 text-sm md:text-base\">\n            <MessageSquare className=\"w-4 h-4 md:w-5 md:h-5\" />\n            {txtFeedback}\n          </CardTitle>\n        </CardHeader>\n        <CardContent className=\"p-3 md:p-6\">\n          {allFeedback.length === 0 ? (\n            <div className=\"text-center py-8 md:py-12\">\n              <MessageSquare className=\"w-12 h-12 md:w-16 md:h-16 text-slate-300 mx-auto mb-3 md:mb-4\" />\n              <p className=\"text-sm text-slate-600\">{txtNoFeedbackYet}</p>\n            </div>\n          ) : (\n            <div className=\"space-y-3 md:space-y-4\">\n              {allFeedback.map((feedback) => (\n                <div \n                  key={`${feedback.type}-${feedback.id}`}\n                  className={`p-3 md:p-5 rounded-xl border-2 transition-all ${\n                    !feedback.response && feedback.feedback\n                      ? 'border-amber-200 bg-amber-50'\n                      : 'border-slate-200 bg-white'\n                  }`}\n                >\n                  <div className=\"flex items-start justify-between mb-2 md:mb-3\">\n                    <div className=\"flex items-center gap-2 md:gap-3 flex-1 min-w-0\">\n                      <div className={`w-8 h-8 md:w-10 md:h-10 rounded-lg flex items-center justify-center flex-shrink-0 ${\n                        feedback.rating >= 4 ? 'bg-green-100' :\n                        feedback.rating === 3 ? 'bg-yellow-100' :\n                        'bg-red-100'\n                      }`}>\n                        <Star className={`w-4 h-4 md:w-5 md:h-5 ${\n                          feedback.rating >= 4 ? 'text-green-600 fill-green-600' :\n                          feedback.rating === 3 ? 'text-yellow-600 fill-yellow-600' :\n                          'text-red-600 fill-red-600'\n                        }`} />\n                      </div>\n                      <div className=\"flex-1 min-w-0\">\n                        <div className=\"flex items-center gap-2\">\n                          <span className=\"font-bold text-sm md:text-base text-slate-900\">{feedback.rating}/5</span>\n                          <Badge variant=\"outline\" className=\"text-xs\">\n                            {feedback.type === 'ticket' ? 'Senha' : feedback.type === 'review' ? 'Avaliação' : 'Marcação'}\n                          </Badge>\n                        </div>\n                        <p className=\"text-xs text-slate-500 truncate\">\n                          {feedback.user_email} • {new Date(feedback.date).toLocaleDateString('pt-PT')}\n                        </p>\n                      </div>\n                    </div>\n                    {!feedback.response && feedback.feedback && (\n                      <Badge className=\"bg-amber-500 text-white text-xs px-1.5 py-0 ml-2\">\n                        <AlertCircle className=\"w-3 h-3 mr-0.5\" />\n                        Aguarda\n                      </Badge>\n                    )}\n                    {feedback.response && (\n                      <Badge className=\"bg-green-100 text-green-700 border-green-200 text-xs px-1.5 py-0 ml-2\">\n                        <CheckCircle2 className=\"w-3 h-3 mr-0.5\" />\n                        OK\n                      </Badge>\n                    )}\n                  </div>\n\n                  {feedback.feedback && (\n                    <div className=\"mb-3 md:mb-4\">\n                      <p className=\"text-xs md:text-sm text-slate-700 leading-relaxed\">\"{feedback.feedback}\"</p>\n                    </div>\n                  )}\n\n                  {feedback.response ? (\n                    <div className=\"p-2 md:p-4 bg-blue-50 rounded-lg border border-blue-200\">\n                      <div className=\"flex items-center gap-2 mb-1 md:mb-2\">\n                        <MessageSquare className=\"w-3 h-3 md:w-4 md:h-4 text-blue-600\" />\n                        <span className=\"text-xs md:text-sm font-semibold text-blue-900\">Resposta:</span>\n                      </div>\n                      <p className=\"text-xs md:text-sm text-blue-800\">{feedback.response}</p>\n                    </div>\n                  ) : feedback.feedback && (\n                    <div>\n                      {respondingTo?.id === feedback.id ? (\n                        <div className=\"space-y-2 md:space-y-3\">\n                          <Textarea\n                            value={response}\n                            onChange={(e) => setResponse(e.target.value)}\n                            placeholder={txtRespondPlaceholder}\n                            rows={2}\n                            className=\"resize-none text-sm\"\n                          />\n                          <div className=\"flex gap-2 justify-end\">\n                            <Button \n                              variant=\"outline\" \n                              size=\"sm\"\n                              onClick={() => setRespondingTo(null)}\n                              className=\"h-8 text-xs\"\n                            >\n                              Cancelar\n                            </Button>\n                            <Button \n                              size=\"sm\"\n                              onClick={submitResponse}\n                              disabled={!response.trim() || respondMutation.isPending}\n                              className=\"bg-blue-600 hover:bg-blue-700 h-8 text-xs\"\n                            >\n                              <Send className=\"w-3 h-3 mr-1\" />\n                              {respondMutation.isPending ? 'Enviando...' : 'Enviar'}\n                            </Button>\n                          </div>\n                        </div>\n                      ) : (\n                        <Button \n                          variant=\"outline\" \n                          size=\"sm\"\n                          onClick={() => handleRespond(feedback)}\n                          className=\"gap-2 h-8 text-xs\"\n                        >\n                          <MessageSquare className=\"w-3 h-3\" />\n                          Responder\n                        </Button>\n                      )}\n                    </div>\n                  )}\n                </div>\n              ))}\n            </div>\n          )}\n        </CardContent>\n      </Card>\n    </div>\n  );\n}","path":null,"size_bytes":17028,"size_tokens":null},"src/components/shared/BusinessCard.jsx":{"content":"import React, { useState } from \"react\";\nimport { Link } from \"react-router-dom\";\nimport { createPageUrl } from \"@/utils\";\nimport { getUploadUrl } from \"@/utils/apiConfig\";\nimport { Card, CardContent } from \"@/components/ui/card\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Button } from \"@/components/ui/button\";\nimport { MapPin, Star, Clock, Building2 } from \"lucide-react\";\nimport { TranslatedText } from \"@/components/translation/TranslatedText\";\nimport { useAutoTranslate } from '@/hooks/useTranslate';\n\nconst categoryColors = {\n  saude: \"from-red-500 to-pink-500\",\n  financeiro: \"from-green-500 to-emerald-500\",\n  governo: \"from-blue-500 to-indigo-500\",\n  restauracao: \"from-orange-500 to-amber-500\",\n  beleza: \"from-purple-500 to-pink-500\",\n  retalho: \"from-cyan-500 to-blue-500\",\n  outros: \"from-slate-500 to-gray-500\"\n};\n\nconst categoryIcons = {\n  saude: \"🏥\",\n  financeiro: \"🏦\",\n  governo: \"🏛️\",\n  restauracao: \"🍽️\",\n  beleza: \"💇\",\n  retalho: \"🛍️\",\n  outros: \"📍\"\n};\n\nexport default function BusinessCard({ business, showWaitTime = false, waitTime = 0 }) {\n  const [logoError, setLogoError] = useState(false);\n  \n  // Translations\n  const txtDefaultDescription = useAutoTranslate('Serviço de qualidade com atendimento rápido e eficiente', 'pt');\n  const txtLocationAvailable = useAutoTranslate('Localização disponível', 'pt');\n  const txtNoQueue = useAutoTranslate('Sem fila', 'pt');\n  const txtViewDetails = useAutoTranslate('Ver Detalhes', 'pt');\n\n  const getWaitTimeColor = (time) => {\n    if (time <= 10) return \"bg-green-100 text-green-700 border-green-200\";\n    if (time <= 30) return \"bg-amber-100 text-amber-700 border-amber-200\";\n    return \"bg-red-100 text-red-700 border-red-200\";\n  };\n\n  const getWaitTimeLabel = (time) => {\n    if (time === 0) return txtNoQueue;\n    if (time <= 10) return `~${time} min`;\n    return `~${time} min`;\n  };\n\n  return (\n    <Card className=\"group hover:shadow-2xl transition-all duration-300 border-0 overflow-hidden\">\n      <div className={`h-40 bg-gradient-to-br ${categoryColors[business.category]} relative`}>\n        <div className=\"absolute inset-0 bg-black/20 group-hover:bg-black/10 transition-colors\" />\n        <div className=\"absolute inset-0 flex items-center justify-center\">\n          <div className=\"text-7xl opacity-90\">\n            {categoryIcons[business.category] || '📍'}\n          </div>\n        </div>\n        {business.logo_url && !logoError && (\n          <img \n            src={getUploadUrl(business.logo_url)} \n            alt={business.name} \n            className=\"absolute top-4 right-4 w-14 h-14 rounded-xl bg-white/95 p-2 object-contain shadow-lg\"\n            onError={() => setLogoError(true)}\n          />\n        )}\n        {(!business.logo_url || logoError) && (\n          <div className=\"absolute top-4 right-4 w-14 h-14 rounded-xl bg-white/95 p-2 shadow-lg flex items-center justify-center\">\n            <Building2 className=\"w-8 h-8 text-slate-400\" />\n          </div>\n        )}\n      </div>\n      \n      <CardContent className=\"p-6\">\n        <h3 className=\"font-bold text-xl text-slate-900 mb-2 group-hover:text-purple-600 transition-colors\">\n          <TranslatedText text={business.name} />\n        </h3>\n        \n        <p className=\"text-sm text-slate-600 mb-4 line-clamp-2\">\n          {business.description ? (\n            <TranslatedText text={business.description} />\n          ) : (\n            txtDefaultDescription\n          )}\n        </p>\n\n        <div className=\"flex items-center gap-2 text-sm text-slate-600 mb-4\">\n          <MapPin className=\"w-4 h-4 flex-shrink-0\" />\n          <span className=\"truncate\">{business.address || txtLocationAvailable}</span>\n        </div>\n\n        <div className=\"flex items-center justify-between mb-4\">\n          <div className=\"flex items-center gap-1\">\n            <Star className=\"w-4 h-4 fill-amber-400 text-amber-400\" />\n            <span className=\"font-semibold text-slate-900\">{business.rating || '4.8'}</span>\n            <span className=\"text-slate-500 text-sm\">(124)</span>\n          </div>\n          {showWaitTime && (\n            <Badge className={getWaitTimeColor(waitTime)}>\n              <Clock className=\"w-3 h-3 mr-1\" />\n              {getWaitTimeLabel(waitTime)}\n            </Badge>\n          )}\n        </div>\n\n        <Link to={createPageUrl(`BusinessDetail?id=${business.id}`)}>\n          <Button className=\"w-full bg-gradient-to-r from-purple-500 to-pink-600 hover:from-purple-600 hover:to-pink-700\">\n            {txtViewDetails}\n          </Button>\n        </Link>\n      </CardContent>\n    </Card>\n  );\n}","path":null,"size_bytes":4618,"size_tokens":null},"src/components/ui/popover.jsx":{"content":"import * as React from \"react\"\nimport * as PopoverPrimitive from \"@radix-ui/react-popover\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Popover = PopoverPrimitive.Root\n\nconst PopoverTrigger = PopoverPrimitive.Trigger\n\nconst PopoverAnchor = PopoverPrimitive.Anchor\n\nconst PopoverContent = React.forwardRef(({ className, align = \"center\", sideOffset = 4, ...props }, ref) => (\n  <PopoverPrimitive.Portal>\n    <PopoverPrimitive.Content\n      ref={ref}\n      align={align}\n      sideOffset={sideOffset}\n      className={cn(\n        \"z-50 w-72 rounded-md border bg-popover p-4 text-popover-foreground shadow-md outline-none data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2\",\n        className\n      )}\n      {...props} />\n  </PopoverPrimitive.Portal>\n))\nPopoverContent.displayName = PopoverPrimitive.Content.displayName\n\nexport { Popover, PopoverTrigger, PopoverContent, PopoverAnchor }\n","path":null,"size_bytes":1166,"size_tokens":null},"src/components/ui/checkbox.jsx":{"content":"import * as React from \"react\"\nimport * as CheckboxPrimitive from \"@radix-ui/react-checkbox\"\nimport { Check } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Checkbox = React.forwardRef(({ className, ...props }, ref) => (\n  <CheckboxPrimitive.Root\n    ref={ref}\n    className={cn(\n      \"peer h-4 w-4 shrink-0 rounded-sm border border-primary shadow focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:cursor-not-allowed disabled:opacity-50 data-[state=checked]:bg-primary data-[state=checked]:text-primary-foreground\",\n      className\n    )}\n    {...props}>\n    <CheckboxPrimitive.Indicator className={cn(\"flex items-center justify-center text-current\")}>\n      <Check className=\"h-4 w-4\" />\n    </CheckboxPrimitive.Indicator>\n  </CheckboxPrimitive.Root>\n))\nCheckbox.displayName = CheckboxPrimitive.Root.displayName\n\nexport { Checkbox }\n","path":null,"size_bytes":880,"size_tokens":null},"src/components/ui/pagination.jsx":{"content":"import * as React from \"react\"\nimport { ChevronLeft, ChevronRight, MoreHorizontal } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\nimport { buttonVariants } from \"@/components/ui/button\";\n\nconst Pagination = ({\n  className,\n  ...props\n}) => (\n  <nav\n    role=\"navigation\"\n    aria-label=\"pagination\"\n    className={cn(\"mx-auto flex w-full justify-center\", className)}\n    {...props} />\n)\nPagination.displayName = \"Pagination\"\n\nconst PaginationContent = React.forwardRef(({ className, ...props }, ref) => (\n  <ul\n    ref={ref}\n    className={cn(\"flex flex-row items-center gap-1\", className)}\n    {...props} />\n))\nPaginationContent.displayName = \"PaginationContent\"\n\nconst PaginationItem = React.forwardRef(({ className, ...props }, ref) => (\n  <li ref={ref} className={cn(\"\", className)} {...props} />\n))\nPaginationItem.displayName = \"PaginationItem\"\n\nconst PaginationLink = ({\n  className,\n  isActive,\n  size = \"icon\",\n  ...props\n}) => (\n  <a\n    aria-current={isActive ? \"page\" : undefined}\n    className={cn(buttonVariants({\n      variant: isActive ? \"outline\" : \"ghost\",\n      size,\n    }), className)}\n    {...props} />\n)\nPaginationLink.displayName = \"PaginationLink\"\n\nconst PaginationPrevious = ({\n  className,\n  ...props\n}) => (\n  <PaginationLink\n    aria-label=\"Go to previous page\"\n    size=\"default\"\n    className={cn(\"gap-1 pl-2.5\", className)}\n    {...props}>\n    <ChevronLeft className=\"h-4 w-4\" />\n    <span>Previous</span>\n  </PaginationLink>\n)\nPaginationPrevious.displayName = \"PaginationPrevious\"\n\nconst PaginationNext = ({\n  className,\n  ...props\n}) => (\n  <PaginationLink\n    aria-label=\"Go to next page\"\n    size=\"default\"\n    className={cn(\"gap-1 pr-2.5\", className)}\n    {...props}>\n    <span>Next</span>\n    <ChevronRight className=\"h-4 w-4\" />\n  </PaginationLink>\n)\nPaginationNext.displayName = \"PaginationNext\"\n\nconst PaginationEllipsis = ({\n  className,\n  ...props\n}) => (\n  <span\n    aria-hidden\n    className={cn(\"flex h-9 w-9 items-center justify-center\", className)}\n    {...props}>\n    <MoreHorizontal className=\"h-4 w-4\" />\n    <span className=\"sr-only\">More pages</span>\n  </span>\n)\nPaginationEllipsis.displayName = \"PaginationEllipsis\"\n\nexport {\n  Pagination,\n  PaginationContent,\n  PaginationLink,\n  PaginationItem,\n  PaginationPrevious,\n  PaginationNext,\n  PaginationEllipsis,\n}\n","path":null,"size_bytes":2322,"size_tokens":null},"README.md":{"content":"# QZero - Sistema de Gestão de Filas\n\nSistema completo e independente para gestão de filas e agendamentos empresariais.\n\n## 🚀 Características\n\n- **Sistema Standalone**: Funciona completamente sem dependências externas\n- **Dados Locais**: Persistência via localStorage + backend API local\n- **Portal do Cliente**: Visualizar empresas, filas, agendamentos e histórico\n- **Portal Empresarial**: Dashboard, gestão de filas, serviços, agendamentos e analytics\n- **Subscrições com Stripe**: Fluxo completo de pagamentos (€49.99/mês com 2 dias grátis)\n- **Tempo Real**: Posição e tempo estimado calculados dinamicamente\n- **Ferramentas de Marketing**: Gerador de cartazes A4 com QR codes\n- **Painel TV**: Display fullscreen para salas de espera\n\n## 📦 Tecnologias\n\n- **Frontend**: React 18 + Vite 6\n- **UI**: Radix UI + Tailwind CSS\n- **Animações**: Framer Motion\n- **State**: TanStack React Query\n- **Routing**: React Router DOM v7\n- **Pagamentos**: Stripe\n\n## 🏃 Como Executar\n\n```bash\n# Instalar dependências\nnpm install\n\n# Executar em desenvolvimento\nnpm run dev\n\n# Acessar\nhttp://localhost:5000\n```\n\n## 🗄️ Gestão de Dados\n\nPara limpar todos os dados e recomeçar:\n\n1. Abra o Console do Navegador (F12)\n2. Execute: `clearAllMockData()`\n3. Recarregue a página (F5)\n\n## 📝 Licença\n\nPropriedade privada - Todos os direitos reservados","path":null,"size_bytes":1363,"size_tokens":null},"src/api/functions.js":{"content":"import { base44 } from './base44Client';\n\n\nexport const createCheckoutSession = base44.functions.createCheckoutSession;\n\nexport const stripeWebhook = base44.functions.stripeWebhook;\n\nexport const checkPaymentStatus = base44.functions.checkPaymentStatus;\n\nexport const sendSMS = base44.functions.sendSMS;\n\nexport const addBusinesses = base44.functions.addBusinesses;\n\nexport const startFreeTrial = base44.functions.startFreeTrial;\n\nexport const forceActivateSubscription = base44.functions.forceActivateSubscription;\n\n","path":null,"size_bytes":517,"size_tokens":null},"postcss.config.js":{"content":"export default {\n  plugins: {\n    tailwindcss: {},\n    autoprefixer: {},\n  },\n}\n","path":null,"size_bytes":80,"size_tokens":null},"src/pages/Dashboard.jsx":{"content":"import React, { useState, useEffect } from \"react\";\nimport { base44 } from \"@/api/base44Client\";\nimport { useQuery, useMutation, useQueryClient } from \"@tanstack/react-query\";\nimport { Link, useNavigate } from \"react-router-dom\";\nimport { createPageUrl } from \"@/utils\";\nimport { getUploadUrl } from \"@/utils/apiConfig\";\nimport { Button } from \"@/components/ui/button\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { \n  Clock, \n  CheckCircle2, \n  Calendar, \n  Building2, \n  TrendingUp,\n  ArrowRight,\n  Sparkles,\n  Star,\n  MapPin,\n  Search\n} from \"lucide-react\";\nimport { Skeleton } from \"@/components/ui/skeleton\";\nimport { format } from \"date-fns\";\nimport { pt } from \"date-fns/locale\";\nimport { Input } from \"@/components/ui/input\";\nimport { toast } from \"sonner\";\nimport { validateQueueOperating } from \"@/utils/queueValidation\";\nimport { checkAndResetQueueForNewDay } from \"@/utils/queueReset\";\nimport { useAutoTranslate } from \"@/hooks/useTranslate\";\n\nexport default function DashboardPage() {\n  // Traduções\n  const txtMyPortal = useAutoTranslate('O Meu Portal', 'pt');\n  const txtActiveTickets = useAutoTranslate('Senhas Ativas', 'pt');\n  const txtUpcomingAppointments = useAutoTranslate('Próximas Marcações', 'pt');\n  const txtRecentTickets = useAutoTranslate('Últimas Senhas', 'pt');\n  const txtFeaturedBusinesses = useAutoTranslate('Empresas em Destaque', 'pt');\n  const txtSearchBusinesses = useAutoTranslate('Procurar empresas...', 'pt');\n  const txtAlreadyHaveTicket = useAutoTranslate('Já tem uma senha ativa para este serviço', 'pt');\n  const txtTicketCreatedSuccess = useAutoTranslate('Senha criada com sucesso!', 'pt');\n  const txtErrorCreatingTicket = useAutoTranslate('Erro ao criar senha:', 'pt');\n  const txtTicket = useAutoTranslate('Senha', 'pt');\n  const txtPosition = useAutoTranslate('Posição', 'pt');\n  const txtEstimatedWait = useAutoTranslate('Tempo Estimado', 'pt');\n  const txtMin = useAutoTranslate('min', 'pt');\n  const txtSeeDetails = useAutoTranslate('Ver Detalhes', 'pt');\n  const txtNoActiveTickets = useAutoTranslate('Nenhuma senha ativa', 'pt');\n  const txtNoActiveTicketsDesc = useAutoTranslate('Não tem senhas ativas no momento', 'pt');\n  const txtNoAppointments = useAutoTranslate('Nenhuma marcação', 'pt');\n  const txtNoAppointmentsDesc = useAutoTranslate('Não tem marcações agendadas', 'pt');\n  const txtNoRecentTickets = useAutoTranslate('Nenhuma senha recente', 'pt');\n  const txtErrorIssuingTicket = useAutoTranslate('Erro ao emitir senha', 'pt');\n  const txtNoQueueAvailable = useAutoTranslate('Nenhuma fila disponível', 'pt');\n  const navigate = useNavigate();\n  const queryClient = useQueryClient();\n  const [user, setUser] = useState(null);\n  const [searchTerm, setSearchTerm] = useState(\"\");\n  const [takingTicket, setTakingTicket] = useState(null);\n\n  useEffect(() => {\n    base44.auth.me().then(setUser).catch(() => base44.auth.redirectToLogin());\n  }, []);\n\n  const { data: activeTickets, isLoading: loadingTickets } = useQuery({\n    queryKey: ['user-active-tickets', user?.email],\n    queryFn: () => base44.entities.Ticket.filter({ \n      user_email: user.email,\n      status: { $in: ['aguardando', 'chamado', 'atendendo'] }\n    }),\n    initialData: [],\n    enabled: !!user,\n    refetchInterval: 5000,\n  });\n\n  const { data: recentTickets } = useQuery({\n    queryKey: ['user-recent-tickets', user?.email],\n    queryFn: () => base44.entities.Ticket.filter({ user_email: user.email }, '-created_date', 5),\n    initialData: [],\n    enabled: !!user,\n  });\n\n  const { data: appointments } = useQuery({\n    queryKey: ['user-appointments', user?.email],\n    queryFn: () => base44.entities.Appointment.filter({ \n      user_email: user.email,\n      status: { $in: ['agendado', 'confirmado'] }\n    }),\n    initialData: [],\n    enabled: !!user,\n  });\n\n  const { data: businesses } = useQuery({\n    queryKey: ['featured-businesses'],\n    queryFn: () => base44.entities.Business.filter({ is_active: true }),\n    initialData: [],\n  });\n\n  const { data: queues } = useQuery({\n    queryKey: ['all-queues-dash'],\n    queryFn: () => base44.entities.Queue.list(),\n    initialData: [],\n  });\n\n  const { data: services } = useQuery({\n    queryKey: ['all-services-dash'],\n    queryFn: () => base44.entities.Service.list(),\n    initialData: [],\n  });\n\n  const createTicketMutation = useMutation({\n    mutationFn: async ({ businessId, queueId }) => {\n      const existingTickets = await base44.entities.Ticket.filter({\n        user_email: user.email,\n        queue_id: queueId\n      });\n\n      const hasActiveTicket = existingTickets.some(t => \n        ['aguardando', 'chamado', 'atendendo'].includes(t.status)\n      );\n\n      if (hasActiveTicket) {\n        toast.error(txtAlreadyHaveTicket);\n        throw new Error(txtAlreadyHaveTicket);\n      }\n\n      let queue = queues.find(q => q.id === queueId);\n      \n      const validation = validateQueueOperating(queue);\n      if (!validation.isOperating) {\n        toast.error(validation.reason);\n        throw new Error(validation.reason);\n      }\n      \n      // Resetar fila se for um novo dia\n      queue = await checkAndResetQueueForNewDay(queue);\n      \n      // Atualizar cache do React Query para evitar resets múltiplos\n      queryClient.setQueryData(['all-queues-dash'], (oldQueues) => \n        oldQueues?.map(q => q.id === queue.id ? queue : q) || oldQueues\n      );\n      \n      const ticketNumber = queue.last_issued_number + 1;\n      const position = ticketNumber - queue.current_number;\n      const estimatedTime = position * queue.average_service_time;\n\n      const ticket = await base44.entities.Ticket.create({\n        queue_id: queueId,\n        business_id: businessId,\n        user_email: user.email,\n        ticket_number: ticketNumber,\n        status: \"aguardando\",\n        estimated_time: estimatedTime,\n        position: position,\n        is_premium: false\n      });\n\n      await base44.entities.Queue.update(queueId, {\n        last_issued_number: ticketNumber\n      });\n\n      return ticket;\n    },\n    onSuccess: (ticket) => {\n      queryClient.invalidateQueries({ queryKey: ['all-queues-dash'] });\n      queryClient.invalidateQueries({ queryKey: ['user-active-tickets'] });\n      queryClient.invalidateQueries({ queryKey: ['customer-tickets'] });\n      queryClient.invalidateQueries({ queryKey: ['my-tickets'] });\n      toast.success(`Senha #${ticket.ticket_number} retirada com sucesso! Posição: ${ticket.position}`);\n      navigate(createPageUrl(`TicketView?id=${ticket.id}`));\n    },\n    onError: (error) => {\n      if (error.message !== 'Já tem uma senha ativa') {\n        toast.error(txtErrorIssuingTicket);\n      }\n      setTakingTicket(null);\n    }\n  });\n\n  const handleQuickTicket = (businessId) => {\n    const businessQueues = queues.filter(q => \n      q.business_id === businessId && \n      q.is_active && \n      q.status === \"aberta\"\n    );\n\n    if (businessQueues.length === 0) {\n      toast.error(txtNoQueueAvailable);\n      return;\n    }\n\n    if (businessQueues.length === 1) {\n      setTakingTicket(businessId);\n      createTicketMutation.mutate({\n        businessId,\n        queueId: businessQueues[0].id\n      });\n    } else {\n      navigate(createPageUrl(`BusinessDetail?id=${businessId}`));\n    }\n  };\n\n  const completedCount = recentTickets.filter(t => t.status === 'concluido').length;\n\n  const recentBusinessIds = [...new Set(recentTickets.map(t => t.business_id))];\n  const recentBusinesses = businesses.filter(b => recentBusinessIds.includes(b.id)).slice(0, 4);\n\n  const filteredBusinesses = businesses\n    .filter(b => \n      b.name.toLowerCase().includes(searchTerm.toLowerCase()) ||\n      b.description?.toLowerCase().includes(searchTerm.toLowerCase())\n    )\n    .slice(0, 6);\n\n  if (!user || loadingTickets) {\n    return (\n      <div className=\"bg-gradient-to-br from-slate-50 via-blue-50 to-sky-50 p-4\">\n        <div className=\"max-w-6xl mx-auto\">\n          <Skeleton className=\"h-16 w-64 mb-8\" />\n          <div className=\"grid md:grid-cols-3 gap-4 mb-8\">\n            {[1, 2, 3].map(i => <Skeleton key={i} className=\"h-32\" />)}\n          </div>\n        </div>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"bg-gradient-to-br from-slate-50 via-blue-50 to-sky-50\">\n      <div className=\"max-w-6xl mx-auto px-4 sm:px-6 py-4 sm:py-6\">\n        <div className=\"mb-8\">\n          <h1 className=\"text-3xl md:text-4xl font-bold text-slate-900 mb-2\">\n            Olá, {user.full_name || 'Utilizador'}! 👋\n          </h1>\n          <p className=\"text-slate-600\">Bem-vindo ao seu dashboard</p>\n        </div>\n\n        <div className=\"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 mb-8\">\n          <Card className=\"border-0 shadow-lg\">\n            <CardContent className=\"p-6\">\n              <div className=\"flex items-center justify-between mb-4\">\n                <div className=\"w-12 h-12 rounded-xl bg-gradient-to-br from-blue-500 to-cyan-500 flex items-center justify-center\">\n                  <Clock className=\"w-6 h-6 text-white\" />\n                </div>\n                <Badge className=\"bg-blue-100 text-blue-700 border-blue-200\">Ativas</Badge>\n              </div>\n              <div className=\"text-3xl font-bold text-slate-900 mb-1\">{activeTickets.length}</div>\n              <p className=\"text-sm text-slate-600\">Senhas ativas</p>\n            </CardContent>\n          </Card>\n\n          <Card className=\"border-0 shadow-lg\">\n            <CardContent className=\"p-6\">\n              <div className=\"flex items-center justify-between mb-4\">\n                <div className=\"w-12 h-12 rounded-xl bg-gradient-to-br from-green-500 to-emerald-500 flex items-center justify-center\">\n                  <CheckCircle2 className=\"w-6 h-6 text-white\" />\n                </div>\n                <Badge className=\"bg-green-100 text-green-700 border-green-200\">Concluídas</Badge>\n              </div>\n              <div className=\"text-3xl font-bold text-slate-900 mb-1\">{completedCount}</div>\n              <p className=\"text-sm text-slate-600\">Recentemente</p>\n            </CardContent>\n          </Card>\n\n          <Card className=\"border-0 shadow-lg\">\n            <CardContent className=\"p-6\">\n              <div className=\"flex items-center justify-between mb-4\">\n                <div className=\"w-12 h-12 rounded-xl bg-gradient-to-br from-purple-500 to-pink-500 flex items-center justify-center\">\n                  <Calendar className=\"w-6 h-6 text-white\" />\n                </div>\n                <Badge className=\"bg-purple-100 text-purple-700 border-purple-200\">Agendadas</Badge>\n              </div>\n              <div className=\"text-3xl font-bold text-slate-900 mb-1\">{appointments.length}</div>\n              <p className=\"text-sm text-slate-600\">Marcações</p>\n            </CardContent>\n          </Card>\n        </div>\n\n        {recentBusinesses.length > 0 && (\n          <Card className=\"border-0 shadow-lg mb-8\">\n            <CardHeader>\n              <CardTitle className=\"flex items-center gap-2\">\n                <TrendingUp className=\"w-5 h-5 text-sky-600\" />\n                Acesso Rápido\n              </CardTitle>\n            </CardHeader>\n            <CardContent>\n              <div className=\"grid grid-cols-1 sm:grid-cols-2 gap-3\">\n                {recentBusinesses.map(business => {\n                  const hasQueues = queues.some(q => \n                    q.business_id === business.id && \n                    q.is_active && \n                    q.status === \"aberta\"\n                  );\n                  const hasServices = services.some(s => \n                    s.business_id === business.id && \n                    s.is_active\n                  );\n\n                  return (\n                    <Card key={business.id} className=\"border-2 hover:border-sky-300 transition-colors\">\n                      <CardContent className=\"p-4\">\n                        <div className=\"flex items-center gap-3 mb-3\">\n                          {business.logo_url && (\n                            <img \n                              src={getUploadUrl(business.logo_url)} \n                              alt={business.name}\n                              className=\"w-10 h-10 rounded-lg object-cover\"\n                              onError={(e) => { e.target.style.display = 'none'; }}\n                            />\n                          )}\n                          <div className=\"flex-1 min-w-0\">\n                            <h4 className=\"font-bold text-sm text-slate-900 truncate\">{business.name}</h4>\n                            {business.rating && (\n                              <div className=\"flex items-center gap-1 text-xs\">\n                                <Star className=\"w-3 h-3 fill-yellow-400 text-yellow-400\" />\n                                <span>{business.rating.toFixed(1)}</span>\n                              </div>\n                            )}\n                          </div>\n                        </div>\n                        <div className=\"grid grid-cols-2 gap-2\">\n                          {hasQueues && (\n                            <Button\n                              size=\"sm\"\n                              onClick={() => handleQuickTicket(business.id)}\n                              disabled={takingTicket === business.id}\n                              className=\"bg-gradient-to-r from-sky-500 to-blue-600 h-8 sm:h-11 text-xs gap-1\"\n                            >\n                              <Sparkles className=\"w-3 h-3\" />\n                              Senha\n                            </Button>\n                          )}\n                          {hasServices && (\n                            <Button\n                              size=\"sm\"\n                              variant=\"outline\"\n                              onClick={() => navigate(createPageUrl(`BusinessDetail?id=${business.id}`))}\n                              className=\"h-8 sm:h-11 text-xs gap-1\"\n                            >\n                              <Calendar className=\"w-3 h-3\" />\n                              Marcar\n                            </Button>\n                          )}\n                        </div>\n                      </CardContent>\n                    </Card>\n                  );\n                })}\n              </div>\n            </CardContent>\n          </Card>\n        )}\n\n        <Card className=\"border-0 shadow-lg\">\n          <CardHeader>\n            <div className=\"flex justify-between items-center\">\n              <CardTitle className=\"flex items-center gap-2\">\n                <Building2 className=\"w-5 h-5 text-sky-600\" />\n                Procurar Empresas\n              </CardTitle>\n              <Link to={createPageUrl(\"Businesses\")}>\n                <Button variant=\"outline\" size=\"sm\" className=\"gap-2\">\n                  Ver Todas\n                  <ArrowRight className=\"w-4 h-4\" />\n                </Button>\n              </Link>\n            </div>\n          </CardHeader>\n          <CardContent>\n            <div className=\"relative mb-4\">\n              <Search className=\"absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-slate-400\" />\n              <Input\n                placeholder=\"Pesquisar...\"\n                value={searchTerm}\n                onChange={(e) => setSearchTerm(e.target.value)}\n                className=\"pl-10\"\n              />\n            </div>\n            \n            <div className=\"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3\">\n              {filteredBusinesses.map(business => {\n                const hasQueues = queues.some(q => \n                  q.business_id === business.id && \n                  q.is_active && \n                  q.status === \"aberta\"\n                );\n\n                return (\n                  <Card key={business.id} className=\"border-2 hover:shadow-md transition-all\">\n                    <CardContent className=\"p-3\">\n                      <div className=\"flex items-center gap-2 mb-2\">\n                        {business.logo_url && (\n                          <img \n                            src={getUploadUrl(business.logo_url)} \n                            alt={business.name}\n                            className=\"w-8 h-8 rounded-lg object-cover\"\n                            onError={(e) => { e.target.style.display = 'none'; }}\n                          />\n                        )}\n                        <h4 className=\"font-bold text-xs text-slate-900 truncate flex-1\">{business.name}</h4>\n                      </div>\n                      {hasQueues ? (\n                        <Button\n                          size=\"sm\"\n                          onClick={() => handleQuickTicket(business.id)}\n                          disabled={takingTicket === business.id}\n                          className=\"w-full bg-gradient-to-r from-sky-500 to-blue-600 h-7 sm:h-11 text-xs\"\n                        >\n                          <Sparkles className=\"w-3 h-3 mr-1\" />\n                          Tirar Senha\n                        </Button>\n                      ) : (\n                        <Link to={createPageUrl(`BusinessDetail?id=${business.id}`)}>\n                          <Button size=\"sm\" variant=\"outline\" className=\"w-full h-7 sm:h-11 text-xs\">\n                            Ver Detalhes\n                          </Button>\n                        </Link>\n                      )}\n                    </CardContent>\n                  </Card>\n                );\n              })}\n            </div>\n          </CardContent>\n        </Card>\n      </div>\n    </div>\n  );\n}","path":null,"size_bytes":17598,"size_tokens":null},"src/components/ui/badge.jsx":{"content":"import * as React from \"react\"\nimport { cva } from \"class-variance-authority\";\n\nimport { cn } from \"@/lib/utils\"\n\nconst badgeVariants = cva(\n  \"inline-flex items-center rounded-md border px-2.5 py-0.5 text-xs font-semibold transition-colors focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2\",\n  {\n    variants: {\n      variant: {\n        default:\n          \"border-transparent bg-primary text-primary-foreground shadow hover:bg-primary/80\",\n        secondary:\n          \"border-transparent bg-secondary text-secondary-foreground hover:bg-secondary/80\",\n        destructive:\n          \"border-transparent bg-destructive text-destructive-foreground shadow hover:bg-destructive/80\",\n        outline: \"text-foreground\",\n      },\n    },\n    defaultVariants: {\n      variant: \"default\",\n    },\n  }\n)\n\nfunction Badge({\n  className,\n  variant,\n  ...props\n}) {\n  return (<div className={cn(badgeVariants({ variant }), className)} {...props} />);\n}\n\nexport { Badge, badgeVariants }\n","path":null,"size_bytes":990,"size_tokens":null},"src/pages/BusinessProfileSetup.jsx":{"content":"import React, { useState, useEffect } from \"react\";\nimport { base44 } from \"@/api/base44Client\";\nimport { useNavigate, useLocation } from \"react-router-dom\";\nimport { createPageUrl } from \"@/utils\";\nimport { Loader2, AlertCircle, CreditCard, Edit, ArrowRight } from \"lucide-react\";\nimport { CompanyProfileForm } from '@/components/business/CompanyProfileForm';\nimport { companyProfileStorage } from '@/models/companyProfile';\nimport { Button } from \"@/components/ui/button\";\nimport { Card, CardContent } from \"@/components/ui/card\";\nimport { Alert, AlertDescription } from \"@/components/ui/alert\";\nimport { useAutoTranslate } from \"@/hooks/useTranslate\";\n\nexport default function BusinessProfileSetupPage() {\n  const txtLoading = useAutoTranslate('A carregar...', 'pt');\n  const txtPaymentError = useAutoTranslate('Erro ao Processar Pagamento', 'pt');\n  const txtPaymentErrorDesc = useAutoTranslate('Ocorreu um problema ao processar seu pagamento. Por favor, escolha uma opção abaixo.', 'pt');\n  const txtProfileFound = useAutoTranslate('Perfil encontrado:', 'pt');\n  const txtEmail = useAutoTranslate('Email:', 'pt');\n  const txtStatus = useAutoTranslate('Status:', 'pt');\n  const txtAwaitingPayment = useAutoTranslate('Aguardando pagamento', 'pt');\n  const txtFailedAttempts = useAutoTranslate('Tentativas falhadas:', 'pt');\n  const txtLastError = useAutoTranslate('Último erro:', 'pt');\n  const txtRetryPayment = useAutoTranslate('Tentar Pagamento Novamente', 'pt');\n  const txtEditProfile = useAutoTranslate('Editar Perfil da Empresa', 'pt');\n  const txtTipPersist = useAutoTranslate('Dica: Se o problema persistir, verifique se os dados da empresa estão corretos ou entre em contato com o suporte.', 'pt');\n  const txtAutoHide = useAutoTranslate('Esta mensagem desaparecerá automaticamente após 5 minutos ou quando tentar novamente.', 'pt');\n  const txtCreateBusinessAccount = useAutoTranslate('Criar Conta Empresarial', 'pt');\n  const txtStep1 = useAutoTranslate('Passo 1 de 2: Preencha o perfil da sua empresa', 'pt');\n  const navigate = useNavigate();\n  const location = useLocation();\n  const [user, setUser] = useState(null);\n  const [loading, setLoading] = useState(true);\n  const [pendingProfile, setPendingProfile] = useState(null);\n  const [showPaymentErrorRecovery, setShowPaymentErrorRecovery] = useState(false);\n\n  useEffect(() => {\n    base44.auth.me().then(async (userData) => {\n      setUser(userData);\n      \n      const existingProfile = await companyProfileStorage.getByUserId(userData.id);\n      \n      if (existingProfile) {\n        console.log('🏢 Perfil existente encontrado:', {\n          id: existingProfile.id,\n          name: existingProfile.companyName,\n          status: existingProfile.status\n        });\n        \n        if (existingProfile.status === 'active') {\n          console.log('✅ Perfil ativo - redirecionando para Dashboard');\n          navigate(createPageUrl('BusinessDashboard'));\n          return;\n        }\n        \n        if (existingProfile.status === 'pending_payment') {\n          const { paymentRetry } = existingProfile;\n          \n          if (paymentRetry && paymentRetry.lastFailureAt && paymentRetry.failureCount > 0) {\n            const lastFailureTime = new Date(paymentRetry.lastFailureAt).getTime();\n            const timeSinceError = Date.now() - lastFailureTime;\n            const minutesSinceError = Math.floor(timeSinceError / 60000);\n            \n            if (timeSinceError < 300000) {\n              console.warn('⚠️ Erro de pagamento persistente detectado no profile');\n              console.warn(`📊 Falhas: ${paymentRetry.failureCount}`);\n              console.warn(`⏱️ Última falha: há ${minutesSinceError} minuto(s)`);\n              console.warn(`❌ Razão: ${paymentRetry.lastFailureReason}`);\n              \n              setPendingProfile(existingProfile);\n              setShowPaymentErrorRecovery(true);\n              setLoading(false);\n              return;\n            } else {\n              console.log(`🔄 Falha antiga (${minutesSinceError} min) - limpando e permitindo retry`);\n              await companyProfileStorage.update(existingProfile.id, {\n                paymentRetry: {\n                  failureCount: 0,\n                  lastFailureAt: null,\n                  lastFailureReason: null,\n                  canRetry: true\n                }\n              });\n            }\n          }\n          \n          console.log('⏳ Perfil pendente de pagamento - redirecionando para Subscrição');\n          navigate(createPageUrl('BusinessSubscription'), { state: { profile: existingProfile } });\n          return;\n        }\n      }\n      \n      console.log('📝 Nenhum perfil encontrado - mostrando formulário');\n      setLoading(false);\n    }).catch(() => {\n      base44.auth.redirectToLogin();\n    });\n  }, [navigate]);\n\n  const handleComplete = (profile) => {\n    navigate(createPageUrl('BusinessSubscription'), { state: { profile } });\n  };\n\n  const handleRetryPayment = async () => {\n    if (pendingProfile) {\n      await companyProfileStorage.update(pendingProfile.id, {\n        paymentRetry: {\n          failureCount: 0,\n          lastFailureAt: null,\n          lastFailureReason: null,\n          canRetry: true\n        }\n      });\n      \n      navigate(createPageUrl('BusinessSubscription'), { state: { profile: pendingProfile } });\n    }\n  };\n\n  const handleEditProfile = () => {\n    if (pendingProfile) {\n      setPendingProfile(null);\n      setShowPaymentErrorRecovery(false);\n      setLoading(false);\n    }\n  };\n\n  if (loading || !user) {\n    return (\n      <div className=\"bg-gradient-to-br from-slate-50 to-blue-50 flex items-center justify-center px-4\">\n        <div className=\"text-center\">\n          <Loader2 className=\"w-10 h-10 animate-spin text-indigo-600 mx-auto mb-4\" />\n          <p className=\"text-slate-600 text-lg\">{txtLoading}</p>\n        </div>\n      </div>\n    );\n  }\n\n  if (showPaymentErrorRecovery && pendingProfile) {\n    return (\n      <div className=\"bg-gradient-to-br from-slate-50 to-blue-50 py-4 sm:py-8 px-4 safe-area-inset\">\n        <div className=\"max-w-lg mx-auto\">\n          <Card className=\"border-amber-300 shadow-xl\">\n            <CardContent className=\"p-5 sm:p-8\">\n              <div className=\"text-center mb-6\">\n                <div className=\"w-16 h-16 bg-amber-100 rounded-full flex items-center justify-center mx-auto mb-4\">\n                  <AlertCircle className=\"w-8 h-8 text-amber-600\" />\n                </div>\n                <h1 className=\"text-xl sm:text-2xl font-bold text-slate-900 mb-2\">\n                  {txtPaymentError}\n                </h1>\n                <p className=\"text-sm sm:text-base text-slate-600\">\n                  {txtPaymentErrorDesc}\n                </p>\n              </div>\n\n              <Alert className=\"mb-6 border-blue-300 bg-blue-50\">\n                <AlertCircle className=\"h-4 w-4 text-blue-600 flex-shrink-0\" />\n                <AlertDescription className=\"text-blue-900 text-sm\">\n                  <strong>{txtProfileFound}</strong> {pendingProfile.companyName}<br />\n                  <strong>{txtEmail}</strong> {pendingProfile.companyEmail}<br />\n                  <strong>{txtStatus}</strong> {txtAwaitingPayment}<br />\n                  {pendingProfile.paymentRetry?.failureCount > 0 && (\n                    <>\n                      <strong>{txtFailedAttempts}</strong> {pendingProfile.paymentRetry.failureCount}<br />\n                      <strong>{txtLastError}</strong> {pendingProfile.paymentRetry.lastFailureReason}\n                    </>\n                  )}\n                </AlertDescription>\n              </Alert>\n\n              <div className=\"space-y-3\">\n                <Button\n                  onClick={handleRetryPayment}\n                  className=\"w-full bg-gradient-to-r from-indigo-600 to-blue-600 hover:from-indigo-700 hover:to-blue-700 h-14 text-base\"\n                >\n                  <CreditCard className=\"w-5 h-5 mr-2\" />\n                  {txtRetryPayment}\n                  <ArrowRight className=\"w-5 h-5 ml-2\" />\n                </Button>\n\n                <Button\n                  onClick={handleEditProfile}\n                  variant=\"outline\"\n                  className=\"w-full h-14 text-base border-slate-300\"\n                >\n                  <Edit className=\"w-5 h-5 mr-2\" />\n                  {txtEditProfile}\n                </Button>\n              </div>\n\n              <p className=\"text-xs sm:text-sm text-slate-500 text-center mt-6\">\n                {pendingProfile.paymentRetry?.failureCount > 1 && (\n                  <>💡 {txtTipPersist}<br /></>\n                )}\n                {txtAutoHide}\n              </p>\n            </CardContent>\n          </Card>\n        </div>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"bg-gradient-to-br from-slate-50 to-blue-50 py-4 sm:py-8 px-3 sm:px-4 safe-area-inset\">\n      <div className=\"max-w-2xl mx-auto\">\n        <div className=\"text-center mb-6 sm:mb-8\">\n          <h1 className=\"text-2xl sm:text-4xl font-bold text-slate-900 mb-2\">\n            {txtCreateBusinessAccount}\n          </h1>\n          <p className=\"text-sm sm:text-lg text-slate-600\">\n            {txtStep1}\n          </p>\n        </div>\n        \n        <CompanyProfileForm onComplete={handleComplete} />\n      </div>\n    </div>\n  );\n}\n","path":null,"size_bytes":9329,"size_tokens":null},"src/pages/AdminActivate.jsx":{"content":"import React, { useState } from \"react\";\nimport { base44 } from \"@/api/base44Client\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { useAutoTranslate } from \"@/hooks/useTranslate\";\n\nexport default function AdminActivatePage() {\n  // Traduções\n  const txtActivateManually = useAutoTranslate('Ativar Subscrição Manualmente', 'pt');\n  const txtUserEmail = useAutoTranslate('Email do utilizador', 'pt');\n  const txtActivating = useAutoTranslate('A ativar...', 'pt');\n  const txtActivateSubscription = useAutoTranslate('Ativar Subscrição', 'pt');\n\n  const [email, setEmail] = useState(\"sofialopesdecoutinho@gmail.com\");\n  const [loading, setLoading] = useState(false);\n  const [result, setResult] = useState(null);\n\n  const handleActivate = async () => {\n    setLoading(true);\n    setResult(null);\n    try {\n      const response = await base44.functions.invoke('forceActivateSubscription', { email });\n      setResult({ success: true, data: response.data });\n    } catch (error) {\n      setResult({ success: false, error: error.message });\n    }\n    setLoading(false);\n  };\n\n  return (\n    <div className=\"bg-gradient-to-br from-slate-50 via-blue-50 to-sky-50 p-4\">\n      <Card className=\"max-w-md mx-auto\">\n        <CardHeader>\n          <CardTitle>{txtActivateManually}</CardTitle>\n        </CardHeader>\n        <CardContent className=\"space-y-4\">\n          <Input\n            value={email}\n            onChange={(e) => setEmail(e.target.value)}\n            placeholder={txtUserEmail}\n          />\n          <Button\n            onClick={handleActivate}\n            disabled={loading}\n            className=\"w-full\"\n          >\n            {loading ? txtActivating : txtActivateSubscription}\n          </Button>\n          {result && (\n            <div className={`p-4 rounded-lg ${result.success ? 'bg-green-50 text-green-800' : 'bg-red-50 text-red-800'}`}>\n              <pre className=\"text-xs\">{JSON.stringify(result, null, 2)}</pre>\n            </div>\n          )}\n        </CardContent>\n      </Card>\n    </div>\n  );\n}","path":null,"size_bytes":2164,"size_tokens":null},"src/components/portal/AppointmentHistory.jsx":{"content":"import React from \"react\";\nimport { useTranslation } from \"react-i18next\";\nimport { base44 } from \"@/api/base44Client\";\nimport { useQuery, useMutation, useQueryClient } from \"@tanstack/react-query\";\nimport { Card, CardContent } from \"@/components/ui/card\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Button } from \"@/components/ui/button\";\nimport { Tabs, TabsList, TabsTrigger, TabsContent } from \"@/components/ui/tabs\";\nimport { Calendar, MapPin, Clock, X, Star, Trash2 } from \"lucide-react\";\nimport { format } from \"date-fns\";\nimport { pt, enUS, de, es, fr, it, nl, pl, sv, da, nb, fi, cs, el, ro, hu, bg, hr, sk, sl, is, ja, th } from \"date-fns/locale\";\nimport { Skeleton } from \"@/components/ui/skeleton\";\nimport { toast } from \"sonner\";\nimport { useConfirm } from \"@/hooks/useConfirm\";\nimport { useAutoTranslate } from \"@/hooks/useTranslate\";\n\nexport default function AppointmentHistory({ user }) {\n  const { i18n } = useTranslation();\n  \n  const txtScheduled = useAutoTranslate('Agendado', 'pt');\n  const txtConfirmed = useAutoTranslate('Confirmado', 'pt');\n  const txtServing = useAutoTranslate('Em Atendimento', 'pt');\n  const txtCompleted = useAutoTranslate('Concluído', 'pt');\n  const txtCancelled = useAutoTranslate('Cancelado', 'pt');\n  const txtNoShow = useAutoTranslate('Falta', 'pt');\n  const txtAppointmentRemoved = useAutoTranslate('marcação removida', 'pt');\n  const txtAppointmentsRemoved = useAutoTranslate('marcações removidas', 'pt');\n  const txtErrorClearHistory = useAutoTranslate('Erro ao limpar histórico', 'pt');\n  const txtClearAppointmentHistory = useAutoTranslate('Limpar Histórico de Marcações', 'pt');\n  const txtConfirmClearAppointments = useAutoTranslate('Tem a certeza que deseja limpar', 'pt');\n  const txtConfirmClearAction = useAutoTranslate('Sim, limpar histórico', 'pt');\n  const txtCancel = useAutoTranslate('Cancelar', 'pt');\n  const txtBusiness = useAutoTranslate('Empresa', 'pt');\n  const txtService = useAutoTranslate('Serviço', 'pt');\n  const txtCancelAppointment = useAutoTranslate('Cancelar Marcação', 'pt');\n  const txtConfirmCancelAppointment = useAutoTranslate('Tem a certeza que deseja cancelar esta marcação?', 'pt');\n  const txtConfirm = useAutoTranslate('Confirmar', 'pt');\n  const txtAt = useAutoTranslate('às', 'pt');\n  const txtCreatedOn = useAutoTranslate('Criado a', 'pt');\n  const txtAppointmentScheduled = useAutoTranslate('Marcação Agendada', 'pt');\n  const txtUpcoming = useAutoTranslate('Próximas', 'pt');\n  const txtHistory = useAutoTranslate('Histórico', 'pt');\n  const txtNoAppointments = useAutoTranslate('Sem marcações agendadas', 'pt');\n  const txtSchedulePrompt = useAutoTranslate('As suas próximas marcações aparecerão aqui', 'pt');\n  const txtNoHistory = useAutoTranslate('Sem histórico', 'pt');\n  const txtCompletedAppointmentsAppearHere = useAutoTranslate('As marcações concluídas aparecerão aqui', 'pt');\n  const txtClearing = useAutoTranslate('A limpar...', 'pt');\n  const txtClearHistory = useAutoTranslate('Limpar Histórico', 'pt');\n  \n  const getDateLocale = () => {\n    const lang = i18n.language.split('-')[0];\n    const localeMap = { \n      pt, en: enUS, de, es, fr, it, nl, pl, sv, da, no: nb, fi, cs, el, ro, hu, bg, hr, sk, sl, is, ja, th\n    };\n    return localeMap[lang] || enUS;\n  };\n  \n  const statusConfig = {\n    agendado: { color: \"bg-blue-100 text-blue-700 border-blue-200\", label: txtScheduled },\n    confirmado: { color: \"bg-green-100 text-green-700 border-green-200\", label: txtConfirmed },\n    em_atendimento: { color: \"bg-purple-100 text-purple-700 border-purple-200\", label: txtServing },\n    concluido: { color: \"bg-slate-100 text-slate-700 border-slate-200\", label: txtCompleted },\n    cancelado: { color: \"bg-red-100 text-red-700 border-red-200\", label: txtCancelled },\n    falta: { color: \"bg-orange-100 text-orange-700 border-orange-200\", label: txtNoShow }\n  };\n  const queryClient = useQueryClient();\n  const { ConfirmDialog, confirm } = useConfirm();\n\n  const { data: appointments, isLoading } = useQuery({\n    queryKey: ['customer-appointments', user.email],\n    queryFn: () => base44.entities.Appointment.filter({ user_email: user.email }, '-appointment_date'),\n    initialData: [],\n  });\n\n  const { data: businesses } = useQuery({\n    queryKey: ['businesses-list'],\n    queryFn: () => base44.entities.Business.list(),\n    initialData: [],\n  });\n\n  const { data: services } = useQuery({\n    queryKey: ['services-list'],\n    queryFn: () => base44.entities.Service.list(),\n    initialData: [],\n  });\n\n  const cancelMutation = useMutation({\n    mutationFn: async (appointmentId) => {\n      await base44.entities.Appointment.update(appointmentId, { status: 'cancelado' });\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['customer-appointments'] });\n    },\n  });\n\n  const clearHistoryMutation = useMutation({\n    mutationFn: async () => {\n      const appointmentsToDelete = appointments.filter(a => \n        a && ['concluido', 'cancelado', 'falta'].includes(a.status)\n      );\n      \n      for (const appointment of appointmentsToDelete) {\n        await base44.entities.Appointment.delete(appointment.id);\n      }\n      \n      return appointmentsToDelete.length;\n    },\n    onSuccess: (count) => {\n      queryClient.invalidateQueries({ queryKey: ['customer-appointments'] });\n      const message = count === 1 ? txtAppointmentRemoved : txtAppointmentsRemoved;\n      toast.success(`${count} ${message}`);\n    },\n    onError: () => {\n      toast.error(txtErrorClearHistory);\n    }\n  });\n\n  const handleClearHistory = async () => {\n    const confirmed = await confirm({\n      title: txtClearAppointmentHistory,\n      description: `${txtConfirmClearAppointments} ${pastAppointments.length} marcações?`,\n      confirmText: txtConfirmClearAction,\n      cancelText: txtCancel\n    });\n\n    if (confirmed) {\n      clearHistoryMutation.mutate();\n    }\n  };\n\n  const upcomingAppointments = appointments.filter(a => \n    ['agendado', 'confirmado'].includes(a.status) &&\n    new Date(a.appointment_date) >= new Date()\n  );\n  \n  const pastAppointments = appointments.filter(a => \n    ['concluido', 'cancelado', 'falta'].includes(a.status) ||\n    (new Date(a.appointment_date) < new Date() && a.status !== 'em_atendimento')\n  );\n\n  const getBusinessName = (businessId) => {\n    return businesses.find(b => b.id === businessId)?.name || txtBusiness;\n  };\n\n  const getServiceName = (serviceId) => {\n    return services.find(s => s.id === serviceId)?.name || txtService;\n  };\n\n  const AppointmentCard = ({ appointment }) => {\n    const status = statusConfig[appointment.status];\n    const canCancel = ['agendado', 'confirmado'].includes(appointment.status) && \n                     new Date(appointment.appointment_date) > new Date();\n    \n    const handleCancelAppointment = async () => {\n      const confirmed = await confirm({\n        title: txtCancelAppointment,\n        description: txtConfirmCancelAppointment,\n        confirmText: txtConfirm,\n        cancelText: txtCancel\n      });\n      if (confirmed) {\n        cancelMutation.mutate(appointment.id);\n      }\n    };\n\n    return (\n      <Card className=\"border-0 shadow-lg hover:shadow-xl transition-all\">\n        <CardContent className=\"p-6\">\n          <div className=\"flex justify-between items-start mb-4\">\n            <div>\n              <div className=\"flex items-center gap-2 text-slate-900 mb-2\">\n                <Calendar className=\"w-5 h-5 text-sky-600\" />\n                <span className=\"font-bold text-lg\">\n                  {format(new Date(appointment.appointment_date), \"dd MMMM\", { locale: getDateLocale() })}\n                </span>\n                <span className=\"text-slate-600\">{txtAt} {appointment.appointment_time}</span>\n              </div>\n              <div className=\"flex items-center gap-2 text-slate-600 mb-1\">\n                <MapPin className=\"w-4 h-4\" />\n                <span className=\"font-semibold\">{getBusinessName(appointment.business_id)}</span>\n              </div>\n              <p className=\"text-sm text-slate-500\">{getServiceName(appointment.service_id)}</p>\n            </div>\n            <Badge className={status.color}>\n              {status.label}\n            </Badge>\n          </div>\n\n          {appointment.notes && (\n            <div className=\"mb-4 p-3 bg-slate-50 rounded-lg\">\n              <p className=\"text-sm text-slate-600\">{appointment.notes}</p>\n            </div>\n          )}\n\n          {appointment.rating && (\n            <div className=\"mb-4 flex items-center gap-2\">\n              <div className=\"flex\">\n                {[1, 2, 3, 4, 5].map(star => (\n                  <Star\n                    key={star}\n                    className={`w-4 h-4 ${star <= appointment.rating ? 'fill-amber-400 text-amber-400' : 'text-slate-300'}`}\n                  />\n                ))}\n              </div>\n              {appointment.feedback && (\n                <span className=\"text-sm text-slate-600\">\"{appointment.feedback}\"</span>\n              )}\n            </div>\n          )}\n\n          <div className=\"flex justify-between items-center pt-4 border-t\">\n            <span className=\"text-xs text-slate-500\">\n              {appointment.created_date ? (\n                <>{txtCreatedOn} {format(new Date(appointment.created_date), \"dd/MM/yyyy\", { locale: getDateLocale() })}</>\n              ) : (\n                <>{txtAppointmentScheduled}</>\n              )}\n            </span>\n            {canCancel && (\n              <Button\n                size=\"sm\"\n                variant=\"outline\"\n                className=\"border-red-200 text-red-600 hover:bg-red-50\"\n                onClick={handleCancelAppointment}\n                disabled={cancelMutation.isPending}\n              >\n                <X className=\"w-4 h-4 mr-2\" />\n                {txtCancel}\n              </Button>\n            )}\n          </div>\n        </CardContent>\n      </Card>\n    );\n  };\n\n  if (isLoading) {\n    return (\n      <div className=\"grid md:grid-cols-2 gap-6\">\n        {[1, 2, 3, 4].map(i => <Skeleton key={i} className=\"h-64\" />)}\n      </div>\n    );\n  }\n\n  return (\n    <Tabs defaultValue=\"upcoming\">\n      <TabsList className=\"bg-white border border-slate-200 mb-6\">\n        <TabsTrigger value=\"upcoming\">\n          {txtUpcoming} ({upcomingAppointments.length})\n        </TabsTrigger>\n        <TabsTrigger value=\"past\">\n          {txtHistory} ({pastAppointments.length})\n        </TabsTrigger>\n      </TabsList>\n\n      <TabsContent value=\"upcoming\">\n        {upcomingAppointments.length === 0 ? (\n          <Card className=\"border-0 shadow-lg\">\n            <CardContent className=\"py-16 text-center\">\n              <Calendar className=\"w-16 h-16 text-slate-400 mx-auto mb-4\" />\n              <h3 className=\"text-xl font-bold text-slate-900 mb-2\">\n                {txtNoAppointments}\n              </h3>\n              <p className=\"text-slate-600\">\n                {txtSchedulePrompt}\n              </p>\n            </CardContent>\n          </Card>\n        ) : (\n          <div className=\"grid md:grid-cols-2 gap-6\">\n            {upcomingAppointments.map(appointment => (\n              <AppointmentCard key={appointment.id} appointment={appointment} />\n            ))}\n          </div>\n        )}\n      </TabsContent>\n\n      <TabsContent value=\"past\">\n        {pastAppointments.length === 0 ? (\n          <Card className=\"border-0 shadow-lg\">\n            <CardContent className=\"py-16 text-center\">\n              <Clock className=\"w-16 h-16 text-slate-400 mx-auto mb-4\" />\n              <h3 className=\"text-xl font-bold text-slate-900 mb-2\">\n                {txtNoHistory}\n              </h3>\n              <p className=\"text-slate-600\">\n                {txtCompletedAppointmentsAppearHere}\n              </p>\n            </CardContent>\n          </Card>\n        ) : (\n          <div className=\"space-y-4\">\n            <div className=\"flex justify-end\">\n              <Button\n                variant=\"outline\"\n                size=\"sm\"\n                onClick={handleClearHistory}\n                disabled={clearHistoryMutation.isPending}\n                className=\"border-red-200 text-red-600 hover:bg-red-50\"\n              >\n                <Trash2 className=\"w-4 h-4 mr-2\" />\n                {clearHistoryMutation.isPending ? txtClearing : txtClearHistory}\n              </Button>\n            </div>\n            <div className=\"grid md:grid-cols-2 gap-6\">\n              {pastAppointments.map(appointment => (\n                <AppointmentCard key={appointment.id} appointment={appointment} />\n              ))}\n            </div>\n          </div>\n        )}\n      </TabsContent>\n      <ConfirmDialog />\n    </Tabs>\n  );\n}","path":null,"size_bytes":12696,"size_tokens":null},"src/pages/StripeCheckout.jsx":{"content":"import React, { useState, useEffect } from \"react\";\nimport { base44 } from \"@/api/base44Client\";\nimport { useNavigate } from \"react-router-dom\";\nimport { createPageUrl } from \"@/utils\";\nimport { Card, CardContent } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Crown, Sparkles, CheckCircle2, Shield, CreditCard, Lock, Loader2 } from \"lucide-react\";\nimport { useAutoTranslate } from \"@/hooks/useTranslate\";\n\nexport default function StripeCheckoutPage() {\n  // Traduções gerais\n  const txtPremium = useAutoTranslate('Premium', 'pt');\n  const txtBusiness = useAutoTranslate('Empresarial', 'pt');\n  const txtCheckoutError = useAutoTranslate('Failed to create checkout session', 'pt');\n  const txtPaymentError = useAutoTranslate('Erro ao processar pagamento', 'pt');\n  const txtLoading = useAutoTranslate('A carregar...', 'pt');\n  const txtSubscription = useAutoTranslate('Subscrição', 'pt');\n  const txtPerMonth = useAutoTranslate('/mês', 'pt');\n  const txtFeaturesIncluded = useAutoTranslate('Funcionalidades incluídas:', 'pt');\n  const txtProcessing = useAutoTranslate('A processar...', 'pt');\n  const txtPayWith = useAutoTranslate('Pagar', 'pt');\n  const txtWithStripe = useAutoTranslate('com Stripe', 'pt');\n  const txtSecurePayment = useAutoTranslate('Pagamento 100% seguro via Stripe', 'pt');\n  const txtVisa = useAutoTranslate('Visa', 'pt');\n  const txtMastercard = useAutoTranslate('Mastercard', 'pt');\n  const txtMBWay = useAutoTranslate('MB Way', 'pt');\n  const txtTerms = useAutoTranslate('Termos de Serviço', 'pt');\n  const txtPrivacy = useAutoTranslate('Política de Privacidade', 'pt');\n  const txtRefundGuarantee = useAutoTranslate('Garantia de reembolso de 30 dias.', 'pt');\n  const txtAgreement = useAutoTranslate('Ao continuar, concorda com os nossos', 'pt');\n\n  // Features Premium\n  const txtFeatureAI = useAutoTranslate('🤖 IA recomenda melhores horários', 'pt');\n  const txtFeatureStats = useAutoTranslate('📊 Estatísticas pessoais detalhadas', 'pt');\n  const txtFeatureNotif = useAutoTranslate('⚡ Notificações prioritárias avançadas', 'pt');\n  const txtFeatureMulti = useAutoTranslate('🎫 Multisenhas (várias ao mesmo tempo)', 'pt');\n  const txtFeatureFav = useAutoTranslate('❤️ Guardar lugares favoritos', 'pt');\n  const txtFeatureWidget = useAutoTranslate('📱 Widget no telemóvel', 'pt');\n  const txtFeatureFamily = useAutoTranslate('👨‍👩‍👧 Perfil familiar', 'pt');\n  const txtFeatureAlerts = useAutoTranslate('🔔 Alertas personalizados', 'pt');\n\n  // Features Business\n  const txtFeatureQueueMgmt = useAutoTranslate('🏢 Gestão completa de filas', 'pt');\n  const txtFeatureBookings = useAutoTranslate('📅 Sistema de marcações', 'pt');\n  const txtFeatureTeam = useAutoTranslate('👥 Gestão de equipa', 'pt');\n  const txtFeatureAdvStats = useAutoTranslate('📊 Estatísticas avançadas', 'pt');\n  const txtFeatureAIAnalysis = useAutoTranslate('🤖 Análise com IA', 'pt');\n  const txtFeatureAutoNotif = useAutoTranslate('📧 Notificações automáticas', 'pt');\n  const txtFeatureTemplates = useAutoTranslate('💬 Templates de mensagens', 'pt');\n  const txtFeatureCalendar = useAutoTranslate('🔗 Integração com calendário', 'pt');\n\n  const navigate = useNavigate();\n  const [user, setUser] = useState(null);\n  const [loading, setLoading] = useState(false);\n  const [error, setError] = useState(null);\n\n  const urlParams = new URLSearchParams(window.location.search);\n  const planType = urlParams.get('plan') || 'premium';\n\n  useEffect(() => {\n    base44.auth.me().then(setUser).catch(() => {\n      base44.auth.redirectToLogin(createPageUrl('StripeCheckout') + `?plan=${planType}`);\n    });\n  }, [planType]);\n\n  const planDetails = {\n    premium: {\n      name: txtPremium,\n      price: 49.99,\n      icon: Crown,\n      color: \"from-purple-600 to-pink-600\",\n      features: [\n        txtFeatureAI,\n        txtFeatureStats,\n        txtFeatureNotif,\n        txtFeatureMulti,\n        txtFeatureFav,\n        txtFeatureWidget,\n        txtFeatureFamily,\n        txtFeatureAlerts\n      ]\n    },\n    business: {\n      name: txtBusiness,\n      price: 49.99,\n      icon: Sparkles,\n      color: \"from-amber-500 to-orange-600\",\n      features: [\n        txtFeatureQueueMgmt,\n        txtFeatureBookings,\n        txtFeatureTeam,\n        txtFeatureAdvStats,\n        txtFeatureAIAnalysis,\n        txtFeatureAutoNotif,\n        txtFeatureTemplates,\n        txtFeatureCalendar\n      ]\n    }\n  };\n\n  const plan = planDetails[planType];\n\n  const handleCheckout = async () => {\n    setLoading(true);\n    setError(null);\n\n    try {\n      const response = await base44.functions.invoke('createCheckoutSession', {\n        plan: planType\n      });\n\n      if (response.data.url) {\n        window.location.href = response.data.url;\n      } else {\n        throw new Error(txtCheckoutError);\n      }\n    } catch (err) {\n      console.error('Checkout error:', err);\n      setError(err.response?.data?.error || err.message || txtPaymentError);\n      setLoading(false);\n    }\n  };\n\n  if (!user) {\n    return (\n      <div className=\"bg-gradient-to-br from-slate-50 via-blue-50 to-sky-50 flex items-center justify-center p-4\">\n        <div className=\"text-center\">\n          <Loader2 className=\"w-12 h-12 animate-spin text-purple-600 mx-auto mb-4\" />\n          <p className=\"text-slate-600\">{txtLoading}</p>\n        </div>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"bg-gradient-to-br from-slate-50 via-blue-50 to-sky-50\">\n      <div className=\"max-w-2xl mx-auto px-4 py-4\">\n        <Card className=\"border-0 shadow-2xl overflow-hidden\">\n          <div className={`h-2 bg-gradient-to-r ${plan.color}`} />\n          <CardContent className=\"p-8\">\n            <div className=\"text-center mb-8\">\n              <div className={`w-20 h-20 rounded-full bg-gradient-to-br ${plan.color} flex items-center justify-center mx-auto mb-4`}>\n                <plan.icon className=\"w-10 h-10 text-white\" />\n              </div>\n              <h1 className=\"text-3xl font-bold text-slate-900 mb-2\">\n                {txtSubscription} {plan.name}\n              </h1>\n              <div className=\"flex items-baseline justify-center gap-2\">\n                <span className=\"text-5xl font-bold text-slate-900\">€{plan.price.toFixed(2)}</span>\n                <span className=\"text-slate-600\">{txtPerMonth}</span>\n              </div>\n            </div>\n\n            {error && (\n              <div className=\"mb-6 p-4 bg-red-50 border border-red-200 rounded-lg\">\n                <p className=\"text-red-700 text-sm\">{error}</p>\n              </div>\n            )}\n\n            <div className=\"space-y-3 mb-8\">\n              <h3 className=\"font-semibold text-slate-900 mb-4\">{txtFeaturesIncluded}</h3>\n              {plan.features.map((feature, idx) => (\n                <div key={idx} className=\"flex items-start gap-3\">\n                  <CheckCircle2 className=\"w-5 h-5 text-green-600 flex-shrink-0 mt-0.5\" />\n                  <span className=\"text-slate-700\">{feature}</span>\n                </div>\n              ))}\n            </div>\n\n            <Button\n              onClick={handleCheckout}\n              disabled={loading}\n              className={`w-full py-6 text-lg bg-gradient-to-r ${plan.color} hover:opacity-90 mb-4`}\n            >\n              {loading ? (\n                <>\n                  <Loader2 className=\"w-5 h-5 mr-2 animate-spin\" />\n                  {txtProcessing}\n                </>\n              ) : (\n                <>\n                  <Shield className=\"w-5 h-5 mr-2\" />\n                  {txtPayWith} €{plan.price.toFixed(2)} {txtWithStripe}\n                </>\n              )}\n            </Button>\n\n            <div className=\"space-y-3\">\n              <div className=\"flex items-center justify-center gap-2 text-sm text-slate-600\">\n                <Lock className=\"w-4 h-4\" />\n                <span>{txtSecurePayment}</span>\n              </div>\n\n              <div className=\"flex items-center justify-center gap-4 pt-4 border-t\">\n                <Badge variant=\"outline\" className=\"bg-white\">\n                  <CreditCard className=\"w-3 h-3 mr-1\" />\n                  {txtVisa}\n                </Badge>\n                <Badge variant=\"outline\" className=\"bg-white\">\n                  <CreditCard className=\"w-3 h-3 mr-1\" />\n                  {txtMastercard}\n                </Badge>\n                <Badge variant=\"outline\" className=\"bg-white\">\n                  <CreditCard className=\"w-3 h-3 mr-1\" />\n                  {txtMBWay}\n                </Badge>\n              </div>\n            </div>\n\n            <p className=\"text-xs text-slate-500 text-center mt-6\">\n              {txtAgreement} <span className=\"underline cursor-pointer\">{txtTerms}</span> e <span className=\"underline cursor-pointer\">{txtPrivacy}</span>. \n              {txtRefundGuarantee}\n            </p>\n          </CardContent>\n        </Card>\n      </div>\n    </div>\n  );\n}","path":null,"size_bytes":9014,"size_tokens":null},"src/components/ui/dialog.jsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as DialogPrimitive from \"@radix-ui/react-dialog\"\nimport { X } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Dialog = DialogPrimitive.Root\n\nconst DialogTrigger = DialogPrimitive.Trigger\n\nconst DialogPortal = DialogPrimitive.Portal\n\nconst DialogClose = DialogPrimitive.Close\n\nconst DialogOverlay = React.forwardRef(({ className, ...props }, ref) => (\n  <DialogPrimitive.Overlay\n    ref={ref}\n    className={cn(\n      \"fixed inset-0 z-50 bg-black/80  data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0\",\n      className\n    )}\n    {...props} />\n))\nDialogOverlay.displayName = DialogPrimitive.Overlay.displayName\n\nconst DialogContent = React.forwardRef(({ className, children, ...props }, ref) => (\n  <DialogPortal>\n    <DialogOverlay />\n    <DialogPrimitive.Content\n      ref={ref}\n      className={cn(\n        \"fixed left-[50%] top-[50%] z-50 grid w-[calc(100%-2rem)] max-w-lg translate-x-[-50%] translate-y-[-50%] gap-4 border bg-background p-4 shadow-lg duration-200 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[state=closed]:slide-out-to-left-1/2 data-[state=closed]:slide-out-to-top-[48%] data-[state=open]:slide-in-from-left-1/2 data-[state=open]:slide-in-from-top-[48%] sm:w-full sm:p-6 sm:rounded-lg\",\n        className\n      )}\n      {...props}>\n      {children}\n      <DialogPrimitive.Close\n        className=\"absolute right-3 top-3 rounded-sm opacity-70 ring-offset-background transition-opacity hover:opacity-100 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:pointer-events-none data-[state=open]:bg-accent data-[state=open]:text-muted-foreground sm:right-4 sm:top-4\">\n        <X className=\"h-4 w-4\" />\n        <span className=\"sr-only\">Close</span>\n      </DialogPrimitive.Close>\n    </DialogPrimitive.Content>\n  </DialogPortal>\n))\nDialogContent.displayName = DialogPrimitive.Content.displayName\n\nconst DialogHeader = ({\n  className,\n  ...props\n}) => (\n  <div\n    className={cn(\"flex flex-col space-y-1.5 text-center sm:text-left\", className)}\n    {...props} />\n)\nDialogHeader.displayName = \"DialogHeader\"\n\nconst DialogFooter = ({\n  className,\n  ...props\n}) => (\n  <div\n    className={cn(\"flex flex-col-reverse sm:flex-row sm:justify-end sm:space-x-2\", className)}\n    {...props} />\n)\nDialogFooter.displayName = \"DialogFooter\"\n\nconst DialogTitle = React.forwardRef(({ className, ...props }, ref) => (\n  <DialogPrimitive.Title\n    ref={ref}\n    className={cn(\"text-base font-semibold leading-none tracking-tight sm:text-lg\", className)}\n    {...props} />\n))\nDialogTitle.displayName = DialogPrimitive.Title.displayName\n\nconst DialogDescription = React.forwardRef(({ className, ...props }, ref) => (\n  <DialogPrimitive.Description\n    ref={ref}\n    className={cn(\"text-xs text-muted-foreground sm:text-sm\", className)}\n    {...props} />\n))\nDialogDescription.displayName = DialogPrimitive.Description.displayName\n\nexport {\n  Dialog,\n  DialogPortal,\n  DialogOverlay,\n  DialogTrigger,\n  DialogClose,\n  DialogContent,\n  DialogHeader,\n  DialogFooter,\n  DialogTitle,\n  DialogDescription,\n}\n","path":null,"size_bytes":3302,"size_tokens":null},"src/components/shared/LocationService.jsx":{"content":"import { useState, useEffect } from 'react';\nimport { safeFetch } from '@/utils/apiConfig';\nimport { Geolocation } from '@capacitor/geolocation';\nimport { Capacitor } from '@capacitor/core';\n\n// Calcular distância entre duas coordenadas (Haversine formula)\nexport function calculateDistance(lat1, lon1, lat2, lon2) {\n  const R = 6371; // Raio da Terra em km\n  const dLat = (lat2 - lat1) * Math.PI / 180;\n  const dLon = (lon2 - lon1) * Math.PI / 180;\n  const a = \n    Math.sin(dLat / 2) * Math.sin(dLat / 2) +\n    Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *\n    Math.sin(dLon / 2) * Math.sin(dLon / 2);\n  const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));\n  return R * c;\n}\n\n// Detectar se estamos no Capacitor (app nativa)\nconst isNative = Capacitor.isNativePlatform();\n\n// Hook para geolocalização - suporta Web e Capacitor (Android/iOS)\nexport function useUserLocation() {\n  const [location, setLocation] = useState(null);\n  const [country, setCountry] = useState(null);\n  const [loading, setLoading] = useState(true);\n  const [error, setError] = useState(null);\n\n  const fetchLocation = async () => {\n    setLoading(true);\n    setError(null);\n\n    try {\n      let latitude, longitude;\n\n      if (isNative) {\n        // ✅ CAPACITOR: Usar plugin nativo para melhor performance e permissões\n        console.log('📱 Usando Capacitor Geolocation (nativo)');\n        \n        // Verificar/pedir permissões\n        const permStatus = await Geolocation.checkPermissions();\n        console.log('📍 Status permissões:', permStatus);\n        \n        if (permStatus.location !== 'granted') {\n          const requestResult = await Geolocation.requestPermissions();\n          console.log('📍 Resultado pedido permissões:', requestResult);\n          \n          if (requestResult.location !== 'granted') {\n            setError('Permissão de localização negada');\n            setLoading(false);\n            return;\n          }\n        }\n        \n        // Obter posição\n        const position = await Geolocation.getCurrentPosition({\n          enableHighAccuracy: true,\n          timeout: 15000,\n          maximumAge: 0\n        });\n        \n        latitude = position.coords.latitude;\n        longitude = position.coords.longitude;\n        console.log('✅ Localização obtida (Capacitor):', { latitude, longitude });\n        \n      } else {\n        // ✅ WEB: Usar navigator.geolocation padrão\n        console.log('🌐 Usando navigator.geolocation (web)');\n        \n        if (!navigator.geolocation) {\n          setError('Geolocalização não suportada pelo navegador');\n          setLoading(false);\n          return;\n        }\n\n        const position = await new Promise((resolve, reject) => {\n          navigator.geolocation.getCurrentPosition(resolve, reject, {\n            enableHighAccuracy: true,\n            timeout: 10000,\n            maximumAge: 0\n          });\n        });\n        \n        latitude = position.coords.latitude;\n        longitude = position.coords.longitude;\n        console.log('✅ Localização obtida (Web):', { latitude, longitude });\n      }\n\n      setLocation({ lat: latitude, lng: longitude });\n\n      // Reverse geocoding para obter país (funciona em ambos os ambientes)\n      try {\n        const response = await fetch(\n          `https://nominatim.openstreetmap.org/reverse?format=json&lat=${latitude}&lon=${longitude}&zoom=3&addressdetails=1`,\n          {\n            headers: {\n              'User-Agent': 'QZero-App/1.0'\n            }\n          }\n        );\n        const data = await response.json();\n        const countryCode = data.address?.country_code?.toUpperCase();\n        const countryName = data.address?.country;\n        \n        setCountry({ code: countryCode, name: countryName });\n        console.log('✅ País detectado:', { code: countryCode, name: countryName });\n      } catch (err) {\n        console.error('❌ Erro ao obter país:', err);\n        // Não definir erro aqui - a localização foi obtida, só faltou o país\n      }\n      \n    } catch (err) {\n      console.error('❌ Erro de localização:', err);\n      if (err.code === 1 || err.message?.includes('denied') || err.message?.includes('permission')) {\n        setError('Acesso à localização negado');\n      } else if (err.code === 2 || err.message?.includes('unavailable')) {\n        setError('Localização indisponível');\n      } else if (err.code === 3 || err.message?.includes('timeout')) {\n        setError('Tempo esgotado ao obter localização');\n      } else {\n        setError('Erro ao obter localização');\n      }\n    }\n    \n    setLoading(false);\n  };\n\n  useEffect(() => {\n    fetchLocation();\n  }, []);\n\n  return { location, country, loading, error, refetch: fetchLocation };\n}\n\n// Geocoding de morada para coordenadas usando Google Maps API\nexport async function geocodeAddress(addressStr, city = null, postalCode = null, country = null) {\n  try {\n    console.log('🗺️ Geocoding endereço com Google Maps:', { addressStr, city, postalCode, country });\n    \n    const { response, data } = await safeFetch('/api/geocode-address', {\n      method: 'POST',\n      headers: {\n        'Content-Type': 'application/json'\n      },\n      body: JSON.stringify({\n        address: addressStr,\n        city,\n        postalCode,\n        country\n      })\n    });\n\n    if (!response.ok) {\n      console.error('❌ Geocoding falhou:', data);\n      return null;\n    }\n    \n    console.log('✅ Geocoding bem-sucedido:', {\n      lat: data?.lat,\n      lng: data?.lng,\n      precision: data?.precision,\n      locationType: data?.locationType\n    });\n    \n    return {\n      lat: data?.lat,\n      lng: data?.lng,\n      precision: data?.precision,\n      locationType: data?.locationType,\n      formattedAddress: data?.formattedAddress\n    };\n  } catch (error) {\n    console.error('❌ Erro no geocoding:', error);\n    return null;\n  }\n}","path":null,"size_bytes":5904,"size_tokens":null},"src/services/stripeService.js":{"content":"import { companyProfileStorage, SUBSCRIPTION_STATUS } from '../models/companyProfile';\nimport { toast } from 'sonner';\nimport { safeFetch } from '@/utils/apiConfig';\n\n// SEGURANÇA: Demo mode APENAS ativo em desenvolvimento\n// Em produção (import.meta.env.DEV === false), sempre usa Stripe real\n// ATENÇÃO: IS_DEMO_MODE = false ativa Stripe REAL (com as chaves configuradas)\nconst IS_DEMO_MODE = false;\n\nexport const stripeService = {\n  async createSubscriptionCheckout(companyProfileId, email, successUrl, cancelUrl) {\n    // PROTEÇÃO: Verificar se está em desenvolvimento antes de permitir mock\n    const isDevelopment = import.meta.env.DEV;\n    const useMock = IS_DEMO_MODE && isDevelopment;\n    \n    console.log('🔒 Stripe Service:', { \n      IS_DEMO_MODE, \n      isDevelopment, \n      useMock,\n      mode: useMock ? 'MOCK (dev)' : 'REAL (production)' \n    });\n    \n    if (useMock) {\n      console.log('💡 Usando Mock Stripe (apenas desenvolvimento)');\n      return this.mockCreateCheckout(companyProfileId, email, successUrl, cancelUrl);\n    }\n    \n    // Produção: SEMPRE usar Stripe real\n    console.log('🔒 Usando Stripe REAL (produção)');\n    \n    try {\n      const { response, data } = await safeFetch('/api/create-subscription-checkout', {\n        method: 'POST',\n        body: JSON.stringify({\n          companyProfileId,\n          email,\n          successUrl,\n          cancelUrl\n        })\n      });\n\n      if (!response.ok) {\n        console.error('❌ Erro ao criar checkout Stripe:', {\n          status: response.status,\n          statusText: response.statusText,\n          error: data?.error\n        });\n        throw new Error(`Erro ao criar sessão de pagamento: ${response.status} - ${data?.error || 'Unknown error'}`);\n      }\n\n      console.log('✅ Checkout criado com sucesso:', data);\n      return data;\n    } catch (error) {\n      console.error('❌ Erro fatal ao criar checkout:', error);\n      throw error;\n    }\n  },\n\n  async mockCreateCheckout(companyProfileId, email, successUrl, cancelUrl) {\n    // SEGURANÇA: Dupla verificação - esta função SÓ deve rodar em desenvolvimento\n    if (!import.meta.env.DEV) {\n      console.error('❌ SEGURANÇA: Tentativa de usar mock checkout em PRODUÇÃO bloqueada!');\n      throw new Error('Mock checkout não disponível em produção');\n    }\n    \n    console.log('Mock: Creating Stripe checkout session (DEV only)');\n    console.log('Company Profile ID:', companyProfileId);\n    console.log('Email:', email);\n    \n    const sessionId = `cs_test_${Date.now()}`;\n    const mockCheckoutUrl = `https://checkout.stripe.com/c/pay/${sessionId}`;\n    \n    await companyProfileStorage.update(companyProfileId, {\n      stripeCheckoutSessionId: sessionId\n    });\n    \n    return {\n      sessionId,\n      url: mockCheckoutUrl,\n      isMock: true\n    };\n  },\n\n  async simulateSuccessfulPayment(companyProfileId) {\n    if (!IS_DEMO_MODE) {\n      throw new Error('This function is only available in demo mode');\n    }\n\n    console.log('Mock: Simulating successful payment for company:', companyProfileId);\n    \n    const customerId = `cus_mock_${Date.now()}`;\n    const subscriptionId = `sub_mock_${Date.now()}`;\n    \n    await companyProfileStorage.update(companyProfileId, {\n      status: SUBSCRIPTION_STATUS.ACTIVE,\n      stripeCustomerId: customerId,\n      subscriptionId: subscriptionId,\n      subscriptionStatus: 'active',\n    });\n\n    toast.success('Pagamento simulado com sucesso! Conta empresarial ativada.');\n    \n    return {\n      success: true,\n      customerId,\n      subscriptionId\n    };\n  },\n\n  async simulateFailedPayment(companyProfileId) {\n    if (!IS_DEMO_MODE) {\n      throw new Error('This function is only available in demo mode');\n    }\n\n    console.log('Mock: Simulating failed payment for company:', companyProfileId);\n    \n    await companyProfileStorage.update(companyProfileId, {\n      status: SUBSCRIPTION_STATUS.PENDING_PAYMENT,\n      subscriptionStatus: null,\n    });\n\n    toast.error('Pagamento simulado como falhado.');\n    \n    return {\n      success: false,\n      error: 'Payment method declined'\n    };\n  }\n};\n","path":null,"size_bytes":4129,"size_tokens":null},"src/components/business/CompanyProfileForm.jsx":{"content":"import { useState } from 'react';\nimport { useNavigate } from 'react-router-dom';\nimport { Button } from '@/components/ui/button';\nimport { Input } from '@/components/ui/input';\nimport { Label } from '@/components/ui/label';\nimport { Textarea } from '@/components/ui/textarea';\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card';\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select';\nimport { Building2, MapPin, Mail, Phone, Globe, AlertCircle, Loader2, CheckCircle2, Navigation } from 'lucide-react';\nimport { CompanyProfile, COMPANY_CATEGORIES, companyProfileStorage } from '@/models/companyProfile';\nimport { validateCompanyProfile } from '@/utils/validation';\nimport { base44 } from '@/api/base44Client';\nimport { toast } from 'sonner';\nimport { ImageUpload } from './ImageUpload';\nimport { STRIPE_SUPPORTED_COUNTRIES } from '@/constants/stripeCountries';\nimport { geocodeAddress } from '@/components/shared/LocationService';\nimport { useAutoTranslate } from '@/hooks/useTranslate';\nimport { Geolocation } from '@capacitor/geolocation';\nimport { Capacitor } from '@capacitor/core';\nimport { navigateBackOrFallback } from '@/hooks/useNavigateBack';\n\nconst countries = STRIPE_SUPPORTED_COUNTRIES;\n\nconst portugueseDistricts = [\n  \"Aveiro\", \"Beja\", \"Braga\", \"Bragança\", \"Castelo Branco\",\n  \"Coimbra\", \"Évora\", \"Faro\", \"Guarda\", \"Leiria\",\n  \"Lisboa\", \"Portalegre\", \"Porto\", \"Santarém\", \"Setúbal\",\n  \"Viana do Castelo\", \"Vila Real\", \"Viseu\", \"Açores\", \"Madeira\"\n];\n\nexport function CompanyProfileForm({ onComplete }) {\n  const navigate = useNavigate();\n  \n  const txtFixFormErrors = useAutoTranslate('Por favor, corrija os erros no formulário', 'pt');\n  const txtProfileCreated = useAutoTranslate('Perfil empresarial criado com sucesso!', 'pt');\n  const txtProfileError = useAutoTranslate('Erro ao criar perfil. Tente novamente.', 'pt');\n  const txtCompanyProfile = useAutoTranslate('Perfil da Empresa', 'pt');\n  const txtFillCompanyInfo = useAutoTranslate('Preencha as informações da sua empresa', 'pt');\n  const txtCompanyName = useAutoTranslate('Nome da Empresa', 'pt');\n  const txtBusinessCategory = useAutoTranslate('Categoria do Negócio', 'pt');\n  const txtSelectCategory = useAutoTranslate('Selecione a categoria', 'pt');\n  const txtDescription = useAutoTranslate('Descrição', 'pt');\n  const txtDescribeServices = useAutoTranslate('Descreva os seus serviços...', 'pt');\n  const txtPhone = useAutoTranslate('Telefone', 'pt');\n  const txtCompanyAddress = useAutoTranslate('Morada da Empresa', 'pt');\n  const txtCountry = useAutoTranslate('País', 'pt');\n  const txtSelectCountry = useAutoTranslate('Selecione o país', 'pt');\n  const txtOtherCountry = useAutoTranslate('Outro país', 'pt');\n  const txtCountryCodeHint = useAutoTranslate('Código ISO (2 letras)', 'pt');\n  const txtBackToList = useAutoTranslate('Voltar à lista', 'pt');\n  const txtDistrictRegion = useAutoTranslate('Distrito/Região', 'pt');\n  const txtSelectDistrict = useAutoTranslate('Selecione o distrito', 'pt');\n  const txtEnterDistrict = useAutoTranslate('Digite o distrito/região', 'pt');\n  const txtCity = useAutoTranslate('Cidade', 'pt');\n  const txtPostalCode = useAutoTranslate('Código Postal', 'pt');\n  const txtStreetName = useAutoTranslate('Rua/Avenida', 'pt');\n  const txtDoorNumber = useAutoTranslate('Nº', 'pt');\n  const txtCompanyLogo = useAutoTranslate('Logótipo da Empresa', 'pt');\n  const txtLogoHelp = useAutoTranslate('Upload do logótipo (obrigatório)', 'pt');\n  const txtEstablishmentPhoto = useAutoTranslate('Foto do Estabelecimento', 'pt');\n  const txtPhotoHelp = useAutoTranslate('Upload de uma foto (opcional)', 'pt');\n  const txtCancel = useAutoTranslate('Cancelar', 'pt');\n  const txtSaving = useAutoTranslate('A guardar...', 'pt');\n  const txtSubmitAndProceed = useAutoTranslate('Submeter e Continuar', 'pt');\n  const txtSearchAddress = useAutoTranslate('Pesquisar morada completa', 'pt');\n  const txtSearchHint = useAutoTranslate('Pesquise para preencher automaticamente', 'pt');\n  const txtAddressFilled = useAutoTranslate('Morada preenchida!', 'pt');\n  const txtUseMyLocation = useAutoTranslate('Usar minha localização', 'pt');\n  const txtGettingLocation = useAutoTranslate('A obter localização...', 'pt');\n  const txtLocationError = useAutoTranslate('Erro ao obter localização', 'pt');\n  const txtLocationPermissionDenied = useAutoTranslate('Permissão de localização negada. Por favor, ative nas definições.', 'pt');\n  const txtLocationObtained = useAutoTranslate('Localização obtida com sucesso!', 'pt');\n  \n  const txtCatHealth = useAutoTranslate('Saúde', 'pt');\n  const txtCatFinance = useAutoTranslate('Financeiro', 'pt');\n  const txtCatGovernment = useAutoTranslate('Governo', 'pt');\n  const txtCatRestaurant = useAutoTranslate('Restauração', 'pt');\n  const txtCatBeauty = useAutoTranslate('Beleza', 'pt');\n  const txtCatRetail = useAutoTranslate('Retalho', 'pt');\n  const txtCatOther = useAutoTranslate('Outros', 'pt');\n  \n  const translatedCategories = {\n    'saude': txtCatHealth,\n    'financeiro': txtCatFinance,\n    'governo': txtCatGovernment,\n    'restauracao': txtCatRestaurant,\n    'beleza': txtCatBeauty,\n    'retalho': txtCatRetail,\n    'outros': txtCatOther\n  };\n\n  const [loading, setLoading] = useState(false);\n  const [gpsLoading, setGpsLoading] = useState(false);\n  const [manualCountryMode, setManualCountryMode] = useState(false);\n  const [addressFilled, setAddressFilled] = useState(false);\n  const [formData, setFormData] = useState({\n    companyName: '',\n    companyCountry: 'PT',\n    companyDistrict: '',\n    companyCity: '',\n    companyPostalCode: '',\n    companyStreetName: '',\n    companyDoorNumber: '',\n    companyPhone: '',\n    companyEmail: '',\n    companyCategory: '',\n    companyDescription: '',\n    companyCoordinates: null,\n    logoUrl: null,\n    photoUrl: null\n  });\n  const [errors, setErrors] = useState({});\n\n  const handleChange = (field, value) => {\n    setFormData(prev => ({ ...prev, [field]: value }));\n    if (errors[field]) {\n      setErrors(prev => {\n        const newErrors = { ...prev };\n        delete newErrors[field];\n        return newErrors;\n      });\n    }\n  };\n\n  const handleUseLocation = async () => {\n    setGpsLoading(true);\n    try {\n      let latitude, longitude;\n\n      if (Capacitor.isNativePlatform()) {\n        console.log('📱 Usando Capacitor Geolocation (nativo)');\n        const permStatus = await Geolocation.checkPermissions();\n        \n        if (permStatus.location !== 'granted') {\n          const requestResult = await Geolocation.requestPermissions();\n          if (requestResult.location !== 'granted') {\n            toast.error(txtLocationPermissionDenied);\n            setGpsLoading(false);\n            return;\n          }\n        }\n        \n        const position = await Geolocation.getCurrentPosition({\n          enableHighAccuracy: true,\n          timeout: 15000,\n          maximumAge: 0\n        });\n        \n        latitude = position.coords.latitude;\n        longitude = position.coords.longitude;\n      } else {\n        console.log('🌐 Usando navigator.geolocation (web)');\n        if (!navigator.geolocation) {\n          toast.error(txtLocationError);\n          setGpsLoading(false);\n          return;\n        }\n\n        const position = await new Promise((resolve, reject) => {\n          navigator.geolocation.getCurrentPosition(resolve, reject, {\n            enableHighAccuracy: true,\n            timeout: 10000,\n            maximumAge: 0\n          });\n        });\n        \n        latitude = position.coords.latitude;\n        longitude = position.coords.longitude;\n      }\n\n      console.log('✅ Coordenadas GPS obtidas:', { latitude, longitude });\n\n      const response = await fetch(\n        `https://nominatim.openstreetmap.org/reverse?format=json&lat=${latitude}&lon=${longitude}&zoom=18&addressdetails=1`,\n        { headers: { 'User-Agent': 'QZero-App/1.0' } }\n      );\n      const data = await response.json();\n      \n      console.log('📍 Reverse geocoding result:', data);\n\n      const updates = {\n        companyCoordinates: { lat: latitude, lng: longitude }\n      };\n\n      if (data.address) {\n        const addr = data.address;\n        if (addr.country_code) {\n          const countryCode = addr.country_code.toUpperCase();\n          updates.companyCountry = countryCode;\n          const countryExists = countries.some(c => c.code === countryCode);\n          setManualCountryMode(!countryExists);\n        }\n        if (addr.state || addr.region) updates.companyDistrict = addr.state || addr.region;\n        if (addr.city || addr.town || addr.village || addr.municipality) {\n          updates.companyCity = addr.city || addr.town || addr.village || addr.municipality;\n        }\n        if (addr.postcode) updates.companyPostalCode = addr.postcode;\n        if (addr.road || addr.street) updates.companyStreetName = addr.road || addr.street;\n        if (addr.house_number) updates.companyDoorNumber = addr.house_number;\n      }\n\n      setFormData(prev => ({ ...prev, ...updates }));\n      setAddressFilled(true);\n      \n      const errorFields = ['companyCountry', 'companyDistrict', 'companyCity', 'companyPostalCode', 'companyStreetName', 'companyDoorNumber'];\n      setErrors(prev => {\n        const newErrors = { ...prev };\n        errorFields.forEach(field => delete newErrors[field]);\n        return newErrors;\n      });\n\n      toast.success(txtLocationObtained);\n    } catch (err) {\n      console.error('❌ Erro de localização:', err);\n      if (err.code === 1 || err.message?.includes('denied')) {\n        toast.error(txtLocationPermissionDenied);\n      } else {\n        toast.error(txtLocationError);\n      }\n    }\n    setGpsLoading(false);\n  };\n\n  const handleSubmit = async (e) => {\n    e.preventDefault();\n    \n    const validation = validateCompanyProfile(formData);\n    if (!validation.isValid) {\n      setErrors(validation.errors);\n      toast.error(txtFixFormErrors);\n      return;\n    }\n\n    setLoading(true);\n    try {\n      const user = await base44.auth.me();\n      \n      let coordinates = formData.companyCoordinates || null;\n      \n      if (!coordinates && formData.companyStreetName && formData.companyCity && formData.companyCountry) {\n        const countryName = countries.find(c => c.code === formData.companyCountry)?.name || formData.companyCountry;\n        \n        console.log('🌍 A obter coordenadas GPS...');\n        \n        try {\n          coordinates = await geocodeAddress(\n            `${formData.companyStreetName} ${formData.companyDoorNumber}`,\n            formData.companyCity,\n            formData.companyPostalCode,\n            countryName\n          );\n          \n          if (coordinates) {\n            console.log('✅ Coordenadas obtidas:', coordinates);\n          }\n        } catch (geoError) {\n          console.warn('⚠️ Geocoding falhou - perfil será criado sem GPS');\n        }\n      }\n      \n      const profile = new CompanyProfile({\n        ...formData,\n        companyCoordinates: coordinates,\n        adminUserId: user.id,\n        status: 'pending_payment'\n      });\n\n      await companyProfileStorage.save(profile);\n      \n      toast.success(txtProfileCreated);\n      \n      if (onComplete) {\n        onComplete(profile);\n      } else {\n        navigate('/business/subscription');\n      }\n    } catch (error) {\n      console.error('Error creating company profile:', error);\n      toast.error(txtProfileError);\n    } finally {\n      setLoading(false);\n    }\n  };\n\n  return (\n    <Card className=\"w-full max-w-2xl mx-auto border-0 shadow-xl\">\n      <CardHeader className=\"px-4 sm:px-6 pt-6 pb-4\">\n        <CardTitle className=\"flex items-center gap-3 text-xl sm:text-2xl\">\n          <div className=\"p-2 bg-indigo-100 rounded-xl\">\n            <Building2 className=\"w-5 h-5 sm:w-6 sm:h-6 text-indigo-600\" />\n          </div>\n          {txtCompanyProfile}\n        </CardTitle>\n        <CardDescription className=\"text-sm sm:text-base mt-2\">\n          {txtFillCompanyInfo}\n        </CardDescription>\n      </CardHeader>\n      \n      <CardContent className=\"px-4 sm:px-6 pb-6\">\n        <form onSubmit={handleSubmit} className=\"space-y-6\">\n          \n          {/* === INFORMAÇÕES BÁSICAS === */}\n          <div className=\"space-y-4\">\n            <div>\n              <Label htmlFor=\"companyName\" className=\"text-sm sm:text-base font-medium mb-2 block\">\n                {txtCompanyName} <span className=\"text-red-500\">*</span>\n              </Label>\n              <div className=\"relative\">\n                <Building2 className=\"absolute left-3 top-1/2 -translate-y-1/2 h-5 w-5 text-slate-400\" />\n                <Input\n                  id=\"companyName\"\n                  value={formData.companyName}\n                  onChange={(e) => handleChange('companyName', e.target.value)}\n                  placeholder=\"Ex: Clínica Saúde+\"\n                  className={`pl-11 h-12 sm:h-14 text-base ${errors.companyName ? 'border-red-500' : ''}`}\n                />\n              </div>\n              {errors.companyName && (\n                <p className=\"text-sm text-red-600 mt-1.5 flex items-center gap-1\">\n                  <AlertCircle className=\"w-4 h-4\" />\n                  {errors.companyName}\n                </p>\n              )}\n            </div>\n\n            <div>\n              <Label className=\"text-sm sm:text-base font-medium mb-2 block\">\n                {txtBusinessCategory} <span className=\"text-red-500\">*</span>\n              </Label>\n              <Select\n                value={formData.companyCategory}\n                onValueChange={(value) => handleChange('companyCategory', value)}\n              >\n                <SelectTrigger className={`h-12 sm:h-14 text-base ${errors.companyCategory ? 'border-red-500' : ''}`}>\n                  <SelectValue placeholder={txtSelectCategory} />\n                </SelectTrigger>\n                <SelectContent>\n                  {Object.keys(COMPANY_CATEGORIES).map((code) => (\n                    <SelectItem key={code} value={code} className=\"py-3 text-base\">\n                      {translatedCategories[code] || COMPANY_CATEGORIES[code]}\n                    </SelectItem>\n                  ))}\n                </SelectContent>\n              </Select>\n              {errors.companyCategory && (\n                <p className=\"text-sm text-red-600 mt-1.5 flex items-center gap-1\">\n                  <AlertCircle className=\"w-4 h-4\" />\n                  {errors.companyCategory}\n                </p>\n              )}\n            </div>\n\n            <div>\n              <Label htmlFor=\"companyDescription\" className=\"text-sm sm:text-base font-medium mb-2 block\">\n                {txtDescription}\n              </Label>\n              <Textarea\n                id=\"companyDescription\"\n                value={formData.companyDescription}\n                onChange={(e) => handleChange('companyDescription', e.target.value)}\n                placeholder={txtDescribeServices}\n                rows={3}\n                className=\"resize-none text-base\"\n              />\n            </div>\n\n            <div className=\"grid grid-cols-1 sm:grid-cols-2 gap-4\">\n              <div>\n                <Label htmlFor=\"companyPhone\" className=\"text-sm sm:text-base font-medium mb-2 block\">\n                  {txtPhone}\n                </Label>\n                <div className=\"relative\">\n                  <Phone className=\"absolute left-3 top-1/2 -translate-y-1/2 h-5 w-5 text-slate-400\" />\n                  <Input\n                    id=\"companyPhone\"\n                    value={formData.companyPhone}\n                    onChange={(e) => handleChange('companyPhone', e.target.value)}\n                    placeholder=\"+351 912 345 678\"\n                    className={`pl-11 h-12 sm:h-14 text-base ${errors.companyPhone ? 'border-red-500' : ''}`}\n                  />\n                </div>\n                {errors.companyPhone && (\n                  <p className=\"text-sm text-red-600 mt-1.5 flex items-center gap-1\">\n                    <AlertCircle className=\"w-4 h-4\" />\n                    {errors.companyPhone}\n                  </p>\n                )}\n              </div>\n\n              <div>\n                <Label htmlFor=\"companyEmail\" className=\"text-sm sm:text-base font-medium mb-2 block\">\n                  Email <span className=\"text-red-500\">*</span>\n                </Label>\n                <div className=\"relative\">\n                  <Mail className=\"absolute left-3 top-1/2 -translate-y-1/2 h-5 w-5 text-slate-400\" />\n                  <Input\n                    id=\"companyEmail\"\n                    type=\"text\"\n                    inputMode=\"email\"\n                    value={formData.companyEmail}\n                    onChange={(e) => handleChange('companyEmail', e.target.value)}\n                    placeholder=\"contacto@empresa.pt\"\n                    className={`pl-11 h-12 sm:h-14 text-base ${errors.companyEmail ? 'border-red-500' : ''}`}\n                    autoComplete=\"off\"\n                  />\n                </div>\n                {errors.companyEmail && (\n                  <p className=\"text-sm text-red-600 mt-1.5 flex items-center gap-1\">\n                    <AlertCircle className=\"w-4 h-4\" />\n                    {errors.companyEmail}\n                  </p>\n                )}\n              </div>\n            </div>\n          </div>\n\n          {/* === SECÇÃO DE MORADA === */}\n          <div className=\"pt-4 border-t border-slate-200\">\n            <div className=\"flex items-center gap-2 mb-4\">\n              <div className=\"p-1.5 bg-blue-100 rounded-lg\">\n                <MapPin className=\"w-4 h-4 text-blue-600\" />\n              </div>\n              <h3 className=\"text-base font-semibold text-slate-800\">\n                {txtCompanyAddress}\n              </h3>\n              {addressFilled && (\n                <span className=\"ml-auto flex items-center gap-1 text-sm text-green-600 bg-green-50 px-2 py-1 rounded-full\">\n                  <CheckCircle2 className=\"w-4 h-4\" />\n                  {txtAddressFilled}\n                </span>\n              )}\n            </div>\n\n            {/* Botão GPS - Usar localização */}\n            <div className=\"mb-4\">\n              <Button\n                type=\"button\"\n                onClick={handleUseLocation}\n                disabled={gpsLoading}\n                className=\"w-full h-12 sm:h-14 bg-gradient-to-r from-green-500 to-emerald-600 hover:from-green-600 hover:to-emerald-700 text-white font-medium\"\n              >\n                {gpsLoading ? (\n                  <>\n                    <Loader2 className=\"w-5 h-5 mr-2 animate-spin\" />\n                    {txtGettingLocation}\n                  </>\n                ) : (\n                  <>\n                    <Navigation className=\"w-5 h-5 mr-2\" />\n                    {txtUseMyLocation}\n                  </>\n                )}\n              </Button>\n              <p className=\"text-xs text-slate-500 mt-2 text-center\">\n                Ou preencha manualmente abaixo\n              </p>\n            </div>\n\n            {/* Campos de Morada - Ordem Lógica */}\n            <div className=\"space-y-4\">\n              \n              {/* Rua + Número */}\n              <div className=\"grid grid-cols-1 sm:grid-cols-4 gap-3\">\n                <div className=\"col-span-1 sm:col-span-3\">\n                  <Label className=\"text-sm sm:text-base font-medium mb-2 block\">\n                    {txtStreetName} <span className=\"text-red-500\">*</span>\n                  </Label>\n                  <Input\n                    value={formData.companyStreetName}\n                    onChange={(e) => handleChange('companyStreetName', e.target.value)}\n                    placeholder=\"Ex: Rua das Flores\"\n                    className={`h-12 sm:h-14 text-base ${errors.companyStreetName ? 'border-red-500' : ''}`}\n                  />\n                  {errors.companyStreetName && (\n                    <p className=\"text-sm text-red-600 mt-1 flex items-center gap-1\">\n                      <AlertCircle className=\"w-4 h-4\" />\n                      {errors.companyStreetName}\n                    </p>\n                  )}\n                </div>\n                <div>\n                  <Label className=\"text-sm sm:text-base font-medium mb-2 block\">\n                    {txtDoorNumber} <span className=\"text-red-500\">*</span>\n                  </Label>\n                  <Input\n                    value={formData.companyDoorNumber}\n                    onChange={(e) => handleChange('companyDoorNumber', e.target.value)}\n                    placeholder=\"123\"\n                    className={`h-12 sm:h-14 text-base text-center ${errors.companyDoorNumber ? 'border-red-500' : ''}`}\n                  />\n                  {errors.companyDoorNumber && (\n                    <p className=\"text-sm text-red-600 mt-1 flex items-center gap-1\">\n                      <AlertCircle className=\"w-4 h-4\" />\n                    </p>\n                  )}\n                </div>\n              </div>\n\n              {/* Código Postal + Cidade */}\n              <div className=\"grid grid-cols-1 sm:grid-cols-5 gap-3\">\n                <div className=\"col-span-1 sm:col-span-2\">\n                  <Label className=\"text-sm sm:text-base font-medium mb-2 block\">\n                    {txtPostalCode} <span className=\"text-red-500\">*</span>\n                  </Label>\n                  <Input\n                    value={formData.companyPostalCode}\n                    onChange={(e) => handleChange('companyPostalCode', e.target.value)}\n                    placeholder=\"1000-001\"\n                    className={`h-12 sm:h-14 text-base ${errors.companyPostalCode ? 'border-red-500' : ''}`}\n                  />\n                  {errors.companyPostalCode && (\n                    <p className=\"text-sm text-red-600 mt-1 flex items-center gap-1\">\n                      <AlertCircle className=\"w-4 h-4\" />\n                      {errors.companyPostalCode}\n                    </p>\n                  )}\n                </div>\n                <div className=\"col-span-1 sm:col-span-3\">\n                  <Label className=\"text-sm sm:text-base font-medium mb-2 block\">\n                    {txtCity} <span className=\"text-red-500\">*</span>\n                  </Label>\n                  <Input\n                    value={formData.companyCity}\n                    onChange={(e) => handleChange('companyCity', e.target.value)}\n                    placeholder=\"Lisboa\"\n                    className={`h-12 sm:h-14 text-base ${errors.companyCity ? 'border-red-500' : ''}`}\n                  />\n                  {errors.companyCity && (\n                    <p className=\"text-sm text-red-600 mt-1 flex items-center gap-1\">\n                      <AlertCircle className=\"w-4 h-4\" />\n                      {errors.companyCity}\n                    </p>\n                  )}\n                </div>\n              </div>\n\n              {/* Distrito + País */}\n              <div className=\"grid grid-cols-1 sm:grid-cols-2 gap-4\">\n                <div>\n                  <Label className=\"text-sm sm:text-base font-medium mb-2 block\">\n                    {txtDistrictRegion} <span className=\"text-red-500\">*</span>\n                  </Label>\n                  {formData.companyCountry === 'PT' ? (\n                    <Select\n                      value={formData.companyDistrict}\n                      onValueChange={(value) => handleChange('companyDistrict', value)}\n                    >\n                      <SelectTrigger className={`h-12 sm:h-14 text-base ${errors.companyDistrict ? 'border-red-500' : ''}`}>\n                        <SelectValue placeholder={txtSelectDistrict} />\n                      </SelectTrigger>\n                      <SelectContent>\n                        {portugueseDistricts.map(district => (\n                          <SelectItem key={district} value={district} className=\"py-3\">\n                            {district}\n                          </SelectItem>\n                        ))}\n                      </SelectContent>\n                    </Select>\n                  ) : (\n                    <Input\n                      value={formData.companyDistrict}\n                      onChange={(e) => handleChange('companyDistrict', e.target.value)}\n                      placeholder={txtEnterDistrict}\n                      className={`h-12 sm:h-14 text-base ${errors.companyDistrict ? 'border-red-500' : ''}`}\n                    />\n                  )}\n                  {errors.companyDistrict && (\n                    <p className=\"text-sm text-red-600 mt-1 flex items-center gap-1\">\n                      <AlertCircle className=\"w-4 h-4\" />\n                      {errors.companyDistrict}\n                    </p>\n                  )}\n                </div>\n\n                <div>\n                  <Label className=\"text-sm sm:text-base font-medium mb-2 block\">\n                    {txtCountry} <span className=\"text-red-500\">*</span>\n                  </Label>\n                  {!manualCountryMode ? (\n                    <div className=\"relative\">\n                      <Globe className=\"absolute left-3 top-1/2 -translate-y-1/2 h-5 w-5 text-slate-400 z-10 pointer-events-none\" />\n                      <Select\n                        value={formData.companyCountry}\n                        onValueChange={(value) => {\n                          if (value === '__OTHER__') {\n                            setManualCountryMode(true);\n                            handleChange('companyCountry', '');\n                          } else {\n                            handleChange('companyCountry', value);\n                          }\n                        }}\n                      >\n                        <SelectTrigger className={`pl-11 h-12 sm:h-14 text-base ${errors.companyCountry ? 'border-red-500' : ''}`}>\n                          <SelectValue placeholder={txtSelectCountry} />\n                        </SelectTrigger>\n                        <SelectContent>\n                          {countries.map(country => (\n                            <SelectItem key={country.code} value={country.code} className=\"py-3\">\n                              {country.flag} {country.name}\n                            </SelectItem>\n                          ))}\n                          <SelectItem value=\"__OTHER__\" className=\"py-3 text-indigo-600 font-medium\">\n                            🌍 {txtOtherCountry}\n                          </SelectItem>\n                        </SelectContent>\n                      </Select>\n                    </div>\n                  ) : (\n                    <div>\n                      <div className=\"relative\">\n                        <Globe className=\"absolute left-3 top-1/2 -translate-y-1/2 h-5 w-5 text-slate-400\" />\n                        <Input\n                          value={formData.companyCountry}\n                          onChange={(e) => handleChange('companyCountry', e.target.value.toUpperCase())}\n                          placeholder=\"PT, BR, US...\"\n                          maxLength={2}\n                          className={`pl-11 h-12 sm:h-14 text-base uppercase ${errors.companyCountry ? 'border-red-500' : ''}`}\n                        />\n                      </div>\n                      <p className=\"text-xs text-slate-500 mt-1\">\n                        {txtCountryCodeHint}{' '}\n                        <button \n                          type=\"button\" \n                          onClick={() => { setManualCountryMode(false); handleChange('companyCountry', 'PT'); }} \n                          className=\"text-indigo-600 hover:underline\"\n                        >\n                          {txtBackToList}\n                        </button>\n                      </p>\n                    </div>\n                  )}\n                  {errors.companyCountry && (\n                    <p className=\"text-sm text-red-600 mt-1 flex items-center gap-1\">\n                      <AlertCircle className=\"w-4 h-4\" />\n                      {errors.companyCountry}\n                    </p>\n                  )}\n                </div>\n              </div>\n            </div>\n          </div>\n\n          {/* === IMAGENS === */}\n          <div className=\"pt-4 sm:pt-6 border-t border-slate-200\">\n            <div className=\"grid grid-cols-1 sm:grid-cols-2 gap-4 sm:gap-6\">\n              <div>\n                <Label className=\"text-sm sm:text-base font-medium mb-2 block\">\n                  {txtCompanyLogo} <span className=\"text-red-500\">*</span>\n                </Label>\n                <ImageUpload\n                  value={formData.logoUrl}\n                  onChange={(url) => handleChange('logoUrl', url)}\n                  label={txtLogoHelp}\n                  error={errors.logoUrl}\n                />\n                {errors.logoUrl && (\n                  <p className=\"text-sm text-red-600 mt-1 flex items-center gap-1\">\n                    <AlertCircle className=\"w-4 h-4\" />\n                    {errors.logoUrl}\n                  </p>\n                )}\n              </div>\n\n              <div>\n                <Label className=\"text-sm sm:text-base font-medium mb-2 block\">\n                  {txtEstablishmentPhoto}\n                </Label>\n                <ImageUpload\n                  value={formData.photoUrl}\n                  onChange={(url) => handleChange('photoUrl', url)}\n                  label={txtPhotoHelp}\n                />\n              </div>\n            </div>\n          </div>\n\n          {/* === BOTÕES === */}\n          <div className=\"flex flex-col sm:flex-row gap-3 pt-4 sm:pt-6\">\n            <Button\n              type=\"button\"\n              variant=\"outline\"\n              onClick={() => navigateBackOrFallback(navigate, '/business-subscription')}\n              className=\"h-12 sm:h-14 text-base flex-1\"\n              disabled={loading}\n            >\n              {txtCancel}\n            </Button>\n            <Button\n              type=\"submit\"\n              className=\"h-12 sm:h-14 text-base flex-[2] bg-indigo-600 hover:bg-indigo-700\"\n              disabled={loading}\n            >\n              {loading ? (\n                <>\n                  <Loader2 className=\"mr-2 h-5 w-5 animate-spin\" />\n                  {txtSaving}\n                </>\n              ) : (\n                txtSubmitAndProceed\n              )}\n            </Button>\n          </div>\n        </form>\n      </CardContent>\n    </Card>\n  );\n}\n","path":null,"size_bytes":30491,"size_tokens":null},"src/components/business/BusinessFeatureGuard.jsx":{"content":"import { Alert, AlertDescription } from '@/components/ui/alert';\nimport { Button } from '@/components/ui/button';\nimport { Card, CardContent } from '@/components/ui/card';\nimport { AlertCircle, Lock, CreditCard, ArrowRight, ArrowLeft, Globe, CheckCircle2 } from 'lucide-react';\nimport { useNavigate } from 'react-router-dom';\nimport { createPageUrl } from '@/utils';\nimport { useAutoTranslate } from '@/hooks/useTranslate';\nimport { Capacitor } from '@capacitor/core';\n\nexport function BusinessFeatureGuard({ \n  companyProfile, \n  hasAccess = false,\n  isExpired = false,\n  children, \n  feature = 'esta funcionalidade',\n  showInline = false,\n  isLoading = false\n}) {\n  const navigate = useNavigate();\n  const isNativeApp = Capacitor.isNativePlatform();\n  \n  const txtVerifyingAccess = useAutoTranslate('A verificar acesso...', 'pt');\n  const txtProfileNotFound = useAutoTranslate('Perfil da empresa não encontrado. Por favor, complete o cadastro.', 'pt');\n  const txtRestrictedAccess = useAutoTranslate('Acesso Restrito', 'pt');\n  const txtToAccess = useAutoTranslate('Para aceder a', 'pt');\n  const txtNeedPlan = useAutoTranslate('precisa de ativar o plano empresarial.', 'pt');\n  const txtActivatePlan = useAutoTranslate('Ver Planos', 'pt');\n  const txtPlanPrice = useAutoTranslate('Ver Planos - €49,99/mês', 'pt');\n  const txtNeedActivate = useAutoTranslate('é necessário ativar o plano empresarial com todas as funcionalidades.', 'pt');\n  const txtSubscriptionExpired = useAutoTranslate('Subscrição Expirada', 'pt');\n  const txtSubscriptionExpiredDesc = useAutoTranslate('A sua subscrição expirou. Renove agora para continuar a usar todas as funcionalidades empresariais.', 'pt');\n  const txtRenewNow = useAutoTranslate('Renovar Agora', 'pt');\n  const txtBackToHome = useAutoTranslate('Voltar para Início', 'pt');\n  const txtExternalPurchaseDesc = useAutoTranslate('Para desbloquear esta funcionalidade, visite o nosso site no seu browser ou computador.', 'pt');\n  const txtExternalPurchasePromo = useAutoTranslate('7 dias grátis + €19,99 (1º mês) + €49,99/mês', 'pt');\n  const txt7DaysTrial = useAutoTranslate('7 dias grátis para testar', 'pt');\n  const txtUnlimitedQueues = useAutoTranslate('Gestão ilimitada de senhas', 'pt');\n  const txtCompleteBooking = useAutoTranslate('Sistema completo de marcações', 'pt');\n  const txtCancelAnytime = useAutoTranslate('Cancele quando quiser', 'pt');\n\n  // Mostrar loader enquanto está a verificar acesso\n  if (isLoading || companyProfile === undefined) {\n    return (\n      <div className=\"min-h-screen flex items-center justify-center bg-gradient-to-br from-slate-50 to-blue-50\">\n        <div className=\"text-center\">\n          <div className=\"w-12 h-12 border-4 border-sky-500 border-t-transparent rounded-full animate-spin mx-auto mb-4\"></div>\n          <p className=\"text-slate-600\">{txtVerifyingAccess}</p>\n        </div>\n      </div>\n    );\n  }\n\n  if (!companyProfile) {\n    return showInline ? (\n      <Alert className=\"border-red-300 bg-red-50\">\n        <AlertCircle className=\"h-4 w-4 text-red-600\" />\n        <AlertDescription className=\"text-red-900\">\n          {txtProfileNotFound}\n        </AlertDescription>\n      </Alert>\n    ) : null;\n  }\n\n  // 🚫 SUBSCRIÇÃO EXPIRADA - Mostrar banner grande com opção de renovar\n  const subscriptionExpired = isExpired || \n    companyProfile.subscriptionStatus === 'expired' || \n    companyProfile.status === 'expired';\n\n  if (subscriptionExpired) {\n    return (\n      <div className=\"min-h-screen bg-gradient-to-br from-slate-50 via-red-50 to-orange-50 p-4\">\n        <Card className=\"max-w-lg mx-auto border-2 border-red-300 bg-white shadow-xl mt-8\">\n          <CardContent className=\"p-8 text-center\">\n            <div className=\"w-20 h-20 rounded-full bg-red-100 flex items-center justify-center mx-auto mb-6\">\n              <CreditCard className=\"w-10 h-10 text-red-600\" />\n            </div>\n            <h2 className=\"text-2xl font-bold text-red-900 mb-3\">\n              {txtSubscriptionExpired}\n            </h2>\n            <p className=\"text-red-700 mb-6 text-lg\">\n              {txtSubscriptionExpiredDesc}\n            </p>\n            \n            {/* 🍎🤖 B2B COMPLIANCE: Apps nativas NÃO podem ter botões de pagamento */}\n            {isNativeApp ? (\n              <div className=\"space-y-4\">\n                <div className=\"bg-indigo-50 rounded-xl p-4 text-center\">\n                  <Globe className=\"w-8 h-8 text-indigo-600 mx-auto mb-2\" />\n                  <p className=\"text-indigo-700 text-sm mb-2\">\n                    {txtExternalPurchaseDesc}\n                  </p>\n                  <p className=\"text-indigo-900 font-bold text-lg\">\n                    waitless-qzero.com\n                  </p>\n                </div>\n                <div className=\"text-center\">\n                  <span className=\"inline-block px-3 py-1.5 bg-gradient-to-r from-green-500 to-emerald-500 text-white text-xs font-semibold rounded-full\">\n                    {txtExternalPurchasePromo}\n                  </span>\n                </div>\n              </div>\n            ) : (\n              <Button\n                onClick={() => navigate(createPageUrl('BusinessSubscription'), { \n                  state: { isReactivation: true, existingProfileId: companyProfile?.id } \n                })}\n                className=\"w-full bg-gradient-to-r from-red-600 to-orange-600 hover:from-red-700 hover:to-orange-700 py-6 text-lg\"\n              >\n                <CreditCard className=\"w-6 h-6 mr-3\" />\n                {txtRenewNow} - €49,99/mês\n                <ArrowRight className=\"w-6 h-6 ml-3\" />\n              </Button>\n            )}\n          </CardContent>\n        </Card>\n      </div>\n    );\n  }\n\n  // ✅ CORRIGIDO: Verificar hasAccess (inclui currentPeriodEnd para subscrições canceladas)\n  const shouldAllowAccess = hasAccess === true || companyProfile.featuresEnabled === true;\n  \n  if (shouldAllowAccess) {\n    return <>{children}</>;\n  }\n\n  const handleActivate = () => {\n    navigate(createPageUrl('BusinessSubscription'), { state: { profile: companyProfile } });\n  };\n\n  if (showInline) {\n    return (\n      <Card className=\"border-amber-300 bg-amber-50\">\n        <CardContent className=\"p-6\">\n          <div className=\"flex items-start gap-4\">\n            <div className=\"w-12 h-12 rounded-full bg-amber-200 flex items-center justify-center flex-shrink-0\">\n              <Lock className=\"w-6 h-6 text-amber-700\" />\n            </div>\n            <div className=\"flex-1\">\n              <h3 className=\"font-semibold text-amber-900 mb-1\">\n                {txtRestrictedAccess}\n              </h3>\n              <p className=\"text-sm text-amber-800 mb-3\">\n                {txtToAccess} {feature}, {txtNeedPlan}\n              </p>\n              {/* 🍎🤖 B2B COMPLIANCE: Apps nativas NÃO podem ter botões de pagamento */}\n              {isNativeApp ? (\n                <div className=\"flex items-center gap-2 text-indigo-700 mt-2\">\n                  <Globe className=\"w-4 h-4\" />\n                  <span className=\"text-sm font-semibold\">waitless-qzero.com</span>\n                </div>\n              ) : (\n                <Button\n                  onClick={handleActivate}\n                  className=\"bg-gradient-to-r from-amber-600 to-orange-600 hover:from-amber-700 hover:to-orange-700\"\n                >\n                  <CreditCard className=\"w-4 h-4 mr-2\" />\n                  {txtActivatePlan}\n                  <ArrowRight className=\"w-4 h-4 ml-2\" />\n                </Button>\n              )}\n            </div>\n          </div>\n        </CardContent>\n      </Card>\n    );\n  }\n\n  const handleGoHome = () => {\n    navigate(createPageUrl('BusinessHome'));\n  };\n\n  return (\n    <div className=\"min-h-screen bg-gradient-to-br from-slate-50 via-amber-50 to-orange-50 p-4\">\n      <div className=\"max-w-md mx-auto\">\n        <Button\n          variant=\"ghost\"\n          onClick={handleGoHome}\n          className=\"mb-4 gap-2\"\n        >\n          <ArrowLeft className=\"w-4 h-4\" />\n          {txtBackToHome}\n        </Button>\n        \n        <Card className=\"border-0 shadow-xl overflow-hidden\">\n          <div className=\"h-1.5 bg-gradient-to-r from-amber-500 via-orange-500 to-red-500\" />\n          <CardContent className=\"p-6 text-center\">\n            <div className=\"w-16 h-16 rounded-full bg-amber-100 flex items-center justify-center mx-auto mb-4\">\n              <Lock className=\"w-8 h-8 text-amber-600\" />\n            </div>\n            \n            <h2 className=\"text-xl font-bold text-slate-900 mb-2\">\n              {txtRestrictedAccess}\n            </h2>\n            \n            <p className=\"text-slate-600 mb-4\">\n              {txtToAccess} <strong>{feature}</strong>, {txtNeedActivate}\n            </p>\n\n            {isNativeApp ? (\n              <div className=\"space-y-4\">\n                <div className=\"bg-indigo-50 rounded-xl p-4 text-center\">\n                  <Globe className=\"w-8 h-8 text-indigo-600 mx-auto mb-2\" />\n                  <p className=\"text-indigo-700 text-sm mb-2\">\n                    {txtExternalPurchaseDesc}\n                  </p>\n                  <p className=\"text-indigo-900 font-bold text-lg\">\n                    waitless-qzero.com\n                  </p>\n                </div>\n                \n                <div className=\"text-center\">\n                  <span className=\"inline-block px-3 py-1.5 bg-gradient-to-r from-green-500 to-emerald-500 text-white text-xs font-semibold rounded-full\">\n                    {txtExternalPurchasePromo}\n                  </span>\n                </div>\n              </div>\n            ) : (\n              <div className=\"space-y-4\">\n                <div className=\"space-y-2 text-left mb-4\">\n                  {[txt7DaysTrial, txtUnlimitedQueues, txtCompleteBooking, txtCancelAnytime].map((feat, idx) => (\n                    <div key={idx} className=\"flex items-center gap-2\">\n                      <CheckCircle2 className=\"w-4 h-4 text-green-600 flex-shrink-0\" />\n                      <span className=\"text-slate-700 text-sm\">{feat}</span>\n                    </div>\n                  ))}\n                </div>\n                \n                <Button\n                  onClick={handleActivate}\n                  className=\"w-full bg-gradient-to-r from-amber-500 to-orange-500 hover:from-amber-600 hover:to-orange-600\"\n                >\n                  <CreditCard className=\"w-4 h-4 mr-2\" />\n                  {txtActivatePlan}\n                  <ArrowRight className=\"w-4 h-4 ml-2\" />\n                </Button>\n              </div>\n            )}\n            \n            <Button\n              variant=\"ghost\"\n              onClick={handleGoHome}\n              className=\"w-full mt-3 text-slate-600\"\n            >\n              <ArrowLeft className=\"w-4 h-4 mr-2\" />\n              {txtBackToHome}\n            </Button>\n          </CardContent>\n        </Card>\n      </div>\n    </div>\n  );\n}\n","path":null,"size_bytes":10934,"size_tokens":null},"replit.md":{"content":"# QZero - Sistema de Gestão de Filas e Agendamentos\n\n## Current Version\n- **Version:** 1.8.3\n- **Build:** 33\n- **Bundle ID:** com.afonso.qzerocerto\n- **Status:** PRODUCTION-READY ✅\n\n## Recent Changes (December 5, 2025)\n- **B2B Registration Compliance**: iOS/Android apps only allow personal account creation - business account option completely hidden on native platforms (Apple/Google B2B compliance)\n- **Mobile Scroll Fix**: Removed `min-h-screen` from 40+ page components to eliminate extra scroll space caused by Layout padding\n- **Complete B2B Compliance Audit**: All payment CTAs hidden in native iOS/Android apps\n- **Toast Notifications Redesigned**: WhatsApp-style toasts with gradient colors, WCAG AA compliant\n- **Bug Fix**: Removed non-existent `Notification.create()` call - push notifications use Firebase\n- **Version Sync**: All config files synchronized (package.json, build.gradle, Info.plist)\n- **Firebase Push**: Verified correct Bundle ID in google-services.json and GoogleService-Info.plist\n\n## B2B Compliance Status (App Store / Play Store Ready)\nAll components verified to hide payment buttons on native platforms:\n- ✅ BusinessFeatureGuard - redirects to waitless-qzero.com\n- ✅ ExpiredBanner - shows external website notice\n- ✅ TrialBanner - shows external website notice  \n- ✅ RestrictedAccessOverlay - shows external website notice\n- ✅ PaymentPendingBanner - shows external website notice\n- ✅ BusinessSubscription - full external redirect flow for native apps\n\n## Overview\nQZero is a production-ready React + Vite application for enterprise queue and appointment management. It aims to improve customer experience and operational efficiency through real-time tracking, analytics, and scalable management tools. The system supports both customer and business accounts, features an integrated Stripe subscription flow, and is prepared for Android/iOS deployment via Capacitor. Its ambition is to be a leading solution for businesses seeking to optimize customer flow and enhance service delivery.\n\n## User Preferences\n- Ask before making major changes.\n- I prefer detailed explanations.\n- Do not make changes to the folder `Z`.\n- Do not make changes to the file `Y`.\n\n## System Architecture\n**UI/UX Decisions:** The system features a modern, responsive, and mobile-first design utilizing Radix UI, Tailwind CSS, and Framer Motion. Key UI/UX elements include a `useConfirm` hook, WhatsApp-style Sonner notifications with gradient colors, a fixed bottom navigation bar for mobile, WCAG 2.1 AA compliance, and a redesigned calendar component. Mobile layouts have been optimized for minimal scrolling with compact headers (text-xl instead of text-4xl), accordion patterns in BusinessSettings, 4-column stats grids, and reduced padding throughout all pages.\n\n**Technical Implementations:**\n- **Backend:** Node.js + Express with security middleware (Helmet, CORS, rate-limiting, input validation, sanitization), Winston logging, and PostgreSQL with Drizzle ORM.\n- **Frontend:** React 18, Vite 6, Radix UI, Tailwind CSS, Framer Motion, `@tanstack/react-query` for state management, and React Router DOM v7 for routing.\n- **API Client:** Custom standalone client (`src/api/base44Client.js`).\n- **Authentication:** Production-ready 2FA system using bcrypt, JWT (HTTP-only cookies), and email-based 6-digit codes. Supports customer (\"pessoal\") and business (\"empresa\") account types, including staff invitation with inherited subscription access, optimized for secure cookie handling across environments.\n- **Data Persistence:** PostgreSQL for all core data including company profiles, tickets, queues, and appointments, ensuring permanent storage.\n- **Payment Processing:** B2B external payment model - Stripe (web, with 7-day free trial). Mobile apps (iOS/Android) redirect to external website (waitless-qzero.com) for subscription purchase, as permitted by Apple/Google B2B guidelines. No in-app purchases.\n- **Mobile App (Capacitor):** Production-ready for Android/iOS deployment with security hardening. Includes `@capacitor/geolocation` for geolocation features.\n- **Internationalization (i18n):** Production-ready multi-language support for 23 languages using `react-i18next` with automatic browser detection, manual selection persistence, and complete date localization via `date-fns`. Dynamic UI translation is supported via Google Cloud Translation API.\n- **GDPR-Compliant System:** Privacy Policy and Terms of Use accessible from Profile > Legal Information section. Account deletion fully removes all user data. No pre-registration consent gate (simplified registration flow).\n- **Toast Notifications:** WhatsApp-style design with gradient colors (green success, red error, orange warning, blue info), bottom-center positioning, safe area support for iOS notch.\n\n**Feature Specifications:**\n- **Customer Portal:** Business viewing with GPS filtering, virtual queues, appointments, real-time tracking, history, geolocation, and reviews.\n- **Business Portal (Paid Subscription):** Dashboard, queue, service, and appointment management, analytics, team management.\n- **Enterprise Subscription Flow:** Business profile creation, Stripe Checkout, access control, 7-day free trial.\n- **Push Notifications:** Implemented for iOS and Android using Firebase Cloud Messaging, with notifications for queue alerts, ticket calls, appointment reminders, and confirmations, all translated into the user's preferred language. Account deletion is fully GDPR compliant, removing all associated user and business data.\n\n## External Dependencies\n- **Stripe:** Payment processing for enterprise subscriptions (web only).\n- **OpenStreetMap Nominatim API:** Geocoding business addresses.\n- **Google Maps Places API:** Address validation and autocomplete for business profiles.\n- **Google Cloud Translation API:** Automatic real-time translation of UI content, business names, descriptions, and emails.\n- **Firebase Cloud Messaging:** Push notifications for iOS and Android.\n\n## Build Commands\n```bash\n# Development\nnpm run dev\n\n# Build for production\nnpm run build\n\n# Capacitor sync (after build)\nnpm run cap:sync\n\n# Open Android Studio\nnpm run cap:android\n\n# Open Xcode\nnpm run cap:ios\n```\n","path":null,"size_bytes":6207,"size_tokens":null},"src/models/companyProfile.js":{"content":"export const SUBSCRIPTION_STATUS = {\n  PENDING_PAYMENT: 'pending_payment',\n  ACTIVE: 'active',\n  PAST_DUE: 'past_due',\n  CANCELLED: 'cancelled',\n  TRIAL: 'trial'\n};\n\n// Mapeamento de categorias: label PT → código\nexport const COMPANY_CATEGORIES = {\n  'saude': 'Saúde',\n  'financeiro': 'Financeiro',\n  'governo': 'Governo',\n  'restauracao': 'Restauração',\n  'beleza': 'Beleza',\n  'retalho': 'Retalho',\n  'outros': 'Outros'\n};\n\n// Lista legada (retrocompatibilidade) - usar apenas para migração\nconst LEGACY_CATEGORIES = [\n  'Clínica',\n  'Restaurante',\n  'Repartição Pública',\n  'Barbearia',\n  'Salão de Beleza',\n  'Consultório',\n  'Loja',\n  'Banco',\n  'Outros'\n];\n\n// Normalizar categoria (label legado ou novo código → código)\nexport const normalizeCategory = (category) => {\n  if (!category) return 'outros';\n  \n  // Se já é um código válido, retornar\n  if (COMPANY_CATEGORIES[category]) return category;\n  \n  // Mapear labels legados para códigos\n  const legacyMap = {\n    'Clínica': 'saude',\n    'Consultório': 'saude',\n    'Restaurante': 'restauracao',\n    'Repartição Pública': 'governo',\n    'Barbearia': 'beleza',\n    'Salão de Beleza': 'beleza',\n    'Loja': 'retalho',\n    'Banco': 'financeiro',\n    'Outros': 'outros'\n  };\n  \n  return legacyMap[category] || 'outros';\n};\n\n// Normalizar país (nome completo ou código ISO)\nexport const normalizeCountry = (country) => {\n  if (!country) return 'PT';\n  \n  // Se já é código ISO válido, retornar\n  if (country.length === 2) return country.toUpperCase();\n  \n  // Mapear nomes completos para códigos ISO\n  const countryMap = {\n    'Portugal': 'PT',\n    'Brasil': 'BR',\n    'Espanha': 'ES',\n    'França': 'FR',\n    'Alemanha': 'DE',\n    'Itália': 'IT',\n    'Reino Unido': 'UK',\n    'Estados Unidos': 'US',\n    'Canadá': 'CA',\n    'Outro': 'PT'\n  };\n  \n  return countryMap[country] || 'PT';\n};\n\nexport class CompanyProfile {\n  constructor(data = {}) {\n    this.id = data.id || `company_${Date.now()}`;\n    this.companyName = data.companyName || '';\n    this.companyVAT = data.companyVAT || '';\n    this.companyCountry = data.companyCountry || 'PT';\n    this.companyCity = data.companyCity || '';\n    this.companyPostalCode = data.companyPostalCode || '';\n    this.companyStreetName = data.companyStreetName || '';\n    this.companyDoorNumber = data.companyDoorNumber || '';\n    this.companyDistrict = data.companyDistrict || '';\n    this.companyPhone = data.companyPhone || '';\n    this.companyEmail = data.companyEmail || '';\n    this.companyCategory = data.companyCategory || '';\n    this.companyDescription = data.companyDescription || '';\n    this.companyCoordinates = data.companyCoordinates || null;\n    this.logoUrl = data.logoUrl || null;\n    this.photoUrl = data.photoUrl || null;\n    \n    // Campo calculado: companyAddress (retrocompatibilidade)\n    if (data.companyAddress) {\n      this.companyAddress = data.companyAddress;\n    } else if (this.companyStreetName && this.companyDoorNumber) {\n      this.companyAddress = `${this.companyStreetName} ${this.companyDoorNumber}, ${this.companyPostalCode} ${this.companyCity}`;\n    } else {\n      this.companyAddress = '';\n    }\n    this.adminUserId = data.adminUserId || '';\n    this.status = data.status || SUBSCRIPTION_STATUS.PENDING_PAYMENT;\n    this.subscriptionId = data.subscriptionId || null;\n    this.stripeCustomerId = data.stripeCustomerId || null;\n    this.subscriptionStatus = data.subscriptionStatus || null;\n    this.currentPeriodEnd = data.currentPeriodEnd || null;  // ✅ Data de fim do período atual\n    this.trialEnd = data.trialEnd || null;  // ✅ Data de fim do trial\n    this.temporaryAccess = data.temporaryAccess || {\n      enabled: false,\n      expiresAt: null,\n      grantedBy: null,\n      reason: null\n    };\n    // NOVO: Tracking persistente de erros de pagamento\n    this.paymentRetry = data.paymentRetry || {\n      failureCount: 0,\n      lastFailureAt: null,\n      lastFailureReason: null,\n      canRetry: true\n    };\n    this.createdAt = data.createdAt || new Date().toISOString();\n    this.updatedAt = data.updatedAt || new Date().toISOString();\n  }\n\n  get featuresEnabled() {\n    // ❌ VERIFICAR EXPIRAÇÃO PRIMEIRO\n    if (this.subscriptionStatus === 'expired') {\n      console.log('❌ featuresEnabled: Subscrição expirada');\n      return false;\n    }\n    \n    // ❌ Verificar se currentPeriodEnd já passou\n    if (this.currentPeriodEnd) {\n      const now = new Date();\n      const periodEnd = new Date(this.currentPeriodEnd);\n      if (now > periodEnd) {\n        console.log('❌ featuresEnabled: Período expirado em', periodEnd.toISOString());\n        return false;\n      }\n    }\n    \n    // ❌ Status cancelled sem tempo restante = sem acesso\n    if (this.status === SUBSCRIPTION_STATUS.CANCELLED || this.status === 'cancelled') {\n      const now = new Date();\n      const periodEnd = this.currentPeriodEnd ? new Date(this.currentPeriodEnd) : null;\n      if (!periodEnd || now > periodEnd) {\n        console.log('❌ featuresEnabled: Cancelado e expirado');\n        return false;\n      }\n    }\n    \n    if (this.temporaryAccess.enabled && this.temporaryAccess.expiresAt) {\n      const now = new Date();\n      const expiresAt = new Date(this.temporaryAccess.expiresAt);\n      if (now <= expiresAt) {\n        return true;\n      }\n    }\n    \n    // ✅ Aceitar tanto 'active' quanto 'trialing' (período de teste grátis de 7 dias)\n    return this.status === SUBSCRIPTION_STATUS.ACTIVE || \n           this.subscriptionStatus === 'active' ||\n           this.subscriptionStatus === 'trialing';\n  }\n\n  toJSON() {\n    return {\n      id: this.id,\n      companyName: this.companyName,\n      companyVAT: this.companyVAT,\n      companyCountry: this.companyCountry,\n      companyAddress: this.companyAddress,\n      companyCity: this.companyCity,\n      companyPostalCode: this.companyPostalCode,\n      companyStreetName: this.companyStreetName,\n      companyDoorNumber: this.companyDoorNumber,\n      companyDistrict: this.companyDistrict,\n      companyPhone: this.companyPhone,\n      companyEmail: this.companyEmail,\n      companyCategory: this.companyCategory,\n      companyDescription: this.companyDescription,\n      companyCoordinates: this.companyCoordinates,\n      logoUrl: this.logoUrl,\n      photoUrl: this.photoUrl,\n      adminUserId: this.adminUserId,\n      status: this.status,\n      subscriptionId: this.subscriptionId,\n      stripeCustomerId: this.stripeCustomerId,\n      subscriptionStatus: this.subscriptionStatus,\n      currentPeriodEnd: this.currentPeriodEnd,  // ✅ Incluir data de fim do período\n      trialEnd: this.trialEnd,  // ✅ Incluir data de fim do trial\n      temporaryAccess: this.temporaryAccess,\n      paymentRetry: this.paymentRetry,\n      featuresEnabled: this.featuresEnabled,\n      createdAt: this.createdAt,\n      updatedAt: this.updatedAt\n    };\n  }\n\n  static fromJSON(json) {\n    return new CompanyProfile(json);\n  }\n}\n\nexport const companyProfileStorage = {\n  STORAGE_KEY: 'company_profiles',\n  \n  async getAll() {\n    try {\n      // ✅ SEMPRE buscar do PostgreSQL via API\n      // Nota: Endpoint /api/public/businesses lista empresas ativas publicamente\n      // Para administração completa, implementar /api/company-profiles GET\n      console.log('⚠️ getAll() não implementado - use /api/public/businesses para listagem pública');\n      return [];\n    } catch (error) {\n      console.error('❌ Erro ao carregar perfis:', error);\n      return [];\n    }\n  },\n  \n  async getById(id) {\n    try {\n      const { safeFetch } = await import('@/utils/apiConfig');\n      const { response, data } = await safeFetch(`/api/company-profiles/${id}`);\n      if (!response.ok) {\n        if (response.status === 404) {\n          console.log('⚠️ Perfil não encontrado no PostgreSQL para ID:', id);\n          return null;\n        }\n        throw new Error(`HTTP ${response.status}`);\n      }\n      return CompanyProfile.fromJSON(data);\n    } catch (error) {\n      console.error('❌ Erro ao buscar perfil por ID:', error);\n      return null;\n    }\n  },\n  \n  async getByUserId(userId) {\n    // Validação defensiva: detectar se foi passado email em vez de ID\n    if (userId && userId.includes('@')) {\n      console.error('⚠️ ERRO: getByUserId() recebeu EMAIL em vez de USER ID:', userId);\n      console.error('💡 FIX: Use user.id em vez de user.email');\n      console.trace('Stack trace:');\n      return null;\n    }\n    \n    try {\n      const { safeFetch } = await import('@/utils/apiConfig');\n      const { response, data } = await safeFetch(`/api/company-profiles/user/${userId}`);\n      if (!response.ok) {\n        throw new Error(`HTTP ${response.status}`);\n      }\n      \n      // ✅ APENAS PostgreSQL - SEM fallback para localStorage\n      if (data?.profile) {\n        return CompanyProfile.fromJSON(data.profile);\n      }\n      \n      console.log('⚠️ Perfil não encontrado no PostgreSQL para userId:', userId);\n      return null;\n    } catch (error) {\n      console.error('❌ Erro ao buscar perfil por userId:', error);\n      return null;\n    }\n  },\n  \n  // ❌ DEPRECATED: Não usar mais localStorage\n  getLocalStorageProfiles() {\n    console.warn('⚠️ getLocalStorageProfiles() DEPRECATED - dados devem vir do PostgreSQL');\n    return [];\n  },\n  \n  async save(profile) {\n    try {\n      // Verificar se já existe\n      const existing = await this.getById(profile.id);\n      \n      if (existing) {\n        return await this.update(profile.id, profile);\n      } else {\n        return await this.create(profile);\n      }\n    } catch (error) {\n      console.error('❌ Erro ao salvar perfil:', error);\n      throw error; // ✅ Propagar erro em vez de fallback silencioso\n    }\n  },\n  \n  async create(profile) {\n    try {\n      const { safeFetch } = await import('@/utils/apiConfig');\n      const { response, data } = await safeFetch('/api/company-profiles', {\n        method: 'POST',\n        body: JSON.stringify(profile)\n      });\n      \n      if (!response.ok) {\n        throw new Error(`HTTP ${response.status}`);\n      }\n      \n      return CompanyProfile.fromJSON(data);\n    } catch (error) {\n      console.error('Error creating profile:', error);\n      throw error;\n    }\n  },\n  \n  async update(id, updates) {\n    try {\n      const { safeFetch } = await import('@/utils/apiConfig');\n      const { response, data } = await safeFetch(`/api/company-profiles/${id}`, {\n        method: 'PUT',\n        body: JSON.stringify(updates)\n      });\n      \n      if (!response.ok) {\n        throw new Error(`HTTP ${response.status}`);\n      }\n      \n      return CompanyProfile.fromJSON(data);\n    } catch (error) {\n      console.error('Error updating profile:', error);\n      throw error;\n    }\n  },\n  \n  async delete(id) {\n    try {\n      const { safeFetch } = await import('@/utils/apiConfig');\n      const { response, data } = await safeFetch(`/api/company-profiles/${id}`, {\n        method: 'DELETE'\n      });\n      \n      if (!response.ok) {\n        throw new Error(`HTTP ${response.status}`);\n      }\n      \n      return data;\n    } catch (error) {\n      console.error('Error deleting profile:', error);\n      throw error;\n    }\n  },\n  \n  // ❌ DEPRECATED: NÃO USAR - dados devem ser salvos no PostgreSQL via API\n  saveToLocalStorage(profile) {\n    console.error('❌ saveToLocalStorage() DEPRECATED - use companyProfileStorage.save() que persiste no PostgreSQL');\n    throw new Error('localStorage desabilitado - use PostgreSQL API');\n  },\n  \n  // ❌ DEPRECATED: Migração manual já não é necessária (limpeza automática ativa)\n  async migrateFromLocalStorage() {\n    console.warn('⚠️ migrateFromLocalStorage() DEPRECATED - limpeza automática ativa no login/bootstrap');\n    return { migrated: 0, errors: [], message: 'Migração desabilitada - localStorage limpo automaticamente' };\n  }\n};\n","path":null,"size_bytes":11845,"size_tokens":null},"src/hooks/useBusinessAccess.js":{"content":"import { useEffect, useState } from 'react';\nimport { businessAccessService } from '@/services/businessAccessService';\nimport { useUser } from '@/contexts/UserContext';\n\nexport function useBusinessAccess() {\n  // 🎯 CONTEXTO COMPARTILHADO: Consome user do contexto (UMA ÚNICA chamada a base44.auth.me())\n  const { user } = useUser();\n  \n  const [businessAccess, setBusinessAccess] = useState(null);\n  const [loading, setLoading] = useState(true);\n  const [refreshKey, setRefreshKey] = useState(0);\n\n  useEffect(() => {\n    const loadUserAndAccess = async () => {\n      // ⚠️ GATE: Esperar user do contexto antes de carregar acesso empresarial\n      if (!user) {\n        setLoading(false);\n        setBusinessAccess(null);\n        return;\n      }\n      \n      try {\n        console.log('✅ useBusinessAccess: Usando user do contexto (sem chamada duplicada):', user.email);\n        \n        const access = await businessAccessService.getUserBusinessAccess(user);\n        console.log('🏢 useBusinessAccess: Acesso empresarial carregado:', {\n          hasAccess: access.hasAccess,\n          isPending: access.isPending,\n          source: access.source\n        });\n        \n        setBusinessAccess(access);\n      } catch (error) {\n        // 📊 LOGGING DETALHADO para debug Safari iOS\n        const errorDetails = {\n          message: error?.message || 'Unknown error',\n          status: error?.response?.status || 'No status',\n          type: error?.name || 'Unknown type',\n          stack: error?.stack?.substring(0, 200) || 'No stack trace'\n        };\n        \n        console.error('❌ useBusinessAccess: Erro ao carregar acesso empresarial:', errorDetails);\n        \n        // Não fazer logout aqui - deixar Layout.jsx gerir autenticação\n        // Este hook apenas gere acesso empresarial, não sessão global\n      } finally {\n        setLoading(false);\n      }\n    };\n\n    loadUserAndAccess();\n  }, [refreshKey, user]);\n  \n  // Função para forçar recarga (pode ser chamada externamente)\n  const refresh = () => {\n    console.log('🔄 useBusinessAccess: Recarga forçada');\n    setRefreshKey(prev => prev + 1);\n  };\n\n  return {\n    user,\n    companyProfile: businessAccess?.companyProfile || null,\n    subscription: businessAccess?.subscription || null,\n    loading,\n    isLoading: loading, // ✅ Alias para compatibilidade\n    hasAccess: businessAccess?.hasAccess || false, // ✅ CORRIGIDO: Retornar hasAccess diretamente\n    hasActiveSubscription: businessAccess?.hasAccess || false, // ✅ Manter para compatibilidade\n    hasPendingPayment: businessAccess?.isPending || false,\n    isPending: businessAccess?.isPending || false, // ✅ Alias para compatibilidade\n    isExpired: businessAccess?.isExpired || false, // 🚫 Flag de expiração\n    source: businessAccess?.source || 'none',\n    refresh\n  };\n}\n","path":null,"size_bytes":2836,"size_tokens":null},"server/index.js":{"content":"import express from 'express';\nimport cors from 'cors';\nimport helmet from 'helmet';\nimport rateLimit from 'express-rate-limit';\nimport Stripe from 'stripe';\nimport { Resend } from 'resend';\nimport { google } from 'googleapis';\nimport { companyProfileStorage, SUBSCRIPTION_STATUS } from '../src/models/companyProfile.js';\nimport fs from 'fs';\nimport path from 'path';\nimport { fileURLToPath } from 'url';\nimport multer from 'multer';\nimport bcrypt from 'bcrypt';\nimport jwt from 'jsonwebtoken';\nimport cookieParser from 'cookie-parser';\nimport crypto from 'crypto';\nimport { db } from './db.js';\nimport { companyProfiles, users, verificationCodes, challengeTokens, passwordResetTokens, consents, tickets, queues, appointments, deviceTokens, pushNotifications, staffInvites, services } from '../shared/schema.js';\nimport { eq, and, gt, desc, sql } from 'drizzle-orm';\nimport { fileTypeFromBuffer } from 'file-type';\nimport { \n  sanitizeMiddleware, \n  validateRegister, \n  validateLogin,\n  validateEmail,\n  validateId,\n  validateVerificationCode,\n  validateRequestPasswordReset,\n  validateResetPassword,\n  validateCompanyProfile,\n  validateCancelSubscription,\n  handleValidationErrors,\n  errorHandler,\n  safeLog\n} from './middleware/security.js';\nimport logger, { logAuthFailure, logAuthSuccess, logSecurityEvent } from './middleware/logger.js';\nimport { translateText, translateBatch, detectLanguage } from './services/translateService.js';\nimport objectStorageService, { ObjectNotFoundError } from './services/objectStorage.js';\nimport pushNotificationService from './services/pushNotificationService.js';\n\nconst __filename = fileURLToPath(import.meta.url);\nconst __dirname = path.dirname(__filename);\nconst STORAGE_FILE = path.join(__dirname, 'demoStore.json');\n\n// Diretório para uploads\nconst UPLOADS_DIR = path.join(__dirname, '../uploads');\nif (!fs.existsSync(UPLOADS_DIR)) {\n  fs.mkdirSync(UPLOADS_DIR, { recursive: true });\n}\n\n// Configuração do Multer para upload de ficheiros\nconst storage = multer.diskStorage({\n  destination: (req, file, cb) => {\n    cb(null, UPLOADS_DIR);\n  },\n  filename: (req, file, cb) => {\n    const uniqueSuffix = Date.now() + '-' + Math.round(Math.random() * 1E9);\n    const ext = path.extname(file.originalname);\n    const safeName = file.originalname.replace(ext, '').replace(/[^a-z0-9]/gi, '_').toLowerCase();\n    cb(null, `${safeName}-${uniqueSuffix}${ext}`);\n  }\n});\n\nconst fileFilter = (req, file, cb) => {\n  const allowedTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/gif'];\n  \n  if (allowedTypes.includes(file.mimetype)) {\n    cb(null, true);\n  } else {\n    cb(new Error('Tipo de ficheiro inválido. Apenas PNG, JPG, JPEG e GIF são permitidos.'), false);\n  }\n};\n\nconst upload = multer({\n  storage: storage,\n  limits: {\n    fileSize: 5 * 1024 * 1024 // 5MB\n  },\n  fileFilter: fileFilter\n});\n\n// Debug: Verificar se a chave é de teste\nconst stripeKey = process.env.STRIPE_SECRET_KEY;\nconst IS_STRIPE_LIVE = stripeKey && stripeKey.startsWith('sk_live_');\n\n// 🔍 DETECTAR PRODUÇÃO DE FORMA ROBUSTA\n// Produção APENAS se NODE_ENV=production OU deployment oficial\n// ✅ NÃO usar IS_STRIPE_LIVE - permite dev com chave LIVE sem forçar modo produção\nconst IS_PRODUCTION = process.env.NODE_ENV === 'production' || \n                      process.env.REPLIT_DEPLOYMENT === '1';\n\n// 🌐 DOMÍNIO COOKIES: Detectar se estamos em domínio personalizado ou Replit dev\n// CRÍTICO: Cookies com domain='waitless-qzero.com' NÃO funcionam em *.replit.dev!\nconst isCustomDomain = process.env.REPLIT_DEPLOYMENT === '1'; // Apenas em deployment oficial\nconst COOKIE_DOMAIN = (IS_PRODUCTION && isCustomDomain) ? 'waitless-qzero.com' : undefined;\n\n// 🔍 DEBUG: Log das variáveis de ambiente para diagnóstico\nconsole.log('🔍 DETECÇÃO DE AMBIENTE:', {\n  'NODE_ENV': process.env.NODE_ENV,\n  'REPLIT_DEPLOYMENT': process.env.REPLIT_DEPLOYMENT,\n  'IS_STRIPE_LIVE': IS_STRIPE_LIVE,\n  'IS_PRODUCTION': IS_PRODUCTION\n});\n\nif (stripeKey) {\n  const keyPrefix = stripeKey.substring(0, 8);\n  console.log('🔑 Stripe Key Prefix:', keyPrefix);\n  if (keyPrefix.startsWith('sk_test_')) {\n    console.log('✅ Usando chave de TESTE da Stripe');\n  } else if (keyPrefix.startsWith('sk_live_')) {\n    console.log('🚀 ATENÇÃO: Usando chave de PRODUÇÃO da Stripe!');\n    console.log('💰 Pagamentos serão REAIS - modo LIVE ativo');\n  } else {\n    console.log('❌ Formato de chave desconhecido');\n  }\n} else {\n  console.log('❌ STRIPE_SECRET_KEY não está definida!');\n}\n\nconsole.log(`🌍 Ambiente: ${IS_PRODUCTION ? 'PRODUÇÃO' : 'DESENVOLVIMENTO'}`);\nconsole.log(`💳 Stripe: ${IS_STRIPE_LIVE ? 'LIVE (REAL)' : 'TEST (SIMULADO)'}`);\nif (IS_PRODUCTION && !IS_STRIPE_LIVE) {\n  console.warn('⚠️ AVISO: Ambiente PRODUÇÃO mas Stripe em modo TESTE!');\n}\n\n// ⚠️ CRÍTICO: Validar que Stripe key existe\nif (!stripeKey) {\n  console.error('❌ ERRO FATAL: STRIPE_SECRET_KEY não está configurada!');\n  console.error('🔧 Configure via: Tools → Secrets → STRIPE_SECRET_KEY');\n  process.exit(1);\n}\n\nconst stripe = new Stripe(stripeKey, {\n  apiVersion: '2023-10-16',\n});\n\n// 🍪 CONFIGURAÇÃO CENTRALIZADA DE COOKIES\n// Desenvolvimento: sameSite: 'strict' (same-origin via Vite proxy) evita Lax+POST\n// Produção: sameSite: 'lax' + secure: true (Safari iOS compatível)\n// 🔒 CORREÇÃO SAFARI iOS: Detectar conexão HTTPS mesmo em desenvolvimento\n// Safari iOS rejeita cookies com secure:false quando acedido via HTTPS (replit.dev)\nconst isHttpsConnection = process.env.REPLIT_DEPLOYMENT === '1' || \n                          process.env.REPL_SLUG !== undefined; // Replit sempre usa HTTPS\n\n// 🐛 WORKAROUND SAFARI 16.4+: Bug conhecido perde cookies com SameSite=Lax\n// Solução: OMITIR SameSite completamente + adicionar Domain + maxAge explícito\n// Referência: WebKit Bug #255524\n// ✅ CAPACITOR FIX: Usar SameSite=None + Secure para cross-origin requests\nconst COOKIE_OPTIONS = {\n  httpOnly: true,\n  secure: true, // ✅ SEMPRE true - HTTPS obrigatório para SameSite=None\n  maxAge: 7 * 24 * 60 * 60 * 1000, // 7 dias (OBRIGATÓRIO para persistência)\n  sameSite: 'none', // ✅ CAPACITOR: Necessário para cross-origin (WebView → API)\n  path: '/', // ✅ Disponível em todo o domínio\n  domain: COOKIE_DOMAIN, // ✅ undefined em dev/replit, domínio em produção\n};\n\n// 🗑️ FUNÇÃO HELPER: Limpeza AGRESSIVA de cookies para Safari iOS\n// Safari iOS frequentemente ignora clearCookie() normal, então precisamos forçar\nfunction aggressiveClearCookie(res, cookieName) {\n  // Método 1: clearCookie com options (padrão)\n  res.clearCookie(cookieName, COOKIE_OPTIONS);\n  \n  // Método 2: clearCookie SEM options (às vezes funciona melhor no Safari)\n  res.clearCookie(cookieName);\n  \n  // Método 3: Forçar expiração via Set-Cookie manual (garantia absoluta)\n  // CRÍTICO: Usar COOKIE_DOMAIN (não hardcoded) para coincidir com cookie original\n  const domain = COOKIE_DOMAIN ? `; Domain=${COOKIE_DOMAIN}` : '';\n  res.setHeader('Set-Cookie', [\n    `${cookieName}=deleted; Path=/; Expires=Thu, 01 Jan 1970 00:00:00 GMT; HttpOnly; Secure; SameSite=None${domain}`,\n    `${cookieName}=deleted; Path=/; Max-Age=0; HttpOnly; Secure; SameSite=None${domain}`\n  ]);\n  \n  console.log(`🗑️ Cookie \"${cookieName}\" limpo agressivamente (3 métodos, domain=${COOKIE_DOMAIN || 'default'})`);\n}\n\nconsole.log('🍪 Configuração de cookies:', {\n  secure: COOKIE_OPTIONS.secure,\n  sameSite: COOKIE_OPTIONS.sameSite || 'OMITIDO (Safari workaround)',\n  httpOnly: COOKIE_OPTIONS.httpOnly,\n  maxAge: '7 dias',\n  domain: COOKIE_DOMAIN || 'padrão (current domain)',\n  IS_PRODUCTION,\n  isHttpsConnection,\n  isCustomDomain\n});\n\nconst app = express();\n\n// ⚙️ CONFIGURAÇÃO: Trust proxy (Replit usa proxy reverso)\n// Essencial para rate limiting funcionar corretamente em produção\napp.set('trust proxy', 1);\n\n// ================== SEGURANÇA ==================\n\n// 🛡️ 1. HELMET - Security headers HTTP\n// Protege contra: XSS, clickjacking, MIME sniffing, etc.\napp.use(helmet({\n  contentSecurityPolicy: IS_PRODUCTION ? {\n    directives: {\n      defaultSrc: [\"'self'\"],\n      scriptSrc: [\"'self'\", \"'unsafe-inline'\", \"'unsafe-eval'\", \"https://maps.googleapis.com\"],\n      styleSrc: [\"'self'\", \"'unsafe-inline'\", \"https://fonts.googleapis.com\"],\n      imgSrc: [\"'self'\", \"data:\", \"https:\", \"https://*.googleapis.com\", \"https://*.gstatic.com\"],\n      connectSrc: [\n        \"'self'\", \n        \"https://api.stripe.com\",\n        \"https://nominatim.openstreetmap.org\",\n        \"https://maps.googleapis.com\",\n        \"https://*.googleapis.com\"\n      ],\n      frameSrc: [\"'self'\", \"https://js.stripe.com\", \"https://hooks.stripe.com\"],\n      fontSrc: [\"'self'\", \"data:\", \"https://fonts.gstatic.com\"],\n    },\n  } : false,\n  crossOriginEmbedderPolicy: false,\n  hsts: IS_PRODUCTION ? {\n    maxAge: 31536000, // 1 ano\n    includeSubDomains: true,\n    preload: true\n  } : false,\n  noSniff: true, // Prevenir MIME sniffing\n  frameguard: { action: 'deny' }, // Prevenir clickjacking\n  xssFilter: true, // XSS protection\n  hidePoweredBy: true, // Esconder X-Powered-By\n  referrerPolicy: { policy: 'strict-origin-when-cross-origin' }\n}));\n\n// 🛡️ 2. RATE LIMITING - Proteção contra spam/DDoS\n// Limita requests por IP para prevenir ataques\n// ✅ AUMENTADO SIGNIFICATIVAMENTE - O Replit dev também pode ter IS_PRODUCTION=true por causa do Stripe\nconst limiter = rateLimit({\n  windowMs: 15 * 60 * 1000,\n  max: 5000, // ✅ AUMENTADO: 5000 req/15min para suportar traduções intensivas\n  message: 'Muitos pedidos deste IP. Por favor, tente novamente mais tarde.',\n  standardHeaders: true,\n  legacyHeaders: false,\n  skip: (req) => {\n    // ✅ CRÍTICO: Excluir traduções do rate limiter geral (tem seu próprio limiter)\n    if (req.path === '/api/translate' || req.path === '/api/translate/detect') return true;\n    if (req.path === '/api/stripe-webhook') return true;\n    if (req.path.includes('/api/demo/')) return true;\n    // ✅ Excluir autenticação (tem seu próprio limiter)\n    if (req.path.startsWith('/api/auth/')) return true;\n    return false;\n  },\n});\n\n// Aplicar rate limiting em todas rotas da API\napp.use('/api/', limiter);\n\n// Rate limiting para autenticação (mais generoso para evitar bloqueios acidentais)\nconst authLimiter = rateLimit({\n  windowMs: 5 * 60 * 1000, // ✅ 5 minutos (reduzido de 15)\n  max: 30, // ✅ AUMENTADO: 30 tentativas/5min (evita bloqueios durante desenvolvimento)\n  message: 'Muitas tentativas de login. Tente novamente em 5 minutos.',\n  skipSuccessfulRequests: true, // Não contar tentativas bem-sucedidas\n});\n\napp.use('/api/auth/login', authLimiter);\napp.use('/api/auth/validate-credentials', authLimiter);\napp.use('/api/auth/verify-code', authLimiter);\n\n// 🛡️ 3. CORS RESTRITO - Apenas domínios autorizados\n// Previne que sites maliciosos façam requests à sua API\n// ✅ CORRIGIDO: CORS SEM WILDCARDS (segurança)\nconst allowedOrigins = IS_PRODUCTION \n  ? [\n      'https://q-zero-afonsomarques80.replit.app',\n      'https://waitless-qzero.com',\n      'https://www.waitless-qzero.com',\n      'https://app.qzero.local',  // ✅ CAPACITOR: Hostname configurado\n      'http://127.0.0.1:3001',\n      'http://localhost:3001',\n      'http://127.0.0.1:5000',\n      'http://localhost:5000'\n    ].filter(Boolean)\n  : [\n      'http://localhost:5000',\n      'http://localhost:5001',\n      'http://localhost:3001',\n      'http://127.0.0.1:5000',\n      'http://127.0.0.1:5001',\n      'http://127.0.0.1:3001',\n      'https://app.qzero.local',  // ✅ CAPACITOR em dev também\n    ];\n\napp.use(cors({\n  origin: (origin, callback) => {\n    // ✅ Permitir requests sem origin (apps móveis Capacitor, Postman, curl)\n    if (!origin) return callback(null, true);\n    \n    const isAllowed = allowedOrigins.includes(origin);\n    const isReplitDomain = origin.includes('.replit.dev') || origin.includes('.replit.app');\n    \n    // ✅ CAPACITOR: Permitir apps móveis (capacitor://, ionic://, file://)\n    const isCapacitorApp = \n      origin.startsWith('capacitor://') ||\n      origin.startsWith('ionic://') ||\n      origin.startsWith('http://localhost') ||\n      origin.startsWith('https://localhost') ||\n      origin === 'null' ||  // Android WebView envia 'null' como origin\n      origin.includes('app.qzero.local');  // Hostname configurado no Capacitor\n    \n    if (isAllowed || isReplitDomain || isCapacitorApp) {\n      callback(null, true);\n    } else {\n      safeLog(`⚠️ CORS BLOCKED:`, { origin, allowed: allowedOrigins });\n      callback(new Error('Not allowed by CORS'));\n    }\n  },\n  credentials: true,\n  methods: ['GET', 'POST', 'PUT', 'DELETE', 'PATCH', 'OPTIONS'],\n  allowedHeaders: ['Content-Type', 'Authorization', 'X-Requested-With'],\n}));\n\nconsole.log(`🛡️ Segurança ativada:`);\nconsole.log(`  - Helmet: ✅ (Security headers)`);\nconsole.log(`  - Rate Limiting: ✅ (${IS_PRODUCTION ? '100' : '2000'} req/15min)`);\nconsole.log(`  - Translation Rate Limit: ✅ (${process.env.NODE_ENV === 'development' ? '2000' : '500'} req/min - separado, NODE_ENV=${process.env.NODE_ENV})`);\nconsole.log(`  - CORS: ✅ (${allowedOrigins.length} domínios autorizados)`);\n\napp.use(cookieParser());\n\n// ⚠️ CRÍTICO: Webhook Stripe ANTES do express.json()\n// Stripe precisa do raw body para verificar assinatura\napp.post('/api/stripe-webhook', express.raw({ type: 'application/json' }), async (req, res) => {\n  const sig = req.headers['stripe-signature'];\n  let event;\n\n  try {\n    if (!process.env.STRIPE_WEBHOOK_SECRET) {\n      console.error('❌ STRIPE_WEBHOOK_SECRET não configurado!');\n      return res.status(500).send('Webhook secret not configured');\n    }\n\n    event = stripe.webhooks.constructEvent(\n      req.body,\n      sig,\n      process.env.STRIPE_WEBHOOK_SECRET\n    );\n  } catch (err) {\n    console.error('❌ Webhook signature verification failed:', err.message);\n    return res.status(400).send(`Webhook Error: ${err.message}`);\n  }\n\n  console.log('🎯 Received Stripe webhook event:', event.type);\n\n  try {\n    switch (event.type) {\n      case 'checkout.session.completed': {\n        const session = event.data.object;\n        const companyProfileId = session.client_reference_id || session.metadata.companyProfileId;\n        \n        if (companyProfileId) {\n          let subscriptionStatus = 'active';\n          let isTrialing = false;\n          let trialStart = null;\n          let trialEnd = null;\n          \n          if (session.subscription) {\n            try {\n              const subscription = await stripe.subscriptions.retrieve(session.subscription);\n              subscriptionStatus = subscription.status;\n              isTrialing = subscription.status === 'trialing';\n              \n              // 🎁 TRIAL: Guardar datas de início e fim do período gratuito\n              if (subscription.trial_start && subscription.trial_end) {\n                trialStart = new Date(subscription.trial_start * 1000); // Stripe usa Unix timestamp\n                trialEnd = new Date(subscription.trial_end * 1000);\n                console.log(`🎁 Trial detected: ${trialStart.toISOString()} → ${trialEnd.toISOString()}`);\n              }\n            } catch (subError) {\n              console.warn('⚠️ Could not retrieve subscription:', subError.message);\n            }\n          }\n          \n          // ✅ CRÍTICO: Status deve ser PENDING_PAYMENT durante trial, só ACTIVE após pagamento\n          const profileStatus = isTrialing ? SUBSCRIPTION_STATUS.PENDING_PAYMENT : SUBSCRIPTION_STATUS.ACTIVE;\n          \n          const updateData = {\n            status: profileStatus,\n            stripeCustomerId: session.customer,\n            subscriptionId: session.subscription,\n            subscriptionStatus: subscriptionStatus,\n            updatedAt: new Date()\n          };\n          \n          // Adicionar datas de trial se existirem\n          if (trialStart) updateData.trialStart = trialStart;\n          if (trialEnd) updateData.trialEnd = trialEnd;\n          \n          await db.update(companyProfiles)\n            .set(updateData)\n            .where(eq(companyProfiles.id, companyProfileId));\n          \n          const statusMessage = isTrialing\n            ? `✅ Webhook: Company profile ${companyProfileId} entered 7-day trial (status: pending_payment)`\n            : `✅ Webhook: Company profile ${companyProfileId} activated after payment (status: active)`;\n          console.log(statusMessage);\n        }\n        break;\n      }\n\n      case 'invoice.payment_succeeded': {\n        const invoice = event.data.object;\n        const subscriptionId = invoice.subscription;\n        \n        if (subscriptionId) {\n          // ✅ PRIMEIRO PAGAMENTO BEM-SUCEDIDO → Ativar perfil!\n          // Isto acontece quando trial expira E o pagamento é processado com sucesso\n          await db.update(companyProfiles)\n            .set({\n              status: SUBSCRIPTION_STATUS.ACTIVE, // ✅ Perfil agora está ATIVO\n              subscriptionStatus: 'active',\n              updatedAt: new Date()\n            })\n            .where(eq(companyProfiles.subscriptionId, subscriptionId));\n          \n          console.log(`✅ Webhook: Payment succeeded for subscription ${subscriptionId} - Profile activated`);\n        }\n        break;\n      }\n\n      case 'invoice.payment_failed': {\n        const failedInvoice = event.data.object;\n        const failedSubscriptionId = failedInvoice.subscription;\n        \n        if (failedSubscriptionId) {\n          // ⚠️ PAGAMENTO FALHOU → Apenas atualizar subscription_status\n          // NÃO revogar acesso imediatamente (Stripe faz retries automáticos)\n          // Acesso só é revogado quando subscription.updated → past_due/canceled\n          await db.update(companyProfiles)\n            .set({\n              subscriptionStatus: 'past_due',\n              updatedAt: new Date()\n            })\n            .where(eq(companyProfiles.subscriptionId, failedSubscriptionId));\n          \n          console.log(`⚠️ Webhook: Payment failed for subscription ${failedSubscriptionId} - Marked past_due (Stripe will retry)`);\n        }\n        break;\n      }\n\n      case 'customer.subscription.updated': {\n        const updatedSubscription = event.data.object;\n        \n        // 🔍 PRIMEIRO: Verificar estado atual na DB antes de atualizar\n        const currentProfile = await db.query.companyProfiles.findFirst({\n          where: eq(companyProfiles.subscriptionId, updatedSubscription.id)\n        });\n        \n        // ⚠️ Se já está cancelado na DB, NÃO reverter para trialing/active\n        const isAlreadyCancelledInDB = currentProfile && \n          (currentProfile.subscriptionStatus === 'cancelled' || currentProfile.subscriptionStatus === 'canceled');\n        \n        // 🔍 Verificar se a subscrição está marcada para cancelar no fim do período\n        const isCancelledButActive = updatedSubscription.cancel_at_period_end === true;\n        \n        console.log(`🔍 Webhook subscription.updated: DB status=${currentProfile?.subscriptionStatus}, Stripe cancel_at_period_end=${isCancelledButActive}, Stripe status=${updatedSubscription.status}`);\n        \n        // ✅ Se já está cancelado na DB OU no Stripe, manter como cancelado\n        if (isAlreadyCancelledInDB || isCancelledButActive) {\n          const updateData = {\n            status: SUBSCRIPTION_STATUS.ACTIVE, // Manter acesso até fim do período\n            subscriptionStatus: 'cancelled',\n            updatedAt: new Date()\n          };\n          \n          // Atualizar a data de fim do período\n          if (updatedSubscription.current_period_end) {\n            updateData.currentPeriodEnd = new Date(updatedSubscription.current_period_end * 1000);\n          }\n          \n          await db.update(companyProfiles)\n            .set(updateData)\n            .where(eq(companyProfiles.subscriptionId, updatedSubscription.id));\n          \n          console.log(`⏰ Webhook: Subscription ${updatedSubscription.id} - MANTENDO ESTADO CANCELADO (acesso até ${updateData.currentPeriodEnd})`);\n          break;\n        }\n        \n        // ✅ Só atualiza para outros estados se NÃO estiver cancelado\n        const updateData = {\n          subscriptionStatus: updatedSubscription.status,\n          updatedAt: new Date()\n        };\n        \n        if (updatedSubscription.status === 'active') {\n          updateData.status = SUBSCRIPTION_STATUS.ACTIVE;\n        } else if (updatedSubscription.status === 'trialing') {\n          updateData.status = SUBSCRIPTION_STATUS.PENDING_PAYMENT;\n        } else if (updatedSubscription.status === 'past_due') {\n          updateData.status = SUBSCRIPTION_STATUS.PENDING_PAYMENT;\n        } else if (updatedSubscription.status === 'canceled' || updatedSubscription.status === 'unpaid') {\n          updateData.status = SUBSCRIPTION_STATUS.CANCELLED;\n        }\n        \n        // 🎁 Atualizar datas de trial se mudaram\n        if (updatedSubscription.trial_start && updatedSubscription.trial_end) {\n          updateData.trialStart = new Date(updatedSubscription.trial_start * 1000);\n          updateData.trialEnd = new Date(updatedSubscription.trial_end * 1000);\n        }\n        \n        await db.update(companyProfiles)\n          .set(updateData)\n          .where(eq(companyProfiles.subscriptionId, updatedSubscription.id));\n        \n        console.log(`✅ Webhook: Subscription ${updatedSubscription.id} updated to ${updatedSubscription.status} (profile status: ${updateData.status})`);\n        break;\n      }\n\n      case 'customer.subscription.deleted': {\n        const deletedSubscription = event.data.object;\n        \n        await db.update(companyProfiles)\n          .set({\n            status: SUBSCRIPTION_STATUS.CANCELLED,\n            subscriptionStatus: 'canceled',\n            updatedAt: new Date()\n          })\n          .where(eq(companyProfiles.subscriptionId, deletedSubscription.id));\n        \n        console.log(`⚠️ Webhook: Subscription ${deletedSubscription.id} cancelled`);\n        break;\n      }\n\n      default:\n        console.log(`ℹ️ Webhook: Unhandled event type: ${event.type}`);\n    }\n  } catch (error) {\n    console.error('❌ Webhook processing error:', error);\n    // Ainda retorna 200 para Stripe não reenviar\n  }\n\n  res.json({ received: true });\n});\n\n// AGORA aplicar express.json() para outras rotas\napp.use(express.json());\n\n// 🛡️ SANITIZAÇÃO GLOBAL - Remove NoSQL injection, XSS\n// ✅ Sanitizer customizado compatível com Express 5 (substitui express-mongo-sanitize)\n// Remove caracteres perigosos ($, .) que podem causar NoSQL injection\nfunction sanitizeObject(obj) {\n  if (!obj || typeof obj !== 'object') return;\n  \n  // Recursivamente sanitizar todos os valores do objeto\n  Object.keys(obj).forEach(key => {\n    // Remover chaves que começam com $ ou contêm .\n    if (key.startsWith('$') || key.includes('.')) {\n      delete obj[key];\n    } else if (typeof obj[key] === 'object' && obj[key] !== null) {\n      // Recursivamente sanitizar objetos aninhados\n      if (Array.isArray(obj[key])) {\n        obj[key].forEach(item => sanitizeObject(item));\n      } else {\n        sanitizeObject(obj[key]);\n      }\n    }\n  });\n}\n\n// Middleware que aplica sanitização em req.body, req.params, req.query\napp.use((req, res, next) => {\n  sanitizeObject(req.body);\n  sanitizeObject(req.params);\n  sanitizeObject(req.query);\n  next();\n});\n\napp.use(sanitizeMiddleware); // Remove tags HTML perigosas\n\n// Servir ficheiros de upload estaticamente com headers CORS para Capacitor\napp.use('/uploads', (req, res, next) => {\n  // ✅ CAPACITOR FIX: Adicionar headers CORS para apps móveis\n  res.setHeader('Access-Control-Allow-Origin', '*');\n  res.setHeader('Access-Control-Allow-Methods', 'GET, OPTIONS');\n  res.setHeader('Access-Control-Allow-Headers', 'Content-Type');\n  res.setHeader('Cross-Origin-Resource-Policy', 'cross-origin');\n  // ✅ Cache control para imagens (1 hora)\n  res.setHeader('Cache-Control', 'public, max-age=3600');\n  next();\n}, express.static(UPLOADS_DIR));\n\nconst PRICE_EUR_49_99_MONTHLY = '49.99';\n\n// 🔒 CRÍTICO: JWT_SECRET é obrigatório (sem fallback inseguro!)\nconst JWT_SECRET = process.env.JWT_SECRET;\nif (!JWT_SECRET) {\n  console.error('❌ ERRO FATAL: JWT_SECRET não está configurada!');\n  console.error('🔧 Configure via: Tools → Secrets → JWT_SECRET');\n  console.error('🔑 Gere uma secret forte: node -e \"console.log(require(\\'crypto\\').randomBytes(64).toString(\\'hex\\'))\"');\n  process.exit(1);\n}\n\n// ================== AUTHENTICATION MIDDLEWARE ==================\n\nconst authenticateToken = (req, res, next) => {\n  const cookieToken = req.cookies.auth_token;\n  const authHeader = req.headers['authorization'];\n  const bearerToken = authHeader?.replace('Bearer ', '');\n  const token = cookieToken || bearerToken;\n  \n  // 🔍 DEBUG: Log detalhado para Safari iOS debugging\n  if (!IS_PRODUCTION) {\n    console.log('🔍 authenticateToken - Cookie token:', !!cookieToken);\n    console.log('🔍 authenticateToken - Bearer token:', !!bearerToken);\n    console.log('🔍 authenticateToken - Token final encontrado:', !!token);\n    console.log('🔍 authenticateToken - Auth header presente:', !!authHeader);\n    console.log('🔍 authenticateToken - Cookies disponíveis:', Object.keys(req.cookies || {}));\n  }\n  \n  if (!token) {\n    logSecurityEvent('auth_missing_token', { ip: req.ip, path: req.path });\n    return res.status(401).json({ error: 'Não autenticado' });\n  }\n\n  try {\n    const decoded = jwt.verify(token, JWT_SECRET);\n    req.user = decoded;\n    \n    // 🔒 PRODUÇÃO: NÃO logar email ou dados do utilizador\n    if (!IS_PRODUCTION) {\n      console.log('✅ Token válido para:', decoded.email);\n    } else {\n      // logAuthSuccess espera (req, userId, email) mas decoded não tem req\n      logger.info('AUTH_SUCCESS', {\n        event: 'TOKEN_VALIDATED',\n        userId: decoded.userId,\n        email: decoded.email,\n        ip: req.ip,\n        timestamp: new Date().toISOString()\n      });\n    }\n    \n    next();\n  } catch (error) {\n    logAuthFailure(req, `Token inválido: ${error.message}`);\n    return res.status(403).json({ error: 'Token inválido' });\n  }\n};\n\n// ================== MIDDLEWARE: BLOQUEIO DE SUBSCRIÇÃO EXPIRADA ==================\n// 🚫 Este middleware bloqueia IMEDIATAMENTE o acesso a funcionalidades empresariais\n// para contas com subscrição expirada - funciona mesmo em apps móveis antigas\n\nconst requireActiveSubscription = async (req, res, next) => {\n  try {\n    const userId = req.user?.userId;\n    if (!userId) {\n      return res.status(401).json({ error: 'Não autenticado' });\n    }\n\n    const user = await db.query.users.findFirst({\n      where: eq(users.id, userId)\n    });\n\n    if (!user || user.accountType !== 'empresa') {\n      return next(); // Contas pessoais podem passar\n    }\n\n    if (!user.businessId) {\n      return res.status(403).json({ \n        error: 'Subscrição necessária',\n        subscription_required: true,\n        is_expired: true\n      });\n    }\n\n    const profile = await db.query.companyProfiles.findFirst({\n      where: eq(companyProfiles.id, user.businessId)\n    });\n\n    if (!profile) {\n      return res.status(403).json({ \n        error: 'Perfil empresarial não encontrado',\n        subscription_required: true\n      });\n    }\n\n    // 🚫 VERIFICAR EXPIRAÇÃO\n    const now = new Date();\n    const periodEnd = profile.currentPeriodEnd ? new Date(profile.currentPeriodEnd) : null;\n    const isExpired = profile.subscriptionStatus === 'expired' || \n                      profile.status === 'expired' ||\n                      (periodEnd && now > periodEnd);\n\n    console.log('🔍 requireActiveSubscription:', {\n      email: user.email,\n      status: profile.status,\n      subscriptionStatus: profile.subscriptionStatus,\n      isExpired: isExpired\n    });\n\n    if (isExpired) {\n      console.log('🚫 ACESSO BLOQUEADO - Subscrição expirada:', user.email);\n      return res.status(403).json({ \n        error: 'A sua subscrição expirou. Por favor, renove para continuar a usar as funcionalidades empresariais.',\n        subscription_expired: true,\n        is_expired: true,\n        subscription_status: profile.subscriptionStatus,\n        current_period_end: profile.currentPeriodEnd\n      });\n    }\n\n    // ✅ Subscrição ativa - permitir acesso\n    next();\n  } catch (error) {\n    console.error('❌ Erro no requireActiveSubscription:', error);\n    return res.status(500).json({ error: 'Erro ao verificar subscrição' });\n  }\n};\n\n// ================== AUTHENTICATION ENDPOINTS ==================\n\n// POST /api/consent - Log user consent to Privacy Policy and Terms & Conditions\n// Rate limited to prevent spam\nconst consentLimiter = rateLimit({\n  windowMs: 1 * 60 * 1000, // 1 minute\n  max: IS_PRODUCTION ? 10 : 50, // Production: 10/min, Dev: 50/min\n  message: 'Too many consent requests. Please try again later.',\n  standardHeaders: true,\n  legacyHeaders: false,\n});\n\napp.post('/api/consent', consentLimiter, async (req, res) => {\n  try {\n    const { guestId, userId, consent, version, userAgent, locale, source } = req.body;\n\n    // Validate required fields\n    if (!guestId || consent === undefined || !version || !source) {\n      return res.status(400).json({ ok: false, error: 'Missing required fields' });\n    }\n\n    // Validate consent value\n    if (typeof consent !== 'boolean') {\n      return res.status(400).json({ ok: false, error: 'Consent must be boolean' });\n    }\n\n    // Capture IP address\n    const ip = req.headers['x-forwarded-for'] || req.socket.remoteAddress || 'unknown';\n\n    // Generate unique ID for consent record\n    const consentId = `consent_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;\n\n    // Store consent in database\n    await db.insert(consents).values({\n      id: consentId,\n      guestId: guestId,\n      userId: userId || null,\n      consent: consent,\n      version: version,\n      userAgent: userAgent || null,\n      locale: locale || null,\n      ip: ip,\n      source: source,\n    });\n\n    console.log(`✅ Consent logged: ${consentId} (guest: ${guestId}, version: ${version})`);\n\n    res.json({ ok: true });\n  } catch (error) {\n    console.error('❌ Consent logging error:', error);\n    // Never expose stack trace to client\n    res.status(500).json({ ok: false });\n  }\n});\n\n// POST /api/auth/register - Registo de novo utilizador\n// ✅ VALIDAÇÃO E SANITIZAÇÃO APLICADAS\napp.post('/api/auth/register', validateRegister, handleValidationErrors, async (req, res) => {\n  try {\n    const { email, password, fullName, phone, birthdate, accountType } = req.body;\n\n    const existingUser = await db.query.users.findFirst({\n      where: eq(users.email, email.toLowerCase())\n    });\n\n    if (existingUser) {\n      return res.status(400).json({ error: 'Email já está registado' });\n    }\n\n    const passwordHash = await bcrypt.hash(password, 10);\n    const userId = `user${Date.now()}${Math.floor(Math.random() * 1000)}`;\n\n    const [newUser] = await db.insert(users).values({\n      id: userId,\n      email: email.toLowerCase(),\n      passwordHash,\n      fullName: fullName || '',\n      phone: phone || '',\n      birthdate: birthdate || '',\n      accountType,\n      isBusinessUser: accountType === 'empresa',\n      isStaffMember: false,\n    }).returning();\n\n    // ✅ Gerar JWT com TODOS os role flags (igual ao login 2FA)\n    const token = jwt.sign(\n      { \n        userId: newUser.id, \n        email: newUser.email,\n        isBusinessUser: newUser.isBusinessUser,\n        isStaffMember: newUser.isStaffMember,\n        businessId: newUser.businessId || null,\n        staffPermissions: newUser.staffPermissions || null,\n        accountType: newUser.accountType\n      },\n      JWT_SECRET,\n      { expiresIn: '7d' }\n    );\n\n    res.cookie('auth_token', token, COOKIE_OPTIONS);\n\n    // 🔒 PRODUÇÃO: NÃO logar email do utilizador\n    if (!IS_PRODUCTION) {\n      console.log('✅ Novo utilizador registado:', email);\n    } else {\n      logAuthSuccess(req, newUser.id, email);\n    }\n\n    res.json({\n      success: true,\n      user: {\n        id: newUser.id,\n        email: newUser.email,\n        fullName: newUser.fullName,\n        phone: newUser.phone,\n        birthdate: newUser.birthdate,\n        accountType: newUser.accountType,\n        isBusinessUser: newUser.isBusinessUser,\n        isStaffMember: newUser.isStaffMember,\n        businessId: newUser.businessId || null,\n        staffPermissions: newUser.staffPermissions || null,\n      },\n      token\n    });\n  } catch (error) {\n    console.error('❌ Erro no registo:', error);\n    res.status(500).json({ error: 'Erro ao criar conta' });\n  }\n});\n\n// POST /api/auth/login - DEPRECADO: Agora exige 2FA\n// Este endpoint foi desabilitado por segurança. Use o fluxo 2FA:\n// 1. POST /api/auth/validate-credentials\n// 2. POST /api/auth/send-verification-code  \n// 3. POST /api/auth/verify-code\napp.post('/api/auth/login', async (req, res) => {\n  return res.status(403).json({ \n    error: 'Este endpoint foi desabilitado. Por favor, utilize o fluxo de autenticação 2FA através da página de login.',\n    requires_2fa: true \n  });\n});\n\n// GET /api/auth/me - Verificar autenticação\napp.get('/api/auth/me', authenticateToken, async (req, res) => {\n  try {\n    console.log('🔍 /api/auth/me - Iniciando busca para userId:', req.user?.userId);\n    \n    const user = await db.query.users.findFirst({\n      where: eq(users.id, req.user.userId)\n    });\n\n    console.log('🔍 /api/auth/me - Utilizador encontrado:', !!user);\n\n    if (!user) {\n      console.warn('⚠️ Utilizador não encontrado (JWT com userId antigo):', req.user.userId);\n      console.warn('🔄 Limpando cookie inválido e forçando re-login...');\n      \n      // 🔒 LIMPAR cookie inválido de forma AGRESSIVA (Safari iOS workaround)\n      aggressiveClearCookie(res, 'auth_token');\n      \n      return res.status(401).json({ \n        error: 'Not authenticated',\n        reason: 'user_not_found',\n        message: 'Sessão inválida. Por favor, faça login novamente.'\n      });\n    }\n\n    // ✅ CALCULAR has_business_subscription DINAMICAMENTE de company_profiles\n    let hasBusinessSubscription = false;\n    let subscriptionInfo = null;\n    \n    if (user.accountType === 'empresa' && user.businessId) {\n      try {\n        const profile = await db.query.companyProfiles.findFirst({\n          where: eq(companyProfiles.id, user.businessId)\n        });\n        \n        // ✅ TRIAL CONTA COMO ACESSO ATIVO!\n        // User tem acesso completo durante trial E após pagamento\n        // ✅ SUBSCRIÇÕES CANCELADAS mantêm acesso até currentPeriodEnd\n        const now = new Date();\n        const hasCanceledAccess = (profile.subscriptionStatus === 'canceled' || profile.subscriptionStatus === 'cancelled') && \n                                   profile.currentPeriodEnd && \n                                   new Date(profile.currentPeriodEnd) > now;\n        \n        // ❌ EXPIRADO: Verificar se a subscrição expirou\n        const isExpired = profile.subscriptionStatus === 'expired' || \n                          (profile.currentPeriodEnd && new Date(profile.currentPeriodEnd) < now);\n        \n        console.log('🔍 Verificação de acesso empresarial:', {\n          email: user.email,\n          status: profile.status,\n          subscriptionStatus: profile.subscriptionStatus,\n          currentPeriodEnd: profile.currentPeriodEnd,\n          isExpired: isExpired,\n          hasCanceledAccess: hasCanceledAccess\n        });\n        \n        if (profile && !isExpired && (profile.status === 'active' || \n                        profile.subscriptionStatus === 'trialing' ||\n                        hasCanceledAccess)) {\n          hasBusinessSubscription = true;\n          \n          // ✅ SYNC: Atualizar DB se estiver desatualizado (evita queries futuras)\n          if (user.hasBusinessSubscription !== hasBusinessSubscription) {\n            await db.update(users)\n              .set({ hasBusinessSubscription: true })\n              .where(eq(users.id, user.id));\n          }\n        } else if (isExpired && user.hasBusinessSubscription) {\n          // ❌ SYNC: Remover acesso se expirou\n          console.log('❌ Subscrição expirada - removendo acesso empresarial:', user.email);\n          await db.update(users)\n            .set({ hasBusinessSubscription: false })\n            .where(eq(users.id, user.id));\n        }\n        \n        // ✅ Retornar informação de subscription/trial para o frontend\n        if (profile) {\n          subscriptionInfo = {\n            status: profile.status,\n            subscription_status: profile.subscriptionStatus,\n            trial_start: profile.trialStart,\n            trial_end: profile.trialEnd,\n            current_period_end: profile.currentPeriodEnd,\n            is_expired: isExpired, // 🚫 Flag explícito de expiração\n          };\n        }\n      } catch (err) {\n        console.warn('⚠️ Erro ao verificar perfil empresarial:', err);\n        // Continuar com valor do DB (fallback seguro)\n        hasBusinessSubscription = !!user.hasBusinessSubscription;\n      }\n    }\n\n    console.log('✅ /api/auth/me - Enviando resposta');\n    \n    // ✅ Retornar campos em snake_case (normalização segura de tipos)\n    res.json({\n      id: user.id,\n      email: user.email,\n      full_name: user.fullName || null,\n      phone: user.phone || null,\n      birthdate: user.birthdate || null,\n      country: user.country || null,\n      city: user.city || null,\n      account_type: user.accountType,\n      is_business_user: !!user.isBusinessUser,\n      is_staff_member: !!user.isStaffMember,\n      business_id: user.businessId || null,\n      staff_permissions: user.staffPermissions || null,\n      onboarding_completed: true, // Sempre true (onboarding legacy removido)\n      has_business_subscription: hasBusinessSubscription,\n      subscription_info: subscriptionInfo, // ✅ Informação de trial/subscription\n      created_at: user.createdAt || null\n    });\n  } catch (error) {\n    console.error('❌ ERRO FATAL em /api/auth/me:', {\n      message: error.message,\n      stack: error.stack,\n      userId: req.user?.userId\n    });\n    return res.status(500).json({ error: 'Erro interno do servidor' });\n  }\n});\n\n// PATCH /api/auth/language - Atualizar idioma preferido do utilizador\napp.patch('/api/auth/language', authenticateToken, async (req, res) => {\n  try {\n    const { language } = req.body;\n    \n    if (!language || typeof language !== 'string' || language.length > 10) {\n      return res.status(400).json({ error: 'Idioma inválido' });\n    }\n\n    await db.update(users)\n      .set({ \n        preferredLanguage: language,\n        updatedAt: new Date()\n      })\n      .where(eq(users.id, req.user.userId));\n\n    console.log(`✅ Idioma atualizado para ${language} - userId: ${req.user.userId}`);\n    res.json({ success: true, language });\n  } catch (error) {\n    console.error('❌ Erro ao atualizar idioma:', error);\n    res.status(500).json({ error: 'Erro ao atualizar idioma' });\n  }\n});\n\n// POST /api/auth/logout - Logout\napp.post('/api/auth/logout', async (req, res) => {\n  try {\n    // 🧹 Tentar obter email do utilizador do JWT (se existir)\n    const token = req.cookies.auth_token;\n    let userEmail = null;\n    \n    if (token) {\n      try {\n        const decoded = jwt.verify(token, JWT_SECRET);\n        userEmail = decoded.email;\n      } catch (err) {\n        // JWT inválido/expirado - ok, vamos limpar o cookie na mesma\n        console.log('⚠️ JWT inválido no logout, mas vamos limpar tudo na mesma');\n      }\n    }\n    \n    // 🗑️ Se temos o email, limpar challenge tokens e verification codes\n    if (userEmail) {\n      // Invalidar todos os challenge tokens do utilizador\n      await db.delete(challengeTokens)\n        .where(eq(challengeTokens.email, userEmail.toLowerCase()));\n      \n      // Invalidar todos os verification codes do utilizador\n      await db.delete(verificationCodes)\n        .where(eq(verificationCodes.email, userEmail.toLowerCase()));\n      \n      console.log(`🧹 Challenge tokens e verification codes limpos para ${userEmail}`);\n    }\n    \n    // 🍪 Limpar cookie de autenticação de forma AGRESSIVA (Safari iOS workaround)\n    aggressiveClearCookie(res, 'auth_token');\n    \n    res.json({ success: true, message: 'Logout realizado com sucesso' });\n  } catch (error) {\n    logger.error('Erro no logout:', error);\n    // Mesmo com erro, limpar cookie de forma AGRESSIVA\n    aggressiveClearCookie(res, 'auth_token');\n    res.json({ success: true, message: 'Logout realizado com sucesso' });\n  }\n});\n\n// DELETE /api/auth/delete-account - Eliminar conta do utilizador e TODOS os dados\napp.delete('/api/auth/delete-account', authenticateToken, async (req, res) => {\n  try {\n    const userId = req.user.userId;\n    const userEmail = req.user.email;\n    \n    console.log(`🗑️ ========== ELIMINAÇÃO COMPLETA DE CONTA ==========`);\n    console.log(`🗑️ Utilizador: ${userEmail} (ID: ${userId})`);\n    \n    // 1. Buscar perfil de empresa (se existir) - PRIMEIRO para cancelar Stripe\n    let companyProfile = null;\n    try {\n      const [profile] = await db.select().from(companyProfiles).where(eq(companyProfiles.userId, userId));\n      companyProfile = profile;\n      \n      // Também verificar por adminUserId (campo alternativo)\n      if (!companyProfile) {\n        const [profileByAdmin] = await db.select().from(companyProfiles).where(eq(companyProfiles.adminUserId, userId));\n        companyProfile = profileByAdmin;\n      }\n    } catch (e) {\n      console.log('⚠️ Erro ao buscar perfil de empresa:', e.message);\n    }\n    \n    // 2. CANCELAR SUBSCRIÇÃO STRIPE (se existir)\n    if (companyProfile?.subscriptionId && stripe) {\n      try {\n        await stripe.subscriptions.cancel(companyProfile.subscriptionId);\n        console.log('✅ Subscrição Stripe CANCELADA:', companyProfile.subscriptionId);\n      } catch (stripeError) {\n        console.warn('⚠️ Erro ao cancelar subscrição Stripe:', stripeError.message);\n      }\n    }\n    \n    // 3. Eliminar tokens de dispositivo (push notifications)\n    try {\n      await db.delete(deviceTokens).where(eq(deviceTokens.userId, userId));\n      console.log('✅ Device tokens eliminados');\n    } catch (e) {\n      console.log('⚠️ Erro ao eliminar device tokens:', e.message);\n    }\n    \n    // 4. Eliminar notificações push\n    try {\n      await db.delete(pushNotifications).where(eq(pushNotifications.userId, userId));\n      console.log('✅ Push notifications eliminadas');\n    } catch (e) {\n      console.log('⚠️ Erro ao eliminar push notifications:', e.message);\n    }\n    \n    // 5. Eliminar registos de consentimento (GDPR)\n    try {\n      await db.delete(consents).where(eq(consents.userId, userId));\n      console.log('✅ Consent records eliminados');\n    } catch (e) {\n      console.log('⚠️ Erro ao eliminar consents:', e.message);\n    }\n    \n    // 6. Eliminar challenge tokens\n    try {\n      await db.delete(challengeTokens).where(eq(challengeTokens.email, userEmail.toLowerCase()));\n      console.log('✅ Challenge tokens eliminados');\n    } catch (e) {\n      console.log('⚠️ Erro ao eliminar challenge tokens:', e.message);\n    }\n    \n    // 7. Eliminar verification codes\n    try {\n      await db.delete(verificationCodes).where(eq(verificationCodes.email, userEmail.toLowerCase()));\n      console.log('✅ Verification codes eliminados');\n    } catch (e) {\n      console.log('⚠️ Erro ao eliminar verification codes:', e.message);\n    }\n    \n    // 8. Eliminar password reset tokens\n    try {\n      await db.delete(passwordResetTokens).where(eq(passwordResetTokens.email, userEmail.toLowerCase()));\n      console.log('✅ Password reset tokens eliminados');\n    } catch (e) {\n      console.log('⚠️ Erro ao eliminar password reset tokens:', e.message);\n    }\n    \n    // 9. Se tem empresa, eliminar TODOS os dados relacionados\n    if (companyProfile) {\n      console.log(`🏢 Eliminando empresa: ${companyProfile.companyName} (ID: ${companyProfile.id})`);\n      \n      // Eliminar filas da empresa\n      try {\n        await db.delete(queues).where(eq(queues.businessId, companyProfile.id));\n        console.log('✅ Filas da empresa eliminadas');\n      } catch (e) {\n        console.log('⚠️ Erro ao eliminar filas:', e.message);\n      }\n      \n      // Eliminar TODAS as marcações da empresa\n      try {\n        await db.delete(appointments).where(eq(appointments.businessId, companyProfile.id));\n        console.log('✅ Marcações da empresa eliminadas');\n      } catch (e) {\n        console.log('⚠️ Erro ao eliminar marcações:', e.message);\n      }\n      \n      // Eliminar TODOS os tickets/senhas da empresa\n      try {\n        await db.delete(tickets).where(eq(tickets.businessId, companyProfile.id));\n        console.log('✅ Tickets/senhas da empresa eliminados');\n      } catch (e) {\n        console.log('⚠️ Erro ao eliminar tickets:', e.message);\n      }\n      \n      // Eliminar convites pendentes de staff\n      try {\n        await db.delete(staffInvites).where(eq(staffInvites.businessId, companyProfile.id));\n        console.log('✅ Staff invites eliminados');\n      } catch (e) {\n        console.log('⚠️ Erro ao eliminar staff invites:', e.message);\n      }\n      \n      // Eliminar perfil de empresa\n      await db.delete(companyProfiles).where(eq(companyProfiles.id, companyProfile.id));\n      console.log('✅ Perfil de empresa ELIMINADO');\n    }\n    \n    // 10. Eliminar marcações do utilizador (como cliente)\n    try {\n      await db.delete(appointments).where(eq(appointments.userEmail, userEmail.toLowerCase()));\n      console.log('✅ Marcações do utilizador (como cliente) eliminadas');\n    } catch (e) {\n      console.log('⚠️ Erro ao eliminar marcações do utilizador:', e.message);\n    }\n    \n    // 11. Eliminar tickets do utilizador (como cliente)\n    try {\n      await db.delete(tickets).where(eq(tickets.userEmail, userEmail.toLowerCase()));\n      console.log('✅ Tickets do utilizador (como cliente) eliminados');\n    } catch (e) {\n      console.log('⚠️ Erro ao eliminar tickets do utilizador:', e.message);\n    }\n    \n    // 12. FINALMENTE - Eliminar o utilizador\n    await db.delete(users).where(eq(users.id, userId));\n    console.log('✅ UTILIZADOR ELIMINADO');\n    \n    // 13. Limpar cookie de autenticação\n    aggressiveClearCookie(res, 'auth_token');\n    \n    console.log(`🗑️ ========== CONTA COMPLETAMENTE ELIMINADA ==========`);\n    console.log(`✅ ${userEmail} - Todos os dados removidos permanentemente`);\n    \n    logSecurityEvent(req, userEmail, 'ACCOUNT_DELETED_COMPLETE');\n    \n    res.json({ success: true, message: 'Conta eliminada com sucesso. Todos os dados foram removidos permanentemente.' });\n  } catch (error) {\n    console.error('❌ Erro ao eliminar conta:', error);\n    res.status(500).json({ error: 'Erro ao eliminar conta. Por favor, tente novamente.' });\n  }\n});\n\n// POST /api/auth/clear-session - Limpar sessão de emergência (SEM autenticação)\n// ⚠️ Endpoint público para quando utilizadores ficam presos em loop de cookies inválidos\napp.post('/api/auth/clear-session', (req, res) => {\n  try {\n    console.log('🚨 Clear-session chamado - limpeza forçada de cookies');\n    \n    // 🗑️ Limpar cookie de forma AGRESSIVA\n    aggressiveClearCookie(res, 'auth_token');\n    \n    res.json({ \n      success: true, \n      message: 'Sessão limpa com sucesso. Pode fazer login novamente.' \n    });\n  } catch (error) {\n    logger.error('Erro no clear-session:', error);\n    res.json({ success: true, message: 'Sessão limpa' });\n  }\n});\n\n// POST /api/auth/validate-credentials - Validar credenciais e gerar challenge token\n// ✅ VALIDAÇÃO E SANITIZAÇÃO APLICADAS\napp.post('/api/auth/validate-credentials', validateLogin, handleValidationErrors, async (req, res) => {\n  try {\n    const { email, password } = req.body;\n\n    const user = await db.query.users.findFirst({\n      where: eq(users.email, email.toLowerCase())\n    });\n\n    if (!user) {\n      logAuthFailure(req, 'User not found');\n      return res.status(401).json({ error: 'Email ou palavra-passe incorretos' });\n    }\n\n    const validPassword = await bcrypt.compare(password, user.passwordHash);\n\n    if (!validPassword) {\n      logAuthFailure(req, 'Invalid password');\n      return res.status(401).json({ error: 'Email ou palavra-passe incorretos' });\n    }\n    \n    logAuthSuccess(req, user.id, user.email);\n\n    // Invalidar challenge tokens anteriores do mesmo email\n    await db.update(challengeTokens)\n      .set({ used: true })\n      .where(and(\n        eq(challengeTokens.email, email.toLowerCase()),\n        eq(challengeTokens.used, false)\n      ));\n\n    // Gerar challenge token único e SALVAR NO SERVIDOR (válido por 2 minutos)\n    const token = crypto.randomBytes(32).toString('hex');\n    const expiresAt = new Date(Date.now() + 2 * 60 * 1000);\n\n    await db.insert(challengeTokens).values({\n      id: `challenge_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,\n      email: email.toLowerCase(),\n      token: token,\n      used: false,\n      expiresAt: expiresAt,\n    });\n\n    // 🔒 PRODUÇÃO: NÃO logar email do utilizador\n    if (!IS_PRODUCTION) {\n      console.log('✅ Credenciais validadas, challenge token armazenado no servidor:', email);\n    }\n\n    res.json({\n      success: true,\n      message: 'Credenciais válidas',\n      challengeToken: token\n    });\n  } catch (error) {\n    console.error('❌ Erro ao validar credenciais:', error);\n    res.status(500).json({ error: 'Erro ao validar credenciais' });\n  }\n});\n\n// POST /api/auth/send-verification-code - Enviar código vinculado a challenge token\n// ✅ VALIDAÇÃO APLICADA\napp.post('/api/auth/send-verification-code', validateEmail, handleValidationErrors, async (req, res) => {\n  try {\n    const { email, challengeToken } = req.body;\n\n    if (!challengeToken) {\n      return res.status(400).json({ error: 'Challenge token é obrigatório' });\n    }\n\n    // VALIDAR que o challenge token existe no servidor e não está expirado\n    // ✅ PERMITE REENVIOS: Removido verificação de \"used\" para permitir múltiplos reenvios\n    const now = new Date();\n    const storedChallenge = await db.query.challengeTokens.findFirst({\n      where: and(\n        eq(challengeTokens.email, email.toLowerCase()),\n        eq(challengeTokens.token, challengeToken),\n        gt(challengeTokens.expiresAt, now)\n      )\n    });\n\n    if (!storedChallenge) {\n      return res.status(401).json({ error: 'Challenge token inválido ou expirado. Por favor, faça login novamente.' });\n    }\n\n    // Verificar se o utilizador existe\n    const user = await db.query.users.findFirst({\n      where: eq(users.email, email.toLowerCase())\n    });\n\n    if (!user) {\n      return res.status(404).json({ error: 'Utilizador não encontrado' });\n    }\n\n    // Invalidar códigos anteriores do mesmo email\n    await db.update(verificationCodes)\n      .set({ verified: true }) // Marca como verificado para invalidar\n      .where(and(\n        eq(verificationCodes.email, email.toLowerCase()),\n        eq(verificationCodes.verified, false)\n      ));\n\n    // 🎯 CONTAS DEMO/REVIEW: Usar código fixo \"000000\" para contas de teste (Apple/Google review)\n    // Inclui contas @qzero.app e conta específica de revisão da Apple\n    const APPLE_REVIEW_ACCOUNTS = ['teste2125b@gmail.com'];\n    const isDemoAccount = email.toLowerCase().endsWith('@qzero.app') || \n                          APPLE_REVIEW_ACCOUNTS.includes(email.toLowerCase());\n    const code = isDemoAccount ? '000000' : Math.floor(100000 + Math.random() * 900000).toString();\n    \n    // Expirar em 10 minutos (demo accounts: 24 horas para facilitar testes)\n    const expiresAt = new Date(Date.now() + (isDemoAccount ? 24 * 60 : 10) * 60 * 1000);\n\n    // Salvar código VINCULADO ao challenge token\n    await db.insert(verificationCodes).values({\n      id: `code_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,\n      email: email.toLowerCase(),\n      code: code,\n      challengeToken: challengeToken,\n      expiresAt: expiresAt,\n      verified: false,\n    });\n\n    // 🎯 CONTAS DEMO: Não enviar email - código fixo é \"000000\"\n    if (isDemoAccount) {\n      console.log('🎯 Demo account detected - using fixed code 000000:', email);\n      return res.json({\n        success: true,\n        message: 'Código de verificação: 000000',\n        isDemoAccount: true\n      });\n    }\n\n    // Enviar código por email (apenas para contas normais)\n    const hostname = process.env.REPLIT_CONNECTORS_HOSTNAME;\n    const xReplitToken = process.env.REPL_IDENTITY \n      ? 'repl ' + process.env.REPL_IDENTITY \n      : process.env.WEB_REPL_RENEWAL \n      ? 'depl ' + process.env.WEB_REPL_RENEWAL \n      : null;\n\n    if (hostname && xReplitToken) {\n      const connectionSettings = await fetch(\n        'https://' + hostname + '/api/v2/connection?include_secrets=true&connector_names=resend',\n        {\n          headers: {\n            'Accept': 'application/json',\n            'X_REPLIT_TOKEN': xReplitToken\n          }\n        }\n      ).then(res => res.json()).then(data => data.items?.[0]);\n\n      if (connectionSettings && connectionSettings.settings.api_key) {\n        const resend = new Resend(connectionSettings.settings.api_key);\n        const fromEmail = 'QZero <noreply@waitless-qzero.com>';\n\n        // Traduzir email para o idioma preferido do utilizador\n        const userLang = user.preferredLanguage || 'pt';\n        const emailSubject = await translateText('Código de Verificação - QZero', userLang, 'pt');\n        const emailBody = await translateText(\n          `Olá ${user.fullName || 'Utilizador'},\\n\\nO seu código de verificação é: ${code}\\n\\nEste código expira em 10 minutos.\\n\\nSe não solicitou este código, ignore este email.\\n\\nQZero - Sistema de Gestão de Filas`,\n          userLang,\n          'pt'\n        );\n\n        await resend.emails.send({\n          from: fromEmail,\n          to: [email],\n          subject: emailSubject,\n          text: emailBody,\n        });\n      }\n    }\n\n    // 🔒 PRODUÇÃO: NÃO logar email do utilizador\n    if (!IS_PRODUCTION) {\n      console.log('✅ Código de verificação enviado para:', email);\n    }\n\n    res.json({\n      success: true,\n      message: 'Código de verificação enviado para o seu email'\n    });\n  } catch (error) {\n    console.error('❌ Erro ao enviar código de verificação:', error);\n    res.status(500).json({ error: 'Erro ao enviar código de verificação' });\n  }\n});\n\n// POST /api/auth/verify-code - Verificar código + challenge token e fazer login\n// ✅ VALIDAÇÃO APLICADA\napp.post('/api/auth/verify-code', validateVerificationCode, handleValidationErrors, async (req, res) => {\n  try {\n    const { email, code, challengeToken } = req.body;\n\n    if (!email) {\n      return res.status(400).json({ error: 'Email é obrigatório' });\n    }\n\n    // PRIMEIRO: Validar que o challenge token existe no servidor e não está usado\n    const now = new Date();\n    const storedChallenge = await db.query.challengeTokens.findFirst({\n      where: and(\n        eq(challengeTokens.email, email.toLowerCase()),\n        eq(challengeTokens.token, challengeToken),\n        eq(challengeTokens.used, false),\n        gt(challengeTokens.expiresAt, now)\n      )\n    });\n\n    if (!storedChallenge) {\n      return res.status(401).json({ error: 'Sessão inválida ou expirada. Por favor, faça login novamente.' });\n    }\n\n    // SEGUNDO: Buscar código válido vinculado ao challenge token\n    const verificationCode = await db.query.verificationCodes.findFirst({\n      where: and(\n        eq(verificationCodes.email, email.toLowerCase()),\n        eq(verificationCodes.code, code),\n        eq(verificationCodes.challengeToken, challengeToken),\n        eq(verificationCodes.verified, false),\n        gt(verificationCodes.expiresAt, now)\n      ),\n      orderBy: [desc(verificationCodes.createdAt)]\n    });\n\n    if (!verificationCode) {\n      return res.status(401).json({ error: 'Código inválido ou expirado' });\n    }\n\n    // Marcar código como verificado\n    await db.update(verificationCodes)\n      .set({ verified: true })\n      .where(eq(verificationCodes.id, verificationCode.id));\n\n    // Marcar challenge token como usado (previne reutilização)\n    await db.update(challengeTokens)\n      .set({ used: true })\n      .where(eq(challengeTokens.id, storedChallenge.id));\n\n    // 🔄 CRÍTICO: RE-BUSCAR utilizador IMEDIATAMENTE ANTES de criar JWT\n    // Isto garante que o user ainda existe (evita JWTs com userId fantasma)\n    const user = await db.query.users.findFirst({\n      where: eq(users.email, email.toLowerCase())\n    });\n\n    if (!user) {\n      console.error('❌ CRÍTICO: User foi apagado entre validação e JWT!', email);\n      return res.status(404).json({ error: 'Utilizador não encontrado' });\n    }\n\n    // ✅ Gerar token JWT APENAS DEPOIS de confirmar que user existe\n    // Token terá TODOS os role flags (necessário para staff members)\n    const token = jwt.sign(\n      { \n        userId: user.id, \n        email: user.email,\n        isBusinessUser: user.isBusinessUser,\n        isStaffMember: user.isStaffMember,\n        businessId: user.businessId,\n        staffPermissions: user.staffPermissions,\n        accountType: user.accountType\n      },\n      JWT_SECRET,\n      { expiresIn: '7d' }\n    );\n\n    // Definir cookie com role flags completos\n    res.cookie('auth_token', token, COOKIE_OPTIONS);\n    \n    console.log('🍪 Cookie auth_token criado para:', user.email);\n    console.log('🍪 Cookie options:', {\n      httpOnly: COOKIE_OPTIONS.httpOnly,\n      secure: COOKIE_OPTIONS.secure,\n      domain: COOKIE_OPTIONS.domain || 'padrão',\n      path: COOKIE_OPTIONS.path,\n      maxAge: '7 dias'\n    });\n\n    // 🔒 PRODUÇÃO: NÃO logar email do utilizador\n    if (!IS_PRODUCTION) {\n      console.log('✅ Login 2FA bem-sucedido com role flags:', email);\n    } else {\n      logAuthSuccess(req, user.id, email);\n    }\n\n    res.json({\n      success: true,\n      user: {\n        id: user.id,\n        email: user.email,\n        fullName: user.fullName,\n        phone: user.phone,\n        birthdate: user.birthdate,\n        accountType: user.accountType,\n        isBusinessUser: user.isBusinessUser,\n        isStaffMember: user.isStaffMember,\n        businessId: user.businessId,\n        staffPermissions: user.staffPermissions,\n      },\n      token\n    });\n  } catch (error) {\n    console.error('❌ Erro ao verificar código:', error);\n    res.status(500).json({ error: 'Erro ao verificar código' });\n  }\n});\n\n// PUT /api/auth/update-profile - Atualizar perfil do utilizador\n// ✅ AUTENTICAÇÃO OBRIGATÓRIA (não precisa de validateEmail - email vem do JWT)\napp.put('/api/auth/update-profile', authenticateToken, async (req, res) => {\n  try {\n    const { fullName, phone, birthdate, country, city, isBusinessUser, businessId, staffPermissions, isStaffMember, accountType } = req.body;\n    \n    const updateData = {};\n    if (fullName !== undefined) updateData.fullName = fullName;\n    if (phone !== undefined) updateData.phone = phone;\n    if (birthdate !== undefined) updateData.birthdate = birthdate;\n    if (country !== undefined) updateData.country = country;\n    if (city !== undefined) updateData.city = city;\n    if (isBusinessUser !== undefined) updateData.isBusinessUser = isBusinessUser;\n    if (businessId !== undefined) updateData.businessId = businessId;\n    if (staffPermissions !== undefined) updateData.staffPermissions = staffPermissions;\n    if (isStaffMember !== undefined) updateData.isStaffMember = isStaffMember;\n    if (accountType !== undefined) updateData.accountType = accountType;\n    \n    updateData.updatedAt = new Date();\n\n    const [updatedUser] = await db.update(users)\n      .set(updateData)\n      .where(eq(users.id, req.user.userId))\n      .returning();\n\n    console.log('✅ Perfil atualizado:', updatedUser.email);\n\n    // CRÍTICO: Emitir novo JWT com TODOS os dados atualizados (incluindo role flags)\n    // para evitar 401 em /me após staff invite\n    const token = jwt.sign(\n      { \n        userId: updatedUser.id, \n        email: updatedUser.email,\n        isBusinessUser: updatedUser.isBusinessUser,\n        isStaffMember: updatedUser.isStaffMember,\n        businessId: updatedUser.businessId,\n        staffPermissions: updatedUser.staffPermissions,\n        accountType: updatedUser.accountType\n      },\n      JWT_SECRET,\n      { expiresIn: '7d' }\n    );\n\n    // Atualizar cookie com novo token contendo role flags\n    res.cookie('auth_token', token, COOKIE_OPTIONS);\n\n    console.log('🔄 Novo JWT emitido com role flags após atualização de perfil');\n\n    res.json({\n      success: true,\n      user: {\n        id: updatedUser.id,\n        email: updatedUser.email,\n        fullName: updatedUser.fullName,\n        phone: updatedUser.phone,\n        birthdate: updatedUser.birthdate,\n        country: updatedUser.country,\n        city: updatedUser.city,\n        accountType: updatedUser.accountType,\n        isBusinessUser: updatedUser.isBusinessUser,\n        isStaffMember: updatedUser.isStaffMember,\n        businessId: updatedUser.businessId,\n        staffPermissions: updatedUser.staffPermissions,\n      },\n      token\n    });\n  } catch (error) {\n    console.error('❌ Erro ao atualizar perfil:', error);\n    res.status(500).json({ error: 'Erro ao atualizar perfil' });\n  }\n});\n\n// POST /api/auth/request-password-reset - Solicitar reset de senha\napp.post('/api/auth/request-password-reset', validateRequestPasswordReset, handleValidationErrors, async (req, res) => {\n  try {\n    const { email } = req.body;\n    \n    // Verificar se usuário existe\n    const user = await db.query.users.findFirst({\n      where: eq(users.email, email)\n    });\n    \n    if (!user) {\n      // Por segurança, não revelar se email existe ou não\n      return res.json({ success: true, message: 'Se o email existir, receberá um código de recuperação' });\n    }\n    \n    // Gerar código de 6 dígitos\n    const code = Math.floor(100000 + Math.random() * 900000).toString();\n    \n    // Expirar em 10 minutos\n    const expiresAt = new Date(Date.now() + 10 * 60 * 1000);\n    \n    // Salvar código na base de dados\n    const resetTokenId = `reset_${Date.now()}${Math.floor(Math.random() * 10000)}`;\n    await db.insert(passwordResetTokens).values({\n      id: resetTokenId,\n      email,\n      code,\n      expiresAt,\n      used: false\n    });\n    \n    // Enviar email com código via Resend\n    const hostname = process.env.REPLIT_CONNECTORS_HOSTNAME;\n    const xReplitToken = process.env.REPL_IDENTITY \n      ? 'repl ' + process.env.REPL_IDENTITY \n      : process.env.WEB_REPL_RENEWAL \n      ? 'depl ' + process.env.WEB_REPL_RENEWAL \n      : null;\n\n    if (hostname && xReplitToken) {\n      try {\n        const connectionSettings = await fetch(\n          'https://' + hostname + '/api/v2/connection?include_secrets=true&connector_names=resend',\n          {\n            headers: {\n              'Accept': 'application/json',\n              'X_REPLIT_TOKEN': xReplitToken\n            }\n          }\n        ).then(res => res.json()).then(data => data.items?.[0]);\n\n        if (connectionSettings && connectionSettings.settings.api_key) {\n          const resend = new Resend(connectionSettings.settings.api_key);\n          \n          // Obter idioma preferido do utilizador\n          const userLang = user?.preferredLanguage || 'pt';\n          \n          // Traduzir textos do email\n          const emailSubject = await translateText('Recuperação de Senha - QZero', userLang, 'pt');\n          const txtTitle = await translateText('Recuperação de Senha', userLang, 'pt');\n          const txtHello = await translateText('Olá,', userLang, 'pt');\n          const txtReceived = await translateText('Recebemos um pedido para recuperar a sua senha.', userLang, 'pt');\n          const txtCodeIs = await translateText('O seu código de recuperação é:', userLang, 'pt');\n          const txtValidFor = await translateText('Este código é válido por', userLang, 'pt');\n          const txtMinutes = await translateText('10 minutos', userLang, 'pt');\n          const txtIgnore = await translateText('Se não solicitou esta recuperação, ignore este email.', userLang, 'pt');\n          const txtRegards = await translateText('Atenciosamente,', userLang, 'pt');\n          const txtTeam = await translateText('Equipa QZero', userLang, 'pt');\n          \n          await resend.emails.send({\n            from: 'QZero <noreply@waitless-qzero.com>',\n            to: email,\n            subject: emailSubject,\n            html: `\n              <h2>${txtTitle}</h2>\n              <p>${txtHello}</p>\n              <p>${txtReceived}</p>\n              <p>${txtCodeIs}</p>\n              <h1 style=\"font-size: 32px; letter-spacing: 5px; color: #2563eb;\">${code}</h1>\n              <p>${txtValidFor} <strong>${txtMinutes}</strong>.</p>\n              <p>${txtIgnore}</p>\n              <br>\n              <p>${txtRegards}<br>${txtTeam}</p>\n            `\n          });\n          \n          console.log('✅ Código de recuperação enviado para:', email);\n        } else {\n          console.error('❌ Resend não configurado');\n          return res.status(500).json({ error: 'Serviço de email não disponível' });\n        }\n      } catch (emailError) {\n        console.error('❌ Erro ao enviar email de recuperação:', emailError);\n        return res.status(500).json({ error: 'Erro ao enviar email de recuperação' });\n      }\n    } else {\n      console.error('❌ Configurações de email não disponíveis');\n      return res.status(500).json({ error: 'Serviço de email não disponível' });\n    }\n    \n    res.json({ success: true, message: 'Código de recuperação enviado para o seu email' });\n  } catch (error) {\n    console.error('❌ Erro ao processar pedido de reset:', error);\n    res.status(500).json({ error: 'Erro ao processar pedido' });\n  }\n});\n\n// POST /api/auth/reset-password - Reset de senha com código\napp.post('/api/auth/reset-password', validateResetPassword, handleValidationErrors, async (req, res) => {\n  try {\n    const { email, code, newPassword } = req.body;\n    \n    // Buscar código válido e não usado\n    const resetToken = await db.query.passwordResetTokens.findFirst({\n      where: and(\n        eq(passwordResetTokens.email, email),\n        eq(passwordResetTokens.code, code),\n        eq(passwordResetTokens.used, false),\n        gt(passwordResetTokens.expiresAt, new Date())\n      )\n    });\n    \n    if (!resetToken) {\n      logAuthFailure(req, email, 'INVALID_RESET_CODE');\n      return res.status(400).json({ error: 'Código inválido ou expirado' });\n    }\n    \n    // Buscar usuário\n    const user = await db.query.users.findFirst({\n      where: eq(users.email, email)\n    });\n    \n    if (!user) {\n      return res.status(404).json({ error: 'Utilizador não encontrado' });\n    }\n    \n    // Hash da nova senha\n    const passwordHash = await bcrypt.hash(newPassword, 10);\n    \n    // Atualizar senha do usuário\n    await db.update(users)\n      .set({ \n        passwordHash,\n        updatedAt: new Date()\n      })\n      .where(eq(users.id, user.id));\n    \n    // Marcar código como usado\n    await db.update(passwordResetTokens)\n      .set({ used: true })\n      .where(eq(passwordResetTokens.id, resetToken.id));\n    \n    logSecurityEvent(req, email, 'PASSWORD_RESET_SUCCESS');\n    console.log('✅ Senha alterada com sucesso:', email);\n    \n    res.json({ success: true, message: 'Senha alterada com sucesso' });\n  } catch (error) {\n    console.error('❌ Erro ao resetar senha:', error);\n    res.status(500).json({ error: 'Erro ao resetar senha' });\n  }\n});\n\n// POST /api/auth/change-password - Alterar senha (utilizador autenticado)\napp.post('/api/auth/change-password', authenticateToken, async (req, res) => {\n  try {\n    const { currentPassword, newPassword } = req.body;\n    const userId = req.user.userId;\n    \n    console.log('🔐 Tentativa de alteração de senha para userId:', userId);\n    \n    // Validações básicas\n    if (!currentPassword || !newPassword) {\n      return res.status(400).json({ error: 'Senha atual e nova senha são obrigatórias' });\n    }\n    \n    if (newPassword.length < 6) {\n      return res.status(400).json({ error: 'A nova senha deve ter pelo menos 6 caracteres' });\n    }\n    \n    // Buscar utilizador\n    const user = await db.query.users.findFirst({\n      where: eq(users.id, userId)\n    });\n    \n    if (!user) {\n      return res.status(404).json({ error: 'Utilizador não encontrado' });\n    }\n    \n    // Verificar senha atual\n    const validPassword = await bcrypt.compare(currentPassword, user.passwordHash);\n    if (!validPassword) {\n      logSecurityEvent(req, user.email, 'PASSWORD_CHANGE_FAILED_WRONG_CURRENT');\n      return res.status(401).json({ error: 'Senha atual incorreta' });\n    }\n    \n    // Hash da nova senha\n    const passwordHash = await bcrypt.hash(newPassword, 10);\n    \n    // Atualizar senha\n    await db.update(users)\n      .set({ \n        passwordHash,\n        updatedAt: new Date()\n      })\n      .where(eq(users.id, userId));\n    \n    logSecurityEvent(req, user.email, 'PASSWORD_CHANGE_SUCCESS');\n    console.log('✅ Senha alterada com sucesso para:', user.email);\n    \n    res.json({ success: true, message: 'Senha alterada com sucesso' });\n  } catch (error) {\n    console.error('❌ Erro ao alterar senha:', error);\n    res.status(500).json({ error: 'Erro ao alterar senha' });\n  }\n});\n\n// ================== ACCOUNT DELETION ENDPOINTS (VIA EMAIL) ==================\n\n// POST /api/auth/request-deletion - Solicitar eliminação de conta (via email)\n// Este endpoint é PÚBLICO para utilizadores não autenticados poderem solicitar\napp.post('/api/auth/request-deletion', async (req, res) => {\n  try {\n    const { email, reason } = req.body;\n    \n    if (!email) {\n      return res.status(400).json({ error: 'Email é obrigatório' });\n    }\n    \n    console.log('📧 Pedido de eliminação de conta recebido para:', email);\n    \n    // Verificar se utilizador existe\n    const user = await db.query.users.findFirst({\n      where: eq(users.email, email.toLowerCase().trim())\n    });\n    \n    // Por segurança, responder sempre com sucesso (não revelar se email existe)\n    if (!user) {\n      console.log('⚠️ Email não encontrado:', email);\n      return res.json({ \n        success: true, \n        message: 'Se o email estiver registado, receberá instruções para eliminar a conta.' \n      });\n    }\n    \n    // Gerar token de eliminação\n    const deletionToken = crypto.randomBytes(32).toString('hex');\n    const expiresAt = new Date(Date.now() + 24 * 60 * 60 * 1000); // 24 horas\n    \n    // Guardar token (reutilizar tabela de password reset)\n    await db.insert(passwordResetTokens).values({\n      id: crypto.randomUUID(),\n      email: user.email,\n      token: deletionToken,\n      expiresAt,\n      createdAt: new Date()\n    });\n    \n    // Enviar email com link de confirmação\n    if (resend) {\n      const deletionUrl = `${process.env.VITE_API_URL || 'https://q-zero-afonsomarques80.replit.app'}/delete-account.html?token=${deletionToken}&email=${encodeURIComponent(user.email)}`;\n      \n      await resend.emails.send({\n        from: 'QZero <noreply@waitless-qzero.com>',\n        to: user.email,\n        subject: 'Confirmação de Eliminação de Conta - QZero',\n        html: `\n          <div style=\"font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto;\">\n            <h2 style=\"color: #dc2626;\">Pedido de Eliminação de Conta</h2>\n            <p>Recebemos um pedido para eliminar a sua conta QZero.</p>\n            <p>Se foi você que fez este pedido, clique no botão abaixo para confirmar:</p>\n            <p style=\"text-align: center; margin: 30px 0;\">\n              <a href=\"${deletionUrl}\" style=\"background-color: #dc2626; color: white; padding: 15px 30px; text-decoration: none; border-radius: 8px; display: inline-block;\">\n                Confirmar Eliminação\n              </a>\n            </p>\n            <p style=\"color: #666; font-size: 14px;\">\n              Este link expira em 24 horas.<br>\n              Se não solicitou a eliminação da conta, ignore este email.\n            </p>\n            <hr style=\"border: none; border-top: 1px solid #eee; margin: 30px 0;\">\n            <p style=\"color: #999; font-size: 12px;\">\n              Razão indicada: ${reason || 'Não especificada'}\n            </p>\n          </div>\n        `\n      });\n      console.log('✅ Email de confirmação de eliminação enviado para:', user.email);\n    }\n    \n    logSecurityEvent(req, email, 'ACCOUNT_DELETION_REQUESTED', { reason: reason || 'not_specified' });\n    \n    res.json({ \n      success: true, \n      message: 'Se o email estiver registado, receberá instruções para eliminar a conta.' \n    });\n  } catch (error) {\n    console.error('❌ Erro ao processar pedido de eliminação:', error);\n    res.status(500).json({ error: 'Erro ao processar pedido' });\n  }\n});\n\n// POST /api/auth/confirm-deletion - Confirmar eliminação via token (público)\napp.post('/api/auth/confirm-deletion', async (req, res) => {\n  try {\n    const { token, email } = req.body;\n    \n    if (!token || !email) {\n      return res.status(400).json({ error: 'Token e email são obrigatórios' });\n    }\n    \n    console.log('🔐 Confirmação de eliminação para:', email);\n    \n    // Verificar token\n    const resetToken = await db.query.passwordResetTokens.findFirst({\n      where: and(\n        eq(passwordResetTokens.token, token),\n        eq(passwordResetTokens.email, email.toLowerCase().trim()),\n        gt(passwordResetTokens.expiresAt, new Date())\n      )\n    });\n    \n    if (!resetToken) {\n      return res.status(400).json({ error: 'Token inválido ou expirado' });\n    }\n    \n    // Buscar utilizador\n    const user = await db.query.users.findFirst({\n      where: eq(users.email, email.toLowerCase().trim())\n    });\n    \n    if (!user) {\n      return res.status(404).json({ error: 'Utilizador não encontrado' });\n    }\n    \n    // Cancelar subscrição Stripe se existir\n    const userProfile = await db.query.companyProfiles.findFirst({\n      where: eq(companyProfiles.adminUserId, user.id)\n    });\n    \n    if (userProfile?.subscriptionId && stripe) {\n      try {\n        await stripe.subscriptions.cancel(userProfile.subscriptionId);\n        console.log('✅ Subscrição Stripe cancelada:', userProfile.subscriptionId);\n      } catch (stripeError) {\n        console.warn('⚠️ Erro ao cancelar subscrição Stripe:', stripeError.message);\n      }\n    }\n    \n    // Eliminar perfil da empresa\n    if (userProfile) {\n      await db.delete(companyProfiles).where(eq(companyProfiles.id, userProfile.id));\n    }\n    \n    // Eliminar todos os dados relacionados\n    await db.delete(consents).where(eq(consents.userId, user.id));\n    await db.delete(verificationCodes).where(eq(verificationCodes.email, user.email));\n    await db.delete(passwordResetTokens).where(eq(passwordResetTokens.email, user.email));\n    await db.delete(challengeTokens).where(eq(challengeTokens.email, user.email));\n    \n    // Eliminar utilizador\n    await db.delete(users).where(eq(users.id, user.id));\n    \n    logSecurityEvent(req, user.email, 'ACCOUNT_DELETED_VIA_TOKEN');\n    console.log('✅ Conta eliminada via token:', user.email);\n    \n    res.json({ \n      success: true, \n      message: 'Conta eliminada com sucesso. Todos os dados foram removidos permanentemente.' \n    });\n  } catch (error) {\n    console.error('❌ Erro ao confirmar eliminação:', error);\n    res.status(500).json({ error: 'Erro ao eliminar conta' });\n  }\n});\n\n// ================== COMPANY PROFILES CRUD ENDPOINTS ==================\n\n// GET /api/company-profiles/:id - Buscar perfil por ID (com autenticação)\napp.get('/api/company-profiles/:id', authenticateToken, async (req, res) => {\n  try {\n    const { id } = req.params;\n    const userId = req.user.userId;\n    \n    console.log('🔍 Buscando perfil:', id, 'para utilizador:', userId);\n    \n    const profile = await db.query.companyProfiles.findFirst({\n      where: eq(companyProfiles.id, id)\n    });\n    \n    if (!profile) {\n      return res.status(404).json({ error: 'Profile not found' });\n    }\n    \n    // ✅ SEGURANÇA: Verificar ownership\n    if (profile.adminUserId !== userId) {\n      logger.warn('Unauthorized profile access attempt', {\n        userId,\n        requestedProfileId: id,\n        actualOwner: profile.adminUserId\n      });\n      return res.status(403).json({ error: 'Acesso não autorizado' });\n    }\n    \n    console.log('✅ Perfil encontrado:', profile.companyName);\n    res.json(profile);\n  } catch (error) {\n    console.error('❌ Error fetching profile:', error);\n    res.status(500).json({ error: error.message });\n  }\n});\n\n// GET /api/company-profiles/user/:userId - Buscar perfil por adminUserId\napp.get('/api/company-profiles/user/:userId', async (req, res) => {\n  try {\n    const { userId } = req.params;\n    console.log('🔍 Buscando perfil do usuário:', userId);\n    \n    const profile = await db.query.companyProfiles.findFirst({\n      where: eq(companyProfiles.adminUserId, userId)\n    });\n    \n    if (!profile) {\n      console.log('⚠️ Perfil não encontrado para usuário:', userId);\n      return res.json({ profile: null });\n    }\n    \n    console.log('✅ Perfil encontrado:', profile.companyName);\n    res.json({ profile });\n  } catch (error) {\n    console.error('❌ Error fetching profile by user:', error);\n    res.status(500).json({ error: error.message });\n  }\n});\n\n// POST /api/company-profiles - Criar novo perfil\n// ✅ VALIDAÇÃO APLICADA\napp.post('/api/company-profiles', validateCompanyProfile, handleValidationErrors, async (req, res) => {\n  const profileData = req.body;\n  \n  try {\n    console.log('📝 Criando novo perfil:', profileData.companyName);\n    \n    // Converter strings ISO para Date objects se necessário\n    const createdAt = profileData.createdAt \n      ? (typeof profileData.createdAt === 'string' ? new Date(profileData.createdAt) : profileData.createdAt)\n      : new Date();\n    const updatedAt = profileData.updatedAt \n      ? (typeof profileData.updatedAt === 'string' ? new Date(profileData.updatedAt) : profileData.updatedAt)\n      : new Date();\n    \n    // Definir defaults\n    const newProfile = {\n      ...profileData,\n      status: profileData.status || 'pending_payment',\n      createdAt,\n      updatedAt,\n      temporaryAccess: profileData.temporaryAccess || {\n        enabled: false,\n        expiresAt: null,\n        grantedBy: null,\n        reason: null\n      },\n      paymentRetry: profileData.paymentRetry || {\n        failureCount: 0,\n        lastFailureAt: null,\n        lastFailureReason: null,\n        canRetry: true\n      }\n    };\n    \n    const [created] = await db.insert(companyProfiles).values(newProfile).returning();\n    \n    console.log('✅ Perfil criado:', created.id);\n    \n    // Atualizar businessId na tabela users para linkar o utilizador ao perfil da empresa\n    try {\n      await db.update(users)\n        .set({ \n          businessId: created.id,\n          updatedAt: new Date()\n        })\n        .where(eq(users.id, created.adminUserId));\n      console.log('✅ businessId atualizado no utilizador:', created.adminUserId);\n    } catch (userUpdateError) {\n      console.error('⚠️ Erro ao atualizar businessId do utilizador:', userUpdateError);\n      // Não falhar a criação do perfil por causa disto\n    }\n    \n    res.status(201).json(created);\n  } catch (error) {\n    // Tratar duplicate key como sucesso (perfil já existe)\n    // CORREÇÃO: profileData agora está acessível neste escopo\n    if (error.cause?.code === '23505') {\n      console.log('ℹ️ Perfil já existe (duplicate key), retornando perfil existente...');\n      try {\n        const existing = await db.select().from(companyProfiles).where(eq(companyProfiles.id, profileData.id)).limit(1);\n        if (existing.length > 0) {\n          console.log('✅ Perfil existente retornado:', existing[0].id);\n          return res.status(200).json(existing[0]);\n        }\n      } catch (fetchError) {\n        console.error('❌ Erro ao buscar perfil existente:', fetchError);\n      }\n    }\n    \n    console.error('❌ Error creating profile:', error);\n    res.status(500).json({ error: error.message });\n  }\n});\n\n// PUT /api/company-profiles/:id - Atualizar perfil\n// ✅ VALIDAÇÃO DE ID APLICADA (validador de campos removido para permitir updates parciais)\napp.put('/api/company-profiles/:id', validateId, handleValidationErrors, async (req, res) => {\n  try {\n    const { id } = req.params;\n    const updates = req.body;\n    console.log('📝 Atualizando perfil:', id);\n    console.log('Dados:', updates);\n    \n    // Converter strings ISO para Date objects se necessário\n    if (updates.createdAt && typeof updates.createdAt === 'string') {\n      updates.createdAt = new Date(updates.createdAt);\n    }\n    if (updates.updatedAt && typeof updates.updatedAt === 'string') {\n      updates.updatedAt = new Date(updates.updatedAt);\n    }\n    \n    // Adicionar timestamp de atualização\n    updates.updatedAt = new Date();\n    \n    const [updated] = await db\n      .update(companyProfiles)\n      .set(updates)\n      .where(eq(companyProfiles.id, id))\n      .returning();\n    \n    if (!updated) {\n      return res.status(404).json({ error: 'Profile not found' });\n    }\n    \n    console.log('✅ Perfil atualizado:', updated.companyName);\n    res.json(updated);\n  } catch (error) {\n    console.error('❌ Error updating profile:', error);\n    res.status(500).json({ error: error.message });\n  }\n});\n\n// DELETE /api/company-profiles/:id - Deletar perfil\n// ✅ VALIDAÇÃO APLICADA\napp.delete('/api/company-profiles/:id', validateId, handleValidationErrors, async (req, res) => {\n  try {\n    const { id } = req.params;\n    console.log('🗑️ Deletando perfil:', id);\n    \n    const [deleted] = await db\n      .delete(companyProfiles)\n      .where(eq(companyProfiles.id, id))\n      .returning();\n    \n    if (!deleted) {\n      return res.status(404).json({ error: 'Profile not found' });\n    }\n    \n    console.log('✅ Perfil deletado:', deleted.companyName);\n    res.json({ success: true, deleted });\n  } catch (error) {\n    console.error('❌ Error deleting profile:', error);\n    res.status(500).json({ error: error.message });\n  }\n});\n\n// POST /api/company-profiles/geocode-all - Fazer geocoding retroativo de todas as empresas\napp.post('/api/company-profiles/geocode-all', async (req, res) => {\n  try {\n    console.log('🌍 Iniciando geocoding retroativo de todas as empresas...');\n    \n    // Buscar todas as empresas\n    const allProfiles = await db.select().from(companyProfiles);\n    \n    const results = {\n      total: allProfiles.length,\n      updated: 0,\n      skipped: 0,\n      failed: 0,\n      details: []\n    };\n    \n    // Função para fazer geocoding usando Nominatim\n    async function geocodeAddress(address) {\n      try {\n        const response = await fetch(\n          `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(address)}&limit=1`,\n          {\n            headers: {\n              'User-Agent': 'QZero-App/1.0 (contact@qzero.app)'\n            }\n          }\n        );\n        const data = await response.json();\n        \n        if (data && data.length > 0) {\n          return {\n            lat: parseFloat(data[0].lat),\n            lng: parseFloat(data[0].lon)\n          };\n        }\n        return null;\n      } catch (error) {\n        console.error('Erro no geocoding:', error);\n        return null;\n      }\n    }\n    \n    // Processar cada empresa\n    for (const profile of allProfiles) {\n      // Pular se já tem coordenadas\n      if (profile.companyCoordinates) {\n        results.skipped++;\n        results.details.push({\n          id: profile.id,\n          name: profile.companyName,\n          status: 'skipped',\n          reason: 'Já tem coordenadas GPS'\n        });\n        continue;\n      }\n      \n      // Verificar se tem pelo menos cidade OU código postal + país\n      if (!profile.companyCountry || (!profile.companyCity && !profile.companyPostalCode)) {\n        results.skipped++;\n        results.details.push({\n          id: profile.id,\n          name: profile.companyName,\n          status: 'skipped',\n          reason: 'Morada incompleta - necessário pelo menos país + (cidade ou código postal)'\n        });\n        continue;\n      }\n      \n      // Montar morada - priorizar morada completa, mas aceitar aproximações\n      const addressParts = [\n        profile.companyStreetName,\n        profile.companyDoorNumber,\n        profile.companyPostalCode,\n        profile.companyCity,\n        profile.companyDistrict,\n        profile.companyCountry\n      ].filter(Boolean);\n      \n      const fullAddress = addressParts.join(', ');\n      \n      console.log(`🌍 Fazendo geocoding: ${profile.companyName} - ${fullAddress}`);\n      \n      try {\n        const coordinates = await geocodeAddress(fullAddress);\n        \n        // Aguardar 1 segundo entre requests (respeitar rate limit da API Nominatim)\n        await new Promise(resolve => setTimeout(resolve, 1000));\n        \n        if (coordinates) {\n          // Atualizar perfil com coordenadas\n          await db\n            .update(companyProfiles)\n            .set({ \n              companyCoordinates: coordinates,\n              updatedAt: new Date()\n            })\n            .where(eq(companyProfiles.id, profile.id));\n          \n          results.updated++;\n          results.details.push({\n            id: profile.id,\n            name: profile.companyName,\n            status: 'success',\n            coordinates: coordinates\n          });\n          \n          console.log(`✅ Coordenadas obtidas para ${profile.companyName}:`, coordinates);\n        } else {\n          results.failed++;\n          results.details.push({\n            id: profile.id,\n            name: profile.companyName,\n            status: 'failed',\n            reason: 'Não foi possível obter coordenadas'\n          });\n          \n          console.log(`⚠️ Não foi possível obter coordenadas para ${profile.companyName}`);\n        }\n      } catch (error) {\n        results.failed++;\n        results.details.push({\n          id: profile.id,\n          name: profile.companyName,\n          status: 'error',\n          reason: error.message\n        });\n        \n        console.error(`❌ Erro ao processar ${profile.companyName}:`, error);\n      }\n    }\n    \n    console.log('🎉 Geocoding retroativo concluído:', results);\n    res.json(results);\n  } catch (error) {\n    console.error('❌ Error in geocode-all:', error);\n    res.status(500).json({ error: error.message });\n  }\n});\n\n// ================== COMPANY PROFILES - PUBLIC API ==================\n\n// Listar empresas públicas (sem autenticação necessária)\n// 🔒 SEGURANÇA: Apenas campos públicos são retornados (SEM dados de Stripe/subscription)\napp.get('/api/public/businesses', async (req, res) => {\n  try {\n    if (!IS_PRODUCTION) {\n      console.log('🔍 Buscando empresas públicas ativas...');\n    }\n    \n    // ✅ BUSCAR TODAS as empresas (active + cancelled)\n    const allProfiles = await db.select({\n      // ✅ APENAS campos públicos (NÃO expor Stripe/subscription data!)\n      id: companyProfiles.id,\n      companyName: companyProfiles.companyName,\n      companyDescription: companyProfiles.companyDescription,\n      companyAddress: companyProfiles.companyAddress,\n      companyStreetName: companyProfiles.companyStreetName,\n      companyDoorNumber: companyProfiles.companyDoorNumber,\n      companyDistrict: companyProfiles.companyDistrict,\n      companyCity: companyProfiles.companyCity,\n      companyPostalCode: companyProfiles.companyPostalCode,\n      companyCountry: companyProfiles.companyCountry,\n      companyPhone: companyProfiles.companyPhone,\n      companyEmail: companyProfiles.companyEmail,\n      companyCategory: companyProfiles.companyCategory,\n      customCategory: companyProfiles.customCategory,\n      logoUrl: companyProfiles.logoUrl,\n      mediaGallery: companyProfiles.mediaGallery,\n      companyCoordinates: companyProfiles.companyCoordinates,\n      status: companyProfiles.status,\n      // ⏰ PRECISAMOS destes campos internamente para verificar acesso (mas serão removidos antes de enviar ao cliente)\n      currentPeriodEnd: companyProfiles.currentPeriodEnd,\n      trialEnd: companyProfiles.trialEnd,\n      subscriptionStatus: companyProfiles.subscriptionStatus,\n    })\n      .from(companyProfiles);\n    \n    // ⏰ FILTRAR empresas com acesso VÁLIDO\n    const now = new Date();\n    const validProfiles = allProfiles.filter(profile => {\n      // ✅ Empresas ativas = sempre visíveis\n      if (profile.status === 'active') return true;\n      \n      // ✅ Trial ativo = sempre visível\n      if (profile.subscriptionStatus === 'trialing') return true;\n      \n      // ⏰ Empresas canceladas MAS com tempo restante = ainda visíveis\n      if (profile.status === 'cancelled') {\n        // Verificar currentPeriodEnd (subscrições pagas)\n        if (profile.currentPeriodEnd) {\n          const periodEnd = new Date(profile.currentPeriodEnd);\n          if (now < periodEnd) {\n            if (!IS_PRODUCTION) {\n              console.log(`⏰ Empresa \"${profile.companyName}\" cancelada mas visível até ${periodEnd.toISOString()}`);\n            }\n            return true; // ✅ Mantém visível até fim do período pago\n          }\n        }\n        \n        // Verificar trialEnd (subscrições em trial)\n        if (profile.trialEnd) {\n          const trialEndDate = new Date(profile.trialEnd);\n          if (now < trialEndDate) {\n            if (!IS_PRODUCTION) {\n              console.log(`⏰ Empresa \"${profile.companyName}\" em trial até ${trialEndDate.toISOString()}`);\n            }\n            return true; // ✅ Mantém visível até fim do trial\n          }\n        }\n      }\n      \n      // ❌ Empresas sem acesso válido = ocultar\n      return false;\n    });\n    \n    // 🔒 REMOVER campos internos e NORMALIZAR nomes para o frontend\n    const publicProfiles = validProfiles.map((profile) => {\n      const now = new Date();\n      const hasValidAccess = profile.status === 'active' || \n        profile.subscriptionStatus === 'trialing' ||\n        (profile.status === 'cancelled' && profile.currentPeriodEnd && new Date(profile.currentPeriodEnd) > now);\n      \n      return {\n        id: profile.id,\n        // ✅ CAMPOS NORMALIZADOS para o frontend (o frontend usa estes nomes)\n        name: profile.companyName,\n        description: profile.companyDescription,\n        address: profile.companyAddress,\n        country: profile.companyCountry,\n        city: profile.companyCity,\n        district: profile.companyDistrict,\n        postal_code: profile.companyPostalCode,\n        street_name: profile.companyStreetName,\n        door_number: profile.companyDoorNumber,\n        phone: profile.companyPhone,\n        email: profile.companyEmail,\n        category: profile.companyCategory,\n        custom_category: profile.customCategory,\n        logo_url: profile.logoUrl,\n        media_gallery: profile.mediaGallery,\n        coordinates: profile.companyCoordinates,\n        latitude: profile.companyCoordinates?.lat || null,\n        longitude: profile.companyCoordinates?.lng || null,\n        status: profile.status,\n        is_active: hasValidAccess,\n        // ✅ Manter campos originais para compatibilidade\n        companyName: profile.companyName,\n        companyDescription: profile.companyDescription,\n        companyAddress: profile.companyAddress,\n        companyCountry: profile.companyCountry,\n        companyCity: profile.companyCity,\n        companyCategory: profile.companyCategory,\n        companyCoordinates: profile.companyCoordinates,\n        logoUrl: profile.logoUrl,\n        mediaGallery: profile.mediaGallery,\n      };\n    });\n    \n    if (!IS_PRODUCTION) {\n      console.log(`✅ Encontradas ${publicProfiles.length} empresas com acesso válido (de ${allProfiles.length} totais)`);\n    }\n    \n    res.json(publicProfiles);\n  } catch (error) {\n    logger.error('Erro ao buscar empresas públicas:', error);\n    res.status(500).json({ error: 'Erro ao buscar empresas' });\n  }\n});\n\n// GET /api/public/businesses/:id - Buscar empresa específica por ID\napp.get('/api/public/businesses/:id', async (req, res) => {\n  try {\n    const { id } = req.params;\n    \n    if (!IS_PRODUCTION) {\n      console.log('🔍 Buscando empresa por ID:', id);\n    }\n    \n    const profiles = await db.select({\n      id: companyProfiles.id,\n      companyName: companyProfiles.companyName,\n      companyDescription: companyProfiles.companyDescription,\n      companyAddress: companyProfiles.companyAddress,\n      companyStreetName: companyProfiles.companyStreetName,\n      companyDoorNumber: companyProfiles.companyDoorNumber,\n      companyDistrict: companyProfiles.companyDistrict,\n      companyCity: companyProfiles.companyCity,\n      companyPostalCode: companyProfiles.companyPostalCode,\n      companyCountry: companyProfiles.companyCountry,\n      companyPhone: companyProfiles.companyPhone,\n      companyEmail: companyProfiles.companyEmail,\n      companyCategory: companyProfiles.companyCategory,\n      customCategory: companyProfiles.customCategory,\n      logoUrl: companyProfiles.logoUrl,\n      mediaGallery: companyProfiles.mediaGallery,\n      companyCoordinates: companyProfiles.companyCoordinates,\n      status: companyProfiles.status,\n      currentPeriodEnd: companyProfiles.currentPeriodEnd,\n      trialEnd: companyProfiles.trialEnd,\n      subscriptionStatus: companyProfiles.subscriptionStatus,\n    })\n      .from(companyProfiles)\n      .where(eq(companyProfiles.id, id));\n    \n    if (profiles.length === 0) {\n      return res.status(404).json({ error: 'Empresa não encontrada' });\n    }\n    \n    const profile = profiles[0];\n    const now = new Date();\n    \n    // Verificar se tem acesso válido\n    const hasValidAccess = profile.status === 'active' || \n      profile.subscriptionStatus === 'trialing' ||\n      (profile.status === 'cancelled' && profile.currentPeriodEnd && new Date(profile.currentPeriodEnd) > now);\n    \n    if (!hasValidAccess) {\n      return res.status(404).json({ error: 'Empresa não disponível' });\n    }\n    \n    // Normalizar para formato do frontend\n    const business = {\n      id: profile.id,\n      name: profile.companyName,\n      description: profile.companyDescription,\n      address: profile.companyAddress || `${profile.companyStreetName || ''} ${profile.companyDoorNumber || ''}`.trim(),\n      country: profile.companyCountry,\n      city: profile.companyCity,\n      district: profile.companyDistrict,\n      postal_code: profile.companyPostalCode,\n      street_name: profile.companyStreetName,\n      door_number: profile.companyDoorNumber,\n      phone: profile.companyPhone,\n      email: profile.companyEmail,\n      category: profile.companyCategory,\n      custom_category: profile.customCategory,\n      logo_url: profile.logoUrl,\n      media_gallery: profile.mediaGallery || [],\n      coordinates: profile.companyCoordinates,\n      latitude: profile.companyCoordinates?.lat || null,\n      longitude: profile.companyCoordinates?.lng || null,\n      is_active: true,\n    };\n    \n    if (!IS_PRODUCTION) {\n      console.log('✅ Empresa encontrada:', business.name);\n    }\n    \n    res.json(business);\n  } catch (error) {\n    logger.error('Erro ao buscar empresa por ID:', error);\n    res.status(500).json({ error: 'Erro ao buscar empresa' });\n  }\n});\n\n// GET /api/company-profiles/my-businesses - Endpoint autenticado para buscar empresas do owner (incluindo inativas)\napp.get('/api/company-profiles/my-businesses', authenticateToken, async (req, res) => {\n  try {\n    const userId = req.user.userId;\n    console.log('🔍 Buscando empresas do owner:', userId);\n    \n    const profiles = await db.select()\n      .from(companyProfiles)\n      .where(eq(companyProfiles.adminUserId, userId));\n    \n    console.log(`✅ Encontradas ${profiles.length} empresas do owner`);\n    \n    res.json(profiles);\n  } catch (error) {\n    console.error('❌ Erro ao buscar empresas do owner:', error);\n    res.status(500).json({ error: error.message });\n  }\n});\n\n// ================== COMPANY PROFILE COORDINATES UPDATE ==================\n\napp.patch('/api/company-profiles/:id/coordinates', async (req, res) => {\n  try {\n    const { id } = req.params;\n    const { lat, lng } = req.body;\n\n    if (!lat || !lng) {\n      return res.status(400).json({ error: 'Latitude and longitude are required' });\n    }\n\n    console.log(`🗺️ Atualizando coordenadas da empresa ${id}:`, { lat, lng });\n\n    const coordinates = { lat, lng };\n    \n    await db.update(companyProfiles)\n      .set({ \n        companyCoordinates: coordinates,\n        updatedAt: sql`NOW()`\n      })\n      .where(eq(companyProfiles.id, id));\n\n    console.log('✅ Coordenadas atualizadas com sucesso!');\n    \n    res.json({ \n      success: true, \n      coordinates \n    });\n  } catch (error) {\n    console.error('❌ Erro ao atualizar coordenadas:', error);\n    res.status(500).json({ error: error.message });\n  }\n});\n\n// ================== STRIPE ENDPOINTS ==================\n\napp.post('/api/create-subscription-checkout', async (req, res) => {\n  try {\n    const { companyProfileId, email, successUrl, cancelUrl } = req.body;\n\n    if (!companyProfileId || !email) {\n      return res.status(400).json({ error: 'Missing required fields' });\n    }\n\n    // 🔍 CRÍTICO: Buscar company profile para verificar se já tem stripeCustomerId\n    const companyProfile = await db.query.companyProfiles.findFirst({\n      where: eq(companyProfiles.id, companyProfileId)\n    });\n\n    if (!companyProfile) {\n      return res.status(404).json({ error: 'Company profile not found' });\n    }\n\n    // ✅ CORREÇÃO: Se já tem stripeCustomerId, SEMPRE usar esse customer (garante histórico)\n    // Trial de 7 dias é APENAS para novos clientes\n    let existingCustomer = null;\n    let hasHadPaidSubscription = false;\n    \n    try {\n      // 🎯 PRIORIDADE 1: Se o perfil já tem stripeCustomerId, usar esse\n      if (companyProfile.stripeCustomerId) {\n        console.log(`🔄 Reativação: Usando customer existente do perfil: ${companyProfile.stripeCustomerId}`);\n        existingCustomer = await stripe.customers.retrieve(companyProfile.stripeCustomerId);\n        \n        // Se conseguiu recuperar customer, verificar histórico\n        if (existingCustomer && !existingCustomer.deleted) {\n          const subscriptions = await stripe.subscriptions.list({\n            customer: existingCustomer.id,\n            limit: 100\n          });\n          \n          // 🔒 ANTI-FRAUDE: Trial é oferecido APENAS a quem NUNCA teve subscrição\n          // Mesmo que tenha cancelado durante o trial, NÃO pode ter trial novamente\n          // Isto previne abuse de trials infinitos\n          \n          if (subscriptions.data.length > 0) {\n            hasHadPaidSubscription = true;\n            console.log(`🔒 ANTI-FRAUDE: Customer já teve ${subscriptions.data.length} subscrição(ões) - SEM TRIAL`);\n            \n            // Log de todas as subscrições encontradas (para debug)\n            subscriptions.data.forEach(sub => {\n              console.log(`  📋 Subscrição ${sub.id}: status=${sub.status}, created=${new Date(sub.created * 1000).toISOString()}`);\n            });\n          } else {\n            console.log(`✅ Customer SEM subscrições anteriores - COM TRIAL de 7 dias`);\n          }\n        }\n      } else {\n        // 🎯 PRIORIDADE 2: Procurar customer por email (primeira vez)\n        const customers = await stripe.customers.list({\n          email: email,\n          limit: 1\n        });\n        \n        if (customers.data.length > 0) {\n          existingCustomer = customers.data[0];\n          console.log(`🔍 Cliente encontrado por email: ${existingCustomer.id}`);\n          \n          // Verificar histórico de subscrições deste cliente\n          const subscriptions = await stripe.subscriptions.list({\n            customer: existingCustomer.id,\n            limit: 100\n          });\n          \n          // 🔒 ANTI-FRAUDE: Mesma lógica - QUALQUER subscrição = SEM TRIAL\n          if (subscriptions.data.length > 0) {\n            hasHadPaidSubscription = true;\n            console.log(`🔒 ANTI-FRAUDE: Customer já teve ${subscriptions.data.length} subscrição(ões) - SEM TRIAL`);\n            \n            subscriptions.data.forEach(sub => {\n              console.log(`  📋 Subscrição ${sub.id}: status=${sub.status}, created=${new Date(sub.created * 1000).toISOString()}`);\n            });\n          } else {\n            console.log(`✅ Customer SEM subscrições anteriores - COM TRIAL de 7 dias`);\n          }\n        } else {\n          console.log(`✅ Cliente completamente novo - COM TRIAL de 7 dias`);\n        }\n      }\n      \n      if (hasHadPaidSubscription) {\n        console.log(`⚠️ Cliente já teve subscrição paga antes - SEM TRIAL`);\n      } else if (existingCustomer) {\n        console.log(`✅ Cliente existente mas sem subscrição paga - COM TRIAL de 7 dias`);\n      }\n    } catch (customerError) {\n      console.warn('⚠️ Erro ao verificar histórico do cliente:', customerError.message);\n      // Em caso de erro, continuar SEM trial por segurança\n      hasHadPaidSubscription = true;\n    }\n\n    // 🎁 TRIAL + DESCONTO: Apenas para clientes que NUNCA pagaram antes\n    // Cupão \"Desconto Primeiro Mês\" - €30 de desconto no primeiro pagamento (€49.99 → €19.99)\n    const FIRST_MONTH_DISCOUNT_COUPON = 'LStVoJAq';\n    \n    const subscriptionData = hasHadPaidSubscription ? {\n      description: 'Plano Empresarial QZero - €49.99/mês',\n    } : {\n      trial_period_days: 7,\n      description: '7 dias grátis para testar. Após o trial, primeiro mês por €19.99, depois €49.99/mês.',\n    };\n    \n    // 🏷️ Aplicar cupão de desconto apenas para novos clientes\n    const discountConfig = hasHadPaidSubscription ? {} : {\n      discounts: [{\n        coupon: FIRST_MONTH_DISCOUNT_COUPON,\n      }],\n    };\n    \n    console.log(`💳 Criando checkout ${hasHadPaidSubscription ? 'SEM trial/desconto' : 'COM trial de 7 dias + desconto €30 no primeiro pagamento'}`);\n\n    // ✅ IMPORTANTE: Stripe só aceita UM destes parâmetros (customer OU customer_email)\n    const customerConfig = existingCustomer \n      ? { customer: existingCustomer.id } // Se cliente existe, usar ID\n      : { customer_email: email };        // Se não existe, usar email\n    \n    const session = await stripe.checkout.sessions.create({\n      mode: 'subscription',\n      payment_method_types: ['card'],\n      line_items: [\n        {\n          price_data: {\n            currency: 'eur',\n            product_data: {\n              name: 'QZero - Plano Empresarial',\n              description: 'Gestão completa de filas e agendamentos para empresas',\n            },\n            unit_amount: 4999,\n            recurring: {\n              interval: 'month',\n            },\n          },\n          quantity: 1,\n        },\n      ],\n      ...customerConfig, // ✅ Apenas UM parâmetro (customer OU customer_email)\n      ...discountConfig, // 🏷️ Cupão de desconto para novos clientes\n      client_reference_id: companyProfileId,\n      success_url: successUrl,\n      cancel_url: cancelUrl,\n      subscription_data: subscriptionData,\n      metadata: {\n        companyProfileId,\n      },\n    });\n\n    res.json({ sessionId: session.id, url: session.url });\n  } catch (error) {\n    console.error('Error creating checkout session:', error);\n    res.status(500).json({ error: error.message });\n  }\n});\n\n// GET /api/check-trial-eligibility - Verificar se utilizador é elegível para trial de 7 dias\napp.get('/api/check-trial-eligibility', async (req, res) => {\n  try {\n    const { email, profileId } = req.query;\n    \n    if (!email) {\n      return res.status(400).json({ error: 'Email is required' });\n    }\n    \n    let isEligibleForTrial = true; // Por defeito, assumir que é elegível\n    \n    try {\n      // 🔍 PRIMEIRO: Verificar se o perfil já teve subscrição (tem stripeCustomerId ou status cancelled)\n      if (profileId) {\n        const profile = await db.query.companyProfiles.findFirst({\n          where: eq(companyProfiles.id, profileId)\n        });\n        \n        if (profile) {\n          // Se perfil já teve uma subscrição (tem customer ID ou status cancelled) = NÃO elegível\n          if (profile.stripeCustomerId || profile.status === 'cancelled' || profile.subscriptionStatus === 'cancelled') {\n            console.log(`🔒 ANTI-FRAUDE: Perfil ${profileId} já teve subscrição anterior (customerId=${profile.stripeCustomerId}, status=${profile.status})`);\n            return res.json({ isEligibleForTrial: false });\n          }\n        }\n      }\n      \n      // 🔍 Buscar TODOS os customers com este email\n      const allCustomers = await stripe.customers.search({\n        query: `email:'${email}'`,\n        limit: 10\n      });\n      \n      console.log(`🔍 Encontrados ${allCustomers.data.length} customers para ${email}`);\n      \n      // 🔒 ANTI-FRAUDE: Se encontrar QUALQUER customer com QUALQUER subscrição = SEM TRIAL\n      let hasHadAnySubscription = false;\n      \n      for (const customer of allCustomers.data) {\n        const subscriptions = await stripe.subscriptions.list({\n          customer: customer.id,\n          limit: 100\n        });\n        \n        if (subscriptions.data.length > 0) {\n          hasHadAnySubscription = true;\n          console.log(`🔒 ANTI-FRAUDE: Customer ${customer.id} já teve ${subscriptions.data.length} subscrição(ões)`);\n          \n          subscriptions.data.forEach(sub => {\n            console.log(`  📋 Subscrição ${sub.id}: status=${sub.status}`);\n          });\n          \n          break; // Não precisa verificar mais\n        }\n      }\n      \n      isEligibleForTrial = !hasHadAnySubscription;\n      \n      console.log(`🎁 Trial eligibility for ${email}: ${isEligibleForTrial ? 'ELIGIBLE (first time)' : 'NOT ELIGIBLE (already used trial)'}`);\n    } catch (stripeError) {\n      console.warn('⚠️ Error checking trial eligibility:', stripeError.message);\n      // Em caso de erro, assumir que NÃO é elegível por segurança\n      isEligibleForTrial = false;\n    }\n    \n    res.json({ isEligibleForTrial });\n  } catch (error) {\n    console.error('❌ Error checking trial eligibility:', error);\n    res.status(500).json({ error: error.message });\n  }\n});\n\napp.post('/api/verify-payment', async (req, res) => {\n  try {\n    const { sessionId } = req.body;\n\n    if (!sessionId) {\n      return res.status(400).json({ error: 'Missing session_id' });\n    }\n\n    console.log('🔍 Verifying payment for session:', sessionId);\n\n    const session = await stripe.checkout.sessions.retrieve(sessionId);\n    \n    console.log('📊 Session status:', session.payment_status);\n    console.log('📊 Session details:', {\n      customer: session.customer,\n      subscription: session.subscription,\n      client_reference_id: session.client_reference_id\n    });\n\n    // ✅ Aceitar tanto 'paid' quanto 'unpaid' (trial period)\n    // Durante os 7 dias grátis, payment_status será 'unpaid'\n    if (session.payment_status === 'paid' || session.payment_status === 'unpaid') {\n      const companyProfileId = session.client_reference_id || session.metadata?.companyProfileId;\n      \n      if (companyProfileId) {\n        // Buscar informações da subscription para verificar se está em trial\n        let subscriptionStatus = 'active';\n        let isTrialing = false;\n        let trialStart = null;\n        let trialEnd = null;\n        let currentPeriodEnd = null;\n        \n        if (session.subscription) {\n          try {\n            const subscription = await stripe.subscriptions.retrieve(session.subscription);\n            subscriptionStatus = subscription.status; // 'trialing', 'active', 'canceled', etc.\n            isTrialing = subscription.status === 'trialing';\n            \n            // ✅ Guardar datas de trial (como objetos Date, NÃO strings)\n            if (isTrialing && subscription.trial_start && subscription.trial_end) {\n              trialStart = new Date(subscription.trial_start * 1000);\n              trialEnd = new Date(subscription.trial_end * 1000);\n            }\n            \n            // ✅ Guardar data de fim do período atual (para subscrições canceladas)\n            if (subscription.current_period_end) {\n              currentPeriodEnd = new Date(subscription.current_period_end * 1000);\n            }\n            \n            console.log(`📊 Subscription status: ${subscriptionStatus} (trial: ${isTrialing})`);\n            if (isTrialing) {\n              console.log(`⏰ Trial period: ${trialStart} → ${trialEnd}`);\n            }\n            if (currentPeriodEnd) {\n              console.log(`📅 Current period ends: ${currentPeriodEnd}`);\n            }\n          } catch (subError) {\n            console.warn('⚠️ Could not retrieve subscription details:', subError.message);\n          }\n        }\n        \n        // ✅ CORRIGIDO: Status deve ser PENDING_PAYMENT durante trial, só ACTIVE após pagamento\n        const profileStatus = isTrialing ? SUBSCRIPTION_STATUS.PENDING_PAYMENT : SUBSCRIPTION_STATUS.ACTIVE;\n        \n        // ⚠️ CRÍTICO: Usar Drizzle diretamente no backend, não o client fetch()\n        await db.update(companyProfiles)\n          .set({\n            status: profileStatus,\n            stripeCustomerId: session.customer,\n            subscriptionId: session.subscription,\n            subscriptionStatus: subscriptionStatus,\n            trialStart: trialStart,\n            trialEnd: trialEnd,\n            currentPeriodEnd: currentPeriodEnd,\n          })\n          .where(eq(companyProfiles.id, companyProfileId));\n        \n        const statusMessage = isTrialing \n          ? `✅ Company profile ${companyProfileId} activated with 7-day trial`\n          : `✅ Company profile ${companyProfileId} activated after payment`;\n        console.log(statusMessage);\n        \n        return res.json({ \n          success: true, \n          status: subscriptionStatus,\n          companyProfileId,\n          isTrialing\n        });\n      }\n    }\n\n    return res.json({ \n      success: false, \n      status: session.payment_status,\n      message: 'Payment not completed yet'\n    });\n\n  } catch (error) {\n    console.error('Error verifying payment:', error);\n    res.status(500).json({ error: error.message });\n  }\n});\n\n// ⚠️ WEBHOOK MOVIDO PARA O INÍCIO DO ARQUIVO (antes do express.json())\n// Ver linha ~110 para o endpoint /api/stripe-webhook\n\napp.post('/api/send-ticket-email', async (req, res) => {\n  try {\n    const { to, subject, body } = req.body;\n\n    if (!to || !subject || !body) {\n      return res.status(400).json({ error: 'Missing required fields: to, subject, body' });\n    }\n\n    const hostname = process.env.REPLIT_CONNECTORS_HOSTNAME;\n    const xReplitToken = process.env.REPL_IDENTITY \n      ? 'repl ' + process.env.REPL_IDENTITY \n      : process.env.WEB_REPL_RENEWAL \n      ? 'depl ' + process.env.WEB_REPL_RENEWAL \n      : null;\n\n    if (!hostname || !xReplitToken) {\n      return res.status(500).json({ error: 'Replit connector not configured' });\n    }\n\n    const connectionSettings = await fetch(\n      'https://' + hostname + '/api/v2/connection?include_secrets=true&connector_names=resend',\n      {\n        headers: {\n          'Accept': 'application/json',\n          'X_REPLIT_TOKEN': xReplitToken\n        }\n      }\n    ).then(res => res.json()).then(data => data.items?.[0]);\n\n    if (!connectionSettings || !connectionSettings.settings.api_key) {\n      return res.status(500).json({ error: 'Resend not connected' });\n    }\n\n    const resend = new Resend(connectionSettings.settings.api_key);\n    const fromEmail = 'QZero <noreply@waitless-qzero.com>';\n\n    const result = await resend.emails.send({\n      from: fromEmail,\n      to: [to],\n      subject: subject,\n      text: body,\n    });\n\n    console.log('✅ Email enviado via Resend:', result);\n    res.json({ success: true, id: result.id });\n\n  } catch (error) {\n    console.error('❌ Erro ao enviar email via Resend:', error);\n    res.status(500).json({ success: false, error: error.message });\n  }\n});\n\n// =====================================================\n// 📱 PUSH NOTIFICATIONS - iOS/Android\n// =====================================================\n\napp.post('/api/push-notifications/register-token', authenticateToken, async (req, res) => {\n  try {\n    const { token, platform, deviceInfo } = req.body;\n    const userId = req.user.userId;\n\n    if (!token || !platform) {\n      return res.status(400).json({ error: 'Token and platform are required' });\n    }\n\n    const tokenId = await pushNotificationService.registerDeviceToken(userId, token, platform, deviceInfo);\n    \n    res.json({ success: true, tokenId });\n  } catch (error) {\n    console.error('❌ Error registering push token:', error);\n    res.status(500).json({ error: error.message });\n  }\n});\n\napp.post('/api/push-notifications/unregister-token', authenticateToken, async (req, res) => {\n  try {\n    const { token } = req.body;\n    const userId = req.user.userId;\n\n    if (!token) {\n      return res.status(400).json({ error: 'Token is required' });\n    }\n\n    await pushNotificationService.unregisterDeviceToken(userId, token);\n    \n    res.json({ success: true });\n  } catch (error) {\n    console.error('❌ Error unregistering push token:', error);\n    res.status(500).json({ error: error.message });\n  }\n});\n\napp.post('/api/push-notifications/send', authenticateToken, async (req, res) => {\n  try {\n    const { userId, title, body, data, type } = req.body;\n\n    if (!userId || !title || !body) {\n      return res.status(400).json({ error: 'userId, title, and body are required' });\n    }\n\n    const result = await pushNotificationService.sendPushNotification(userId, title, body, data, type);\n    \n    res.json(result);\n  } catch (error) {\n    console.error('❌ Error sending push notification:', error);\n    res.status(500).json({ error: error.message });\n  }\n});\n\napp.get('/api/push-notifications/my-tokens', authenticateToken, async (req, res) => {\n  try {\n    const userId = req.user.userId;\n    const tokens = await pushNotificationService.getUserTokens(userId);\n    \n    res.json({ tokens });\n  } catch (error) {\n    console.error('❌ Error getting push tokens:', error);\n    res.status(500).json({ error: error.message });\n  }\n});\n\napp.post('/api/push-notifications/test', authenticateToken, async (req, res) => {\n  try {\n    const userId = req.user.userId;\n    \n    const result = await pushNotificationService.sendPushNotification(\n      userId,\n      'Teste de Notificação',\n      'Se está a ver esta mensagem, as notificações push estão a funcionar corretamente!',\n      { test: true },\n      'test'\n    );\n    \n    res.json(result);\n  } catch (error) {\n    console.error('❌ Error sending test notification:', error);\n    res.status(500).json({ error: error.message });\n  }\n});\n\n// ✅ NOTIFICAÇÃO \"A SUA VEZ ESTÁ A CHEGAR\" - quando faltam 2 senhas\napp.post('/api/push-notifications/queue-alert', authenticateToken, async (req, res) => {\n  try {\n    const { userEmail, queueName, ticketNumber, position, businessName } = req.body;\n\n    if (!userEmail || !queueName || !ticketNumber) {\n      return res.status(400).json({ error: 'userEmail, queueName, and ticketNumber are required' });\n    }\n\n    // Encontrar userId pelo email\n    const user = await db.query.users.findFirst({\n      where: eq(users.email, userEmail)\n    });\n\n    if (!user) {\n      console.log(`⚠️ User not found for queue alert: ${userEmail}`);\n      return res.json({ success: false, reason: 'user_not_found' });\n    }\n\n    const result = await pushNotificationService.sendQueueNotification(\n      user.id,\n      queueName,\n      ticketNumber,\n      position || 2,\n      businessName || ''\n    );\n    \n    console.log(`📬 Queue alert sent to ${userEmail}: faltam ${position} senhas`);\n    res.json(result);\n  } catch (error) {\n    console.error('❌ Error sending queue alert:', error);\n    res.status(500).json({ error: error.message });\n  }\n});\n\n// ✅ NOTIFICAÇÃO \"A SUA SENHA FOI CHAMADA\" - quando é chamado\napp.post('/api/push-notifications/ticket-called', authenticateToken, async (req, res) => {\n  try {\n    const { userEmail, queueName, ticketNumber, businessName, toleranceMinutes } = req.body;\n\n    if (!userEmail || !queueName || !ticketNumber) {\n      return res.status(400).json({ error: 'userEmail, queueName, and ticketNumber are required' });\n    }\n\n    // Encontrar userId pelo email\n    const user = await db.query.users.findFirst({\n      where: eq(users.email, userEmail)\n    });\n\n    if (!user) {\n      console.log(`⚠️ User not found for ticket called: ${userEmail}`);\n      return res.json({ success: false, reason: 'user_not_found' });\n    }\n\n    const result = await pushNotificationService.sendTicketCalledNotification(\n      user.id,\n      queueName,\n      ticketNumber,\n      businessName || '',\n      toleranceMinutes || 15\n    );\n    \n    console.log(`📬 Ticket called notification sent to ${userEmail}: Senha #${ticketNumber} (tolerância: ${toleranceMinutes || 15}min)`);\n    res.json(result);\n  } catch (error) {\n    console.error('❌ Error sending ticket called notification:', error);\n    res.status(500).json({ error: error.message });\n  }\n});\n\n// ✅ NOTIFICAÇÃO \"MARCAÇÃO CONFIRMADA\" - quando é confirmada\napp.post('/api/push-notifications/appointment-confirmed', authenticateToken, async (req, res) => {\n  try {\n    const { userEmail, serviceName, businessName, date, time } = req.body;\n\n    if (!userEmail || !serviceName || !businessName || !date || !time) {\n      return res.status(400).json({ error: 'userEmail, serviceName, businessName, date, and time are required' });\n    }\n\n    // Encontrar userId pelo email\n    const user = await db.query.users.findFirst({\n      where: eq(users.email, userEmail)\n    });\n\n    if (!user) {\n      console.log(`⚠️ User not found for appointment confirmed: ${userEmail}`);\n      return res.json({ success: false, reason: 'user_not_found' });\n    }\n\n    const result = await pushNotificationService.sendAppointmentConfirmationNotification(\n      user.id,\n      serviceName,\n      businessName,\n      date,\n      time\n    );\n    \n    console.log(`📬 Appointment confirmed notification sent to ${userEmail}: ${serviceName} em ${date} às ${time}`);\n    res.json(result);\n  } catch (error) {\n    console.error('❌ Error sending appointment confirmed notification:', error);\n    res.status(500).json({ error: error.message });\n  }\n});\n\n// ✅ NOTIFICAÇÃO \"LEMBRETE DE MARCAÇÃO\" - 24h antes\napp.post('/api/push-notifications/appointment-reminder', authenticateToken, async (req, res) => {\n  try {\n    const { userEmail, serviceName, businessName, date, time } = req.body;\n\n    if (!userEmail || !serviceName || !businessName || !date || !time) {\n      return res.status(400).json({ error: 'userEmail, serviceName, businessName, date, and time are required' });\n    }\n\n    // Encontrar userId pelo email\n    const user = await db.query.users.findFirst({\n      where: eq(users.email, userEmail)\n    });\n\n    if (!user) {\n      console.log(`⚠️ User not found for appointment reminder: ${userEmail}`);\n      return res.json({ success: false, reason: 'user_not_found' });\n    }\n\n    const result = await pushNotificationService.sendAppointmentReminderNotification(\n      user.id,\n      serviceName,\n      businessName,\n      date,\n      time\n    );\n    \n    console.log(`📬 Appointment reminder notification sent to ${userEmail}: ${serviceName} em ${date} às ${time}`);\n    res.json(result);\n  } catch (error) {\n    console.error('❌ Error sending appointment reminder notification:', error);\n    res.status(500).json({ error: error.message });\n  }\n});\n\n// ✅ CANCELAR SUBSCRIÇÃO STRIPE (CRÍTICO - INTEGRAÇÃO REAL)\n// Endpoint para cancelamento REAL da subscrição no Stripe\napp.post('/api/stripe/cancel-subscription', \n  authenticateToken, \n  validateCancelSubscription, \n  handleValidationErrors, \n  async (req, res) => {\n  try {\n    const { companyProfileId } = req.body;\n    const userId = req.user.userId;\n    \n    console.log('🔴 CANCEL REQUEST RECEIVED:', { userId, companyProfileId });\n    logger.info('Cancellation request received', {\n      userId,\n      companyProfileId,\n      ip: req.ip\n    });\n    \n    // 1. Buscar perfil da empresa com subscriptionId\n    const profile = await db.query.companyProfiles.findFirst({\n      where: eq(companyProfiles.id, companyProfileId)\n    });\n    \n    if (!profile) {\n      logger.warn('Profile not found for cancellation', { companyProfileId });\n      return res.status(404).json({ error: 'Perfil da empresa não encontrado' });\n    }\n    \n    // 2. Validar ownership (utilizador é dono do perfil)\n    if (profile.adminUserId !== userId) {\n      logSecurityEvent('UNAUTHORIZED_CANCELLATION_ATTEMPT', {\n        userId,\n        attemptedProfileId: companyProfileId,\n        adminUserId: profile.adminUserId,\n        actualUserId: userId\n      });\n      return res.status(403).json({ error: 'Não tem permissão para cancelar esta subscrição' });\n    }\n    \n    if (!profile.subscriptionId) {\n      logger.warn('No Stripe subscription found', { companyProfileId });\n      return res.status(404).json({ error: 'Subscrição não encontrada no Stripe' });\n    }\n    \n    // 3. CANCELAR NO STRIPE (mantém acesso até fim do período pago)\n    // ⚠️ cancel_at_period_end: true → Utilizador mantém acesso até data de renovação\n    const cancelledSubscription = await stripe.subscriptions.update(\n      profile.subscriptionId,\n      { \n        cancel_at_period_end: true,\n        metadata: {\n          cancelled_by_user: 'true',\n          cancelled_at: new Date().toISOString(),\n          user_id: userId\n        }\n      }\n    );\n    \n    logger.info('Stripe subscription cancelled successfully', {\n      subscriptionId: profile.subscriptionId,\n      cancel_at: new Date(cancelledSubscription.cancel_at * 1000).toISOString(),\n      current_period_end: new Date(cancelledSubscription.current_period_end * 1000).toISOString()\n    });\n    \n    // 4. Atualizar DB local\n    const accessEndDate = new Date(cancelledSubscription.current_period_end * 1000);\n    \n    console.log('🔴 UPDATING DB:', { companyProfileId, accessEndDate });\n    \n    const updateResult = await db.update(companyProfiles)\n      .set({ \n        status: 'cancelled',\n        subscriptionStatus: 'cancelled',\n        currentPeriodEnd: accessEndDate,\n        updatedAt: new Date()\n      })\n      .where(eq(companyProfiles.id, companyProfileId))\n      .returning();\n    \n    console.log('🔴 DB UPDATE RESULT:', updateResult);\n    \n    // 5. Log de segurança\n    logSecurityEvent('SUBSCRIPTION_CANCELLED', {\n      userId,\n      email: req.user.email,\n      companyProfileId,\n      subscriptionId: profile.subscriptionId,\n      accessUntil: accessEndDate.toISOString()\n    });\n    \n    // 6. Retornar detalhes da cancelação\n    res.json({ \n      success: true,\n      cancelled: true,\n      access_until: accessEndDate.toISOString(),\n      current_period_end: cancelledSubscription.current_period_end,\n      cancel_at_period_end: cancelledSubscription.cancel_at_period_end,\n      message: `Subscrição cancelada com sucesso. Terá acesso até ${accessEndDate.toLocaleDateString('pt-PT', { \n        day: 'numeric', \n        month: 'long', \n        year: 'numeric' \n      })}`\n    });\n    \n  } catch (error) {\n    logger.error('Stripe cancellation error:', {\n      error: error.message,\n      stack: error.stack,\n      userId: req.user?.userId,\n      companyProfileId: req.body?.companyProfileId\n    });\n    \n    res.status(500).json({ \n      error: 'Erro ao cancelar subscrição. Por favor, tente novamente ou contacte o suporte.' \n    });\n  }\n});\n\n// ✅ REATIVAR SUBSCRIÇÃO CANCELADA (CRIAR NOVA SUBSCRIÇÃO)\n// Endpoint para reativar subscrições que foram canceladas\napp.post('/api/stripe/reactivate-subscription', \n  authenticateToken, \n  async (req, res) => {\n  try {\n    const { companyProfileId } = req.body;\n    const userId = req.user.userId;\n    const email = req.user.email;\n    \n    logger.info('Reactivation request received', {\n      userId,\n      companyProfileId,\n      ip: req.ip\n    });\n    \n    // 1. Buscar perfil da empresa\n    const profile = await db.query.companyProfiles.findFirst({\n      where: eq(companyProfiles.id, companyProfileId)\n    });\n    \n    if (!profile) {\n      logger.warn('Profile not found for reactivation', { companyProfileId });\n      return res.status(404).json({ error: 'Perfil da empresa não encontrado' });\n    }\n    \n    // 2. Validar ownership\n    if (profile.adminUserId !== userId) {\n      logSecurityEvent('UNAUTHORIZED_REACTIVATION_ATTEMPT', {\n        userId,\n        attemptedProfileId: companyProfileId,\n        adminUserId: profile.adminUserId\n      });\n      return res.status(403).json({ error: 'Não tem permissão para reativar esta subscrição' });\n    }\n    \n    // 3. Verificar se subscrição já está ativa\n    if (profile.status === 'active' && profile.subscriptionStatus === 'active') {\n      return res.status(400).json({ error: 'Subscrição já está ativa' });\n    }\n    \n    // 4. Se já tem subscriptionId no Stripe, tentar reativar\n    if (profile.subscriptionId) {\n      try {\n        const subscription = await stripe.subscriptions.retrieve(profile.subscriptionId);\n        \n        // Se está marcada para cancelar no fim do período, remover cancelamento\n        if (subscription.cancel_at_period_end) {\n          const reactivatedSub = await stripe.subscriptions.update(\n            profile.subscriptionId,\n            { cancel_at_period_end: false }\n          );\n          \n          logger.info('Stripe subscription reactivated (cancel removed)', {\n            subscriptionId: profile.subscriptionId\n          });\n          \n          // Atualizar DB local\n          await db.update(companyProfiles)\n            .set({ \n              status: 'active',\n              subscriptionStatus: reactivatedSub.status,\n              updatedAt: new Date()\n            })\n            .where(eq(companyProfiles.id, companyProfileId));\n          \n          logSecurityEvent('SUBSCRIPTION_REACTIVATED', {\n            userId,\n            email,\n            companyProfileId,\n            subscriptionId: profile.subscriptionId\n          });\n          \n          return res.json({ \n            success: true,\n            message: 'Subscrição reativada com sucesso!' \n          });\n        }\n        \n        // Se subscrição está cancelada (status = 'canceled'), criar nova subscrição para a mesma empresa\n        if (subscription.status === 'canceled') {\n          logger.info('Subscription canceled, will create new subscription for same company', {\n            oldSubscriptionId: profile.subscriptionId,\n            companyProfileId\n          });\n          // Retornar flag para criar nova subscrição\n          return res.json({ \n            success: false,\n            requires_new_checkout: true,\n            existing_profile_id: companyProfileId,\n            message: 'Subscrição expirada. Vamos criar uma nova subscrição para a sua empresa.'\n          });\n        }\n        \n      } catch (stripeError) {\n        logger.warn('Could not retrieve subscription, will create new one', {\n          error: stripeError.message,\n          subscriptionId: profile.subscriptionId\n        });\n      }\n    }\n    \n    // 5. Se não tem subscrição Stripe, criar nova subscrição para a mesma empresa\n    logger.info('No active subscription found, will create new subscription', {\n      companyProfileId\n    });\n    \n    res.json({ \n      success: false,\n      requires_new_checkout: true,\n      existing_profile_id: companyProfileId,\n      message: 'Vamos criar uma nova subscrição para a sua empresa.'\n    });\n    \n  } catch (error) {\n    logger.error('Stripe reactivation error:', {\n      error: error.message,\n      stack: error.stack,\n      userId: req.user?.userId,\n      companyProfileId: req.body?.companyProfileId\n    });\n    \n    res.status(500).json({ \n      error: 'Erro ao reativar subscrição. Por favor, tente novamente ou contacte o suporte.' \n    });\n  }\n});\n\n// ============================================\n// DEMO API - In-memory storage for demo mode\n// ============================================\n// Load demoStore from file or create default\nfunction loadDemoStore() {\n  try {\n    if (fs.existsSync(STORAGE_FILE)) {\n      const data = fs.readFileSync(STORAGE_FILE, 'utf8');\n      return JSON.parse(data);\n    }\n  } catch (error) {\n    console.error('Error loading demoStore:', error);\n  }\n  return {\n    tickets: [],\n    queues: [],\n    businesses: [],\n    services: [],\n    appointments: [],\n    reviews: []\n  };\n}\n\n// Save demoStore to file\nfunction saveDemoStore() {\n  try {\n    fs.writeFileSync(STORAGE_FILE, JSON.stringify(demoStore, null, 2));\n  } catch (error) {\n    console.error('Error saving demoStore:', error);\n  }\n}\n\nlet demoStore = loadDemoStore();\n\n// Seed default demo data\nfunction seedDemoData() {\n  if (demoStore.businesses.length === 0) {\n    demoStore.businesses = [\n      {\n        id: '1',\n        name: 'Clínica Saúde+',\n        description: 'Clínica médica com especialidades diversas',\n        address: 'Rua das Flores 123, 1200-000 Lisboa, Lisboa, Portugal',\n        street_name: 'Rua das Flores',\n        door_number: '123',\n        postal_code: '1200-000',\n        city: 'Lisboa',\n        district: 'Lisboa',\n        country: 'PT',\n        logo_url: '',\n        is_active: true,\n        rating: 4.5,\n        phone: '210000000',\n        email: 'contato@clinicasaude.pt',\n        website: 'https://clinicasaude.pt',\n        latitude: 38.7223,\n        longitude: -9.1393,\n        business_hours: 'Seg-Sex: 09:00-18:00',\n        total_queues: 1,\n        owner_email: 'demo@example.com',\n        category: 'saude'\n      },\n      {\n        id: '2',\n        name: 'Restaurante Sabor',\n        description: 'Cozinha tradicional portuguesa',\n        address: 'Avenida da Liberdade 456, 1250-000 Lisboa, Lisboa, Portugal',\n        street_name: 'Avenida da Liberdade',\n        door_number: '456',\n        postal_code: '1250-000',\n        city: 'Lisboa',\n        district: 'Lisboa',\n        country: 'PT',\n        is_active: true,\n        rating: 4.7,\n        phone: '210111111',\n        email: 'info@sabor.pt',\n        latitude: 38.7252,\n        longitude: -9.1500,\n        business_hours: 'Ter-Dom: 12:00-23:00',\n        total_queues: 1,\n        owner_email: 'demo2@example.com',\n        category: 'restauracao'\n      }\n    ];\n  }\n  \n  if (demoStore.queues.length === 0) {\n    demoStore.queues = [\n      {\n        id: 'q1',\n        business_id: '1',\n        name: 'Consultas Gerais',\n        is_active: true,\n        current_number: 5,\n        last_issued_number: 12,\n        average_service_time: 15,\n        tolerance_time: 5,\n        max_capacity: 100,\n        status: 'aberta',\n        notifications_enabled: true,\n        notification_settings: {\n          email: true,\n          sms: true,\n          advance_notice: 2\n        },\n        working_hours: {\n          monday: { enabled: true, start: '09:00', end: '18:00', break_start: '12:00', break_end: '13:00' },\n          tuesday: { enabled: true, start: '09:00', end: '18:00', break_start: '12:00', break_end: '13:00' },\n          wednesday: { enabled: true, start: '09:00', end: '18:00', break_start: '12:00', break_end: '13:00' },\n          thursday: { enabled: true, start: '09:00', end: '18:00', break_start: '12:00', break_end: '13:00' },\n          friday: { enabled: true, start: '09:00', end: '18:00', break_start: '12:00', break_end: '13:00' }\n        }\n      },\n      {\n        id: 'q2',\n        business_id: '2',\n        name: 'Mesas',\n        is_active: true,\n        current_number: 3,\n        last_issued_number: 8,\n        average_service_time: 20,\n        tolerance_time: 5,\n        max_capacity: 50,\n        status: 'aberta',\n        notifications_enabled: true,\n        notification_settings: {\n          email: true,\n          sms: true,\n          advance_notice: 2\n        },\n        working_hours: {\n          monday: { enabled: true, start: '12:00', end: '23:00', break_start: '15:00', break_end: '16:00' },\n          tuesday: { enabled: true, start: '12:00', end: '23:00', break_start: '15:00', break_end: '16:00' },\n          wednesday: { enabled: true, start: '12:00', end: '23:00', break_start: '15:00', break_end: '16:00' },\n          thursday: { enabled: true, start: '12:00', end: '23:00', break_start: '15:00', break_end: '16:00' },\n          friday: { enabled: true, start: '12:00', end: '00:00', break_start: '15:00', break_end: '16:00' },\n          saturday: { enabled: true, start: '12:00', end: '00:00', break_start: '15:00', break_end: '16:00' }\n        }\n      }\n    ];\n  }\n  \n  if (demoStore.services.length === 0) {\n    demoStore.services = [\n      {\n        id: 's1',\n        business_id: '1',\n        name: 'Consulta Médica',\n        description: 'Consulta com clínico geral',\n        price: 50,\n        duration: 30,\n        buffer_time: 5,\n        start_time: '09:00',\n        end_time: '18:00',\n        is_active: true,\n        allows_booking: true\n      },\n      {\n        id: 's2',\n        business_id: '2',\n        name: 'Jantar',\n        description: 'Menu completo de jantar',\n        price: 25,\n        duration: 90,\n        buffer_time: 15,\n        start_time: '19:00',\n        end_time: '23:00',\n        is_active: true,\n        allows_booking: true\n      }\n    ];\n  }\n  \n  console.log('✅ Demo data seeded:', {\n    businesses: demoStore.businesses.length,\n    queues: demoStore.queues.length,\n    services: demoStore.services.length\n  });\n  \n  // Save seeded data to file for persistence\n  saveDemoStore();\n}\n\n// Seed data on server start - DESABILITADO para limpeza completa\n// seedDemoData();\n\n// ================== PROTEÇÃO GLOBAL DE ENDPOINTS EMPRESARIAIS ==================\n// 🚫 BLOQUEIO AUTOMÁTICO: Todos os endpoints POST/PUT/DELETE de /api/demo/* \n// verificam subscrição ativa ANTES de processar a requisição\n// Isto funciona mesmo em apps móveis antigas que não têm o código atualizado\n\napp.use('/api/demo', async (req, res, next) => {\n  // 🔍 Verificar token para identificar utilizador\n  const cookieToken = req.cookies?.auth_token;\n  const authHeader = req.headers['authorization'];\n  const bearerToken = authHeader?.replace('Bearer ', '');\n  const token = cookieToken || bearerToken;\n  \n  // GET é permitido para leitura (permite ver dashboard e opção de renovar)\n  if (req.method === 'GET') {\n    return next();\n  }\n  \n  // POST/PUT/DELETE requerem autenticação e subscrição ativa\n  if (!token) {\n    console.log('🚫 /api/demo/* - Sem token de autenticação');\n    return res.status(401).json({ error: 'Não autenticado' });\n  }\n  \n  try {\n    const decoded = jwt.verify(token, JWT_SECRET);\n    req.user = decoded;\n    \n    // Buscar utilizador\n    const user = await db.query.users.findFirst({\n      where: eq(users.id, decoded.userId)\n    });\n    \n    if (!user) {\n      return res.status(401).json({ error: 'Utilizador não encontrado' });\n    }\n    \n    // Contas pessoais só podem criar tickets/appointments (como clientes)\n    if (user.accountType !== 'empresa') {\n      // Permitir que clientes criem tickets e marcações\n      const isClientAction = req.path.includes('/tickets') || req.path.includes('/appointments');\n      if (isClientAction) {\n        return next();\n      }\n      return res.status(403).json({ error: 'Apenas contas empresariais podem usar esta funcionalidade' });\n    }\n    \n    // Verificar subscrição para contas empresariais\n    if (!user.businessId) {\n      console.log('🚫 BLOQUEIO - Conta empresarial sem businessId:', user.email);\n      return res.status(403).json({ \n        error: 'Subscrição necessária para usar funcionalidades empresariais',\n        subscription_required: true,\n        is_expired: true\n      });\n    }\n    \n    const profile = await db.query.companyProfiles.findFirst({\n      where: eq(companyProfiles.id, user.businessId)\n    });\n    \n    if (!profile) {\n      console.log('🚫 BLOQUEIO - Perfil empresarial não encontrado:', user.email);\n      return res.status(403).json({ \n        error: 'Perfil empresarial não encontrado',\n        subscription_required: true\n      });\n    }\n    \n    // 🚫 VERIFICAR EXPIRAÇÃO\n    const now = new Date();\n    const periodEnd = profile.currentPeriodEnd ? new Date(profile.currentPeriodEnd) : null;\n    const isExpired = profile.subscriptionStatus === 'expired' || \n                      profile.status === 'expired' ||\n                      profile.status === 'cancelled' ||\n                      (periodEnd && now > periodEnd);\n    \n    console.log('🔍 /api/demo/* Verificação de subscrição:', {\n      email: user.email,\n      path: req.path,\n      method: req.method,\n      status: profile.status,\n      subscriptionStatus: profile.subscriptionStatus,\n      currentPeriodEnd: profile.currentPeriodEnd,\n      isExpired: isExpired\n    });\n    \n    if (isExpired) {\n      console.log('🚫 BLOQUEIO IMEDIATO - Subscrição expirada:', user.email);\n      return res.status(403).json({ \n        error: 'A sua subscrição expirou. Por favor, renove para continuar a usar as funcionalidades empresariais.',\n        subscription_expired: true,\n        is_expired: true,\n        subscription_status: profile.subscriptionStatus,\n        current_period_end: profile.currentPeriodEnd\n      });\n    }\n    \n    // ✅ Subscrição ativa - permitir acesso\n    next();\n  } catch (error) {\n    console.error('❌ Erro na verificação de subscrição /api/demo/*:', error);\n    return res.status(403).json({ error: 'Token inválido ou sessão expirada' });\n  }\n});\n\n// ENDPOINT DE LIMPEZA COMPLETA - Remove TODOS os dados demo\napp.post('/api/demo/clear-all', (req, res) => {\n  console.log('🧹 LIMPANDO TODOS OS DADOS DEMO...');\n  \n  // Limpar store em memória\n  demoStore = {\n    tickets: [],\n    queues: [],\n    businesses: [],\n    services: [],\n    appointments: [],\n    reviews: []\n  };\n  \n  // Salvar store vazio no ficheiro\n  saveDemoStore();\n  \n  console.log('✅ TODOS os dados demo removidos!');\n  res.json({ \n    success: true, \n    message: 'Todos os dados demo foram removidos',\n    store: demoStore\n  });\n});\n\n// GET all tickets (PostgreSQL)\napp.get('/api/demo/tickets', async (req, res) => {\n  try {\n    const { queue_id, business_id, id, user_email, status } = req.query;\n    \n    let result = await db.select().from(tickets).orderBy(desc(tickets.createdAt));\n    \n    if (id) result = result.filter(t => t.id === id);\n    if (queue_id) result = result.filter(t => t.queueId === queue_id);\n    if (business_id) result = result.filter(t => t.businessId === business_id);\n    if (user_email) result = result.filter(t => t.userEmail === user_email);\n    if (status) {\n      const statuses = status.split(',');\n      result = result.filter(t => statuses.includes(t.status));\n    }\n    \n    const mapped = result.map(t => ({\n      id: t.id,\n      ticket_number: t.ticketNumber,\n      queue_id: t.queueId,\n      business_id: t.businessId,\n      user_email: t.userEmail,\n      user_name: t.userName,\n      user_phone: t.userPhone,\n      status: t.status,\n      is_manual: t.isManual,\n      manual_name: t.manualName,\n      estimated_time: t.estimatedTime,\n      position: t.position,\n      called_at: t.calledAt,\n      completed_at: t.completedAt,\n      attending_started_at: t.attendingStartedAt,\n      created_date: t.createdAt\n    }));\n    \n    res.json(mapped);\n  } catch (error) {\n    console.error('Error fetching tickets:', error);\n    res.status(500).json({ error: 'Failed to fetch tickets' });\n  }\n});\n\n// POST create ticket (PostgreSQL)\napp.post('/api/demo/tickets', async (req, res) => {\n  try {\n    const ticketId = `ticket_${Date.now()}`;\n    const newTicket = {\n      id: ticketId,\n      ticketNumber: req.body.ticket_number,\n      queueId: req.body.queue_id,\n      businessId: req.body.business_id,\n      userEmail: req.body.user_email,\n      userName: req.body.user_name || null,\n      userPhone: req.body.user_phone || null,\n      status: req.body.status || 'aguardando',\n      isManual: req.body.is_manual || false,\n      manualName: req.body.manual_name || null,\n      estimatedTime: req.body.estimated_time || null,\n      position: req.body.position || null\n    };\n    \n    await db.insert(tickets).values(newTicket);\n    \n    const [created] = await db.select().from(tickets).where(eq(tickets.id, ticketId));\n    \n    res.json({\n      id: created.id,\n      ticket_number: created.ticketNumber,\n      queue_id: created.queueId,\n      business_id: created.businessId,\n      user_email: created.userEmail,\n      user_name: created.userName,\n      user_phone: created.userPhone,\n      status: created.status,\n      is_manual: created.isManual,\n      manual_name: created.manualName,\n      estimated_time: created.estimatedTime,\n      position: created.position,\n      created_date: created.createdAt\n    });\n  } catch (error) {\n    console.error('Error creating ticket:', error);\n    res.status(500).json({ error: 'Failed to create ticket' });\n  }\n});\n\n// PUT update ticket (PostgreSQL)\napp.put('/api/demo/tickets/:id', async (req, res) => {\n  try {\n    const [existing] = await db.select().from(tickets).where(eq(tickets.id, req.params.id));\n    if (!existing) return res.status(404).json({ error: 'Ticket not found' });\n    \n    const updates = {};\n    if (req.body.status !== undefined) updates.status = req.body.status;\n    if (req.body.called_at !== undefined) updates.calledAt = new Date(req.body.called_at);\n    if (req.body.completed_at !== undefined) updates.completedAt = new Date(req.body.completed_at);\n    if (req.body.attending_started_at !== undefined) updates.attendingStartedAt = new Date(req.body.attending_started_at);\n    if (req.body.is_manual !== undefined) updates.isManual = req.body.is_manual;\n    if (req.body.manual_name !== undefined) updates.manualName = req.body.manual_name;\n    if (req.body.estimated_time !== undefined) updates.estimatedTime = req.body.estimated_time;\n    if (req.body.position !== undefined) updates.position = req.body.position;\n    \n    await db.update(tickets).set(updates).where(eq(tickets.id, req.params.id));\n    \n    const [updated] = await db.select().from(tickets).where(eq(tickets.id, req.params.id));\n    \n    res.json({\n      id: updated.id,\n      ticket_number: updated.ticketNumber,\n      queue_id: updated.queueId,\n      business_id: updated.businessId,\n      user_email: updated.userEmail,\n      user_name: updated.userName,\n      user_phone: updated.userPhone,\n      status: updated.status,\n      is_manual: updated.isManual,\n      manual_name: updated.manualName,\n      estimated_time: updated.estimatedTime,\n      position: updated.position,\n      called_at: updated.calledAt,\n      completed_at: updated.completedAt,\n      attending_started_at: updated.attendingStartedAt,\n      created_date: updated.createdAt\n    });\n  } catch (error) {\n    console.error('Error updating ticket:', error);\n    res.status(500).json({ error: 'Failed to update ticket' });\n  }\n});\n\n// DELETE ticket (PostgreSQL)\napp.delete('/api/demo/tickets/:id', async (req, res) => {\n  try {\n    const [existing] = await db.select().from(tickets).where(eq(tickets.id, req.params.id));\n    if (!existing) return res.status(404).json({ error: 'Ticket not found' });\n    \n    await db.delete(tickets).where(eq(tickets.id, req.params.id));\n    res.json({ success: true });\n  } catch (error) {\n    console.error('Error deleting ticket:', error);\n    res.status(500).json({ error: 'Failed to delete ticket' });\n  }\n});\n\n// GET all queues (PostgreSQL)\napp.get('/api/demo/queues', async (req, res) => {\n  try {\n    const { business_id, id, is_active } = req.query;\n    \n    let result = await db.select().from(queues).orderBy(desc(queues.createdAt));\n    \n    if (id) result = result.filter(q => q.id === id);\n    if (business_id) result = result.filter(q => q.businessId === business_id);\n    if (is_active !== undefined) result = result.filter(q => q.isActive === (is_active === 'true'));\n    \n    const mapped = result.map(q => ({\n      id: q.id,\n      name: q.name,\n      description: q.description,\n      business_id: q.businessId,\n      current_number: q.currentNumber,\n      last_issued_number: q.lastIssuedNumber || q.currentNumber,\n      average_service_time: q.averageServiceTime,\n      tolerance_time: q.toleranceTime,\n      max_capacity: q.maxCapacity,\n      status: q.status || 'aberta',\n      is_active: q.isActive,\n      working_hours: q.workingHours,\n      last_reset_date: q.lastResetDate,\n      notifications_enabled: q.notificationsEnabled,\n      notification_settings: q.notificationSettings,\n      created_at: q.createdAt\n    }));\n    \n    res.json(mapped);\n  } catch (error) {\n    console.error('Error fetching queues:', error);\n    res.status(500).json({ error: 'Failed to fetch queues' });\n  }\n});\n\n// POST create queue (PostgreSQL)\napp.post('/api/demo/queues', async (req, res) => {\n  try {\n    // 🚫 VERIFICAR SUBSCRIÇÃO EXPIRADA\n    const businessId = req.body.business_id;\n    if (businessId) {\n      const [profile] = await db.select().from(companyProfiles).where(eq(companyProfiles.id, businessId));\n      if (profile) {\n        const now = new Date();\n        const periodEnd = profile.currentPeriodEnd ? new Date(profile.currentPeriodEnd) : null;\n        const isExpired = profile.subscriptionStatus === 'expired' || \n                          profile.status === 'expired' ||\n                          (periodEnd && now > periodEnd);\n        if (isExpired) {\n          console.log('🚫 BLOQUEADO: Tentativa de criar queue com subscrição expirada:', businessId);\n          return res.status(403).json({ error: 'Subscrição expirada. Renove para continuar.' });\n        }\n      }\n    }\n\n    const queueId = `q${Date.now()}`;\n    const today = new Date().toISOString().split('T')[0];\n    const newQueue = {\n      id: queueId,\n      name: req.body.name,\n      description: req.body.description || '',\n      businessId: req.body.business_id,\n      currentNumber: req.body.current_number || 0,\n      lastIssuedNumber: req.body.last_issued_number || 0,\n      averageServiceTime: req.body.average_service_time || 10,\n      toleranceTime: req.body.tolerance_time || 15,\n      maxCapacity: req.body.max_capacity || 100,\n      status: req.body.status || 'aberta',\n      isActive: req.body.is_active !== false,\n      workingHours: req.body.working_hours || null,\n      lastResetDate: req.body.last_reset_date || today,\n      notificationsEnabled: req.body.notifications_enabled || false,\n      notificationSettings: req.body.notification_settings || null\n    };\n    \n    await db.insert(queues).values(newQueue);\n    \n    const [created] = await db.select().from(queues).where(eq(queues.id, queueId));\n    \n    res.json({\n      id: created.id,\n      name: created.name,\n      description: created.description,\n      business_id: created.businessId,\n      current_number: created.currentNumber,\n      last_issued_number: created.lastIssuedNumber,\n      average_service_time: created.averageServiceTime,\n      tolerance_time: created.toleranceTime,\n      max_capacity: created.maxCapacity,\n      status: created.status,\n      is_active: created.isActive,\n      working_hours: created.workingHours,\n      last_reset_date: created.lastResetDate,\n      notifications_enabled: created.notificationsEnabled,\n      notification_settings: created.notificationSettings,\n      created_at: created.createdAt\n    });\n  } catch (error) {\n    console.error('Error creating queue:', error);\n    res.status(500).json({ error: 'Failed to create queue' });\n  }\n});\n\n// PUT update queue (PostgreSQL)\napp.put('/api/demo/queues/:id', async (req, res) => {\n  try {\n    const [existing] = await db.select().from(queues).where(eq(queues.id, req.params.id));\n    if (!existing) return res.status(404).json({ error: 'Queue not found' });\n    \n    // 🚫 VERIFICAR SUBSCRIÇÃO EXPIRADA\n    const businessId = existing.businessId;\n    if (businessId) {\n      const [profile] = await db.select().from(companyProfiles).where(eq(companyProfiles.id, businessId));\n      if (profile) {\n        const now = new Date();\n        const periodEnd = profile.currentPeriodEnd ? new Date(profile.currentPeriodEnd) : null;\n        const isExpired = profile.subscriptionStatus === 'expired' || \n                          profile.status === 'expired' ||\n                          (periodEnd && now > periodEnd);\n        if (isExpired) {\n          console.log('🚫 BLOQUEADO: Tentativa de editar queue com subscrição expirada:', businessId);\n          return res.status(403).json({ error: 'Subscrição expirada. Renove para continuar.' });\n        }\n      }\n    }\n    \n    const updates = { updatedAt: new Date() };\n    if (req.body.name !== undefined) updates.name = req.body.name;\n    if (req.body.description !== undefined) updates.description = req.body.description;\n    if (req.body.current_number !== undefined) updates.currentNumber = req.body.current_number;\n    if (req.body.last_issued_number !== undefined) updates.lastIssuedNumber = req.body.last_issued_number;\n    if (req.body.average_service_time !== undefined) updates.averageServiceTime = req.body.average_service_time;\n    if (req.body.tolerance_time !== undefined) updates.toleranceTime = req.body.tolerance_time;\n    if (req.body.max_capacity !== undefined) updates.maxCapacity = req.body.max_capacity;\n    if (req.body.status !== undefined) updates.status = req.body.status;\n    if (req.body.is_active !== undefined) updates.isActive = req.body.is_active;\n    if (req.body.working_hours !== undefined) updates.workingHours = req.body.working_hours;\n    if (req.body.last_reset_date !== undefined) updates.lastResetDate = req.body.last_reset_date;\n    if (req.body.notifications_enabled !== undefined) updates.notificationsEnabled = req.body.notifications_enabled;\n    if (req.body.notification_settings !== undefined) updates.notificationSettings = req.body.notification_settings;\n    \n    await db.update(queues).set(updates).where(eq(queues.id, req.params.id));\n    \n    const [updated] = await db.select().from(queues).where(eq(queues.id, req.params.id));\n    \n    res.json({\n      id: updated.id,\n      name: updated.name,\n      description: updated.description,\n      business_id: updated.businessId,\n      current_number: updated.currentNumber,\n      last_issued_number: updated.lastIssuedNumber,\n      average_service_time: updated.averageServiceTime,\n      tolerance_time: updated.toleranceTime,\n      max_capacity: updated.maxCapacity,\n      status: updated.status,\n      is_active: updated.isActive,\n      working_hours: updated.workingHours,\n      last_reset_date: updated.lastResetDate,\n      notifications_enabled: updated.notificationsEnabled,\n      notification_settings: updated.notificationSettings,\n      created_at: updated.createdAt\n    });\n  } catch (error) {\n    console.error('Error updating queue:', error);\n    res.status(500).json({ error: 'Failed to update queue' });\n  }\n});\n\n// DELETE queue (PostgreSQL)\napp.delete('/api/demo/queues/:id', async (req, res) => {\n  try {\n    const [existing] = await db.select().from(queues).where(eq(queues.id, req.params.id));\n    if (!existing) return res.status(404).json({ error: 'Queue not found' });\n    \n    // 🚫 VERIFICAR SUBSCRIÇÃO EXPIRADA\n    const businessId = existing.businessId;\n    if (businessId) {\n      const [profile] = await db.select().from(companyProfiles).where(eq(companyProfiles.id, businessId));\n      if (profile) {\n        const now = new Date();\n        const periodEnd = profile.currentPeriodEnd ? new Date(profile.currentPeriodEnd) : null;\n        const isExpired = profile.subscriptionStatus === 'expired' || \n                          profile.status === 'expired' ||\n                          (periodEnd && now > periodEnd);\n        if (isExpired) {\n          console.log('🚫 BLOQUEADO: Tentativa de eliminar queue com subscrição expirada:', businessId);\n          return res.status(403).json({ error: 'Subscrição expirada. Renove para continuar.' });\n        }\n      }\n    }\n    \n    await db.delete(queues).where(eq(queues.id, req.params.id));\n    res.json({ success: true });\n  } catch (error) {\n    console.error('Error deleting queue:', error);\n    res.status(500).json({ error: 'Failed to delete queue' });\n  }\n});\n\n// GET all businesses\napp.get('/api/demo/businesses', (req, res) => {\n  const { id, is_active, owner_email } = req.query;\n  let filtered = [...demoStore.businesses];\n  \n  if (id) filtered = filtered.filter(b => b.id === id);\n  if (is_active !== undefined) filtered = filtered.filter(b => b.is_active === (is_active === 'true'));\n  if (owner_email) filtered = filtered.filter(b => b.owner_email === owner_email);\n  \n  res.json(filtered);\n});\n\n// POST create business\napp.post('/api/demo/businesses', (req, res) => {\n  const business = {\n    id: `${Date.now()}`,\n    ...req.body,\n    created_at: new Date().toISOString()\n  };\n  demoStore.businesses.push(business);\n  saveDemoStore();\n  res.json(business);\n});\n\n// PUT update business\napp.put('/api/demo/businesses/:id', (req, res) => {\n  const index = demoStore.businesses.findIndex(b => b.id === req.params.id);\n  if (index === -1) return res.status(404).json({ error: 'Business not found' });\n  \n  demoStore.businesses[index] = { ...demoStore.businesses[index], ...req.body };\n  saveDemoStore();\n  res.json(demoStore.businesses[index]);\n});\n\n// GET all services (PostgreSQL)\napp.get('/api/demo/services', async (req, res) => {\n  try {\n    const { business_id, id, is_active } = req.query;\n    \n    let result = await db.select().from(services).orderBy(desc(services.createdAt));\n    \n    if (id) result = result.filter(s => s.id === id);\n    if (business_id) result = result.filter(s => s.businessId === business_id);\n    if (is_active !== undefined) result = result.filter(s => s.isActive === (is_active === 'true'));\n    \n    const mapped = result.map(s => ({\n      id: s.id,\n      business_id: s.businessId,\n      name: s.name,\n      description: s.description,\n      category: s.category,\n      duration: s.duration,\n      tolerance_time: s.toleranceTime,\n      price: s.price,\n      max_daily_slots: s.maxDailySlots,\n      available_days: s.availableDays,\n      working_hours: s.workingHours,\n      is_active: s.isActive,\n      created_at: s.createdAt\n    }));\n    \n    res.json(mapped);\n  } catch (error) {\n    console.error('Error fetching services:', error);\n    res.status(500).json({ error: 'Failed to fetch services' });\n  }\n});\n\n// POST create service (PostgreSQL)\napp.post('/api/demo/services', async (req, res) => {\n  try {\n    // 🚫 VERIFICAR SUBSCRIÇÃO EXPIRADA\n    const businessId = req.body.business_id;\n    if (businessId) {\n      const [profile] = await db.select().from(companyProfiles).where(eq(companyProfiles.id, businessId));\n      if (profile) {\n        const now = new Date();\n        const periodEnd = profile.currentPeriodEnd ? new Date(profile.currentPeriodEnd) : null;\n        const isExpired = profile.subscriptionStatus === 'expired' || \n                          profile.status === 'expired' ||\n                          (periodEnd && now > periodEnd);\n        if (isExpired) {\n          console.log('🚫 BLOQUEADO: Tentativa de criar service com subscrição expirada:', businessId);\n          return res.status(403).json({ error: 'Subscrição expirada. Renove para continuar.' });\n        }\n      }\n    }\n\n    const serviceId = `service_${Date.now()}`;\n    const newService = {\n      id: serviceId,\n      businessId: req.body.business_id,\n      name: req.body.name,\n      description: req.body.description || null,\n      category: req.body.category || null,\n      duration: req.body.duration || 30,\n      toleranceTime: req.body.tolerance_time || 15,\n      price: req.body.price || 0,\n      maxDailySlots: req.body.max_daily_slots || 10,\n      availableDays: req.body.available_days || null,\n      workingHours: req.body.working_hours || null,\n      isActive: req.body.is_active !== false\n    };\n    \n    await db.insert(services).values(newService);\n    \n    const [created] = await db.select().from(services).where(eq(services.id, serviceId));\n    \n    res.json({\n      id: created.id,\n      business_id: created.businessId,\n      name: created.name,\n      description: created.description,\n      category: created.category,\n      duration: created.duration,\n      tolerance_time: created.toleranceTime,\n      price: created.price,\n      max_daily_slots: created.maxDailySlots,\n      available_days: created.availableDays,\n      working_hours: created.workingHours,\n      is_active: created.isActive,\n      created_at: created.createdAt\n    });\n  } catch (error) {\n    console.error('Error creating service:', error);\n    res.status(500).json({ error: 'Failed to create service' });\n  }\n});\n\n// PUT update service (PostgreSQL)\napp.put('/api/demo/services/:id', async (req, res) => {\n  try {\n    const [existing] = await db.select().from(services).where(eq(services.id, req.params.id));\n    if (!existing) return res.status(404).json({ error: 'Service not found' });\n    \n    // 🚫 VERIFICAR SUBSCRIÇÃO EXPIRADA\n    const businessId = existing.businessId || req.body.business_id;\n    if (businessId) {\n      const [profile] = await db.select().from(companyProfiles).where(eq(companyProfiles.id, businessId));\n      if (profile) {\n        const now = new Date();\n        const periodEnd = profile.currentPeriodEnd ? new Date(profile.currentPeriodEnd) : null;\n        const isExpired = profile.subscriptionStatus === 'expired' || \n                          profile.status === 'expired' ||\n                          (periodEnd && now > periodEnd);\n        if (isExpired) {\n          console.log('🚫 BLOQUEADO: Tentativa de editar service com subscrição expirada:', businessId);\n          return res.status(403).json({ error: 'Subscrição expirada. Renove para continuar.' });\n        }\n      }\n    }\n    \n    const updates = { updatedAt: new Date() };\n    if (req.body.name !== undefined) updates.name = req.body.name;\n    if (req.body.description !== undefined) updates.description = req.body.description;\n    if (req.body.category !== undefined) updates.category = req.body.category;\n    if (req.body.duration !== undefined) updates.duration = req.body.duration;\n    if (req.body.tolerance_time !== undefined) updates.toleranceTime = req.body.tolerance_time;\n    if (req.body.price !== undefined) updates.price = req.body.price;\n    if (req.body.max_daily_slots !== undefined) updates.maxDailySlots = req.body.max_daily_slots;\n    if (req.body.available_days !== undefined) updates.availableDays = req.body.available_days;\n    if (req.body.working_hours !== undefined) updates.workingHours = req.body.working_hours;\n    if (req.body.is_active !== undefined) updates.isActive = req.body.is_active;\n    \n    await db.update(services).set(updates).where(eq(services.id, req.params.id));\n    \n    const [updated] = await db.select().from(services).where(eq(services.id, req.params.id));\n    \n    res.json({\n      id: updated.id,\n      business_id: updated.businessId,\n      name: updated.name,\n      description: updated.description,\n      category: updated.category,\n      duration: updated.duration,\n      tolerance_time: updated.toleranceTime,\n      price: updated.price,\n      max_daily_slots: updated.maxDailySlots,\n      available_days: updated.availableDays,\n      working_hours: updated.workingHours,\n      is_active: updated.isActive,\n      created_at: updated.createdAt\n    });\n  } catch (error) {\n    console.error('Error updating service:', error);\n    res.status(500).json({ error: 'Failed to update service' });\n  }\n});\n\n// DELETE service (PostgreSQL)\napp.delete('/api/demo/services/:id', async (req, res) => {\n  try {\n    const [existing] = await db.select().from(services).where(eq(services.id, req.params.id));\n    if (!existing) return res.status(404).json({ error: 'Service not found' });\n    \n    // 🚫 VERIFICAR SUBSCRIÇÃO EXPIRADA\n    const businessId = existing.businessId;\n    if (businessId) {\n      const [profile] = await db.select().from(companyProfiles).where(eq(companyProfiles.id, businessId));\n      if (profile) {\n        const now = new Date();\n        const periodEnd = profile.currentPeriodEnd ? new Date(profile.currentPeriodEnd) : null;\n        const isExpired = profile.subscriptionStatus === 'expired' || \n                          profile.status === 'expired' ||\n                          (periodEnd && now > periodEnd);\n        if (isExpired) {\n          console.log('🚫 BLOQUEADO: Tentativa de eliminar service com subscrição expirada:', businessId);\n          return res.status(403).json({ error: 'Subscrição expirada. Renove para continuar.' });\n        }\n      }\n    }\n    \n    await db.delete(services).where(eq(services.id, req.params.id));\n    res.json({ success: true });\n  } catch (error) {\n    console.error('Error deleting service:', error);\n    res.status(500).json({ error: 'Failed to delete service' });\n  }\n});\n\n// GET all appointments (PostgreSQL)\napp.get('/api/demo/appointments', async (req, res) => {\n  try {\n    const { business_id, user_email, status, id } = req.query;\n    \n    let result = await db.select().from(appointments).orderBy(desc(appointments.createdAt));\n    \n    if (id) result = result.filter(a => a.id === id);\n    if (business_id) result = result.filter(a => a.businessId === business_id);\n    if (user_email) result = result.filter(a => a.userEmail === user_email);\n    if (status) {\n      const statuses = status.split(',');\n      result = result.filter(a => statuses.includes(a.status));\n    }\n    \n    const mapped = result.map(a => ({\n      id: a.id,\n      business_id: a.businessId,\n      service_id: a.serviceId,\n      service_name: a.serviceName,\n      user_email: a.userEmail,\n      user_name: a.userName,\n      user_phone: a.userPhone,\n      status: a.status,\n      appointment_date: a.appointmentDate,\n      appointment_time: a.appointmentTime,\n      duration: a.duration,\n      buffer_time: a.bufferTime,\n      notes: a.notes,\n      business_response: a.businessResponse,\n      rating: a.rating,\n      feedback: a.feedback,\n      reminder_sent: a.reminderSent,\n      management_token: a.managementToken,\n      created_date: a.createdAt,\n      updated_at: a.updatedAt\n    }));\n    \n    res.json(mapped);\n  } catch (error) {\n    console.error('Error fetching appointments:', error);\n    res.status(500).json({ error: 'Failed to fetch appointments' });\n  }\n});\n\n// POST create appointment (PostgreSQL)\napp.post('/api/demo/appointments', async (req, res) => {\n  try {\n    const appointmentId = `appointment_${Date.now()}`;\n    const newAppointment = {\n      id: appointmentId,\n      businessId: req.body.business_id,\n      serviceId: req.body.service_id || null,\n      serviceName: req.body.service_name || null,\n      userEmail: req.body.user_email,\n      userName: req.body.user_name || null,\n      userPhone: req.body.user_phone || null,\n      status: req.body.status || 'agendado',\n      appointmentDate: req.body.appointment_date,\n      appointmentTime: req.body.appointment_time,\n      duration: req.body.duration || 30,\n      bufferTime: req.body.buffer_time || 0,\n      notes: req.body.notes || null,\n      businessResponse: req.body.business_response || null,\n      managementToken: req.body.management_token || null\n    };\n    \n    await db.insert(appointments).values(newAppointment);\n    \n    const [created] = await db.select().from(appointments).where(eq(appointments.id, appointmentId));\n    \n    res.json({\n      id: created.id,\n      business_id: created.businessId,\n      service_id: created.serviceId,\n      service_name: created.serviceName,\n      user_email: created.userEmail,\n      user_name: created.userName,\n      user_phone: created.userPhone,\n      status: created.status,\n      appointment_date: created.appointmentDate,\n      appointment_time: created.appointmentTime,\n      duration: created.duration,\n      buffer_time: created.bufferTime,\n      notes: created.notes,\n      business_response: created.businessResponse,\n      management_token: created.managementToken,\n      created_date: created.createdAt\n    });\n  } catch (error) {\n    console.error('Error creating appointment:', error);\n    res.status(500).json({ error: 'Failed to create appointment' });\n  }\n});\n\n// PUT update appointment (PostgreSQL)\napp.put('/api/demo/appointments/:id', async (req, res) => {\n  try {\n    const [existing] = await db.select().from(appointments).where(eq(appointments.id, req.params.id));\n    if (!existing) return res.status(404).json({ error: 'Appointment not found' });\n    \n    const oldStatus = existing.status;\n    \n    const updates = { updatedAt: new Date() };\n    if (req.body.status !== undefined) updates.status = req.body.status;\n    if (req.body.appointment_date !== undefined) updates.appointmentDate = req.body.appointment_date;\n    if (req.body.appointment_time !== undefined) updates.appointmentTime = req.body.appointment_time;\n    if (req.body.notes !== undefined) updates.notes = req.body.notes;\n    if (req.body.business_response !== undefined) updates.businessResponse = req.body.business_response;\n    if (req.body.rating !== undefined) updates.rating = req.body.rating;\n    if (req.body.feedback !== undefined) updates.feedback = req.body.feedback;\n    if (req.body.reminder_sent !== undefined) updates.reminderSent = req.body.reminder_sent;\n    \n    await db.update(appointments).set(updates).where(eq(appointments.id, req.params.id));\n    \n    const [updated] = await db.select().from(appointments).where(eq(appointments.id, req.params.id));\n    \n    const updatedAppointment = {\n      id: updated.id,\n      business_id: updated.businessId,\n      service_id: updated.serviceId,\n      service_name: updated.serviceName,\n      user_email: updated.userEmail,\n      user_name: updated.userName,\n      user_phone: updated.userPhone,\n      status: updated.status,\n      appointment_date: updated.appointmentDate,\n      appointment_time: updated.appointmentTime,\n      duration: updated.duration,\n      buffer_time: updated.bufferTime,\n      notes: updated.notes,\n      business_response: updated.businessResponse,\n      rating: updated.rating,\n      feedback: updated.feedback,\n      reminder_sent: updated.reminderSent,\n      management_token: updated.managementToken,\n      created_date: updated.createdAt,\n      updated_at: updated.updatedAt\n    };\n    \n    // ✅ ENVIAR NOTIFICAÇÕES quando status muda para \"confirmado\"\n    if (req.body.status === 'confirmado' && oldStatus !== 'confirmado') {\n      // Buscar dados da empresa do PostgreSQL company_profiles\n      let business = null;\n      console.log('🔍 Procurando empresa no PostgreSQL...');\n      try {\n        const [companyProfile] = await db.select().from(companyProfiles).where(eq(companyProfiles.id, updated.businessId));\n        if (companyProfile) {\n          business = {\n            id: companyProfile.id,\n            name: companyProfile.companyName,\n            address: companyProfile.companyAddress,\n            phone: companyProfile.companyPhone\n          };\n          console.log('✅ Empresa encontrada no PostgreSQL:', business.name);\n        }\n      } catch (dbError) {\n        console.log('⚠️ Erro ao procurar empresa no PostgreSQL:', dbError.message);\n      }\n\n      // 📱 PUSH NOTIFICATION: \"Marcação Confirmada\" (independente do email)\n      if (updated.userEmail && business) {\n        try {\n          const appointmentDate = new Date(updated.appointmentDate);\n          const formattedDate = appointmentDate.toLocaleDateString('pt-PT', { \n            day: '2-digit', \n            month: '2-digit', \n            year: 'numeric' \n          });\n          \n          const user = await db.query.users.findFirst({ where: eq(users.email, updated.userEmail.toLowerCase()) });\n          if (user) {\n            await pushNotificationService.sendAppointmentConfirmationNotification(\n              user.id,\n              updated.serviceName || 'Serviço',\n              business.name,\n              formattedDate,\n              updated.appointmentTime\n            );\n            console.log(`📱 Push \"Marcação Confirmada\" enviado para: ${updated.userEmail}`);\n          }\n        } catch (pushError) {\n          console.error('⚠️ Erro ao enviar push de confirmação:', pushError);\n        }\n      }\n\n      // 📧 ENVIAR E-MAIL DE CONFIRMAÇÃO\n      try {\n        console.log('📧 Tentando enviar e-mail de confirmação de marcação...');\n        console.log('📧 business_id:', updated.businessId);\n        console.log('📧 user_email:', updated.userEmail);\n        console.log('📧 business encontrado:', business ? business.name : 'NÃO ENCONTRADO');\n        \n        if (business && updated.userEmail) {\n          const hostname = process.env.REPLIT_CONNECTORS_HOSTNAME;\n          const xReplitToken = process.env.REPL_IDENTITY \n            ? 'repl ' + process.env.REPL_IDENTITY \n            : process.env.WEB_REPL_RENEWAL \n            ? 'depl ' + process.env.WEB_REPL_RENEWAL \n            : null;\n\n          console.log('📧 Resend hostname disponível:', !!hostname);\n          console.log('📧 Resend token disponível:', !!xReplitToken);\n\n          if (hostname && xReplitToken) {\n            console.log('📧 Conectando ao Resend...');\n            const connectionSettings = await fetch(\n              'https://' + hostname + '/api/v2/connection?include_secrets=true&connector_names=resend',\n              {\n                headers: {\n                  'Accept': 'application/json',\n                  'X_REPLIT_TOKEN': xReplitToken\n                }\n              }\n            ).then(res => res.json()).then(data => data.items?.[0]);\n\n            if (connectionSettings && connectionSettings.settings.api_key) {\n              const resend = new Resend(connectionSettings.settings.api_key);\n              const fromEmail = 'QZero <noreply@waitless-qzero.com>';\n              \n              // Buscar idioma preferido do utilizador\n              let userLang = 'pt';\n              try {\n                const [appointmentUser] = await db.select().from(users).where(eq(users.email, updated.userEmail.toLowerCase()));\n                userLang = appointmentUser?.preferredLanguage || 'pt';\n              } catch (e) {\n                console.log('Usando idioma padrão pt para email');\n              }\n              \n              // Formatar data e hora\n              const appointmentDate = new Date(updated.appointmentDate);\n              const formattedDate = appointmentDate.toLocaleDateString('pt-PT', { \n                day: '2-digit', \n                month: '2-digit', \n                year: 'numeric' \n              });\n\n              // Traduzir textos do email\n              const txtSubject = await translateText('Marcação Confirmada', userLang, 'pt');\n              const txtHello = await translateText('Olá', userLang, 'pt');\n              const txtClient = await translateText('Cliente', userLang, 'pt');\n              const txtConfirmed = await translateText('A sua marcação foi CONFIRMADA!', userLang, 'pt');\n              const txtDetails = await translateText('Detalhes da Marcação', userLang, 'pt');\n              const txtBusiness = await translateText('Empresa', userLang, 'pt');\n              const txtDate = await translateText('Data', userLang, 'pt');\n              const txtTime = await translateText('Hora', userLang, 'pt');\n              const txtService = await translateText('Serviço', userLang, 'pt');\n              const txtAddress = await translateText('Morada', userLang, 'pt');\n              const txtNotSpecified = await translateText('Não especificada', userLang, 'pt');\n              const txtContact = await translateText('Contacto', userLang, 'pt');\n              const txtImportant = await translateText('IMPORTANTE', userLang, 'pt');\n              const txtArriveEarly = await translateText('Por favor, chegue 5-10 minutos antes da hora marcada', userLang, 'pt');\n              const txtCancelAdvance = await translateText('Em caso de impossibilidade de comparência, cancele com antecedência', userLang, 'pt');\n              const txtThankYou = await translateText('Obrigado por escolher', userLang, 'pt');\n\n              const emailBody = `\n${txtHello} ${updated.userName || txtClient},\n\n${txtConfirmed} ✅\n\n📋 ${txtDetails}:\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n🏢 ${txtBusiness}: ${business.name}\n📅 ${txtDate}: ${formattedDate}\n⏰ ${txtTime}: ${updated.appointmentTime}\n${updated.serviceName ? `🔧 ${txtService}: ${updated.serviceName}` : ''}\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n\n📍 ${txtAddress}: ${business.address || txtNotSpecified}\n${business.phone ? `📞 ${txtContact}: ${business.phone}` : ''}\n\n⚠️ ${txtImportant}:\n• ${txtArriveEarly}\n• ${txtCancelAdvance}\n\n${txtThankYou} ${business.name}!\n\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\nQZero - Sistema de Gestão de Filas\n              `.trim();\n\n              await resend.emails.send({\n                from: fromEmail,\n                to: [updated.userEmail],\n                subject: `✅ ${txtSubject} - ${business.name}`,\n                text: emailBody,\n              });\n\n              console.log(`✅ E-mail de confirmação enviado para: ${updated.userEmail}`);\n            } else {\n              console.log('⚠️ Resend API key não encontrada nas connectionSettings');\n            }\n          } else {\n            console.log('⚠️ Hostname ou token Resend não disponíveis');\n          }\n        } else {\n          console.log('⚠️ Não foi possível enviar e-mail: business=', !!business, ', user_email=', !!updated.userEmail);\n        }\n      } catch (emailError) {\n        console.error('❌ Erro ao enviar e-mail de confirmação:', emailError);\n      }\n    }\n    \n    res.json(updatedAppointment);\n  } catch (error) {\n    console.error('❌ Erro ao atualizar marcação:', error);\n    res.status(500).json({ error: error.message });\n  }\n});\n\n// DELETE appointment (PostgreSQL)\napp.delete('/api/demo/appointments/:id', async (req, res) => {\n  try {\n    const [existing] = await db.select().from(appointments).where(eq(appointments.id, req.params.id));\n    if (!existing) return res.status(404).json({ error: 'Appointment not found' });\n    \n    await db.delete(appointments).where(eq(appointments.id, req.params.id));\n    res.json({ success: true });\n  } catch (error) {\n    console.error('Error deleting appointment:', error);\n    res.status(500).json({ error: 'Failed to delete appointment' });\n  }\n});\n\n// ============================================\n// REVIEWS Endpoints\n// ============================================\n\n// GET reviews\napp.get('/api/demo/reviews', (req, res) => {\n  const { business_id, user_email } = req.query;\n  let filtered = [...demoStore.reviews];\n  \n  if (business_id) {\n    filtered = filtered.filter(r => r.business_id === business_id);\n  }\n  \n  if (user_email) {\n    filtered = filtered.filter(r => r.user_email === user_email);\n  }\n  \n  res.json(filtered);\n});\n\n// POST create review\napp.post('/api/demo/reviews', (req, res) => {\n  const review = {\n    id: `review_${Date.now()}`,\n    created_date: new Date().toISOString(),\n    ...req.body\n  };\n  demoStore.reviews.push(review);\n  saveDemoStore();\n  res.json(review);\n});\n\n// PUT update review\napp.put('/api/demo/reviews/:id', (req, res) => {\n  const index = demoStore.reviews.findIndex(r => r.id === req.params.id);\n  if (index === -1) return res.status(404).json({ error: 'Review not found' });\n  \n  demoStore.reviews[index] = { ...demoStore.reviews[index], ...req.body };\n  saveDemoStore();\n  res.json(demoStore.reviews[index]);\n});\n\n// DELETE review\napp.delete('/api/demo/reviews/:id', (req, res) => {\n  const index = demoStore.reviews.findIndex(r => r.id === req.params.id);\n  if (index === -1) return res.status(404).json({ error: 'Review not found' });\n  \n  demoStore.reviews.splice(index, 1);\n  saveDemoStore();\n  res.json({ success: true });\n});\n\n// ============================================================================\n// STAFF INVITES\n// ============================================================================\n\n// GET staff invites\napp.get('/api/demo/staff-invites', (req, res) => {\n  if (!demoStore.staffInvites) demoStore.staffInvites = [];\n  \n  let filtered = demoStore.staffInvites;\n  \n  if (req.query.business_id) {\n    filtered = filtered.filter(i => i.business_id === req.query.business_id);\n  }\n  if (req.query.email) {\n    filtered = filtered.filter(i => i.email === req.query.email);\n  }\n  if (req.query.status) {\n    filtered = filtered.filter(i => i.status === req.query.status);\n  }\n  if (req.query.token) {\n    filtered = filtered.filter(i => i.token === req.query.token);\n  }\n  \n  res.json(filtered);\n});\n\n// POST create staff invite\napp.post('/api/demo/staff-invites', (req, res) => {\n  if (!demoStore.staffInvites) demoStore.staffInvites = [];\n  \n  const invite = {\n    id: `invite_${Date.now()}`,\n    created_at: new Date().toISOString(),\n    ...req.body\n  };\n  demoStore.staffInvites.push(invite);\n  saveDemoStore();\n  res.json(invite);\n});\n\n// PUT update staff invite\napp.put('/api/demo/staff-invites/:id', (req, res) => {\n  if (!demoStore.staffInvites) demoStore.staffInvites = [];\n  \n  const index = demoStore.staffInvites.findIndex(i => i.id === req.params.id);\n  if (index === -1) return res.status(404).json({ error: 'Invite not found' });\n  \n  demoStore.staffInvites[index] = { ...demoStore.staffInvites[index], ...req.body };\n  saveDemoStore();\n  res.json(demoStore.staffInvites[index]);\n});\n\n// DELETE staff invite\napp.delete('/api/demo/staff-invites/:id', (req, res) => {\n  if (!demoStore.staffInvites) demoStore.staffInvites = [];\n  \n  const index = demoStore.staffInvites.findIndex(i => i.id === req.params.id);\n  if (index === -1) return res.status(404).json({ error: 'Invite not found' });\n  \n  demoStore.staffInvites.splice(index, 1);\n  saveDemoStore();\n  res.json({ success: true });\n});\n\n// ============================================================================\n// SUPPORT MESSAGES\n// ============================================================================\n\n// GET support messages\napp.get('/api/demo/support-messages', (req, res) => {\n  if (!demoStore.supportMessages) demoStore.supportMessages = [];\n  \n  let filtered = demoStore.supportMessages;\n  \n  if (req.query.business_id) {\n    filtered = filtered.filter(m => m.business_id === req.query.business_id);\n  }\n  if (req.query.user_email) {\n    filtered = filtered.filter(m => m.user_email === req.query.user_email);\n  }\n  if (req.query.status) {\n    filtered = filtered.filter(m => m.status === req.query.status);\n  }\n  \n  res.json(filtered);\n});\n\n// POST create support message\napp.post('/api/demo/support-messages', (req, res) => {\n  if (!demoStore.supportMessages) demoStore.supportMessages = [];\n  \n  const message = {\n    id: `msg_${Date.now()}`,\n    created_at: new Date().toISOString(),\n    ...req.body\n  };\n  demoStore.supportMessages.push(message);\n  saveDemoStore();\n  res.json(message);\n});\n\n// PUT update support message\napp.put('/api/demo/support-messages/:id', (req, res) => {\n  if (!demoStore.supportMessages) demoStore.supportMessages = [];\n  \n  const index = demoStore.supportMessages.findIndex(m => m.id === req.params.id);\n  if (index === -1) return res.status(404).json({ error: 'Message not found' });\n  \n  demoStore.supportMessages[index] = { ...demoStore.supportMessages[index], ...req.body };\n  saveDemoStore();\n  res.json(demoStore.supportMessages[index]);\n});\n\n// DELETE support message\napp.delete('/api/demo/support-messages/:id', (req, res) => {\n  if (!demoStore.supportMessages) demoStore.supportMessages = [];\n  \n  const index = demoStore.supportMessages.findIndex(m => m.id === req.params.id);\n  if (index === -1) return res.status(404).json({ error: 'Message not found' });\n  \n  demoStore.supportMessages.splice(index, 1);\n  saveDemoStore();\n  res.json({ success: true });\n});\n\n// ============================================================================\n// USERS (for staff management)\n// ============================================================================\n\n// GET users\n// 🔒 SEGURANÇA: NÃO expor passwordHash nas respostas\napp.get('/api/demo/users', async (req, res) => {\n  try {\n    let users = [];\n    \n    // Buscar utilizadores da base de dados PostgreSQL\n    if (req.query.business_id && req.query.is_staff_member !== undefined) {\n      const isStaff = req.query.is_staff_member === 'true' || req.query.is_staff_member === true;\n      users = await db.query.users.findMany({\n        where: (user, { eq, and }) => and(\n          eq(user.businessId, req.query.business_id),\n          eq(user.isStaffMember, isStaff)\n        )\n      });\n    } else if (req.query.email) {\n      const user = await db.query.users.findFirst({\n        where: (user, { eq }) => eq(user.email, req.query.email)\n      });\n      users = user ? [user] : [];\n    } else {\n      users = await db.query.users.findMany();\n    }\n    \n    // 🔒 SEGURANÇA: Remover passwordHash dos resultados (SEM quebrar outros campos)\n    const sanitizedUsers = users.map(user => {\n      const { passwordHash, ...userWithoutPassword } = user;\n      return userWithoutPassword;\n    });\n    \n    res.json(sanitizedUsers);\n  } catch (error) {\n    logger.error('Erro ao buscar utilizadores:', error);\n    res.status(500).json({ error: 'Erro ao buscar utilizadores' });\n  }\n});\n\n// PUT update user\napp.put('/api/demo/users/:id', async (req, res) => {\n  try {\n    const updated = await db.update(users)\n      .set({\n        ...req.body,\n        updatedAt: new Date()\n      })\n      .where(eq(users.id, req.params.id))\n      .returning();\n    \n    if (updated.length === 0) {\n      return res.status(404).json({ error: 'User not found' });\n    }\n    \n    res.json(updated[0]);\n  } catch (error) {\n    console.error('Erro ao atualizar utilizador:', error);\n    res.status(500).json({ error: 'Erro ao atualizar utilizador' });\n  }\n});\n\n// DELETE user\napp.delete('/api/demo/users/:id', async (req, res) => {\n  try {\n    const deleted = await db.delete(users)\n      .where(eq(users.id, req.params.id))\n      .returning();\n    \n    if (deleted.length === 0) {\n      return res.status(404).json({ error: 'User not found' });\n    }\n    \n    res.json({ success: true });\n  } catch (error) {\n    console.error('Erro ao apagar utilizador:', error);\n    res.status(500).json({ error: 'Erro ao apagar utilizador' });\n  }\n});\n\n// ============================================================================\n// OBJECT STORAGE (uploads permanentes)\n// ============================================================================\n\n// Endpoint para obter URL de upload (presigned URL)\napp.post('/api/objects/upload', async (req, res) => {\n  try {\n    const { filename = 'image.jpg' } = req.body;\n    const { uploadURL, objectPath } = await objectStorageService.getUploadURL(filename);\n    res.json({ uploadURL, objectPath });\n  } catch (error) {\n    console.error('Erro ao obter URL de upload:', error);\n    \n    if (error.message?.includes('PRIVATE_OBJECT_DIR')) {\n      return res.status(503).json({ \n        error: 'Object Storage não configurado. Use o upload local.',\n        fallback: true\n      });\n    }\n    \n    res.status(500).json({ error: 'Erro ao obter URL de upload' });\n  }\n});\n\n// Endpoint para servir objectos do Object Storage\napp.get(/^\\/objects\\/(.+)$/, async (req, res) => {\n  // ✅ CAPACITOR FIX: Adicionar headers CORS para apps móveis\n  res.setHeader('Access-Control-Allow-Origin', '*');\n  res.setHeader('Access-Control-Allow-Methods', 'GET, OPTIONS');\n  res.setHeader('Access-Control-Allow-Headers', 'Content-Type');\n  res.setHeader('Cross-Origin-Resource-Policy', 'cross-origin');\n  res.setHeader('Cache-Control', 'public, max-age=3600');\n  \n  try {\n    const objectPath = req.path;\n    const objectFile = await objectStorageService.getObjectFile(objectPath);\n    await objectStorageService.downloadObject(objectFile, res);\n  } catch (error) {\n    if (error instanceof ObjectNotFoundError) {\n      return res.status(404).json({ error: 'Ficheiro não encontrado' });\n    }\n    console.error('Erro ao servir objeto:', error);\n    res.status(500).json({ error: 'Erro ao servir ficheiro' });\n  }\n});\n\n// ============================================================================\n// UPLOAD DE IMAGENS (fallback local + Object Storage)\n// ============================================================================\n\n// ✅ UPLOAD SEGURO: Valida MAGIC NUMBERS (não apenas MIME type)\napp.post('/api/upload', upload.single('file'), async (req, res) => {\n  try {\n    if (!req.file) {\n      return res.status(400).json({ error: 'Nenhum ficheiro foi enviado' });\n    }\n\n    // 🔒 VALIDAÇÃO DE CONTEÚDO REAL (magic numbers)\n    const buffer = fs.readFileSync(req.file.path);\n    const fileType = await fileTypeFromBuffer(buffer);\n    \n    const allowedMimeTypes = ['image/jpeg', 'image/png', 'image/gif', 'image/webp'];\n    \n    if (!fileType || !allowedMimeTypes.includes(fileType.mime)) {\n      // ❌ Ficheiro malicioso detectado - apagar imediatamente\n      fs.unlinkSync(req.file.path);\n      logSecurityEvent('MALICIOUS_FILE_UPLOAD', {\n        ip: req.ip,\n        filename: req.file.originalname,\n        detectedMime: fileType?.mime || 'unknown',\n        uploadedMime: req.file.mimetype\n      });\n      return res.status(400).json({ \n        error: 'Tipo de ficheiro não permitido. Apenas imagens são aceites.' \n      });\n    }\n\n    const fileUrl = `/uploads/${req.file.filename}`;\n    \n    safeLog('✅ Ficheiro validado e carregado:', {\n      filename: req.file.filename,\n      size: req.file.size,\n      realType: fileType.mime\n    });\n\n    res.json({\n      success: true,\n      file_url: fileUrl,\n      filename: req.file.filename,\n      size: req.file.size,\n      mimetype: fileType.mime\n    });\n  } catch (error) {\n    logger.error('Upload error:', error);\n    res.status(500).json({ error: 'Erro ao fazer upload do ficheiro' });\n  }\n});\n\n// Endpoint para apagar imagem\napp.delete('/api/delete-image', (req, res) => {\n  try {\n    const { fileUrl } = req.body;\n    \n    if (!fileUrl) {\n      return res.status(400).json({ error: 'URL do ficheiro não fornecido' });\n    }\n\n    // Extrair nome do ficheiro da URL\n    const filename = path.basename(fileUrl);\n    const filePath = path.join(UPLOADS_DIR, filename);\n\n    // Verificar se o ficheiro existe\n    if (fs.existsSync(filePath)) {\n      fs.unlinkSync(filePath);\n      console.log('✅ Ficheiro apagado:', filename);\n      res.json({ success: true, message: 'Ficheiro apagado com sucesso' });\n    } else {\n      res.status(404).json({ error: 'Ficheiro não encontrado' });\n    }\n  } catch (error) {\n    console.error('❌ Erro ao apagar ficheiro:', error);\n    res.status(500).json({ error: error.message || 'Erro ao apagar ficheiro' });\n  }\n});\n\n// ============================================================================\n// TRADUÇÃO COM GOOGLE TRANSLATE API\n// ============================================================================\n\n// ✅ Rate limiter específico para traduções (muito generoso para desenvolvimento)\nconst translateLimiter = rateLimit({\n  windowMs: 1 * 60 * 1000, // 1 minuto\n  max: 3000, // ✅ AUMENTADO: 3000 req/min para suportar muitas traduções simultâneas\n  message: 'Muitas requisições de tradução. Tente novamente em 1 minuto.',\n  standardHeaders: true,\n  legacyHeaders: false,\n});\n\napp.post('/api/translate', translateLimiter, async (req, res) => {\n  try {\n    const { text, texts, targetLang, sourceLang } = req.body;\n\n    if (!targetLang || typeof targetLang !== 'string' || targetLang.length !== 2) {\n      return res.status(400).json({ error: 'targetLang é obrigatório e deve ser um código de idioma de 2 letras' });\n    }\n\n    if (text !== undefined) {\n      if (typeof text !== 'string') {\n        return res.status(400).json({ error: 'text deve ser uma string' });\n      }\n      if (text.length > 5000) {\n        return res.status(400).json({ error: 'text excede o limite de 5000 caracteres' });\n      }\n      const translation = await translateText(text, targetLang, sourceLang);\n      return res.json({ translation });\n    }\n\n    if (texts !== undefined) {\n      if (!Array.isArray(texts)) {\n        return res.status(400).json({ error: 'texts deve ser um array' });\n      }\n      if (texts.length > 100) {\n        return res.status(400).json({ error: 'texts excede o limite de 100 elementos' });\n      }\n      if (!texts.every(t => typeof t === 'string' && t.length <= 5000)) {\n        return res.status(400).json({ error: 'todos os elementos de texts devem ser strings com no máximo 5000 caracteres' });\n      }\n      const translations = await translateBatch(texts, targetLang, sourceLang);\n      return res.json({ translations });\n    }\n\n    return res.status(400).json({ error: 'text ou texts é obrigatório' });\n  } catch (error) {\n    logger.error('Translation endpoint error:', error);\n    res.status(500).json({ error: 'Erro ao traduzir texto' });\n  }\n});\n\napp.post('/api/translate/detect', translateLimiter, async (req, res) => {\n  try {\n    const { text } = req.body;\n\n    if (!text) {\n      return res.status(400).json({ error: 'text é obrigatório' });\n    }\n\n    const language = await detectLanguage(text);\n    res.json({ language });\n  } catch (error) {\n    logger.error('Language detection endpoint error:', error);\n    res.status(500).json({ error: 'Erro ao detectar idioma' });\n  }\n});\n\n// ================== GOOGLE PLACES PROXY (Capacitor iOS/Android) ==================\n// O WebView do Capacitor tem CORS restrito, então precisamos de um proxy no backend\n\n// Rate limiter específico para Places API (mais restritivo)\nconst placesRateLimiter = rateLimit({\n  windowMs: 60 * 1000, // 1 minuto\n  max: 60, // 60 requests por minuto por IP\n  message: { error: 'Muitas pesquisas de moradas. Aguarde um minuto.' },\n  standardHeaders: true,\n  legacyHeaders: false\n});\n\n// GET /api/places/autocomplete - Proxy para Google Places Autocomplete\n// Com fallback para OpenStreetMap/Nominatim quando Google falha\napp.get('/api/places/autocomplete', placesRateLimiter, async (req, res) => {\n  try {\n    const { input, country } = req.query;\n    \n    // Validação robusta do input - SEMPRE retornar estrutura consistente\n    if (!input || typeof input !== 'string') {\n      return res.json({ predictions: [], status: 'INVALID_INPUT' });\n    }\n    \n    const sanitizedInput = input.trim().slice(0, 200);\n    if (sanitizedInput.length < 2) {\n      return res.json({ predictions: [], status: 'INPUT_TOO_SHORT' });\n    }\n    \n    // Validar country code (2 letras)\n    const sanitizedCountry = (country && typeof country === 'string') \n      ? country.slice(0, 2).toLowerCase().replace(/[^a-z]/g, '') \n      : 'pt';\n    \n    // Tentar Google primeiro (chave sem restrições de referrer)\n    const serverApiKey = process.env.GOOGLE_PLACES_API_KEY || process.env.VITE_GOOGLE_MAPS_API_KEY;\n    \n    if (serverApiKey) {\n      try {\n        const url = `https://maps.googleapis.com/maps/api/place/autocomplete/json?input=${encodeURIComponent(sanitizedInput)}&types=address&components=country:${sanitizedCountry}&key=${serverApiKey}`;\n        const response = await fetch(url);\n        const data = await response.json();\n        \n        if (data.status === 'OK' && data.predictions) {\n          const normalizedPredictions = data.predictions.map(p => ({\n            place_id: p.place_id,\n            description: p.description,\n            structured_formatting: p.structured_formatting\n          }));\n          return res.json({ predictions: normalizedPredictions, status: 'OK', source: 'google' });\n        } else if (data.status === 'REQUEST_DENIED') {\n          logger.warn('Google Places API denied - using fallback. Error:', data.error_message);\n        } else if (data.status !== 'ZERO_RESULTS') {\n          logger.warn('Google Places API status:', data.status);\n        }\n      } catch (googleError) {\n        logger.warn('Google Places API failed, using OpenStreetMap fallback:', googleError.message);\n      }\n    }\n    \n    // Fallback para OpenStreetMap/Nominatim (gratuito, sem API key)\n    logger.info('Using OpenStreetMap/Nominatim for address search');\n    \n    // Converter country code para código de país Nominatim\n    const countryCodesMap = {\n      'pt': 'pt', 'br': 'br', 'es': 'es', 'fr': 'fr', 'de': 'de', \n      'it': 'it', 'gb': 'gb', 'uk': 'gb', 'us': 'us', 'nl': 'nl'\n    };\n    const nominatimCountry = countryCodesMap[sanitizedCountry] || sanitizedCountry;\n    \n    const nominatimUrl = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(sanitizedInput)}&countrycodes=${nominatimCountry}&addressdetails=1&limit=5`;\n    \n    const nominatimResponse = await fetch(nominatimUrl, {\n      headers: { 'User-Agent': 'QZero-App/1.8.3' }\n    });\n    \n    if (!nominatimResponse.ok) {\n      logger.error('Nominatim API HTTP error:', nominatimResponse.status);\n      return res.json({ predictions: [], status: 'HTTP_ERROR', error: 'Serviço de pesquisa indisponível' });\n    }\n    \n    const nominatimData = await nominatimResponse.json();\n    \n    if (!nominatimData || nominatimData.length === 0) {\n      return res.json({ predictions: [], status: 'ZERO_RESULTS' });\n    }\n    \n    // Converter formato Nominatim para formato compatível com Google Places\n    const normalizedPredictions = nominatimData.map(item => ({\n      place_id: `osm_${item.osm_type}_${item.osm_id}`,\n      description: item.display_name,\n      structured_formatting: {\n        main_text: item.address?.road || item.address?.city || item.name || '',\n        secondary_text: [\n          item.address?.city || item.address?.town || item.address?.village || '',\n          item.address?.state || item.address?.region || '',\n          item.address?.country || ''\n        ].filter(Boolean).join(', ')\n      },\n      osm_data: {\n        lat: parseFloat(item.lat),\n        lng: parseFloat(item.lon),\n        address: item.address\n      }\n    }));\n    \n    res.json({ predictions: normalizedPredictions, status: 'OK', source: 'openstreetmap' });\n  } catch (error) {\n    logger.error('Places autocomplete proxy error:', error);\n    res.json({ predictions: [], status: 'ERROR', error: 'Erro ao pesquisar moradas' });\n  }\n});\n\n// GET /api/places/details - Proxy para Google Places Details\n// Suporta place_ids do Google (ChIJ...) e OpenStreetMap (osm_*)\napp.get('/api/places/details', placesRateLimiter, async (req, res) => {\n  try {\n    const { place_id, osm_lat, osm_lng, osm_address } = req.query;\n    \n    // Validação robusta do place_id\n    if (!place_id || typeof place_id !== 'string') {\n      return res.json({ result: null, status: 'INVALID_INPUT', error: 'place_id é obrigatório' });\n    }\n    \n    const sanitizedPlaceId = place_id.trim().slice(0, 300);\n    \n    // Verificar se é um place_id do OpenStreetMap (fallback)\n    if (sanitizedPlaceId.startsWith('osm_')) {\n      // Para OSM, os dados já foram passados via query params do autocomplete\n      const lat = osm_lat ? parseFloat(osm_lat) : null;\n      const lng = osm_lng ? parseFloat(osm_lng) : null;\n      let addressData = null;\n      \n      try {\n        if (osm_address) {\n          addressData = JSON.parse(decodeURIComponent(osm_address));\n        }\n      } catch (e) {\n        logger.warn('Failed to parse OSM address data');\n      }\n      \n      // Se temos coordenadas, fazer reverse geocode para obter detalhes completos\n      if (lat && lng) {\n        const nominatimUrl = `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&zoom=18&addressdetails=1`;\n        \n        const nominatimResponse = await fetch(nominatimUrl, {\n          headers: { 'User-Agent': 'QZero-App/1.8.3' }\n        });\n        \n        if (nominatimResponse.ok) {\n          const nominatimData = await nominatimResponse.json();\n          \n          if (nominatimData && nominatimData.address) {\n            const addr = nominatimData.address;\n            const addressComponents = [];\n            \n            if (addr.house_number) {\n              addressComponents.push({ long_name: addr.house_number, short_name: addr.house_number, types: ['street_number'] });\n            }\n            if (addr.road || addr.street) {\n              const street = addr.road || addr.street;\n              addressComponents.push({ long_name: street, short_name: street, types: ['route'] });\n            }\n            if (addr.city || addr.town || addr.village || addr.municipality) {\n              const city = addr.city || addr.town || addr.village || addr.municipality;\n              addressComponents.push({ long_name: city, short_name: city, types: ['locality', 'political'] });\n            }\n            if (addr.state || addr.region || addr.county) {\n              const district = addr.state || addr.region || addr.county;\n              addressComponents.push({ long_name: district, short_name: district, types: ['administrative_area_level_1', 'political'] });\n            }\n            if (addr.postcode) {\n              addressComponents.push({ long_name: addr.postcode, short_name: addr.postcode, types: ['postal_code'] });\n            }\n            if (addr.country) {\n              const countryCode = addr.country_code ? addr.country_code.toUpperCase() : '';\n              addressComponents.push({ long_name: addr.country, short_name: countryCode, types: ['country', 'political'] });\n            }\n            \n            return res.json({\n              result: {\n                address_components: addressComponents,\n                formatted_address: nominatimData.display_name || '',\n                geometry: { location: { lat, lng } }\n              },\n              status: 'OK',\n              source: 'openstreetmap'\n            });\n          }\n        }\n      }\n      \n      // Fallback se não conseguiu obter detalhes\n      return res.json({ result: null, status: 'NOT_FOUND', error: 'Detalhes não disponíveis' });\n    }\n    \n    // Place_id do Google - validar formato\n    if (sanitizedPlaceId.length < 10 || !/^[a-zA-Z0-9_-]+$/.test(sanitizedPlaceId)) {\n      return res.json({ result: null, status: 'INVALID_PLACE_ID', error: 'place_id inválido' });\n    }\n    \n    // Tentar Google (chave sem restrições de referrer)\n    const serverApiKey = process.env.GOOGLE_PLACES_API_KEY || process.env.VITE_GOOGLE_MAPS_API_KEY;\n    \n    if (!serverApiKey) {\n      logger.error('Google Maps API key não configurada');\n      return res.json({ result: null, status: 'CONFIG_ERROR', error: 'Serviço não configurado' });\n    }\n    \n    const url = `https://maps.googleapis.com/maps/api/place/details/json?place_id=${encodeURIComponent(sanitizedPlaceId)}&fields=address_components,geometry,formatted_address&key=${serverApiKey}`;\n    \n    const response = await fetch(url);\n    \n    if (!response.ok) {\n      logger.error('Google Places Details API HTTP error:', response.status);\n      return res.json({ result: null, status: 'HTTP_ERROR', error: 'Google API unavailable' });\n    }\n    \n    const data = await response.json();\n    \n    if (data.status !== 'OK') {\n      logger.warn('Google Places Details API status:', data.status);\n      return res.json({ result: null, status: data.status || 'UNKNOWN_ERROR' });\n    }\n    \n    const place = data.result || {};\n    res.json({\n      result: {\n        address_components: place.address_components || [],\n        formatted_address: place.formatted_address || '',\n        geometry: place.geometry ? {\n          location: {\n            lat: place.geometry.location?.lat,\n            lng: place.geometry.location?.lng\n          }\n        } : null\n      },\n      status: 'OK',\n      source: 'google'\n    });\n  } catch (error) {\n    logger.error('Places details proxy error:', error);\n    res.json({ result: null, status: 'ERROR', error: 'Erro ao obter detalhes da morada' });\n  }\n});\n\n// GET /api/places/reverse-geocode - Converter coordenadas GPS em morada\n// Com fallback para OpenStreetMap/Nominatim quando Google falha\napp.get('/api/places/reverse-geocode', placesRateLimiter, async (req, res) => {\n  try {\n    const { lat, lng } = req.query;\n    \n    if (!lat || !lng) {\n      return res.json({ result: null, status: 'INVALID_INPUT', error: 'Coordenadas são obrigatórias' });\n    }\n    \n    const latitude = parseFloat(lat);\n    const longitude = parseFloat(lng);\n    \n    if (isNaN(latitude) || isNaN(longitude)) {\n      return res.json({ result: null, status: 'INVALID_INPUT', error: 'Coordenadas inválidas' });\n    }\n    \n    // Tentar Google primeiro (chave sem restrições de referrer)\n    const serverApiKey = process.env.GOOGLE_PLACES_API_KEY || process.env.VITE_GOOGLE_MAPS_API_KEY;\n    \n    if (serverApiKey) {\n      try {\n        const url = `https://maps.googleapis.com/maps/api/geocode/json?latlng=${latitude},${longitude}&key=${serverApiKey}&language=pt`;\n        const response = await fetch(url);\n        \n        if (response.ok) {\n          const data = await response.json();\n          if (data.status === 'OK' && data.results && data.results.length > 0) {\n            const place = data.results[0];\n            return res.json({\n              result: {\n                address_components: place.address_components || [],\n                formatted_address: place.formatted_address || '',\n                geometry: { location: { lat: latitude, lng: longitude } }\n              },\n              status: 'OK',\n              source: 'google'\n            });\n          }\n        }\n      } catch (googleError) {\n        logger.warn('Google Geocoding failed, using OpenStreetMap fallback:', googleError.message);\n      }\n    }\n    \n    // Fallback para OpenStreetMap/Nominatim (gratuito, sem API key)\n    logger.info('Using OpenStreetMap/Nominatim for reverse geocoding');\n    const nominatimUrl = `https://nominatim.openstreetmap.org/reverse?format=json&lat=${latitude}&lon=${longitude}&zoom=18&addressdetails=1`;\n    \n    const nominatimResponse = await fetch(nominatimUrl, {\n      headers: { 'User-Agent': 'QZero-App/1.8.3' }\n    });\n    \n    if (!nominatimResponse.ok) {\n      logger.error('Nominatim API HTTP error:', nominatimResponse.status);\n      return res.json({ result: null, status: 'HTTP_ERROR', error: 'Serviço de geocoding indisponível' });\n    }\n    \n    const nominatimData = await nominatimResponse.json();\n    \n    if (!nominatimData || !nominatimData.address) {\n      return res.json({ result: null, status: 'ZERO_RESULTS', error: 'Morada não encontrada' });\n    }\n    \n    // Converter formato Nominatim para formato compatível com Google\n    const addr = nominatimData.address;\n    const addressComponents = [];\n    \n    // Street number\n    if (addr.house_number) {\n      addressComponents.push({ long_name: addr.house_number, short_name: addr.house_number, types: ['street_number'] });\n    }\n    \n    // Street name\n    const streetName = addr.road || addr.street || addr.pedestrian || addr.footway || '';\n    if (streetName) {\n      addressComponents.push({ long_name: streetName, short_name: streetName, types: ['route'] });\n    }\n    \n    // City\n    const city = addr.city || addr.town || addr.village || addr.municipality || addr.hamlet || '';\n    if (city) {\n      addressComponents.push({ long_name: city, short_name: city, types: ['locality', 'political'] });\n    }\n    \n    // District/State\n    const district = addr.state || addr.region || addr.county || addr.state_district || '';\n    if (district) {\n      addressComponents.push({ long_name: district, short_name: district, types: ['administrative_area_level_1', 'political'] });\n    }\n    \n    // Postal code\n    if (addr.postcode) {\n      addressComponents.push({ long_name: addr.postcode, short_name: addr.postcode, types: ['postal_code'] });\n    }\n    \n    // Country\n    if (addr.country) {\n      const countryCode = addr.country_code ? addr.country_code.toUpperCase() : '';\n      addressComponents.push({ long_name: addr.country, short_name: countryCode, types: ['country', 'political'] });\n    }\n    \n    const formattedAddress = nominatimData.display_name || '';\n    \n    res.json({\n      result: {\n        address_components: addressComponents,\n        formatted_address: formattedAddress,\n        geometry: { location: { lat: latitude, lng: longitude } }\n      },\n      status: 'OK',\n      source: 'openstreetmap'\n    });\n  } catch (error) {\n    logger.error('Reverse geocode error:', error);\n    res.json({ result: null, status: 'ERROR', error: 'Erro ao converter coordenadas' });\n  }\n});\n\n// POST /api/geocode-address - Geocoding de endereço para coordenadas usando Google Maps Geocoding API\n// Converte um endereço em coordenadas GPS precisas\napp.post('/api/geocode-address', placesRateLimiter, async (req, res) => {\n  try {\n    const { address, city, postalCode, country } = req.body;\n    \n    // Validação\n    if (!address || typeof address !== 'string') {\n      return res.status(400).json({ error: 'Endereço é obrigatório' });\n    }\n    \n    // Construir endereço completo para geocoding\n    const addressParts = [address.trim()];\n    if (postalCode) addressParts.push(postalCode.trim());\n    if (city) addressParts.push(city.trim());\n    if (country) addressParts.push(country.trim());\n    \n    const fullAddress = addressParts.join(', ');\n    \n    logger.info('Geocoding address:', { fullAddress });\n    \n    // Usar Google Maps Geocoding API\n    const apiKey = process.env.GOOGLE_PLACES_API_KEY || process.env.VITE_GOOGLE_MAPS_API_KEY;\n    \n    if (!apiKey) {\n      logger.error('Google Maps API key não configurada');\n      return res.status(500).json({ error: 'Serviço de geocoding não configurado' });\n    }\n    \n    const url = `https://maps.googleapis.com/maps/api/geocode/json?address=${encodeURIComponent(fullAddress)}&key=${apiKey}`;\n    \n    const response = await fetch(url);\n    \n    if (!response.ok) {\n      logger.error('Google Geocoding API HTTP error:', response.status);\n      return res.status(502).json({ error: 'Erro ao comunicar com Google Maps' });\n    }\n    \n    const data = await response.json();\n    \n    if (data.status === 'REQUEST_DENIED') {\n      logger.error('Google Geocoding API denied:', data.error_message);\n      return res.status(403).json({ error: 'API key inválida' });\n    }\n    \n    if (data.status === 'ZERO_RESULTS') {\n      logger.warn('Geocoding: nenhum resultado para:', fullAddress);\n      return res.status(404).json({ error: 'Endereço não encontrado' });\n    }\n    \n    if (data.status !== 'OK' || !data.results || data.results.length === 0) {\n      logger.warn('Geocoding status:', data.status);\n      return res.status(400).json({ error: 'Não foi possível geocodificar o endereço' });\n    }\n    \n    // Pegar o primeiro resultado (mais relevante)\n    const result = data.results[0];\n    const location = result.geometry?.location;\n    \n    if (!location || !location.lat || !location.lng) {\n      return res.status(400).json({ error: 'Coordenadas não encontradas' });\n    }\n    \n    // Determinar precisão baseada no location_type\n    // ROOFTOP = exato, RANGE_INTERPOLATED = aproximado, GEOMETRIC_CENTER = centro, APPROXIMATE = aproximado\n    const locationType = result.geometry?.location_type || 'UNKNOWN';\n    let precision = 'approximate';\n    if (locationType === 'ROOFTOP') precision = 'exact';\n    else if (locationType === 'RANGE_INTERPOLATED') precision = 'interpolated';\n    else if (locationType === 'GEOMETRIC_CENTER') precision = 'center';\n    \n    logger.info('Geocoding successful:', {\n      lat: location.lat,\n      lng: location.lng,\n      precision,\n      locationType,\n      formattedAddress: result.formatted_address\n    });\n    \n    res.json({\n      lat: location.lat,\n      lng: location.lng,\n      precision,\n      locationType,\n      formattedAddress: result.formatted_address\n    });\n    \n  } catch (error) {\n    logger.error('Geocode address error:', error);\n    res.status(500).json({ error: 'Erro interno no geocoding' });\n  }\n});\n\n// ================== SUPORTE - FORMULÁRIO DE CONTACTO ==================\napp.post('/api/public/support/contact', async (req, res) => {\n  try {\n    const { name, email, subject, message } = req.body;\n\n    if (!name || !email || !message) {\n      return res.status(400).json({ error: 'Nome, email e mensagem são obrigatórios' });\n    }\n\n    // Validar email\n    const emailRegex = /^[^\\s@]+@[^\\s@]+\\.[^\\s@]+$/;\n    if (!emailRegex.test(email)) {\n      return res.status(400).json({ error: 'Email inválido' });\n    }\n\n    logger.info('Support contact form submission', { name, email, subject });\n\n    // Enviar email via Resend\n    const hostname = process.env.REPLIT_DEV_DOMAIN || process.env.REPLIT_DOMAINS?.split(',')[0];\n    const xReplitToken = process.env.REPLIT_IDENTITY;\n\n    if (!hostname || !xReplitToken) {\n      logger.error('Resend not configured for support form');\n      return res.status(500).json({ error: 'Serviço de email não configurado' });\n    }\n\n    const connectionResponse = await fetch(\n      'https://' + hostname + '/api/v2/connection?include_secrets=true&connector_names=resend',\n      { headers: { 'X-Replit-Identity': xReplitToken } }\n    );\n\n    const connections = await connectionResponse.json();\n    const connectionSettings = connections.find(c => c.name === 'resend');\n\n    if (!connectionSettings?.settings?.api_key) {\n      logger.error('Resend API key not found');\n      return res.status(500).json({ error: 'Serviço de email não configurado' });\n    }\n\n    const { Resend } = await import('resend');\n    const resend = new Resend(connectionSettings.settings.api_key);\n\n    const subjectLine = subject || 'Contacto via QZero App';\n\n    await resend.emails.send({\n      from: 'QZero Suporte <onboarding@resend.dev>',\n      to: 'suporteqzero@gmail.com',\n      replyTo: email,\n      subject: `[QZero Suporte] ${subjectLine}`,\n      html: `\n        <div style=\"font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto;\">\n          <h2 style=\"color: #3b82f6;\">Nova Mensagem de Suporte</h2>\n          <div style=\"background: #f8fafc; padding: 20px; border-radius: 8px; margin: 20px 0;\">\n            <p><strong>Nome:</strong> ${name}</p>\n            <p><strong>Email:</strong> ${email}</p>\n            <p><strong>Assunto:</strong> ${subjectLine}</p>\n          </div>\n          <div style=\"background: #ffffff; padding: 20px; border: 1px solid #e2e8f0; border-radius: 8px;\">\n            <h3 style=\"color: #475569; margin-top: 0;\">Mensagem:</h3>\n            <p style=\"white-space: pre-wrap; color: #334155;\">${message}</p>\n          </div>\n          <p style=\"color: #94a3b8; font-size: 12px; margin-top: 20px;\">\n            Enviado via QZero App em ${new Date().toLocaleString('pt-PT')}\n          </p>\n        </div>\n      `\n    });\n\n    logger.info('Support email sent successfully', { to: 'suporteqzero@gmail.com', from: email });\n\n    res.json({ success: true, message: 'Mensagem enviada com sucesso' });\n\n  } catch (error) {\n    logger.error('Support contact form error:', error);\n    res.status(500).json({ error: 'Erro ao enviar mensagem' });\n  }\n});\n\napp.get('/health', (req, res) => {\n  res.json({ status: 'ok' });\n});\n\napp.get('/api/health', (req, res) => {\n  res.json({ \n    status: 'ok', \n    timestamp: new Date().toISOString(),\n    environment: IS_PRODUCTION ? 'production' : 'development',\n    version: '1.0.0'\n  });\n});\n\n// 🔥 Firebase/Push Notifications Diagnostic Endpoint\napp.get('/api/diagnostics/firebase', async (req, res) => {\n  try {\n    const diagnostics = {\n      timestamp: new Date().toISOString(),\n      firebase: {\n        configured: false,\n        projectId: null,\n        initialized: false,\n        error: null\n      },\n      deviceTokens: {\n        total: 0,\n        active: 0\n      }\n    };\n\n    // Check if Service Account is configured\n    const serviceAccountJson = process.env.FIREBASE_SERVICE_ACCOUNT_JSON;\n    if (serviceAccountJson) {\n      try {\n        const parsed = JSON.parse(serviceAccountJson);\n        diagnostics.firebase.configured = true;\n        diagnostics.firebase.projectId = parsed.project_id;\n        diagnostics.firebase.clientEmail = parsed.client_email ? '✅ Present' : '❌ Missing';\n        diagnostics.firebase.privateKey = parsed.private_key ? '✅ Present' : '❌ Missing';\n      } catch (parseError) {\n        diagnostics.firebase.error = 'Invalid JSON format: ' + parseError.message;\n      }\n    } else {\n      diagnostics.firebase.error = 'FIREBASE_SERVICE_ACCOUNT_JSON not configured';\n    }\n\n    // Check device tokens in database\n    try {\n      const allTokens = await db.select().from(deviceTokens);\n      const activeTokens = allTokens.filter(t => t.isActive);\n      diagnostics.deviceTokens.total = allTokens.length;\n      diagnostics.deviceTokens.active = activeTokens.length;\n    } catch (dbError) {\n      diagnostics.deviceTokens.error = dbError.message;\n    }\n\n    // Test Firebase initialization\n    try {\n      const admin = await import('firebase-admin');\n      const adminDefault = admin.default || admin;\n      if (adminDefault.apps && adminDefault.apps.length > 0) {\n        diagnostics.firebase.initialized = true;\n      } else if (diagnostics.firebase.configured && !diagnostics.firebase.error) {\n        try {\n          const serviceAccount = JSON.parse(serviceAccountJson);\n          adminDefault.initializeApp({\n            credential: adminDefault.credential.cert(serviceAccount),\n          });\n          diagnostics.firebase.initialized = true;\n        } catch (initError) {\n          diagnostics.firebase.error = 'Initialization failed: ' + initError.message;\n        }\n      }\n    } catch (adminError) {\n      diagnostics.firebase.error = 'Firebase Admin import error: ' + adminError.message;\n    }\n\n    res.json(diagnostics);\n  } catch (error) {\n    res.status(500).json({ error: error.message });\n  }\n});\n\n// 🛡️ API 404 HANDLER - Retorna JSON para rotas API não encontradas\n// CRÍTICO: Deve vir ANTES do catch-all do SPA para evitar retornar HTML\napp.use((req, res, next) => {\n  if (req.path.startsWith('/api/')) {\n    return res.status(404).json({\n      error: 'Endpoint não encontrado',\n      path: req.path,\n      method: req.method,\n      timestamp: new Date().toISOString()\n    });\n  }\n  next();\n});\n\n// 🛡️ ERROR HANDLER GLOBAL - DEVE SER O ÚLTIMO MIDDLEWARE\n// Captura TODOS os erros e esconde detalhes sensíveis em produção\napp.use(errorHandler);\n\n// ================== SERVIR FRONTEND EM PRODUÇÃO ==================\n// Em produção, servir o frontend compilado (dist/)\nif (IS_PRODUCTION) {\n  const distPath = path.join(__dirname, '../dist');\n  \n  console.log('🌐 Modo PRODUÇÃO: Servindo frontend de', distPath);\n  \n  // Servir ficheiros estáticos do build\n  app.use(express.static(distPath));\n  \n  // Todas as rotas não-API vão para o index.html (SPA routing)\n  app.use((req, res, next) => {\n    // Excluir rotas da API e uploads (estas já foram tratadas acima)\n    if (req.path.startsWith('/api/') || req.path.startsWith('/uploads/')) {\n      // Se chegou aqui, já foi tratado pelo 404 handler\n      return res.status(404).json({ error: 'Not found' });\n    }\n    \n    // Servir index.html para todas as outras rotas (SPA routing)\n    res.sendFile(path.join(distPath, 'index.html'));\n  });\n  \n  console.log('✅ Frontend e API servindo em: waitless-qzero.com (same-origin)');\n} else {\n  console.log('🔧 Modo DESENVOLVIMENTO: Frontend servido via Vite (porta 5000)');\n}\n\n// ✅ SCHEDULER: Enviar lembretes de marcação 24h antes\nasync function sendAppointmentReminders() {\n  try {\n    const now = new Date();\n    const tomorrow = new Date(now);\n    tomorrow.setDate(tomorrow.getDate() + 1);\n    \n    // Formatar data de amanhã no formato YYYY-MM-DD\n    const tomorrowStr = tomorrow.toISOString().split('T')[0];\n    \n    // Buscar marcações para amanhã que estão confirmadas e não tiveram lembrete enviado\n    const upcomingAppointments = await db.select()\n      .from(appointments)\n      .where(and(\n        eq(appointments.appointmentDate, tomorrowStr),\n        eq(appointments.status, 'confirmado'),\n        eq(appointments.reminderSent, false)\n      ));\n    \n    console.log(`⏰ Verificando lembretes de marcação: ${upcomingAppointments.length} marcações para amanhã`);\n    \n    for (const appointment of upcomingAppointments) {\n      try {\n        // Buscar dados da empresa\n        let businessName = 'QZero';\n        try {\n          const [company] = await db.select().from(companyProfiles).where(eq(companyProfiles.id, appointment.businessId));\n          if (company) {\n            businessName = company.companyName;\n          }\n        } catch (e) {\n          console.log('⚠️ Empresa não encontrada para lembrete');\n        }\n        \n        // Encontrar userId pelo email\n        if (appointment.userEmail) {\n          const user = await db.query.users.findFirst({\n            where: eq(users.email, appointment.userEmail.toLowerCase())\n          });\n          \n          if (user) {\n            // Enviar push notification\n            await pushNotificationService.sendAppointmentReminderNotification(\n              user.id,\n              appointment.serviceName || 'Serviço',\n              businessName,\n              tomorrowStr,\n              appointment.appointmentTime\n            );\n            \n            // Marcar lembrete como enviado\n            await db.update(appointments)\n              .set({ reminderSent: true })\n              .where(eq(appointments.id, appointment.id));\n            \n            console.log(`📬 Lembrete de marcação enviado para: ${appointment.userEmail} (${appointment.appointmentTime})`);\n          }\n        }\n      } catch (error) {\n        console.error(`❌ Erro ao enviar lembrete para ${appointment.userEmail}:`, error);\n      }\n    }\n  } catch (error) {\n    console.error('❌ Erro no scheduler de lembretes:', error);\n  }\n}\n\n// Executar verificação de lembretes a cada hora\nsetInterval(sendAppointmentReminders, 60 * 60 * 1000);\n\n// Executar uma vez ao iniciar o servidor\nsetTimeout(sendAppointmentReminders, 10000);\n\nconst PORT = process.env.PORT || 3001;\napp.listen(PORT, () => {\n  console.log(`🚀 Server running on port ${PORT}`);\n  console.log(`📍 Demo API available at http://localhost:${PORT}/api/demo/`);\n  console.log(`🔐 Auth endpoints: /api/auth/*`);\n  console.log(`💳 Stripe endpoints: /api/*stripe*`);\n  console.log(`⏰ Appointment reminders scheduler: Active (checks every hour)`);\n  if (IS_PRODUCTION) {\n    console.log(`🌐 Frontend servindo de: dist/`);\n  }\n});\n\nexport default app;\n","path":null,"size_bytes":219275,"size_tokens":null},"src/utils/validation.js":{"content":"export const validateEmail = (email) => {\n  const re = /^[^\\s@]+@[^\\s@]+\\.[^\\s@]+$/;\n  return re.test(email);\n};\n\nexport const validateVAT = (vat, country = 'PT') => {\n  if (!vat) return true;\n  \n  vat = vat.replace(/\\s/g, '');\n  \n  if (country === 'PT' || country === 'Portugal') {\n    const ptVatRegex = /^PT\\d{9}$/i;\n    return ptVatRegex.test(vat) || /^\\d{9}$/.test(vat);\n  }\n  \n  return vat.length >= 5;\n};\n\nexport const validatePostalCode = (postalCode, country = 'PT') => {\n  if (!postalCode) return false;\n  \n  postalCode = postalCode.replace(/\\s/g, '');\n  \n  if (country === 'PT' || country === 'Portugal') {\n    const ptPostalCodeRegex = /^\\d{4}-?\\d{3}$/;\n    return ptPostalCodeRegex.test(postalCode);\n  }\n  \n  return postalCode.length >= 3;\n};\n\nexport const validatePhone = (phone) => {\n  if (!phone) return true;\n  \n  const phoneRegex = /^[+]?[\\d\\s-()]{9,}$/;\n  return phoneRegex.test(phone);\n};\n\nexport const validateCompanyProfile = (data) => {\n  const errors = {};\n  \n  if (!data.companyName || data.companyName.trim().length < 2) {\n    errors.companyName = 'Nome da empresa é obrigatório (mínimo 2 caracteres)';\n  }\n  \n  if (data.companyVAT && !validateVAT(data.companyVAT, data.companyCountry)) {\n    errors.companyVAT = 'NIF/VAT inválido';\n  }\n  \n  if (!data.companyCountry) {\n    errors.companyCountry = 'País é obrigatório';\n  }\n  \n  if (!data.companyDistrict || data.companyDistrict.trim().length < 2) {\n    errors.companyDistrict = 'Distrito/Região é obrigatório';\n  }\n  \n  if (!data.companyCity || data.companyCity.trim().length < 2) {\n    errors.companyCity = 'Cidade é obrigatória';\n  }\n  \n  if (!validatePostalCode(data.companyPostalCode, data.companyCountry)) {\n    errors.companyPostalCode = 'Código postal inválido';\n  }\n  \n  if (!data.companyStreetName || data.companyStreetName.trim().length < 2) {\n    errors.companyStreetName = 'Nome da rua é obrigatório';\n  }\n  \n  if (!data.companyDoorNumber || data.companyDoorNumber.trim().length < 1) {\n    errors.companyDoorNumber = 'Número da porta é obrigatório';\n  }\n  \n  if (data.companyPhone && !validatePhone(data.companyPhone)) {\n    errors.companyPhone = 'Telefone inválido';\n  }\n  \n  if (!data.companyEmail || !validateEmail(data.companyEmail)) {\n    errors.companyEmail = 'Email é obrigatório e deve ser válido';\n  }\n  \n  if (!data.companyCategory) {\n    errors.companyCategory = 'Categoria é obrigatória';\n  }\n  \n  if (!data.logoUrl) {\n    errors.logoUrl = 'Logótipo é obrigatório';\n  }\n  \n  return {\n    isValid: Object.keys(errors).length === 0,\n    errors\n  };\n};\n","path":null,"size_bytes":2579,"size_tokens":null},"src/components/business/PaymentPendingBanner.jsx":{"content":"import { Alert, AlertDescription } from '@/components/ui/alert';\nimport { Button } from '@/components/ui/button';\nimport { AlertCircle, CreditCard, Globe } from 'lucide-react';\nimport { useNavigate } from 'react-router-dom';\nimport { createPageUrl } from '@/utils';\nimport { useAutoTranslate } from '@/hooks/useTranslate';\nimport { isCapacitorApp } from '@/utils/apiConfig';\n\nexport function PaymentPendingBanner({ companyProfile }) {\n  const isNativeApp = isCapacitorApp();\n  \n  const txtPlanCancelled = useAutoTranslate('Plano Empresarial cancelado', 'pt');\n  const txtPlanPending = useAutoTranslate('Falta ativar o seu plano!', 'pt');\n  const txtReactivateMessage = useAutoTranslate('Reative o seu plano empresarial para continuar a ter acesso a todas as funcionalidades.', 'pt');\n  const txtActivateMessage = useAutoTranslate('Ative o plano (€49,99/mês) para desbloquear: Painel, Gestão de Senhas, Reporting e mais.', 'pt');\n  const txtReactivate = useAutoTranslate('Reativar Plano', 'pt');\n  const txtPayPlan = useAutoTranslate('Ativar Agora', 'pt');\n  \n  const txtMobileActivateMessage = useAutoTranslate('Para desbloquear tudo, compre o plano em waitless-qzero.com', 'pt');\n  const txtMobileReactivateMessage = useAutoTranslate('Para reativar, visite waitless-qzero.com', 'pt');\n  const txtMobileHint = useAutoTranslate('7 dias grátis + €19,99 (1º mês) + €49,99/mês', 'pt');\n\n  const navigate = useNavigate();\n\n  if (!companyProfile) {\n    return null;\n  }\n\n  const isCancelled = companyProfile.status === 'cancelled' || companyProfile.subscriptionStatus === 'canceled';\n  const isActive = companyProfile.status === 'active' && !isCancelled;\n  \n  if (isActive) {\n    return null;\n  }\n\n  const handlePayNow = () => {\n    navigate(createPageUrl('BusinessManageSubscription'));\n  };\n\n  return (\n    <Alert className=\"mb-4 border-amber-300 bg-amber-50 shadow-md\">\n      {isNativeApp ? (\n        <Globe className=\"h-5 w-5 text-amber-600\" />\n      ) : (\n        <AlertCircle className=\"h-5 w-5 text-amber-600\" />\n      )}\n      <AlertDescription className=\"flex flex-col gap-2\">\n        <div>\n          <p className=\"font-semibold text-amber-900\">\n            {isCancelled ? txtPlanCancelled : txtPlanPending}\n          </p>\n          <p className=\"text-sm text-amber-800\">\n            {isNativeApp \n              ? (isCancelled ? txtMobileReactivateMessage : txtMobileActivateMessage)\n              : (isCancelled ? txtReactivateMessage : txtActivateMessage)\n            }\n          </p>\n          {isNativeApp && (\n            <p className=\"text-xs text-amber-700 mt-1\">\n              {txtMobileHint}\n            </p>\n          )}\n        </div>\n        \n        {!isNativeApp && (\n          <Button\n            onClick={handlePayNow}\n            size=\"sm\"\n            className=\"w-fit bg-gradient-to-r from-amber-600 to-orange-600 hover:from-amber-700 hover:to-orange-700\"\n          >\n            <CreditCard className=\"w-4 h-4 mr-2\" />\n            {isCancelled ? txtReactivate : txtPayPlan}\n          </Button>\n        )}\n      </AlertDescription>\n    </Alert>\n  );\n}\n","path":null,"size_bytes":3085,"size_tokens":null},"src/utils/demoDataSeeder.js":{"content":"import { companyProfileStorage, CompanyProfile } from '@/models/companyProfile';\nimport { base44 } from '@/api/base44Client';\n\n// ✅ CONTROLE: Desabilitar dados demo para produção\n// Mudar para false para começar com base limpa\nconst ENABLE_DEMO_DATA = false;\n\nexport async function seedDemoCompanyProfile() {\n  if (!ENABLE_DEMO_DATA) {\n    return null;\n  }\n  \n  const demoEmail = 'demo@example.com';\n  \n  const existingProfile = companyProfileStorage.getByUserId(demoEmail);\n  if (existingProfile) {\n    console.log('Demo company profile already exists');\n    \n    // ✅ CORRIGIR SUBSCRIÇÃO AUTOMATICAMENTE se não existir válida\n    try {\n      const subs = await base44.entities.Subscription.filter({\n        user_email: demoEmail,\n        plan: 'business'\n      });\n      \n      const validSub = subs.find(s => \n        (s.status === 'active' || s.status === 'trialing') && \n        s.end_date && \n        s.created_date\n      );\n      \n      if (!validSub) {\n        console.log('⚠️ Subscrição inválida detectada - corrigindo automaticamente...');\n        \n        // Atualizar subscrições antigas para cancelled (em vez de deletar)\n        for (const sub of subs) {\n          try {\n            await base44.entities.Subscription.update(sub.id, {\n              status: 'cancelled',\n              auto_renew: false\n            });\n          } catch (err) {\n            console.warn('Não conseguiu cancelar subscrição antiga:', err.message);\n          }\n        }\n        \n        // Criar nova subscrição válida com trial\n        const now = new Date();\n        const trialEnd = new Date(now);\n        trialEnd.setDate(trialEnd.getDate() + 7); // +7 dias trial\n        \n        const endDate = new Date(trialEnd);\n        endDate.setMonth(endDate.getMonth() + 1); // +1 mês após trial\n        \n        await base44.entities.Subscription.create({\n          user_email: demoEmail,\n          plan: 'business',\n          status: 'trialing',\n          amount: 49.99,\n          currency: 'EUR',\n          payment_method: 'stripe',\n          stripe_subscription_id: `sub_trial_${Date.now()}`,\n          created_date: now.toISOString(),\n          trial_end_date: trialEnd.toISOString(),\n          end_date: endDate.toISOString(),\n          auto_renew: true\n        });\n        \n        console.log('✅ Subscrição demo criada com período de teste de 7 dias');\n      }\n    } catch (error) {\n      console.warn('⚠️ Não foi possível verificar/corrigir subscrição:', error.message);\n    }\n    \n    return existingProfile;\n  }\n  \n  const demoProfile = new CompanyProfile({\n    companyName: 'Clínica Saúde+',\n    companyVAT: 'PT123456789',\n    companyCountry: 'PT',\n    companyAddress: 'Rua da Saúde, 123',\n    companyCity: 'Lisboa',\n    companyPostalCode: '1000-100',\n    companyPhone: '+351912345678',\n    companyEmail: 'clinica@saudeplus.pt',\n    companyCategory: 'Clínica',\n    companyCoordinates: { lat: 38.7223, lng: -9.1393 },\n    adminUserId: demoEmail,\n    status: 'active',\n    subscriptionStatus: 'active',\n    subscriptionId: 'sub_demo_123',\n    stripeCustomerId: 'cus_demo_123'\n  });\n  \n  companyProfileStorage.save(demoProfile);\n  console.log('✅ Demo company profile seeded:', demoProfile.companyName);\n  \n  return demoProfile;\n}\n","path":null,"size_bytes":3276,"size_tokens":null},"src/services/businessAccessService.js":{"content":"import { companyProfileStorage, normalizeCategory, normalizeCountry } from '@/models/companyProfile';\nimport { base44 } from '@/api/base44Client';\n\n// 🎁 ACESSO VIP VITALÍCIO - Emails com acesso empresarial gratuito permanente\nconst VIP_EMAILS = [\n  // Lista vazia - nenhum email com acesso VIP atualmente\n];\n\nexport class BusinessAccessService {\n  async getUserBusinessAccess(user) {\n    const userEmail = user.email;\n    const userId = user.id;\n    const isStaff = user.is_staff_member === true;\n    const businessId = user.business_id;\n    \n    // 🎁 VIP CHECK: Acesso vitalício gratuito para emails especiais\n    if (VIP_EMAILS.includes(userEmail?.toLowerCase())) {\n      console.log('🎁 BusinessAccessService: VIP DETECTADO - Acesso vitalício gratuito:', userEmail);\n      \n      // Ainda tentar obter o perfil da empresa para dados completos\n      let companyProfile = null;\n      if (isStaff && businessId) {\n        companyProfile = await companyProfileStorage.get(businessId);\n      } else {\n        companyProfile = await companyProfileStorage.getByUserId(userId);\n      }\n      \n      return {\n        hasAccess: true,\n        isPending: false,\n        companyProfile: companyProfile,\n        source: 'vip_lifetime',\n        isVip: true\n      };\n    }\n    \n    console.log('🔍 BusinessAccessService: Procurando perfil para:', { \n      userId, \n      userEmail,\n      isStaff,\n      businessId\n    });\n    \n    let companyProfile = null;\n    \n    if (isStaff && businessId) {\n      console.log('👥 BusinessAccessService: Utilizador é funcionário - procurando por businessId');\n      companyProfile = await companyProfileStorage.get(businessId);\n    } else {\n      console.log('👤 BusinessAccessService: Utilizador é criador - procurando por userId');\n      companyProfile = await companyProfileStorage.getByUserId(userId);\n    }\n    \n    if (companyProfile) {\n      console.log('✅ BusinessAccessService: Perfil encontrado:', {\n        id: companyProfile.id,\n        name: companyProfile.companyName,\n        status: companyProfile.status,\n        subscriptionStatus: companyProfile.subscriptionStatus,\n        featuresEnabled: companyProfile.featuresEnabled\n      });\n      \n      // IMPORTANTE: Apenas sincronizar subscrição para o CRIADOR, não para staff\n      if (!isStaff) {\n        console.log('👤 BusinessAccessService: Sincronizando subscrição do criador');\n        await this.syncSubscription(companyProfile, userEmail);\n      } else {\n        console.log('👥 BusinessAccessService: Staff member - pulando sync de subscrição (herda acesso do criador)');\n      }\n      \n      // MIGRAÇÃO AUTOMÁTICA: Criar Business entity se não existir\n      // ⚠️ DESATIVADO: Business entities são LEGACY (não existem mais no sistema atual)\n      // await this.ensureBusinessEntityExists(companyProfile);\n      \n      // ❌ VERIFICAR EXPIRAÇÃO PRIMEIRO\n      const now = new Date();\n      const periodEnd = companyProfile.currentPeriodEnd ? new Date(companyProfile.currentPeriodEnd) : null;\n      const isExpired = companyProfile.subscriptionStatus === 'expired' || \n                        companyProfile.status === 'expired' ||\n                        (periodEnd && now > periodEnd);\n      \n      console.log('🔍 BusinessAccessService: Verificação de acesso:', {\n        email: userEmail,\n        status: companyProfile.status,\n        subscriptionStatus: companyProfile.subscriptionStatus,\n        currentPeriodEnd: companyProfile.currentPeriodEnd,\n        isExpired: isExpired\n      });\n      \n      // ❌ SE EXPIRADO, NÃO DAR ACESSO\n      if (isExpired) {\n        console.log('❌ BusinessAccessService: Subscrição EXPIRADA - sem acesso');\n        return {\n          hasAccess: false,\n          isPending: false,\n          companyProfile: companyProfile,\n          source: 'expired',\n          isExpired: true\n        };\n      }\n      \n      // ✅ CORRIGIDO: Dar acesso durante TRIAL, após ACTIVE, e subscrições canceladas com tempo restante\n      // subscriptionStatus = 'trialing' durante período de trial (2 dias)\n      // status = 'active' após primeiro pagamento bem-sucedido\n      // status = 'cancelled' mas com currentPeriodEnd no futuro = acesso mantido\n      let hasAccess = \n        companyProfile.status === 'active' || \n        companyProfile.subscriptionStatus === 'trialing';\n      \n      // ⏰ VERIFICAR SE SUBSCRIÇÃO CANCELADA AINDA TEM TEMPO RESTANTE\n      if (companyProfile.status === 'cancelled' && periodEnd && now < periodEnd) {\n        hasAccess = true; // ✅ Mantém acesso até fim do período pago\n        console.log('⏰ Subscrição cancelada mas ainda com acesso até:', periodEnd.toISOString());\n      }\n      \n      const isPending = \n        companyProfile.status === 'pending_payment' && \n        companyProfile.subscriptionStatus !== 'trialing'; // NÃO pending durante trial!\n      \n      const access = {\n        hasAccess: hasAccess,\n        isPending: isPending,\n        companyProfile: companyProfile,\n        source: 'companyProfile'\n      };\n      \n      console.log('📊 BusinessAccessService: Retornando acesso:', {\n        hasAccess: access.hasAccess,\n        isPending: access.isPending,\n        source: access.source\n      });\n      \n      return access;\n    }\n    \n    console.log('⚠️ BusinessAccessService: Nenhum perfil encontrado para', { userId, userEmail });\n    \n    // CRÍTICO: Se for staff member sem perfil, NÃO fazer fallback para subscrição\n    // Staff members NUNCA devem criar/consultar subscrições com seu próprio email\n    if (isStaff) {\n      console.log('❌ BusinessAccessService: Staff member sem perfil da empresa - acesso negado');\n      return {\n        hasAccess: false,\n        isPending: false,\n        companyProfile: null,\n        source: 'staff_no_profile'\n      };\n    }\n    \n    // Apenas criadores podem fazer fallback para subscriptions\n    try {\n      const subscriptions = await base44.entities.Subscription.filter({\n        user_email: userEmail,\n        plan: 'business'\n      });\n      \n      const activeSub = subscriptions.find(s => \n        s.status === 'active' || s.status === 'trialing'\n      );\n      \n      if (activeSub) {\n        return {\n          hasAccess: true,\n          isPending: false,\n          subscription: activeSub,\n          source: 'base44'\n        };\n      }\n    } catch (error) {\n      console.error('Error checking subscription:', error);\n    }\n    \n    return {\n      hasAccess: false,\n      isPending: false,\n      companyProfile: null,\n      source: 'none'\n    };\n  }\n  \n  async ensureBusinessEntityExists(companyProfile) {\n    try {\n      console.log('🔍 BusinessAccessService: Verificando se Business entity existe...');\n      \n      const existingBusinesses = await base44.entities.Business.filter({ id: companyProfile.id });\n      \n      if (existingBusinesses.length > 0) {\n        console.log('✅ BusinessAccessService: Business entity já existe');\n        return;\n      }\n      \n      console.log('⚠️ BusinessAccessService: Business entity NÃO encontrada - criando automaticamente...');\n      \n      // Criar Business entity a partir do CompanyProfile\n      const businessData = {\n        id: companyProfile.id,\n        name: companyProfile.companyName || 'Empresa',\n        description: companyProfile.companyDescription || '',\n        category: normalizeCategory(companyProfile.companyCategory || 'outros'),\n        address: companyProfile.companyAddress || \n          `${companyProfile.companyStreetName || ''} ${companyProfile.companyDoorNumber || ''}`.trim() ||\n          'Morada por definir',\n        street_name: companyProfile.companyStreetName || '',\n        door_number: companyProfile.companyDoorNumber || '',\n        postal_code: companyProfile.companyPostalCode || '',\n        city: companyProfile.companyCity || '',\n        district: companyProfile.companyDistrict || '',\n        country: normalizeCountry(companyProfile.companyCountry || 'PT'),\n        phone: companyProfile.companyPhone || '',\n        email: companyProfile.companyEmail || '',\n        logo_url: companyProfile.logoUrl || '',\n        photo_url: companyProfile.photoUrl || '',\n        media_gallery: companyProfile.mediaGallery || [],\n        custom_category: companyProfile.customCategory || null,\n        is_active: companyProfile.status === 'active',\n        owner_email: companyProfile.adminUserId,\n        latitude: companyProfile.companyCoordinates?.lat || null,\n        longitude: companyProfile.companyCoordinates?.lng || null\n      };\n      \n      await base44.entities.Business.create(businessData);\n      console.log('✅ BusinessAccessService: Business entity criada automaticamente!');\n      \n    } catch (error) {\n      console.error('❌ BusinessAccessService: Erro ao criar Business entity:', error);\n      // Não bloquear o acesso se falhar - apenas logar o erro\n    }\n  }\n\n  async syncSubscription(companyProfile, userEmail) {\n    try {\n      const existingSubs = await base44.entities.Subscription.filter({\n        user_email: userEmail,\n        plan: 'business'\n      });\n      \n      if (companyProfile.featuresEnabled && existingSubs.length === 0) {\n        const now = new Date();\n        const trialEndDate = new Date(now);\n        trialEndDate.setDate(trialEndDate.getDate() + 7); // 7 dias grátis\n        \n        const endDate = new Date(now);\n        endDate.setMonth(endDate.getMonth() + 1); // Renovação mensal\n        \n        await base44.entities.Subscription.create({\n          user_email: userEmail,\n          plan: 'business',\n          status: 'trialing',\n          amount: 49.99,\n          currency: 'EUR',\n          payment_method: 'stripe',\n          stripe_subscription_id: companyProfile.subscriptionId || `sub_mock_${Date.now()}`,\n          created_date: now.toISOString(),\n          trial_end_date: trialEndDate.toISOString(),\n          end_date: endDate.toISOString(),\n          auto_renew: true\n        });\n        console.log('✅ Subscription created with 7-day trial');\n      }\n      \n      if (!companyProfile.featuresEnabled && existingSubs.length > 0) {\n        for (const sub of existingSubs) {\n          await base44.entities.Subscription.update(sub.id, {\n            status: 'cancelled'\n          });\n        }\n        console.log('✅ Subscription cancelled (profile not active)');\n      }\n    } catch (error) {\n      console.warn('Could not sync subscription:', error);\n    }\n  }\n}\n\nexport const businessAccessService = new BusinessAccessService();\n","path":null,"size_bytes":10506,"size_tokens":null},"src/pages/BusinessHome.jsx":{"content":"import React, { useState } from \"react\";\nimport { base44 } from \"@/api/base44Client\";\nimport { useNavigate } from \"react-router-dom\";\nimport { createPageUrl } from \"@/utils\";\nimport { Capacitor } from \"@capacitor/core\";\nimport { Button } from \"@/components/ui/button\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { \n  LayoutDashboard, \n  Users, \n  Calendar, \n  Settings,\n  BarChart3,\n  Crown,\n  CheckCircle2,\n  ArrowRight,\n  Sparkles,\n  Clock,\n  MessageSquare,\n  Tv,\n  ExternalLink,\n  FileImage,\n  Lock,\n  Globe\n} from \"lucide-react\";\nimport { Skeleton } from \"@/components/ui/skeleton\";\nimport { useBusinessAccess } from \"../hooks/useBusinessAccess\";\nimport { PaymentPendingBanner } from \"../components/business/PaymentPendingBanner\";\nimport { RestrictedAccessOverlay } from \"../components/business/RestrictedAccessOverlay\";\nimport { PosterGenerator } from \"../components/business/PosterGenerator\";\nimport { TranslatedText } from \"@/components/translation/TranslatedText\";\nimport { useAutoTranslate } from \"@/hooks/useTranslate\";\n\n// 🌐 URL externa para compra B2B (Apple/Google compliance)\nconst EXTERNAL_SUBSCRIPTION_URL = 'https://waitless-qzero.com';\n\nexport default function BusinessHomePage() {\n  const navigate = useNavigate();\n  const { user, hasActiveSubscription: hasAccess, companyProfile, loading: isLoading } = useBusinessAccess();\n  const [showRestrictedOverlay, setShowRestrictedOverlay] = useState(false);\n  const [restrictedFeatureName, setRestrictedFeatureName] = useState('');\n  \n  // 🍎🤖 B2B COMPLIANCE: Detectar app nativa (iOS/Android)\n  const isNativeApp = Capacitor.isNativePlatform();\n  \n  const txtDashboardTitle = useAutoTranslate('Painel de Controlo', 'pt');\n  const txtDashboardDesc = useAutoTranslate('Visão geral completa do seu negócio', 'pt');\n  const txtQueuesTitle = useAutoTranslate('Gestão de Senhas', 'pt');\n  const txtQueuesDesc = useAutoTranslate('Controle senhas digitais em tempo real', 'pt');\n  const txtServicesTitle = useAutoTranslate('Marcações', 'pt');\n  const txtServicesDesc = useAutoTranslate('Gerir marcações e serviços', 'pt');\n  const txtFeedbackTitle = useAutoTranslate('Feedback', 'pt');\n  const txtFeedbackDesc = useAutoTranslate('Avaliações e comentários de clientes', 'pt');\n  const txtManageSubTitle = useAutoTranslate('Gerir Subscrição', 'pt');\n  const txtManageSubDesc = useAutoTranslate('Cancelar ou reativar plano empresarial', 'pt');\n  const txtSettingsTitle = useAutoTranslate('Configurações', 'pt');\n  const txtSettingsDesc = useAutoTranslate('Gerir perfil da empresa', 'pt');\n  const txtBusinessPortal = useAutoTranslate('Portal Empresarial', 'pt');\n  const txtManageBusiness = useAutoTranslate('Gerir o seu negócio de forma simples e eficiente', 'pt');\n  const txtActivePlan = useAutoTranslate('Plano Ativo', 'pt');\n  const txtTVPanel = useAutoTranslate('Painel TV - Ecrã de Senhas', 'pt');\n  const txtNew = useAutoTranslate('Novo', 'pt');\n  const txtTVPanelDesc = useAutoTranslate('Exiba as senhas em tempo real num ecrã grande para a sua sala de espera', 'pt');\n  const txtTVPanelFeatures = useAutoTranslate('Fullscreen • Auto-atualização • Visual limpo e profissional', 'pt');\n  const txtOpenTVPanel = useAutoTranslate('Abrir Painel TV', 'pt');\n  const txtPoster = useAutoTranslate('Cartaz Publicitário', 'pt');\n  const txtFree = useAutoTranslate('Grátis', 'pt');\n  const txtPosterDesc = useAutoTranslate('Imprima e afixe na sua empresa para informar os clientes sobre o sistema QZero', 'pt');\n  const txtPosterFeatures = useAutoTranslate('Formato A4 • QR Code personalizado • Pronto para imprimir', 'pt');\n  const txtActiveTickets = useAutoTranslate('Senhas Ativas', 'pt');\n  const txtTodayAppointments = useAutoTranslate('Marcações Hoje', 'pt');\n  const txtServedClients = useAutoTranslate('Clientes Atendidos', 'pt');\n  const txtAvgRating = useAutoTranslate('Avaliação Média', 'pt');\n  const txtFeatures = useAutoTranslate('Funcionalidades', 'pt');\n  const txtUnlockPotential = useAutoTranslate('Desbloqueie Todo o Potencial', 'pt');\n  const txtCtaDescription = useAutoTranslate('Ative o plano empresarial e aceda a todas as funcionalidades por apenas €49,99/mês', 'pt');\n  const txtUnlimitedQueues = useAutoTranslate('Gestão ilimitada de senhas', 'pt');\n  const txtCompleteBooking = useAutoTranslate('Sistema completo de marcações', 'pt');\n  const txtTeamManagement = useAutoTranslate('Gestão de equipa e staff', 'pt');\n  const txtActivateNow = useAutoTranslate('Ativar Plano Agora', 'pt');\n  const txtVisitWebsite = useAutoTranslate('Visite waitless-qzero.com', 'pt');\n\n  React.useEffect(() => {\n    // Verificar se é conta empresarial quando os dados estiverem carregados\n    if (!isLoading && user && !user.is_business_user) {\n      navigate(createPageUrl(\"Home\"));\n    }\n  }, [navigate, isLoading, user]);\n\n  if (isLoading || !user) {\n    return (\n      <div className=\"bg-gradient-to-br from-slate-50 to-slate-100 px-4 sm:px-6 py-4 sm:py-6\">\n        <div className=\"max-w-7xl mx-auto space-y-4 sm:space-y-6\">\n          <Skeleton className=\"h-32 w-full\" />\n          <div className=\"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 sm:gap-6\">\n            <Skeleton className=\"h-64\" />\n            <Skeleton className=\"h-64\" />\n            <Skeleton className=\"h-64\" />\n          </div>\n        </div>\n      </div>\n    );\n  }\n\n  const features = [\n    {\n      icon: LayoutDashboard,\n      titleKey: txtDashboardTitle,\n      descriptionKey: txtDashboardDesc,\n      color: \"from-blue-500 to-cyan-500\",\n      route: \"BusinessDashboard\",\n      requiresSubscription: true\n    },\n    {\n      icon: Users,\n      titleKey: txtQueuesTitle,\n      descriptionKey: txtQueuesDesc,\n      color: \"from-purple-500 to-pink-500\",\n      route: \"BusinessQueues\",\n      requiresSubscription: true\n    },\n    {\n      icon: Calendar,\n      titleKey: txtServicesTitle,\n      descriptionKey: txtServicesDesc,\n      color: \"from-green-500 to-emerald-500\",\n      route: \"BusinessServices\",\n      requiresSubscription: true\n    },\n    {\n      icon: MessageSquare,\n      titleKey: txtFeedbackTitle,\n      descriptionKey: txtFeedbackDesc,\n      color: \"from-rose-500 to-red-500\",\n      route: \"BusinessDashboard\",\n      tab: \"feedback\",\n      requiresSubscription: true\n    },\n    {\n      icon: Settings,\n      titleKey: txtSettingsTitle,\n      descriptionKey: txtSettingsDesc,\n      color: \"from-slate-500 to-gray-600\",\n      route: \"BusinessSettings\",\n      requiresSubscription: false\n    }\n  ];\n\n  const handleFeatureClick = (feature) => {\n    if (feature.requiresSubscription && !hasAccess) {\n      setRestrictedFeatureName(feature.titleKey);\n      setShowRestrictedOverlay(true);\n      return;\n    }\n\n    if (feature.tab) {\n      navigate(createPageUrl(feature.route), { state: { activeTab: feature.tab } });\n    } else {\n      navigate(createPageUrl(feature.route));\n    }\n  };\n\n  return (\n    <div className=\"bg-gradient-to-br from-slate-50 to-slate-100\">\n      <div className=\"max-w-7xl mx-auto px-3 lg:px-8 py-3 lg:py-6 space-y-3 sm:space-y-4 lg:space-y-6\">\n        {/* Banner de Pagamento Pendente */}\n        {!hasAccess && companyProfile && (\n          <PaymentPendingBanner companyProfile={companyProfile} />\n        )}\n\n        {/* Header */}\n        <div className=\"bg-gradient-to-r from-blue-600 to-purple-600 rounded-xl lg:rounded-2xl p-3 sm:p-4 lg:p-6 text-white shadow-lg\">\n          <div className=\"flex flex-row items-center justify-between gap-2 lg:gap-4\">\n            <div className=\"space-y-0.5 lg:space-y-1 min-w-0 flex-1\">\n              <div className=\"flex items-center gap-2 lg:gap-3\">\n                <Sparkles className=\"w-5 h-5 lg:w-7 lg:h-7 flex-shrink-0\" />\n                <h1 className=\"text-base sm:text-lg lg:text-2xl xl:text-3xl font-bold truncate\">\n                  {companyProfile?.name || txtBusinessPortal}\n                </h1>\n              </div>\n              <p className=\"text-blue-100 text-xs lg:text-base hidden sm:block\">\n                {txtManageBusiness}\n              </p>\n            </div>\n            \n            {hasAccess && (\n              <Badge className=\"bg-green-500 text-white px-2 lg:px-4 py-1 lg:py-2 text-xs lg:text-sm flex-shrink-0\">\n                <CheckCircle2 className=\"w-3 h-3 lg:w-4 lg:h-4 mr-1 lg:mr-2\" />\n                {txtActivePlan}\n              </Badge>\n            )}\n          </div>\n        </div>\n\n        {/* Quick Actions - TV Panel & Poster */}\n        {hasAccess && (\n          <div className=\"grid grid-cols-2 gap-2 lg:gap-4\">\n            <Button\n              onClick={() => window.open('/painel-tv', '_blank')}\n              className=\"bg-gradient-to-r from-green-600 to-emerald-600 hover:from-green-700 hover:to-emerald-700 text-white h-auto py-2.5 lg:py-4 px-3 lg:px-6\"\n            >\n              <Tv className=\"w-4 h-4 lg:w-6 lg:h-6 mr-1.5 lg:mr-3 flex-shrink-0\" />\n              <span className=\"text-xs sm:text-sm lg:text-base truncate\">{txtOpenTVPanel}</span>\n              <ExternalLink className=\"w-3 h-3 lg:w-5 lg:h-5 ml-1 lg:ml-2 flex-shrink-0\" />\n            </Button>\n            <PosterGenerator companyProfile={companyProfile} compact={true} />\n          </div>\n        )}\n\n        {/* Quick Stats - 2x2 grid on mobile, 4 columns on desktop */}\n        {hasAccess && (\n          <div className=\"grid grid-cols-2 lg:grid-cols-4 gap-2 lg:gap-4\">\n            <Card className=\"border-blue-200 bg-gradient-to-br from-blue-50 to-white\">\n              <CardContent className=\"p-3 lg:p-4\">\n                <div className=\"flex flex-col items-center text-center\">\n                  <Clock className=\"w-5 h-5 lg:w-6 lg:h-6 text-blue-500 mb-1.5 lg:mb-2\" />\n                  <p className=\"text-xl lg:text-2xl xl:text-3xl font-bold text-blue-900\">-</p>\n                  <p className=\"text-xs lg:text-sm text-blue-600 leading-tight\">{txtActiveTickets}</p>\n                </div>\n              </CardContent>\n            </Card>\n\n            <Card className=\"border-purple-200 bg-gradient-to-br from-purple-50 to-white\">\n              <CardContent className=\"p-3 lg:p-4\">\n                <div className=\"flex flex-col items-center text-center\">\n                  <Calendar className=\"w-5 h-5 lg:w-6 lg:h-6 text-purple-500 mb-1.5 lg:mb-2\" />\n                  <p className=\"text-xl lg:text-2xl xl:text-3xl font-bold text-purple-900\">-</p>\n                  <p className=\"text-xs lg:text-sm text-purple-600 leading-tight\">{txtTodayAppointments}</p>\n                </div>\n              </CardContent>\n            </Card>\n\n            <Card className=\"border-green-200 bg-gradient-to-br from-green-50 to-white\">\n              <CardContent className=\"p-3 lg:p-4\">\n                <div className=\"flex flex-col items-center text-center\">\n                  <Users className=\"w-5 h-5 lg:w-6 lg:h-6 text-green-500 mb-1.5 lg:mb-2\" />\n                  <p className=\"text-xl lg:text-2xl xl:text-3xl font-bold text-green-900\">-</p>\n                  <p className=\"text-xs lg:text-sm text-green-600 leading-tight\">{txtServedClients}</p>\n                </div>\n              </CardContent>\n            </Card>\n\n            <Card className=\"border-amber-200 bg-gradient-to-br from-amber-50 to-white\">\n              <CardContent className=\"p-3 lg:p-4\">\n                <div className=\"flex flex-col items-center text-center\">\n                  <BarChart3 className=\"w-5 h-5 lg:w-6 lg:h-6 text-amber-500 mb-1.5 lg:mb-2\" />\n                  <p className=\"text-xl lg:text-2xl xl:text-3xl font-bold text-amber-900\">-</p>\n                  <p className=\"text-xs lg:text-sm text-amber-600 leading-tight\">{txtAvgRating}</p>\n                </div>\n              </CardContent>\n            </Card>\n          </div>\n        )}\n\n        {/* Features Grid */}\n        <div>\n          <h2 className=\"text-base lg:text-xl xl:text-2xl font-bold text-slate-900 mb-2 lg:mb-4\">\n            {txtFeatures}\n          </h2>\n          <div className=\"grid grid-cols-2 sm:grid-cols-3 gap-2 md:gap-3 lg:gap-4\">\n            {features.map((feature, index) => {\n              const Icon = feature.icon;\n              const isLocked = feature.requiresSubscription && !hasAccess;\n              \n              return (\n                <Card\n                  key={index}\n                  className={`group cursor-pointer transition-all hover:shadow-md lg:hover:shadow-lg ${\n                    isLocked ? 'opacity-75 border-amber-200' : 'hover:-translate-y-0.5 lg:hover:-translate-y-1'\n                  }`}\n                  onClick={() => handleFeatureClick(feature)}\n                >\n                  <CardContent className=\"p-3 lg:p-5\">\n                    <div className=\"flex items-start gap-2 lg:gap-4\">\n                      <div className={`w-8 h-8 lg:w-12 lg:h-12 rounded-lg lg:rounded-xl bg-gradient-to-r ${feature.color} p-1.5 lg:p-2.5 flex-shrink-0 group-hover:scale-105 transition-transform`}>\n                        <Icon className=\"w-5 h-5 lg:w-7 lg:h-7 text-white\" />\n                      </div>\n                      <div className=\"min-w-0 flex-1\">\n                        <div className=\"flex items-center gap-1 lg:gap-2 mb-0.5 lg:mb-1\">\n                          <p className=\"text-xs lg:text-base xl:text-lg font-semibold text-slate-900 truncate\">{feature.titleKey}</p>\n                          {isLocked && (\n                            <Badge className=\"bg-amber-500 text-white text-[8px] lg:text-xs px-1 lg:px-2 py-0 lg:py-0.5\">\n                              Pro\n                            </Badge>\n                          )}\n                        </div>\n                        <p className=\"text-[10px] lg:text-sm text-slate-500 line-clamp-2 leading-tight\">\n                          {feature.descriptionKey}\n                        </p>\n                      </div>\n                    </div>\n                  </CardContent>\n                </Card>\n              );\n            })}\n          </div>\n        </div>\n\n        {/* 🍎🤖 B2B COMPLIANCE: CTA para Ativar Plano - escondido em apps nativas */}\n        {!hasAccess && !isNativeApp && (\n          <Card className=\"border-amber-300 bg-gradient-to-r from-amber-50 to-orange-50\">\n            <CardContent className=\"p-3 lg:p-6\">\n              <div className=\"flex flex-col gap-3 lg:gap-5\">\n                <div>\n                  <h3 className=\"text-sm lg:text-xl font-bold text-amber-900 mb-1 lg:mb-2\">\n                    {txtUnlockPotential}\n                  </h3>\n                  <p className=\"text-xs lg:text-base text-amber-800 mb-2 lg:mb-4\">\n                    {txtCtaDescription}\n                  </p>\n                  <div className=\"flex flex-wrap gap-x-3 lg:gap-x-6 gap-y-1 lg:gap-y-2 text-xs lg:text-sm text-amber-900\">\n                    <span className=\"flex items-center gap-1 lg:gap-2\">\n                      <CheckCircle2 className=\"w-3 h-3 lg:w-5 lg:h-5 text-green-600\" />\n                      {txtUnlimitedQueues}\n                    </span>\n                    <span className=\"flex items-center gap-1 lg:gap-2\">\n                      <CheckCircle2 className=\"w-3 h-3 lg:w-5 lg:h-5 text-green-600\" />\n                      {txtCompleteBooking}\n                    </span>\n                    <span className=\"flex items-center gap-1 lg:gap-2\">\n                      <CheckCircle2 className=\"w-3 h-3 lg:w-5 lg:h-5 text-green-600\" />\n                      {txtTeamManagement}\n                    </span>\n                  </div>\n                </div>\n                <Button\n                  onClick={() => navigate(createPageUrl(\"BusinessSubscription\"))}\n                  className=\"bg-gradient-to-r from-amber-600 to-orange-600 hover:from-amber-700 hover:to-orange-700 text-white w-full py-2 lg:py-4 text-sm lg:text-lg\"\n                >\n                  <Crown className=\"w-4 h-4 lg:w-6 lg:h-6 mr-1 lg:mr-2\" />\n                  {txtActivateNow}\n                  <ArrowRight className=\"w-4 h-4 lg:w-6 lg:h-6 ml-1 lg:ml-2\" />\n                </Button>\n              </div>\n            </CardContent>\n          </Card>\n        )}\n      </div>\n\n      {showRestrictedOverlay && (\n        <RestrictedAccessOverlay \n          featureName={restrictedFeatureName}\n          onClose={() => setShowRestrictedOverlay(false)}\n        />\n      )}\n    </div>\n  );\n}\n","path":null,"size_bytes":16333,"size_tokens":null},"src/utils/queueValidation.js":{"content":"function parseTime(timeString) {\n  if (!timeString || typeof timeString !== 'string') return null;\n  const parts = timeString.split(':');\n  if (parts.length !== 2) return null;\n  const hour = parseInt(parts[0], 10);\n  const min = parseInt(parts[1], 10);\n  if (isNaN(hour) || isNaN(min) || hour < 0 || hour > 23 || min < 0 || min > 59) return null;\n  return hour * 60 + min;\n}\n\nexport function validateQueueOperating(queue, now = new Date()) {\n  if (!queue) {\n    return {\n      isOperating: false,\n      reason: 'Fila não encontrada'\n    };\n  }\n\n  if (queue.status !== 'aberta') {\n    return {\n      isOperating: false,\n      reason: queue.status === 'pausada' \n        ? 'Fila pausada temporariamente' \n        : 'Fila fechada'\n    };\n  }\n\n  if (!queue.working_hours || Object.keys(queue.working_hours).length === 0) {\n    return {\n      isOperating: false,\n      reason: 'Horário de funcionamento não configurado'\n    };\n  }\n\n  const daysOfWeek = ['sunday', 'monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday'];\n  const currentDay = daysOfWeek[now.getDay()];\n  const todaySchedule = queue.working_hours[currentDay];\n\n  if (!todaySchedule || !todaySchedule.enabled) {\n    return {\n      isOperating: false,\n      reason: 'Fila fechada hoje'\n    };\n  }\n\n  if (!todaySchedule.start || !todaySchedule.end) {\n    return {\n      isOperating: false,\n      reason: 'Horário não configurado para hoje'\n    };\n  }\n\n  const startTime = parseTime(todaySchedule.start);\n  let endTime = parseTime(todaySchedule.end);\n\n  if (startTime === null || endTime === null) {\n    return {\n      isOperating: false,\n      reason: 'Horário configurado de forma incorreta'\n    };\n  }\n\n  const currentTime = now.getHours() * 60 + now.getMinutes();\n  \n  const crossesMidnight = endTime <= startTime;\n\n  if (crossesMidnight) {\n    if (endTime === 0) {\n      if (currentTime < startTime) {\n        return {\n          isOperating: false,\n          reason: `Fila abre às ${todaySchedule.start}`\n        };\n      }\n    } else {\n      if (currentTime < startTime && currentTime >= endTime) {\n        return {\n          isOperating: false,\n          reason: `Fila fechou às ${todaySchedule.end}`\n        };\n      }\n    }\n  } else {\n    if (currentTime < startTime) {\n      return {\n        isOperating: false,\n        reason: `Fila abre às ${todaySchedule.start}`\n      };\n    }\n\n    if (currentTime >= endTime) {\n      return {\n        isOperating: false,\n        reason: `Fila fechou às ${todaySchedule.end}`\n      };\n    }\n  }\n\n  const hasBreakStart = todaySchedule.break_start && todaySchedule.break_start.trim() !== '';\n  const hasBreakEnd = todaySchedule.break_end && todaySchedule.break_end.trim() !== '';\n  \n  if (hasBreakStart && hasBreakEnd) {\n    const breakStartTime = parseTime(todaySchedule.break_start);\n    const breakEndTime = parseTime(todaySchedule.break_end);\n\n    if (breakStartTime === null || breakEndTime === null) {\n      return {\n        isOperating: false,\n        reason: 'Pausa configurada de forma incorreta'\n      };\n    }\n\n    if (breakEndTime <= breakStartTime) {\n      return {\n        isOperating: false,\n        reason: 'Pausa configurada de forma incorreta'\n      };\n    }\n\n    if (breakStartTime < startTime || breakEndTime > endTime) {\n      return {\n        isOperating: false,\n        reason: 'Pausa fora do horário de funcionamento'\n      };\n    }\n\n    if (currentTime >= breakStartTime && currentTime < breakEndTime) {\n      return {\n        isOperating: false,\n        reason: `Fila em pausa até ${todaySchedule.break_end}`\n      };\n    }\n  }\n\n  return {\n    isOperating: true,\n    reason: null\n  };\n}\n","path":null,"size_bytes":3639,"size_tokens":null},"src/pages/BusinessTicketHistory.jsx":{"content":"import React, { useState, useEffect } from \"react\";\nimport { base44 } from \"@/api/base44Client\";\nimport { useQuery, useMutation, useQueryClient } from \"@tanstack/react-query\";\nimport { useNavigate } from \"react-router-dom\";\nimport { createPageUrl } from \"@/utils\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Input } from \"@/components/ui/input\";\nimport { Button } from \"@/components/ui/button\";\nimport { \n  Search,\n  Clock, \n  CheckCircle2,\n  XCircle,\n  Calendar,\n  User,\n  Phone,\n  Hash,\n  TrendingUp,\n  Award,\n  Filter,\n  Trash2\n} from \"lucide-react\";\nimport { Skeleton } from \"@/components/ui/skeleton\";\nimport { format } from \"date-fns\";\nimport { pt } from \"date-fns/locale\";\nimport PageHeader from \"../components/shared/PageHeader\";\nimport { toast } from \"sonner\";\nimport { useConfirm } from \"@/hooks/useConfirm\";\nimport {\n  Select,\n  SelectContent,\n  SelectItem,\n  SelectTrigger,\n  SelectValue,\n} from \"@/components/ui/select\";\nimport { useAutoTranslate } from \"@/hooks/useTranslate\";\n\nexport default function BusinessTicketHistoryPage() {\n  const txtCompleted = useAutoTranslate('Concluído', 'pt');\n  const txtCancelled = useAutoTranslate('Cancelado', 'pt');\n  const txtSubscriptionRequired = useAutoTranslate('Subscrição Necessária', 'pt');\n  const txtSubscriptionMessage = useAutoTranslate('Para aceder ao histórico de senhas, precisa de ativar o plano empresarial.', 'pt');\n  const txtPageTitle = useAutoTranslate('Histórico de Senhas', 'pt');\n  const txtPageSubtitle = useAutoTranslate('Consulte o histórico completo de atendimentos', 'pt');\n  const txtAttended = useAutoTranslate('Atendidas', 'pt');\n  const txtCancelledLabel = useAutoTranslate('Canceladas', 'pt');\n  const txtAvgTime = useAutoTranslate('Tempo Médio (min)', 'pt');\n  const txtSearchTickets = useAutoTranslate('Pesquisar Senhas', 'pt');\n  const txtSearchPlaceholder = useAutoTranslate('Procurar por número, nome, telefone, email ou fila...', 'pt');\n  const txtFilterByStatus = useAutoTranslate('Filtrar por status', 'pt');\n  const txtAll = useAutoTranslate('Todos', 'pt');\n  const txtCompletedFilter = useAutoTranslate('Concluídos', 'pt');\n  const txtCancelledFilter = useAutoTranslate('Cancelados', 'pt');\n  const txtNoTicketFound = useAutoTranslate('Nenhuma senha encontrada', 'pt');\n  const txtNoHistory = useAutoTranslate('Sem histórico', 'pt');\n  const txtAdjustFilters = useAutoTranslate('Tente ajustar os filtros de pesquisa', 'pt');\n  const txtHistoryWillAppear = useAutoTranslate('O histórico de senhas concluídas aparecerá aqui', 'pt');\n  const txtTicket = useAutoTranslate('senha', 'pt');\n  const txtTickets = useAutoTranslate('senhas', 'pt');\n  const txtFound = useAutoTranslate('encontradas', 'pt');\n  const txtClearHistory = useAutoTranslate('Limpar Histórico', 'pt');\n  const txtClearing = useAutoTranslate('Limpando...', 'pt');\n  const txtClearHistoryTitle = useAutoTranslate('Limpar Histórico de Senhas', 'pt');\n  const txtConfirmClear = useAutoTranslate('Tem certeza que deseja remover todas as', 'pt');\n  const txtFromHistory = useAutoTranslate('senhas do histórico? Esta ação não pode ser desfeita.', 'pt');\n  const txtYesClear = useAutoTranslate('Sim, limpar histórico', 'pt');\n  const txtCancel = useAutoTranslate('Cancelar', 'pt');\n  const txtTicketRemoved = useAutoTranslate('senha removida', 'pt');\n  const txtTicketsRemoved = useAutoTranslate('senhas removidas', 'pt');\n  const txtFromHistoryMsg = useAutoTranslate('do histórico', 'pt');\n  const txtErrorClearing = useAutoTranslate('Erro ao limpar histórico', 'pt');\n  const txtQueue = useAutoTranslate('Fila', 'pt');\n  const txtManual = useAutoTranslate('Manual', 'pt');\n  const txtDateNotAvailable = useAutoTranslate('Data não disponível', 'pt');\n  const txtServiceTime = useAutoTranslate('Tempo de atendimento:', 'pt');\n  const txtTimeNotAvailable = useAutoTranslate('Tempo não disponível', 'pt');\n  const txtRating = useAutoTranslate('Avaliação', 'pt');\n\n  const statusConfig = {\n    concluido: { \n      icon: CheckCircle2, \n      color: \"bg-green-100 text-green-700 border-green-200\", \n      label: txtCompleted \n    },\n    cancelado: { \n      icon: XCircle, \n      color: \"bg-red-100 text-red-700 border-red-200\", \n      label: txtCancelled \n    }\n  };\n  const navigate = useNavigate();\n  const queryClient = useQueryClient();\n  const { ConfirmDialog, confirm } = useConfirm();\n  const [user, setUser] = useState(null);\n  const [searchTerm, setSearchTerm] = useState(\"\");\n  const [statusFilter, setStatusFilter] = useState(\"all\");\n\n  useEffect(() => {\n    base44.auth.me().then(userData => {\n      setUser(userData);\n      if (!userData.is_business_user || !userData.business_id) {\n        navigate(createPageUrl(\"Home\"));\n      }\n    }).catch(() => base44.auth.redirectToLogin());\n  }, [navigate]);\n\n  const hasSubscription = user?.has_business_subscription;\n\n  const { data: tickets, isLoading } = useQuery({\n    queryKey: ['business-ticket-history', user?.business_id],\n    queryFn: () => base44.entities.Ticket.filter({ \n      business_id: user.business_id,\n      status: { $in: ['concluido', 'cancelado'] }\n    }, '-completed_at'),\n    initialData: [],\n    enabled: !!user?.business_id && hasSubscription,\n  });\n\n  const { data: queues } = useQuery({\n    queryKey: ['business-queues', user?.business_id],\n    queryFn: () => base44.entities.Queue.filter({ business_id: user.business_id }),\n    initialData: [],\n    enabled: !!user?.business_id,\n  });\n\n  const clearHistoryMutation = useMutation({\n    mutationFn: async () => {\n      const ticketsToDelete = tickets.filter(t => \n        t && ['concluido', 'cancelado'].includes(t.status)\n      );\n      \n      for (const ticket of ticketsToDelete) {\n        await base44.entities.Ticket.delete(ticket.id);\n      }\n      \n      return ticketsToDelete.length;\n    },\n    onSuccess: (count) => {\n      queryClient.invalidateQueries({ queryKey: ['business-ticket-history'] });\n      toast.success(`${count} ${count === 1 ? txtTicketRemoved : txtTicketsRemoved} ${txtFromHistoryMsg}`);\n    },\n    onError: () => {\n      toast.error(txtErrorClearing);\n    }\n  });\n\n  const handleClearHistory = async () => {\n    const confirmed = await confirm({\n      title: txtClearHistoryTitle,\n      description: `${txtConfirmClear} ${tickets.length} ${txtFromHistory}`,\n      confirmText: txtYesClear,\n      cancelText: txtCancel\n    });\n\n    if (confirmed) {\n      clearHistoryMutation.mutate();\n    }\n  };\n\n  if (!user || isLoading) {\n    return (\n      <div className=\"bg-gradient-to-br from-slate-50 via-blue-50 to-sky-50 p-4\">\n        <div className=\"max-w-6xl mx-auto\">\n          <Skeleton className=\"h-16 w-64 mb-8\" />\n          <Skeleton className=\"h-96 w-full\" />\n        </div>\n      </div>\n    );\n  }\n\n  if (!hasSubscription) {\n    return (\n      <div className=\"bg-gradient-to-br from-slate-50 via-blue-50 to-sky-50\">\n        <div className=\"max-w-4xl mx-auto px-4 py-4\">\n          <Card className=\"border-0 shadow-2xl\">\n            <CardContent className=\"p-12 text-center\">\n              <Clock className=\"w-16 h-16 text-amber-600 mx-auto mb-6\" />\n              <h2 className=\"text-3xl font-bold text-slate-900 mb-4\">\n                {txtSubscriptionRequired}\n              </h2>\n              <p className=\"text-lg text-slate-600 mb-8\">\n                {txtSubscriptionMessage}\n              </p>\n            </CardContent>\n          </Card>\n        </div>\n      </div>\n    );\n  }\n\n  const getQueueName = (queueId) => {\n    return queues.find(q => q && q.id === queueId)?.name || txtQueue;\n  };\n\n  const filteredTickets = tickets.filter(ticket => {\n    if (!ticket) return false;\n\n    const matchesStatus = statusFilter === \"all\" || ticket.status === statusFilter;\n\n    if (!searchTerm) return matchesStatus;\n\n    const searchLower = searchTerm.toLowerCase();\n    const matchesSearch = \n      ticket.ticket_number?.toString().includes(searchLower) ||\n      ticket.user_email?.toLowerCase().includes(searchLower) ||\n      ticket.user_phone?.toLowerCase().includes(searchLower) ||\n      ticket.manual_name?.toLowerCase().includes(searchLower) ||\n      getQueueName(ticket.queue_id).toLowerCase().includes(searchLower);\n\n    return matchesStatus && matchesSearch;\n  });\n\n  const completedTickets = tickets.filter(t => t?.status === 'concluido');\n  const cancelledTickets = tickets.filter(t => t?.status === 'cancelado');\n\n  const ticketsWithTimestamps = completedTickets.filter(t => t?.called_at && t?.completed_at);\n  \n  const averageServiceTime = ticketsWithTimestamps.length > 0\n    ? Math.round(\n        ticketsWithTimestamps.reduce((sum, t) => {\n          const start = new Date(t.called_at);\n          const end = new Date(t.completed_at);\n          const minutes = (end - start) / 1000 / 60;\n          return sum + minutes;\n        }, 0) / ticketsWithTimestamps.length\n      )\n    : 0;\n\n  return (\n    <div className=\"bg-gradient-to-br from-slate-50 via-blue-50 to-sky-50\">\n      <div className=\"max-w-6xl mx-auto px-4 py-4\">\n        <PageHeader\n          title={txtPageTitle}\n          subtitle={txtPageSubtitle}\n          backTo=\"BusinessDashboard\"\n        />\n\n        <div className=\"grid md:grid-cols-3 gap-6 mb-8\">\n          <Card className=\"border-0 shadow-lg\">\n            <CardContent className=\"p-6\">\n              <div className=\"flex items-center gap-4\">\n                <div className=\"p-3 bg-green-100 rounded-full\">\n                  <CheckCircle2 className=\"w-6 h-6 text-green-600\" />\n                </div>\n                <div>\n                  <p className=\"text-2xl font-bold text-slate-900\">{completedTickets.length}</p>\n                  <p className=\"text-sm text-slate-600\">{txtAttended}</p>\n                </div>\n              </div>\n            </CardContent>\n          </Card>\n\n          <Card className=\"border-0 shadow-lg\">\n            <CardContent className=\"p-6\">\n              <div className=\"flex items-center gap-4\">\n                <div className=\"p-3 bg-red-100 rounded-full\">\n                  <XCircle className=\"w-6 h-6 text-red-600\" />\n                </div>\n                <div>\n                  <p className=\"text-2xl font-bold text-slate-900\">{cancelledTickets.length}</p>\n                  <p className=\"text-sm text-slate-600\">{txtCancelledLabel}</p>\n                </div>\n              </div>\n            </CardContent>\n          </Card>\n\n          <Card className=\"border-0 shadow-lg\">\n            <CardContent className=\"p-6\">\n              <div className=\"flex items-center gap-4\">\n                <div className=\"p-3 bg-blue-100 rounded-full\">\n                  <TrendingUp className=\"w-6 h-6 text-blue-600\" />\n                </div>\n                <div>\n                  <p className=\"text-2xl font-bold text-slate-900\">{averageServiceTime}</p>\n                  <p className=\"text-sm text-slate-600\">{txtAvgTime}</p>\n                </div>\n              </div>\n            </CardContent>\n          </Card>\n        </div>\n\n        <Card className=\"border-0 shadow-xl mb-6\">\n          <CardHeader>\n            <CardTitle className=\"flex items-center gap-2\">\n              <Search className=\"w-5 h-5\" />\n              {txtSearchTickets}\n            </CardTitle>\n          </CardHeader>\n          <CardContent>\n            <div className=\"flex flex-col md:flex-row gap-4\">\n              <div className=\"flex-1 relative\">\n                <Search className=\"absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-slate-400\" />\n                <Input\n                  placeholder={txtSearchPlaceholder}\n                  value={searchTerm}\n                  onChange={(e) => setSearchTerm(e.target.value)}\n                  className=\"pl-10\"\n                />\n              </div>\n              <Select value={statusFilter} onValueChange={setStatusFilter}>\n                <SelectTrigger className=\"w-full md:w-48\">\n                  <Filter className=\"w-4 h-4 mr-2\" />\n                  <SelectValue placeholder={txtFilterByStatus} />\n                </SelectTrigger>\n                <SelectContent>\n                  <SelectItem value=\"all\">{txtAll}</SelectItem>\n                  <SelectItem value=\"concluido\">{txtCompletedFilter}</SelectItem>\n                  <SelectItem value=\"cancelado\">{txtCancelledFilter}</SelectItem>\n                </SelectContent>\n              </Select>\n            </div>\n          </CardContent>\n        </Card>\n\n        {filteredTickets.length === 0 ? (\n          <Card className=\"border-0 shadow-lg\">\n            <CardContent className=\"py-16 text-center\">\n              <Clock className=\"w-16 h-16 text-slate-400 mx-auto mb-4\" />\n              <h3 className=\"text-xl font-bold text-slate-900 mb-2\">\n                {searchTerm || statusFilter !== \"all\" \n                  ? txtNoTicketFound\n                  : txtNoHistory\n                }\n              </h3>\n              <p className=\"text-slate-600\">\n                {searchTerm || statusFilter !== \"all\"\n                  ? txtAdjustFilters\n                  : txtHistoryWillAppear\n                }\n              </p>\n            </CardContent>\n          </Card>\n        ) : (\n          <div className=\"space-y-4\">\n            <div className=\"flex justify-between items-center\">\n              <p className=\"text-sm text-slate-600\">\n                {filteredTickets.length} {filteredTickets.length === 1 ? txtTicket : txtTickets} {txtFound}\n              </p>\n              <Button\n                variant=\"outline\"\n                size=\"sm\"\n                onClick={handleClearHistory}\n                disabled={clearHistoryMutation.isPending || tickets.length === 0}\n                className=\"border-red-200 text-red-600 hover:bg-red-50\"\n              >\n                <Trash2 className=\"w-4 h-4 mr-2\" />\n                {clearHistoryMutation.isPending ? txtClearing : txtClearHistory}\n              </Button>\n            </div>\n\n            <div className=\"grid gap-4\">\n              {filteredTickets.map(ticket => {\n                if (!ticket) return null;\n                \n                const status = statusConfig[ticket.status];\n                const StatusIcon = status.icon;\n\n                return (\n                  <Card key={ticket.id} className=\"border-0 shadow-lg hover:shadow-xl transition-all\">\n                    <CardContent className=\"p-6\">\n                      <div className=\"flex flex-col md:flex-row justify-between gap-4\">\n                        <div className=\"flex-1\">\n                          <div className=\"flex items-center gap-3 mb-3\">\n                            <div className=\"flex items-center gap-2\">\n                              <Hash className=\"w-4 h-4 text-slate-400\" />\n                              <span className=\"text-3xl font-bold text-sky-600\">\n                                {ticket.ticket_number}\n                              </span>\n                            </div>\n                            <Badge className={status.color}>\n                              <StatusIcon className=\"w-3 h-3 mr-1\" />\n                              {status.label}\n                            </Badge>\n                          </div>\n\n                          <div className=\"space-y-2 text-sm\">\n                            <div className=\"flex items-center gap-2 text-slate-600\">\n                              <Award className=\"w-4 h-4\" />\n                              <span className=\"font-semibold\">{getQueueName(ticket.queue_id)}</span>\n                            </div>\n\n                            {ticket.is_manual && ticket.manual_name && (\n                              <div className=\"flex items-center gap-2 text-slate-600\">\n                                <User className=\"w-4 h-4\" />\n                                <span>{ticket.manual_name}</span>\n                                <Badge variant=\"outline\" className=\"text-xs\">{txtManual}</Badge>\n                              </div>\n                            )}\n\n                            {!ticket.is_manual && ticket.user_email && (\n                              <div className=\"flex items-center gap-2 text-slate-600\">\n                                <User className=\"w-4 h-4\" />\n                                <span>{ticket.user_email}</span>\n                              </div>\n                            )}\n\n                            {ticket.user_phone && (\n                              <div className=\"flex items-center gap-2 text-slate-600\">\n                                <Phone className=\"w-4 h-4\" />\n                                <span>{ticket.user_phone}</span>\n                              </div>\n                            )}\n\n                            {ticket.completed_at && (\n                              <div className=\"flex items-center gap-2 text-slate-600\">\n                                <Calendar className=\"w-4 h-4\" />\n                                <span>\n                                  {(() => {\n                                    try {\n                                      const date = new Date(ticket.completed_at);\n                                      if (isNaN(date.getTime())) return txtDateNotAvailable;\n                                      return format(date, \"dd/MM/yyyy 'às' HH:mm\", { locale: pt });\n                                    } catch (e) {\n                                      console.warn('Erro ao formatar data de conclusão:', e);\n                                      return txtDateNotAvailable;\n                                    }\n                                  })()}\n                                </span>\n                              </div>\n                            )}\n\n                            {ticket.status === 'concluido' && ticket.called_at && ticket.completed_at && (\n                              <div className=\"flex items-center gap-2 text-slate-600\">\n                                <Clock className=\"w-4 h-4\" />\n                                <span>\n                                  {(() => {\n                                    try {\n                                      const completedDate = new Date(ticket.completed_at);\n                                      const calledDate = new Date(ticket.called_at);\n                                      if (isNaN(completedDate.getTime()) || isNaN(calledDate.getTime())) {\n                                        return txtTimeNotAvailable;\n                                      }\n                                      const minutes = Math.round((completedDate - calledDate) / 1000 / 60);\n                                      return `${txtServiceTime} ${minutes} min`;\n                                    } catch (e) {\n                                      console.warn('Erro ao calcular tempo de atendimento:', e);\n                                      return txtTimeNotAvailable;\n                                    }\n                                  })()}\n                                </span>\n                              </div>\n                            )}\n                          </div>\n                        </div>\n\n                        {ticket.rating && (\n                          <div className=\"flex flex-col items-end justify-center\">\n                            <p className=\"text-xs text-slate-500 mb-1\">{txtRating}</p>\n                            <div className=\"flex items-center gap-1\">\n                              <span className=\"text-2xl font-bold text-amber-600\">{ticket.rating}</span>\n                              <span className=\"text-sm text-slate-400\">/5</span>\n                            </div>\n                          </div>\n                        )}\n                      </div>\n                    </CardContent>\n                  </Card>\n                );\n              })}\n            </div>\n          </div>\n        )}\n        <ConfirmDialog />\n      </div>\n    </div>\n  );\n}\n","path":null,"size_bytes":19874,"size_tokens":null},"src/components/business/ServiceSchedule.jsx":{"content":"import React, { useState, useEffect } from \"react\";\nimport { base44 } from \"@/api/base44Client\";\nimport { useMutation, useQueryClient } from \"@tanstack/react-query\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Label } from \"@/components/ui/label\";\nimport { Switch } from \"@/components/ui/switch\";\nimport { Clock, Save, Info } from \"lucide-react\";\nimport { toast } from \"sonner\";\nimport {\n  Alert,\n  AlertDescription,\n} from \"@/components/ui/alert\";\nimport { useAutoTranslate } from \"@/hooks/useTranslate\";\n\nexport default function ServiceSchedule({ service, onChange, onSaveComplete }) {\n  const txtSunday = useAutoTranslate('Domingo', 'pt');\n  const txtMonday = useAutoTranslate('Segunda-feira', 'pt');\n  const txtTuesday = useAutoTranslate('Terça-feira', 'pt');\n  const txtWednesday = useAutoTranslate('Quarta-feira', 'pt');\n  const txtThursday = useAutoTranslate('Quinta-feira', 'pt');\n  const txtFriday = useAutoTranslate('Sexta-feira', 'pt');\n  const txtSaturday = useAutoTranslate('Sábado', 'pt');\n  const txtWorkingHours = useAutoTranslate('Horários de Funcionamento', 'pt');\n  const txtStart = useAutoTranslate('Início', 'pt');\n  const txtEnd = useAutoTranslate('Fim', 'pt');\n  const txtBreakStart = useAutoTranslate('Pausa Início', 'pt');\n  const txtBreakEnd = useAutoTranslate('Pausa Fim', 'pt');\n  const txtOptional = useAutoTranslate('opcional', 'pt');\n  const txtSaving = useAutoTranslate('A salvar...', 'pt');\n  const txtSaveHours = useAutoTranslate('Salvar Horários', 'pt');\n  const txtHoursSaved = useAutoTranslate('Horários salvos com sucesso!', 'pt');\n  const txtHoursError = useAutoTranslate('Erro ao salvar horários. Tente novamente.', 'pt');\n  const txtSaveHint = useAutoTranslate('Os horários serão salvos ao clicar no botão \"Salvar\" no final', 'pt');\n  const txtExistingServiceHint = useAutoTranslate('Configure os horários de disponibilidade para este serviço. Deixe os campos de pausa vazios se não houver intervalo.', 'pt');\n  const txtNewServiceHint = useAutoTranslate('Para serviços novos, configure os horários aqui. Eles serão salvos quando criar o serviço.', 'pt');\n\n  const daysOfWeek = [\n    { value: \"sunday\", label: txtSunday },\n    { value: \"monday\", label: txtMonday },\n    { value: \"tuesday\", label: txtTuesday },\n    { value: \"wednesday\", label: txtWednesday },\n    { value: \"thursday\", label: txtThursday },\n    { value: \"friday\", label: txtFriday },\n    { value: \"saturday\", label: txtSaturday }\n  ];\n\n  const queryClient = useQueryClient();\n  const [schedule, setSchedule] = useState(service.working_hours || {});\n\n  useEffect(() => {\n    setSchedule(service.working_hours || {});\n  }, [service.id]);\n\n  const updateMutation = useMutation({\n    mutationFn: (data) => base44.entities.Service.update(service.id, data),\n    onSuccess: (updatedService) => {\n      // Atualiza AMBAS as query keys com businessId\n      queryClient.setQueryData(['business-services', service.business_id], (oldData) => {\n        if (!oldData) return [updatedService];\n        return oldData.map(s => s.id === updatedService.id ? updatedService : s);\n      });\n      \n      queryClient.setQueryData(['services', service.business_id], (oldData) => {\n        if (!oldData) return [updatedService];\n        return oldData.map(s => s.id === updatedService.id ? updatedService : s);\n      });\n      \n      toast.success(txtHoursSaved);\n      if (onSaveComplete) {\n        onSaveComplete(schedule);\n      }\n    },\n    onError: (error) => {\n      console.error('Error saving schedule:', error);\n      toast.error(txtHoursError);\n    }\n  });\n\n  const toggleDay = (day) => {\n    setSchedule(prev => {\n      const newSchedule = { ...prev };\n      if (newSchedule[day]) {\n        delete newSchedule[day];\n      } else {\n        newSchedule[day] = {\n          enabled: true,\n          start: \"09:00\",\n          end: \"18:00\",\n          break_start: \"\",\n          break_end: \"\"\n        };\n      }\n      if (onChange) {\n        onChange(newSchedule);\n      }\n      if (onSaveComplete) {\n        onSaveComplete(newSchedule);\n      }\n      return newSchedule;\n    });\n  };\n\n  const updateDaySchedule = (day, field, value) => {\n    setSchedule(prev => {\n      const newSchedule = {\n        ...prev,\n        [day]: {\n          ...prev[day],\n          [field]: value\n        }\n      };\n      if (onChange) {\n        onChange(newSchedule);\n      }\n      if (onSaveComplete) {\n        onSaveComplete(newSchedule);\n      }\n      return newSchedule;\n    });\n  };\n\n  const handleSave = () => {\n    updateMutation.mutate({ working_hours: schedule });\n  };\n\n  const isEditMode = service.id !== 'new';\n\n  return (\n    <Card className=\"border-0 shadow-lg\">\n      <CardHeader>\n        <CardTitle className=\"flex items-center gap-2\">\n          <Clock className=\"w-5 h-5\" />\n          {txtWorkingHours}\n        </CardTitle>\n      </CardHeader>\n      <CardContent className=\"space-y-4\">\n        {!onChange && (\n          <Alert>\n            <Info className=\"h-4 w-4\" />\n            <AlertDescription>\n              {txtExistingServiceHint}\n            </AlertDescription>\n          </Alert>\n        )}\n\n        {onChange && (\n          <Alert>\n            <Info className=\"h-4 w-4\" />\n            <AlertDescription>\n              {txtNewServiceHint}\n            </AlertDescription>\n          </Alert>\n        )}\n\n        <div className=\"space-y-4\">\n          {daysOfWeek.map((day) => (\n            <div key={day.value} className=\"space-y-3 p-4 border rounded-lg bg-slate-50\">\n              <div className=\"flex items-center justify-between\">\n                <div className=\"flex items-center gap-3\">\n                  <Switch\n                    checked={!!schedule[day.value]}\n                    onCheckedChange={() => toggleDay(day.value)}\n                  />\n                  <Label className=\"font-semibold text-base\">{day.label}</Label>\n                </div>\n              </div>\n\n              {schedule[day.value] && (\n                <div className=\"grid grid-cols-2 gap-4 pl-10\">\n                  <div>\n                    <Label htmlFor={`${day.value}-start`} className=\"text-sm\">{txtStart}</Label>\n                    <Input\n                      id={`${day.value}-start`}\n                      type=\"time\"\n                      value={schedule[day.value].start}\n                      onChange={(e) => updateDaySchedule(day.value, 'start', e.target.value)}\n                      className=\"mt-1\"\n                    />\n                  </div>\n                  <div>\n                    <Label htmlFor={`${day.value}-end`} className=\"text-sm\">{txtEnd}</Label>\n                    <Input\n                      id={`${day.value}-end`}\n                      type=\"time\"\n                      value={schedule[day.value].end}\n                      onChange={(e) => updateDaySchedule(day.value, 'end', e.target.value)}\n                      className=\"mt-1\"\n                    />\n                  </div>\n                  <div>\n                    <Label htmlFor={`${day.value}-break-start`} className=\"text-sm\">\n                      {txtBreakStart} <span className=\"text-slate-400\">({txtOptional})</span>\n                    </Label>\n                    <Input\n                      id={`${day.value}-break-start`}\n                      type=\"time\"\n                      value={schedule[day.value].break_start || ''}\n                      onChange={(e) => updateDaySchedule(day.value, 'break_start', e.target.value)}\n                      placeholder=\"--:--\"\n                      className=\"mt-1\"\n                    />\n                  </div>\n                  <div>\n                    <Label htmlFor={`${day.value}-break-end`} className=\"text-sm\">\n                      {txtBreakEnd} <span className=\"text-slate-400\">({txtOptional})</span>\n                    </Label>\n                    <Input\n                      id={`${day.value}-break-end`}\n                      type=\"time\"\n                      value={schedule[day.value].break_end || ''}\n                      onChange={(e) => updateDaySchedule(day.value, 'break_end', e.target.value)}\n                      placeholder=\"--:--\"\n                      className=\"mt-1\"\n                    />\n                  </div>\n                </div>\n              )}\n            </div>\n          ))}\n        </div>\n\n        {!onChange && !onSaveComplete && (\n          <Button\n            onClick={handleSave}\n            disabled={updateMutation.isPending}\n            className=\"w-full gap-2\"\n          >\n            <Save className=\"w-4 h-4\" />\n            {updateMutation.isPending ? txtSaving : txtSaveHours}\n          </Button>\n        )}\n        {(onChange || onSaveComplete) && (\n          <div className=\"text-center text-sm text-slate-600 py-2 bg-blue-50 rounded-md\">\n            💡 {txtSaveHint}\n          </div>\n        )}\n      </CardContent>\n    </Card>\n  );\n}\n","path":null,"size_bytes":8989,"size_tokens":null},"src/components/business/ServiceForm.jsx":{"content":"import React, { useState, useEffect } from \"react\";\nimport { base44 } from \"@/api/base44Client\";\nimport { useMutation, useQueryClient } from \"@tanstack/react-query\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Label } from \"@/components/ui/label\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport { Tabs, TabsList, TabsTrigger, TabsContent } from \"@/components/ui/tabs\";\nimport { X, Save, Info } from \"lucide-react\";\nimport { toast } from \"sonner\";\nimport {\n  Tooltip,\n  TooltipContent,\n  TooltipProvider,\n  TooltipTrigger,\n} from \"@/components/ui/tooltip\";\nimport ServiceSchedule from \"./ServiceSchedule\";\nimport { useAutoTranslate } from \"@/hooks/useTranslate\";\n\nexport default function ServiceForm({ service, businessId, onClose }) {\n  // Traduções\n  const txtEditService = useAutoTranslate('Editar Serviço', 'pt');\n  const txtNewService = useAutoTranslate('Novo Serviço', 'pt');\n  const txtInfo = useAutoTranslate('Info', 'pt');\n  const txtConfig = useAutoTranslate('Config', 'pt');\n  const txtSchedule = useAutoTranslate('Horários', 'pt');\n  const txtServiceName = useAutoTranslate('Nome do Serviço', 'pt');\n  const txtDescription = useAutoTranslate('Descrição', 'pt');\n  const txtDuration = useAutoTranslate('Duração (min)', 'pt');\n  const txtPrice = useAutoTranslate('Preço (€)', 'pt');\n  const txtCategory = useAutoTranslate('Categoria', 'pt');\n  const txtToleranceTime = useAutoTranslate('Tempo de Tolerância (min)', 'pt');\n  const txtOptional = useAutoTranslate('(opcional)', 'pt');\n  const txtToleranceTooltip = useAutoTranslate('Tempo que o cliente tem para chegar após a confirmação da marcação', 'pt');\n  const txtNoTolerance = useAutoTranslate('0 = sem tolerância', 'pt');\n  const txtCategoryPlaceholder = useAutoTranslate('Ex: Beleza, Saúde, Consultoria', 'pt');\n  const txtCancel = useAutoTranslate('Cancelar', 'pt');\n  const txtSave = useAutoTranslate('Salvar', 'pt');\n  const txtUpdateService = useAutoTranslate('Atualizar Serviço', 'pt');\n  const txtCreateService = useAutoTranslate('Criar Serviço', 'pt');\n  const txtServiceUpdated = useAutoTranslate('Serviço atualizado com sucesso!', 'pt');\n  const txtServiceCreated = useAutoTranslate('Serviço criado com sucesso!', 'pt');\n  const txtErrorSaving = useAutoTranslate('Erro ao salvar serviço:', 'pt');\n  const txtPlaceholderHaircut = useAutoTranslate('Ex: Corte de Cabelo', 'pt');\n  const queryClient = useQueryClient();\n  const [formData, setFormData] = useState(service || {\n    name: '',\n    description: '',\n    duration: 30,\n    price: 0,\n    category: '',\n    tolerance_time: 5,\n    working_hours: {}\n  });\n\n  useEffect(() => {\n    if (service) {\n      console.log('📝 ServiceForm received service:', service);\n      console.log('📅 Working hours from service:', service.working_hours);\n      setFormData({\n        ...service,\n        tolerance_time: service.tolerance_time || 5\n      });\n    } else {\n      setFormData({\n        name: '',\n        description: '',\n        duration: 30,\n        price: 0,\n        category: '',\n        tolerance_time: 5,\n        working_hours: {}\n      });\n    }\n  }, [service]);\n\n  const saveMutation = useMutation({\n    mutationFn: async (data) => {\n      console.log('💾 Saving service...', { serviceId: service?.id, data });\n      if (service) {\n        const result = await base44.entities.Service.update(service.id, data);\n        console.log('✅ Service updated:', result);\n        return result;\n      } else {\n        const result = await base44.entities.Service.create({\n          ...data,\n          business_id: businessId,\n          is_active: true\n        });\n        console.log('✅ Service created:', result);\n        return result;\n      }\n    },\n    onSuccess: async (updatedService) => {\n      console.log('✅ onSuccess called, updating cache directly...');\n      \n      // Atualiza AMBAS as query keys (business-services E services)\n      queryClient.setQueryData(['business-services', businessId], (oldData) => {\n        if (!oldData) return [updatedService];\n        if (service) {\n          return oldData.map(s => s.id === updatedService.id ? updatedService : s);\n        } else {\n          return [...oldData, updatedService];\n        }\n      });\n      \n      queryClient.setQueryData(['services', businessId], (oldData) => {\n        if (!oldData) return [updatedService];\n        if (service) {\n          return oldData.map(s => s.id === updatedService.id ? updatedService : s);\n        } else {\n          return [...oldData, updatedService];\n        }\n      });\n      \n      toast.success(service ? txtServiceUpdated : txtServiceCreated);\n      onClose();\n    },\n    onError: (error) => {\n      console.error('❌ Error saving service:', error);\n      toast.error(`${txtErrorSaving} ${error.message}`);\n    }\n  });\n\n  const handleSubmit = (e) => {\n    e.preventDefault();\n    saveMutation.mutate(formData);\n  };\n\n  const handleChange = (field, value) => {\n    setFormData(prev => ({ ...prev, [field]: value }));\n  };\n\n  const handleScheduleSaveComplete = (newSchedule) => {\n    setFormData(prev => ({ ...prev, working_hours: newSchedule }));\n  };\n\n  return (\n    <form onSubmit={handleSubmit} className=\"space-y-6 bg-white p-6 rounded-xl border border-slate-200\" noValidate>\n      <div className=\"flex justify-between items-center mb-4\">\n        <h3 className=\"text-xl font-bold text-slate-900\">\n          {service ? txtEditService : txtNewService}\n        </h3>\n        <Button\n          type=\"button\"\n          variant=\"ghost\"\n          size=\"sm\"\n          onClick={onClose}\n        >\n          <X className=\"w-4 h-4\" />\n        </Button>\n      </div>\n\n      <Tabs defaultValue=\"info\" className=\"w-full\">\n        <TabsList className=\"flex flex-row w-full h-auto gap-1 p-1\">\n          <TabsTrigger value=\"info\" className=\"flex-1 text-xs sm:text-sm px-2 py-2\">\n            {txtInfo}\n          </TabsTrigger>\n          <TabsTrigger value=\"config\" className=\"flex-1 text-xs sm:text-sm px-2 py-2\">\n            {txtConfig}\n          </TabsTrigger>\n          <TabsTrigger value=\"schedule\" className=\"flex-1 text-xs sm:text-sm px-2 py-2\">\n            {txtSchedule}\n          </TabsTrigger>\n        </TabsList>\n\n        <TabsContent value=\"info\" className=\"space-y-4 mt-6\">\n          <div>\n            <Label htmlFor=\"service-name\">{txtServiceName} *</Label>\n            <Input\n              id=\"service-name\"\n              value={formData.name}\n              onChange={(e) => handleChange('name', e.target.value)}\n              placeholder={txtPlaceholderHaircut}\n            />\n          </div>\n\n          <div>\n            <Label htmlFor=\"service-description\">{txtDescription}</Label>\n            <Textarea\n              id=\"service-description\"\n              value={formData.description}\n              onChange={(e) => handleChange('description', e.target.value)}\n              placeholder={txtDescription}\n              rows={3}\n            />\n          </div>\n\n          <div className=\"grid md:grid-cols-2 gap-6\">\n            <div>\n              <Label htmlFor=\"duration\">{txtDuration} *</Label>\n              <Input\n                id=\"duration\"\n                type=\"number\"\n                min=\"15\"\n                step=\"15\"\n                value={formData.duration}\n                onChange={(e) => handleChange('duration', parseInt(e.target.value))}\n              />\n            </div>\n\n            <div>\n              <Label htmlFor=\"price\">{txtPrice}</Label>\n              <Input\n                id=\"price\"\n                type=\"number\"\n                min=\"0\"\n                step=\"0.01\"\n                value={formData.price}\n                onChange={(e) => handleChange('price', parseFloat(e.target.value))}\n              />\n            </div>\n          </div>\n\n          <div>\n            <Label htmlFor=\"category\">{txtCategory}</Label>\n            <Input\n              id=\"category\"\n              value={formData.category}\n              onChange={(e) => handleChange('category', e.target.value)}\n              placeholder={txtCategoryPlaceholder}\n            />\n          </div>\n        </TabsContent>\n\n        <TabsContent value=\"config\" className=\"space-y-4 mt-6\">\n          <div>\n            <div className=\"flex items-center gap-2 mb-2\">\n              <Label htmlFor=\"tolerance-time\">{txtToleranceTime} <span className=\"text-xs text-slate-400\">{txtOptional}</span></Label>\n              <TooltipProvider>\n                <Tooltip>\n                  <TooltipTrigger asChild>\n                    <Info className=\"w-4 h-4 text-slate-400 cursor-help\" />\n                  </TooltipTrigger>\n                  <TooltipContent>\n                    <p className=\"max-w-xs\">{txtToleranceTooltip}</p>\n                  </TooltipContent>\n                </Tooltip>\n              </TooltipProvider>\n            </div>\n            <Input\n              id=\"tolerance-time\"\n              type=\"number\"\n              min=\"0\"\n              step=\"5\"\n              value={formData.tolerance_time}\n              onChange={(e) => handleChange('tolerance_time', parseInt(e.target.value))}\n              placeholder={txtNoTolerance}\n            />\n          </div>\n        </TabsContent>\n\n        <TabsContent value=\"schedule\" className=\"mt-6\">\n          {service ? (\n            <ServiceSchedule \n              service={service}\n              onSaveComplete={handleScheduleSaveComplete}\n            />\n          ) : (\n            <ServiceSchedule \n              service={{ \n                id: 'new',\n                working_hours: formData.working_hours \n              }}\n              onChange={(newSchedule) => handleChange('working_hours', newSchedule)}\n              onSaveComplete={handleScheduleSaveComplete}\n            />\n          )}\n        </TabsContent>\n      </Tabs>\n\n      <div className=\"flex gap-3 pt-4 border-t\">\n        <Button\n          type=\"submit\"\n          className=\"flex-1 gap-2\"\n          disabled={saveMutation.isPending}\n        >\n          <Save className=\"w-4 h-4\" />\n          {service ? txtUpdateService : txtCreateService}\n        </Button>\n        <Button\n          type=\"button\"\n          variant=\"outline\"\n          onClick={onClose}\n          disabled={saveMutation.isPending}\n        >\n          {txtCancel}\n        </Button>\n      </div>\n    </form>\n  );\n}\n","path":null,"size_bytes":10335,"size_tokens":null},"src/services/emailService.js":{"content":"export async function sendEmail({ to, subject, body }) {\n  try {\n    const { safeFetch } = await import('@/utils/apiConfig');\n    const { response, data: result } = await safeFetch('/api/send-ticket-email', {\n      method: 'POST',\n      body: JSON.stringify({ to, subject, body }),\n    });\n    \n    if (result?.success) {\n      console.log('✅ Email enviado via Resend:', result);\n      return { success: true, id: result?.id };\n    } else {\n      console.error('❌ Erro ao enviar email:', result?.error);\n      return { success: false, error: result?.error };\n    }\n  } catch (error) {\n    console.error('❌ Erro ao enviar email via Resend:', error);\n    return { success: false, error: error.message };\n  }\n}\n","path":null,"size_bytes":714,"size_tokens":null},"src/pages/PainelTV.css":{"content":".painel-tv {\n  width: 100vw;\n  height: 100vh;\n  margin: 0;\n  padding: 0;\n  background-color: #fff;\n  color: #000;\n  display: flex;\n  flex-direction: column;\n  align-items: center;\n  justify-content: center;\n  overflow: hidden;\n  position: relative;\n}\n\n.painel-tv-logo {\n  position: absolute;\n  top: 0.5rem;\n  left: 0.5rem;\n  max-width: 150px;\n  max-height: 100px;\n  object-fit: contain;\n  z-index: 10;\n  image-rendering: -webkit-optimize-contrast;\n  image-rendering: crisp-edges;\n}\n\n@media (min-width: 640px) {\n  .painel-tv-logo {\n    max-width: 250px;\n    max-height: 200px;\n  }\n}\n\n@media (min-width: 1024px) {\n  .painel-tv-logo {\n    max-width: 400px;\n    max-height: 300px;\n  }\n}\n\n.painel-tv-titulo {\n  font-size: 3rem;\n  font-weight: bold;\n  margin: 0;\n  margin-bottom: 2rem;\n  text-align: center;\n  color: #000;\n}\n\n@media (min-width: 640px) {\n  .painel-tv-titulo {\n    font-size: 5rem;\n    margin-bottom: 3rem;\n  }\n}\n\n@media (min-width: 1024px) {\n  .painel-tv-titulo {\n    font-size: 8rem;\n    margin-bottom: 4rem;\n  }\n}\n\n.painel-tv-vazio {\n  font-size: 2rem;\n  text-align: center;\n  color: #666;\n}\n\n@media (min-width: 640px) {\n  .painel-tv-vazio {\n    font-size: 3.5rem;\n  }\n}\n\n@media (min-width: 1024px) {\n  .painel-tv-vazio {\n    font-size: 5rem;\n  }\n}\n\n.painel-tv-lista {\n  display: grid;\n  grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));\n  gap: 1rem;\n  justify-content: center;\n  align-items: center;\n  max-width: 95vw;\n  padding: 0 0.5rem;\n}\n\n@media (min-width: 640px) {\n  .painel-tv-lista {\n    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));\n    gap: 1.5rem;\n    padding: 0 1rem;\n  }\n}\n\n@media (min-width: 1024px) {\n  .painel-tv-lista {\n    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));\n    gap: 2rem;\n    max-width: 90vw;\n    padding: 0 2rem;\n  }\n}\n\n.painel-tv-senha {\n  background-color: #f5f5f5;\n  border: 2px solid #333;\n  border-radius: 0.75rem;\n  padding: 1rem 1.5rem;\n  text-align: center;\n  aspect-ratio: 2 / 1;\n  display: flex;\n  align-items: center;\n  justify-content: center;\n  transition: all 0.3s ease;\n}\n\n@media (min-width: 640px) {\n  .painel-tv-senha {\n    border: 3px solid #333;\n    border-radius: 1rem;\n    padding: 1.5rem 2rem;\n  }\n}\n\n@media (min-width: 1024px) {\n  .painel-tv-senha {\n    border: 4px solid #333;\n    border-radius: 1.5rem;\n    padding: 2rem 3rem;\n  }\n}\n\n.painel-tv-senha-chamado {\n  background-color: #ff8c00;\n  border-color: #ff6600;\n  transform: scale(1.15);\n  box-shadow: 0 8px 24px rgba(255, 140, 0, 0.4);\n  z-index: 5;\n}\n\n.painel-tv-senha-chamado .painel-tv-numero {\n  color: #fff;\n  font-size: 4rem;\n  animation: pulse 2s ease-in-out infinite;\n}\n\n@media (min-width: 640px) {\n  .painel-tv-senha-chamado .painel-tv-numero {\n    font-size: 6rem;\n  }\n}\n\n@media (min-width: 1024px) {\n  .painel-tv-senha-chamado .painel-tv-numero {\n    font-size: 9rem;\n  }\n}\n\n@keyframes pulse {\n  0%, 100% {\n    transform: scale(1);\n  }\n  50% {\n    transform: scale(1.05);\n  }\n}\n\n.painel-tv-numero {\n  font-size: 3rem;\n  font-weight: bold;\n  color: #000;\n  display: block;\n  line-height: 1;\n}\n\n@media (min-width: 640px) {\n  .painel-tv-numero {\n    font-size: 5rem;\n  }\n}\n\n@media (min-width: 1024px) {\n  .painel-tv-numero {\n    font-size: 8rem;\n  }\n}\n","path":null,"size_bytes":3224,"size_tokens":null},"src/pages/PainelTV.jsx":{"content":"import { useEffect, useState } from 'react';\nimport './PainelTV.css';\nimport { TranslatedText } from '@/components/translation/TranslatedText';\nimport { safeFetch } from '@/utils/apiConfig';\n\nexport default function PainelTV() {\n  const [senhas, setSenhas] = useState([]);\n\n  const buscarSenhas = async () => {\n    try {\n      const { response, data } = await safeFetch('/api/demo/tickets?status=aguardando,chamado');\n      if (!response.ok || !data) return;\n      \n      const senhasOrdenadas = data\n        .sort((a, b) => new Date(a.created_at || 0) - new Date(b.created_at || 0))\n        .slice(0, 12)\n        .map((senha, index) => ({\n          ...senha,\n          displayNumber: senha.ticket_number || (index + 1)\n        }));\n      \n      setSenhas(senhasOrdenadas);\n    } catch (error) {\n      console.error('Erro ao buscar senhas:', error);\n    }\n  };\n\n  useEffect(() => {\n    buscarSenhas();\n    \n    const intervalo = setInterval(() => {\n      buscarSenhas();\n    }, 5000);\n\n    return () => clearInterval(intervalo);\n  }, []);\n\n  return (\n    <div className=\"painel-tv\">\n      <h1 className=\"painel-tv-titulo\">\n        <TranslatedText text=\"Senhas na Fila\" sourceLang=\"pt\" />\n      </h1>\n      \n      {senhas.length === 0 ? (\n        <p className=\"painel-tv-vazio\">\n          <TranslatedText text=\"Nenhuma senha na fila.\" sourceLang=\"pt\" />\n        </p>\n      ) : (\n        <div className=\"painel-tv-lista\">\n          {senhas.map((senha) => (\n            <div \n              key={senha.id} \n              className={`painel-tv-senha ${senha.status === 'chamado' ? 'painel-tv-senha-chamado' : ''}`}\n            >\n              <span className=\"painel-tv-numero\">{senha.displayNumber}</span>\n            </div>\n          ))}\n        </div>\n      )}\n    </div>\n  );\n}\n","path":null,"size_bytes":1777,"size_tokens":null},"src/pages/RootRedirect.jsx":{"content":"import React, { useEffect, useState } from 'react';\nimport { useNavigate } from 'react-router-dom';\nimport { base44 } from '@/api/base44Client';\nimport { createPageUrl } from '@/utils';\nimport { useBusinessAccess } from '@/hooks/useBusinessAccess';\nimport { useAutoTranslate } from '@/hooks/useTranslate';\n\nexport default function RootRedirect() {\n  const txtLoading = useAutoTranslate('A carregar...', 'pt');\n  \n  const navigate = useNavigate();\n  const [isLoading, setIsLoading] = useState(true);\n  const [user, setUser] = useState(null);\n  const { hasAccess, loading: accessLoading } = useBusinessAccess(user);\n\n  useEffect(() => {\n    const loadUser = async () => {\n      try {\n        console.log('🔍 RootRedirect: Verificando autenticação...');\n        const userData = await base44.auth.me();\n        \n        // 🧹 LIMPAR CACHE: APENAS se utilizador estiver autenticado\n        if (userData) {\n          try {\n            localStorage.removeItem('company_profiles');\n            localStorage.removeItem('businesses');\n            console.log('🗑️ RootRedirect: Cache de empresas limpo (utilizador autenticado)');\n          } catch (e) {\n            console.warn('⚠️ RootRedirect: Erro ao limpar localStorage:', e);\n          }\n        }\n        console.log('✅ RootRedirect: Dados do utilizador:', userData);\n        \n        if (!userData) {\n          console.log('⚠️ RootRedirect: Sem dados de utilizador, redirecionando para login');\n          navigate('/login', { replace: true });\n          setIsLoading(false);\n          return;\n        }\n\n        setUser(userData);\n      } catch (error) {\n        console.error('❌ RootRedirect: Erro ao verificar autenticação:', error);\n        navigate('/login', { replace: true });\n        setIsLoading(false);\n      }\n    };\n\n    loadUser();\n  }, [navigate]);\n\n  useEffect(() => {\n    if (!user || accessLoading) return;\n\n    const accountType = user.account_type || 'pessoal';\n    console.log('👤 RootRedirect: Tipo de conta:', accountType);\n\n    if (accountType === 'empresa') {\n      if (!user.business_id || !user.business_profile_completed) {\n        console.log('🏢 RootRedirect: Redirecionando para setup empresarial');\n        navigate('/business-profile-setup', { replace: true });\n      } else if (!hasAccess) {\n        console.log('💳 RootRedirect: Sem acesso - redirecionando para subscrição');\n        navigate('/business-subscription', { replace: true });\n      } else {\n        console.log('🏢 RootRedirect: Com acesso - redirecionando para home empresarial');\n        navigate('/business-home', { replace: true });\n      }\n    } else {\n      console.log('👤 RootRedirect: Redirecionando para home');\n      navigate('/home', { replace: true });\n    }\n    setIsLoading(false);\n  }, [user, hasAccess, accessLoading, navigate]);\n\n  if (isLoading) {\n    return (\n      <div className=\"flex items-center justify-center bg-gradient-to-br from-blue-50 to-indigo-100\">\n        <div className=\"text-center\">\n          <div className=\"inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mb-4\"></div>\n          <p className=\"text-slate-600\">{txtLoading}</p>\n        </div>\n      </div>\n    );\n  }\n\n  return null;\n}\n","path":null,"size_bytes":3230,"size_tokens":null},"src/components/business/PosterGenerator.jsx":{"content":"import React, { useRef } from 'react';\nimport { QRCodeSVG } from 'qrcode.react';\nimport { Button } from '@/components/ui/button';\nimport { Printer, Eye, FileImage } from 'lucide-react';\nimport {\n  Dialog,\n  DialogContent,\n  DialogDescription,\n  DialogHeader,\n  DialogTitle,\n  DialogTrigger,\n} from '@/components/ui/dialog';\nimport { useAutoTranslate } from '@/hooks/useTranslate';\n\nexport function PosterGenerator({ companyProfile, compact = false }) {\n  const posterRef = useRef(null);\n\n  const txtViewPrintPoster = useAutoTranslate('Ver e Imprimir Cartaz', 'pt');\n  const txtPosterBtn = useAutoTranslate('Cartaz', 'pt');\n  const txtAdvertisingPoster = useAutoTranslate('Cartaz Publicitário', 'pt');\n  const txtPrintInstructions = useAutoTranslate('Imprima este cartaz A4 e coloque-o na sua empresa para informar os clientes sobre o sistema QZero', 'pt');\n  const txtZeroQueues = useAutoTranslate('Zero Filas de Espera', 'pt');\n  const txtSmartManagement = useAutoTranslate('Gestão inteligente de senhas e marcações', 'pt');\n  const txtGetTicketMobile = useAutoTranslate('Tire Senha pelo Telemóvel', 'pt');\n  const txtNoNeedPresent = useAutoTranslate('Não precisa de estar aqui presente. Tire a sua senha online!', 'pt');\n  const txtBookAppointment = useAutoTranslate('Marque o Seu Atendimento', 'pt');\n  const txtChooseBestTime = useAutoTranslate('Escolha o melhor dia e hora para si. Sem esperas!', 'pt');\n  const txtReceiveNotifications = useAutoTranslate('Receba Notificações', 'pt');\n  const txtWeNotifyYou = useAutoTranslate('Avisamos quando estiver quase na sua vez!', 'pt');\n  const txtHowToUse = useAutoTranslate('Como Usar?', 'pt');\n  const txtAccessQRCode = useAutoTranslate('Aceda ao nosso QR Code', 'pt');\n  const txtGetTicketOrBook = useAutoTranslate('Tire senha ou marque atendimento', 'pt');\n  const txtFollowRealTime = useAutoTranslate('Acompanhe tudo em tempo real', 'pt');\n  const txtArriveWhenCalled = useAutoTranslate('Chegue quando for chamado!', 'pt');\n  const txtQueueSystem = useAutoTranslate('Sistema de gestão de filas inteligente • QZero', 'pt');\n  const txtPrintPosterA4 = useAutoTranslate('Imprimir Cartaz A4', 'pt');\n  const txtTip = useAutoTranslate('Dica:', 'pt');\n  const txtQRCodeLeads = useAutoTranslate('O QR Code leva os clientes diretamente para a página de registo do QZero!', 'pt');\n\n  if (!companyProfile) return null;\n\n  // 🌐 Usar sempre domínio de produção para QR code\n  const productionDomain = 'https://waitless-qzero.com';\n  const publicUrl = `${productionDomain}/register`;\n\n  const handlePrint = () => {\n    const printWindow = window.open('', '_blank');\n    const posterHTML = posterRef.current.innerHTML;\n    \n    printWindow.document.write(`\n      <!DOCTYPE html>\n      <html lang=\"pt-PT\">\n      <head>\n        <meta charset=\"UTF-8\">\n        <title>Cartaz ${companyProfile.name} - QZero</title>\n        <style>\n          @page { size: A4 portrait; margin: 0; }\n          * { margin: 0; padding: 0; box-sizing: border-box; }\n          body {\n            font-family: 'Arial', sans-serif;\n            background-color: #ffffff;\n            color: #111111;\n            width: 21cm;\n            height: 29.7cm;\n            margin: 0 auto;\n            display: flex;\n            flex-direction: column;\n            justify-content: flex-start;\n            align-items: center;\n          }\n          .cartaz {\n            width: 100%;\n            height: 100%;\n            padding: 2cm;\n            display: flex;\n            flex-direction: column;\n            align-items: center;\n            justify-content: space-between;\n          }\n          .header { text-align: center; margin-bottom: 2em; }\n          .logo-section { margin-bottom: 1.5em; }\n          .logo {\n            font-size: 72px;\n            font-weight: 900;\n            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);\n            -webkit-background-clip: text;\n            -webkit-text-fill-color: transparent;\n            background-clip: text;\n            letter-spacing: -2px;\n          }\n          .company-name {\n            font-size: 36px;\n            color: #111;\n            font-weight: 700;\n            margin-top: 0.5em;\n            margin-bottom: 0.3em;\n          }\n          .tagline {\n            font-size: 24px;\n            color: #333;\n            font-weight: 600;\n            margin-top: 0.5em;\n          }\n          .subtitle {\n            font-size: 18px;\n            color: #666;\n            font-weight: 400;\n          }\n          .content { flex: 1; width: 100%; max-width: 600px; }\n          h2 {\n            font-size: 32px;\n            font-weight: bold;\n            margin-bottom: 1.5em;\n            text-align: center;\n            color: #667eea;\n          }\n          .benefits { margin-bottom: 2em; }\n          .benefit-item {\n            display: flex;\n            align-items: flex-start;\n            margin-bottom: 1.5em;\n            padding: 1em;\n            background: #f8f9ff;\n            border-radius: 12px;\n            border-left: 4px solid #667eea;\n          }\n          .benefit-icon {\n            font-size: 32px;\n            margin-right: 1em;\n            flex-shrink: 0;\n          }\n          .benefit-text h3 {\n            font-size: 20px;\n            font-weight: bold;\n            color: #333;\n            margin-bottom: 0.3em;\n          }\n          .benefit-text p {\n            font-size: 16px;\n            color: #666;\n            line-height: 1.5;\n          }\n          .how-to {\n            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);\n            color: white;\n            padding: 2em;\n            border-radius: 16px;\n            margin-bottom: 2em;\n          }\n          .how-to h2 {\n            color: white;\n            font-size: 28px;\n            margin-bottom: 1em;\n          }\n          .steps { display: grid; gap: 1em; }\n          .step {\n            display: flex;\n            align-items: center;\n            background: rgba(255, 255, 255, 0.15);\n            padding: 1em;\n            border-radius: 10px;\n            backdrop-filter: blur(10px);\n          }\n          .step-number {\n            font-size: 32px;\n            font-weight: 900;\n            background: white;\n            color: #667eea;\n            width: 50px;\n            height: 50px;\n            border-radius: 50%;\n            display: flex;\n            align-items: center;\n            justify-content: center;\n            margin-right: 1em;\n            flex-shrink: 0;\n          }\n          .step-text {\n            font-size: 18px;\n            font-weight: 500;\n            line-height: 1.4;\n          }\n          .footer { text-align: center; margin-top: 2em; }\n          .qr-container {\n            width: 180px;\n            height: 180px;\n            background: white;\n            border-radius: 12px;\n            display: flex;\n            align-items: center;\n            justify-content: center;\n            margin: 0 auto 1em;\n            padding: 1em;\n            box-shadow: 0 4px 12px rgba(0,0,0,0.1);\n          }\n          .url {\n            font-size: 18px;\n            font-weight: bold;\n            color: #667eea;\n            margin-bottom: 0.5em;\n            word-break: break-all;\n          }\n          .footer-note {\n            font-size: 14px;\n            color: #999;\n            font-style: italic;\n          }\n          @media print {\n            body { width: 21cm; height: 29.7cm; }\n            .cartaz { page-break-after: avoid; }\n          }\n        </style>\n      </head>\n      <body>\n        ${posterHTML}\n      </body>\n      </html>\n    `);\n    \n    printWindow.document.close();\n    setTimeout(() => {\n      printWindow.print();\n    }, 250);\n  };\n\n  return (\n    <Dialog>\n      <DialogTrigger asChild>\n        {compact ? (\n          <Button\n            className=\"bg-gradient-to-r from-purple-600 to-pink-600 hover:from-purple-700 hover:to-pink-700 text-white h-auto py-2.5 px-3 w-full\"\n          >\n            <FileImage className=\"w-4 h-4 mr-1.5 flex-shrink-0\" />\n            <span className=\"text-xs sm:text-sm truncate\">{txtPosterBtn}</span>\n          </Button>\n        ) : (\n          <Button\n            size=\"lg\"\n            variant=\"outline\"\n            className=\"w-full border-2 border-purple-300 hover:bg-purple-50 hover:border-purple-400\"\n          >\n            <Eye className=\"w-5 h-5 mr-2\" />\n            {txtViewPrintPoster}\n          </Button>\n        )}\n      </DialogTrigger>\n      <DialogContent className=\"max-w-4xl max-h-[90vh] overflow-y-auto\">\n        <DialogHeader>\n          <DialogTitle>{txtAdvertisingPoster} - {companyProfile.name}</DialogTitle>\n          <DialogDescription>\n            {txtPrintInstructions}\n          </DialogDescription>\n        </DialogHeader>\n        \n        <div className=\"space-y-4\">\n          {/* Preview do Cartaz */}\n          <div \n            ref={posterRef}\n            className=\"bg-white border rounded-lg shadow-lg\"\n            style={{ \n              width: '100%',\n              aspectRatio: '210/297',\n              maxWidth: '600px',\n              margin: '0 auto'\n            }}\n          >\n            <div className=\"cartaz w-full h-full p-8 flex flex-col items-center justify-between\">\n              <div className=\"header text-center mb-6\">\n                <div className=\"logo-section mb-4\">\n                  <div \n                    className=\"logo text-5xl font-black\"\n                    style={{\n                      background: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',\n                      WebkitBackgroundClip: 'text',\n                      WebkitTextFillColor: 'transparent',\n                      backgroundClip: 'text',\n                      letterSpacing: '-2px'\n                    }}\n                  >\n                    QZero\n                  </div>\n                  <div className=\"company-name text-2xl text-gray-900 font-bold mt-3 mb-1\">\n                    {companyProfile.name}\n                  </div>\n                  <div className=\"tagline text-lg text-gray-700 font-semibold mt-2\">\n                    {txtZeroQueues}\n                  </div>\n                  <div className=\"subtitle text-sm text-gray-600\">\n                    {txtSmartManagement}\n                  </div>\n                </div>\n              </div>\n\n              <div className=\"content flex-1 w-full max-w-lg\">\n                <div className=\"benefits mb-6\">\n                  <div className=\"benefit-item flex items-start mb-4 p-3 bg-purple-50 rounded-lg border-l-4 border-purple-500\">\n                    <div className=\"benefit-icon text-2xl mr-3\">📱</div>\n                    <div className=\"benefit-text\">\n                      <h3 className=\"text-base font-bold text-gray-800 mb-1\">{txtGetTicketMobile}</h3>\n                      <p className=\"text-xs text-gray-600 leading-relaxed\">\n                        {txtNoNeedPresent}\n                      </p>\n                    </div>\n                  </div>\n\n                  <div className=\"benefit-item flex items-start mb-4 p-3 bg-purple-50 rounded-lg border-l-4 border-purple-500\">\n                    <div className=\"benefit-icon text-2xl mr-3\">⏰</div>\n                    <div className=\"benefit-text\">\n                      <h3 className=\"text-base font-bold text-gray-800 mb-1\">{txtBookAppointment}</h3>\n                      <p className=\"text-xs text-gray-600 leading-relaxed\">\n                        {txtChooseBestTime}\n                      </p>\n                    </div>\n                  </div>\n\n                  <div className=\"benefit-item flex items-start p-3 bg-purple-50 rounded-lg border-l-4 border-purple-500\">\n                    <div className=\"benefit-icon text-2xl mr-3\">🔔</div>\n                    <div className=\"benefit-text\">\n                      <h3 className=\"text-base font-bold text-gray-800 mb-1\">{txtReceiveNotifications}</h3>\n                      <p className=\"text-xs text-gray-600 leading-relaxed\">\n                        {txtWeNotifyYou}\n                      </p>\n                    </div>\n                  </div>\n                </div>\n\n                <div \n                  className=\"how-to text-white p-4 rounded-xl mb-6\"\n                  style={{\n                    background: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)'\n                  }}\n                >\n                  <h2 className=\"text-white text-lg font-bold mb-3\">{txtHowToUse}</h2>\n                  <div className=\"steps space-y-2\">\n                    <div className=\"step flex items-center bg-white bg-opacity-15 p-2 rounded-lg\">\n                      <div className=\"step-number text-lg font-black bg-white text-purple-600 w-8 h-8 rounded-full flex items-center justify-center mr-3 flex-shrink-0\">\n                        1\n                      </div>\n                      <div className=\"step-text text-sm font-medium\">\n                        {txtAccessQRCode}\n                      </div>\n                    </div>\n                    <div className=\"step flex items-center bg-white bg-opacity-15 p-2 rounded-lg\">\n                      <div className=\"step-number text-lg font-black bg-white text-purple-600 w-8 h-8 rounded-full flex items-center justify-center mr-3 flex-shrink-0\">\n                        2\n                      </div>\n                      <div className=\"step-text text-sm font-medium\">\n                        {txtGetTicketOrBook}\n                      </div>\n                    </div>\n                    <div className=\"step flex items-center bg-white bg-opacity-15 p-2 rounded-lg\">\n                      <div className=\"step-number text-lg font-black bg-white text-purple-600 w-8 h-8 rounded-full flex items-center justify-center mr-3 flex-shrink-0\">\n                        3\n                      </div>\n                      <div className=\"step-text text-sm font-medium\">\n                        {txtFollowRealTime}\n                      </div>\n                    </div>\n                    <div className=\"step flex items-center bg-white bg-opacity-15 p-2 rounded-lg\">\n                      <div className=\"step-number text-lg font-black bg-white text-purple-600 w-8 h-8 rounded-full flex items-center justify-center mr-3 flex-shrink-0\">\n                        4\n                      </div>\n                      <div className=\"step-text text-sm font-medium\">\n                        {txtArriveWhenCalled}\n                      </div>\n                    </div>\n                  </div>\n                </div>\n              </div>\n\n              <div className=\"footer text-center\">\n                <div className=\"qr-container w-32 h-32 bg-white rounded-lg flex items-center justify-center mx-auto mb-3 p-2 shadow-md\">\n                  <QRCodeSVG \n                    value={publicUrl}\n                    size={112}\n                    level=\"H\"\n                    includeMargin={false}\n                  />\n                </div>\n                <div className=\"url text-xs font-bold text-purple-600 mb-1 break-all px-4\">\n                  {publicUrl}\n                </div>\n                <div className=\"footer-note text-xs text-gray-500 italic\">\n                  {txtQueueSystem}\n                </div>\n              </div>\n            </div>\n          </div>\n\n          {/* Botões de Ação */}\n          <div className=\"flex gap-3 justify-center pt-4 border-t\">\n            <Button\n              onClick={handlePrint}\n              size=\"lg\"\n              className=\"bg-gradient-to-r from-purple-600 to-blue-600 hover:from-purple-700 hover:to-blue-700\"\n            >\n              <Printer className=\"w-5 h-5 mr-2\" />\n              {txtPrintPosterA4}\n            </Button>\n          </div>\n\n          <div className=\"text-sm text-gray-600 bg-blue-50 p-3 rounded-lg border border-blue-200\">\n            <p className=\"font-medium mb-1\">💡 {txtTip}</p>\n            <p>{txtQRCodeLeads}</p>\n          </div>\n        </div>\n      </DialogContent>\n    </Dialog>\n  );\n}\n","path":null,"size_bytes":15953,"size_tokens":null},"src/hooks/useConfirm.jsx":{"content":"import { useState, useCallback, useRef, useEffect } from 'react';\nimport {\n  AlertDialog,\n  AlertDialogContent,\n  AlertDialogDescription,\n  AlertDialogFooter,\n  AlertDialogHeader,\n  AlertDialogTitle,\n} from \"@/components/ui/alert-dialog\";\nimport { Button } from \"@/components/ui/button\";\nimport { useAutoTranslate } from '@/hooks/useTranslate';\n\nexport function useConfirm() {\n  const txtDefaultCancel = useAutoTranslate('Cancelar', 'pt');\n  const txtDefaultConfirm = useAutoTranslate('Confirmar', 'pt');\n  \n  const [state, setState] = useState({\n    isOpen: false,\n    title: '',\n    description: '',\n    confirmText: '',\n    cancelText: '',\n    variant: 'default',\n  });\n  \n  const resolveRef = useRef(null);\n\n  const confirm = useCallback(({ title, description, confirmText, cancelText, variant = 'default' }) => {\n    return new Promise((resolve) => {\n      resolveRef.current = resolve;\n      setState({\n        isOpen: true,\n        title,\n        description,\n        confirmText: confirmText || txtDefaultConfirm,\n        cancelText: cancelText || txtDefaultCancel,\n        variant,\n      });\n    });\n  }, [txtDefaultConfirm, txtDefaultCancel]);\n\n  const handleConfirm = useCallback(() => {\n    console.log('🔴 CONFIRM CLICKED');\n    setState(prev => ({ ...prev, isOpen: false }));\n    setTimeout(() => {\n      if (resolveRef.current) {\n        console.log('🔴 RESOLVING WITH TRUE');\n        resolveRef.current(true);\n        resolveRef.current = null;\n      }\n    }, 100);\n  }, []);\n\n  const handleCancel = useCallback(() => {\n    console.log('🔴 CANCEL CLICKED');\n    setState(prev => ({ ...prev, isOpen: false }));\n    setTimeout(() => {\n      if (resolveRef.current) {\n        console.log('🔴 RESOLVING WITH FALSE');\n        resolveRef.current(false);\n        resolveRef.current = null;\n      }\n    }, 100);\n  }, []);\n\n  const ConfirmDialog = () => (\n    <AlertDialog open={state.isOpen} onOpenChange={(open) => {\n      if (!open && state.isOpen) {\n        handleCancel();\n      }\n    }}>\n      <AlertDialogContent className=\"max-w-[90vw] sm:max-w-md\">\n        <AlertDialogHeader>\n          <AlertDialogTitle className=\"text-base sm:text-lg\">{state.title}</AlertDialogTitle>\n          <AlertDialogDescription className=\"text-sm sm:text-base\">\n            {state.description}\n          </AlertDialogDescription>\n        </AlertDialogHeader>\n        <AlertDialogFooter className=\"flex-col sm:flex-row gap-2\">\n          <Button \n            variant=\"outline\"\n            onClick={handleCancel} \n            className=\"w-full sm:w-auto\"\n          >\n            {state.cancelText || txtDefaultCancel}\n          </Button>\n          <Button \n            onClick={handleConfirm}\n            className={`w-full sm:w-auto ${\n              state.variant === 'destructive' \n                ? 'bg-gradient-to-r from-red-500 to-rose-600 hover:from-red-600 hover:to-rose-700 text-white' \n                : 'bg-gradient-to-r from-sky-500 to-blue-600 hover:from-sky-600 hover:to-blue-700 text-white'\n            }`}\n          >\n            {state.confirmText || txtDefaultConfirm}\n          </Button>\n        </AlertDialogFooter>\n      </AlertDialogContent>\n    </AlertDialog>\n  );\n\n  return { confirm, ConfirmDialog };\n}\n","path":null,"size_bytes":3225,"size_tokens":null},"src/components/business/ImageUpload.jsx":{"content":"import { useState, useRef, useEffect } from 'react';\nimport { Button } from '@/components/ui/button';\nimport { Label } from '@/components/ui/label';\nimport { Upload, X, Image as ImageIcon, Loader2 } from 'lucide-react';\nimport { base44 } from '@/api/base44Client';\nimport { toast } from 'sonner';\nimport { useAutoTranslate } from '@/hooks/useTranslate';\nimport { Capacitor } from '@capacitor/core';\nimport { Camera, CameraResultType, CameraSource } from '@capacitor/camera';\nimport { getUploadUrl } from '@/utils/apiConfig';\n\nexport function ImageUpload({ \n  label, \n  value, \n  onChange, \n  required = false,\n  helpText \n}) {\n  const txtInvalidFileType = useAutoTranslate('Tipo de ficheiro inválido. Apenas PNG, JPG, JPEG e GIF são permitidos.', 'pt');\n  const txtFileTooLarge = useAutoTranslate('Ficheiro demasiado grande. Tamanho máximo: 5MB', 'pt');\n  const txtImageUploaded = useAutoTranslate('Imagem carregada com sucesso!', 'pt');\n  const txtUploadError = useAutoTranslate('Erro ao carregar imagem', 'pt');\n  const txtImageRemoved = useAutoTranslate('Imagem removida', 'pt');\n  const txtLoading = useAutoTranslate('A carregar...', 'pt');\n  const txtReplace = useAutoTranslate('Substituir', 'pt');\n  const txtRemove = useAutoTranslate('Remover', 'pt');\n  const txtLoadingImage = useAutoTranslate('A carregar imagem...', 'pt');\n  const txtClickToChoose = useAutoTranslate('Clique para escolher ficheiro', 'pt');\n  const txtOrDragHere = useAutoTranslate('ou arraste aqui', 'pt');\n  const txtMaxSize = useAutoTranslate('PNG, JPG, GIF (máx. 5MB)', 'pt');\n  const txtPreview = useAutoTranslate('Pré-visualização', 'pt');\n  const txtPermissionDenied = useAutoTranslate('Permissão para aceder à galeria negada', 'pt');\n  const txtSelectionCancelled = useAutoTranslate('Seleção de imagem cancelada', 'pt');\n  const txtImageNotAvailable = useAutoTranslate('A imagem anterior não está disponível. Por favor, faça upload de uma nova.', 'pt');\n\n  const [uploading, setUploading] = useState(false);\n  const [preview, setPreview] = useState(null);\n  const [imageError, setImageError] = useState(false);\n  const fileInputRef = useRef(null);\n\n  useEffect(() => {\n    if (value) {\n      setPreview(getUploadUrl(value));\n      setImageError(false);\n    } else {\n      setPreview(null);\n      setImageError(false);\n    }\n  }, [value]);\n\n  const handleImageError = () => {\n    console.warn('⚠️ Erro ao carregar imagem:', preview);\n    setImageError(true);\n  };\n\n  const handleCapacitorImagePick = async () => {\n    try {\n      const image = await Camera.getPhoto({\n        quality: 90,\n        allowEditing: false,\n        resultType: CameraResultType.DataUrl,\n        source: CameraSource.Photos\n      });\n\n      if (!image.dataUrl) {\n        toast.error(txtUploadError);\n        return;\n      }\n\n      setPreview(image.dataUrl);\n      setUploading(true);\n\n      try {\n        const response = await fetch(image.dataUrl);\n        const blob = await response.blob();\n        \n        const mimeType = image.format === 'png' ? 'image/png' : 'image/jpeg';\n        const extension = image.format === 'png' ? 'png' : 'jpg';\n        const fileName = `image_${Date.now()}.${extension}`;\n        \n        const file = new File([blob], fileName, { type: mimeType });\n\n        const maxSize = 5 * 1024 * 1024;\n        if (file.size > maxSize) {\n          toast.error(txtFileTooLarge);\n          setPreview(null);\n          return;\n        }\n\n        const { file_url } = await base44.integrations.Core.UploadFile({ file });\n        onChange(file_url);\n        toast.success(txtImageUploaded);\n      } catch (uploadError) {\n        console.error('Erro no upload:', uploadError);\n        toast.error(uploadError.message || txtUploadError);\n        setPreview(null);\n      } finally {\n        setUploading(false);\n      }\n    } catch (error) {\n      console.error('Erro ao selecionar imagem:', error);\n      \n      if (error.message?.includes('User cancelled') || error.message?.includes('canceled')) {\n        return;\n      }\n      \n      if (error.message?.includes('permission') || error.message?.includes('denied')) {\n        toast.error(txtPermissionDenied);\n      } else {\n        toast.error(txtUploadError);\n      }\n    }\n  };\n\n  const handleFileChange = async (e) => {\n    const file = e.target.files?.[0];\n    if (!file) return;\n\n    const allowedTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/gif'];\n    if (!allowedTypes.includes(file.type)) {\n      toast.error(txtInvalidFileType);\n      return;\n    }\n\n    const maxSize = 5 * 1024 * 1024;\n    if (file.size > maxSize) {\n      toast.error(txtFileTooLarge);\n      return;\n    }\n\n    const reader = new FileReader();\n    reader.onloadend = () => {\n      setPreview(reader.result);\n    };\n    reader.readAsDataURL(file);\n\n    setUploading(true);\n    try {\n      const { file_url } = await base44.integrations.Core.UploadFile({ file });\n      onChange(file_url);\n      toast.success(txtImageUploaded);\n    } catch (error) {\n      console.error('Erro no upload:', error);\n      toast.error(error.message || txtUploadError);\n      setPreview(null);\n    } finally {\n      setUploading(false);\n    }\n  };\n\n  const handleRemove = async () => {\n    if (value) {\n      try {\n        await fetch('/api/delete-image', {\n          method: 'DELETE',\n          headers: { 'Content-Type': 'application/json' },\n          body: JSON.stringify({ fileUrl: value })\n        });\n      } catch (error) {\n        console.error('Erro ao apagar imagem:', error);\n      }\n    }\n    \n    setPreview(null);\n    onChange(null);\n    if (fileInputRef.current) {\n      fileInputRef.current.value = '';\n    }\n    toast.success(txtImageRemoved);\n  };\n\n  const handleButtonClick = () => {\n    if (Capacitor.isNativePlatform()) {\n      handleCapacitorImagePick();\n    } else {\n      fileInputRef.current?.click();\n    }\n  };\n\n  return (\n    <div className=\"space-y-3\">\n      <Label className={required ? 'required' : ''}>\n        {label}\n      </Label>\n      \n      {helpText && (\n        <p className=\"text-sm text-slate-500\">{helpText}</p>\n      )}\n\n      <input\n        ref={fileInputRef}\n        type=\"file\"\n        accept=\"image/png,image/jpeg,image/jpg,image/gif\"\n        onChange={handleFileChange}\n        className=\"hidden\"\n        disabled={uploading}\n      />\n\n      {preview && !imageError ? (\n        <div className=\"relative border-2 border-slate-200 rounded-lg p-4 bg-slate-50\">\n          <img\n            src={preview}\n            alt={txtPreview}\n            className=\"max-w-full max-h-64 mx-auto rounded-lg object-contain\"\n            onError={handleImageError}\n          />\n          <div className=\"mt-3 flex gap-2\">\n            <Button\n              type=\"button\"\n              variant=\"outline\"\n              size=\"sm\"\n              onClick={handleButtonClick}\n              disabled={uploading}\n              className=\"flex-1\"\n            >\n              {uploading ? (\n                <>\n                  <Loader2 className=\"w-4 h-4 mr-2 animate-spin\" />\n                  {txtLoading}\n                </>\n              ) : (\n                <>\n                  <Upload className=\"w-4 h-4 mr-2\" />\n                  {txtReplace}\n                </>\n              )}\n            </Button>\n            <Button\n              type=\"button\"\n              variant=\"destructive\"\n              size=\"sm\"\n              onClick={handleRemove}\n              disabled={uploading}\n            >\n              <X className=\"w-4 h-4 mr-2\" />\n              {txtRemove}\n            </Button>\n          </div>\n        </div>\n      ) : preview && imageError ? (\n        <div className=\"relative border-2 border-orange-300 rounded-lg p-4 bg-orange-50\">\n          <div className=\"flex flex-col items-center gap-3 py-4\">\n            <div className=\"w-16 h-16 bg-orange-100 rounded-full flex items-center justify-center\">\n              <ImageIcon className=\"w-8 h-8 text-orange-500\" />\n            </div>\n            <p className=\"text-sm text-orange-700 text-center\">\n              {txtImageNotAvailable}\n            </p>\n          </div>\n          <div className=\"mt-3 flex gap-2\">\n            <Button\n              type=\"button\"\n              variant=\"outline\"\n              size=\"sm\"\n              onClick={handleButtonClick}\n              disabled={uploading}\n              className=\"flex-1 border-orange-400 text-orange-700 hover:bg-orange-100\"\n            >\n              <Upload className=\"w-4 h-4 mr-2\" />\n              {txtReplace}\n            </Button>\n            <Button\n              type=\"button\"\n              variant=\"destructive\"\n              size=\"sm\"\n              onClick={handleRemove}\n              disabled={uploading}\n            >\n              <X className=\"w-4 h-4 mr-2\" />\n              {txtRemove}\n            </Button>\n          </div>\n        </div>\n      ) : (\n        <Button\n          type=\"button\"\n          variant=\"outline\"\n          onClick={handleButtonClick}\n          disabled={uploading}\n          className=\"w-full h-32 border-2 border-dashed border-slate-300 hover:border-indigo-400 hover:bg-indigo-50/50\"\n        >\n          {uploading ? (\n            <div className=\"flex flex-col items-center gap-2\">\n              <Loader2 className=\"w-8 h-8 animate-spin text-indigo-600\" />\n              <span className=\"text-sm text-slate-600\">{txtLoadingImage}</span>\n            </div>\n          ) : (\n            <div className=\"flex flex-col items-center gap-2\">\n              <ImageIcon className=\"w-8 h-8 text-slate-400\" />\n              <div className=\"text-sm\">\n                <span className=\"font-semibold text-indigo-600\">{txtClickToChoose}</span>\n                <span className=\"text-slate-500\"> {txtOrDragHere}</span>\n              </div>\n              <span className=\"text-xs text-slate-400\">{txtMaxSize}</span>\n            </div>\n          )}\n        </Button>\n      )}\n    </div>\n  );\n}\n","path":null,"size_bytes":9876,"size_tokens":null},"src/components/business/MultiImageUpload.jsx":{"content":"import { useState, useRef, useEffect } from 'react';\nimport { Button } from '@/components/ui/button';\nimport { Label } from '@/components/ui/label';\nimport { Upload, X, Image as ImageIcon, Loader2 } from 'lucide-react';\nimport { base44 } from '@/api/base44Client';\nimport { toast } from 'sonner';\nimport { useAutoTranslate } from '@/hooks/useTranslate';\nimport { getUploadUrl } from '@/utils/apiConfig';\n\nexport function MultiImageUpload({ \n  label = \"Galeria de Fotos\", \n  value = [], \n  onChange, \n  maxImages = 10,\n  helpText = \"Adicione fotos da sua empresa (ex: instalações, produtos, pratos)\"\n}) {\n  const txtInvalidType = useAutoTranslate('Tipo inválido. Apenas PNG, JPG, JPEG e GIF.', 'pt');\n  const txtFileTooLarge = useAutoTranslate('Ficheiro demasiado grande (máx 5MB)', 'pt');\n  const txtMaxPhotosReached = useAutoTranslate('Máximo de fotos atingido', 'pt');\n  const txtUploadedSuccess = useAutoTranslate('carregada com sucesso!', 'pt');\n  const txtUploadError = useAutoTranslate('Erro ao carregar', 'pt');\n  const txtPhotoRemoved = useAutoTranslate('Foto removida com sucesso!', 'pt');\n  const txtPhotoRemovedWarning = useAutoTranslate('Foto removida da galeria (ficheiro pode permanecer no servidor)', 'pt');\n  const txtPhoto = useAutoTranslate('Foto', 'pt');\n  const txtRemovePhoto = useAutoTranslate('Remover foto', 'pt');\n  const txtLoading = useAutoTranslate('A carregar...', 'pt');\n  const txtAddPhotos = useAutoTranslate('Adicionar Fotos', 'pt');\n  const txtAddMorePhotos = useAutoTranslate('Adicionar Mais Fotos', 'pt');\n  const txtPhotoAdded = useAutoTranslate('foto adicionada', 'pt');\n  const txtPhotosAdded = useAutoTranslate('fotos adicionadas', 'pt');\n\n  const [uploading, setUploading] = useState(false);\n  const [images, setImages] = useState(value || []);\n  const fileInputRef = useRef(null);\n\n  useEffect(() => {\n    setImages(value || []);\n  }, [value]);\n\n  const handleFileChange = async (e) => {\n    const files = Array.from(e.target.files || []);\n    if (!files.length) return;\n\n    const allowedTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/gif'];\n    const maxSize = 5 * 1024 * 1024;\n\n    setUploading(true);\n    \n    for (const file of files) {\n      if (!allowedTypes.includes(file.type)) {\n        toast.error(`${file.name}: ${txtInvalidType}`);\n        continue;\n      }\n\n      if (file.size > maxSize) {\n        toast.error(`${file.name}: ${txtFileTooLarge}`);\n        continue;\n      }\n\n      try {\n        const { file_url } = await base44.integrations.Core.UploadFile({ file });\n        \n        setImages(prev => {\n          if (prev.length >= maxImages) {\n            toast.error(`${txtMaxPhotosReached} (${maxImages})`);\n            return prev;\n          }\n          const updated = [...prev, file_url];\n          onChange(updated);\n          return updated;\n        });\n        \n        toast.success(`${file.name} ${txtUploadedSuccess}`);\n      } catch (error) {\n        console.error('Erro no upload:', error);\n        toast.error(`${txtUploadError} ${file.name}`);\n      }\n    }\n    \n    setUploading(false);\n\n    if (fileInputRef.current) {\n      fileInputRef.current.value = '';\n    }\n  };\n\n  const handleRemove = async (indexToRemove) => {\n    const imageUrl = images[indexToRemove];\n    \n    try {\n      await base44.integrations.Core.DeleteFile({ fileUrl: imageUrl });\n      \n      setImages(prev => {\n        const updated = prev.filter((_, index) => index !== indexToRemove);\n        onChange(updated);\n        return updated;\n      });\n      \n      toast.success(txtPhotoRemoved);\n    } catch (error) {\n      console.error('Erro ao remover foto:', error);\n      \n      setImages(prev => {\n        const updated = prev.filter((_, index) => index !== indexToRemove);\n        onChange(updated);\n        return updated;\n      });\n      \n      toast.warning(txtPhotoRemovedWarning);\n    }\n  };\n\n  return (\n    <div className=\"space-y-3\">\n      {label && (\n        <Label className=\"text-sm font-medium text-slate-700\">\n          {label}\n        </Label>\n      )}\n      \n      {helpText && (\n        <p className=\"text-xs text-slate-500\">{helpText}</p>\n      )}\n\n      <input\n        ref={fileInputRef}\n        type=\"file\"\n        accept=\"image/png,image/jpeg,image/jpg,image/gif\"\n        multiple\n        onChange={handleFileChange}\n        className=\"hidden\"\n        disabled={uploading || images.length >= maxImages}\n      />\n\n      {images.length > 0 && (\n        <div className=\"grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-3\">\n          {images.map((imageUrl, index) => (\n            <div\n              key={index}\n              className=\"relative aspect-square rounded-lg overflow-hidden border-2 border-slate-200 bg-slate-50 group\"\n            >\n              <img\n                src={getUploadUrl(imageUrl)}\n                alt={`${txtPhoto} ${index + 1}`}\n                className=\"w-full h-full object-cover transition-transform group-hover:scale-105\"\n                onError={(e) => {\n                  e.target.src = 'data:image/svg+xml,%3Csvg xmlns=\"http://www.w3.org/2000/svg\" width=\"100\" height=\"100\"%3E%3Crect fill=\"%23f1f5f9\" width=\"100\" height=\"100\"/%3E%3Ctext x=\"50%25\" y=\"50%25\" dominant-baseline=\"middle\" text-anchor=\"middle\" fill=\"%2394a3b8\"%3EErro%3C/text%3E%3C/svg%3E';\n                }}\n              />\n              <button\n                type=\"button\"\n                onClick={() => handleRemove(index)}\n                className=\"absolute top-2 right-2 bg-red-500 text-white p-1.5 rounded-full opacity-0 group-hover:opacity-100 transition-opacity hover:bg-red-600 shadow-lg\"\n                title={txtRemovePhoto}\n              >\n                <X className=\"w-4 h-4\" />\n              </button>\n              <div className=\"absolute bottom-0 left-0 right-0 bg-gradient-to-t from-black/50 to-transparent p-2 opacity-0 group-hover:opacity-100 transition-opacity\">\n                <p className=\"text-white text-xs font-medium\">{txtPhoto} {index + 1}</p>\n              </div>\n            </div>\n          ))}\n        </div>\n      )}\n\n      <Button\n        type=\"button\"\n        variant=\"outline\"\n        size=\"sm\"\n        onClick={() => fileInputRef.current?.click()}\n        disabled={uploading || images.length >= maxImages}\n        className=\"w-full border-dashed border-2 h-20 hover:border-blue-500 hover:bg-blue-50 transition-colors\"\n      >\n        {uploading ? (\n          <>\n            <Loader2 className=\"w-5 h-5 mr-2 animate-spin\" />\n            {txtLoading}\n          </>\n        ) : (\n          <>\n            <Upload className=\"w-5 h-5 mr-2\" />\n            {images.length === 0 \n              ? txtAddPhotos \n              : `${txtAddMorePhotos} (${images.length}/${maxImages})`\n            }\n          </>\n        )}\n      </Button>\n\n      {images.length > 0 && (\n        <p className=\"text-xs text-green-600 font-medium\">\n          ✓ {images.length} {images.length === 1 ? txtPhotoAdded : txtPhotosAdded}\n        </p>\n      )}\n    </div>\n  );\n}\n","path":null,"size_bytes":6972,"size_tokens":null},"src/pages/BusinessAppointmentHistory.jsx":{"content":"import React, { useState, useEffect } from \"react\";\nimport { base44 } from \"@/api/base44Client\";\nimport { useQuery, useMutation, useQueryClient } from \"@tanstack/react-query\";\nimport { useNavigate } from \"react-router-dom\";\nimport { createPageUrl } from \"@/utils\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Input } from \"@/components/ui/input\";\nimport { Button } from \"@/components/ui/button\";\nimport { \n  Search,\n  Clock, \n  CheckCircle2,\n  XCircle,\n  Calendar,\n  User,\n  Phone,\n  Hash,\n  TrendingUp,\n  AlertCircle,\n  Filter,\n  Trash2\n} from \"lucide-react\";\nimport { Skeleton } from \"@/components/ui/skeleton\";\nimport { format } from \"date-fns\";\nimport { pt } from \"date-fns/locale\";\nimport PageHeader from \"../components/shared/PageHeader\";\nimport { toast } from \"sonner\";\nimport { useConfirm } from \"@/hooks/useConfirm\";\nimport {\n  Select,\n  SelectContent,\n  SelectItem,\n  SelectTrigger,\n  SelectValue,\n} from \"@/components/ui/select\";\nimport { useAutoTranslate } from \"@/hooks/useTranslate\";\n\nexport default function BusinessAppointmentHistoryPage() {\n  const txtCompleted = useAutoTranslate('Concluído', 'pt');\n  const txtCancelled = useAutoTranslate('Cancelado', 'pt');\n  const txtNoShow = useAutoTranslate('Falta', 'pt');\n  const txtSubscriptionRequired = useAutoTranslate('Subscrição Necessária', 'pt');\n  const txtSubscriptionMessage = useAutoTranslate('Para aceder ao histórico de marcações, precisa de ativar o plano empresarial.', 'pt');\n  const txtPageTitle = useAutoTranslate('Histórico de Marcações', 'pt');\n  const txtPageSubtitle = useAutoTranslate('Consulte o histórico completo de marcações', 'pt');\n  const txtCompletedLabel = useAutoTranslate('Concluídas', 'pt');\n  const txtCancelledLabel = useAutoTranslate('Canceladas', 'pt');\n  const txtNoShowLabel = useAutoTranslate('Faltas', 'pt');\n  const txtSearchAppointments = useAutoTranslate('Pesquisar Marcações', 'pt');\n  const txtSearchPlaceholder = useAutoTranslate('Procurar por nome, telefone, email ou serviço...', 'pt');\n  const txtFilterByStatus = useAutoTranslate('Filtrar por status', 'pt');\n  const txtAll = useAutoTranslate('Todos', 'pt');\n  const txtCompletedFilter = useAutoTranslate('Concluídos', 'pt');\n  const txtCancelledFilter = useAutoTranslate('Cancelados', 'pt');\n  const txtNoShowFilter = useAutoTranslate('Faltas', 'pt');\n  const txtNoAppointmentFound = useAutoTranslate('Nenhuma marcação encontrada', 'pt');\n  const txtNoHistory = useAutoTranslate('Sem histórico', 'pt');\n  const txtAdjustFilters = useAutoTranslate('Tente ajustar os filtros de pesquisa', 'pt');\n  const txtHistoryWillAppear = useAutoTranslate('O histórico de marcações concluídas aparecerá aqui', 'pt');\n  const txtAppointment = useAutoTranslate('marcação', 'pt');\n  const txtAppointments = useAutoTranslate('marcações', 'pt');\n  const txtFound = useAutoTranslate('encontradas', 'pt');\n  const txtClearHistory = useAutoTranslate('Limpar Histórico', 'pt');\n  const txtClearing = useAutoTranslate('Limpando...', 'pt');\n  const txtClearHistoryTitle = useAutoTranslate('Limpar Histórico de Marcações', 'pt');\n  const txtConfirmClear = useAutoTranslate('Tem certeza que deseja remover todas as', 'pt');\n  const txtFromHistory = useAutoTranslate('marcações do histórico? Esta ação não pode ser desfeita.', 'pt');\n  const txtYesClear = useAutoTranslate('Sim, limpar histórico', 'pt');\n  const txtCancel = useAutoTranslate('Cancelar', 'pt');\n  const txtAppointmentRemoved = useAutoTranslate('marcação removida', 'pt');\n  const txtAppointmentsRemoved = useAutoTranslate('marcações removidas', 'pt');\n  const txtFromHistoryMsg = useAutoTranslate('do histórico', 'pt');\n  const txtErrorClearing = useAutoTranslate('Erro ao limpar histórico', 'pt');\n  const txtService = useAutoTranslate('Serviço', 'pt');\n  const txtDateNotAvailable = useAutoTranslate('Data não disponível', 'pt');\n  const txtNotes = useAutoTranslate('Notas:', 'pt');\n  const txtRating = useAutoTranslate('Avaliação', 'pt');\n\n  const statusConfig = {\n    concluido: { \n      icon: CheckCircle2, \n      color: \"bg-green-100 text-green-700 border-green-200\", \n      label: txtCompleted \n    },\n    cancelado: { \n      icon: XCircle, \n      color: \"bg-red-100 text-red-700 border-red-200\", \n      label: txtCancelled \n    },\n    falta: { \n      icon: AlertCircle, \n      color: \"bg-orange-100 text-orange-700 border-orange-200\", \n      label: txtNoShow \n    }\n  };\n  const navigate = useNavigate();\n  const queryClient = useQueryClient();\n  const { ConfirmDialog, confirm } = useConfirm();\n  const [user, setUser] = useState(null);\n  const [searchTerm, setSearchTerm] = useState(\"\");\n  const [statusFilter, setStatusFilter] = useState(\"all\");\n\n  useEffect(() => {\n    base44.auth.me().then(userData => {\n      setUser(userData);\n      if (!userData.is_business_user || !userData.business_id) {\n        navigate(createPageUrl(\"Home\"));\n      }\n    }).catch(() => base44.auth.redirectToLogin());\n  }, [navigate]);\n\n  const hasSubscription = user?.has_business_subscription;\n\n  const { data: appointments, isLoading } = useQuery({\n    queryKey: ['business-appointment-history', user?.business_id],\n    queryFn: () => base44.entities.Appointment.filter({ \n      business_id: user.business_id,\n      status: { $in: ['concluido', 'cancelado', 'falta'] }\n    }, '-appointment_date'),\n    initialData: [],\n    enabled: !!user?.business_id && hasSubscription,\n  });\n\n  const { data: services } = useQuery({\n    queryKey: ['business-services', user?.business_id],\n    queryFn: () => base44.entities.Service.filter({ business_id: user.business_id }),\n    initialData: [],\n    enabled: !!user?.business_id,\n  });\n\n  const clearHistoryMutation = useMutation({\n    mutationFn: async () => {\n      const appointmentsToDelete = appointments.filter(a => \n        a && ['concluido', 'cancelado', 'falta'].includes(a.status)\n      );\n      \n      for (const appointment of appointmentsToDelete) {\n        await base44.entities.Appointment.delete(appointment.id);\n      }\n      \n      return appointmentsToDelete.length;\n    },\n    onSuccess: (count) => {\n      queryClient.invalidateQueries({ queryKey: ['business-appointment-history'] });\n      toast.success(`${count} ${count === 1 ? txtAppointmentRemoved : txtAppointmentsRemoved} ${txtFromHistoryMsg}`);\n    },\n    onError: () => {\n      toast.error(txtErrorClearing);\n    }\n  });\n\n  const handleClearHistory = async () => {\n    const confirmed = await confirm({\n      title: txtClearHistoryTitle,\n      description: `${txtConfirmClear} ${appointments.length} ${txtFromHistory}`,\n      confirmText: txtYesClear,\n      cancelText: txtCancel\n    });\n\n    if (confirmed) {\n      clearHistoryMutation.mutate();\n    }\n  };\n\n  if (!user || isLoading) {\n    return (\n      <div className=\"bg-gradient-to-br from-slate-50 via-blue-50 to-sky-50 p-4\">\n        <div className=\"max-w-6xl mx-auto\">\n          <Skeleton className=\"h-16 w-64 mb-8\" />\n          <Skeleton className=\"h-96 w-full\" />\n        </div>\n      </div>\n    );\n  }\n\n  if (!hasSubscription) {\n    return (\n      <div className=\"bg-gradient-to-br from-slate-50 via-blue-50 to-sky-50\">\n        <div className=\"max-w-4xl mx-auto px-4 py-4\">\n          <Card className=\"border-0 shadow-2xl\">\n            <CardContent className=\"p-12 text-center\">\n              <Clock className=\"w-16 h-16 text-amber-600 mx-auto mb-6\" />\n              <h2 className=\"text-3xl font-bold text-slate-900 mb-4\">\n                {txtSubscriptionRequired}\n              </h2>\n              <p className=\"text-lg text-slate-600 mb-8\">\n                {txtSubscriptionMessage}\n              </p>\n            </CardContent>\n          </Card>\n        </div>\n      </div>\n    );\n  }\n\n  const getServiceName = (serviceId) => {\n    return services.find(s => s && s.id === serviceId)?.name || txtService;\n  };\n\n  const filteredAppointments = appointments.filter(appointment => {\n    if (!appointment) return false;\n\n    const matchesStatus = statusFilter === \"all\" || appointment.status === statusFilter;\n\n    if (!searchTerm) return matchesStatus;\n\n    const searchLower = searchTerm.toLowerCase();\n    const matchesSearch = \n      appointment.user_email?.toLowerCase().includes(searchLower) ||\n      appointment.user_phone?.toLowerCase().includes(searchLower) ||\n      appointment.user_name?.toLowerCase().includes(searchLower) ||\n      getServiceName(appointment.service_id).toLowerCase().includes(searchLower);\n\n    return matchesStatus && matchesSearch;\n  });\n\n  const completedAppointments = appointments.filter(a => a?.status === 'concluido');\n  const cancelledAppointments = appointments.filter(a => a?.status === 'cancelado');\n  const noShowAppointments = appointments.filter(a => a?.status === 'falta');\n\n  return (\n    <div className=\"bg-gradient-to-br from-slate-50 via-blue-50 to-sky-50\">\n      <div className=\"max-w-6xl mx-auto px-4 py-4\">\n        <PageHeader\n          title={txtPageTitle}\n          subtitle={txtPageSubtitle}\n          backTo=\"BusinessDashboard\"\n        />\n\n        <div className=\"grid md:grid-cols-3 gap-6 mb-8\">\n          <Card className=\"border-0 shadow-lg\">\n            <CardContent className=\"p-6\">\n              <div className=\"flex items-center gap-4\">\n                <div className=\"p-3 bg-green-100 rounded-full\">\n                  <CheckCircle2 className=\"w-6 h-6 text-green-600\" />\n                </div>\n                <div>\n                  <p className=\"text-2xl font-bold text-slate-900\">{completedAppointments.length}</p>\n                  <p className=\"text-sm text-slate-600\">{txtCompletedLabel}</p>\n                </div>\n              </div>\n            </CardContent>\n          </Card>\n\n          <Card className=\"border-0 shadow-lg\">\n            <CardContent className=\"p-6\">\n              <div className=\"flex items-center gap-4\">\n                <div className=\"p-3 bg-red-100 rounded-full\">\n                  <XCircle className=\"w-6 h-6 text-red-600\" />\n                </div>\n                <div>\n                  <p className=\"text-2xl font-bold text-slate-900\">{cancelledAppointments.length}</p>\n                  <p className=\"text-sm text-slate-600\">{txtCancelledLabel}</p>\n                </div>\n              </div>\n            </CardContent>\n          </Card>\n\n          <Card className=\"border-0 shadow-lg\">\n            <CardContent className=\"p-6\">\n              <div className=\"flex items-center gap-4\">\n                <div className=\"p-3 bg-orange-100 rounded-full\">\n                  <AlertCircle className=\"w-6 h-6 text-orange-600\" />\n                </div>\n                <div>\n                  <p className=\"text-2xl font-bold text-slate-900\">{noShowAppointments.length}</p>\n                  <p className=\"text-sm text-slate-600\">{txtNoShowLabel}</p>\n                </div>\n              </div>\n            </CardContent>\n          </Card>\n        </div>\n\n        <Card className=\"border-0 shadow-xl mb-6\">\n          <CardHeader>\n            <CardTitle className=\"flex items-center gap-2\">\n              <Search className=\"w-5 h-5\" />\n              {txtSearchAppointments}\n            </CardTitle>\n          </CardHeader>\n          <CardContent>\n            <div className=\"flex flex-col md:flex-row gap-4\">\n              <div className=\"flex-1 relative\">\n                <Search className=\"absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-slate-400\" />\n                <Input\n                  placeholder={txtSearchPlaceholder}\n                  value={searchTerm}\n                  onChange={(e) => setSearchTerm(e.target.value)}\n                  className=\"pl-10\"\n                />\n              </div>\n              <Select value={statusFilter} onValueChange={setStatusFilter}>\n                <SelectTrigger className=\"w-full md:w-48\">\n                  <Filter className=\"w-4 h-4 mr-2\" />\n                  <SelectValue placeholder={txtFilterByStatus} />\n                </SelectTrigger>\n                <SelectContent>\n                  <SelectItem value=\"all\">{txtAll}</SelectItem>\n                  <SelectItem value=\"concluido\">{txtCompletedFilter}</SelectItem>\n                  <SelectItem value=\"cancelado\">{txtCancelledFilter}</SelectItem>\n                  <SelectItem value=\"falta\">{txtNoShowFilter}</SelectItem>\n                </SelectContent>\n              </Select>\n            </div>\n          </CardContent>\n        </Card>\n\n        {filteredAppointments.length === 0 ? (\n          <Card className=\"border-0 shadow-lg\">\n            <CardContent className=\"py-16 text-center\">\n              <Calendar className=\"w-16 h-16 text-slate-400 mx-auto mb-4\" />\n              <h3 className=\"text-xl font-bold text-slate-900 mb-2\">\n                {searchTerm || statusFilter !== \"all\" \n                  ? txtNoAppointmentFound\n                  : txtNoHistory\n                }\n              </h3>\n              <p className=\"text-slate-600\">\n                {searchTerm || statusFilter !== \"all\"\n                  ? txtAdjustFilters\n                  : txtHistoryWillAppear\n                }\n              </p>\n            </CardContent>\n          </Card>\n        ) : (\n          <div className=\"space-y-4\">\n            <div className=\"flex justify-between items-center\">\n              <p className=\"text-sm text-slate-600\">\n                {filteredAppointments.length} {filteredAppointments.length === 1 ? txtAppointment : txtAppointments} {txtFound}\n              </p>\n              <Button\n                variant=\"outline\"\n                size=\"sm\"\n                onClick={handleClearHistory}\n                disabled={clearHistoryMutation.isPending || appointments.length === 0}\n                className=\"border-red-200 text-red-600 hover:bg-red-50\"\n              >\n                <Trash2 className=\"w-4 h-4 mr-2\" />\n                {clearHistoryMutation.isPending ? txtClearing : txtClearHistory}\n              </Button>\n            </div>\n\n            <div className=\"grid gap-4\">\n              {filteredAppointments.map(appointment => {\n                if (!appointment) return null;\n                \n                const status = statusConfig[appointment.status];\n                const StatusIcon = status.icon;\n\n                return (\n                  <Card key={appointment.id} className=\"border-0 shadow-lg hover:shadow-xl transition-all\">\n                    <CardContent className=\"p-6\">\n                      <div className=\"flex flex-col md:flex-row justify-between gap-4\">\n                        <div className=\"flex-1\">\n                          <div className=\"flex items-center gap-3 mb-3\">\n                            <div className=\"flex items-center gap-2\">\n                              <Calendar className=\"w-5 h-5 text-sky-600\" />\n                              <span className=\"text-lg font-bold text-slate-900\">\n                                {(() => {\n                                  try {\n                                    if (!appointment.appointment_date) return txtDateNotAvailable;\n                                    const date = new Date(appointment.appointment_date);\n                                    if (isNaN(date.getTime())) return txtDateNotAvailable;\n                                    return format(date, \"dd/MM/yyyy\", { locale: pt });\n                                  } catch (e) {\n                                    console.warn('Erro ao formatar data da marcação:', e);\n                                    return txtDateNotAvailable;\n                                  }\n                                })()} {appointment.appointment_time ? `às ${appointment.appointment_time}` : ''}\n                              </span>\n                            </div>\n                            <Badge className={status.color}>\n                              <StatusIcon className=\"w-3 h-3 mr-1\" />\n                              {status.label}\n                            </Badge>\n                          </div>\n\n                          <div className=\"space-y-2 text-sm\">\n                            <div className=\"flex items-center gap-2 text-slate-600 font-semibold\">\n                              <span>{getServiceName(appointment.service_id)}</span>\n                            </div>\n\n                            {appointment.user_name && (\n                              <div className=\"flex items-center gap-2 text-slate-600\">\n                                <User className=\"w-4 h-4\" />\n                                <span>{appointment.user_name}</span>\n                              </div>\n                            )}\n\n                            {appointment.user_email && (\n                              <div className=\"flex items-center gap-2 text-slate-600\">\n                                <span className=\"text-xs\">{appointment.user_email}</span>\n                              </div>\n                            )}\n\n                            {appointment.user_phone && (\n                              <div className=\"flex items-center gap-2 text-slate-600\">\n                                <Phone className=\"w-4 h-4\" />\n                                <span>{appointment.user_phone}</span>\n                              </div>\n                            )}\n\n                            {appointment.notes && (\n                              <div className=\"mt-2 p-2 bg-slate-50 rounded text-xs text-slate-600\">\n                                <span className=\"font-semibold\">{txtNotes}</span> {appointment.notes}\n                              </div>\n                            )}\n                          </div>\n                        </div>\n\n                        {appointment.rating && (\n                          <div className=\"flex flex-col items-end justify-center\">\n                            <p className=\"text-xs text-slate-500 mb-1\">{txtRating}</p>\n                            <div className=\"flex items-center gap-1\">\n                              <span className=\"text-2xl font-bold text-amber-600\">{appointment.rating}</span>\n                              <span className=\"text-sm text-slate-400\">/5</span>\n                            </div>\n                            {appointment.feedback && (\n                              <p className=\"text-xs text-slate-500 mt-1 italic max-w-xs\">\"{appointment.feedback}\"</p>\n                            )}\n                          </div>\n                        )}\n                      </div>\n                    </CardContent>\n                  </Card>\n                );\n              })}\n            </div>\n          </div>\n        )}\n        <ConfirmDialog />\n      </div>\n    </div>\n  );\n}\n","path":null,"size_bytes":18662,"size_tokens":null},"shared/schema.js":{"content":"import { pgTable, text, timestamp, varchar, integer, jsonb, boolean } from 'drizzle-orm/pg-core';\n\nexport const users = pgTable('users', {\n  id: varchar('id', { length: 255 }).primaryKey(),\n  email: varchar('email', { length: 255 }).notNull().unique(),\n  passwordHash: text('password_hash').notNull(),\n  fullName: varchar('full_name', { length: 255 }),\n  phone: varchar('phone', { length: 50 }),\n  birthdate: varchar('birthdate', { length: 50 }),\n  country: varchar('country', { length: 100 }),\n  city: varchar('city', { length: 100 }),\n  accountType: varchar('account_type', { length: 50 }).notNull(),\n  isBusinessUser: boolean('is_business_user').default(false).notNull(),\n  isStaffMember: boolean('is_staff_member').default(false).notNull(),\n  businessId: varchar('business_id', { length: 255 }),\n  staffPermissions: jsonb('staff_permissions'),\n  onboardingCompleted: boolean('onboarding_completed').default(true).notNull(),\n  hasBusinessSubscription: boolean('has_business_subscription').default(false).notNull(),\n  preferredLanguage: varchar('preferred_language', { length: 10 }).default('pt'),\n  createdAt: timestamp('created_at').defaultNow().notNull(),\n  updatedAt: timestamp('updated_at').defaultNow().notNull(),\n});\n\nexport const companyProfiles = pgTable('company_profiles', {\n  id: varchar('id', { length: 255 }).primaryKey(),\n  companyName: varchar('company_name', { length: 255 }).notNull(),\n  companyVAT: varchar('company_vat', { length: 50 }),\n  companyCountry: varchar('company_country', { length: 100 }).default('Portugal'),\n  companyAddress: text('company_address'),\n  companyCity: varchar('company_city', { length: 100 }),\n  companyPostalCode: varchar('company_postal_code', { length: 20 }),\n  companyStreetName: varchar('company_street_name', { length: 255 }),\n  companyDoorNumber: varchar('company_door_number', { length: 50 }),\n  companyDistrict: varchar('company_district', { length: 100 }),\n  companyPhone: varchar('company_phone', { length: 50 }),\n  companyEmail: varchar('company_email', { length: 255 }).notNull(),\n  companyCategory: varchar('company_category', { length: 100 }),\n  customCategory: varchar('custom_category', { length: 255 }),\n  companyDescription: text('company_description'),\n  companyCoordinates: jsonb('company_coordinates'),\n  logoUrl: text('logo_url'),\n  photoUrl: text('photo_url'),\n  mediaGallery: jsonb('media_gallery'),\n  adminUserId: varchar('admin_user_id', { length: 255 }).notNull(),\n  \n  status: varchar('status', { length: 50 }).default('pending_payment').notNull(),\n  subscriptionId: varchar('subscription_id', { length: 255 }),\n  stripeCustomerId: varchar('stripe_customer_id', { length: 255 }),\n  subscriptionStatus: varchar('subscription_status', { length: 50 }),\n  \n  trialStart: timestamp('trial_start'),\n  trialEnd: timestamp('trial_end'),\n  currentPeriodEnd: timestamp('current_period_end'),\n  \n  temporaryAccess: jsonb('temporary_access'),\n  paymentRetry: jsonb('payment_retry'),\n  \n  // In-App Purchase fields (iOS/Android)\n  subscriptionPlan: varchar('subscription_plan', { length: 100 }),\n  subscriptionStartDate: timestamp('subscription_start_date'),\n  subscriptionEndDate: timestamp('subscription_end_date'),\n  subscriptionPaymentMethod: varchar('subscription_payment_method', { length: 50 }),\n  iapTransactionId: varchar('iap_transaction_id', { length: 255 }),\n  iapProductId: varchar('iap_product_id', { length: 255 }),\n  iapPlatform: varchar('iap_platform', { length: 20 }),\n  iapLastValidated: timestamp('iap_last_validated'),\n  \n  createdAt: timestamp('created_at').defaultNow().notNull(),\n  updatedAt: timestamp('updated_at').defaultNow().notNull(),\n});\n\nexport const staffInvites = pgTable('staff_invites', {\n  id: varchar('id', { length: 255 }).primaryKey(),\n  businessId: varchar('business_id', { length: 255 }).notNull(),\n  email: varchar('email', { length: 255 }).notNull(),\n  token: varchar('token', { length: 255 }).notNull().unique(),\n  status: varchar('status', { length: 50 }).default('pendente').notNull(),\n  permissions: jsonb('permissions'),\n  invitedBy: varchar('invited_by', { length: 255 }).notNull(),\n  expiresAt: timestamp('expires_at').notNull(),\n  acceptedAt: timestamp('accepted_at'),\n  createdAt: timestamp('created_at').defaultNow().notNull(),\n});\n\nexport const challengeTokens = pgTable('challenge_tokens', {\n  id: varchar('id', { length: 255 }).primaryKey(),\n  email: varchar('email', { length: 255 }).notNull(),\n  token: varchar('token', { length: 255 }).notNull().unique(),\n  used: boolean('used').default(false).notNull(),\n  expiresAt: timestamp('expires_at').notNull(),\n  createdAt: timestamp('created_at').defaultNow().notNull(),\n});\n\nexport const verificationCodes = pgTable('verification_codes', {\n  id: varchar('id', { length: 255 }).primaryKey(),\n  email: varchar('email', { length: 255 }).notNull(),\n  code: varchar('code', { length: 6 }).notNull(),\n  challengeToken: varchar('challenge_token', { length: 255 }).notNull(),\n  expiresAt: timestamp('expires_at').notNull(),\n  verified: boolean('verified').default(false).notNull(),\n  createdAt: timestamp('created_at').defaultNow().notNull(),\n});\n\nexport const passwordResetTokens = pgTable('password_reset_tokens', {\n  id: varchar('id', { length: 255 }).primaryKey(),\n  email: varchar('email', { length: 255 }).notNull(),\n  code: varchar('code', { length: 6 }).notNull(),\n  expiresAt: timestamp('expires_at').notNull(),\n  used: boolean('used').default(false).notNull(),\n  createdAt: timestamp('created_at').defaultNow().notNull(),\n});\n\nexport const consents = pgTable('consents', {\n  id: varchar('id', { length: 255 }).primaryKey(),\n  guestId: varchar('guest_id', { length: 255 }).notNull(),\n  userId: varchar('user_id', { length: 255 }),\n  consent: boolean('consent').default(true).notNull(),\n  version: varchar('version', { length: 50 }).notNull(),\n  userAgent: text('user_agent'),\n  locale: varchar('locale', { length: 10 }),\n  ip: varchar('ip', { length: 100 }),\n  source: varchar('source', { length: 50 }).notNull(),\n  createdAt: timestamp('created_at').defaultNow().notNull(),\n});\n\nexport const tickets = pgTable('tickets', {\n  id: varchar('id', { length: 255 }).primaryKey(),\n  ticketNumber: integer('ticket_number').notNull(),\n  queueId: varchar('queue_id', { length: 255 }).notNull(),\n  businessId: varchar('business_id', { length: 255 }).notNull(),\n  userEmail: varchar('user_email', { length: 255 }).notNull(),\n  userName: varchar('user_name', { length: 255 }),\n  userPhone: varchar('user_phone', { length: 50 }),\n  status: varchar('status', { length: 50 }).default('aguardando').notNull(),\n  isManual: boolean('is_manual').default(false),\n  manualName: varchar('manual_name', { length: 255 }),\n  estimatedTime: integer('estimated_time'),\n  position: integer('position'),\n  calledAt: timestamp('called_at'),\n  completedAt: timestamp('completed_at'),\n  attendingStartedAt: timestamp('attending_started_at'),\n  createdAt: timestamp('created_at').defaultNow().notNull(),\n});\n\nexport const queues = pgTable('queues', {\n  id: varchar('id', { length: 255 }).primaryKey(),\n  name: varchar('name', { length: 255 }).notNull(),\n  description: text('description'),\n  businessId: varchar('business_id', { length: 255 }).notNull(),\n  currentNumber: integer('current_number').default(0).notNull(),\n  lastIssuedNumber: integer('last_issued_number').default(0).notNull(),\n  averageServiceTime: integer('average_service_time').default(10).notNull(),\n  toleranceTime: integer('tolerance_time').default(15).notNull(),\n  maxCapacity: integer('max_capacity').default(100),\n  status: varchar('status', { length: 50 }).default('aberta').notNull(),\n  isActive: boolean('is_active').default(true).notNull(),\n  workingHours: jsonb('working_hours'),\n  lastResetDate: varchar('last_reset_date', { length: 20 }),\n  notificationsEnabled: boolean('notifications_enabled').default(false),\n  notificationSettings: jsonb('notification_settings'),\n  createdAt: timestamp('created_at').defaultNow().notNull(),\n  updatedAt: timestamp('updated_at').defaultNow().notNull(),\n});\n\nexport const services = pgTable('services', {\n  id: varchar('id', { length: 255 }).primaryKey(),\n  businessId: varchar('business_id', { length: 255 }).notNull(),\n  name: varchar('name', { length: 255 }).notNull(),\n  description: text('description'),\n  category: varchar('category', { length: 100 }),\n  duration: integer('duration').default(30).notNull(),\n  toleranceTime: integer('tolerance_time').default(15),\n  price: integer('price').default(0),\n  maxDailySlots: integer('max_daily_slots').default(10),\n  availableDays: jsonb('available_days'),\n  workingHours: jsonb('working_hours'),\n  isActive: boolean('is_active').default(true).notNull(),\n  createdAt: timestamp('created_at').defaultNow().notNull(),\n  updatedAt: timestamp('updated_at').defaultNow().notNull(),\n});\n\nexport const appointments = pgTable('appointments', {\n  id: varchar('id', { length: 255 }).primaryKey(),\n  businessId: varchar('business_id', { length: 255 }).notNull(),\n  serviceId: varchar('service_id', { length: 255 }),\n  serviceName: varchar('service_name', { length: 255 }),\n  userEmail: varchar('user_email', { length: 255 }).notNull(),\n  userName: varchar('user_name', { length: 255 }),\n  userPhone: varchar('user_phone', { length: 50 }),\n  status: varchar('status', { length: 50 }).default('agendado').notNull(),\n  appointmentDate: varchar('appointment_date', { length: 50 }).notNull(),\n  appointmentTime: varchar('appointment_time', { length: 20 }).notNull(),\n  duration: integer('duration').default(30),\n  bufferTime: integer('buffer_time').default(0),\n  notes: text('notes'),\n  businessResponse: text('business_response'),\n  rating: integer('rating'),\n  feedback: text('feedback'),\n  reminderSent: boolean('reminder_sent').default(false),\n  managementToken: varchar('management_token', { length: 255 }),\n  createdAt: timestamp('created_at').defaultNow().notNull(),\n  updatedAt: timestamp('updated_at').defaultNow().notNull(),\n});\n\nexport const deviceTokens = pgTable('device_tokens', {\n  id: varchar('id', { length: 255 }).primaryKey(),\n  userId: varchar('user_id', { length: 255 }).notNull(),\n  token: text('token').notNull(),\n  platform: varchar('platform', { length: 20 }).notNull(),\n  deviceInfo: jsonb('device_info'),\n  isActive: boolean('is_active').default(true).notNull(),\n  lastUsedAt: timestamp('last_used_at').defaultNow(),\n  createdAt: timestamp('created_at').defaultNow().notNull(),\n  updatedAt: timestamp('updated_at').defaultNow().notNull(),\n});\n\nexport const pushNotifications = pgTable('push_notifications', {\n  id: varchar('id', { length: 255 }).primaryKey(),\n  userId: varchar('user_id', { length: 255 }).notNull(),\n  title: varchar('title', { length: 255 }).notNull(),\n  body: text('body').notNull(),\n  data: jsonb('data'),\n  type: varchar('type', { length: 50 }).notNull(),\n  status: varchar('status', { length: 50 }).default('pending').notNull(),\n  sentAt: timestamp('sent_at'),\n  readAt: timestamp('read_at'),\n  createdAt: timestamp('created_at').defaultNow().notNull(),\n});\n","path":null,"size_bytes":10996,"size_tokens":null},"drizzle.config.js":{"content":"export default {\n  schema: './shared/schema.js',\n  out: './drizzle',\n  dialect: 'postgresql',\n  dbCredentials: {\n    url: process.env.DATABASE_URL,\n  },\n};\n","path":null,"size_bytes":156,"size_tokens":null},"server/db.js":{"content":"import { drizzle } from 'drizzle-orm/postgres-js';\nimport postgres from 'postgres';\nimport * as schema from '../shared/schema.js';\n\nconst connectionString = process.env.DATABASE_URL;\n\nconst client = postgres(connectionString);\nexport const db = drizzle(client, { schema });\n","path":null,"size_bytes":274,"size_tokens":null},"src/utils/fixUserAccess.js":{"content":"/**\n * Utilidade para trocar para utilizador demo empresarial pré-configurado\n * Uso: Chamar switchToDemoUser() no console do browser\n */\n\nexport function switchToDemoUser() {\n  console.log('🔄 Trocando para utilizador demo empresarial...');\n  \n  // Utilizador demo pré-configurado com perfil empresarial ativo\n  const demoUser = {\n    nome_completo: 'Demo User',\n    full_name: 'Demo User',\n    email: 'demo@example.com',\n    account_type: 'empresa',\n    onboarding_completed: true,\n    has_business_subscription: true,\n    business_profile_completed: true,\n    business_id: '1',\n    is_business_user: true,\n    country: 'PT',\n    city: 'Lisboa',\n    latitude: 38.7223,\n    longitude: -9.1393,\n    profile_completed: true,\n    phone: '912345678',\n    birthdate: '1990-01-01'\n  };\n  \n  localStorage.setItem('mock_user', JSON.stringify(demoUser));\n  console.log('✅ Trocado para demo@example.com');\n  console.log('📋 Perfil: Clínica Saúde+ (subscrição ativa)');\n  console.log('🔄 Recarregando página...');\n  \n  setTimeout(() => {\n    window.location.href = '/business-dashboard';\n  }, 500);\n}\n\n/**\n * Criar novo utilizador empresarial com onboarding completo\n * Uso: Chamar createBusinessUser() no console\n */\nexport async function createBusinessUser(email, companyName) {\n  console.log('🏢 Criando novo utilizador empresarial...');\n  \n  const userEmail = email || `business${Date.now()}@example.com`;\n  const company = companyName || 'Minha Empresa';\n  \n  // 1. Criar utilizador\n  const newUser = {\n    nome_completo: 'Utilizador Empresarial',\n    full_name: 'Utilizador Empresarial',\n    email: userEmail,\n    account_type: 'empresa',\n    onboarding_completed: true,\n    profile_completed: true,\n    phone: '912345678',\n    birthdate: '1990-01-01',\n    is_business_user: true,\n    country: 'PT',\n    city: 'Lisboa',\n    latitude: 38.7223,\n    longitude: -9.1393,\n    has_business_subscription: true,\n    business_profile_completed: true\n  };\n  \n  // 2. Criar perfil empresarial\n  const businessId = `company_${Date.now()}`;\n  const companyProfile = {\n    id: businessId,\n    companyName: company,\n    companyEmail: userEmail,\n    companyPhone: '912345678',\n    companyAddress: 'Lisboa, Portugal',\n    companyCategory: 'comercio',\n    companyVAT: '',\n    companyCity: 'Lisboa',\n    companyCountry: 'Portugal',\n    companyPostalCode: '',\n    adminUserId: userEmail,\n    status: 'active',\n    subscriptionStatus: 'active',\n    stripeCustomerId: `cus_mock_${Date.now()}`,\n    subscriptionId: `sub_mock_${Date.now()}`\n  };\n  \n  newUser.business_id = businessId;\n  \n  try {\n    // 3. Salvar perfil via API\n    const { safeFetch } = await import('@/utils/apiConfig');\n    const { response, data: savedProfile } = await safeFetch('/api/company-profiles', {\n      method: 'POST',\n      body: JSON.stringify(companyProfile)\n    });\n    \n    if (!response.ok) {\n      throw new Error(`HTTP ${response.status}`);\n    }\n    \n    console.log('✅ Perfil empresarial criado:', savedProfile);\n    \n    // 4. Atualizar utilizador local\n    localStorage.setItem('mock_user', JSON.stringify(newUser));\n    console.log('✅ Utilizador criado:', userEmail);\n    console.log('🔄 Recarregando...');\n    \n    setTimeout(() => window.location.href = '/business-dashboard', 500);\n    \n    return { user: newUser, profile: savedProfile };\n  } catch (error) {\n    console.error('❌ Erro ao criar perfil:', error);\n    throw error;\n  }\n}\n\n/**\n * Forçar refresh dos dados do utilizador atual\n * Útil após atualizações no backend para sincronizar dados\n */\nexport async function refreshCurrentUser() {\n  console.log('🔄 Atualizando dados do utilizador...');\n  \n  try {\n    const { safeFetch } = await import('@/utils/apiConfig');\n    const { response, data: userData } = await safeFetch('/api/auth/me');\n    \n    if (!response.ok) {\n      console.error('❌ Erro ao buscar dados atualizados');\n      console.log('💡 Dica: Faça logout e login novamente');\n      return;\n    }\n    \n    console.log('✅ Dados atualizados:', {\n      email: userData?.email,\n      businessId: userData?.businessId,\n      isBusinessUser: userData?.isBusinessUser,\n      accountType: userData?.accountType\n    });\n    \n    console.log('🔄 Recarregando página para aplicar mudanças...');\n    setTimeout(() => window.location.reload(), 500);\n    \n  } catch (error) {\n    console.error('❌ Erro:', error);\n    console.log('💡 Dica: Faça logout e login novamente');\n  }\n}\n\n// Expor globalmente\nif (typeof window !== 'undefined') {\n  window.switchToDemoUser = switchToDemoUser;\n  window.createBusinessUser = createBusinessUser;\n  window.refreshCurrentUser = refreshCurrentUser;\n}\n","path":null,"size_bytes":4659,"size_tokens":null},"src/utils/clearDemoData.js":{"content":"/**\n * Limpar TODOS os dados demo e começar com base limpa\n * ⚠️ ATENÇÃO: Esta função apaga TODOS os dados de teste!\n * \n * Uso: clearDemoData() no console\n */\n\nimport { base44 } from '@/api/base44Client';\nimport { companyProfileStorage } from '@/models/companyProfile';\n\nexport async function clearDemoData() {\n  const confirmed = window.confirm(\n    '⚠️ ATENÇÃO: Isto vai apagar TODOS os dados demo!\\n\\n' +\n    'Será apagado:\\n' +\n    '- Utilizador demo (demo@example.com)\\n' +\n    '- Perfil da empresa demo\\n' +\n    '- Todas as subscrições demo\\n' +\n    '- Todas as filas, tickets, marcações demo\\n' +\n    '- Todos os dados locais (localStorage)\\n\\n' +\n    'Tem a certeza que quer continuar?'\n  );\n  \n  if (!confirmed) {\n    console.log('❌ Operação cancelada pelo utilizador');\n    return;\n  }\n  \n  console.log('🗑️ LIMPEZA DE DADOS DEMO INICIADA...\\n');\n  \n  try {\n    // 1. Limpar localStorage\n    console.log('1️⃣ Limpando localStorage...');\n    const keysToRemove = [];\n    for (let i = 0; i < localStorage.length; i++) {\n      const key = localStorage.key(i);\n      // Remover dados mock mas preservar configurações do sistema\n      if (key && !key.startsWith('replit_') && !key.startsWith('vite_')) {\n        keysToRemove.push(key);\n      }\n    }\n    keysToRemove.forEach(key => localStorage.removeItem(key));\n    console.log(`   ✅ ${keysToRemove.length} itens removidos do localStorage`);\n    \n    // 2. Limpar CompanyProfiles do PostgreSQL\n    console.log('\\n2️⃣ Limpando perfis de empresa do PostgreSQL...');\n    try {\n      const { safeFetch } = await import('@/utils/apiConfig');\n      const { response, data: profiles } = await safeFetch('/api/company-profiles');\n      if (response.ok && profiles) {\n        let deletedCount = 0;\n        \n        for (const profile of profiles) {\n          try {\n            await safeFetch(`/api/company-profiles/${profile.id}`, {\n              method: 'DELETE'\n            });\n            deletedCount++;\n            console.log(`   🗑️ Perfil deletado: ${profile.companyName}`);\n          } catch (err) {\n            console.warn(`   ⚠️ Erro ao deletar ${profile.companyName}:`, err.message);\n          }\n        }\n        \n        console.log(`   ✅ ${deletedCount} perfis removidos do PostgreSQL`);\n      }\n    } catch (err) {\n      console.warn('   ⚠️ Erro ao limpar perfis PostgreSQL:', err.message);\n    }\n    \n    // 3. Limpar entidades do base44 (Demo API)\n    console.log('\\n3️⃣ Limpando entidades demo (Businesses, Queues, Tickets, etc)...');\n    \n    const entitiesToClear = [\n      'Subscription',\n      'Ticket',\n      'Queue',\n      'Appointment',\n      'Service',\n      'Business',\n      'Staff',\n      'StaffInvite'\n    ];\n    \n    for (const entityName of entitiesToClear) {\n      try {\n        const entities = await base44.entities[entityName].filter({});\n        let deletedCount = 0;\n        \n        for (const entity of entities) {\n          try {\n            // Alguns podem não ter método delete\n            if (typeof base44.entities[entityName].delete === 'function') {\n              await base44.entities[entityName].delete(entity.id);\n              deletedCount++;\n            }\n          } catch (err) {\n            // Ignorar erros de delete individual\n          }\n        }\n        \n        if (deletedCount > 0) {\n          console.log(`   ✅ ${entityName}: ${deletedCount} itens removidos`);\n        }\n      } catch (err) {\n        console.warn(`   ⚠️ Erro ao limpar ${entityName}:`, err.message);\n      }\n    }\n    \n    console.log('\\n' + '='.repeat(60));\n    console.log('✅ LIMPEZA CONCLUÍDA COM SUCESSO!');\n    console.log('='.repeat(60));\n    console.log('\\n📋 PRÓXIMOS PASSOS:');\n    console.log('1. A página será recarregada em 3 segundos');\n    console.log('2. Faça logout (se estiver autenticado)');\n    console.log('3. Crie uma nova conta empresarial do zero');\n    console.log('\\n💡 O sistema está agora com base de dados limpa!');\n    console.log('💳 Stripe continua em MODO DE TESTE (use cartões de teste)\\n');\n    \n    // Recarregar após 3 segundos\n    setTimeout(() => {\n      window.location.href = '/';\n    }, 3000);\n    \n  } catch (error) {\n    console.error('\\n❌ ERRO durante a limpeza:', error);\n    console.error('Alguns dados podem não ter sido removidos completamente.');\n  }\n}\n\n// Expor globalmente\nif (typeof window !== 'undefined') {\n  window.clearDemoData = clearDemoData;\n}\n","path":null,"size_bytes":4470,"size_tokens":null},"src/pages/Register.jsx":{"content":"import React, { useState } from 'react';\nimport { useNavigate, Link } from 'react-router-dom';\nimport { Eye, EyeOff, UserPlus, Mail, Lock, User, Building2, ExternalLink, Globe, CheckCircle2, AlertCircle, ArrowRight, CreditCard, X } from 'lucide-react';\nimport { Button } from '@/components/ui/button';\nimport { Input } from '@/components/ui/input';\nimport { Card, CardContent } from '@/components/ui/card';\nimport { Alert, AlertDescription } from '@/components/ui/alert';\nimport { toast } from 'sonner';\nimport PhoneInput from '../components/shared/PhoneInput';\nimport { safeFetch, apiUrl, isCapacitorApp } from '@/utils/apiConfig';\nimport { useAutoTranslate } from '@/hooks/useTranslate';\nimport PreRegisterConsent from '@/components/PreRegisterConsent';\nimport { Capacitor } from '@capacitor/core';\n\nconst EXTERNAL_SUBSCRIPTION_URL = 'https://waitless-qzero.com';\n\nexport default function RegisterPage() {\n  const navigate = useNavigate();\n  const [formData, setFormData] = useState({\n    email: '',\n    password: '',\n    confirmPassword: '',\n    fullName: '',\n    phone: '',\n    accountType: 'pessoal'\n  });\n  const [showPassword, setShowPassword] = useState(false);\n  const [showConfirmPassword, setShowConfirmPassword] = useState(false);\n  const [loading, setLoading] = useState(false);\n  const [showBusinessInfo, setShowBusinessInfo] = useState(false);\n  \n  const isNativeApp = isCapacitorApp();\n\n  const txtCreateAccount = useAutoTranslate('Criar Conta', 'pt');\n  const txtRegisterToStart = useAutoTranslate('Registe-se para começar a usar o QZero', 'pt');\n  const txtFullName = useAutoTranslate('Nome Completo', 'pt');\n  const txtEmail = useAutoTranslate('Email', 'pt');\n  const txtPassword = useAutoTranslate('Palavra-passe', 'pt');\n  const txtConfirmPassword = useAutoTranslate('Confirmar Palavra-passe', 'pt');\n  const txtMobileNumber = useAutoTranslate('Número de Telemóvel', 'pt');\n  const txtAccountType = useAutoTranslate('Tipo de Conta', 'pt');\n  const txtPersonal = useAutoTranslate('Conta Pessoal', 'pt');\n  const txtBusiness = useAutoTranslate('Conta Empresa', 'pt');\n  const txtRegister = useAutoTranslate('Registar', 'pt');\n  const txtRegistering = useAutoTranslate('A registar...', 'pt');\n  const txtPasswordMin6 = useAutoTranslate('A palavra-passe deve ter no mínimo 6 caracteres', 'pt');\n  const txtPasswordsNotMatch = useAutoTranslate('As palavras-passe não coincidem', 'pt');\n  const txtFillAllFields = useAutoTranslate('Por favor preencha todos os campos obrigatórios', 'pt');\n  const txtAccountCreated = useAutoTranslate('Conta criada com sucesso!', 'pt');\n  const txtErrorCreatingAccount = useAutoTranslate('Erro ao criar conta', 'pt');\n  const txtAlreadyHaveAccount = useAutoTranslate('Já tem conta?', 'pt');\n  const txtLoginHere = useAutoTranslate('Entre aqui', 'pt');\n  const txtForCustomers = useAutoTranslate('Para clientes', 'pt');\n  const txtForBusinesses = useAutoTranslate('Para negócios', 'pt');\n  const txtCreatingAccount = useAutoTranslate('A criar conta...', 'pt');\n  const txtPlaceholderName = useAutoTranslate('João Silva', 'pt');\n  const txtPlaceholderEmail = useAutoTranslate('seu@email.com', 'pt');\n  const txtPlaceholderMinChars = useAutoTranslate('Mínimo 6 caracteres', 'pt');\n  const txtPlaceholderConfirmPass = useAutoTranslate('Confirme a palavra-passe', 'pt');\n  \n  const txtBusinessAccountInfo = useAutoTranslate('Informação Importante', 'pt');\n  const txtBusinessAccountTitle = useAutoTranslate('Olá! Antes de criar a conta...', 'pt');\n  const txtBusinessStep1Title = useAutoTranslate('Crie a sua conta aqui', 'pt');\n  const txtBusinessStep1Desc = useAutoTranslate('É rápido e gratuito! Basta preencher o formulário abaixo.', 'pt');\n  const txtBusinessStep2Title = useAutoTranslate('Compre no nosso site', 'pt');\n  const txtBusinessStep2Desc = useAutoTranslate('Para ativar as funcionalidades, visite waitless-qzero.com no seu computador ou browser.', 'pt');\n  const txtBusinessStep3Title = useAutoTranslate('Volte à app e aproveite!', 'pt');\n  const txtBusinessStep3Desc = useAutoTranslate('Depois de comprar, faça login aqui e tudo estará desbloqueado.', 'pt');\n  const txtBusinessImportantNote = useAutoTranslate('Atenção:', 'pt');\n  const txtBusinessNoAccessWithoutPayment = useAutoTranslate('Sem a compra no site, a conta fica limitada. Mas não se preocupe, pode explorar a app à vontade!', 'pt');\n  const txtBusinessCancellation = useAutoTranslate('Onde comprar?', 'pt');\n  const txtBusinessCancellationDesc = useAutoTranslate('waitless-qzero.com - Lá pode comprar, gerir e cancelar a sua subscrição quando quiser.', 'pt');\n  const txtBusinessGoToSite = useAutoTranslate('Saber mais no site', 'pt');\n  const txtBusinessUnderstood = useAutoTranslate('Entendi, vamos lá!', 'pt');\n  const txtBusinessWebTrialNote = useAutoTranslate('7 dias grátis para experimentar!', 'pt');\n  const txtBusinessMobileNote = useAutoTranslate('Na app móvel: compra no site', 'pt');\n  const txtBusinessPlanPrice = useAutoTranslate('Plano Empresarial', 'pt');\n  const txtBusinessPlanPriceInfo = useAutoTranslate('7 dias grátis, depois €19,99 (1º mês) e €49,99/mês', 'pt');\n  const txtClose = useAutoTranslate('Fechar', 'pt');\n\n  const handleInputChange = (e) => {\n    const { name, value } = e.target;\n    setFormData(prev => ({\n      ...prev,\n      [name]: value\n    }));\n  };\n\n  const handleBusinessAccountSelect = () => {\n    setFormData(prev => ({ ...prev, accountType: 'empresa' }));\n    if (isNativeApp) {\n      setShowBusinessInfo(true);\n    }\n  };\n\n  const handleExternalPurchase = () => {\n    console.log('🌐 Abrindo site externo para compra B2B:', EXTERNAL_SUBSCRIPTION_URL);\n    if (Capacitor.isNativePlatform()) {\n      window.open(EXTERNAL_SUBSCRIPTION_URL, '_system');\n    } else {\n      window.open(EXTERNAL_SUBSCRIPTION_URL, '_blank');\n    }\n  };\n\n  const validatePassword = () => {\n    if (formData.password.length < 6) {\n      toast.error(txtPasswordMin6);\n      return false;\n    }\n    if (formData.password !== formData.confirmPassword) {\n      toast.error(txtPasswordsNotMatch);\n      return false;\n    }\n    return true;\n  };\n\n  const handleSubmit = async (e) => {\n    e.preventDefault();\n\n    if (!formData.phone) {\n      toast.error(txtFillAllFields);\n      return;\n    }\n\n    if (!validatePassword()) {\n      return;\n    }\n\n    setLoading(true);\n\n    try {\n      const { response, data } = await safeFetch('/api/auth/register', {\n        method: 'POST',\n        body: JSON.stringify({\n          email: formData.email,\n          password: formData.password,\n          fullName: formData.fullName,\n          phone: formData.phone,\n          accountType: formData.accountType\n        }),\n      });\n\n      if (!response.ok) {\n        throw new Error(data?.error || txtErrorCreatingAccount);\n      }\n\n      console.log('✅ Conta criada com sucesso! Tipo:', data.user.accountType);\n      toast.success(txtAccountCreated);\n      \n      // 🔄 AGUARDAR cookies sincronizarem verificando /api/auth/me\n      // Garante que o cookie foi definido antes de navegar (Safari iOS)\n      let cookieReady = false;\n      let attempts = 0;\n      const maxAttempts = 5;\n      \n      while (!cookieReady && attempts < maxAttempts) {\n        attempts++;\n        try {\n          const { response: meResponse } = await safeFetch('/api/auth/me', {\n            method: 'GET'\n          });\n          \n          if (meResponse.ok) {\n            console.log('✅ Cookie sincronizado após', attempts, 'tentativa(s)');\n            cookieReady = true;\n          } else {\n            console.log('⏳ Cookie ainda não sincronizado, tentativa', attempts);\n            await new Promise(resolve => setTimeout(resolve, 200));\n          }\n        } catch (err) {\n          console.log('⏳ Aguardando cookie sincronizar...', attempts);\n          await new Promise(resolve => setTimeout(resolve, 200));\n        }\n      }\n      \n      const targetPath = data.user.accountType === 'empresa' \n        ? '/business-subscription' \n        : '/home';\n      \n      console.log('📍 Redirecionando para', targetPath);\n      window.location.href = targetPath;\n    } catch (error) {\n      toast.error(error.message);\n    } finally {\n      setLoading(false);\n    }\n  };\n\n  return (\n    <PreRegisterConsent>\n      <div className=\"min-h-screen bg-gradient-to-br from-blue-50 via-white to-cyan-50 flex items-center justify-center p-4\">\n      <Card className=\"w-full max-w-md p-8 shadow-xl\">\n        <div className=\"text-center mb-8\">\n          <div className=\"inline-flex items-center justify-center w-16 h-16 bg-gradient-to-br from-blue-500 to-cyan-500 rounded-full mb-4\">\n            <UserPlus className=\"w-8 h-8 text-white\" />\n          </div>\n          <h1 className=\"text-3xl font-bold text-gray-900 mb-2\">{txtCreateAccount}</h1>\n          <p className=\"text-gray-600\">{txtRegisterToStart}</p>\n        </div>\n\n        <form onSubmit={handleSubmit} className=\"space-y-6\" noValidate>\n          <div>\n            <label htmlFor=\"fullName\" className=\"block text-sm font-medium text-gray-700 mb-2\">\n              {txtFullName}\n            </label>\n            <div className=\"relative\">\n              <User className=\"absolute left-3 top-1/2 -translate-y-1/2 w-5 h-5 text-gray-400\" />\n              <Input\n                id=\"fullName\"\n                name=\"fullName\"\n                type=\"text\"\n                value={formData.fullName}\n                onChange={handleInputChange}\n                placeholder={txtPlaceholderName}\n                className=\"pl-10\"\n                autoComplete=\"name\"\n              />\n            </div>\n          </div>\n\n          <div>\n            <label htmlFor=\"email\" className=\"block text-sm font-medium text-gray-700 mb-2\">\n              {txtEmail}\n            </label>\n            <div className=\"relative\">\n              <Mail className=\"absolute left-3 top-1/2 -translate-y-1/2 w-5 h-5 text-gray-400\" />\n              <Input\n                id=\"email\"\n                name=\"email\"\n                type=\"text\"\n                inputMode=\"email\"\n                value={formData.email}\n                onChange={handleInputChange}\n                placeholder={txtPlaceholderEmail}\n                className=\"pl-10\"\n                autoComplete=\"username\"\n              />\n            </div>\n          </div>\n\n          <div>\n            <label htmlFor=\"password\" className=\"block text-sm font-medium text-gray-700 mb-2\">\n              {txtPassword}\n            </label>\n            <div className=\"relative\">\n              <Lock className=\"absolute left-3 top-1/2 -translate-y-1/2 w-5 h-5 text-gray-400\" />\n              <Input\n                id=\"password\"\n                name=\"password\"\n                type={showPassword ? 'text' : 'password'}\n                value={formData.password}\n                onChange={handleInputChange}\n                placeholder={txtPlaceholderMinChars}\n                className=\"pl-10 pr-12\"\n                autoComplete=\"new-password\"\n              />\n              <button\n                type=\"button\"\n                onClick={() => setShowPassword(!showPassword)}\n                className=\"absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 hover:text-gray-600 transition-colors\"\n              >\n                {showPassword ? <EyeOff className=\"w-5 h-5\" /> : <Eye className=\"w-5 h-5\" />}\n              </button>\n            </div>\n          </div>\n\n          <div>\n            <label htmlFor=\"confirmPassword\" className=\"block text-sm font-medium text-gray-700 mb-2\">\n              {txtConfirmPassword}\n            </label>\n            <div className=\"relative\">\n              <Lock className=\"absolute left-3 top-1/2 -translate-y-1/2 w-5 h-5 text-gray-400\" />\n              <Input\n                id=\"confirmPassword\"\n                name=\"confirmPassword\"\n                type={showConfirmPassword ? 'text' : 'password'}\n                value={formData.confirmPassword}\n                onChange={handleInputChange}\n                placeholder={txtPlaceholderConfirmPass}\n                className=\"pl-10 pr-12\"\n                autoComplete=\"new-password\"\n              />\n              <button\n                type=\"button\"\n                onClick={() => setShowConfirmPassword(!showConfirmPassword)}\n                className=\"absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 hover:text-gray-600 transition-colors\"\n              >\n                {showConfirmPassword ? <EyeOff className=\"w-5 h-5\" /> : <Eye className=\"w-5 h-5\" />}\n              </button>\n            </div>\n          </div>\n\n          <div>\n            <label htmlFor=\"phone\" className=\"block text-sm font-medium text-gray-700 mb-2\">\n              {txtMobileNumber}\n            </label>\n            <PhoneInput\n              value={formData.phone}\n              onChange={(value) => setFormData(prev => ({ ...prev, phone: value }))}\n            />\n          </div>\n\n          {/* ============================================ */}\n          {/* TIPO DE CONTA - SÓ MOSTRA NA WEB */}\n          {/* iOS/Android: Apenas conta pessoal (regra Apple B2B) */}\n          {/* Website: Pessoal + Empresa disponíveis */}\n          {/* ============================================ */}\n          {!isNativeApp && (\n            <div>\n              <label className=\"block text-sm font-medium text-gray-700 mb-3\">\n                {txtAccountType}\n              </label>\n              <div className=\"grid grid-cols-2 gap-3\">\n                <button\n                  type=\"button\"\n                  onClick={() => setFormData(prev => ({ ...prev, accountType: 'pessoal' }))}\n                  className={`p-4 rounded-lg border-2 transition-all ${\n                    formData.accountType === 'pessoal'\n                      ? 'border-blue-500 bg-blue-50'\n                      : 'border-gray-200 hover:border-gray-300'\n                  }`}\n                >\n                  <User className={`w-6 h-6 mx-auto mb-2 ${\n                    formData.accountType === 'pessoal' ? 'text-blue-600' : 'text-gray-400'\n                  }`} />\n                  <div className={`text-sm font-medium ${\n                    formData.accountType === 'pessoal' ? 'text-blue-900' : 'text-gray-700'\n                  }`}>\n                    {txtPersonal}\n                  </div>\n                  <div className=\"text-xs text-gray-500 mt-1\">{txtForCustomers}</div>\n                </button>\n\n                <button\n                  type=\"button\"\n                  onClick={handleBusinessAccountSelect}\n                  className={`p-4 rounded-lg border-2 transition-all ${\n                    formData.accountType === 'empresa'\n                      ? 'border-blue-500 bg-blue-50'\n                      : 'border-gray-200 hover:border-gray-300'\n                  }`}\n                >\n                  <Building2 className={`w-6 h-6 mx-auto mb-2 ${\n                    formData.accountType === 'empresa' ? 'text-blue-600' : 'text-gray-400'\n                  }`} />\n                  <div className={`text-sm font-medium ${\n                    formData.accountType === 'empresa' ? 'text-blue-900' : 'text-gray-700'\n                  }`}>\n                    {txtBusiness}\n                  </div>\n                  <div className=\"text-xs text-gray-500 mt-1\">{txtForBusinesses}</div>\n                </button>\n              </div>\n            </div>\n          )}\n\n          {/* ============================================ */}\n          {/* TELA INFORMATIVA - Conta Empresa */}\n          {/* SÓ MOSTRA EM iOS/ANDROID (apps nativas) */}\n          {/* Na web, o utilizador pode pagar diretamente via Stripe */}\n          {/* ============================================ */}\n          {showBusinessInfo && formData.accountType === 'empresa' && isNativeApp && (\n            <Card className=\"border-2 border-indigo-200 bg-gradient-to-br from-indigo-50 to-purple-50 shadow-lg\">\n              <CardContent className=\"p-4 sm:p-6\">\n                <div className=\"flex items-center justify-between mb-4\">\n                  <div className=\"flex items-center gap-2\">\n                    <div className=\"p-2 bg-indigo-100 rounded-lg\">\n                      <Globe className=\"w-5 h-5 text-indigo-600\" />\n                    </div>\n                    <h3 className=\"font-bold text-indigo-900 text-lg\">\n                      {txtBusinessAccountTitle}\n                    </h3>\n                  </div>\n                  <button\n                    type=\"button\"\n                    onClick={() => setShowBusinessInfo(false)}\n                    className=\"p-1 hover:bg-indigo-100 rounded-full transition-colors\"\n                  >\n                    <X className=\"w-5 h-5 text-indigo-400\" />\n                  </button>\n                </div>\n\n                {/* Passos do processo */}\n                <div className=\"space-y-4 mb-5\">\n                  <div className=\"flex gap-3\">\n                    <div className=\"w-8 h-8 rounded-full bg-indigo-600 text-white flex items-center justify-center flex-shrink-0 text-sm font-bold\">1</div>\n                    <div>\n                      <h4 className=\"font-semibold text-slate-800\">{txtBusinessStep1Title}</h4>\n                      <p className=\"text-sm text-slate-600\">{txtBusinessStep1Desc}</p>\n                    </div>\n                  </div>\n                  \n                  <div className=\"flex gap-3\">\n                    <div className=\"w-8 h-8 rounded-full bg-indigo-600 text-white flex items-center justify-center flex-shrink-0 text-sm font-bold\">2</div>\n                    <div>\n                      <h4 className=\"font-semibold text-slate-800\">{txtBusinessStep2Title}</h4>\n                      <p className=\"text-sm text-slate-600\">{txtBusinessStep2Desc}</p>\n                    </div>\n                  </div>\n                  \n                  <div className=\"flex gap-3\">\n                    <div className=\"w-8 h-8 rounded-full bg-indigo-600 text-white flex items-center justify-center flex-shrink-0 text-sm font-bold\">3</div>\n                    <div>\n                      <h4 className=\"font-semibold text-slate-800\">{txtBusinessStep3Title}</h4>\n                      <p className=\"text-sm text-slate-600\">{txtBusinessStep3Desc}</p>\n                    </div>\n                  </div>\n                </div>\n\n                {/* Alertas importantes */}\n                <Alert className=\"mb-4 border-amber-200 bg-amber-50\">\n                  <AlertCircle className=\"h-4 w-4 text-amber-600\" />\n                  <AlertDescription className=\"text-amber-900 text-sm\">\n                    <strong>{txtBusinessImportantNote}</strong> {txtBusinessNoAccessWithoutPayment}\n                  </AlertDescription>\n                </Alert>\n                \n                <Alert className=\"mb-4 border-blue-200 bg-blue-50\">\n                  <CreditCard className=\"h-4 w-4 text-blue-600\" />\n                  <AlertDescription className=\"text-blue-900 text-sm\">\n                    <strong>{txtBusinessCancellation}</strong> {txtBusinessCancellationDesc}\n                  </AlertDescription>\n                </Alert>\n\n                {/* Preço do plano */}\n                <div className=\"text-center mb-4 p-3 bg-white rounded-lg border border-indigo-100\">\n                  <span className=\"inline-block px-4 py-2 bg-gradient-to-r from-indigo-600 to-purple-600 text-white text-sm font-semibold rounded-full mb-2\">\n                    {txtBusinessPlanPrice}\n                  </span>\n                  <p className=\"text-xs text-green-600 font-medium\">\n                    {txtBusinessPlanPriceInfo}\n                  </p>\n                </div>\n\n                {/* Botão de ação único */}\n                <Button\n                  type=\"button\"\n                  onClick={() => setShowBusinessInfo(false)}\n                  className=\"w-full bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-700 hover:to-purple-700\"\n                >\n                  <CheckCircle2 className=\"w-4 h-4 mr-2\" />\n                  {txtBusinessUnderstood}\n                </Button>\n              </CardContent>\n            </Card>\n          )}\n\n          <Button\n            type=\"submit\"\n            disabled={loading}\n            className=\"w-full bg-gradient-to-r from-blue-500 to-cyan-500 hover:from-blue-600 hover:to-cyan-600 text-white font-medium py-3\"\n          >\n            {loading ? txtCreatingAccount : txtCreateAccount}\n          </Button>\n        </form>\n\n        <div className=\"mt-6 text-center\">\n          <p className=\"text-gray-600\">\n            {txtAlreadyHaveAccount}{' '}\n            <Link\n              to=\"/login\"\n              className=\"text-blue-600 hover:text-blue-700 font-medium transition-colors\"\n            >\n              {txtLoginHere}\n            </Link>\n          </p>\n        </div>\n      </Card>\n      </div>\n    </PreRegisterConsent>\n  );\n}\n","path":null,"size_bytes":20836,"size_tokens":null},"src/pages/Login.jsx":{"content":"import React, { useState, useEffect } from 'react';\nimport { useNavigate, Link } from 'react-router-dom';\nimport { Eye, EyeOff, LogIn, Mail, Lock, Shield, ArrowLeft } from 'lucide-react';\nimport { Button } from '@/components/ui/button';\nimport { Input } from '@/components/ui/input';\nimport { Card } from '@/components/ui/card';\nimport { toast } from 'sonner';\nimport { safeFetch } from '@/utils/apiConfig';\nimport { useUser } from '@/contexts/UserContext';\nimport { useAutoTranslate } from '@/hooks/useTranslate';\nimport { ApiDiagnostic } from '@/components/debug/ApiDiagnostic';\n\nconst LOGIN_EMAIL_KEY = '2fa_login_email';\nconst LOGIN_STEP_KEY = '2fa_login_step';\nconst LOGIN_CHALLENGE_KEY = '2fa_challenge_token';\n\nexport default function LoginPage() {\n  const navigate = useNavigate();\n  const { refresh } = useUser();\n  const [step, setStep] = useState(() => {\n    return sessionStorage.getItem(LOGIN_STEP_KEY) || 'credentials';\n  });\n  const [formData, setFormData] = useState(() => {\n    // Se estamos no passo de verificação, restaurar email do sessionStorage\n    const currentStep = sessionStorage.getItem(LOGIN_STEP_KEY);\n    const savedEmail = sessionStorage.getItem(LOGIN_EMAIL_KEY);\n    \n    if (currentStep === 'verification' && savedEmail) {\n      return {\n        email: savedEmail,\n        password: ''\n      };\n    }\n    \n    return {\n      email: '',\n      password: ''\n    };\n  });\n  const [verificationCode, setVerificationCode] = useState('');\n  const [challengeToken, setChallengeToken] = useState(() => {\n    return sessionStorage.getItem(LOGIN_CHALLENGE_KEY) || '';\n  });\n  const [showPassword, setShowPassword] = useState(false);\n  const [loading, setLoading] = useState(false);\n  const [apiError, setApiError] = useState(null);\n  const [isDemoAccount, setIsDemoAccount] = useState(false);\n\n  const txtWelcome = useAutoTranslate('Bem-vindo ao QZero', 'pt');\n  const txtSecurityVerification = useAutoTranslate('Verificação de Segurança', 'pt');\n  const txtEnterAccount = useAutoTranslate('Entre na sua conta para continuar', 'pt');\n  const txtEnterCode = useAutoTranslate('Introduza o código enviado para o seu email', 'pt');\n  const txtEmail = useAutoTranslate('Email', 'pt');\n  const txtPassword = useAutoTranslate('Palavra-passe', 'pt');\n  const txtContinue = useAutoTranslate('Continuar', 'pt');\n  const txtValidating = useAutoTranslate('A validar...', 'pt');\n  const txtForgotPassword = useAutoTranslate('Esqueceu a senha?', 'pt');\n  const txtVerificationCode = useAutoTranslate('Código de Verificação', 'pt');\n  const txtEnter6Digits = useAutoTranslate('Introduza o código de 6 dígitos', 'pt');\n  const txtVerify = useAutoTranslate('Verificar', 'pt');\n  const txtVerifying = useAutoTranslate('A verificar...', 'pt');\n  const txtResendCode = useAutoTranslate('Reenviar Código', 'pt');\n  const txtBackToLogin = useAutoTranslate('Voltar ao Login', 'pt');\n  const txtIncorrectCredentials = useAutoTranslate('Email ou palavra-passe incorretos', 'pt');\n  const txtErrorSendingCode = useAutoTranslate('Erro ao enviar código de verificação', 'pt');\n  const txtCodeSent = useAutoTranslate('Código de verificação enviado para o seu email!', 'pt');\n  const txtInvalidCode = useAutoTranslate('Código inválido ou expirado', 'pt');\n  const txtNewCodeSent = useAutoTranslate('Novo código enviado!', 'pt');\n  const txtErrorResendingCode = useAutoTranslate('Erro ao reenviar código', 'pt');\n  const txtNoAccount = useAutoTranslate('Ainda não tem conta?', 'pt');\n  const txtRegisterNow = useAutoTranslate('Registar agora', 'pt');\n  const txtLoginSuccess = useAutoTranslate('Login realizado com sucesso!', 'pt');\n  const txtSentCodeTo = useAutoTranslate('Enviámos um código de 6 dígitos para', 'pt');\n  const txtPlaceholderEmail = useAutoTranslate('seu@email.com', 'pt');\n  const txtEnterEmail = useAutoTranslate('Por favor, introduza o seu email', 'pt');\n  const txtEnterPassword = useAutoTranslate('Por favor, introduza a sua palavra-passe', 'pt');\n\n  // 🧹 LIMPEZA AUTOMÁTICA ao montar a página\n  useEffect(() => {\n    // Se NÃO estamos no passo de verificação, limpar tudo\n    const currentStep = sessionStorage.getItem(LOGIN_STEP_KEY);\n    if (currentStep !== 'verification') {\n      console.log('🧹 Login page montada - limpando sessionStorage antigo');\n      sessionStorage.removeItem(LOGIN_EMAIL_KEY);\n      sessionStorage.removeItem(LOGIN_STEP_KEY);\n      sessionStorage.removeItem(LOGIN_CHALLENGE_KEY);\n      \n      // 🚨 LIMPAR COOKIES DE FORMA AGRESSIVA (Safari iOS fix)\n      // Chama endpoint de emergência para garantir cookies limpos\n      safeFetch('/api/auth/clear-session', {\n        method: 'POST'\n      }).catch(err => {\n        console.warn('⚠️ Erro ao limpar sessão (não crítico):', err);\n      });\n    }\n    \n    return () => {\n      if (window.location.pathname !== '/login') {\n        sessionStorage.removeItem(LOGIN_EMAIL_KEY);\n        sessionStorage.removeItem(LOGIN_STEP_KEY);\n        sessionStorage.removeItem(LOGIN_CHALLENGE_KEY);\n      }\n    };\n  }, []);\n\n  const handleInputChange = (e) => {\n    const { name, value } = e.target;\n    setFormData(prev => ({\n      ...prev,\n      [name]: value\n    }));\n  };\n\n  // Step 1: Validar credenciais e enviar código\n  const handleSubmit = async (e) => {\n    e.preventDefault();\n    \n    // Validação personalizada (substitui validação nativa HTML5 para evitar erros Safari iOS)\n    if (!formData.email || !formData.email.trim()) {\n      toast.error(txtEnterEmail);\n      return;\n    }\n    if (!formData.password || !formData.password.trim()) {\n      toast.error(txtEnterPassword);\n      return;\n    }\n    \n    setLoading(true);\n\n    try {\n      // Primeiro valida email e senha (SEM emitir JWT) e recebe challenge token\n      const { response: validateResponse, data: validateData } = await safeFetch('/api/auth/validate-credentials', {\n        method: 'POST',\n        body: JSON.stringify(formData),\n      });\n\n      if (!validateResponse.ok) {\n        throw new Error(validateData?.error || txtIncorrectCredentials);\n      }\n\n      // Guardar challenge token\n      const token = validateData.challengeToken;\n      setChallengeToken(token);\n\n      // Persistir email e token em sessionStorage para não perder ao sair da página\n      sessionStorage.setItem(LOGIN_EMAIL_KEY, formData.email);\n      sessionStorage.setItem(LOGIN_CHALLENGE_KEY, token);\n      sessionStorage.setItem(LOGIN_STEP_KEY, 'verification');\n\n      // Envia código de verificação vinculado ao challenge token\n      const { response: codeResponse, data: codeData } = await safeFetch('/api/auth/send-verification-code', {\n        method: 'POST',\n        body: JSON.stringify({ \n          email: formData.email,\n          challengeToken: token\n        }),\n      });\n\n      if (!codeResponse.ok) {\n        throw new Error(codeData?.error || txtErrorSendingCode);\n      }\n\n      // 🎯 Conta demo: mostrar código diretamente (toast apenas, sem popup persistente)\n      if (codeData.isDemoAccount) {\n        setIsDemoAccount(true);\n        toast.success('Conta Demo - Código: 000000', { duration: 5000 });\n      } else {\n        toast.success(txtCodeSent);\n      }\n      setStep('verification');\n    } catch (error) {\n      console.error('❌ Login error:', error);\n      setApiError(error);\n      toast.error(error.message);\n    } finally {\n      setLoading(false);\n    }\n  };\n\n  // Step 2: Verificar código 2FA\n  const handleVerifyCode = async (e) => {\n    e.preventDefault();\n    setLoading(true);\n\n    try {\n      const { response, data } = await safeFetch('/api/auth/verify-code', {\n        method: 'POST',\n        body: JSON.stringify({\n          email: formData.email,\n          code: verificationCode,\n          challengeToken: challengeToken,\n        }),\n      });\n\n      if (!response.ok) {\n        throw new Error(data?.error || txtInvalidCode);\n      }\n\n      console.log('✅ Login 2FA bem-sucedido! Tipo de conta:', data.user.accountType);\n      toast.success(txtLoginSuccess);\n      \n      // 🍪 SAFARI iOS FIX: Guardar token no localStorage como fallback\n      // Safari bloqueia cookies em iframes, então usamos localStorage + Authorization header\n      if (data.token) {\n        try {\n          localStorage.setItem('qzero_auth_token', data.token);\n          console.log('🔐 Token guardado no localStorage (Safari iOS fallback)');\n        } catch (e) {\n          console.warn('⚠️ Erro ao guardar token no localStorage:', e);\n        }\n      }\n      \n      // 🧹 Limpar dados de sessão E localStorage (remove dados demo/cache antigos)\n      sessionStorage.removeItem(LOGIN_EMAIL_KEY);\n      sessionStorage.removeItem(LOGIN_STEP_KEY);\n      sessionStorage.removeItem(LOGIN_CHALLENGE_KEY);\n      \n      // Limpar cache de empresas do localStorage\n      try {\n        localStorage.removeItem('company_profiles');\n        localStorage.removeItem('businesses');\n        console.log('🗑️ Cache de empresas limpo do localStorage');\n      } catch (e) {\n        console.warn('⚠️ Erro ao limpar localStorage:', e);\n      }\n      \n      // 🔄 CRÍTICO: Recarregar utilizador ANTES de navegar (fix loop infinito)\n      console.log('🔄 Recarregando estado de autenticação com novo cookie...');\n      await refresh();\n      console.log('✅ Estado de autenticação recarregado com sucesso!');\n      \n      if (data.user.accountType === 'empresa') {\n        console.log('📍 Redirecionando para BusinessHome...');\n        navigate('/business-home', { replace: true });\n      } else {\n        console.log('📍 Redirecionando para Home...');\n        navigate('/home', { replace: true });\n      }\n    } catch (error) {\n      toast.error(error.message);\n    } finally {\n      setLoading(false);\n    }\n  };\n\n  const handleResendCode = async () => {\n    setLoading(true);\n    try {\n      const { response, data } = await safeFetch('/api/auth/send-verification-code', {\n        method: 'POST',\n        body: JSON.stringify({ \n          email: formData.email,\n          challengeToken: challengeToken\n        }),\n      });\n\n      if (!response.ok) {\n        throw new Error(data?.error || txtErrorResendingCode);\n      }\n\n      toast.success(txtNewCodeSent);\n    } catch (error) {\n      toast.error(error.message);\n    } finally {\n      setLoading(false);\n    }\n  };\n\n  const handleBackToCredentials = () => {\n    setStep('credentials');\n    setVerificationCode('');\n    setChallengeToken('');\n    sessionStorage.setItem(LOGIN_STEP_KEY, 'credentials');\n    sessionStorage.removeItem(LOGIN_CHALLENGE_KEY);\n  };\n\n  return (\n    <div className=\"min-h-screen bg-gradient-to-br from-blue-50 via-white to-cyan-50 flex items-center justify-center p-4\">\n      <Card className=\"w-full max-w-md p-8 shadow-xl\">\n        <div className=\"text-center mb-8\">\n          <div className=\"inline-flex items-center justify-center w-16 h-16 bg-gradient-to-br from-blue-500 to-cyan-500 rounded-full mb-4\">\n            {step === 'credentials' ? (\n              <LogIn className=\"w-8 h-8 text-white\" />\n            ) : (\n              <Shield className=\"w-8 h-8 text-white\" />\n            )}\n          </div>\n          <h1 className=\"text-3xl font-bold text-gray-900 mb-2\">\n            {step === 'credentials' ? txtWelcome : txtSecurityVerification}\n          </h1>\n          <p className=\"text-gray-600\">\n            {step === 'credentials' ? txtEnterAccount : txtEnterCode}\n          </p>\n        </div>\n\n        {step === 'credentials' ? (\n          <form onSubmit={handleSubmit} className=\"space-y-6\" noValidate>\n            <div>\n              <label htmlFor=\"email\" className=\"block text-sm font-medium text-gray-700 mb-2\">\n                {txtEmail}\n              </label>\n              <div className=\"relative\">\n                <Mail className=\"absolute left-3 top-1/2 -translate-y-1/2 w-5 h-5 text-gray-400\" />\n                <Input\n                  id=\"email\"\n                  name=\"email\"\n                  type=\"text\"\n                  value={formData.email}\n                  onChange={handleInputChange}\n                  placeholder={txtPlaceholderEmail}\n                  className=\"pl-10\"\n                  autoComplete=\"username\"\n                  inputMode=\"email\"\n                />\n              </div>\n            </div>\n\n            <div>\n              <label htmlFor=\"password\" className=\"block text-sm font-medium text-gray-700 mb-2\">\n                {txtPassword}\n              </label>\n              <div className=\"relative\">\n                <Lock className=\"absolute left-3 top-1/2 -translate-y-1/2 w-5 h-5 text-gray-400\" />\n                <Input\n                  id=\"password\"\n                  name=\"password\"\n                  type={showPassword ? 'text' : 'password'}\n                  value={formData.password}\n                  onChange={handleInputChange}\n                  placeholder=\"••••••••\"\n                  className=\"pl-10 pr-12\"\n                  autoComplete=\"current-password\"\n                />\n                <button\n                  type=\"button\"\n                  onClick={() => setShowPassword(!showPassword)}\n                  className=\"absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 hover:text-gray-600 transition-colors\"\n                >\n                  {showPassword ? <EyeOff className=\"w-5 h-5\" /> : <Eye className=\"w-5 h-5\" />}\n                </button>\n              </div>\n            </div>\n\n            <Button\n              type=\"submit\"\n              disabled={loading || !formData.email || !formData.password}\n              className=\"w-full bg-gradient-to-r from-blue-500 to-cyan-500 hover:from-blue-600 hover:to-cyan-600 text-white font-medium py-3\"\n            >\n              {loading ? txtValidating : txtContinue}\n            </Button>\n\n            <div className=\"text-center\">\n              <Link\n                to=\"/forgot-password\"\n                className=\"text-sm text-blue-600 hover:text-blue-700 transition-colors\"\n              >\n                {txtForgotPassword}\n              </Link>\n            </div>\n          </form>\n        ) : (\n          <form onSubmit={handleVerifyCode} className=\"space-y-6\" noValidate>\n            <div>\n              <label htmlFor=\"code\" className=\"block text-sm font-medium text-gray-700 mb-2\">\n                {txtVerificationCode}\n              </label>\n              <div className=\"relative\">\n                <Shield className=\"absolute left-3 top-1/2 -translate-y-1/2 w-5 h-5 text-gray-400\" />\n                <Input\n                  id=\"code\"\n                  name=\"code\"\n                  type=\"text\"\n                  inputMode=\"numeric\"\n                  value={verificationCode}\n                  onChange={(e) => {\n                    const value = e.target.value.replace(/\\D/g, '').slice(0, 6);\n                    setVerificationCode(value);\n                  }}\n                  placeholder=\"000000\"\n                  className=\"pl-10 text-center text-2xl tracking-widest font-mono\"\n                  maxLength={6}\n                  autoComplete=\"one-time-code\"\n                  autoFocus\n                />\n              </div>\n              <p className=\"mt-2 text-xs text-gray-500 text-center\">\n                {isDemoAccount && verificationCode.length === 0 ? (\n                  <span className=\"text-green-600 font-medium\">\n                    Conta Demo - Use o código: <strong className=\"text-lg\">000000</strong>\n                  </span>\n                ) : (\n                  <>{txtSentCodeTo} <strong>{formData.email}</strong></>\n                )}\n              </p>\n            </div>\n\n            <Button\n              type=\"submit\"\n              disabled={loading || verificationCode.length !== 6}\n              className=\"w-full bg-gradient-to-r from-blue-500 to-cyan-500 hover:from-blue-600 hover:to-cyan-600 text-white font-medium py-3\"\n            >\n              {loading ? txtVerifying : txtVerify}\n            </Button>\n\n            <div className=\"flex flex-col gap-2\">\n              <Button\n                type=\"button\"\n                onClick={handleResendCode}\n                disabled={loading}\n                variant=\"outline\"\n                className=\"w-full\"\n              >\n                {txtResendCode}\n              </Button>\n              \n              <Button\n                type=\"button\"\n                onClick={handleBackToCredentials}\n                disabled={loading}\n                variant=\"ghost\"\n                className=\"w-full\"\n              >\n                <ArrowLeft className=\"w-4 h-4 mr-2\" />\n                {txtBackToLogin}\n              </Button>\n            </div>\n          </form>\n        )}\n\n        {step === 'credentials' && (\n          <div className=\"mt-6 text-center\">\n            <p className=\"text-gray-600\">\n              {txtNoAccount}{' '}\n              <Link\n                to=\"/register\"\n                className=\"text-blue-600 hover:text-blue-700 font-medium transition-colors\"\n              >\n                {txtRegisterNow}\n              </Link>\n            </p>\n          </div>\n        )}\n\n        {apiError && <ApiDiagnostic error={apiError} />}\n      </Card>\n    </div>\n  );\n}\n","path":null,"size_bytes":17148,"size_tokens":null},"src/utils/fixDemoSubscription.js":{"content":"/**\n * Corrigir subscrição do utilizador demo\n * Uso: Executar via fixDemoSubscription() no console\n */\n\nimport { base44 } from '@/api/base44Client';\n\nexport async function fixDemoSubscription() {\n  console.log('🔧 CORRIGINDO SUBSCRIÇÃO DO UTILIZADOR DEMO...');\n  \n  try {\n    const userEmail = 'demo@example.com';\n    \n    // Buscar subscriptions existentes\n    const existingSubs = await base44.entities.Subscription.filter({\n      user_email: userEmail,\n      plan: 'business'\n    });\n    \n    console.log(`📊 Encontradas ${existingSubs.length} subscrições existentes`);\n    \n    // Cancelar todas as subscrições antigas\n    for (const sub of existingSubs) {\n      console.log(`  🗑️ Cancelando subscrição antiga: ${sub.id} (status: ${sub.status})`);\n      await base44.entities.Subscription.delete(sub.id);\n    }\n    \n    // Criar nova subscrição válida com período de teste\n    const now = new Date();\n    const trialEndDate = new Date(now);\n    trialEndDate.setDate(trialEndDate.getDate() + 7); // +7 dias de trial\n    \n    const endDate = new Date(trialEndDate);\n    endDate.setMonth(endDate.getMonth() + 1); // +1 mês após trial\n    \n    const newSub = await base44.entities.Subscription.create({\n      user_email: userEmail,\n      plan: 'business',\n      status: 'trialing', // Status de período de teste\n      amount: 49.99,\n      currency: 'EUR',\n      payment_method: 'stripe',\n      stripe_subscription_id: `sub_trial_${Date.now()}`,\n      created_date: now.toISOString(),\n      trial_end_date: trialEndDate.toISOString(),\n      end_date: endDate.toISOString(),\n      auto_renew: true\n    });\n    \n    console.log('✅ Nova subscrição criada com sucesso!');\n    console.log('📊 Detalhes:', {\n      id: newSub.id,\n      status: newSub.status,\n      created: newSub.created_date,\n      trial_end: newSub.trial_end_date,\n      end: newSub.end_date,\n      auto_renew: newSub.auto_renew\n    });\n    \n    console.log('\\n🎉 Correção concluída! Recarregue a página para ver as mudanças.');\n    setTimeout(() => window.location.reload(), 2000);\n    \n    return newSub;\n    \n  } catch (error) {\n    console.error('❌ Erro ao corrigir subscrição:', error);\n    throw error;\n  }\n}\n\n// Expor globalmente\nif (typeof window !== 'undefined') {\n  window.fixDemoSubscription = fixDemoSubscription;\n}\n","path":null,"size_bytes":2334,"size_tokens":null},"src/utils/fixLegacyProfiles.js":{"content":"/**\n * Corrigir perfis legados criando Business entities faltantes\n * Uso: Executar via createBusinessForLegacyProfiles() no console\n */\n\nimport { companyProfileStorage, normalizeCategory, normalizeCountry } from '@/models/companyProfile';\nimport { base44 } from '@/api/base44Client';\n\nexport async function createBusinessForLegacyProfiles() {\n  console.log('🔧 CORRIGINDO PERFIS LEGADOS - Criando Business entities...');\n  \n  try {\n    // Buscar todos os perfis do PostgreSQL\n    const { safeFetch } = await import('@/utils/apiConfig');\n    const { response, data: profiles } = await safeFetch('/api/company-profiles');\n    if (!response.ok) {\n      throw new Error('Erro ao buscar perfis');\n    }\n    \n    console.log(`📊 Encontrados ${profiles?.length || 0} perfis`);\n    \n    if (!profiles || profiles.length === 0) {\n      console.log('⚠️ Nenhum perfil encontrado para processar');\n      return { created: 0, updated: 0, skipped: 0 };\n    }\n    \n    let created = 0;\n    let updated = 0;\n    let skipped = 0;\n    \n    for (const profile of profiles) {\n      try {\n        console.log(`\\n🔍 Processando: ${profile.companyName} (ID: ${profile.id})`);\n        \n        // Verificar se Business já existe\n        const existingBusinesses = await base44.entities.Business.filter({ id: profile.id });\n        \n        if (existingBusinesses.length > 0) {\n          console.log(`  ⏭️  Business já existe, pulando...`);\n          skipped++;\n          continue;\n        }\n        \n        // Criar Business entity\n        const businessData = {\n          id: profile.id,\n          name: profile.companyName || 'Sem Nome',\n          description: profile.companyDescription || '',\n          category: normalizeCategory(profile.companyCategory || 'outros'),\n          address: profile.companyAddress || `${profile.companyStreetName || ''} ${profile.companyDoorNumber || ''}`.trim(),\n          street_name: profile.companyStreetName || '',\n          door_number: profile.companyDoorNumber || '',\n          postal_code: profile.companyPostalCode || '',\n          city: profile.companyCity || '',\n          district: profile.companyDistrict || '',\n          country: normalizeCountry(profile.companyCountry || 'PT'),\n          phone: profile.companyPhone || '',\n          email: profile.companyEmail || '',\n          logo_url: profile.logoUrl || '',\n          photo_url: profile.photoUrl || '',\n          is_active: profile.status === 'active',\n          owner_email: profile.adminUserId,\n          latitude: profile.companyCoordinates?.lat || null,\n          longitude: profile.companyCoordinates?.lng || null\n        };\n        \n        await base44.entities.Business.create(businessData);\n        console.log(`  ✅ Business criada com sucesso!`);\n        created++;\n        \n      } catch (error) {\n        console.error(`  ❌ Erro ao processar ${profile.companyName}:`, error.message);\n      }\n    }\n    \n    console.log('\\n' + '='.repeat(50));\n    console.log('📊 RESUMO:');\n    console.log(`  ✅ Criadas: ${created}`);\n    console.log(`  🔄 Atualizadas: ${updated}`);\n    console.log(`  ⏭️  Puladas: ${skipped}`);\n    console.log('='.repeat(50));\n    \n    if (created > 0) {\n      console.log('\\n🎉 Correção concluída! Recarregue a página para ver as mudanças.');\n      setTimeout(() => window.location.reload(), 2000);\n    }\n    \n    return { created, updated, skipped };\n    \n  } catch (error) {\n    console.error('❌ Erro ao corrigir perfis legados:', error);\n    throw error;\n  }\n}\n\n// Expor globalmente\nif (typeof window !== 'undefined') {\n  window.createBusinessForLegacyProfiles = createBusinessForLegacyProfiles;\n}\n","path":null,"size_bytes":3654,"size_tokens":null},"src/components/business/AppointmentHistory.jsx":{"content":"import React, { useState } from \"react\";\nimport { base44 } from \"@/api/base44Client\";\nimport { useQuery, useMutation, useQueryClient } from \"@tanstack/react-query\";\nimport { Card, CardContent } from \"@/components/ui/card\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Input } from \"@/components/ui/input\";\nimport { Button } from \"@/components/ui/button\";\nimport { \n  Search,\n  Clock, \n  CheckCircle2,\n  XCircle,\n  Calendar,\n  User,\n  Phone,\n  AlertCircle,\n  Filter,\n  Trash2\n} from \"lucide-react\";\nimport { format } from \"date-fns\";\nimport { pt } from \"date-fns/locale\";\nimport { toast } from \"sonner\";\nimport { useConfirm } from \"@/hooks/useConfirm\";\nimport {\n  Select,\n  SelectContent,\n  SelectItem,\n  SelectTrigger,\n  SelectValue,\n} from \"@/components/ui/select\";\nimport { useAutoTranslate } from \"@/hooks/useTranslate\";\n\nexport default function AppointmentHistory({ businessId }) {\n  // Traduções\n  const txtCompleted = useAutoTranslate('Concluído', 'pt');\n  const txtCancelled = useAutoTranslate('Cancelado', 'pt');\n  const txtNoShow = useAutoTranslate('Falta', 'pt');\n  const txtSearch = useAutoTranslate('Pesquisar...', 'pt');\n  const txtAll = useAutoTranslate('Todos', 'pt');\n  const txtClearHistory = useAutoTranslate('Limpar Histórico', 'pt');\n  const txtClearHistoryTitle = useAutoTranslate('Limpar Histórico de Marcações', 'pt');\n  const txtConfirmClear = useAutoTranslate('Tem certeza que deseja remover todas as', 'pt');\n  const txtAppointments = useAutoTranslate('marcações do histórico? Esta ação não pode ser desfeita.', 'pt');\n  const txtYesClear = useAutoTranslate('Sim, limpar histórico', 'pt');\n  const txtCancel = useAutoTranslate('Cancelar', 'pt');\n  const txtAppointmentRemoved = useAutoTranslate('marcação removida', 'pt');\n  const txtAppointmentsRemoved = useAutoTranslate('marcações removidas', 'pt');\n  const txtFromHistory = useAutoTranslate('do histórico', 'pt');\n  const txtErrorClearingHistory = useAutoTranslate('Erro ao limpar histórico', 'pt');\n  const txtNoHistory = useAutoTranslate('Sem histórico', 'pt');\n  const txtNoAppointmentsFound = useAutoTranslate('Nenhuma marcação encontrada', 'pt');\n  const txtCompletedAppointmentsAppearHere = useAutoTranslate('Marcações concluídas aparecerão aqui', 'pt');\n  const txtAdjustFilters = useAutoTranslate('Tente ajustar os filtros', 'pt');\n  const txtAppointment = useAutoTranslate('marcação', 'pt');\n  const txtAppointmentsCount = useAutoTranslate('marcações', 'pt');\n  const txtClearing = useAutoTranslate('Limpando...', 'pt');\n  const txtClear = useAutoTranslate('Limpar', 'pt');\n  const txtService = useAutoTranslate('Serviço', 'pt');\n  const txtStatus = useAutoTranslate('Estado', 'pt');\n  const txtLoadingHistory = useAutoTranslate('Carregando histórico...', 'pt');\n  const txtCompletedLabel = useAutoTranslate('Concluídas', 'pt');\n  const txtCancelledLabel = useAutoTranslate('Canceladas', 'pt');\n  const txtNoShows = useAutoTranslate('Faltas', 'pt');\n  const txtSearchPlaceholder = useAutoTranslate('Procurar...', 'pt');\n  const txtFilter = useAutoTranslate('Filtrar', 'pt');\n  const txtAllLabel = useAutoTranslate('Todos', 'pt');\n  const txtCompletedFilter = useAutoTranslate('Concluídos', 'pt');\n  const txtCancelledFilter = useAutoTranslate('Cancelados', 'pt');\n  const txtNoShowsFilter = useAutoTranslate('Faltas', 'pt');\n\n  const statusConfig = {\n    concluido: { \n      icon: CheckCircle2, \n      color: \"bg-green-100 text-green-700 border-green-200\", \n      label: txtCompleted \n    },\n    cancelado: { \n      icon: XCircle, \n      color: \"bg-red-100 text-red-700 border-red-200\", \n      label: txtCancelled \n    },\n    falta: { \n      icon: AlertCircle, \n      color: \"bg-orange-100 text-orange-700 border-orange-200\", \n      label: txtNoShow \n    }\n  };\n  const queryClient = useQueryClient();\n  const { ConfirmDialog, confirm } = useConfirm();\n  const [searchTerm, setSearchTerm] = useState(\"\");\n  const [statusFilter, setStatusFilter] = useState(\"all\");\n\n  const { data: appointments = [], isLoading } = useQuery({\n    queryKey: ['business-appointment-history', businessId],\n    queryFn: () => base44.entities.Appointment.filter({ \n      business_id: businessId,\n      status: { $in: ['concluido', 'cancelado', 'falta'] }\n    }, '-appointment_date'),\n    initialData: [],\n    enabled: !!businessId,\n  });\n\n  const { data: services = [] } = useQuery({\n    queryKey: ['business-services', businessId],\n    queryFn: () => base44.entities.Service.filter({ business_id: businessId }),\n    initialData: [],\n    enabled: !!businessId,\n  });\n\n  const clearHistoryMutation = useMutation({\n    mutationFn: async () => {\n      const appointmentsToDelete = appointments.filter(a => \n        a && ['concluido', 'cancelado', 'falta'].includes(a.status)\n      );\n      \n      for (const appointment of appointmentsToDelete) {\n        await base44.entities.Appointment.delete(appointment.id);\n      }\n      \n      return appointmentsToDelete.length;\n    },\n    onSuccess: (count) => {\n      queryClient.invalidateQueries({ queryKey: ['business-appointment-history'] });\n      queryClient.invalidateQueries({ queryKey: ['business-appointments'] });\n      toast.success(`${count} ${count === 1 ? txtAppointmentRemoved : txtAppointmentsRemoved} ${txtFromHistory}`);\n    },\n    onError: () => {\n      toast.error(txtErrorClearingHistory);\n    }\n  });\n\n  const handleClearHistory = async () => {\n    const confirmed = await confirm({\n      title: txtClearHistoryTitle,\n      description: `${txtConfirmClear} ${appointments.length} ${txtAppointments}`,\n      confirmText: txtYesClear,\n      cancelText: txtCancel\n    });\n\n    if (confirmed) {\n      clearHistoryMutation.mutate();\n    }\n  };\n\n  const getServiceName = (serviceId) => {\n    return services.find(s => s && s.id === serviceId)?.name || 'Serviço';\n  };\n\n  const filteredAppointments = appointments.filter(appointment => {\n    if (!appointment) return false;\n\n    const matchesStatus = statusFilter === \"all\" || appointment.status === statusFilter;\n\n    if (!searchTerm) return matchesStatus;\n\n    const searchLower = searchTerm.toLowerCase();\n    const matchesSearch = \n      appointment.user_email?.toLowerCase().includes(searchLower) ||\n      appointment.user_phone?.toLowerCase().includes(searchLower) ||\n      appointment.user_name?.toLowerCase().includes(searchLower) ||\n      getServiceName(appointment.service_id).toLowerCase().includes(searchLower);\n\n    return matchesStatus && matchesSearch;\n  });\n\n  const completedAppointments = appointments.filter(a => a?.status === 'concluido');\n  const cancelledAppointments = appointments.filter(a => a?.status === 'cancelado');\n  const noShowAppointments = appointments.filter(a => a?.status === 'falta');\n\n  if (isLoading) {\n    return (\n      <div className=\"p-4 text-center text-slate-600\">\n        <Clock className=\"w-8 h-8 mx-auto mb-2 animate-spin\" />\n        <p className=\"text-sm\">{txtLoadingHistory}</p>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"space-y-4\">\n      <div className=\"grid grid-cols-3 gap-3\">\n        <Card className=\"border-slate-200\">\n          <CardContent className=\"p-3\">\n            <div className=\"flex items-center gap-2\">\n              <div className=\"p-2 bg-green-100 rounded-full\">\n                <CheckCircle2 className=\"w-4 h-4 text-green-600\" />\n              </div>\n              <div>\n                <p className=\"text-lg font-bold text-slate-900\">{completedAppointments.length}</p>\n                <p className=\"text-xs text-slate-600\">{txtCompletedLabel}</p>\n              </div>\n            </div>\n          </CardContent>\n        </Card>\n\n        <Card className=\"border-slate-200\">\n          <CardContent className=\"p-3\">\n            <div className=\"flex items-center gap-2\">\n              <div className=\"p-2 bg-red-100 rounded-full\">\n                <XCircle className=\"w-4 h-4 text-red-600\" />\n              </div>\n              <div>\n                <p className=\"text-lg font-bold text-slate-900\">{cancelledAppointments.length}</p>\n                <p className=\"text-xs text-slate-600\">{txtCancelledLabel}</p>\n              </div>\n            </div>\n          </CardContent>\n        </Card>\n\n        <Card className=\"border-slate-200\">\n          <CardContent className=\"p-3\">\n            <div className=\"flex items-center gap-2\">\n              <div className=\"p-2 bg-orange-100 rounded-full\">\n                <AlertCircle className=\"w-4 h-4 text-orange-600\" />\n              </div>\n              <div>\n                <p className=\"text-lg font-bold text-slate-900\">{noShowAppointments.length}</p>\n                <p className=\"text-xs text-slate-600\">{txtNoShows}</p>\n              </div>\n            </div>\n          </CardContent>\n        </Card>\n      </div>\n\n      <Card className=\"border-slate-200\">\n        <CardContent className=\"p-3\">\n          <div className=\"flex flex-col sm:flex-row gap-2\">\n            <div className=\"flex-1 relative\">\n              <Search className=\"absolute left-2 top-1/2 -translate-y-1/2 w-3 h-3 text-slate-400\" />\n              <Input\n                placeholder={txtSearchPlaceholder}\n                value={searchTerm}\n                onChange={(e) => setSearchTerm(e.target.value)}\n                className=\"pl-8 h-8 text-xs\"\n              />\n            </div>\n            <Select value={statusFilter} onValueChange={setStatusFilter}>\n              <SelectTrigger className=\"w-full sm:w-32 h-8 text-xs\">\n                <Filter className=\"w-3 h-3 mr-1\" />\n                <SelectValue placeholder={txtFilter} />\n              </SelectTrigger>\n              <SelectContent>\n                <SelectItem value=\"all\">{txtAllLabel}</SelectItem>\n                <SelectItem value=\"concluido\">{txtCompletedFilter}</SelectItem>\n                <SelectItem value=\"cancelado\">{txtCancelledFilter}</SelectItem>\n                <SelectItem value=\"falta\">{txtNoShowsFilter}</SelectItem>\n              </SelectContent>\n            </Select>\n          </div>\n        </CardContent>\n      </Card>\n\n      {filteredAppointments.length === 0 ? (\n        <Card className=\"border-slate-200\">\n          <CardContent className=\"py-8 text-center\">\n            <Calendar className=\"w-12 h-12 text-slate-400 mx-auto mb-3\" />\n            <h3 className=\"text-base font-bold text-slate-900 mb-1\">\n              {searchTerm || statusFilter !== \"all\" \n                ? txtNoAppointmentsFound\n                : txtNoHistory\n              }\n            </h3>\n            <p className=\"text-sm text-slate-600\">\n              {searchTerm || statusFilter !== \"all\"\n                ? txtAdjustFilters\n                : txtCompletedAppointmentsAppearHere\n              }\n            </p>\n          </CardContent>\n        </Card>\n      ) : (\n        <div className=\"space-y-3\">\n          <div className=\"flex justify-between items-center\">\n            <p className=\"text-xs text-slate-600\">\n              {filteredAppointments.length} {filteredAppointments.length === 1 ? txtAppointment : txtAppointmentsCount}\n            </p>\n            <Button\n              variant=\"outline\"\n              size=\"sm\"\n              onClick={handleClearHistory}\n              disabled={clearHistoryMutation.isPending || appointments.length === 0}\n              className=\"border-red-200 text-red-600 hover:bg-red-50 h-7 text-xs\"\n            >\n              <Trash2 className=\"w-3 h-3 mr-1\" />\n              {clearHistoryMutation.isPending ? txtClearing : txtClear}\n            </Button>\n          </div>\n\n          <div className=\"space-y-2 max-h-96 overflow-y-auto\">\n            {filteredAppointments.map(appointment => {\n              if (!appointment) return null;\n              \n              const status = statusConfig[appointment.status];\n              const StatusIcon = status.icon;\n\n              return (\n                <Card key={appointment.id} className=\"border-slate-200 hover:shadow-md transition-shadow\">\n                  <CardContent className=\"p-3\">\n                    <div className=\"flex flex-col gap-2\">\n                      <div className=\"flex items-center justify-between\">\n                        <div className=\"flex items-center gap-2\">\n                          <Calendar className=\"w-4 h-4 text-sky-600\" />\n                          <span className=\"text-sm font-bold text-slate-900\">\n                            {(() => {\n                              try {\n                                if (!appointment.appointment_date) return 'Data não disponível';\n                                const date = new Date(appointment.appointment_date);\n                                if (isNaN(date.getTime())) return 'Data não disponível';\n                                return format(date, \"dd/MM/yyyy\", { locale: pt });\n                              } catch (e) {\n                                return 'Data não disponível';\n                              }\n                            })()} {appointment.appointment_time ? `às ${appointment.appointment_time}` : ''}\n                          </span>\n                        </div>\n                        <Badge className={`${status.color} text-xs`}>\n                          <StatusIcon className=\"w-2.5 h-2.5 mr-1\" />\n                          {status.label}\n                        </Badge>\n                      </div>\n\n                      <div className=\"space-y-1 text-xs\">\n                        <div className=\"flex items-center gap-1.5 text-slate-600 font-semibold\">\n                          <span>{getServiceName(appointment.service_id)}</span>\n                        </div>\n\n                        {appointment.user_name && (\n                          <div className=\"flex items-center gap-1.5 text-slate-600\">\n                            <User className=\"w-3 h-3\" />\n                            <span>{appointment.user_name}</span>\n                          </div>\n                        )}\n\n                        {appointment.user_email && (\n                          <div className=\"flex items-center gap-1.5 text-slate-600 truncate\">\n                            <span className=\"text-xs truncate\">{appointment.user_email}</span>\n                          </div>\n                        )}\n\n                        {appointment.user_phone && (\n                          <div className=\"flex items-center gap-1.5 text-slate-600\">\n                            <Phone className=\"w-3 h-3\" />\n                            <span>{appointment.user_phone}</span>\n                          </div>\n                        )}\n\n                        {appointment.notes && (\n                          <div className=\"mt-1 p-1.5 bg-slate-50 rounded text-xs text-slate-600\">\n                            <span className=\"font-semibold\">Notas:</span> {appointment.notes}\n                          </div>\n                        )}\n\n                        {appointment.rating && (\n                          <div className=\"flex items-center gap-1.5 text-slate-600\">\n                            <span className=\"text-xs\">Avaliação:</span>\n                            <span className=\"text-sm font-bold text-amber-600\">{appointment.rating}/5</span>\n                            {appointment.feedback && (\n                              <span className=\"text-xs italic text-slate-500 truncate\">\"{appointment.feedback}\"</span>\n                            )}\n                          </div>\n                        )}\n                      </div>\n                    </div>\n                  </CardContent>\n                </Card>\n              );\n            })}\n          </div>\n        </div>\n      )}\n      <ConfirmDialog />\n    </div>\n  );\n}\n","path":null,"size_bytes":15623,"size_tokens":null},"src/components/business/TicketHistory.jsx":{"content":"import React, { useState } from \"react\";\nimport { base44 } from \"@/api/base44Client\";\nimport { useQuery, useMutation, useQueryClient } from \"@tanstack/react-query\";\nimport { Card, CardContent } from \"@/components/ui/card\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Input } from \"@/components/ui/input\";\nimport { Button } from \"@/components/ui/button\";\nimport { \n  Search,\n  Clock, \n  CheckCircle2,\n  XCircle,\n  Calendar,\n  User,\n  Phone,\n  Hash,\n  TrendingUp,\n  Award,\n  Filter,\n  Trash2\n} from \"lucide-react\";\nimport { format } from \"date-fns\";\nimport { pt } from \"date-fns/locale\";\nimport { toast } from \"sonner\";\nimport { useConfirm } from \"@/hooks/useConfirm\";\nimport {\n  Select,\n  SelectContent,\n  SelectItem,\n  SelectTrigger,\n  SelectValue,\n} from \"@/components/ui/select\";\nimport { useAutoTranslate } from \"@/hooks/useTranslate\";\n\nexport default function TicketHistory({ businessId }) {\n  // Traduções\n  const txtCompleted = useAutoTranslate('Concluído', 'pt');\n  const txtCancelled = useAutoTranslate('Cancelado', 'pt');\n  const txtSearch = useAutoTranslate('Pesquisar...', 'pt');\n  const txtAll = useAutoTranslate('Todos', 'pt');\n  const txtClearHistory = useAutoTranslate('Limpar Histórico', 'pt');\n  const txtClearHistoryTitle = useAutoTranslate('Limpar Histórico de Senhas', 'pt');\n  const txtConfirmClear = useAutoTranslate('Tem certeza que deseja remover todas as', 'pt');\n  const txtSenhas = useAutoTranslate('senhas do histórico? Esta ação não pode ser desfeita.', 'pt');\n  const txtYesClear = useAutoTranslate('Sim, limpar histórico', 'pt');\n  const txtCancel = useAutoTranslate('Cancelar', 'pt');\n  const txtTicketRemoved = useAutoTranslate('senha removida', 'pt');\n  const txtTicketsRemoved = useAutoTranslate('senhas removidas', 'pt');\n  const txtFromHistory = useAutoTranslate('do histórico', 'pt');\n  const txtErrorClearingHistory = useAutoTranslate('Erro ao limpar histórico', 'pt');\n  const txtNoHistory = useAutoTranslate('Sem histórico', 'pt');\n  const txtNoTicketsFound = useAutoTranslate('Nenhuma senha encontrada', 'pt');\n  const txtCompletedTicketsAppearHere = useAutoTranslate('Senhas concluídas aparecerão aqui', 'pt');\n  const txtAdjustFilters = useAutoTranslate('Tente ajustar os filtros', 'pt');\n  const txtTicket = useAutoTranslate('senha', 'pt');\n  const txtTickets = useAutoTranslate('senhas', 'pt');\n  const txtClearing = useAutoTranslate('Limpando...', 'pt');\n  const txtClear = useAutoTranslate('Limpar', 'pt');\n  const txtCompletedFilter = useAutoTranslate('Concluídos', 'pt');\n  const txtCancelledFilter = useAutoTranslate('Cancelados', 'pt');\n  const txtQueue = useAutoTranslate('Fila', 'pt');\n  const txtStatus = useAutoTranslate('Estado', 'pt');\n  const txtLoadingHistory = useAutoTranslate('Carregando histórico...', 'pt');\n  const txtAttended = useAutoTranslate('Atendidas', 'pt');\n  const txtCancelledLabel = useAutoTranslate('Canceladas', 'pt');\n  const txtTime = useAutoTranslate('Tempo (min)', 'pt');\n  const txtSearchPlaceholder = useAutoTranslate('Procurar...', 'pt');\n  const txtFilter = useAutoTranslate('Filtrar', 'pt');\n\n  const statusConfig = {\n    concluido: { \n      icon: CheckCircle2, \n      color: \"bg-green-100 text-green-700 border-green-200\", \n      label: txtCompleted \n    },\n    cancelado: { \n      icon: XCircle, \n      color: \"bg-red-100 text-red-700 border-red-200\", \n      label: txtCancelled \n    }\n  };\n  const queryClient = useQueryClient();\n  const { ConfirmDialog, confirm } = useConfirm();\n  const [searchTerm, setSearchTerm] = useState(\"\");\n  const [statusFilter, setStatusFilter] = useState(\"all\");\n\n  const { data: tickets = [], isLoading } = useQuery({\n    queryKey: ['business-ticket-history', businessId],\n    queryFn: () => base44.entities.Ticket.filter({ \n      business_id: businessId,\n      status: { $in: ['concluido', 'cancelado'] }\n    }, '-completed_at'),\n    initialData: [],\n    enabled: !!businessId,\n  });\n\n  const { data: queues = [] } = useQuery({\n    queryKey: ['business-queues', businessId],\n    queryFn: () => base44.entities.Queue.filter({ business_id: businessId }),\n    initialData: [],\n    enabled: !!businessId,\n  });\n\n  const clearHistoryMutation = useMutation({\n    mutationFn: async () => {\n      const ticketsToDelete = tickets.filter(t => \n        t && ['concluido', 'cancelado'].includes(t.status)\n      );\n      \n      for (const ticket of ticketsToDelete) {\n        await base44.entities.Ticket.delete(ticket.id);\n      }\n      \n      return ticketsToDelete.length;\n    },\n    onSuccess: (count) => {\n      queryClient.invalidateQueries({ queryKey: ['business-ticket-history'] });\n      queryClient.invalidateQueries({ queryKey: ['business-tickets'] });\n      toast.success(`${count} ${count === 1 ? txtTicketRemoved : txtTicketsRemoved} ${txtFromHistory}`);\n    },\n    onError: () => {\n      toast.error(txtErrorClearingHistory);\n    }\n  });\n\n  const handleClearHistory = async () => {\n    const confirmed = await confirm({\n      title: txtClearHistoryTitle,\n      description: `${txtConfirmClear} ${tickets.length} ${txtSenhas}`,\n      confirmText: txtYesClear,\n      cancelText: txtCancel\n    });\n\n    if (confirmed) {\n      clearHistoryMutation.mutate();\n    }\n  };\n\n  const getQueueName = (queueId) => {\n    return queues.find(q => q && q.id === queueId)?.name || 'Fila';\n  };\n\n  const filteredTickets = tickets.filter(ticket => {\n    if (!ticket) return false;\n\n    const matchesStatus = statusFilter === \"all\" || ticket.status === statusFilter;\n\n    if (!searchTerm) return matchesStatus;\n\n    const searchLower = searchTerm.toLowerCase();\n    const matchesSearch = \n      ticket.ticket_number?.toString().includes(searchLower) ||\n      ticket.user_email?.toLowerCase().includes(searchLower) ||\n      ticket.user_phone?.toLowerCase().includes(searchLower) ||\n      ticket.manual_name?.toLowerCase().includes(searchLower) ||\n      getQueueName(ticket.queue_id).toLowerCase().includes(searchLower);\n\n    return matchesStatus && matchesSearch;\n  });\n\n  const completedTickets = tickets.filter(t => t?.status === 'concluido');\n  const cancelledTickets = tickets.filter(t => t?.status === 'cancelado');\n\n  const ticketsWithTimestamps = completedTickets.filter(t => t?.called_at && t?.completed_at);\n  \n  const averageServiceTime = ticketsWithTimestamps.length > 0\n    ? Math.round(\n        ticketsWithTimestamps.reduce((sum, t) => {\n          const start = new Date(t.called_at);\n          const end = new Date(t.completed_at);\n          const minutes = (end - start) / 1000 / 60;\n          return sum + minutes;\n        }, 0) / ticketsWithTimestamps.length\n      )\n    : 0;\n\n  if (isLoading) {\n    return (\n      <div className=\"p-4 text-center text-slate-600\">\n        <Clock className=\"w-8 h-8 mx-auto mb-2 animate-spin\" />\n        <p className=\"text-sm\">{txtLoadingHistory}</p>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"space-y-4\">\n      <div className=\"grid grid-cols-3 gap-3\">\n        <Card className=\"border-slate-200\">\n          <CardContent className=\"p-3\">\n            <div className=\"flex items-center gap-2\">\n              <div className=\"p-2 bg-green-100 rounded-full\">\n                <CheckCircle2 className=\"w-4 h-4 text-green-600\" />\n              </div>\n              <div>\n                <p className=\"text-lg font-bold text-slate-900\">{completedTickets.length}</p>\n                <p className=\"text-xs text-slate-600\">{txtAttended}</p>\n              </div>\n            </div>\n          </CardContent>\n        </Card>\n\n        <Card className=\"border-slate-200\">\n          <CardContent className=\"p-3\">\n            <div className=\"flex items-center gap-2\">\n              <div className=\"p-2 bg-red-100 rounded-full\">\n                <XCircle className=\"w-4 h-4 text-red-600\" />\n              </div>\n              <div>\n                <p className=\"text-lg font-bold text-slate-900\">{cancelledTickets.length}</p>\n                <p className=\"text-xs text-slate-600\">{txtCancelledLabel}</p>\n              </div>\n            </div>\n          </CardContent>\n        </Card>\n\n        <Card className=\"border-slate-200\">\n          <CardContent className=\"p-3\">\n            <div className=\"flex items-center gap-2\">\n              <div className=\"p-2 bg-blue-100 rounded-full\">\n                <TrendingUp className=\"w-4 h-4 text-blue-600\" />\n              </div>\n              <div>\n                <p className=\"text-lg font-bold text-slate-900\">{averageServiceTime}</p>\n                <p className=\"text-xs text-slate-600\">{txtTime}</p>\n              </div>\n            </div>\n          </CardContent>\n        </Card>\n      </div>\n\n      <Card className=\"border-slate-200\">\n        <CardContent className=\"p-3\">\n          <div className=\"flex flex-col sm:flex-row gap-2\">\n            <div className=\"flex-1 relative\">\n              <Search className=\"absolute left-2 top-1/2 -translate-y-1/2 w-3 h-3 text-slate-400\" />\n              <Input\n                placeholder={txtSearchPlaceholder}\n                value={searchTerm}\n                onChange={(e) => setSearchTerm(e.target.value)}\n                className=\"pl-8 h-8 text-xs\"\n              />\n            </div>\n            <Select value={statusFilter} onValueChange={setStatusFilter}>\n              <SelectTrigger className=\"w-full sm:w-32 h-8 text-xs\">\n                <Filter className=\"w-3 h-3 mr-1\" />\n                <SelectValue placeholder={txtFilter} />\n              </SelectTrigger>\n              <SelectContent>\n                <SelectItem value=\"all\">{txtAll}</SelectItem>\n                <SelectItem value=\"concluido\">{txtCompletedFilter}</SelectItem>\n                <SelectItem value=\"cancelado\">{txtCancelledFilter}</SelectItem>\n              </SelectContent>\n            </Select>\n          </div>\n        </CardContent>\n      </Card>\n\n      {filteredTickets.length === 0 ? (\n        <Card className=\"border-slate-200\">\n          <CardContent className=\"py-8 text-center\">\n            <Clock className=\"w-12 h-12 text-slate-400 mx-auto mb-3\" />\n            <h3 className=\"text-base font-bold text-slate-900 mb-1\">\n              {searchTerm || statusFilter !== \"all\" \n                ? txtNoTicketsFound\n                : txtNoHistory\n              }\n            </h3>\n            <p className=\"text-sm text-slate-600\">\n              {searchTerm || statusFilter !== \"all\"\n                ? txtAdjustFilters\n                : txtCompletedTicketsAppearHere\n              }\n            </p>\n          </CardContent>\n        </Card>\n      ) : (\n        <div className=\"space-y-3\">\n          <div className=\"flex justify-between items-center\">\n            <p className=\"text-xs text-slate-600\">\n              {filteredTickets.length} {filteredTickets.length === 1 ? txtTicket : txtTickets}\n            </p>\n            <Button\n              variant=\"outline\"\n              size=\"sm\"\n              onClick={handleClearHistory}\n              disabled={clearHistoryMutation.isPending || tickets.length === 0}\n              className=\"border-red-200 text-red-600 hover:bg-red-50 h-7 text-xs\"\n            >\n              <Trash2 className=\"w-3 h-3 mr-1\" />\n              {clearHistoryMutation.isPending ? txtClearing : txtClear}\n            </Button>\n          </div>\n\n          <div className=\"space-y-2 max-h-96 overflow-y-auto\">\n            {filteredTickets.map(ticket => {\n              if (!ticket) return null;\n              \n              const status = statusConfig[ticket.status];\n              const StatusIcon = status.icon;\n\n              return (\n                <Card key={ticket.id} className=\"border-slate-200 hover:shadow-md transition-shadow\">\n                  <CardContent className=\"p-3\">\n                    <div className=\"flex flex-col gap-2\">\n                      <div className=\"flex items-center justify-between\">\n                        <div className=\"flex items-center gap-2\">\n                          <Hash className=\"w-3 h-3 text-slate-400\" />\n                          <span className=\"text-xl font-bold text-sky-600\">\n                            {ticket.ticket_number}\n                          </span>\n                        </div>\n                        <Badge className={`${status.color} text-xs`}>\n                          <StatusIcon className=\"w-2.5 h-2.5 mr-1\" />\n                          {status.label}\n                        </Badge>\n                      </div>\n\n                      <div className=\"space-y-1 text-xs\">\n                        <div className=\"flex items-center gap-1.5 text-slate-600\">\n                          <Award className=\"w-3 h-3\" />\n                          <span className=\"font-semibold\">{getQueueName(ticket.queue_id)}</span>\n                        </div>\n\n                        {ticket.is_manual && ticket.manual_name && (\n                          <div className=\"flex items-center gap-1.5 text-slate-600\">\n                            <User className=\"w-3 h-3\" />\n                            <span>{ticket.manual_name}</span>\n                            <Badge variant=\"outline\" className=\"text-xs\">Manual</Badge>\n                          </div>\n                        )}\n\n                        {!ticket.is_manual && ticket.user_email && (\n                          <div className=\"flex items-center gap-1.5 text-slate-600\">\n                            <User className=\"w-3 h-3\" />\n                            <span className=\"truncate\">{ticket.user_email}</span>\n                          </div>\n                        )}\n\n                        {ticket.user_phone && (\n                          <div className=\"flex items-center gap-1.5 text-slate-600\">\n                            <Phone className=\"w-3 h-3\" />\n                            <span>{ticket.user_phone}</span>\n                          </div>\n                        )}\n\n                        {ticket.completed_at && (\n                          <div className=\"flex items-center gap-1.5 text-slate-600\">\n                            <Calendar className=\"w-3 h-3\" />\n                            <span>\n                              {(() => {\n                                try {\n                                  const date = new Date(ticket.completed_at);\n                                  if (isNaN(date.getTime())) return 'Data não disponível';\n                                  return format(date, \"dd/MM/yyyy HH:mm\", { locale: pt });\n                                } catch (e) {\n                                  return 'Data não disponível';\n                                }\n                              })()}\n                            </span>\n                          </div>\n                        )}\n\n                        {ticket.status === 'concluido' && ticket.called_at && ticket.completed_at && (\n                          <div className=\"flex items-center gap-1.5 text-slate-600\">\n                            <Clock className=\"w-3 h-3\" />\n                            <span>\n                              {(() => {\n                                try {\n                                  const completedDate = new Date(ticket.completed_at);\n                                  const calledDate = new Date(ticket.called_at);\n                                  if (isNaN(completedDate.getTime()) || isNaN(calledDate.getTime())) {\n                                    return 'Tempo não disponível';\n                                  }\n                                  const minutes = Math.round((completedDate - calledDate) / 1000 / 60);\n                                  return `Atendimento: ${minutes} min`;\n                                } catch (e) {\n                                  return 'Tempo não disponível';\n                                }\n                              })()}\n                            </span>\n                          </div>\n                        )}\n\n                        {ticket.rating && (\n                          <div className=\"flex items-center gap-1.5 text-slate-600\">\n                            <span className=\"text-xs\">Avaliação:</span>\n                            <span className=\"text-sm font-bold text-amber-600\">{ticket.rating}/5</span>\n                          </div>\n                        )}\n                      </div>\n                    </div>\n                  </CardContent>\n                </Card>\n              );\n            })}\n          </div>\n        </div>\n      )}\n      <ConfirmDialog />\n    </div>\n  );\n}\n","path":null,"size_bytes":16415,"size_tokens":null},"src/components/support/SupportContent.jsx":{"content":"import React from \"react\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Mail, Clock, MessageSquare, HelpCircle } from \"lucide-react\";\nimport { TranslatedText } from \"@/components/translation/TranslatedText\";\n\nexport function SupportContent() {\n  return (\n    <div className=\"space-y-4 md:space-y-6\">\n      <Card>\n        <CardHeader>\n          <CardTitle className=\"flex items-center gap-2 text-lg md:text-xl\">\n            <Mail className=\"w-5 h-5 text-blue-600\" />\n            Email\n          </CardTitle>\n        </CardHeader>\n        <CardContent>\n          <a \n            href=\"mailto:suporteqzero@gmail.com\"\n            className=\"text-base md:text-lg text-blue-600 hover:text-blue-700 hover:underline\"\n          >\n            suporteqzero@gmail.com\n          </a>\n        </CardContent>\n      </Card>\n\n      <Card>\n        <CardHeader>\n          <CardTitle className=\"flex items-center gap-2 text-lg md:text-xl\">\n            <Clock className=\"w-5 h-5 text-blue-600\" />\n            <TranslatedText text=\"Horário de Suporte\" sourceLang=\"pt\" />\n          </CardTitle>\n        </CardHeader>\n        <CardContent className=\"space-y-1\">\n          <p className=\"text-sm md:text-base text-slate-700\">\n            <TranslatedText text=\"Segunda a Sexta: 9h - 18h\" sourceLang=\"pt\" />\n          </p>\n          <p className=\"text-sm md:text-base text-slate-700\">\n            <TranslatedText text=\"Sábado e Domingo: Fechado\" sourceLang=\"pt\" />\n          </p>\n        </CardContent>\n      </Card>\n\n      <Card>\n        <CardHeader>\n          <CardTitle className=\"flex items-center gap-2 text-lg md:text-xl\">\n            <MessageSquare className=\"w-5 h-5 text-blue-600\" />\n            <TranslatedText text=\"Tempo de Resposta\" sourceLang=\"pt\" />\n          </CardTitle>\n        </CardHeader>\n        <CardContent>\n          <p className=\"text-sm md:text-base text-slate-700\">\n            <TranslatedText text=\"Normalmente respondemos em 24 horas\" sourceLang=\"pt\" />\n          </p>\n        </CardContent>\n      </Card>\n\n      <Card>\n        <CardHeader>\n          <CardTitle className=\"flex items-center gap-2 text-lg md:text-xl\">\n            <HelpCircle className=\"w-5 h-5 text-blue-600\" />\n            <TranslatedText text=\"Tipos de Suporte\" sourceLang=\"pt\" />\n          </CardTitle>\n        </CardHeader>\n        <CardContent>\n          <ul className=\"space-y-2 text-sm md:text-base text-slate-700\">\n            <li className=\"flex items-start gap-2\">\n              <span className=\"text-blue-600 mt-1\">•</span>\n              <TranslatedText text=\"Dúvidas técnicas\" sourceLang=\"pt\" as=\"span\" />\n            </li>\n            <li className=\"flex items-start gap-2\">\n              <span className=\"text-blue-600 mt-1\">•</span>\n              <TranslatedText text=\"Problemas de funcionamento\" sourceLang=\"pt\" as=\"span\" />\n            </li>\n            <li className=\"flex items-start gap-2\">\n              <span className=\"text-blue-600 mt-1\">•</span>\n              <TranslatedText text=\"Sugestões de melhorias\" sourceLang=\"pt\" as=\"span\" />\n            </li>\n            <li className=\"flex items-start gap-2\">\n              <span className=\"text-blue-600 mt-1\">•</span>\n              <TranslatedText text=\"Pedidos de funcionalidades\" sourceLang=\"pt\" as=\"span\" />\n            </li>\n          </ul>\n        </CardContent>\n      </Card>\n    </div>\n  );\n}\n","path":null,"size_bytes":3399,"size_tokens":null},"src/components/business/AddressAutocomplete.jsx":{"content":"import React, { useState, useEffect, useRef, useCallback } from 'react';\nimport { setOptions, importLibrary } from '@googlemaps/js-api-loader';\nimport Autocomplete from 'react-google-autocomplete';\nimport { Input } from '@/components/ui/input';\nimport { Label } from '@/components/ui/label';\nimport { Alert, AlertDescription } from '@/components/ui/alert';\nimport { MapPin, AlertCircle, AlertTriangle, Loader2, Search, ChevronDown, ChevronUp } from 'lucide-react';\nimport { toast } from 'sonner';\nimport { useAutoTranslate } from '@/hooks/useTranslate';\nimport { isCapacitorApp, safeFetch } from '@/utils/apiConfig';\n\nlet optionsSet = false;\nlet loadingPromise = null;\n\nfunction initializeGoogleMaps() {\n  const apiKey = import.meta.env.VITE_GOOGLE_MAPS_API_KEY;\n  \n  if (!apiKey) {\n    return null;\n  }\n\n  if (!optionsSet) {\n    setOptions({\n      key: apiKey,\n      version: 'weekly'\n    });\n    optionsSet = true;\n  }\n\n  return true;\n}\n\nfunction useDebounce(value, delay) {\n  const [debouncedValue, setDebouncedValue] = useState(value);\n\n  useEffect(() => {\n    const handler = setTimeout(() => {\n      setDebouncedValue(value);\n    }, delay);\n\n    return () => {\n      clearTimeout(handler);\n    };\n  }, [value, delay]);\n\n  return debouncedValue;\n}\n\nexport function AddressAutocomplete({ \n  onAddressSelect, \n  countryCode = 'PT',\n  placeholder = \"Comece a escrever a morada...\",\n  error,\n  className = \"\",\n  compact = false\n}) {\n  const txtStreetName = useAutoTranslate('Nome da Rua', 'pt');\n  const txtNumber = useAutoTranslate('Número', 'pt');\n  const txtPostalCode = useAutoTranslate('Código Postal', 'pt');\n  const txtCity = useAutoTranslate('Cidade', 'pt');\n  const txtDistrictRegion = useAutoTranslate('Distrito/Região', 'pt');\n  const txtSearchAddressOptional = useAutoTranslate('Pesquisar Morada (opcional)', 'pt');\n  const txtLoadingGoogleMaps = useAutoTranslate('A carregar Google Maps...', 'pt');\n  const txtAutoFillHint = useAutoTranslate('Pesquise para preencher automaticamente', 'pt');\n  const txtSearchingAddresses = useAutoTranslate('A procurar moradas...', 'pt');\n  const txtNoAddressesFound = useAutoTranslate('Nenhuma morada encontrada', 'pt');\n  const txtTryDifferentSearch = useAutoTranslate('Tente pesquisar de forma diferente', 'pt');\n  const txtAddressDetails = useAutoTranslate('Detalhes da Morada', 'pt');\n  const txtShowSearch = useAutoTranslate('Pesquisar morada', 'pt');\n  const txtHideSearch = useAutoTranslate('Ocultar pesquisa', 'pt');\n  const txtUseMyLocation = useAutoTranslate('Usar minha localização', 'pt');\n  const txtGettingLocation = useAutoTranslate('A obter localização...', 'pt');\n  const txtLocationError = useAutoTranslate('Erro ao obter localização', 'pt');\n  const txtLocationFilled = useAutoTranslate('Localização preenchida!', 'pt');\n\n  const isCapacitor = isCapacitorApp();\n  \n  const [apiKeyAvailable, setApiKeyAvailable] = useState(true);\n  const [scriptsLoaded, setScriptsLoaded] = useState(false);\n  const [loadingFailed, setLoadingFailed] = useState(false);\n  \n  const [inputValue, setInputValue] = useState('');\n  const [predictions, setPredictions] = useState([]);\n  const [isSearching, setIsSearching] = useState(false);\n  const [showDropdown, setShowDropdown] = useState(false);\n  const [isSelectingPlace, setIsSelectingPlace] = useState(false);\n  const [showSearchBox, setShowSearchBox] = useState(false);\n  const [isGettingLocation, setIsGettingLocation] = useState(false);\n  \n  const dropdownRef = useRef(null);\n  const inputRef = useRef(null);\n  \n  const debouncedInput = useDebounce(inputValue, 400);\n\n  const [manualAddress, setManualAddress] = useState({\n    streetName: '',\n    streetNumber: '',\n    city: '',\n    district: '',\n    postalCode: ''\n  });\n\n  const handleUseCurrentLocation = useCallback(async () => {\n    if (!navigator.geolocation) {\n      toast.error(txtLocationError);\n      return;\n    }\n\n    setIsGettingLocation(true);\n    \n    try {\n      const position = await new Promise((resolve, reject) => {\n        navigator.geolocation.getCurrentPosition(resolve, reject, {\n          enableHighAccuracy: true,\n          timeout: 10000,\n          maximumAge: 0\n        });\n      });\n\n      const { latitude, longitude } = position.coords;\n      \n      const { response, data } = await safeFetch(\n        `/api/places/reverse-geocode?lat=${latitude}&lng=${longitude}`\n      );\n\n      if (response.ok && data?.result) {\n        const place = data.result;\n        const addressData = extractAddressComponents(place.address_components || []);\n        \n        const completeAddress = {\n          ...addressData,\n          formattedAddress: place.formatted_address || '',\n          geometry: { lat: latitude, lng: longitude }\n        };\n\n        onAddressSelect(completeAddress);\n        toast.success(txtLocationFilled);\n      } else {\n        onAddressSelect({\n          geometry: { lat: latitude, lng: longitude }\n        });\n        toast.success(txtLocationFilled);\n      }\n    } catch (err) {\n      console.error('❌ Erro ao obter localização:', err);\n      toast.error(txtLocationError);\n    } finally {\n      setIsGettingLocation(false);\n    }\n  }, [onAddressSelect, txtLocationError, txtLocationFilled]);\n\n  useEffect(() => {\n    if (!isCapacitor) {\n      const initialized = initializeGoogleMaps();\n      \n      if (!initialized) {\n        console.warn('⚠️ Google Maps API key não configurada');\n        setApiKeyAvailable(false);\n        return;\n      }\n\n      if (window.google && window.google.maps && window.google.maps.places) {\n        setScriptsLoaded(true);\n        return;\n      }\n\n      if (!loadingPromise) {\n        loadingPromise = importLibrary('places')\n          .then(() => {\n            console.log('✅ Google Maps Places API carregado');\n            setScriptsLoaded(true);\n            setLoadingFailed(false);\n          })\n          .catch((err) => {\n            console.error('❌ Erro ao carregar Google Maps:', err);\n            setLoadingFailed(true);\n            setApiKeyAvailable(false);\n            loadingPromise = null;\n          });\n      } else {\n        loadingPromise.then(() => {\n          setScriptsLoaded(true);\n          setLoadingFailed(false);\n        }).catch(() => {\n          setLoadingFailed(true);\n          setApiKeyAvailable(false);\n        });\n      }\n    }\n  }, [isCapacitor]);\n\n  const [autocompleteError, setAutocompleteError] = useState(false);\n  \n  useEffect(() => {\n    if (!isCapacitor || !showSearchBox || !debouncedInput || debouncedInput.length < 3) {\n      setPredictions([]);\n      return;\n    }\n\n    const fetchPredictions = async () => {\n      setIsSearching(true);\n      setAutocompleteError(false);\n      try {\n        const { response, data } = await safeFetch(\n          `/api/places/autocomplete?input=${encodeURIComponent(debouncedInput)}&country=${countryCode}`\n        );\n        \n        if (response.ok && data?.predictions) {\n          setPredictions(data.predictions);\n          setShowDropdown(true);\n        } else {\n          setPredictions([]);\n          setAutocompleteError(true);\n        }\n      } catch (err) {\n        console.error('❌ Erro ao buscar moradas:', err);\n        setPredictions([]);\n        setAutocompleteError(true);\n      } finally {\n        setIsSearching(false);\n      }\n    };\n\n    fetchPredictions();\n  }, [isCapacitor, showSearchBox, debouncedInput, countryCode]);\n\n  useEffect(() => {\n    const handleClickOutside = (event) => {\n      if (dropdownRef.current && !dropdownRef.current.contains(event.target) &&\n          inputRef.current && !inputRef.current.contains(event.target)) {\n        setShowDropdown(false);\n      }\n    };\n\n    document.addEventListener('mousedown', handleClickOutside);\n    return () => document.removeEventListener('mousedown', handleClickOutside);\n  }, []);\n\n  const handleManualFieldChange = useCallback((field, value) => {\n    setManualAddress(prev => {\n      const updated = { ...prev, [field]: value };\n      return updated;\n    });\n  }, []);\n\n  // Debounced callback for manual address changes - only fires when user stops typing\n  const manualAddressTimeoutRef = useRef(null);\n  useEffect(() => {\n    // Only trigger for manual entry when all required fields have values\n    if (manualAddress.streetName && manualAddress.city) {\n      if (manualAddressTimeoutRef.current) {\n        clearTimeout(manualAddressTimeoutRef.current);\n      }\n      manualAddressTimeoutRef.current = setTimeout(() => {\n        onAddressSelect({\n          ...manualAddress,\n          country: countryCode,\n          isManualEntry: true\n        });\n      }, 1000); // 1 second debounce\n    }\n    return () => {\n      if (manualAddressTimeoutRef.current) {\n        clearTimeout(manualAddressTimeoutRef.current);\n      }\n    };\n  }, [manualAddress, countryCode, onAddressSelect]);\n\n  const handlePredictionSelect = useCallback(async (prediction) => {\n    setIsSelectingPlace(true);\n    setShowDropdown(false);\n    setInputValue(prediction.description);\n    \n    try {\n      // Verificar se é uma prediction do OpenStreetMap (tem osm_data)\n      if (prediction.osm_data) {\n        // Usar dados OSM diretamente + fazer reverse geocode para detalhes\n        const { lat, lng, address } = prediction.osm_data;\n        \n        let detailsUrl = `/api/places/details?place_id=${encodeURIComponent(prediction.place_id)}`;\n        if (lat && lng) {\n          detailsUrl += `&osm_lat=${lat}&osm_lng=${lng}`;\n        }\n        if (address) {\n          detailsUrl += `&osm_address=${encodeURIComponent(JSON.stringify(address))}`;\n        }\n        \n        const { response, data } = await safeFetch(detailsUrl);\n        \n        if (response.ok && data?.result) {\n          const place = data.result;\n          const addressComponents = place.address_components || [];\n          const addressData = extractAddressComponents(addressComponents);\n          \n          const newManualAddress = {\n            streetName: addressData.streetName || '',\n            streetNumber: addressData.streetNumber || '',\n            city: addressData.city || '',\n            district: addressData.district || '',\n            postalCode: addressData.postalCode || ''\n          };\n          \n          setManualAddress(newManualAddress);\n          \n          const completeAddress = {\n            ...addressData,\n            formattedAddress: place.formatted_address || prediction.description,\n            placeId: prediction.place_id,\n            geometry: { lat, lng }\n          };\n          \n          console.log('✅ Dados extraídos da morada (OpenStreetMap):', completeAddress);\n          onAddressSelect(completeAddress);\n          setShowSearchBox(false);\n        }\n      } else {\n        // Google Places - usar API normal\n        const { response, data } = await safeFetch(\n          `/api/places/details?place_id=${encodeURIComponent(prediction.place_id)}`\n        );\n        \n        if (response.ok && data?.result) {\n          const place = data.result;\n          const addressComponents = place.address_components;\n          \n          if (!addressComponents || addressComponents.length === 0) {\n            console.warn('⚠️ Resposta sem address_components');\n            return;\n          }\n          \n          const addressData = extractAddressComponents(addressComponents);\n          \n          const newManualAddress = {\n            streetName: addressData.streetName || '',\n            streetNumber: addressData.streetNumber || '',\n            city: addressData.city || '',\n            district: addressData.district || '',\n            postalCode: addressData.postalCode || ''\n          };\n          \n          setManualAddress(newManualAddress);\n          \n          const completeAddress = {\n            ...addressData,\n            formattedAddress: place.formatted_address || prediction.description,\n            placeId: prediction.place_id,\n            geometry: place.geometry?.location ? {\n              lat: place.geometry.location.lat,\n              lng: place.geometry.location.lng\n            } : null\n          };\n\n          console.log('✅ Dados extraídos da morada (Google):', completeAddress);\n          onAddressSelect(completeAddress);\n          setShowSearchBox(false);\n        }\n      }\n    } catch (err) {\n      console.error('❌ Erro ao buscar detalhes:', err);\n    } finally {\n      setIsSelectingPlace(false);\n    }\n  }, [onAddressSelect, countryCode]);\n\n  const handlePlaceSelected = useCallback((place) => {\n    if (!place || !place.address_components) {\n      console.warn('⚠️ Morada inválida selecionada');\n      return;\n    }\n\n    const addressData = extractAddressComponents(place.address_components);\n    \n    const newManualAddress = {\n      streetName: addressData.streetName || '',\n      streetNumber: addressData.streetNumber || '',\n      city: addressData.city || '',\n      district: addressData.district || '',\n      postalCode: addressData.postalCode || ''\n    };\n    \n    setManualAddress(newManualAddress);\n    \n    const completeAddress = {\n      ...addressData,\n      formattedAddress: place.formatted_address || '',\n      placeId: place.place_id || '',\n      geometry: place.geometry ? {\n        lat: place.geometry.location.lat(),\n        lng: place.geometry.location.lng()\n      } : null\n    };\n    \n    onAddressSelect(completeAddress);\n  }, [onAddressSelect]);\n\n  const getComponentRestrictions = () => {\n    if (countryCode) {\n      return { country: countryCode.toLowerCase() };\n    }\n    return undefined;\n  };\n\n  if (isCapacitor) {\n    return (\n      <div className={`space-y-4 ${className}`}>\n        <div className=\"flex items-center justify-between\">\n          <Label className=\"text-base font-semibold flex items-center gap-2\">\n            <MapPin className=\"h-4 w-4 text-blue-600\" />\n            {txtAddressDetails}\n          </Label>\n          <button\n            type=\"button\"\n            onClick={() => setShowSearchBox(!showSearchBox)}\n            className=\"text-sm text-blue-600 hover:text-blue-800 flex items-center gap-1 px-3 py-1.5 rounded-lg hover:bg-blue-50 transition-colors active:bg-blue-100\"\n          >\n            <Search className=\"h-4 w-4\" />\n            {showSearchBox ? txtHideSearch : txtShowSearch}\n            {showSearchBox ? <ChevronUp className=\"h-4 w-4\" /> : <ChevronDown className=\"h-4 w-4\" />}\n          </button>\n        </div>\n        \n        {showSearchBox && (\n          <div className=\"p-4 bg-blue-50 border border-blue-200 rounded-xl\">\n            <div className=\"relative\">\n              <Search className=\"absolute left-3 top-1/2 -translate-y-1/2 h-5 w-5 text-blue-500 z-10\" />\n              {(isSearching || isSelectingPlace) && (\n                <Loader2 className=\"absolute right-3 top-1/2 -translate-y-1/2 h-5 w-5 text-blue-500 animate-spin z-10\" />\n              )}\n              <Input\n                ref={inputRef}\n                value={inputValue}\n                onChange={(e) => {\n                  setInputValue(e.target.value);\n                  if (e.target.value.length >= 3) {\n                    setShowDropdown(true);\n                  }\n                }}\n                onFocus={() => {\n                  if (predictions.length > 0) {\n                    setShowDropdown(true);\n                  }\n                }}\n                placeholder={placeholder}\n                className=\"pl-11 pr-11 h-12 text-base bg-white border-blue-200 focus:border-blue-400 rounded-lg\"\n                disabled={isSelectingPlace}\n              />\n              \n              {showDropdown && predictions.length > 0 && (\n                <div \n                  ref={dropdownRef}\n                  className=\"absolute z-50 w-full mt-2 bg-white border border-blue-200 rounded-xl shadow-lg max-h-64 overflow-auto\"\n                >\n                  {predictions.map((prediction) => (\n                    <button\n                      key={prediction.place_id}\n                      type=\"button\"\n                      className=\"w-full px-4 py-4 text-left hover:bg-blue-50 active:bg-blue-100 focus:bg-blue-50 focus:outline-none border-b border-blue-100 last:border-b-0 first:rounded-t-xl last:rounded-b-xl\"\n                      onClick={() => handlePredictionSelect(prediction)}\n                      disabled={isSelectingPlace}\n                    >\n                      <div className=\"flex items-start gap-3\">\n                        <MapPin className=\"h-5 w-5 text-blue-500 mt-0.5 flex-shrink-0\" />\n                        <span className=\"text-base text-slate-700\">{prediction.description}</span>\n                      </div>\n                    </button>\n                  ))}\n                </div>\n              )}\n              \n              {showDropdown && isSearching && predictions.length === 0 && (\n                <div className=\"absolute z-50 w-full mt-2 bg-white border border-blue-200 rounded-xl shadow-lg p-4\">\n                  <div className=\"flex items-center gap-3 text-base text-blue-600\">\n                    <Loader2 className=\"h-5 w-5 animate-spin\" />\n                    {txtSearchingAddresses}\n                  </div>\n                </div>\n              )}\n              \n              {showDropdown && !isSearching && predictions.length === 0 && debouncedInput.length >= 3 && (\n                <div className=\"absolute z-50 w-full mt-2 bg-amber-50 border border-amber-200 rounded-xl shadow-lg p-4\">\n                  <p className=\"text-base text-amber-800 font-medium\">{txtNoAddressesFound}</p>\n                  <p className=\"text-sm text-amber-600 mt-1\">{txtTryDifferentSearch}</p>\n                </div>\n              )}\n            </div>\n            <p className=\"text-sm text-blue-600 mt-3 text-center\">\n              {txtAutoFillHint}\n            </p>\n          </div>\n        )}\n        \n        <div className=\"space-y-4\">\n          <div>\n            <Label htmlFor=\"cap-street\" className=\"text-sm font-medium mb-1.5 block\">{txtStreetName} *</Label>\n            <Input\n              id=\"cap-street\"\n              value={manualAddress.streetName}\n              onChange={(e) => handleManualFieldChange('streetName', e.target.value)}\n              placeholder=\"Ex: Rua das Flores\"\n              className={`h-12 text-base ${error && !manualAddress.streetName ? 'border-red-500' : ''}`}\n            />\n          </div>\n          \n          <div className=\"grid grid-cols-2 gap-3\">\n            <div>\n              <Label htmlFor=\"cap-number\" className=\"text-sm font-medium mb-1.5 block\">{txtNumber}</Label>\n              <Input\n                id=\"cap-number\"\n                value={manualAddress.streetNumber}\n                onChange={(e) => handleManualFieldChange('streetNumber', e.target.value)}\n                placeholder=\"123\"\n                className=\"h-12 text-base\"\n              />\n            </div>\n            <div>\n              <Label htmlFor=\"cap-postal\" className=\"text-sm font-medium mb-1.5 block\">{txtPostalCode} *</Label>\n              <Input\n                id=\"cap-postal\"\n                value={manualAddress.postalCode}\n                onChange={(e) => handleManualFieldChange('postalCode', e.target.value)}\n                placeholder=\"1000-001\"\n                className={`h-12 text-base ${error && !manualAddress.postalCode ? 'border-red-500' : ''}`}\n              />\n            </div>\n          </div>\n          \n          <div className=\"grid grid-cols-2 gap-3\">\n            <div>\n              <Label htmlFor=\"cap-city\" className=\"text-sm font-medium mb-1.5 block\">{txtCity} *</Label>\n              <Input\n                id=\"cap-city\"\n                value={manualAddress.city}\n                onChange={(e) => handleManualFieldChange('city', e.target.value)}\n                placeholder=\"Lisboa\"\n                className={`h-12 text-base ${error && !manualAddress.city ? 'border-red-500' : ''}`}\n              />\n            </div>\n            <div>\n              <Label htmlFor=\"cap-district\" className=\"text-sm font-medium mb-1.5 block\">{txtDistrictRegion}</Label>\n              <Input\n                id=\"cap-district\"\n                value={manualAddress.district}\n                onChange={(e) => handleManualFieldChange('district', e.target.value)}\n                placeholder=\"Lisboa\"\n                className=\"h-12 text-base\"\n              />\n            </div>\n          </div>\n        </div>\n        \n        {error && (\n          <p className=\"text-sm text-red-600 flex items-center gap-1.5\">\n            <AlertCircle className=\"w-4 h-4\" />\n            {error}\n          </p>\n        )}\n      </div>\n    );\n  }\n\n  if (!apiKeyAvailable || loadingFailed) {\n    return (\n      <div className={className}>\n        <Alert className=\"mb-4 border-yellow-200 bg-yellow-50\">\n          <AlertTriangle className=\"h-4 w-4 text-yellow-600\" />\n          <AlertDescription className=\"text-yellow-800 text-sm\">\n            Preencha os campos manualmente abaixo.\n          </AlertDescription>\n        </Alert>\n        \n        <div className=\"space-y-4\">\n          <div>\n            <Label htmlFor=\"manual-street\" className=\"text-sm font-medium mb-1.5 block\">{txtStreetName}</Label>\n            <Input\n              id=\"manual-street\"\n              value={manualAddress.streetName}\n              onChange={(e) => handleManualFieldChange('streetName', e.target.value)}\n              placeholder=\"Ex: Rua das Flores\"\n              className=\"h-12 text-base\"\n            />\n          </div>\n          \n          <div className=\"grid grid-cols-2 gap-3\">\n            <div>\n              <Label htmlFor=\"manual-number\" className=\"text-sm font-medium mb-1.5 block\">{txtNumber}</Label>\n              <Input\n                id=\"manual-number\"\n                value={manualAddress.streetNumber}\n                onChange={(e) => handleManualFieldChange('streetNumber', e.target.value)}\n                placeholder=\"123\"\n                className=\"h-12 text-base\"\n              />\n            </div>\n            <div>\n              <Label htmlFor=\"manual-postal\" className=\"text-sm font-medium mb-1.5 block\">{txtPostalCode}</Label>\n              <Input\n                id=\"manual-postal\"\n                value={manualAddress.postalCode}\n                onChange={(e) => handleManualFieldChange('postalCode', e.target.value)}\n                placeholder=\"1000-001\"\n                className=\"h-12 text-base\"\n              />\n            </div>\n          </div>\n          \n          <div className=\"grid grid-cols-2 gap-3\">\n            <div>\n              <Label htmlFor=\"manual-city\" className=\"text-sm font-medium mb-1.5 block\">{txtCity}</Label>\n              <Input\n                id=\"manual-city\"\n                value={manualAddress.city}\n                onChange={(e) => handleManualFieldChange('city', e.target.value)}\n                placeholder=\"Lisboa\"\n                className=\"h-12 text-base\"\n              />\n            </div>\n            <div>\n              <Label htmlFor=\"manual-district\" className=\"text-sm font-medium mb-1.5 block\">{txtDistrictRegion}</Label>\n              <Input\n                id=\"manual-district\"\n                value={manualAddress.district}\n                onChange={(e) => handleManualFieldChange('district', e.target.value)}\n                placeholder=\"Lisboa\"\n                className=\"h-12 text-base\"\n              />\n            </div>\n          </div>\n        </div>\n      </div>\n    );\n  }\n\n  if (!scriptsLoaded) {\n    return (\n      <div className={className}>\n        <div className=\"relative\">\n          <MapPin className=\"absolute left-3 top-3 h-4 w-4 text-slate-400 z-10\" />\n          <Input\n            disabled\n            placeholder={txtLoadingGoogleMaps}\n            className={compact ? \"pl-10 bg-slate-50 h-8 text-xs\" : \"pl-10 bg-slate-50\"}\n          />\n        </div>\n      </div>\n    );\n  }\n\n  if (compact) {\n    return (\n      <div className={`space-y-2 ${className}`}>\n        <div className=\"flex gap-2\">\n          <div className=\"relative flex-1\">\n            <Search className=\"absolute left-2.5 top-1/2 -translate-y-1/2 h-3.5 w-3.5 text-blue-500 z-10 pointer-events-none\" />\n            <Autocomplete\n              apiKey={import.meta.env.VITE_GOOGLE_MAPS_API_KEY}\n              onPlaceSelected={handlePlaceSelected}\n              options={{\n                types: ['address'],\n                componentRestrictions: getComponentRestrictions(),\n                fields: ['address_components', 'geometry', 'formatted_address', 'place_id']\n              }}\n              placeholder={placeholder}\n              className=\"flex h-8 w-full rounded-md border border-blue-200 bg-white px-2 py-1 pl-8 text-xs ring-offset-background placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-blue-400 focus-visible:ring-offset-1\"\n            />\n          </div>\n          <button\n            type=\"button\"\n            onClick={handleUseCurrentLocation}\n            disabled={isGettingLocation}\n            className=\"flex items-center gap-1.5 px-2.5 h-8 text-xs font-medium text-blue-600 bg-blue-50 hover:bg-blue-100 rounded-md border border-blue-200 transition-colors disabled:opacity-50 whitespace-nowrap\"\n          >\n            {isGettingLocation ? (\n              <Loader2 className=\"h-3.5 w-3.5 animate-spin\" />\n            ) : (\n              <MapPin className=\"h-3.5 w-3.5\" />\n            )}\n            <span className=\"hidden sm:inline\">{isGettingLocation ? txtGettingLocation : txtUseMyLocation}</span>\n          </button>\n        </div>\n        {error && (\n          <p className=\"text-xs text-red-600 flex items-center gap-1\">\n            <AlertCircle className=\"w-3 h-3\" />\n            {error}\n          </p>\n        )}\n      </div>\n    );\n  }\n\n  return (\n    <div className={className}>\n      <Label htmlFor=\"address-autocomplete\" className=\"mb-2 block\">\n        {txtSearchAddressOptional}\n      </Label>\n      <div className=\"flex gap-2 mb-2\">\n        <div className=\"relative flex-1\">\n          <MapPin className=\"absolute left-3 top-3 h-4 w-4 text-slate-400 z-10\" />\n          <Autocomplete\n            apiKey={import.meta.env.VITE_GOOGLE_MAPS_API_KEY}\n            onPlaceSelected={handlePlaceSelected}\n            options={{\n              types: ['address'],\n              componentRestrictions: getComponentRestrictions(),\n              fields: ['address_components', 'geometry', 'formatted_address', 'place_id']\n            }}\n            placeholder={placeholder}\n            className={`flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 pl-10 text-sm ring-offset-background file:border-0 file:bg-transparent file:text-sm file:font-medium placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 ${error ? 'border-red-500' : ''}`}\n          />\n        </div>\n        <button\n          type=\"button\"\n          onClick={handleUseCurrentLocation}\n          disabled={isGettingLocation}\n          className=\"flex items-center gap-2 px-4 h-10 text-sm font-medium text-blue-600 bg-blue-50 hover:bg-blue-100 rounded-md border border-blue-200 transition-colors disabled:opacity-50\"\n        >\n          {isGettingLocation ? (\n            <Loader2 className=\"h-4 w-4 animate-spin\" />\n          ) : (\n            <MapPin className=\"h-4 w-4\" />\n          )}\n          {isGettingLocation ? txtGettingLocation : txtUseMyLocation}\n        </button>\n      </div>\n      {error && (\n        <p className=\"text-sm text-red-600 mt-1 flex items-center gap-1\">\n          <AlertCircle className=\"w-3 h-3\" />\n          {error}\n        </p>\n      )}\n      <p className=\"text-xs text-slate-500 mt-1\">\n        {txtAutoFillHint}\n      </p>\n    </div>\n  );\n}\n\nfunction extractAddressComponents(components) {\n  const data = {\n    streetNumber: '',\n    streetName: '',\n    city: '',\n    district: '',\n    postalCode: '',\n    country: ''\n  };\n\n  components.forEach(component => {\n    const types = component.types;\n    const longName = component.long_name;\n    const shortName = component.short_name;\n\n    if (types.includes('street_number')) {\n      data.streetNumber = longName;\n    }\n\n    if (types.includes('route')) {\n      data.streetName = longName;\n    }\n\n    if (types.includes('locality')) {\n      data.city = longName;\n    } else if (types.includes('postal_town') && !data.city) {\n      data.city = longName;\n    } else if (types.includes('administrative_area_level_2') && !data.city) {\n      data.city = longName;\n    }\n\n    if (types.includes('administrative_area_level_1')) {\n      data.district = longName;\n    }\n\n    if (types.includes('postal_code')) {\n      data.postalCode = longName;\n    }\n\n    if (types.includes('country')) {\n      data.country = shortName;\n    }\n  });\n\n  return data;\n}\n\nexport default AddressAutocomplete;\n","path":null,"size_bytes":28776,"size_tokens":null},"src/pages/Support.jsx":{"content":"import React from \"react\";\nimport { SupportContent } from \"@/components/support/SupportContent\";\nimport { useAutoTranslate } from '@/hooks/useTranslate';\n\nexport default function SupportPage() {\n  const txtSupport = useAutoTranslate('Suporte', 'pt');\n  const txtHereToHelp = useAutoTranslate('Estamos aqui para ajudar', 'pt');\n\n  return (\n    <div className=\"bg-gradient-to-br from-slate-50 via-blue-50 to-sky-50\">\n      <div className=\"max-w-4xl mx-auto px-3 md:px-6 py-4 md:py-6 pb-6 md:pb-8\">\n        <div className=\"mb-6 md:mb-8\">\n          <h1 className=\"text-2xl md:text-4xl font-bold text-slate-900 mb-2\">\n            {txtSupport}\n          </h1>\n          <p className=\"text-sm md:text-xl text-slate-600\">\n            {txtHereToHelp}\n          </p>\n        </div>\n\n        <SupportContent />\n      </div>\n    </div>\n  );\n}\n","path":null,"size_bytes":831,"size_tokens":null},"src/components/navigation/MobileBottomNav.jsx":{"content":"import React from 'react';\nimport { useLocation, useNavigate } from 'react-router-dom';\nimport { Home, LayoutDashboard, Clock, Calendar, Building2, User, MessageSquare } from 'lucide-react';\nimport { createPageUrl } from '@/utils';\n\nexport function MobileBottomNav({ isBusinessMode = false, user, isRedirecting = false }) {\n  const location = useLocation();\n  const navigate = useNavigate();\n  const [isNavigating, setIsNavigating] = React.useState(false);\n  \n  const currentPath = location.pathname;\n  \n  const isActive = (paths) => {\n    return paths.some(path => {\n      const normalizedPath = currentPath.toLowerCase();\n      const normalizedTarget = path.toLowerCase();\n      \n      // Exact match\n      if (normalizedPath === normalizedTarget) {\n        return true;\n      }\n      \n      // For paths with \"/\", use startsWith to avoid false positives\n      // e.g., \"/support\" should not match \"/business-support\"\n      if (normalizedTarget.startsWith('/')) {\n        return normalizedPath === normalizedTarget || normalizedPath.startsWith(normalizedTarget + '/');\n      }\n      \n      // For other paths, check if it's part of the current path\n      return normalizedPath.includes('/' + normalizedTarget);\n    });\n  };\n  \n  const navItems = isBusinessMode ? [\n    {\n      icon: Home,\n      label: 'Home',\n      path: createPageUrl('BusinessHome'),\n      activePaths: ['business-home', 'businesshome']\n    },\n    {\n      icon: LayoutDashboard,\n      label: 'Painel',\n      path: createPageUrl('BusinessDashboard'),\n      activePaths: ['business-dashboard', 'businessdashboard']\n    },\n    {\n      icon: Clock,\n      label: 'Senhas',\n      path: createPageUrl('BusinessQueues'),\n      activePaths: ['business-queues', 'businessqueues']\n    },\n    {\n      icon: Calendar,\n      label: 'Marcações',\n      path: createPageUrl('BusinessServices'),\n      activePaths: ['business-services', 'businessservices']\n    },\n    {\n      icon: Building2,\n      label: 'Configurações',\n      path: createPageUrl('BusinessSettings'),\n      activePaths: ['business-settings', 'businesssettings']\n    },\n    {\n      icon: User,\n      label: 'Perfil',\n      path: createPageUrl('Profile'),\n      activePaths: ['/profile', '/perfil']\n    },\n    {\n      icon: MessageSquare,\n      label: 'Suporte',\n      path: createPageUrl('BusinessSupport'),\n      activePaths: ['/business-support', '/businesssupport']\n    }\n  ] : [\n    {\n      icon: Home,\n      label: 'Home',\n      path: createPageUrl('Home'),\n      activePaths: ['/home']\n    },\n    {\n      icon: User,\n      label: 'Portal',\n      path: createPageUrl('CustomerPortal'),\n      activePaths: ['customer-portal', 'customerportal']\n    },\n    {\n      icon: Building2,\n      label: 'Empresas',\n      path: createPageUrl('Businesses'),\n      activePaths: ['businesses', 'empresas']\n    },\n    {\n      icon: User,\n      label: 'Perfil',\n      path: createPageUrl('Profile'),\n      activePaths: ['/profile', '/perfil']\n    },\n    {\n      icon: MessageSquare,\n      label: 'Suporte',\n      path: createPageUrl('Support'),\n      activePaths: ['/support', '/suporte']\n    }\n  ];\n\n  const handleNavigation = (path) => {\n    // 🛡️ PROTEÇÃO SAFARI iOS: Prevenir navegação durante redirects ou navegação em progresso\n    if (path === '#' || isNavigating || isRedirecting) {\n      console.log('⚠️ MobileBottomNav: Navegação bloqueada', { \n        isNavigating, \n        isRedirecting,\n        reason: isRedirecting ? 'Layout está redirecionando' : 'Navegação em progresso'\n      });\n      return;\n    }\n    \n    console.log('📱 MobileBottomNav: Navegando para', path);\n    setIsNavigating(true);\n    \n    // Resetar flag após navegação completar\n    setTimeout(() => setIsNavigating(false), 1000);\n    \n    navigate(path);\n  };\n\n  return (\n    <nav \n      className=\"mobile-bottom-nav fixed bottom-0 left-0 right-0 z-50 bg-white border-t border-gray-200 lg:hidden\"\n      style={{ \n        paddingBottom: 'calc(env(safe-area-inset-bottom) + 8px)',\n        marginBottom: '4px',\n        boxShadow: '0 -2px 10px rgba(0, 0, 0, 0.08)'\n      }}\n    >\n      <div className=\"flex items-center justify-around h-[60px] px-2\">\n        {navItems.map((item, index) => {\n          const Icon = item.icon;\n          const active = isActive(item.activePaths);\n          \n          return (\n            <button\n              key={index}\n              onClick={() => handleNavigation(item.path)}\n              className=\"flex items-center justify-center flex-1 h-full min-w-[44px] min-h-[44px] transition-colors focus:outline-none\"\n              aria-label={item.label}\n            >\n              <Icon \n                className={`w-6 h-6 transition-all ${\n                  active \n                    ? isBusinessMode \n                      ? 'text-indigo-600 stroke-[2.5]' \n                      : 'text-sky-600 stroke-[2.5]'\n                    : 'text-gray-400 stroke-[1.5]'\n                }`}\n              />\n            </button>\n          );\n        })}\n      </div>\n    </nav>\n  );\n}\n","path":null,"size_bytes":5032,"size_tokens":null},"src/constants/stripeCountries.js":{"content":"export const STRIPE_SUPPORTED_COUNTRIES = [\n  { code: 'PT', name: 'Portugal', flag: '🇵🇹', currency: 'EUR', defaultLanguage: 'pt' },\n  { code: 'ES', name: 'Espanha', flag: '🇪🇸', currency: 'EUR', defaultLanguage: 'es' },\n  { code: 'FR', name: 'França', flag: '🇫🇷', currency: 'EUR', defaultLanguage: 'fr' },\n  { code: 'GB', name: 'Reino Unido', flag: '🇬🇧', currency: 'GBP', defaultLanguage: 'en' },\n  { code: 'DE', name: 'Alemanha', flag: '🇩🇪', currency: 'EUR', defaultLanguage: 'de' },\n  { code: 'IT', name: 'Itália', flag: '🇮🇹', currency: 'EUR', defaultLanguage: 'it' },\n  { code: 'NL', name: 'Holanda', flag: '🇳🇱', currency: 'EUR', defaultLanguage: 'nl' },\n  { code: 'BE', name: 'Bélgica', flag: '🇧🇪', currency: 'EUR', defaultLanguage: 'nl' },\n  { code: 'CH', name: 'Suíça', flag: '🇨🇭', currency: 'CHF', defaultLanguage: 'de' },\n  { code: 'AT', name: 'Áustria', flag: '🇦🇹', currency: 'EUR', defaultLanguage: 'de' },\n  { code: 'LU', name: 'Luxemburgo', flag: '🇱🇺', currency: 'EUR', defaultLanguage: 'fr' },\n  { code: 'IE', name: 'Irlanda', flag: '🇮🇪', currency: 'EUR', defaultLanguage: 'en' },\n  { code: 'SE', name: 'Suécia', flag: '🇸🇪', currency: 'SEK', defaultLanguage: 'sv' },\n  { code: 'NO', name: 'Noruega', flag: '🇳🇴', currency: 'NOK', defaultLanguage: 'no' },\n  { code: 'DK', name: 'Dinamarca', flag: '🇩🇰', currency: 'DKK', defaultLanguage: 'da' },\n  { code: 'FI', name: 'Finlândia', flag: '🇫🇮', currency: 'EUR', defaultLanguage: 'fi' },\n  { code: 'PL', name: 'Polónia', flag: '🇵🇱', currency: 'PLN', defaultLanguage: 'pl' },\n  { code: 'CZ', name: 'República Checa', flag: '🇨🇿', currency: 'CZK', defaultLanguage: 'cs' },\n  { code: 'GR', name: 'Grécia', flag: '🇬🇷', currency: 'EUR', defaultLanguage: 'el' },\n  { code: 'RO', name: 'Roménia', flag: '🇷🇴', currency: 'RON', defaultLanguage: 'ro' },\n  { code: 'HU', name: 'Hungria', flag: '🇭🇺', currency: 'HUF', defaultLanguage: 'hu' },\n  { code: 'BG', name: 'Bulgária', flag: '🇧🇬', currency: 'BGN', defaultLanguage: 'bg' },\n  { code: 'HR', name: 'Croácia', flag: '🇭🇷', currency: 'EUR', defaultLanguage: 'hr' },\n  { code: 'CY', name: 'Chipre', flag: '🇨🇾', currency: 'EUR', defaultLanguage: 'el' },\n  { code: 'EE', name: 'Estónia', flag: '🇪🇪', currency: 'EUR', defaultLanguage: 'en' },\n  { code: 'LV', name: 'Letónia', flag: '🇱🇻', currency: 'EUR', defaultLanguage: 'en' },\n  { code: 'LT', name: 'Lituânia', flag: '🇱🇹', currency: 'EUR', defaultLanguage: 'en' },\n  { code: 'MT', name: 'Malta', flag: '🇲🇹', currency: 'EUR', defaultLanguage: 'en' },\n  { code: 'SK', name: 'Eslováquia', flag: '🇸🇰', currency: 'EUR', defaultLanguage: 'sk' },\n  { code: 'SI', name: 'Eslovénia', flag: '🇸🇮', currency: 'EUR', defaultLanguage: 'sl' },\n  { code: 'LI', name: 'Liechtenstein', flag: '🇱🇮', currency: 'CHF', defaultLanguage: 'de' },\n  { code: 'IS', name: 'Islândia', flag: '🇮🇸', currency: 'ISK', defaultLanguage: 'is' },\n  { code: 'US', name: 'Estados Unidos', flag: '🇺🇸', currency: 'USD', defaultLanguage: 'en' },\n  { code: 'CA', name: 'Canadá', flag: '🇨🇦', currency: 'CAD', defaultLanguage: 'en' },\n  { code: 'MX', name: 'México', flag: '🇲🇽', currency: 'MXN', defaultLanguage: 'es' },\n  { code: 'AU', name: 'Austrália', flag: '🇦🇺', currency: 'AUD', defaultLanguage: 'en' },\n  { code: 'NZ', name: 'Nova Zelândia', flag: '🇳🇿', currency: 'NZD', defaultLanguage: 'en' },\n  { code: 'SG', name: 'Singapura', flag: '🇸🇬', currency: 'SGD', defaultLanguage: 'en' },\n  { code: 'HK', name: 'Hong Kong', flag: '🇭🇰', currency: 'HKD', defaultLanguage: 'en' },\n  { code: 'JP', name: 'Japão', flag: '🇯🇵', currency: 'JPY', defaultLanguage: 'ja' },\n  { code: 'MY', name: 'Malásia', flag: '🇲🇾', currency: 'MYR', defaultLanguage: 'en' },\n  { code: 'TH', name: 'Tailândia', flag: '🇹🇭', currency: 'THB', defaultLanguage: 'th' },\n  { code: 'IN', name: 'Índia', flag: '🇮🇳', currency: 'INR', defaultLanguage: 'en' },\n  { code: 'AE', name: 'Emirados Árabes Unidos', flag: '🇦🇪', currency: 'AED', defaultLanguage: 'en' },\n  { code: 'BR', name: 'Brasil', flag: '🇧🇷', currency: 'BRL', defaultLanguage: 'pt' },\n  { code: 'ZA', name: 'África do Sul', flag: '🇿🇦', currency: 'ZAR', defaultLanguage: 'en' }\n];\n\nexport const SUPPORTED_COUNTRY_CODES = STRIPE_SUPPORTED_COUNTRIES.map(c => c.code);\n\nexport const isCountrySupported = (countryCode) => {\n  return SUPPORTED_COUNTRY_CODES.includes(countryCode?.toUpperCase());\n};\n\nexport const getCountryData = (countryCode) => {\n  return STRIPE_SUPPORTED_COUNTRIES.find(c => c.code === countryCode?.toUpperCase());\n};\n","path":null,"size_bytes":4767,"size_tokens":null},"src/utils/queueReset.js":{"content":"import { base44 } from \"@/api/base44Client\";\n\n/**\n * Verifica se a fila precisa ser resetada para um novo dia\n * e reseta os contadores se necessário\n * @param {Object} queue - A fila para verificar\n * @returns {Object} - A fila atualizada (ou original se não precisar reset)\n */\nexport async function checkAndResetQueueForNewDay(queue) {\n  if (!queue) return queue;\n\n  const today = new Date().toISOString().split('T')[0]; // Formato: YYYY-MM-DD\n  const lastResetDate = queue.last_reset_date;\n\n  // Se já foi resetada hoje, não fazer nada\n  if (lastResetDate === today) {\n    return queue;\n  }\n\n  // Resetar contadores para começar do zero num novo dia\n  console.log(`🔄 Novo dia detectado! Resetando fila \"${queue.name}\" (última reset: ${lastResetDate || 'nunca'})`);\n  \n  const updatedQueue = await base44.entities.Queue.update(queue.id, {\n    current_number: 0,\n    last_issued_number: 0,\n    last_reset_date: today\n  });\n\n  console.log(`✅ Fila \"${queue.name}\" resetada - senhas começam do #1`);\n\n  return updatedQueue;\n}\n","path":null,"size_bytes":1037,"size_tokens":null},"src/hooks/useBusinessRole.js":{"content":"export function useBusinessRole(user) {\n  if (!user) {\n    return {\n      isOwner: false,\n      isStaff: false,\n      hasBusinessAccess: false\n    };\n  }\n\n  const isOwner = user.is_business_user === true && user.is_staff_member === false;\n  const isStaff = user.is_staff_member === true;\n  const hasBusinessAccess = user.is_business_user === true;\n\n  return {\n    isOwner,\n    isStaff,\n    hasBusinessAccess,\n    permissions: isStaff ? user.staff_permissions : null\n  };\n}\n","path":null,"size_bytes":473,"size_tokens":null},"capacitor.config.ts":{"content":"import type { CapacitorConfig } from '@capacitor/cli';\n\nconst config: CapacitorConfig = {\n  appId: 'com.afonso.qzerocerto',\n  appName: 'QZero',\n  webDir: 'dist',\n  server: {\n    androidScheme: 'https',\n    iosScheme: 'https',\n    hostname: 'app.qzero.local',\n    allowNavigation: [\n      'https://waitless-qzero.com',\n      'https://*.waitless-qzero.com',\n      'https://q-zero-afonsomarques80.replit.app',\n      'https://*.replit.dev',\n      'https://*.replit.app',\n      'https://*.stripe.com',\n      'https://js.stripe.com',\n      'https://api.stripe.com',\n      'https://maps.googleapis.com',\n      'https://*.googleapis.com',\n      'https://translation.googleapis.com'\n    ]\n  },\n  plugins: {\n    SplashScreen: {\n      launchShowDuration: 2000,\n      backgroundColor: \"#3b82f6\",\n      showSpinner: false,\n      androidScaleType: \"CENTER_CROP\",\n      splashFullScreen: true,\n      splashImmersive: true\n    },\n    CapacitorHttp: {\n      enabled: true\n    },\n    Keyboard: {\n      resizeOnFullScreen: true\n    },\n    PushNotifications: {\n      presentationOptions: [\"badge\", \"sound\", \"alert\"]\n    }\n  },\n  android: {\n    allowMixedContent: false,\n    captureInput: true,\n    webContentsDebuggingEnabled: false,\n    backgroundColor: \"#ffffff\",\n    buildOptions: {\n      keystorePath: undefined,\n      keystoreAlias: undefined\n    }\n  },\n  ios: {\n    contentInset: 'always',\n    scrollEnabled: true,\n    allowsLinkPreview: true,\n    backgroundColor: \"#ffffff\",\n    preferredContentMode: 'mobile'\n  }\n};\n\nexport default config;\n","path":null,"size_bytes":1528,"size_tokens":null},"src/contexts/UserContext.jsx":{"content":"import React, { createContext, useContext, useState, useEffect, useMemo, useCallback, useRef } from 'react';\nimport { base44 } from '@/api/base44Client';\n\nconst UserContext = createContext(null);\n\nexport function UserProvider({ children }) {\n  const [user, setUser] = useState(null);\n  const [loading, setLoading] = useState(true);\n  const [error, setError] = useState(null);\n  const [authFailed, setAuthFailed] = useState(false);\n  const isMountedRef = useRef(true);\n  const retryTimeoutIdRef = useRef(null);\n\n  const loadUserWithRetry = useCallback(async (attempt = 1, maxAttempts = 1) => {\n    if (!isMountedRef.current) {\n      console.log('⚠️ UserContext: Componente desmontado, cancelando retry');\n      return;\n    }\n\n    try {\n      console.log(`🔄 UserContext: Carregando utilizador (tentativa ${attempt}/${maxAttempts})`);\n      const userData = await base44.auth.me();\n      \n      if (isMountedRef.current) {\n        console.log('✅ UserContext: Utilizador carregado:', userData.email);\n        setUser(userData);\n        setError(null);\n        setAuthFailed(false);\n        setLoading(false);\n      }\n    } catch (err) {\n      // ✅ CRÍTICO: Se não há cookie (401), não fazer retry - aceitar que não está autenticado\n      // Isto previne 3 tentativas falhadas desnecessárias em páginas protegidas\n      if (isMountedRef.current) {\n        console.log('⚠️ UserContext: Não autenticado - utilizador precisa fazer login');\n        setUser(null);\n        setError(err);\n        setAuthFailed(true);\n        setLoading(false);\n      }\n    }\n  }, []);\n\n  useEffect(() => {\n    isMountedRef.current = true;\n    \n    // ✅ CRÍTICO: Em páginas públicas, inicializar estado mas permitir refresh() posterior\n    // Isto permite que após login bem-sucedido, refresh() possa carregar o utilizador\n    const publicPaths = ['/login', '/register', '/reset-password', '/request-password-reset', '/business-detail'];\n    const currentPath = window.location.pathname;\n    const isPublicPage = publicPaths.some(path => currentPath.startsWith(path));\n    \n    if (isPublicPage) {\n      console.log('🔓 UserContext: Página pública detectada - estado inicializado sem autenticação:', currentPath);\n      setUser(null);\n      setLoading(false);\n      setAuthFailed(false);\n      setError(null);\n      // ✅ NÃO fazer return - permitir que cleanup function seja registrada\n      return () => {\n        isMountedRef.current = false;\n        if (retryTimeoutIdRef.current) {\n          clearTimeout(retryTimeoutIdRef.current);\n        }\n      };\n    }\n    \n    // Apenas tentar carregar em páginas protegidas\n    loadUserWithRetry();\n\n    return () => {\n      isMountedRef.current = false;\n      if (retryTimeoutIdRef.current) {\n        console.log('🧹 UserContext: Limpando timeout de retry pendente');\n        clearTimeout(retryTimeoutIdRef.current);\n      }\n    };\n  }, [loadUserWithRetry]);\n\n  const refresh = useCallback(async () => {\n    console.log('🔄 UserContext: Recarga forçada - resetando estado e recarregando utilizador');\n    setLoading(true);\n    setUser(null);\n    setError(null);\n    setAuthFailed(false);\n    await loadUserWithRetry(1, 1); // ✅ Apenas 1 tentativa (sem retries desnecessários)\n  }, [loadUserWithRetry]);\n\n  const logout = async () => {\n    console.log('🚪 UserContext: Fazendo logout');\n    await base44.auth.logout();\n    setUser(null);\n    setError(null);\n    setAuthFailed(false);\n  };\n\n  // 🎯 MEMOIZAÇÃO: Prevenir re-renders infinitos quando user object muda mas dados são iguais\n  const memoizedUser = useMemo(() => user, [user?.id, user?.email]);\n\n  const value = useMemo(() => ({\n    user: memoizedUser,\n    loading,\n    error,\n    authFailed,\n    refresh,\n    logout\n  }), [memoizedUser, loading, error, authFailed]);\n\n  return <UserContext.Provider value={value}>{children}</UserContext.Provider>;\n}\n\nexport function useUser() {\n  const context = useContext(UserContext);\n  if (!context) {\n    throw new Error('useUser must be used within a UserProvider');\n  }\n  return context;\n}\n","path":null,"size_bytes":4063,"size_tokens":null},"server/middleware/logger.js":{"content":"// 🔒 SECURITY LOGGER COM WINSTON\nimport winston from 'winston';\nimport path from 'path';\nimport { fileURLToPath } from 'url';\n\nconst __filename = fileURLToPath(import.meta.url);\nconst __dirname = path.dirname(__filename);\n\nconst IS_PRODUCTION = process.env.NODE_ENV === 'production';\n\n// 📝 Configuração do Winston Logger\nconst logger = winston.createLogger({\n  level: IS_PRODUCTION ? 'info' : 'debug',\n  format: winston.format.combine(\n    winston.format.timestamp({ format: 'YYYY-MM-DD HH:mm:ss' }),\n    winston.format.errors({ stack: true }),\n    winston.format.splat(),\n    winston.format.json()\n  ),\n  defaultMeta: { service: 'qzero-api' },\n  transports: [\n    // ✅ ARQUIVO DE ERROS\n    new winston.transports.File({ \n      filename: path.join(__dirname, '../logs/error.log'), \n      level: 'error',\n      maxsize: 5242880, // 5MB\n      maxFiles: 5,\n    }),\n    \n    // ✅ ARQUIVO DE SEGURANÇA (tentativas falhadas, acessos suspeitos)\n    new winston.transports.File({ \n      filename: path.join(__dirname, '../logs/security.log'),\n      level: 'warn',\n      maxsize: 5242880,\n      maxFiles: 5,\n    }),\n    \n    // ✅ ARQUIVO GERAL\n    new winston.transports.File({ \n      filename: path.join(__dirname, '../logs/combined.log'),\n      maxsize: 10485760, // 10MB\n      maxFiles: 10,\n    }),\n  ],\n});\n\n// 🔓 DESENVOLVIMENTO: Também logar no console\nif (!IS_PRODUCTION) {\n  logger.add(new winston.transports.Console({\n    format: winston.format.combine(\n      winston.format.colorize(),\n      winston.format.simple()\n    ),\n  }));\n}\n\n// 🛡️ LOGS DE SEGURANÇA ESPECÍFICOS\n\nexport const logSecurityEvent = (event, details) => {\n  logger.warn('SECURITY_EVENT', {\n    event,\n    ...details,\n    timestamp: new Date().toISOString()\n  });\n};\n\nexport const logAuthFailure = (req, reason) => {\n  logSecurityEvent('AUTH_FAILURE', {\n    ip: req.ip,\n    path: req.path,\n    method: req.method,\n    reason,\n    userAgent: req.headers['user-agent'],\n  });\n};\n\nexport const logAuthSuccess = (req, userId, email) => {\n  logger.info('AUTH_SUCCESS', {\n    event: 'LOGIN',\n    userId,\n    email,\n    ip: req.ip,\n    userAgent: req.headers['user-agent'],\n    timestamp: new Date().toISOString()\n  });\n};\n\nexport const logSuspiciousActivity = (req, reason, details = {}) => {\n  logSecurityEvent('SUSPICIOUS_ACTIVITY', {\n    ip: req.ip,\n    path: req.path,\n    method: req.method,\n    reason,\n    ...details,\n    userAgent: req.headers['user-agent'],\n  });\n};\n\nexport const logDataAccess = (userId, resource, action) => {\n  logger.info('DATA_ACCESS', {\n    userId,\n    resource,\n    action,\n    timestamp: new Date().toISOString()\n  });\n};\n\nexport default logger;\n","path":null,"size_bytes":2667,"size_tokens":null},"server/middleware/security.js":{"content":"// 🔒 MIDDLEWARE DE SEGURANÇA CENTRALIZADO\nimport { body, param, query, validationResult } from 'express-validator';\nimport validator from 'validator';\nimport xss from 'xss';\n\n// 🛡️ SANITIZAÇÃO GLOBAL - Remove XSS de todos os inputs\nexport const sanitizeInput = (value) => {\n  if (typeof value === 'string') {\n    // Remove tags HTML perigosas\n    return xss(value, {\n      whiteList: {}, // Sem tags permitidas\n      stripIgnoreTag: true,\n      stripIgnoreTagBody: ['script', 'style']\n    });\n  }\n  return value;\n};\n\n// 🛡️ Sanitizar req.body, req.query, req.params\nexport const sanitizeMiddleware = (req, res, next) => {\n  // Sanitizar body\n  if (req.body) {\n    Object.keys(req.body).forEach(key => {\n      req.body[key] = sanitizeInput(req.body[key]);\n    });\n  }\n  \n  // Sanitizar query\n  if (req.query) {\n    Object.keys(req.query).forEach(key => {\n      req.query[key] = sanitizeInput(req.query[key]);\n    });\n  }\n  \n  // Sanitizar params\n  if (req.params) {\n    Object.keys(req.params).forEach(key => {\n      req.params[key] = sanitizeInput(req.params[key]);\n    });\n  }\n  \n  next();\n};\n\n// ✅ VALIDADORES DE EMAIL\nexport const validateEmail = [\n  body('email')\n    .trim()\n    .isEmail().withMessage('Email inválido')\n    .normalizeEmail()\n    .custom(value => {\n      if (!validator.isEmail(value)) {\n        throw new Error('Formato de email inválido');\n      }\n      return true;\n    })\n];\n\n// ✅ VALIDADORES DE PASSWORD\nexport const validatePassword = [\n  body('password')\n    .trim()\n    .isLength({ min: 6, max: 128 }).withMessage('Password deve ter entre 6 e 128 caracteres')\n];\n\n// ✅ VALIDADORES DE REGISTO\nexport const validateRegister = [\n  ...validateEmail,\n  ...validatePassword,\n  body('fullName')\n    .trim()\n    .isLength({ min: 2, max: 100 }).withMessage('Nome deve ter entre 2 e 100 caracteres')\n    .matches(/^[a-zA-Z0-9À-ÿ\\s]+$/).withMessage('Nome deve conter apenas letras, números e espaços'),\n  body('phone')\n    .optional()\n    .trim()\n    .customSanitizer(value => value ? value.replace(/[\\s\\-\\(\\)]/g, '') : value)\n    .matches(/^\\+?[0-9]{9,15}$/).withMessage('Telefone inválido'),\n  body('accountType')\n    .isIn(['pessoal', 'empresa']).withMessage('Tipo de conta inválido')\n];\n\n// ✅ VALIDADOR DE VERIFICATION CODE\nexport const validateVerificationCode = [\n  body('code')\n    .trim()\n    .isLength({ min: 6, max: 6 }).withMessage('Código deve ter 6 dígitos')\n    .isNumeric().withMessage('Código deve conter apenas números'),\n  body('challengeToken')\n    .trim()\n    .notEmpty().withMessage('Challenge token é obrigatório')\n];\n\n// ✅ VALIDADOR DE COMPANY PROFILE\nexport const validateCompanyProfile = [\n  body('companyName')\n    .trim()\n    .isLength({ min: 2, max: 200 }).withMessage('Nome da empresa deve ter entre 2 e 200 caracteres'),\n  body('companyEmail')\n    .optional()\n    .trim()\n    .isEmail().withMessage('Email da empresa inválido'),\n  body('companyPhone')\n    .optional()\n    .trim()\n    .customSanitizer(value => value ? value.replace(/[\\s\\-\\(\\)]/g, '') : value)\n    .matches(/^\\+?[0-9]{9,15}$/).withMessage('Telefone inválido')\n];\n\n// ✅ VALIDADOR DE CANCELAMENTO DE SUBSCRIÇÃO\nexport const validateCancelSubscription = [\n  body('companyProfileId')\n    .trim()\n    .notEmpty().withMessage('ID do perfil da empresa é obrigatório')\n];\n\n// ✅ VALIDADORES DE LOGIN\nexport const validateLogin = [\n  ...validateEmail,\n  body('password')\n    .trim()\n    .notEmpty().withMessage('Password é obrigatória')\n];\n\n// ✅ VALIDADOR DE REQUEST PASSWORD RESET\nexport const validateRequestPasswordReset = [\n  ...validateEmail\n];\n\n// ✅ VALIDADOR DE RESET PASSWORD\nexport const validateResetPassword = [\n  ...validateEmail,\n  body('code')\n    .trim()\n    .isLength({ min: 6, max: 6 }).withMessage('Código deve ter 6 dígitos')\n    .isNumeric().withMessage('Código deve conter apenas números'),\n  body('newPassword')\n    .trim()\n    .isLength({ min: 8 }).withMessage('Nova password deve ter pelo menos 8 caracteres')\n    .matches(/^(?=.*[a-z])(?=.*[A-Z])(?=.*\\d)/).withMessage('Nova password deve conter maiúsculas, minúsculas e números')\n];\n\n// ✅ VALIDADOR DE ID (UUID, número, ou IDs alfanuméricos com hífens/underscores)\nexport const validateId = [\n  param('id')\n    .trim()\n    .custom(value => {\n      // Aceitar UUID, número, ou IDs alfanuméricos (ex: demo-empresa-profile-001, user_123)\n      if (validator.isUUID(value) || validator.isNumeric(value) || /^[a-zA-Z0-9_-]+$/.test(value)) {\n        return true;\n      }\n      throw new Error('ID inválido');\n    })\n];\n\n// ✅ MIDDLEWARE DE VALIDAÇÃO DE ERROS\nexport const handleValidationErrors = (req, res, next) => {\n  const errors = validationResult(req);\n  \n  if (!errors.isEmpty()) {\n    const formattedErrors = errors.array().map(err => ({\n      field: err.path,\n      message: err.msg\n    }));\n    \n    return res.status(400).json({\n      error: 'Dados inválidos',\n      details: formattedErrors\n    });\n  }\n  \n  next();\n};\n\n// 🛡️ MIDDLEWARE DE ERRO GLOBAL - Esconde detalhes sensíveis\nexport const errorHandler = (err, req, res, next) => {\n  const IS_PRODUCTION = process.env.NODE_ENV === 'production';\n  \n  // 📊 Log do erro (APENAS servidor, nunca enviar ao cliente)\n  console.error('🚨 ERRO:', {\n    timestamp: new Date().toISOString(),\n    method: req.method,\n    path: req.path,\n    ip: req.ip,\n    error: err.message,\n    stack: err.stack\n  });\n  \n  // ⚠️ PRODUÇÃO: Mensagem genérica (não expor detalhes)\n  if (IS_PRODUCTION) {\n    return res.status(err.status || 500).json({\n      error: 'Ocorreu um erro no servidor. Por favor, tente novamente.'\n    });\n  }\n  \n  // 🔓 DESENVOLVIMENTO: Detalhes para debug\n  return res.status(err.status || 500).json({\n    error: err.message,\n    stack: err.stack?.split('\\n').slice(0, 5) // Apenas primeiras 5 linhas\n  });\n};\n\n// 🛡️ SAFE LOGGER - Nunca loga passwords ou dados sensíveis\nconst SENSITIVE_FIELDS = ['password', 'passwordHash', 'token', 'secret', 'apiKey', 'creditCard'];\n\nexport const safeLog = (message, data) => {\n  if (!data) {\n    console.log(message);\n    return;\n  }\n  \n  // Clone e remove campos sensíveis\n  const safeCopy = JSON.parse(JSON.stringify(data));\n  \n  const removeSensitive = (obj) => {\n    if (typeof obj !== 'object' || obj === null) return;\n    \n    Object.keys(obj).forEach(key => {\n      const lowerKey = key.toLowerCase();\n      \n      // Remover campos sensíveis\n      if (SENSITIVE_FIELDS.some(field => lowerKey.includes(field.toLowerCase()))) {\n        obj[key] = '***REDACTED***';\n      } else if (typeof obj[key] === 'object') {\n        removeSensitive(obj[key]);\n      }\n    });\n  };\n  \n  removeSensitive(safeCopy);\n  console.log(message, safeCopy);\n};\n\n// ✅ EXPORTAÇÕES\nexport default {\n  sanitizeInput,\n  sanitizeMiddleware,\n  validateEmail,\n  validatePassword,\n  validateRegister,\n  validateLogin,\n  validateId,\n  validateVerificationCode,\n  validateRequestPasswordReset,\n  validateResetPassword,\n  validateCompanyProfile,\n  validateCancelSubscription,\n  handleValidationErrors,\n  errorHandler,\n  safeLog\n};\n","path":null,"size_bytes":7086,"size_tokens":null},"src/components/settings/LanguageSelector.jsx":{"content":"import { useState } from 'react';\nimport { useTranslation } from 'react-i18next';\nimport { Globe } from 'lucide-react';\nimport { Button } from '@/components/ui/button';\nimport {\n  Select,\n  SelectContent,\n  SelectItem,\n  SelectTrigger,\n  SelectValue,\n} from '@/components/ui/select';\nimport { Card } from '@/components/ui/card';\nimport { AVAILABLE_LANGUAGES } from '@/i18n/config';\nimport { toast } from 'sonner';\nimport { useAutoTranslate } from '@/hooks/useTranslate';\nimport { safeFetch } from '@/utils/apiConfig';\n\nexport function LanguageSelector() {\n  const { i18n } = useTranslation();\n  const txtLanguage = useAutoTranslate('Idioma', 'pt');\n  const txtSelectLanguage = useAutoTranslate('Selecionar idioma', 'pt');\n  const txtCurrentLanguage = useAutoTranslate('Idioma atual', 'pt');\n  const txtLanguageChanged = useAutoTranslate('Idioma alterado com sucesso', 'pt');\n  const txtError = useAutoTranslate('Erro ao alterar idioma', 'pt');\n  \n  const [selectedLanguage, setSelectedLanguage] = useState(i18n.language);\n\n  const handleLanguageChange = async (languageCode) => {\n    try {\n      await i18n.changeLanguage(languageCode);\n      setSelectedLanguage(languageCode);\n      localStorage.setItem('qzero_language', languageCode);\n      \n      // Enviar idioma para o servidor (para emails traduzidos)\n      try {\n        await safeFetch('/api/auth/language', {\n          method: 'PATCH',\n          body: JSON.stringify({ language: languageCode })\n        });\n      } catch (serverError) {\n        // Ignorar erro se não estiver autenticado\n        console.log('Idioma guardado apenas localmente (utilizador não autenticado)');\n      }\n      \n      toast.success(txtLanguageChanged);\n      \n      setTimeout(() => {\n        window.location.reload();\n      }, 500);\n    } catch (error) {\n      console.error('Failed to change language:', error);\n      toast.error(txtError);\n    }\n  };\n\n  return (\n    <Card className=\"p-6\">\n      <div className=\"flex items-center gap-3 mb-4\">\n        <Globe className=\"w-5 h-5 text-primary\" />\n        <h3 className=\"text-lg font-semibold\">{txtLanguage}</h3>\n      </div>\n      \n      <div className=\"space-y-4\">\n        <div>\n          <label className=\"text-sm text-gray-600 mb-2 block\">\n            {txtSelectLanguage}\n          </label>\n          <Select value={selectedLanguage} onValueChange={handleLanguageChange}>\n            <SelectTrigger className=\"w-full\">\n              <SelectValue placeholder={txtSelectLanguage} />\n            </SelectTrigger>\n            <SelectContent>\n              {AVAILABLE_LANGUAGES.map((lang) => (\n                <SelectItem key={lang.code} value={lang.code}>\n                  <div className=\"flex items-center gap-2\">\n                    <span className=\"text-xl\">{lang.flag}</span>\n                    <span>{lang.name}</span>\n                  </div>\n                </SelectItem>\n              ))}\n            </SelectContent>\n          </Select>\n        </div>\n\n        <div className=\"text-sm text-gray-500\">\n          {txtCurrentLanguage}: {AVAILABLE_LANGUAGES.find(l => l.code === selectedLanguage)?.name}\n        </div>\n      </div>\n    </Card>\n  );\n}\n","path":null,"size_bytes":3147,"size_tokens":null},"src/utils/getUserCountry.js":{"content":"import { isCountrySupported } from '@/constants/stripeCountries';\n\nexport async function getUserCountry() {\n  try {\n    const position = await new Promise((resolve, reject) => {\n      navigator.geolocation.getCurrentPosition(resolve, reject, {\n        timeout: 5000,\n        enableHighAccuracy: false\n      });\n    });\n\n    const { latitude, longitude } = position.coords;\n    \n    const response = await fetch(\n      `https://nominatim.openstreetmap.org/reverse?format=json&lat=${latitude}&lon=${longitude}&accept-language=en`\n    );\n    \n    if (!response.ok) {\n      throw new Error('Failed to fetch country from coordinates');\n    }\n    \n    const data = await response.json();\n    const countryCode = data.address?.country_code?.toUpperCase();\n    \n    if (countryCode) {\n      return {\n        code: countryCode,\n        isSupported: isCountrySupported(countryCode),\n        latitude,\n        longitude\n      };\n    }\n    \n    throw new Error('No country code in geocoding response');\n  } catch (error) {\n    console.error('getUserCountry error:', error);\n    \n    const storedCountry = localStorage.getItem('user_country');\n    if (storedCountry) {\n      return {\n        code: storedCountry,\n        isSupported: isCountrySupported(storedCountry),\n        fromCache: true\n      };\n    }\n    \n    return {\n      code: 'PT',\n      isSupported: true,\n      fromFallback: true\n    };\n  }\n}\n\nexport async function getUserCountryWithCache() {\n  const cached = localStorage.getItem('user_country');\n  const cacheTime = localStorage.getItem('user_country_timestamp');\n  \n  const ONE_DAY = 24 * 60 * 60 * 1000;\n  if (cached && cacheTime && Date.now() - parseInt(cacheTime) < ONE_DAY) {\n    return {\n      code: cached,\n      isSupported: isCountrySupported(cached),\n      fromCache: true\n    };\n  }\n  \n  const result = await getUserCountry();\n  \n  if (result.code && !result.fromCache) {\n    localStorage.setItem('user_country', result.code);\n    localStorage.setItem('user_country_timestamp', Date.now().toString());\n  }\n  \n  return result;\n}\n","path":null,"size_bytes":2043,"size_tokens":null},"src/i18n/config.js":{"content":"import i18n from 'i18next';\nimport { initReactI18next } from 'react-i18next';\nimport LanguageDetector from 'i18next-browser-languagedetector';\n\nimport ptTranslation from './locales/pt/translation.json';\nimport enTranslation from './locales/en/translation.json';\nimport esTranslation from './locales/es/translation.json';\nimport frTranslation from './locales/fr/translation.json';\nimport deTranslation from './locales/de/translation.json';\nimport itTranslation from './locales/it/translation.json';\nimport nlTranslation from './locales/nl/translation.json';\nimport plTranslation from './locales/pl/translation.json';\nimport svTranslation from './locales/sv/translation.json';\nimport daTranslation from './locales/da/translation.json';\nimport noTranslation from './locales/no/translation.json';\nimport fiTranslation from './locales/fi/translation.json';\nimport csTranslation from './locales/cs/translation.json';\nimport elTranslation from './locales/el/translation.json';\nimport roTranslation from './locales/ro/translation.json';\nimport huTranslation from './locales/hu/translation.json';\nimport bgTranslation from './locales/bg/translation.json';\nimport hrTranslation from './locales/hr/translation.json';\nimport skTranslation from './locales/sk/translation.json';\nimport slTranslation from './locales/sl/translation.json';\nimport isTranslation from './locales/is/translation.json';\nimport jaTranslation from './locales/ja/translation.json';\nimport thTranslation from './locales/th/translation.json';\n\nconst resources = {\n  pt: { translation: ptTranslation },\n  en: { translation: enTranslation },\n  es: { translation: esTranslation },\n  fr: { translation: frTranslation },\n  de: { translation: deTranslation },\n  it: { translation: itTranslation },\n  nl: { translation: nlTranslation },\n  pl: { translation: plTranslation },\n  sv: { translation: svTranslation },\n  da: { translation: daTranslation },\n  no: { translation: noTranslation },\n  fi: { translation: fiTranslation },\n  cs: { translation: csTranslation },\n  el: { translation: elTranslation },\n  ro: { translation: roTranslation },\n  hu: { translation: huTranslation },\n  bg: { translation: bgTranslation },\n  hr: { translation: hrTranslation },\n  sk: { translation: skTranslation },\n  sl: { translation: slTranslation },\n  is: { translation: isTranslation },\n  ja: { translation: jaTranslation },\n  th: { translation: thTranslation }\n};\n\ni18n\n  .use(LanguageDetector)\n  .use(initReactI18next)\n  .init({\n    resources,\n    fallbackLng: 'pt',\n    supportedLngs: ['pt', 'en', 'es', 'fr', 'de', 'it', 'nl', 'pl', 'sv', 'da', 'no', 'fi', 'cs', 'el', 'ro', 'hu', 'bg', 'hr', 'sk', 'sl', 'is', 'ja', 'th'],\n    detection: {\n      // ORDEM: querystring permite override manual (?lng=pt)\n      // localStorage (escolhas manuais) tem prioridade sobre navigator\n      // Navigator (idioma do sistema) é fallback final\n      order: ['querystring', 'localStorage', 'navigator', 'htmlTag'],\n      caches: ['localStorage'],\n      lookupLocalStorage: 'qzero_language',\n      lookupQuerystring: 'lng',\n      convertDetectedLanguage: (lng) => {\n        // Normalizar códigos de idioma (ex: en-US -> en, pt-BR -> pt)\n        if (!lng) return 'pt';\n        const normalized = lng.split('-')[0].toLowerCase();\n        const supported = ['pt', 'en', 'es', 'fr', 'de', 'it', 'nl', 'pl', 'sv', 'da', 'no', 'fi', 'cs', 'el', 'ro', 'hu', 'bg', 'hr', 'sk', 'sl', 'is', 'ja', 'th'];\n        return supported.includes(normalized) ? normalized : 'pt';\n      }\n    },\n    interpolation: {\n      escapeValue: false\n    },\n    react: {\n      useSuspense: false\n    }\n  });\n\nexport default i18n;\n\nexport const changeLanguage = (lng) => {\n  return i18n.changeLanguage(lng);\n};\n\nexport const getCurrentLanguage = () => {\n  return i18n.language;\n};\n\nexport const AVAILABLE_LANGUAGES = [\n  { code: 'en', name: 'English', flag: '🇬🇧' },\n  { code: 'pt', name: 'Português', flag: '🇵🇹' },\n  { code: 'es', name: 'Español', flag: '🇪🇸' },\n  { code: 'fr', name: 'Français', flag: '🇫🇷' },\n  { code: 'de', name: 'Deutsch', flag: '🇩🇪' },\n  { code: 'it', name: 'Italiano', flag: '🇮🇹' },\n  { code: 'nl', name: 'Nederlands', flag: '🇳🇱' },\n  { code: 'pl', name: 'Polski', flag: '🇵🇱' },\n  { code: 'sv', name: 'Svenska', flag: '🇸🇪' },\n  { code: 'da', name: 'Dansk', flag: '🇩🇰' },\n  { code: 'no', name: 'Norsk', flag: '🇳🇴' },\n  { code: 'fi', name: 'Suomi', flag: '🇫🇮' },\n  { code: 'cs', name: 'Čeština', flag: '🇨🇿' },\n  { code: 'el', name: 'Ελληνικά', flag: '🇬🇷' },\n  { code: 'ro', name: 'Română', flag: '🇷🇴' },\n  { code: 'hu', name: 'Magyar', flag: '🇭🇺' },\n  { code: 'bg', name: 'Български', flag: '🇧🇬' },\n  { code: 'hr', name: 'Hrvatski', flag: '🇭🇷' },\n  { code: 'sk', name: 'Slovenčina', flag: '🇸🇰' },\n  { code: 'sl', name: 'Slovenščina', flag: '🇸🇮' },\n  { code: 'is', name: 'Íslenska', flag: '🇮🇸' },\n  { code: 'ja', name: '日本語', flag: '🇯🇵' },\n  { code: 'th', name: 'ไทย', flag: '🇹🇭' }\n];\n","path":null,"size_bytes":5076,"size_tokens":null},"src/pages/ResetPassword.jsx":{"content":"import { useState, useEffect } from 'react';\nimport { Link, useLocation, useNavigate } from 'react-router-dom';\nimport { Button } from '@/components/ui/button';\nimport { Input } from '@/components/ui/input';\nimport { Card } from '@/components/ui/card';\nimport { ArrowLeft, Lock, Eye, EyeOff } from 'lucide-react';\nimport { useAutoTranslate } from '@/hooks/useTranslate';\nimport { safeFetch } from '@/utils/apiConfig';\n\nexport default function ResetPassword() {\n  // Traduções\n  const txtPasswordsMismatch = useAutoTranslate('As senhas não coincidem', 'pt');\n  const txtPasswordMin8 = useAutoTranslate('A senha deve ter pelo menos 8 caracteres', 'pt');\n  const txtPasswordRequirements = useAutoTranslate('A senha deve conter maiúsculas, minúsculas e números', 'pt');\n  const txtErrorReset = useAutoTranslate('Erro ao resetar senha', 'pt');\n  const txtSuccessMessage = useAutoTranslate('Senha alterada com sucesso! Faça login com a nova senha.', 'pt');\n  const txtResetPassword = useAutoTranslate('Redefinir Senha', 'pt');\n  const txtEnterCodeAndPassword = useAutoTranslate('Insira o código que recebeu por email e defina uma nova senha', 'pt');\n  const txtEmail = useAutoTranslate('Email', 'pt');\n  const txtEmailPlaceholder = useAutoTranslate('seu@email.com', 'pt');\n  const txtRecoveryCode = useAutoTranslate('Código de Recuperação', 'pt');\n  const txtCodePlaceholder = useAutoTranslate('123456', 'pt');\n  const txtCodeSent = useAutoTranslate('Código de 6 dígitos enviado para o seu email', 'pt');\n  const txtNewPassword = useAutoTranslate('Nova Senha', 'pt');\n  const txtMin8Chars = useAutoTranslate('Mínimo 8 caracteres', 'pt');\n  const txtMustContain = useAutoTranslate('Deve conter maiúsculas, minúsculas e números', 'pt');\n  const txtConfirmPassword = useAutoTranslate('Confirmar Nova Senha', 'pt');\n  const txtRepeatPassword = useAutoTranslate('Repita a nova senha', 'pt');\n  const txtProcessing = useAutoTranslate('A processar...', 'pt');\n  const txtResendCode = useAutoTranslate('Não recebeu o código? Reenviar', 'pt');\n  const txtBackToLogin = useAutoTranslate('Voltar ao login', 'pt');\n\n  const location = useLocation();\n  const navigate = useNavigate();\n  \n  const [email, setEmail] = useState(location.state?.email || '');\n  const [code, setCode] = useState('');\n  const [newPassword, setNewPassword] = useState('');\n  const [confirmPassword, setConfirmPassword] = useState('');\n  const [showPassword, setShowPassword] = useState(false);\n  const [loading, setLoading] = useState(false);\n  const [error, setError] = useState('');\n  const [success, setSuccess] = useState('');\n\n  useEffect(() => {\n    if (location.state?.message) {\n      setSuccess(location.state.message);\n    }\n  }, [location.state]);\n\n  const handleSubmit = async (e) => {\n    e.preventDefault();\n    setError('');\n    setSuccess('');\n\n    if (newPassword !== confirmPassword) {\n      setError(txtPasswordsMismatch);\n      return;\n    }\n\n    if (newPassword.length < 8) {\n      setError(txtPasswordMin8);\n      return;\n    }\n\n    if (!/(?=.*[a-z])(?=.*[A-Z])(?=.*\\d)/.test(newPassword)) {\n      setError(txtPasswordRequirements);\n      return;\n    }\n\n    setLoading(true);\n\n    try {\n      const { response, data } = await safeFetch('/api/auth/reset-password', {\n        method: 'POST',\n        body: JSON.stringify({ email, code, newPassword }),\n      });\n\n      if (!response.ok) {\n        throw new Error(data?.error || txtErrorReset);\n      }\n\n      setSuccess(data.message);\n      \n      // Redirecionar para login após 2 segundos\n      setTimeout(() => {\n        navigate('/login', {\n          state: { message: txtSuccessMessage }\n        });\n      }, 2000);\n    } catch (err) {\n      setError(err.message);\n    } finally {\n      setLoading(false);\n    }\n  };\n\n  return (\n    <div className=\"min-h-screen bg-gradient-to-b from-blue-50 to-white flex items-center justify-center px-4 py-8\">\n      <Card className=\"w-full max-w-md p-4 sm:p-6 md:p-8\">\n        <div className=\"text-center mb-6 sm:mb-8\">\n          <div className=\"inline-flex items-center justify-center w-14 h-14 sm:w-16 sm:h-16 bg-blue-100 rounded-full mb-3 sm:mb-4\">\n            <Lock className=\"w-7 h-7 sm:w-8 sm:h-8 text-blue-600\" />\n          </div>\n          <h1 className=\"text-xl sm:text-2xl font-bold text-gray-900 mb-2\">\n            {txtResetPassword}\n          </h1>\n          <p className=\"text-sm sm:text-base text-gray-600\">\n            {txtEnterCodeAndPassword}\n          </p>\n        </div>\n\n        <form onSubmit={handleSubmit} className=\"space-y-4\" noValidate>\n          <div>\n            <label htmlFor=\"email\" className=\"block text-sm font-medium text-gray-700 mb-2\">\n              {txtEmail}\n            </label>\n            <Input\n              id=\"email\"\n              type=\"text\"\n              inputMode=\"email\"\n              value={email}\n              onChange={(e) => setEmail(e.target.value)}\n              placeholder={txtEmailPlaceholder}\n              disabled={loading}\n              autoComplete=\"username\"\n            />\n          </div>\n\n          <div>\n            <label htmlFor=\"code\" className=\"block text-sm font-medium text-gray-700 mb-2\">\n              {txtRecoveryCode}\n            </label>\n            <Input\n              id=\"code\"\n              type=\"text\"\n              inputMode=\"numeric\"\n              value={code}\n              onChange={(e) => setCode(e.target.value.replace(/\\D/g, '').slice(0, 6))}\n              placeholder={txtCodePlaceholder}\n              disabled={loading}\n              maxLength={6}\n              className=\"text-center text-2xl letter-spacing-[0.5em] font-mono\"\n              autoComplete=\"one-time-code\"\n            />\n            <p className=\"text-xs text-gray-500 mt-1\">\n              {txtCodeSent}\n            </p>\n          </div>\n\n          <div>\n            <label htmlFor=\"newPassword\" className=\"block text-sm font-medium text-gray-700 mb-2\">\n              {txtNewPassword}\n            </label>\n            <div className=\"relative\">\n              <Input\n                id=\"newPassword\"\n                type={showPassword ? 'text' : 'password'}\n                value={newPassword}\n                onChange={(e) => setNewPassword(e.target.value)}\n                placeholder={txtMin8Chars}\n                disabled={loading}\n              />\n              <button\n                type=\"button\"\n                onClick={() => setShowPassword(!showPassword)}\n                className=\"absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 hover:text-gray-600\"\n              >\n                {showPassword ? <EyeOff size={20} /> : <Eye size={20} />}\n              </button>\n            </div>\n            <p className=\"text-xs text-gray-500 mt-1\">\n              {txtMustContain}\n            </p>\n          </div>\n\n          <div>\n            <label htmlFor=\"confirmPassword\" className=\"block text-sm font-medium text-gray-700 mb-2\">\n              {txtConfirmPassword}\n            </label>\n            <Input\n              id=\"confirmPassword\"\n              type={showPassword ? 'text' : 'password'}\n              value={confirmPassword}\n              onChange={(e) => setConfirmPassword(e.target.value)}\n              placeholder={txtRepeatPassword}\n              disabled={loading}\n            />\n          </div>\n\n          {error && (\n            <div className=\"bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded\">\n              {error}\n            </div>\n          )}\n\n          {success && (\n            <div className=\"bg-green-50 border border-green-200 text-green-700 px-4 py-3 rounded\">\n              {success}\n            </div>\n          )}\n\n          <Button\n            type=\"submit\"\n            className=\"w-full\"\n            disabled={loading}\n          >\n            {loading ? txtProcessing : txtResetPassword}\n          </Button>\n        </form>\n\n        <div className=\"mt-6 space-y-2 text-center text-sm\">\n          <Link\n            to=\"/forgot-password\"\n            className=\"block text-blue-600 hover:text-blue-800\"\n          >\n            {txtResendCode}\n          </Link>\n          <Link\n            to=\"/login\"\n            className=\"inline-flex items-center text-gray-600 hover:text-gray-800\"\n          >\n            <ArrowLeft className=\"w-4 h-4 mr-1\" />\n            {txtBackToLogin}\n          </Link>\n        </div>\n      </Card>\n    </div>\n  );\n}\n","path":null,"size_bytes":8351,"size_tokens":null},"src/pages/ForgotPassword.jsx":{"content":"import { useState } from 'react';\nimport { Link, useNavigate } from 'react-router-dom';\nimport { Button } from '@/components/ui/button';\nimport { Input } from '@/components/ui/input';\nimport { Card } from '@/components/ui/card';\nimport { ArrowLeft, Mail } from 'lucide-react';\nimport { useAutoTranslate } from '@/hooks/useTranslate';\nimport { safeFetch } from '@/utils/apiConfig';\n\nexport default function ForgotPassword() {\n  // Traduções\n  const txtRecoverPassword = useAutoTranslate('Recuperar Senha', 'pt');\n  const txtEnterEmail = useAutoTranslate('Insira o seu email para receber um código de recuperação', 'pt');\n  const txtEmail = useAutoTranslate('Email', 'pt');\n  const txtEmailPlaceholder = useAutoTranslate('seu@email.com', 'pt');\n  const txtErrorRequest = useAutoTranslate('Erro ao solicitar recuperação', 'pt');\n  const txtSending = useAutoTranslate('A enviar...', 'pt');\n  const txtSendCode = useAutoTranslate('Enviar Código', 'pt');\n  const txtBackToLogin = useAutoTranslate('Voltar ao login', 'pt');\n\n  const navigate = useNavigate();\n  const [email, setEmail] = useState('');\n  const [loading, setLoading] = useState(false);\n  const [error, setError] = useState('');\n\n  const handleSubmit = async (e) => {\n    e.preventDefault();\n    setError('');\n    setLoading(true);\n\n    try {\n      const { response, data } = await safeFetch('/api/auth/request-password-reset', {\n        method: 'POST',\n        body: JSON.stringify({ email }),\n      });\n\n      if (!response.ok) {\n        throw new Error(data?.error || txtErrorRequest);\n      }\n\n      // Redirecionar para página de reset com email\n      navigate('/reset-password', { \n        state: { \n          email,\n          message: data.message \n        } \n      });\n    } catch (err) {\n      setError(err.message);\n    } finally {\n      setLoading(false);\n    }\n  };\n\n  return (\n    <div className=\"min-h-screen bg-gradient-to-b from-blue-50 to-white flex items-center justify-center px-4 py-8\">\n      <Card className=\"w-full max-w-md p-4 sm:p-6 md:p-8\">\n        <div className=\"text-center mb-6 sm:mb-8\">\n          <div className=\"inline-flex items-center justify-center w-14 h-14 sm:w-16 sm:h-16 bg-blue-100 rounded-full mb-3 sm:mb-4\">\n            <Mail className=\"w-7 h-7 sm:w-8 sm:h-8 text-blue-600\" />\n          </div>\n          <h1 className=\"text-xl sm:text-2xl font-bold text-gray-900 mb-2\">\n            {txtRecoverPassword}\n          </h1>\n          <p className=\"text-sm sm:text-base text-gray-600\">\n            {txtEnterEmail}\n          </p>\n        </div>\n\n        <form onSubmit={handleSubmit} className=\"space-y-6\" noValidate>\n          <div>\n            <label htmlFor=\"email\" className=\"block text-sm font-medium text-gray-700 mb-2\">\n              {txtEmail}\n            </label>\n            <Input\n              id=\"email\"\n              type=\"text\"\n              inputMode=\"email\"\n              value={email}\n              onChange={(e) => setEmail(e.target.value)}\n              placeholder={txtEmailPlaceholder}\n              disabled={loading}\n              autoComplete=\"username\"\n            />\n          </div>\n\n          {error && (\n            <div className=\"bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded\">\n              {error}\n            </div>\n          )}\n\n          <Button\n            type=\"submit\"\n            className=\"w-full\"\n            disabled={loading}\n          >\n            {loading ? txtSending : txtSendCode}\n          </Button>\n        </form>\n\n        <div className=\"mt-6 text-center\">\n          <Link\n            to=\"/login\"\n            className=\"inline-flex items-center text-sm text-blue-600 hover:text-blue-800\"\n          >\n            <ArrowLeft className=\"w-4 h-4 mr-1\" />\n            {txtBackToLogin}\n          </Link>\n        </div>\n      </Card>\n    </div>\n  );\n}\n","path":null,"size_bytes":3816,"size_tokens":null},"src/components/business/CountryNotSupportedBanner.jsx":{"content":"import { AlertTriangle, Globe } from 'lucide-react';\nimport { Alert, AlertDescription, AlertTitle } from '@/components/ui/alert';\nimport { isCountrySupported } from '@/constants/stripeCountries';\nimport { useAutoTranslate } from '@/hooks/useTranslate';\n\nexport function CountryNotSupportedBanner({ userCountry }) {\n  const txtPaymentsBlocked = useAutoTranslate('Pagamentos Bloqueados', 'pt');\n  const txtCountryNotSupported = useAutoTranslate('O seu país ainda não é suportado para pagamentos. Estamos a trabalhar para adicionar mais países em breve.', 'pt');\n  \n  if (!userCountry || isCountrySupported(userCountry)) {\n    return null;\n  }\n\n  return (\n    <Alert variant=\"destructive\" className=\"mb-6\">\n      <AlertTriangle className=\"h-4 w-4\" />\n      <AlertTitle className=\"flex items-center gap-2\">\n        <Globe className=\"w-4 h-4\" />\n        {txtPaymentsBlocked}\n      </AlertTitle>\n      <AlertDescription>\n        {txtCountryNotSupported}\n      </AlertDescription>\n    </Alert>\n  );\n}\n","path":null,"size_bytes":998,"size_tokens":null},"src/utils/apiConfig.js":{"content":"// ✅ CONFIGURAÇÃO API - SUPORTA WEB E CAPACITOR (Android/iOS)\n// Em DEV Web: Usa proxy Vite (/api → http://localhost:3001/api)\n// Em PROD Web: Usa MESMO domínio (/api → https://waitless-qzero.com/api)\n// Em Capacitor: Usa URL COMPLETO (https://q-zero-afonsomarques80.replit.app/api)\n\n// ✅ Detectar Capacitor (Android/iOS app)\nconst isCapacitor = typeof window !== 'undefined' && \n  (window.Capacitor !== undefined || \n   window.location.protocol === 'capacitor:' ||\n   window.location.protocol === 'ionic:' ||\n   window.location.protocol === 'file:' ||\n   (window.location.hostname === 'localhost' && window.navigator.userAgent.includes('Android')) ||\n   window.navigator.userAgent.includes('Capacitor'));\n\n// URLs do servidor\nconst REPLIT_PUBLISHED_URL = 'https://q-zero-afonsomarques80.replit.app';\n\n// ✅ Determinar URL base\nconst getApiBase = () => {\n  if (isCapacitor) {\n    if (import.meta.env.VITE_API_URL) {\n      return import.meta.env.VITE_API_URL;\n    }\n    return REPLIT_PUBLISHED_URL;\n  }\n  return '';\n};\n\nexport const API_BASE = getApiBase();\n\n// ✅ Exportar função para verificar se está no Capacitor\nexport const isCapacitorApp = () => isCapacitor;\n\n// ✅ Exportar função para obter URL base (para redirects do Stripe, etc)\nexport const getBaseUrl = () => {\n  if (isCapacitor) {\n    // No Capacitor, usar sempre o URL do servidor publicado\n    return import.meta.env.VITE_API_URL || REPLIT_PUBLISHED_URL;\n  }\n  // Na web, usar o origin atual\n  return typeof window !== 'undefined' ? window.location.origin : '';\n};\n\n// 🔍 DEBUG: Logs para diagnóstico (apenas em desenvolvimento)\nif (import.meta.env.DEV) {\n  console.log('🔧 API CONFIG:', {\n    'isCapacitor': isCapacitor,\n    'import.meta.env.PROD': import.meta.env.PROD,\n    'window.location.hostname': typeof window !== 'undefined' ? window.location.hostname : 'N/A',\n    'API_BASE': API_BASE || '(same origin)',\n    'Exemplo URL': (API_BASE || (typeof window !== 'undefined' ? window.location.origin : '')) + '/api/auth/me'\n  });\n}\n\n// Helper para construir URLs de API\nexport const apiUrl = (path) => {\n  const fullUrl = API_BASE + path;\n  if (import.meta.env.DEV) {\n    console.log('🌐 API Request:', path, '→', fullUrl || (window.location.origin + path));\n  }\n  return fullUrl;\n};\n\n// ✅ Helper para construir URLs absolutas para uploads/imagens\n// Suporta: /uploads/..., /objects/..., URLs absolutas\n// Em Capacitor, precisa de URL absoluta; em web, URL relativa funciona\nexport const getUploadUrl = (relativePath) => {\n  if (!relativePath) return null;\n  \n  // Se já é URL absoluta, retorna como está\n  if (relativePath.startsWith('http://') || relativePath.startsWith('https://')) {\n    return relativePath;\n  }\n  \n  // Normalizar path - garantir que começa com /\n  let normalizedPath = relativePath.startsWith('/') ? relativePath : '/' + relativePath;\n  \n  // Garantir que paths de objects começam corretamente\n  if (normalizedPath.startsWith('/objects/') || normalizedPath.startsWith('/uploads/')) {\n    // Path já está correto\n  } else if (normalizedPath.startsWith('/')) {\n    // Outros paths - manter como estão\n  }\n  \n  // Se está no Capacitor, precisa de URL absoluta\n  if (isCapacitor) {\n    const base = import.meta.env.VITE_API_URL || REPLIT_PUBLISHED_URL;\n    return base + normalizedPath;\n  }\n  \n  // Em web, URL relativa funciona (com barra inicial)\n  return normalizedPath;\n};\n\n// ✅ FUNÇÃO SEGURA PARA FETCH - Lida com respostas HTML e erros\nexport const safeFetch = async (url, options = {}) => {\n  const fullUrl = apiUrl(url);\n  \n  // Para endpoints públicos, não enviar credentials\n  const isPublicEndpoint = url.includes('/api/public/');\n  \n  const defaultOptions = {\n    credentials: isPublicEndpoint ? 'omit' : 'include',\n    headers: {\n      'Content-Type': 'application/json',\n      ...options.headers\n    }\n  };\n  \n  const response = await fetch(fullUrl, { ...defaultOptions, ...options });\n  \n  // Lidar com respostas 204 No Content ou respostas vazias\n  if (response.status === 204 || response.headers.get('content-length') === '0') {\n    return { response, data: undefined };\n  }\n  \n  const contentType = response.headers.get('content-type') || '';\n  \n  // Se não é JSON, provavelmente é uma página de erro HTML\n  if (!contentType.includes('application/json')) {\n    const text = await response.text();\n    \n    if (!text || text.trim() === '') {\n      return { response, data: undefined };\n    }\n    \n    if (text.includes('<!DOCTYPE') || text.includes('<html')) {\n      console.error('❌ API ERROR: Servidor retornou HTML em vez de JSON');\n      console.error('📍 Endpoint:', url);\n      console.error('🔍 Content-Type:', contentType);\n      \n      throw new Error(\n        `Servidor indisponível. Verifique se a aplicação está publicada e acessível.`\n      );\n    }\n    \n    try {\n      const data = JSON.parse(text);\n      return { response, data };\n    } catch (e) {\n      throw new Error(`Resposta inválida do servidor: ${text.substring(0, 100)}`);\n    }\n  }\n  \n  const data = await response.json();\n  return { response, data };\n};\n","path":null,"size_bytes":5098,"size_tokens":null},"src/components/translation/TranslatedText.jsx":{"content":"import { useAutoTranslate } from '../../hooks/useTranslate';\n\nexport function TranslatedText({ text, sourceLang = null, children, as: Component = 'span', ...props }) {\n  const translatedText = useAutoTranslate(text || children, sourceLang);\n\n  return <Component {...props}>{translatedText}</Component>;\n}\n","path":null,"size_bytes":305,"size_tokens":null},"src/hooks/useTranslate.js":{"content":"import { useState, useCallback, useEffect, useRef, useMemo } from 'react';\nimport { useTranslation } from 'react-i18next';\nimport { safeFetch } from '@/utils/apiConfig';\n\nconst CACHE_STORAGE_KEY = 'qzero_translations_cache';\nconst CACHE_MAX_SIZE = 5000;\nconst CACHE_VERSION = 1;\n\nconst GLOSSARY_OVERRIDES = {\n  en: {\n    'Tirar Senha': 'Get Ticket',\n    'Retirar Senha': 'Get Ticket',\n    'Nova Senha': 'New Ticket',\n    'Senha retirada com sucesso!': 'Ticket taken successfully!',\n    'Erro ao retirar senha. Tente novamente.': 'Error getting ticket. Please try again.',\n    'Já tem uma senha ativa para este serviço': 'You already have an active ticket for this service',\n    'Gestão de Senhas': 'Ticket Management',\n    'Gestão de Senhas e Filas': 'Ticket and Queue Management',\n    'Crie e gerir as suas senhas de atendimento': 'Create and manage your service tickets',\n    'Para criar e gerir senhas de atendimento, precisa de ativar o plano empresarial.': 'To create and manage service tickets, you need to activate the business plan.',\n    'Senha eliminada com sucesso': 'Ticket deleted successfully',\n    'Erro ao eliminar senha': 'Error deleting ticket',\n    'Eliminar Senha': 'Delete Ticket',\n    'Tem certeza que deseja eliminar esta senha de atendimento? Esta ação não pode ser desfeita.': 'Are you sure you want to delete this service ticket? This action cannot be undone.',\n    'Nenhuma senha de atendimento criada': 'No service tickets created',\n    'Crie a sua primeira senha de atendimento para começar a gerir o fluxo de clientes': 'Create your first service ticket to start managing customer flow',\n    'Criar Primeira Senha': 'Create First Ticket',\n    'Multisenhas (várias ao mesmo tempo)': 'Multi-tickets (multiple at once)',\n    '🎫 Multisenhas (várias ao mesmo tempo)': '🎫 Multi-tickets (multiple at once)',\n    'Receba senhas virtuais e acompanhe em tempo real': 'Get virtual tickets and track in real time',\n    'Senha': 'Ticket',\n    'Senhas': 'Tickets',\n    'senha': 'ticket',\n    'senhas': 'tickets',\n    'senha de atendimento': 'service ticket',\n    'senhas de atendimento': 'service tickets',\n  },\n  es: {\n    'Tirar Senha': 'Obtener Turno',\n    'Retirar Senha': 'Obtener Turno',\n    'Nova Senha': 'Nuevo Turno',\n    'Senha retirada com sucesso!': '¡Turno obtenido con éxito!',\n    'Erro ao retirar senha. Tente novamente.': 'Error al obtener turno. Inténtelo de nuevo.',\n    'Já tem uma senha ativa para este serviço': 'Ya tiene un turno activo para este servicio',\n    'Gestão de Senhas': 'Gestión de Turnos',\n    'Gestão de Senhas e Filas': 'Gestión de Turnos y Colas',\n    'Crie e gerir as suas senhas de atendimento': 'Cree y gestione sus turnos de atención',\n    'Senha': 'Turno',\n    'Senhas': 'Turnos',\n  },\n  fr: {\n    'Tirar Senha': 'Prendre un Ticket',\n    'Retirar Senha': 'Prendre un Ticket',\n    'Nova Senha': 'Nouveau Ticket',\n    'Senha retirada com sucesso!': 'Ticket pris avec succès!',\n    'Erro ao retirar senha. Tente novamente.': 'Erreur lors de la prise du ticket. Veuillez réessayer.',\n    'Já tem uma senha ativa para este serviço': 'Vous avez déjà un ticket actif pour ce service',\n    'Gestão de Senhas': 'Gestion des Tickets',\n    'Gestão de Senhas e Filas': 'Gestion des Tickets et Files',\n    'Crie e gerir as suas senhas de atendimento': 'Créez et gérez vos tickets de service',\n    'Senha': 'Ticket',\n    'Senhas': 'Tickets',\n  },\n  de: {\n    'Tirar Senha': 'Ticket Nehmen',\n    'Retirar Senha': 'Ticket Nehmen',\n    'Nova Senha': 'Neues Ticket',\n    'Senha retirada com sucesso!': 'Ticket erfolgreich genommen!',\n    'Erro ao retirar senha. Tente novamente.': 'Fehler beim Nehmen des Tickets. Bitte erneut versuchen.',\n    'Já tem uma senha ativa para este serviço': 'Sie haben bereits ein aktives Ticket für diesen Service',\n    'Gestão de Senhas': 'Ticketverwaltung',\n    'Gestão de Senhas e Filas': 'Ticket- und Warteschlangenverwaltung',\n    'Crie e gerir as suas senhas de atendimento': 'Erstellen und verwalten Sie Ihre Service-Tickets',\n    'Senha': 'Ticket',\n    'Senhas': 'Tickets',\n  },\n  it: {\n    'Tirar Senha': 'Prendi Biglietto',\n    'Retirar Senha': 'Prendi Biglietto',\n    'Nova Senha': 'Nuovo Biglietto',\n    'Senha retirada com sucesso!': 'Biglietto preso con successo!',\n    'Erro ao retirar senha. Tente novamente.': 'Errore nel prendere il biglietto. Riprova.',\n    'Já tem uma senha ativa para este serviço': 'Hai già un biglietto attivo per questo servizio',\n    'Gestão de Senhas': 'Gestione Biglietti',\n    'Gestão de Senhas e Filas': 'Gestione Biglietti e Code',\n    'Crie e gerir as suas senhas de atendimento': 'Crea e gestisci i tuoi biglietti di servizio',\n    'Senha': 'Biglietto',\n    'Senhas': 'Biglietti',\n  },\n};\n\nfunction getGlossaryOverride(text, targetLang) {\n  if (!text || targetLang === 'pt') return null;\n  \n  const langOverrides = GLOSSARY_OVERRIDES[targetLang];\n  if (!langOverrides) return null;\n  \n  if (langOverrides[text]) {\n    return langOverrides[text];\n  }\n  \n  const lowerText = text.toLowerCase();\n  for (const [key, value] of Object.entries(langOverrides)) {\n    if (key.toLowerCase() === lowerText) {\n      return value;\n    }\n  }\n  \n  return null;\n}\n\nconst memoryCache = new Map();\nlet cacheLoadedFromStorage = false;\nconst pendingTranslations = new Map();\nconst translationSubscribers = new Map();\n\nfunction loadCacheFromStorage() {\n  if (cacheLoadedFromStorage) return;\n  \n  try {\n    const stored = localStorage.getItem(CACHE_STORAGE_KEY);\n    if (stored) {\n      const { version, data } = JSON.parse(stored);\n      if (version === CACHE_VERSION && Array.isArray(data)) {\n        data.forEach(([key, value]) => {\n          memoryCache.set(key, value);\n        });\n        console.log(`✅ Cache de traduções carregado: ${data.length} entradas`);\n      }\n    }\n  } catch (e) {\n    console.warn('Erro ao carregar cache de traduções:', e);\n  }\n  cacheLoadedFromStorage = true;\n}\n\nfunction saveCacheToStorage() {\n  try {\n    const entries = Array.from(memoryCache.entries());\n    const trimmedEntries = entries.slice(-CACHE_MAX_SIZE);\n    \n    localStorage.setItem(CACHE_STORAGE_KEY, JSON.stringify({\n      version: CACHE_VERSION,\n      data: trimmedEntries\n    }));\n  } catch (e) {\n    console.warn('Erro ao guardar cache de traduções:', e);\n  }\n}\n\nlet saveTimeout = null;\nfunction debouncedSaveCache() {\n  if (saveTimeout) clearTimeout(saveTimeout);\n  saveTimeout = setTimeout(saveCacheToStorage, 1000);\n}\n\nloadCacheFromStorage();\n\nfunction getCacheKey(text, sourceLang, targetLang) {\n  return `${sourceLang || 'auto'}:${targetLang}:${text}`;\n}\n\nfunction notifySubscribers(cacheKey, translation) {\n  const subscribers = translationSubscribers.get(cacheKey);\n  if (subscribers) {\n    subscribers.forEach(callback => callback(translation));\n  }\n}\n\nasync function fetchTranslationFromAPI(text, targetLang, sourceLang, cacheKey) {\n  if (pendingTranslations.has(cacheKey)) {\n    return pendingTranslations.get(cacheKey);\n  }\n\n  const translationPromise = (async () => {\n    try {\n      const requestBody = {\n        text,\n        targetLang,\n      };\n      \n      if (sourceLang) {\n        requestBody.sourceLang = sourceLang;\n      }\n\n      const { response, data } = await safeFetch('/api/translate', {\n        method: 'POST',\n        body: JSON.stringify(requestBody),\n      });\n\n      if (!response.ok) {\n        console.error('Translation failed:', response.status);\n        return text;\n      }\n\n      const translation = data?.translation || text;\n\n      memoryCache.set(cacheKey, translation);\n      debouncedSaveCache();\n      notifySubscribers(cacheKey, translation);\n\n      return translation;\n    } catch (error) {\n      console.error('Translation error:', error);\n      return text;\n    } finally {\n      pendingTranslations.delete(cacheKey);\n    }\n  })();\n\n  pendingTranslations.set(cacheKey, translationPromise);\n  return translationPromise;\n}\n\nfunction getCachedTranslation(text, targetLang, sourceLang) {\n  if (!text || typeof text !== 'string') {\n    return { value: text, isCached: true };\n  }\n\n  const glossaryOverride = getGlossaryOverride(text, targetLang);\n  if (glossaryOverride) {\n    return { value: glossaryOverride, isCached: true };\n  }\n\n  const cacheKey = getCacheKey(text, sourceLang, targetLang);\n  if (memoryCache.has(cacheKey)) {\n    return { value: memoryCache.get(cacheKey), isCached: true };\n  }\n\n  return { value: text, isCached: false, cacheKey };\n}\n\nexport function useTranslate() {\n  const { i18n } = useTranslation();\n  const [isTranslating, setIsTranslating] = useState(false);\n\n  const currentLang = i18n.language?.split('-')[0] || 'pt';\n\n  const translate = useCallback(async (text, sourceLang = null) => {\n    if (!text || typeof text !== 'string') {\n      return text;\n    }\n\n    const glossaryOverride = getGlossaryOverride(text, currentLang);\n    if (glossaryOverride) {\n      return glossaryOverride;\n    }\n\n    const cacheKey = getCacheKey(text, sourceLang, currentLang);\n    \n    if (memoryCache.has(cacheKey)) {\n      return memoryCache.get(cacheKey);\n    }\n\n    if (pendingTranslations.has(cacheKey)) {\n      return pendingTranslations.get(cacheKey);\n    }\n\n    setIsTranslating(true);\n    try {\n      return await fetchTranslationFromAPI(text, currentLang, sourceLang, cacheKey);\n    } finally {\n      setIsTranslating(false);\n    }\n  }, [currentLang]);\n\n  const translateBatch = useCallback(async (texts, sourceLang = null) => {\n    if (!Array.isArray(texts) || texts.length === 0) {\n      return texts;\n    }\n\n    const uncachedTexts = [];\n    const uncachedIndices = [];\n    const results = new Array(texts.length);\n\n    texts.forEach((text, index) => {\n      if (!text || typeof text !== 'string') {\n        results[index] = text;\n        return;\n      }\n\n      const cacheKey = getCacheKey(text, sourceLang, currentLang);\n      if (memoryCache.has(cacheKey)) {\n        results[index] = memoryCache.get(cacheKey);\n      } else {\n        uncachedTexts.push(text);\n        uncachedIndices.push(index);\n      }\n    });\n\n    if (uncachedTexts.length === 0) {\n      return results;\n    }\n\n    setIsTranslating(true);\n\n    try {\n      const requestBody = {\n        texts: uncachedTexts,\n        targetLang: currentLang,\n      };\n      \n      if (sourceLang) {\n        requestBody.sourceLang = sourceLang;\n      }\n\n      const { response, data } = await safeFetch('/api/translate', {\n        method: 'POST',\n        body: JSON.stringify(requestBody),\n      });\n\n      if (!response.ok) {\n        console.error('Batch translation failed:', response.status);\n        uncachedIndices.forEach(index => {\n          results[index] = texts[index];\n        });\n        return results;\n      }\n\n      const translations = data?.translations || uncachedTexts;\n\n      uncachedIndices.forEach((originalIndex, i) => {\n        const translation = translations[i] || texts[originalIndex];\n        results[originalIndex] = translation;\n\n        const cacheKey = getCacheKey(uncachedTexts[i], sourceLang, currentLang);\n        memoryCache.set(cacheKey, translation);\n      });\n\n      debouncedSaveCache();\n\n      return results;\n    } catch (error) {\n      console.error('Batch translation error:', error);\n      uncachedIndices.forEach(index => {\n        results[index] = texts[index];\n      });\n      return results;\n    } finally {\n      setIsTranslating(false);\n    }\n  }, [currentLang]);\n\n  const detectLanguage = useCallback(async (text) => {\n    if (!text || typeof text !== 'string') {\n      return 'pt';\n    }\n\n    try {\n      const { response, data } = await safeFetch('/api/translate/detect', {\n        method: 'POST',\n        body: JSON.stringify({ text }),\n      });\n\n      if (!response.ok) {\n        return 'pt';\n      }\n\n      return data?.language || 'pt';\n    } catch (error) {\n      console.error('Language detection error:', error);\n      return 'pt';\n    }\n  }, []);\n\n  return {\n    translate,\n    translateBatch,\n    detectLanguage,\n    isTranslating,\n    currentLang,\n  };\n}\n\nexport function useAutoTranslate(text, sourceLang = null) {\n  const { i18n } = useTranslation();\n  const currentLang = i18n.language?.split('-')[0] || 'pt';\n  \n  const cacheKey = useMemo(() => {\n    return getCacheKey(text, sourceLang, currentLang);\n  }, [text, sourceLang, currentLang]);\n  \n  const getInitialValue = useCallback(() => {\n    const result = getCachedTranslation(text, currentLang, sourceLang);\n    return result.value;\n  }, [text, currentLang, sourceLang]);\n  \n  const [translatedText, setTranslatedText] = useState(getInitialValue);\n  \n  const isMountedRef = useRef(true);\n  const prevLangRef = useRef(currentLang);\n  const prevTextRef = useRef(text);\n  \n  useEffect(() => {\n    isMountedRef.current = true;\n    return () => {\n      isMountedRef.current = false;\n    };\n  }, []);\n  \n  useEffect(() => {\n    const langChanged = prevLangRef.current !== currentLang;\n    const textChanged = prevTextRef.current !== text;\n    \n    prevLangRef.current = currentLang;\n    prevTextRef.current = text;\n    \n    if (langChanged || textChanged) {\n      setTranslatedText(getInitialValue());\n    }\n    \n    const cacheResult = getCachedTranslation(text, currentLang, sourceLang);\n    \n    if (cacheResult.isCached) {\n      if (langChanged || textChanged) {\n        setTranslatedText(cacheResult.value);\n      }\n      return;\n    }\n    \n    if (!text || !cacheResult.cacheKey) {\n      return;\n    }\n    \n    const currentCacheKey = cacheResult.cacheKey;\n    \n    const handleTranslationUpdate = (translation) => {\n      if (isMountedRef.current) {\n        setTranslatedText(translation);\n      }\n    };\n    \n    if (!translationSubscribers.has(currentCacheKey)) {\n      translationSubscribers.set(currentCacheKey, new Set());\n    }\n    translationSubscribers.get(currentCacheKey).add(handleTranslationUpdate);\n    \n    if (!pendingTranslations.has(currentCacheKey)) {\n      fetchTranslationFromAPI(text, currentLang, sourceLang, currentCacheKey);\n    } else {\n      pendingTranslations.get(currentCacheKey).then((result) => {\n        if (isMountedRef.current) {\n          setTranslatedText(result);\n        }\n      });\n    }\n    \n    return () => {\n      const subscribers = translationSubscribers.get(currentCacheKey);\n      if (subscribers) {\n        subscribers.delete(handleTranslationUpdate);\n        if (subscribers.size === 0) {\n          translationSubscribers.delete(currentCacheKey);\n        }\n      }\n    };\n  }, [text, sourceLang, currentLang, getInitialValue, cacheKey]);\n\n  return translatedText;\n}\n","path":null,"size_bytes":14520,"size_tokens":null},"server/services/translateService.js":{"content":"import pkg from '@google-cloud/translate';\nconst { Translate } = pkg.v2;\nimport logger from '../middleware/logger.js';\n\nconst translate = new Translate({\n  key: process.env.GOOGLE_TRANSLATE_API_KEY,\n});\n\nconst translationCache = new Map();\nconst CACHE_MAX_SIZE = 10000;\nconst CACHE_TTL = 1000 * 60 * 60 * 24;\n\nfunction getCacheKey(text, sourceLang, targetLang) {\n  return `${sourceLang}:${targetLang}:${text}`;\n}\n\nfunction cleanCache() {\n  if (translationCache.size > CACHE_MAX_SIZE) {\n    const keysToDelete = Array.from(translationCache.keys()).slice(0, Math.floor(CACHE_MAX_SIZE / 2));\n    keysToDelete.forEach(key => translationCache.delete(key));\n    logger.info(`Translation cache cleaned: removed ${keysToDelete.length} entries`);\n  }\n}\n\nexport async function translateText(text, targetLang, sourceLang = null) {\n  if (!text || typeof text !== 'string' || text.length > 5000) {\n    return text;\n  }\n\n  if (!process.env.GOOGLE_TRANSLATE_API_KEY) {\n    logger.error('GOOGLE_TRANSLATE_API_KEY not configured');\n    return text;\n  }\n\n  let detectedSource = sourceLang;\n  \n  if (!detectedSource) {\n    try {\n      const [detection] = await translate.detect(text);\n      detectedSource = detection.language;\n    } catch (error) {\n      logger.error('Language detection failed, defaulting to pt:', error);\n      detectedSource = 'pt';\n    }\n  }\n  \n  if (detectedSource === targetLang) {\n    return text;\n  }\n\n  const cacheKey = getCacheKey(text, detectedSource, targetLang);\n  const cached = translationCache.get(cacheKey);\n  \n  if (cached) {\n    if (Date.now() - cached.timestamp < CACHE_TTL) {\n      return cached.translation;\n    } else {\n      translationCache.delete(cacheKey);\n    }\n  }\n\n  try {\n    const [translation] = await translate.translate(text, {\n      from: detectedSource,\n      to: targetLang,\n    });\n\n    translationCache.set(cacheKey, {\n      translation,\n      timestamp: Date.now(),\n    });\n\n    cleanCache();\n\n    logger.info(`Translated text from ${detectedSource} to ${targetLang}: \"${text.substring(0, 50)}...\"`);\n    \n    return translation;\n  } catch (error) {\n    logger.error('Translation error:', error);\n    return text;\n  }\n}\n\nexport async function translateBatch(texts, targetLang, sourceLang = null) {\n  if (!Array.isArray(texts) || texts.length === 0 || texts.length > 100) {\n    return texts;\n  }\n\n  if (!process.env.GOOGLE_TRANSLATE_API_KEY) {\n    logger.error('GOOGLE_TRANSLATE_API_KEY not configured');\n    return texts;\n  }\n\n  const validTexts = texts.filter(t => t && typeof t === 'string' && t.length <= 5000);\n  if (validTexts.length === 0) {\n    return texts;\n  }\n\n  let detectedSource = sourceLang;\n  \n  if (!detectedSource && validTexts.length > 0) {\n    try {\n      const [detection] = await translate.detect(validTexts[0]);\n      detectedSource = detection.language;\n    } catch (error) {\n      logger.error('Language detection failed, defaulting to pt:', error);\n      detectedSource = 'pt';\n    }\n  }\n  \n  if (detectedSource === targetLang) {\n    return texts;\n  }\n\n  const uncachedTexts = [];\n  const uncachedIndices = [];\n  const results = new Array(texts.length);\n\n  texts.forEach((text, index) => {\n    if (!text || typeof text !== 'string' || text.length > 5000) {\n      results[index] = text;\n      return;\n    }\n\n    const cacheKey = getCacheKey(text, detectedSource, targetLang);\n    const cached = translationCache.get(cacheKey);\n    \n    if (cached) {\n      if (Date.now() - cached.timestamp < CACHE_TTL) {\n        results[index] = cached.translation;\n      } else {\n        translationCache.delete(cacheKey);\n        uncachedTexts.push(text);\n        uncachedIndices.push(index);\n      }\n    } else {\n      uncachedTexts.push(text);\n      uncachedIndices.push(index);\n    }\n  });\n\n  if (uncachedTexts.length === 0) {\n    return results;\n  }\n\n  try {\n    const [translations] = await translate.translate(uncachedTexts, {\n      from: detectedSource,\n      to: targetLang,\n    });\n\n    uncachedIndices.forEach((originalIndex, i) => {\n      const translation = Array.isArray(translations) ? translations[i] : translations;\n      const originalText = uncachedTexts[i];\n      \n      results[originalIndex] = translation;\n\n      const cacheKey = getCacheKey(originalText, detectedSource, targetLang);\n      translationCache.set(cacheKey, {\n        translation,\n        timestamp: Date.now(),\n      });\n    });\n\n    cleanCache();\n\n    logger.info(`Batch translated ${uncachedTexts.length} texts from ${detectedSource} to ${targetLang}`);\n    \n    return results;\n  } catch (error) {\n    logger.error('Batch translation error:', error);\n    uncachedIndices.forEach(index => {\n      results[index] = texts[index];\n    });\n    return results;\n  }\n}\n\nexport async function detectLanguage(text) {\n  if (!text || typeof text !== 'string') {\n    return 'pt';\n  }\n\n  if (!process.env.GOOGLE_TRANSLATE_API_KEY) {\n    return 'pt';\n  }\n\n  try {\n    const [detection] = await translate.detect(text);\n    return detection.language;\n  } catch (error) {\n    logger.error('Language detection error:', error);\n    return 'pt';\n  }\n}\n\nexport function clearTranslationCache() {\n  translationCache.clear();\n  logger.info('Translation cache cleared');\n}\n","path":null,"size_bytes":5188,"size_tokens":null},"src/components/PreRegisterConsent.jsx":{"content":"import React from 'react';\n\nexport default function PreRegisterConsent({ children }) {\n  return <>{children}</>;\n}\n","path":null,"size_bytes":115,"size_tokens":null},"src/config/consent.js":{"content":"/**\n * Consent Configuration\n * Defines the current version of Privacy Policy and Terms & Conditions\n * If this version changes, users will need to accept the new consent\n */\nexport const CONSENT_VERSION = \"privacy_v1.0\";\n","path":null,"size_bytes":222,"size_tokens":null},"src/utils/consentRetry.js":{"content":"/**\n * Consent Retry System\n * Automatically retries pending consent submissions that failed on initial attempt\n */\n\n/**\n * Attempt to send pending consent to server\n * Called on app load\n */\nexport async function retryPendingConsent() {\n  try {\n    // Check if there's a pending consent\n    const pendingConsentData = localStorage.getItem('qzero_consent_pending');\n    \n    if (!pendingConsentData) {\n      return; // No pending consent\n    }\n\n    console.log('🔄 Attempting to retry pending consent...');\n    \n    const consentPayload = JSON.parse(pendingConsentData);\n\n    // Attempt to send consent to backend\n    const { safeFetch } = await import('@/utils/apiConfig');\n    const { response, data: result } = await safeFetch('/api/consent', {\n      method: 'POST',\n      body: JSON.stringify(consentPayload)\n    });\n\n    if (response.ok) {\n      if (result?.ok) {\n        // Success - remove pending consent\n        localStorage.removeItem('qzero_consent_pending');\n        console.log('✅ Pending consent successfully submitted');\n      } else {\n        console.warn('⚠️ Consent API returned ok:false, will retry later');\n      }\n    } else {\n      console.warn(`⚠️ Consent retry failed with HTTP ${response.status}, will retry later`);\n    }\n  } catch (error) {\n    console.warn('⚠️ Consent retry failed:', error.message, '- will retry later');\n  }\n}\n","path":null,"size_bytes":1373,"size_tokens":null},"src/components/debug/ApiDiagnostic.jsx":{"content":"import React, { useState } from 'react';\nimport { Button } from '@/components/ui/button';\nimport { Card } from '@/components/ui/card';\nimport { AlertCircle, CheckCircle, Wifi, Server, XCircle, ChevronDown, ChevronUp } from 'lucide-react';\nimport { apiUrl } from '@/utils/apiConfig';\n\nconst isCapacitor = typeof window !== 'undefined' && \n  (window.Capacitor !== undefined || \n   window.location.protocol === 'capacitor:' ||\n   window.location.protocol === 'ionic:' ||\n   window.location.protocol === 'file:');\n\nexport function ApiDiagnostic({ error }) {\n  const [expanded, setExpanded] = useState(false);\n  const [diagResults, setDiagResults] = useState(null);\n  const [testing, setTesting] = useState(false);\n\n  const isHtmlError = error?.message?.includes('API indisponível') || \n                      error?.message?.includes('unexpected token') ||\n                      error?.message?.includes('doctype');\n\n  const runDiagnostics = async () => {\n    setTesting(true);\n    const results = {\n      environment: {\n        isCapacitor,\n        protocol: window.location.protocol,\n        hostname: window.location.hostname,\n        apiBase: apiUrl(''),\n        timestamp: new Date().toISOString()\n      },\n      tests: []\n    };\n\n    const endpoints = [\n      { name: 'Health Check', url: '/api/health' },\n      { name: 'Public Businesses', url: '/api/public/businesses' }\n    ];\n\n    for (const ep of endpoints) {\n      try {\n        const start = Date.now();\n        const response = await fetch(apiUrl(ep.url), { \n          method: 'GET',\n          headers: { 'Accept': 'application/json' }\n        });\n        const duration = Date.now() - start;\n        const contentType = response.headers.get('content-type') || '';\n        const isJson = contentType.includes('application/json');\n        \n        let bodyPreview = '';\n        try {\n          const text = await response.text();\n          bodyPreview = text.substring(0, 100);\n          if (text.includes('<!DOCTYPE') || text.includes('<html')) {\n            bodyPreview = '[HTML PAGE - Server may be down or returning error page]';\n          }\n        } catch (e) {\n          bodyPreview = '[Unable to read body]';\n        }\n\n        results.tests.push({\n          endpoint: ep.name,\n          url: apiUrl(ep.url),\n          status: response.status,\n          ok: response.ok,\n          contentType,\n          isJson,\n          duration,\n          bodyPreview\n        });\n      } catch (err) {\n        results.tests.push({\n          endpoint: ep.name,\n          url: apiUrl(ep.url),\n          error: err.message,\n          ok: false\n        });\n      }\n    }\n\n    setDiagResults(results);\n    setTesting(false);\n  };\n\n  if (!isHtmlError && !expanded) {\n    return null;\n  }\n\n  return (\n    <Card className=\"mt-4 p-4 bg-amber-50 border-amber-200\">\n      <div \n        className=\"flex items-center justify-between cursor-pointer\"\n        onClick={() => setExpanded(!expanded)}\n      >\n        <div className=\"flex items-center gap-2 text-amber-700\">\n          <AlertCircle className=\"w-5 h-5\" />\n          <span className=\"font-medium text-sm\">Problemas de Conectividade</span>\n        </div>\n        {expanded ? <ChevronUp className=\"w-4 h-4\" /> : <ChevronDown className=\"w-4 h-4\" />}\n      </div>\n\n      {expanded && (\n        <div className=\"mt-4 space-y-4\">\n          <div className=\"text-sm text-amber-800\">\n            <p className=\"mb-2\">\n              O servidor não está a responder corretamente. Isto pode acontecer se:\n            </p>\n            <ul className=\"list-disc ml-4 space-y-1 text-xs\">\n              <li>O servidor de produção não está publicado</li>\n              <li>Problemas de rede ou firewall</li>\n              <li>O servidor está a devolver uma página de erro HTML</li>\n            </ul>\n          </div>\n\n          <Button \n            variant=\"outline\" \n            size=\"sm\"\n            onClick={runDiagnostics}\n            disabled={testing}\n            className=\"w-full text-xs\"\n          >\n            <Wifi className=\"w-4 h-4 mr-2\" />\n            {testing ? 'A testar...' : 'Executar Diagnóstico'}\n          </Button>\n\n          {diagResults && (\n            <div className=\"mt-4 space-y-3 text-xs\">\n              <div className=\"bg-white p-3 rounded border\">\n                <h4 className=\"font-medium mb-2 flex items-center gap-2\">\n                  <Server className=\"w-4 h-4\" />\n                  Ambiente\n                </h4>\n                <div className=\"space-y-1 text-slate-600\">\n                  <p>App Móvel: {diagResults.environment.isCapacitor ? 'Sim (Capacitor)' : 'Não (Browser)'}</p>\n                  <p>Protocolo: {diagResults.environment.protocol}</p>\n                  <p>API Base: {diagResults.environment.apiBase || '(same-origin)'}</p>\n                </div>\n              </div>\n\n              {diagResults.tests.map((test, i) => (\n                <div key={i} className={`p-3 rounded border ${test.ok ? 'bg-green-50 border-green-200' : 'bg-red-50 border-red-200'}`}>\n                  <div className=\"flex items-center gap-2 mb-1\">\n                    {test.ok ? (\n                      <CheckCircle className=\"w-4 h-4 text-green-600\" />\n                    ) : (\n                      <XCircle className=\"w-4 h-4 text-red-600\" />\n                    )}\n                    <span className=\"font-medium\">{test.endpoint}</span>\n                  </div>\n                  <div className=\"text-slate-600 space-y-1\">\n                    <p className=\"truncate\">URL: {test.url}</p>\n                    {test.error ? (\n                      <p className=\"text-red-600\">Erro: {test.error}</p>\n                    ) : (\n                      <>\n                        <p>Status: {test.status} | JSON: {test.isJson ? 'Sim' : 'Não'} | {test.duration}ms</p>\n                        <p className=\"truncate\">Resposta: {test.bodyPreview}</p>\n                      </>\n                    )}\n                  </div>\n                </div>\n              ))}\n            </div>\n          )}\n        </div>\n      )}\n    </Card>\n  );\n}\n\nexport default ApiDiagnostic;\n","path":null,"size_bytes":6088,"size_tokens":null},"android/app/src/test/java/com/getcapacitor/myapp/ExampleUnitTest.java":{"content":"package com.getcapacitor.myapp;\n\nimport static org.junit.Assert.*;\n\nimport org.junit.Test;\n\n/**\n * Example local unit test, which will execute on the development machine (host).\n *\n * @see <a href=\"http://d.android.com/tools/testing\">Testing documentation</a>\n */\npublic class ExampleUnitTest {\n\n    @Test\n    public void addition_isCorrect() throws Exception {\n        assertEquals(4, 2 + 2);\n    }\n}\n","path":null,"size_bytes":402,"size_tokens":null},"ios/App/App/AppDelegate.swift":{"content":"import UIKit\nimport Capacitor\n\n@UIApplicationMain\nclass AppDelegate: UIResponder, UIApplicationDelegate {\n\n    var window: UIWindow?\n\n    func application(_ application: UIApplication, didFinishLaunchingWithOptions launchOptions: [UIApplication.LaunchOptionsKey: Any]?) -> Bool {\n        // Override point for customization after application launch.\n        return true\n    }\n\n    func applicationWillResignActive(_ application: UIApplication) {\n        // Sent when the application is about to move from active to inactive state. This can occur for certain types of temporary interruptions (such as an incoming phone call or SMS message) or when the user quits the application and it begins the transition to the background state.\n        // Use this method to pause ongoing tasks, disable timers, and invalidate graphics rendering callbacks. Games should use this method to pause the game.\n    }\n\n    func applicationDidEnterBackground(_ application: UIApplication) {\n        // Use this method to release shared resources, save user data, invalidate timers, and store enough application state information to restore your application to its current state in case it is terminated later.\n        // If your application supports background execution, this method is called instead of applicationWillTerminate: when the user quits.\n    }\n\n    func applicationWillEnterForeground(_ application: UIApplication) {\n        // Called as part of the transition from the background to the active state; here you can undo many of the changes made on entering the background.\n    }\n\n    func applicationDidBecomeActive(_ application: UIApplication) {\n        // Restart any tasks that were paused (or not yet started) while the application was inactive. If the application was previously in the background, optionally refresh the user interface.\n    }\n\n    func applicationWillTerminate(_ application: UIApplication) {\n        // Called when the application is about to terminate. Save data if appropriate. See also applicationDidEnterBackground:.\n    }\n\n    func application(_ app: UIApplication, open url: URL, options: [UIApplication.OpenURLOptionsKey: Any] = [:]) -> Bool {\n        // Called when the app was launched with a url. Feel free to add additional processing here,\n        // but if you want the App API to support tracking app url opens, make sure to keep this call\n        return ApplicationDelegateProxy.shared.application(app, open: url, options: options)\n    }\n\n    func application(_ application: UIApplication, continue userActivity: NSUserActivity, restorationHandler: @escaping ([UIUserActivityRestoring]?) -> Void) -> Bool {\n        // Called when the app was launched with an activity, including Universal Links.\n        // Feel free to add additional processing here, but if you want the App API to support\n        // tracking app url opens, make sure to keep this call\n        return ApplicationDelegateProxy.shared.application(application, continue: userActivity, restorationHandler: restorationHandler)\n    }\n\n}\n","path":null,"size_bytes":3031,"size_tokens":null},"android/app/src/androidTest/java/com/getcapacitor/myapp/ExampleInstrumentedTest.java":{"content":"package com.getcapacitor.myapp;\n\nimport static org.junit.Assert.*;\n\nimport android.content.Context;\nimport androidx.test.ext.junit.runners.AndroidJUnit4;\nimport androidx.test.platform.app.InstrumentationRegistry;\nimport org.junit.Test;\nimport org.junit.runner.RunWith;\n\n/**\n * Instrumented test, which will execute on an Android device.\n *\n * @see <a href=\"http://d.android.com/tools/testing\">Testing documentation</a>\n */\n@RunWith(AndroidJUnit4.class)\npublic class ExampleInstrumentedTest {\n\n    @Test\n    public void useAppContext() throws Exception {\n        // Context of the app under test.\n        Context appContext = InstrumentationRegistry.getInstrumentation().getTargetContext();\n\n        assertEquals(\"com.getcapacitor.app\", appContext.getPackageName());\n    }\n}\n","path":null,"size_bytes":774,"size_tokens":null},"android/app/src/main/java/com/qzero/app/MainActivity.java":{"content":"package com.qzero.app;\n\nimport com.getcapacitor.BridgeActivity;\n\npublic class MainActivity extends BridgeActivity {}\n","path":null,"size_bytes":117,"size_tokens":null},"src/components/business/AddressSearchBox.jsx":{"content":"import React, { useState, useEffect, useRef, useCallback } from 'react';\nimport { setOptions, importLibrary } from '@googlemaps/js-api-loader';\nimport Autocomplete from 'react-google-autocomplete';\nimport { Input } from '@/components/ui/input';\nimport { MapPin, Loader2, Search, AlertTriangle } from 'lucide-react';\nimport { isCapacitorApp, safeFetch } from '@/utils/apiConfig';\n\nlet optionsSet = false;\nlet loadingPromise = null;\n\nfunction initializeGoogleMaps() {\n  const apiKey = import.meta.env.VITE_GOOGLE_MAPS_API_KEY;\n  \n  if (!apiKey) {\n    return null;\n  }\n\n  if (!optionsSet) {\n    setOptions({\n      key: apiKey,\n      version: 'weekly'\n    });\n    optionsSet = true;\n  }\n\n  return true;\n}\n\nfunction useDebounce(value, delay) {\n  const [debouncedValue, setDebouncedValue] = useState(value);\n\n  useEffect(() => {\n    const handler = setTimeout(() => {\n      setDebouncedValue(value);\n    }, delay);\n\n    return () => {\n      clearTimeout(handler);\n    };\n  }, [value, delay]);\n\n  return debouncedValue;\n}\n\nexport function AddressSearchBox({ \n  onAddressSelect, \n  countryCode = 'PT',\n  placeholder = \"Pesquisar morada...\"\n}) {\n  const isCapacitor = isCapacitorApp();\n  \n  const [apiKeyAvailable, setApiKeyAvailable] = useState(true);\n  const [scriptsLoaded, setScriptsLoaded] = useState(false);\n  const [loadingFailed, setLoadingFailed] = useState(false);\n  \n  const [inputValue, setInputValue] = useState('');\n  const [predictions, setPredictions] = useState([]);\n  const [isSearching, setIsSearching] = useState(false);\n  const [showDropdown, setShowDropdown] = useState(false);\n  const [isSelectingPlace, setIsSelectingPlace] = useState(false);\n  \n  const dropdownRef = useRef(null);\n  const inputRef = useRef(null);\n  \n  const debouncedInput = useDebounce(inputValue, 400);\n\n  useEffect(() => {\n    if (!isCapacitor) {\n      const initialized = initializeGoogleMaps();\n      \n      if (!initialized) {\n        console.warn('⚠️ Google Maps API key não configurada');\n        setApiKeyAvailable(false);\n        return;\n      }\n\n      if (window.google && window.google.maps && window.google.maps.places) {\n        setScriptsLoaded(true);\n        return;\n      }\n\n      if (!loadingPromise) {\n        loadingPromise = importLibrary('places')\n          .then(() => {\n            console.log('✅ Google Maps Places API carregado');\n            setScriptsLoaded(true);\n            setLoadingFailed(false);\n          })\n          .catch((err) => {\n            console.error('❌ Erro ao carregar Google Maps:', err);\n            setLoadingFailed(true);\n            setApiKeyAvailable(false);\n            loadingPromise = null;\n          });\n      } else {\n        loadingPromise.then(() => {\n          setScriptsLoaded(true);\n          setLoadingFailed(false);\n        }).catch(() => {\n          setLoadingFailed(true);\n          setApiKeyAvailable(false);\n        });\n      }\n    }\n  }, [isCapacitor]);\n\n  useEffect(() => {\n    if (!isCapacitor || !debouncedInput || debouncedInput.length < 3) {\n      setPredictions([]);\n      return;\n    }\n\n    const fetchPredictions = async () => {\n      setIsSearching(true);\n      try {\n        const { response, data } = await safeFetch(\n          `/api/places/autocomplete?input=${encodeURIComponent(debouncedInput)}&country=${countryCode}`\n        );\n        \n        if (response.ok && data?.predictions) {\n          setPredictions(data.predictions);\n          setShowDropdown(true);\n        } else {\n          setPredictions([]);\n        }\n      } catch (err) {\n        console.error('❌ Erro ao buscar moradas:', err);\n        setPredictions([]);\n      } finally {\n        setIsSearching(false);\n      }\n    };\n\n    fetchPredictions();\n  }, [isCapacitor, debouncedInput, countryCode]);\n\n  useEffect(() => {\n    const handleClickOutside = (event) => {\n      if (dropdownRef.current && !dropdownRef.current.contains(event.target) &&\n          inputRef.current && !inputRef.current.contains(event.target)) {\n        setShowDropdown(false);\n      }\n    };\n\n    document.addEventListener('mousedown', handleClickOutside);\n    return () => document.removeEventListener('mousedown', handleClickOutside);\n  }, []);\n\n  const handlePredictionSelect = useCallback(async (prediction) => {\n    setIsSelectingPlace(true);\n    setShowDropdown(false);\n    setInputValue(prediction.description);\n    \n    try {\n      const { response, data } = await safeFetch(\n        `/api/places/details?place_id=${encodeURIComponent(prediction.place_id)}`\n      );\n      \n      if (response.ok && data?.result) {\n        const place = data.result;\n        const addressComponents = place.address_components;\n        \n        if (!addressComponents || addressComponents.length === 0) {\n          console.warn('⚠️ Resposta sem address_components');\n          return;\n        }\n        \n        const addressData = extractAddressComponents(addressComponents);\n        \n        const completeAddress = {\n          ...addressData,\n          formattedAddress: place.formatted_address || prediction.description,\n          placeId: prediction.place_id,\n          geometry: place.geometry?.location ? {\n            lat: place.geometry.location.lat,\n            lng: place.geometry.location.lng\n          } : null\n        };\n\n        console.log('✅ Morada completa extraída:', completeAddress);\n        onAddressSelect(completeAddress);\n        setInputValue('');\n      }\n    } catch (err) {\n      console.error('❌ Erro ao buscar detalhes:', err);\n    } finally {\n      setIsSelectingPlace(false);\n    }\n  }, [onAddressSelect]);\n\n  const handlePlaceSelected = useCallback((place) => {\n    if (!place || !place.address_components) {\n      console.warn('⚠️ Morada inválida selecionada');\n      return;\n    }\n\n    const addressData = extractAddressComponents(place.address_components);\n    \n    const completeAddress = {\n      ...addressData,\n      formattedAddress: place.formatted_address || '',\n      placeId: place.place_id || '',\n      geometry: place.geometry ? {\n        lat: place.geometry.location.lat(),\n        lng: place.geometry.location.lng()\n      } : null\n    };\n    \n    console.log('✅ Morada completa extraída:', completeAddress);\n    onAddressSelect(completeAddress);\n  }, [onAddressSelect]);\n\n  const getComponentRestrictions = () => {\n    if (countryCode) {\n      return { country: countryCode.toLowerCase() };\n    }\n    return undefined;\n  };\n\n  if (isCapacitor) {\n    return (\n      <div className=\"relative\">\n        <Search className=\"absolute left-3 top-1/2 -translate-y-1/2 h-5 w-5 text-blue-500 z-10\" />\n        {(isSearching || isSelectingPlace) && (\n          <Loader2 className=\"absolute right-3 top-1/2 -translate-y-1/2 h-5 w-5 text-blue-500 animate-spin z-10\" />\n        )}\n        <Input\n          ref={inputRef}\n          value={inputValue}\n          onChange={(e) => {\n            setInputValue(e.target.value);\n            if (e.target.value.length >= 3) {\n              setShowDropdown(true);\n            }\n          }}\n          onFocus={() => {\n            if (predictions.length > 0) {\n              setShowDropdown(true);\n            }\n          }}\n          placeholder={placeholder}\n          className=\"pl-11 pr-11 h-12 text-base bg-white border-blue-200 focus:border-blue-400 rounded-lg\"\n          disabled={isSelectingPlace}\n        />\n        \n        {showDropdown && predictions.length > 0 && (\n          <div \n            ref={dropdownRef}\n            className=\"absolute z-50 w-full mt-2 bg-white border border-blue-200 rounded-xl shadow-lg max-h-64 overflow-auto\"\n          >\n            {predictions.map((prediction) => (\n              <button\n                key={prediction.place_id}\n                type=\"button\"\n                className=\"w-full px-4 py-4 text-left hover:bg-blue-50 active:bg-blue-100 focus:bg-blue-50 focus:outline-none border-b border-blue-100 last:border-b-0 first:rounded-t-xl last:rounded-b-xl\"\n                onClick={() => handlePredictionSelect(prediction)}\n                disabled={isSelectingPlace}\n              >\n                <div className=\"flex items-start gap-3\">\n                  <MapPin className=\"h-5 w-5 text-blue-500 mt-0.5 flex-shrink-0\" />\n                  <span className=\"text-base text-slate-700\">{prediction.description}</span>\n                </div>\n              </button>\n            ))}\n          </div>\n        )}\n        \n        {showDropdown && isSearching && predictions.length === 0 && (\n          <div className=\"absolute z-50 w-full mt-2 bg-white border border-blue-200 rounded-xl shadow-lg p-4\">\n            <div className=\"flex items-center gap-3 text-base text-blue-600\">\n              <Loader2 className=\"h-5 w-5 animate-spin\" />\n              A procurar moradas...\n            </div>\n          </div>\n        )}\n        \n        {showDropdown && !isSearching && predictions.length === 0 && debouncedInput.length >= 3 && (\n          <div className=\"absolute z-50 w-full mt-2 bg-amber-50 border border-amber-200 rounded-xl shadow-lg p-4\">\n            <p className=\"text-base text-amber-800 font-medium\">Nenhuma morada encontrada</p>\n            <p className=\"text-sm text-amber-600 mt-1\">Tente pesquisar de forma diferente</p>\n          </div>\n        )}\n      </div>\n    );\n  }\n\n  if (!apiKeyAvailable || loadingFailed) {\n    return (\n      <div className=\"flex items-center gap-2 p-3 bg-amber-50 border border-amber-200 rounded-lg text-amber-800 text-sm\">\n        <AlertTriangle className=\"h-4 w-4 flex-shrink-0\" />\n        <span>Pesquisa indisponível. Preencha os campos manualmente.</span>\n      </div>\n    );\n  }\n\n  if (!scriptsLoaded) {\n    return (\n      <div className=\"relative\">\n        <Loader2 className=\"absolute left-3 top-1/2 -translate-y-1/2 h-5 w-5 text-blue-500 animate-spin z-10\" />\n        <Input\n          disabled\n          placeholder=\"A carregar pesquisa...\"\n          className=\"pl-11 h-12 bg-slate-50\"\n        />\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"relative\">\n      <Search className=\"absolute left-3 top-1/2 -translate-y-1/2 h-5 w-5 text-blue-500 z-10 pointer-events-none\" />\n      <Autocomplete\n        apiKey={import.meta.env.VITE_GOOGLE_MAPS_API_KEY}\n        onPlaceSelected={handlePlaceSelected}\n        options={{\n          types: ['address'],\n          componentRestrictions: getComponentRestrictions(),\n          fields: ['address_components', 'geometry', 'formatted_address', 'place_id']\n        }}\n        placeholder={placeholder}\n        className=\"flex h-12 w-full rounded-lg border border-blue-200 bg-white px-3 py-2 pl-11 text-base ring-offset-background placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-blue-400 focus-visible:ring-offset-2\"\n      />\n    </div>\n  );\n}\n\nfunction extractAddressComponents(components) {\n  const data = {\n    streetNumber: '',\n    streetName: '',\n    city: '',\n    district: '',\n    postalCode: '',\n    country: ''\n  };\n\n  components.forEach(component => {\n    const types = component.types;\n    const longName = component.long_name;\n    const shortName = component.short_name;\n\n    if (types.includes('street_number')) {\n      data.streetNumber = longName;\n    }\n\n    if (types.includes('route')) {\n      data.streetName = longName;\n    }\n\n    if (types.includes('locality')) {\n      data.city = longName;\n    } else if (types.includes('postal_town') && !data.city) {\n      data.city = longName;\n    } else if (types.includes('administrative_area_level_2') && !data.city) {\n      data.city = longName;\n    }\n\n    if (types.includes('administrative_area_level_1')) {\n      data.district = longName;\n    }\n\n    if (types.includes('postal_code')) {\n      data.postalCode = longName;\n    }\n\n    if (types.includes('country')) {\n      data.country = shortName;\n    }\n  });\n\n  return data;\n}\n\nexport default AddressSearchBox;\n","path":null,"size_bytes":11822,"size_tokens":null},"server/services/objectStorage.js":{"content":"import { Storage } from \"@google-cloud/storage\";\nimport { randomUUID } from \"crypto\";\n\nconst REPLIT_SIDECAR_ENDPOINT = \"http://127.0.0.1:1106\";\n\nexport const objectStorageClient = new Storage({\n  credentials: {\n    audience: \"replit\",\n    subject_token_type: \"access_token\",\n    token_url: `${REPLIT_SIDECAR_ENDPOINT}/token`,\n    type: \"external_account\",\n    credential_source: {\n      url: `${REPLIT_SIDECAR_ENDPOINT}/credential`,\n      format: {\n        type: \"json\",\n        subject_token_field_name: \"access_token\",\n      },\n    },\n    universe_domain: \"googleapis.com\",\n  },\n  projectId: \"\",\n});\n\nexport class ObjectNotFoundError extends Error {\n  constructor() {\n    super(\"Object not found\");\n    this.name = \"ObjectNotFoundError\";\n    Object.setPrototypeOf(this, ObjectNotFoundError.prototype);\n  }\n}\n\nexport class ObjectStorageService {\n  constructor() {}\n\n  getPrivateObjectDir() {\n    const dir = process.env.PRIVATE_OBJECT_DIR || \"\";\n    if (!dir) {\n      throw new Error(\n        \"PRIVATE_OBJECT_DIR not set. Create a bucket in 'Object Storage' \" +\n          \"tool and set PRIVATE_OBJECT_DIR env var.\"\n      );\n    }\n    return dir;\n  }\n\n  async getUploadURL(filename) {\n    const privateObjectDir = this.getPrivateObjectDir();\n    const objectId = `${Date.now()}-${randomUUID()}`;\n    const sanitizedFilename = filename.replace(/[^a-zA-Z0-9.-]/g, '_');\n    const fullPath = `${privateObjectDir}/uploads/${objectId}-${sanitizedFilename}`;\n\n    const { bucketName, objectName } = parseObjectPath(fullPath);\n\n    const signedUrl = await signObjectURL({\n      bucketName,\n      objectName,\n      method: \"PUT\",\n      ttlSec: 900,\n    });\n\n    return {\n      uploadURL: signedUrl,\n      objectPath: `/objects/uploads/${objectId}-${sanitizedFilename}`,\n    };\n  }\n\n  async getObjectFile(objectPath) {\n    if (!objectPath.startsWith(\"/objects/\")) {\n      throw new ObjectNotFoundError();\n    }\n\n    const parts = objectPath.slice(1).split(\"/\");\n    if (parts.length < 2) {\n      throw new ObjectNotFoundError();\n    }\n\n    const entityId = parts.slice(1).join(\"/\");\n    let entityDir = this.getPrivateObjectDir();\n    if (!entityDir.endsWith(\"/\")) {\n      entityDir = `${entityDir}/`;\n    }\n    const objectEntityPath = `${entityDir}${entityId}`;\n    const { bucketName, objectName } = parseObjectPath(objectEntityPath);\n    const bucket = objectStorageClient.bucket(bucketName);\n    const objectFile = bucket.file(objectName);\n    const [exists] = await objectFile.exists();\n    if (!exists) {\n      throw new ObjectNotFoundError();\n    }\n    return objectFile;\n  }\n\n  async downloadObject(file, res, cacheTtlSec = 3600) {\n    try {\n      const [metadata] = await file.getMetadata();\n      res.set({\n        \"Content-Type\": metadata.contentType || \"application/octet-stream\",\n        \"Content-Length\": metadata.size,\n        \"Cache-Control\": `public, max-age=${cacheTtlSec}`,\n      });\n\n      const stream = file.createReadStream();\n\n      stream.on(\"error\", (err) => {\n        console.error(\"Stream error:\", err);\n        if (!res.headersSent) {\n          res.status(500).json({ error: \"Error streaming file\" });\n        }\n      });\n\n      stream.pipe(res);\n    } catch (error) {\n      console.error(\"Error downloading file:\", error);\n      if (!res.headersSent) {\n        res.status(500).json({ error: \"Error downloading file\" });\n      }\n    }\n  }\n\n  normalizeObjectPath(rawPath) {\n    if (!rawPath.startsWith(\"https://storage.googleapis.com/\")) {\n      return rawPath;\n    }\n\n    const url = new URL(rawPath);\n    const rawObjectPath = url.pathname;\n\n    let objectEntityDir = this.getPrivateObjectDir();\n    if (!objectEntityDir.endsWith(\"/\")) {\n      objectEntityDir = `${objectEntityDir}/`;\n    }\n\n    if (!rawObjectPath.startsWith(objectEntityDir)) {\n      return rawObjectPath;\n    }\n\n    const entityId = rawObjectPath.slice(objectEntityDir.length);\n    return `/objects/${entityId}`;\n  }\n}\n\nfunction parseObjectPath(path) {\n  if (!path.startsWith(\"/\")) {\n    path = `/${path}`;\n  }\n  const pathParts = path.split(\"/\");\n  if (pathParts.length < 3) {\n    throw new Error(\"Invalid path: must contain at least a bucket name\");\n  }\n\n  const bucketName = pathParts[1];\n  const objectName = pathParts.slice(2).join(\"/\");\n\n  return {\n    bucketName,\n    objectName,\n  };\n}\n\nasync function signObjectURL({ bucketName, objectName, method, ttlSec }) {\n  const request = {\n    bucket_name: bucketName,\n    object_name: objectName,\n    method,\n    expires_at: new Date(Date.now() + ttlSec * 1000).toISOString(),\n  };\n  const response = await fetch(\n    `${REPLIT_SIDECAR_ENDPOINT}/object-storage/signed-object-url`,\n    {\n      method: \"POST\",\n      headers: {\n        \"Content-Type\": \"application/json\",\n      },\n      body: JSON.stringify(request),\n    }\n  );\n  if (!response.ok) {\n    throw new Error(\n      `Failed to sign object URL, errorcode: ${response.status}, ` +\n        `make sure you're running on Replit`\n    );\n  }\n\n  const { signed_url: signedURL } = await response.json();\n  return signedURL;\n}\n\nexport default new ObjectStorageService();\n","path":null,"size_bytes":5063,"size_tokens":null},"src/hooks/useNavigateBack.js":{"content":"import { useNavigate } from 'react-router-dom';\nimport { useCallback } from 'react';\n\nexport function useNavigateBack(fallbackPath = '/') {\n  const navigate = useNavigate();\n\n  const goBack = useCallback(() => {\n    if (window.history.length > 1) {\n      navigate(-1);\n    } else {\n      navigate(fallbackPath, { replace: true });\n    }\n  }, [navigate, fallbackPath]);\n\n  return goBack;\n}\n\nexport function navigateBackOrFallback(navigate, fallbackPath = '/') {\n  if (window.history.length > 1) {\n    navigate(-1);\n  } else {\n    navigate(fallbackPath, { replace: true });\n  }\n}\n","path":null,"size_bytes":578,"size_tokens":null},"src/pages/PrivacyPolicy.jsx":{"content":"import React from \"react\";\nimport { useNavigate } from \"react-router-dom\";\nimport { Button } from \"@/components/ui/button\";\nimport { Card, CardContent } from \"@/components/ui/card\";\nimport { ArrowLeft, Shield, Lock, Eye, Database, Globe, Mail, Trash2 } from \"lucide-react\";\nimport { useAutoTranslate } from '@/hooks/useTranslate';\nimport { navigateBackOrFallback } from '@/hooks/useNavigateBack';\nimport { useTranslation } from 'react-i18next';\nimport { format } from 'date-fns';\nimport { pt, enUS, es, fr, de, it, nl, pl, ru, uk, zhCN, ja, ko, ar, hi, tr, vi, th, id as idLocale, ms } from 'date-fns/locale';\n\nconst localeMap = {\n  'pt': pt, 'pt-PT': pt, 'pt-BR': pt,\n  'en': enUS, 'en-US': enUS, 'en-GB': enUS,\n  'es': es, 'fr': fr, 'de': de, 'it': it, 'nl': nl, 'pl': pl,\n  'ru': ru, 'uk': uk, 'zh': zhCN, 'zh-CN': zhCN, 'ja': ja, 'ko': ko,\n  'ar': ar, 'hi': hi, 'tr': tr, 'vi': vi, 'th': th, 'id': idLocale, 'ms': ms, 'fil': enUS\n};\n\nexport default function PrivacyPolicyPage() {\n  const navigate = useNavigate();\n  const { i18n } = useTranslation();\n  \n  const currentLocale = localeMap[i18n.language] || localeMap[i18n.language?.split('-')[0]] || enUS;\n  const lastUpdateDate = new Date(2025, 11, 2);\n  const isPtLang = i18n.language?.startsWith('pt');\n  const formattedDate = isPtLang \n    ? format(lastUpdateDate, \"d 'de' MMMM 'de' yyyy\", { locale: currentLocale })\n    : format(lastUpdateDate, \"MMMM d, yyyy\", { locale: currentLocale });\n  \n  const txtBack = useAutoTranslate('Voltar', 'pt');\n  const txtTitle = useAutoTranslate('Política de Privacidade', 'pt');\n  const txtLastUpdated = useAutoTranslate('Última atualização', 'pt');\n  \n  const txtIntroTitle = useAutoTranslate('Introdução', 'pt');\n  const txtIntroText = useAutoTranslate('A QZero (\"nós\", \"nosso\" ou \"nos\") opera a aplicação móvel QZero. Esta página informa-o sobre as nossas políticas relativas à recolha, utilização e divulgação de dados pessoais quando utiliza o nosso Serviço e as escolhas que tem associadas a esses dados.', 'pt');\n  \n  const txtDataCollectionTitle = useAutoTranslate('Dados que Recolhemos', 'pt');\n  const txtDataCollectionText = useAutoTranslate('Recolhemos vários tipos de informação para fornecer e melhorar o nosso Serviço:', 'pt');\n  const txtDataPersonal = useAutoTranslate('Dados Pessoais: nome, email, número de telefone, data de nascimento', 'pt');\n  const txtDataLocation = useAutoTranslate('Dados de Localização: localização GPS (apenas com a sua permissão)', 'pt');\n  const txtDataUsage = useAutoTranslate('Dados de Utilização: interações com a app, histórico de filas e marcações', 'pt');\n  const txtDataDevice = useAutoTranslate('Dados do Dispositivo: tipo de dispositivo, sistema operativo, identificadores únicos', 'pt');\n  const txtDataPayment = useAutoTranslate('Dados de Pagamento: processados de forma segura através de Stripe ou Apple/Google Pay', 'pt');\n  \n  const txtDataUseTitle = useAutoTranslate('Como Utilizamos os Seus Dados', 'pt');\n  const txtDataUseText = useAutoTranslate('Utilizamos os dados recolhidos para:', 'pt');\n  const txtDataUse1 = useAutoTranslate('Fornecer e manter o nosso Serviço', 'pt');\n  const txtDataUse2 = useAutoTranslate('Notificá-lo sobre alterações no nosso Serviço', 'pt');\n  const txtDataUse3 = useAutoTranslate('Permitir-lhe participar em funcionalidades interativas', 'pt');\n  const txtDataUse4 = useAutoTranslate('Fornecer suporte ao cliente', 'pt');\n  const txtDataUse5 = useAutoTranslate('Recolher análises para melhorar o Serviço', 'pt');\n  const txtDataUse6 = useAutoTranslate('Detetar, prevenir e resolver problemas técnicos', 'pt');\n  const txtDataUse7 = useAutoTranslate('Enviar notificações push sobre filas e marcações', 'pt');\n  \n  const txtDataStorageTitle = useAutoTranslate('Armazenamento e Segurança dos Dados', 'pt');\n  const txtDataStorageText = useAutoTranslate('Os seus dados são armazenados de forma segura em servidores encriptados. Implementamos medidas de segurança adequadas para proteger contra acesso não autorizado, alteração, divulgação ou destruição dos seus dados pessoais.', 'pt');\n  \n  const txtDataSharingTitle = useAutoTranslate('Partilha de Dados', 'pt');\n  const txtDataSharingText = useAutoTranslate('Não vendemos nem alugamos os seus dados pessoais a terceiros. Podemos partilhar os seus dados apenas com:', 'pt');\n  const txtDataSharing1 = useAutoTranslate('Prestadores de serviços (Stripe para pagamentos, Firebase para notificações)', 'pt');\n  const txtDataSharing2 = useAutoTranslate('Empresas onde utiliza os nossos serviços de fila/marcação', 'pt');\n  const txtDataSharing3 = useAutoTranslate('Autoridades legais quando exigido por lei', 'pt');\n  \n  const txtRightsTitle = useAutoTranslate('Os Seus Direitos (GDPR)', 'pt');\n  const txtRightsText = useAutoTranslate('Ao abrigo do GDPR, tem os seguintes direitos:', 'pt');\n  const txtRights1 = useAutoTranslate('Direito de acesso aos seus dados pessoais', 'pt');\n  const txtRights2 = useAutoTranslate('Direito de retificação de dados incorretos', 'pt');\n  const txtRights3 = useAutoTranslate('Direito ao apagamento (\"direito a ser esquecido\")', 'pt');\n  const txtRights4 = useAutoTranslate('Direito à portabilidade dos dados', 'pt');\n  const txtRights5 = useAutoTranslate('Direito de oposição ao processamento', 'pt');\n  const txtRights6 = useAutoTranslate('Direito de retirar o consentimento a qualquer momento', 'pt');\n  \n  const txtDeleteTitle = useAutoTranslate('Eliminação de Conta', 'pt');\n  const txtDeleteText = useAutoTranslate('Pode eliminar a sua conta e todos os dados associados a qualquer momento através das definições do seu perfil na aplicação. Esta ação é irreversível e remove permanentemente todos os seus dados dos nossos sistemas.', 'pt');\n  \n  const txtChildrenTitle = useAutoTranslate('Privacidade de Menores', 'pt');\n  const txtChildrenText = useAutoTranslate('O nosso Serviço não se destina a menores de 16 anos. Não recolhemos intencionalmente informações pessoais de menores de 16 anos.', 'pt');\n  \n  const txtChangesTitle = useAutoTranslate('Alterações a Esta Política', 'pt');\n  const txtChangesText = useAutoTranslate('Podemos atualizar a nossa Política de Privacidade periodicamente. Notificá-lo-emos de quaisquer alterações publicando a nova Política de Privacidade nesta página e atualizando a data de \"última atualização\".', 'pt');\n  \n  const txtContactTitle = useAutoTranslate('Contacto', 'pt');\n  const txtContactText = useAutoTranslate('Se tiver questões sobre esta Política de Privacidade, contacte-nos:', 'pt');\n\n  return (\n    <div className=\"bg-gradient-to-br from-slate-50 via-blue-50 to-sky-50\">\n      <div className=\"max-w-4xl mx-auto px-4 py-4 sm:py-8\">\n        <div className=\"mb-6\">\n          <Button\n            variant=\"ghost\"\n            onClick={() => navigateBackOrFallback(navigate, '/')}\n            className=\"gap-2\"\n          >\n            <ArrowLeft className=\"w-4 h-4\" />\n            {txtBack}\n          </Button>\n        </div>\n\n        <Card className=\"border-0 shadow-xl\">\n          <CardContent className=\"p-6 sm:p-8 md:p-12\">\n            <div className=\"flex items-center gap-3 mb-6\">\n              <div className=\"p-3 bg-indigo-100 rounded-xl\">\n                <Shield className=\"w-8 h-8 text-indigo-600\" />\n              </div>\n              <div>\n                <h1 className=\"text-2xl sm:text-3xl font-bold text-slate-900\">{txtTitle}</h1>\n                <p className=\"text-sm text-slate-500\">{txtLastUpdated}: {formattedDate}</p>\n              </div>\n            </div>\n\n            <div className=\"prose prose-slate max-w-none space-y-8\">\n              <section>\n                <h2 className=\"text-xl font-semibold text-slate-900 flex items-center gap-2\">\n                  <Eye className=\"w-5 h-5 text-indigo-600\" />\n                  {txtIntroTitle}\n                </h2>\n                <p className=\"text-slate-600 mt-2\">{txtIntroText}</p>\n              </section>\n\n              <section>\n                <h2 className=\"text-xl font-semibold text-slate-900 flex items-center gap-2\">\n                  <Database className=\"w-5 h-5 text-indigo-600\" />\n                  {txtDataCollectionTitle}\n                </h2>\n                <p className=\"text-slate-600 mt-2\">{txtDataCollectionText}</p>\n                <ul className=\"list-disc list-inside text-slate-600 mt-3 space-y-2\">\n                  <li>{txtDataPersonal}</li>\n                  <li>{txtDataLocation}</li>\n                  <li>{txtDataUsage}</li>\n                  <li>{txtDataDevice}</li>\n                  <li>{txtDataPayment}</li>\n                </ul>\n              </section>\n\n              <section>\n                <h2 className=\"text-xl font-semibold text-slate-900 flex items-center gap-2\">\n                  <Globe className=\"w-5 h-5 text-indigo-600\" />\n                  {txtDataUseTitle}\n                </h2>\n                <p className=\"text-slate-600 mt-2\">{txtDataUseText}</p>\n                <ul className=\"list-disc list-inside text-slate-600 mt-3 space-y-2\">\n                  <li>{txtDataUse1}</li>\n                  <li>{txtDataUse2}</li>\n                  <li>{txtDataUse3}</li>\n                  <li>{txtDataUse4}</li>\n                  <li>{txtDataUse5}</li>\n                  <li>{txtDataUse6}</li>\n                  <li>{txtDataUse7}</li>\n                </ul>\n              </section>\n\n              <section>\n                <h2 className=\"text-xl font-semibold text-slate-900 flex items-center gap-2\">\n                  <Lock className=\"w-5 h-5 text-indigo-600\" />\n                  {txtDataStorageTitle}\n                </h2>\n                <p className=\"text-slate-600 mt-2\">{txtDataStorageText}</p>\n              </section>\n\n              <section>\n                <h2 className=\"text-xl font-semibold text-slate-900\">{txtDataSharingTitle}</h2>\n                <p className=\"text-slate-600 mt-2\">{txtDataSharingText}</p>\n                <ul className=\"list-disc list-inside text-slate-600 mt-3 space-y-2\">\n                  <li>{txtDataSharing1}</li>\n                  <li>{txtDataSharing2}</li>\n                  <li>{txtDataSharing3}</li>\n                </ul>\n              </section>\n\n              <section>\n                <h2 className=\"text-xl font-semibold text-slate-900\">{txtRightsTitle}</h2>\n                <p className=\"text-slate-600 mt-2\">{txtRightsText}</p>\n                <ul className=\"list-disc list-inside text-slate-600 mt-3 space-y-2\">\n                  <li>{txtRights1}</li>\n                  <li>{txtRights2}</li>\n                  <li>{txtRights3}</li>\n                  <li>{txtRights4}</li>\n                  <li>{txtRights5}</li>\n                  <li>{txtRights6}</li>\n                </ul>\n              </section>\n\n              <section>\n                <h2 className=\"text-xl font-semibold text-slate-900 flex items-center gap-2\">\n                  <Trash2 className=\"w-5 h-5 text-red-600\" />\n                  {txtDeleteTitle}\n                </h2>\n                <p className=\"text-slate-600 mt-2\">{txtDeleteText}</p>\n              </section>\n\n              <section>\n                <h2 className=\"text-xl font-semibold text-slate-900\">{txtChildrenTitle}</h2>\n                <p className=\"text-slate-600 mt-2\">{txtChildrenText}</p>\n              </section>\n\n              <section>\n                <h2 className=\"text-xl font-semibold text-slate-900\">{txtChangesTitle}</h2>\n                <p className=\"text-slate-600 mt-2\">{txtChangesText}</p>\n              </section>\n\n              <section>\n                <h2 className=\"text-xl font-semibold text-slate-900 flex items-center gap-2\">\n                  <Mail className=\"w-5 h-5 text-indigo-600\" />\n                  {txtContactTitle}\n                </h2>\n                <p className=\"text-slate-600 mt-2\">{txtContactText}</p>\n                <div className=\"mt-3 p-4 bg-slate-50 rounded-lg\">\n                  <p className=\"text-slate-700\"><strong>Email:</strong> suporteqzero@gmail.com</p>\n                </div>\n              </section>\n            </div>\n          </CardContent>\n        </Card>\n      </div>\n    </div>\n  );\n}\n","path":null,"size_bytes":12152,"size_tokens":null},"server/services/pushNotificationService.js":{"content":"import admin from 'firebase-admin';\nimport { db } from '../db.js';\nimport { deviceTokens, pushNotifications, users } from '../../shared/schema.js';\nimport { eq, and } from 'drizzle-orm';\nimport { v4 as uuidv4 } from 'uuid';\nimport { translateText } from './translateService.js';\n\nlet firebaseInitialized = false;\n\nfunction initializeFirebase() {\n  if (firebaseInitialized) return true;\n  \n  const serviceAccountJson = process.env.FIREBASE_SERVICE_ACCOUNT_JSON;\n  \n  if (!serviceAccountJson) {\n    console.log('⚠️ Firebase not configured - FIREBASE_SERVICE_ACCOUNT_JSON not set');\n    return false;\n  }\n\n  try {\n    const serviceAccount = JSON.parse(serviceAccountJson);\n    admin.initializeApp({\n      credential: admin.credential.cert(serviceAccount),\n    });\n    firebaseInitialized = true;\n    console.log('✅ Firebase Admin initialized for push notifications');\n    return true;\n  } catch (error) {\n    console.error('❌ Failed to initialize Firebase:', error.message);\n    return false;\n  }\n}\n\nexport async function registerDeviceToken(userId, token, platform, deviceInfo = {}) {\n  try {\n    const existingTokens = await db.select()\n      .from(deviceTokens)\n      .where(and(\n        eq(deviceTokens.userId, userId),\n        eq(deviceTokens.token, token)\n      ));\n\n    if (existingTokens.length > 0) {\n      await db.update(deviceTokens)\n        .set({\n          isActive: true,\n          lastUsedAt: new Date(),\n          updatedAt: new Date(),\n        })\n        .where(eq(deviceTokens.id, existingTokens[0].id));\n      \n      console.log('✅ Device token updated for user:', userId);\n      return existingTokens[0].id;\n    }\n\n    const id = uuidv4();\n    await db.insert(deviceTokens).values({\n      id,\n      userId,\n      token,\n      platform,\n      deviceInfo,\n      isActive: true,\n      lastUsedAt: new Date(),\n    });\n\n    console.log('✅ Device token registered for user:', userId);\n    return id;\n  } catch (error) {\n    console.error('❌ Error registering device token:', error);\n    throw error;\n  }\n}\n\nexport async function unregisterDeviceToken(userId, token) {\n  try {\n    await db.update(deviceTokens)\n      .set({ isActive: false, updatedAt: new Date() })\n      .where(and(\n        eq(deviceTokens.userId, userId),\n        eq(deviceTokens.token, token)\n      ));\n    \n    console.log('✅ Device token unregistered for user:', userId);\n  } catch (error) {\n    console.error('❌ Error unregistering device token:', error);\n    throw error;\n  }\n}\n\nexport async function getUserTokens(userId) {\n  try {\n    const tokens = await db.select()\n      .from(deviceTokens)\n      .where(and(\n        eq(deviceTokens.userId, userId),\n        eq(deviceTokens.isActive, true)\n      ));\n    \n    return tokens;\n  } catch (error) {\n    console.error('❌ Error getting user tokens:', error);\n    return [];\n  }\n}\n\nexport async function sendPushNotification(userId, title, body, data = {}, type = 'general') {\n  if (!initializeFirebase()) {\n    console.log('⚠️ Push notifications disabled - Firebase not configured');\n    return { success: false, reason: 'firebase_not_configured' };\n  }\n\n  try {\n    const tokens = await getUserTokens(userId);\n    \n    if (tokens.length === 0) {\n      console.log('⚠️ No active tokens for user:', userId);\n      return { success: false, reason: 'no_tokens' };\n    }\n\n    const notificationId = uuidv4();\n    await db.insert(pushNotifications).values({\n      id: notificationId,\n      userId,\n      title,\n      body,\n      data,\n      type,\n      status: 'sending',\n    });\n\n    const message = {\n      notification: {\n        title,\n        body,\n      },\n      data: {\n        ...data,\n        notificationId,\n        type,\n        click_action: 'FLUTTER_NOTIFICATION_CLICK',\n      },\n      tokens: tokens.map(t => t.token),\n    };\n\n    const response = await admin.messaging().sendEachForMulticast(message);\n    \n    const successCount = response.successCount;\n    const failureCount = response.failureCount;\n    \n    response.responses.forEach(async (resp, idx) => {\n      if (!resp.success) {\n        console.error(`❌ Failed to send to token ${idx}:`, resp.error);\n        if (resp.error?.code === 'messaging/invalid-registration-token' ||\n            resp.error?.code === 'messaging/registration-token-not-registered') {\n          await db.update(deviceTokens)\n            .set({ isActive: false, updatedAt: new Date() })\n            .where(eq(deviceTokens.token, tokens[idx].token));\n        }\n      }\n    });\n\n    await db.update(pushNotifications)\n      .set({\n        status: successCount > 0 ? 'sent' : 'failed',\n        sentAt: new Date(),\n      })\n      .where(eq(pushNotifications.id, notificationId));\n\n    console.log(`📬 Push notification sent: ${successCount} success, ${failureCount} failed`);\n    \n    return {\n      success: successCount > 0,\n      successCount,\n      failureCount,\n      notificationId,\n    };\n  } catch (error) {\n    console.error('❌ Error sending push notification:', error);\n    return { success: false, reason: 'error', error: error.message };\n  }\n}\n\nasync function getUserLanguage(userId) {\n  try {\n    const [user] = await db.select().from(users).where(eq(users.id, userId));\n    return user?.preferredLanguage || 'pt';\n  } catch (error) {\n    console.error('Error getting user language:', error);\n    return 'pt';\n  }\n}\n\nexport async function sendQueueNotification(userId, queueName, ticketNumber, position, businessName) {\n  const userLang = await getUserLanguage(userId);\n  \n  let title = 'A sua vez está a chegar!';\n  let body = `Fila: ${queueName} - Senha #${ticketNumber}. Faltam ${position} senhas para ser chamado.`;\n  \n  if (userLang !== 'pt') {\n    title = await translateText(title, userLang, 'pt');\n    body = await translateText(body, userLang, 'pt');\n  }\n  \n  return sendPushNotification(userId, title, body, {\n    queueName,\n    ticketNumber: String(ticketNumber),\n    position: String(position),\n    businessName,\n  }, 'queue_alert');\n}\n\nexport async function sendTicketCalledNotification(userId, queueName, ticketNumber, businessName, toleranceMinutes = 15) {\n  const userLang = await getUserLanguage(userId);\n  \n  let title = 'A sua senha foi chamada!';\n  let body = `Senha #${ticketNumber} - ${queueName}. Dirija-se ao atendimento. Tem ${toleranceMinutes} minutos de tolerância.`;\n  \n  if (userLang !== 'pt') {\n    title = await translateText(title, userLang, 'pt');\n    body = await translateText(body, userLang, 'pt');\n  }\n  \n  return sendPushNotification(userId, title, body, {\n    queueName,\n    ticketNumber: String(ticketNumber),\n    businessName,\n    toleranceMinutes: String(toleranceMinutes),\n  }, 'ticket_called');\n}\n\nexport async function sendAppointmentReminderNotification(userId, serviceName, businessName, date, time) {\n  const userLang = await getUserLanguage(userId);\n  \n  let title = 'Lembrete de Marcação';\n  let body = `A sua marcação para ${serviceName} em ${businessName} é amanhã às ${time}.`;\n  \n  if (userLang !== 'pt') {\n    title = await translateText(title, userLang, 'pt');\n    body = await translateText(body, userLang, 'pt');\n  }\n  \n  return sendPushNotification(userId, title, body, {\n    serviceName,\n    businessName,\n    date,\n    time,\n  }, 'appointment_reminder');\n}\n\nexport async function sendAppointmentConfirmationNotification(userId, serviceName, businessName, date, time) {\n  const userLang = await getUserLanguage(userId);\n  \n  let title = 'Marcação Confirmada';\n  let body = `A sua marcação para ${serviceName} em ${businessName} foi confirmada para ${date} às ${time}.`;\n  \n  if (userLang !== 'pt') {\n    title = await translateText(title, userLang, 'pt');\n    body = await translateText(body, userLang, 'pt');\n  }\n  \n  return sendPushNotification(userId, title, body, {\n    serviceName,\n    businessName,\n    date,\n    time,\n  }, 'appointment_confirmed');\n}\n\nexport default {\n  registerDeviceToken,\n  unregisterDeviceToken,\n  getUserTokens,\n  sendPushNotification,\n  sendQueueNotification,\n  sendTicketCalledNotification,\n  sendAppointmentReminderNotification,\n  sendAppointmentConfirmationNotification,\n};\n","path":null,"size_bytes":8099,"size_tokens":null},"src/pages/TermsOfUse.jsx":{"content":"import React from \"react\";\nimport { useNavigate } from \"react-router-dom\";\nimport { Button } from \"@/components/ui/button\";\nimport { Card, CardContent } from \"@/components/ui/card\";\nimport { ArrowLeft, FileText, CreditCard, AlertTriangle, Scale, RefreshCw, Ban, Mail } from \"lucide-react\";\nimport { useAutoTranslate } from '@/hooks/useTranslate';\nimport { navigateBackOrFallback } from '@/hooks/useNavigateBack';\nimport { useTranslation } from 'react-i18next';\nimport { format } from 'date-fns';\nimport { pt, enUS, es, fr, de, it, nl, pl, ru, uk, zhCN, ja, ko, ar, hi, tr, vi, th, id as idLocale, ms } from 'date-fns/locale';\n\nconst localeMap = {\n  'pt': pt, 'pt-PT': pt, 'pt-BR': pt,\n  'en': enUS, 'en-US': enUS, 'en-GB': enUS,\n  'es': es, 'fr': fr, 'de': de, 'it': it, 'nl': nl, 'pl': pl,\n  'ru': ru, 'uk': uk, 'zh': zhCN, 'zh-CN': zhCN, 'ja': ja, 'ko': ko,\n  'ar': ar, 'hi': hi, 'tr': tr, 'vi': vi, 'th': th, 'id': idLocale, 'ms': ms, 'fil': enUS\n};\n\nexport default function TermsOfUsePage() {\n  const navigate = useNavigate();\n  const { i18n } = useTranslation();\n  \n  const currentLocale = localeMap[i18n.language] || localeMap[i18n.language?.split('-')[0]] || enUS;\n  const lastUpdateDate = new Date(2025, 11, 2);\n  const isPtLang = i18n.language?.startsWith('pt');\n  const formattedDate = isPtLang \n    ? format(lastUpdateDate, \"d 'de' MMMM 'de' yyyy\", { locale: currentLocale })\n    : format(lastUpdateDate, \"MMMM d, yyyy\", { locale: currentLocale });\n  \n  const txtBack = useAutoTranslate('Voltar', 'pt');\n  const txtTitle = useAutoTranslate('Termos de Utilização', 'pt');\n  const txtLastUpdated = useAutoTranslate('Última atualização', 'pt');\n  \n  const txtIntroTitle = useAutoTranslate('Aceitação dos Termos', 'pt');\n  const txtIntroText = useAutoTranslate('Ao aceder ou utilizar a aplicação QZero, concorda em ficar vinculado a estes Termos de Utilização. Se não concordar com qualquer parte dos termos, não poderá aceder ao serviço.', 'pt');\n  \n  const txtServiceTitle = useAutoTranslate('Descrição do Serviço', 'pt');\n  const txtServiceText = useAutoTranslate('A QZero é uma plataforma de gestão de filas e marcações que permite às empresas gerir o atendimento aos clientes e aos consumidores acompanhar o seu lugar na fila em tempo real.', 'pt');\n  \n  const txtAccountTitle = useAutoTranslate('Conta de Utilizador', 'pt');\n  const txtAccountText = useAutoTranslate('Para utilizar certas funcionalidades do Serviço, deve criar uma conta. É responsável por manter a confidencialidade da sua conta e palavra-passe. Concorda em aceitar a responsabilidade por todas as atividades que ocorram na sua conta.', 'pt');\n  \n  const txtSubscriptionTitle = useAutoTranslate('Subscrições e Pagamentos', 'pt');\n  const txtSubscriptionIntro = useAutoTranslate('Para contas empresariais, oferecemos subscrições pagas com as seguintes condições:', 'pt');\n  \n  const txtSubName = useAutoTranslate('Plano Empresarial QZero', 'pt');\n  const txtSubDuration = useAutoTranslate('Duração: Mensal (renovação automática)', 'pt');\n  const txtSubPrice = useAutoTranslate('Preço: €49,99/mês', 'pt');\n  \n  const txtPaymentTermsTitle = useAutoTranslate('Termos de Pagamento (Apple App Store / Google Play)', 'pt');\n  const txtPaymentTerm1 = useAutoTranslate('O pagamento será cobrado na sua conta iTunes/Google Play no momento da confirmação da compra.', 'pt');\n  const txtPaymentTerm2 = useAutoTranslate('A subscrição renova-se automaticamente a menos que a renovação automática seja desativada pelo menos 24 horas antes do fim do período atual.', 'pt');\n  const txtPaymentTerm3 = useAutoTranslate('A sua conta será cobrada pela renovação nas 24 horas anteriores ao fim do período atual, ao preço da subscrição selecionada.', 'pt');\n  const txtPaymentTerm4 = useAutoTranslate('As subscrições podem ser geridas pelo utilizador e a renovação automática pode ser desativada acedendo às Definições da Conta após a compra.', 'pt');\n  const txtPaymentTerm5 = useAutoTranslate('Qualquer parte não utilizada de um período de teste gratuito, se oferecido, será perdida quando o utilizador comprar uma subscrição.', 'pt');\n  \n  const txtStripeTermsTitle = useAutoTranslate('Termos de Pagamento (Website via Stripe)', 'pt');\n  const txtStripeTerm1 = useAutoTranslate('Os pagamentos são processados de forma segura através do Stripe.', 'pt');\n  const txtStripeTerm2 = useAutoTranslate('Pode existir um período de teste gratuito de 7 dias para novos utilizadores.', 'pt');\n  const txtStripeTerm3 = useAutoTranslate('Após o período de teste, a subscrição é cobrada automaticamente.', 'pt');\n  const txtStripeTerm4 = useAutoTranslate('Pode cancelar a qualquer momento através das definições da sua conta.', 'pt');\n  \n  const txtCancelTitle = useAutoTranslate('Cancelamento', 'pt');\n  const txtCancelText = useAutoTranslate('Pode cancelar a sua subscrição a qualquer momento. O acesso às funcionalidades empresariais permanecerá ativo até ao fim do período de faturação atual. Não são emitidos reembolsos por períodos parciais.', 'pt');\n  const txtCancelHow = useAutoTranslate('Para cancelar:', 'pt');\n  const txtCancelIOS = useAutoTranslate('iOS: Definições > [Seu Nome] > Subscrições > QZero > Cancelar Subscrição', 'pt');\n  const txtCancelAndroid = useAutoTranslate('Android: Google Play Store > Menu > Subscrições > QZero > Cancelar Subscrição', 'pt');\n  const txtCancelWeb = useAutoTranslate('Website: Perfil > Gerir Subscrição > Cancelar', 'pt');\n  \n  const txtUseTitle = useAutoTranslate('Utilização Aceitável', 'pt');\n  const txtUseText = useAutoTranslate('Concorda em não utilizar o Serviço para:', 'pt');\n  const txtUse1 = useAutoTranslate('Violar quaisquer leis ou regulamentos aplicáveis', 'pt');\n  const txtUse2 = useAutoTranslate('Transmitir material prejudicial, fraudulento ou enganador', 'pt');\n  const txtUse3 = useAutoTranslate('Interferir com o funcionamento normal do Serviço', 'pt');\n  const txtUse4 = useAutoTranslate('Tentar aceder não autorizado a sistemas ou dados', 'pt');\n  const txtUse5 = useAutoTranslate('Recolher dados de outros utilizadores sem consentimento', 'pt');\n  \n  const txtIPTitle = useAutoTranslate('Propriedade Intelectual', 'pt');\n  const txtIPText = useAutoTranslate('O Serviço e o seu conteúdo original, funcionalidades e funcionalidade são e permanecerão propriedade exclusiva da QZero. O Serviço está protegido por direitos de autor, marcas registadas e outras leis.', 'pt');\n  \n  const txtTerminationTitle = useAutoTranslate('Rescisão', 'pt');\n  const txtTerminationText = useAutoTranslate('Podemos rescindir ou suspender a sua conta imediatamente, sem aviso prévio ou responsabilidade, por qualquer razão, incluindo, sem limitação, se violar os Termos. Após a rescisão, o seu direito de utilizar o Serviço cessará imediatamente.', 'pt');\n  \n  const txtLiabilityTitle = useAutoTranslate('Limitação de Responsabilidade', 'pt');\n  const txtLiabilityText = useAutoTranslate('Em caso algum a QZero, nem os seus diretores, empregados, parceiros, agentes, fornecedores ou afiliados, serão responsáveis por quaisquer danos indiretos, incidentais, especiais, consequenciais ou punitivos, incluindo, sem limitação, perda de lucros, dados, uso, boa vontade ou outras perdas intangíveis.', 'pt');\n  \n  const txtDisclaimerTitle = useAutoTranslate('Isenção de Garantias', 'pt');\n  const txtDisclaimerText = useAutoTranslate('O Serviço é fornecido \"TAL COMO ESTÁ\" e \"CONFORME DISPONÍVEL\" sem garantias de qualquer tipo, expressas ou implícitas. Não garantimos que o Serviço funcionará de forma ininterrupta, segura ou estará disponível em qualquer momento ou local específico.', 'pt');\n  \n  const txtLawTitle = useAutoTranslate('Lei Aplicável', 'pt');\n  const txtLawText = useAutoTranslate('Estes Termos serão regidos e interpretados de acordo com as leis de Portugal, sem consideração às suas disposições sobre conflitos de leis. A nossa falha em fazer valer qualquer direito ou disposição destes Termos não será considerada uma renúncia a esses direitos.', 'pt');\n  \n  const txtChangesTitle = useAutoTranslate('Alterações aos Termos', 'pt');\n  const txtChangesText = useAutoTranslate('Reservamo-nos o direito, a nosso exclusivo critério, de modificar ou substituir estes Termos a qualquer momento. Notificá-lo-emos de quaisquer alterações materiais com pelo menos 30 dias de antecedência antes de os novos termos entrarem em vigor.', 'pt');\n  \n  const txtContactTitle = useAutoTranslate('Contacto', 'pt');\n  const txtContactText = useAutoTranslate('Se tiver questões sobre estes Termos, contacte-nos:', 'pt');\n\n  return (\n    <div className=\"bg-gradient-to-br from-slate-50 via-blue-50 to-sky-50\">\n      <div className=\"max-w-4xl mx-auto px-4 py-4 sm:py-8\">\n        <div className=\"mb-6\">\n          <Button\n            variant=\"ghost\"\n            onClick={() => navigateBackOrFallback(navigate, '/')}\n            className=\"gap-2\"\n          >\n            <ArrowLeft className=\"w-4 h-4\" />\n            {txtBack}\n          </Button>\n        </div>\n\n        <Card className=\"border-0 shadow-xl\">\n          <CardContent className=\"p-6 sm:p-8 md:p-12\">\n            <div className=\"flex items-center gap-3 mb-6\">\n              <div className=\"p-3 bg-indigo-100 rounded-xl\">\n                <FileText className=\"w-8 h-8 text-indigo-600\" />\n              </div>\n              <div>\n                <h1 className=\"text-2xl sm:text-3xl font-bold text-slate-900\">{txtTitle}</h1>\n                <p className=\"text-sm text-slate-500\">{txtLastUpdated}: {formattedDate}</p>\n              </div>\n            </div>\n\n            <div className=\"prose prose-slate max-w-none space-y-8\">\n              <section>\n                <h2 className=\"text-xl font-semibold text-slate-900 flex items-center gap-2\">\n                  <Scale className=\"w-5 h-5 text-indigo-600\" />\n                  {txtIntroTitle}\n                </h2>\n                <p className=\"text-slate-600 mt-2\">{txtIntroText}</p>\n              </section>\n\n              <section>\n                <h2 className=\"text-xl font-semibold text-slate-900\">{txtServiceTitle}</h2>\n                <p className=\"text-slate-600 mt-2\">{txtServiceText}</p>\n              </section>\n\n              <section>\n                <h2 className=\"text-xl font-semibold text-slate-900\">{txtAccountTitle}</h2>\n                <p className=\"text-slate-600 mt-2\">{txtAccountText}</p>\n              </section>\n\n              <section className=\"bg-indigo-50 p-6 rounded-xl border border-indigo-200\">\n                <h2 className=\"text-xl font-semibold text-slate-900 flex items-center gap-2\">\n                  <CreditCard className=\"w-5 h-5 text-indigo-600\" />\n                  {txtSubscriptionTitle}\n                </h2>\n                <p className=\"text-slate-600 mt-2\">{txtSubscriptionIntro}</p>\n                \n                <div className=\"mt-4 p-4 bg-white rounded-lg\">\n                  <h3 className=\"font-semibold text-lg text-slate-900\">{txtSubName}</h3>\n                  <ul className=\"list-disc list-inside text-slate-700 mt-2 space-y-1\">\n                    <li>{txtSubDuration}</li>\n                    <li>{txtSubPrice}</li>\n                  </ul>\n                </div>\n\n                <div className=\"mt-6\">\n                  <h3 className=\"font-semibold text-slate-900\">{txtPaymentTermsTitle}</h3>\n                  <ul className=\"list-disc list-inside text-slate-700 mt-2 space-y-2\">\n                    <li>{txtPaymentTerm1}</li>\n                    <li>{txtPaymentTerm2}</li>\n                    <li>{txtPaymentTerm3}</li>\n                    <li>{txtPaymentTerm4}</li>\n                    <li>{txtPaymentTerm5}</li>\n                  </ul>\n                </div>\n\n                <div className=\"mt-6\">\n                  <h3 className=\"font-semibold text-slate-900\">{txtStripeTermsTitle}</h3>\n                  <ul className=\"list-disc list-inside text-slate-700 mt-2 space-y-2\">\n                    <li>{txtStripeTerm1}</li>\n                    <li>{txtStripeTerm2}</li>\n                    <li>{txtStripeTerm3}</li>\n                    <li>{txtStripeTerm4}</li>\n                  </ul>\n                </div>\n              </section>\n\n              <section>\n                <h2 className=\"text-xl font-semibold text-slate-900 flex items-center gap-2\">\n                  <RefreshCw className=\"w-5 h-5 text-indigo-600\" />\n                  {txtCancelTitle}\n                </h2>\n                <p className=\"text-slate-600 mt-2\">{txtCancelText}</p>\n                <p className=\"text-slate-700 mt-3 font-medium\">{txtCancelHow}</p>\n                <ul className=\"list-disc list-inside text-slate-600 mt-2 space-y-1\">\n                  <li>{txtCancelIOS}</li>\n                  <li>{txtCancelAndroid}</li>\n                  <li>{txtCancelWeb}</li>\n                </ul>\n              </section>\n\n              <section>\n                <h2 className=\"text-xl font-semibold text-slate-900 flex items-center gap-2\">\n                  <Ban className=\"w-5 h-5 text-red-600\" />\n                  {txtUseTitle}\n                </h2>\n                <p className=\"text-slate-600 mt-2\">{txtUseText}</p>\n                <ul className=\"list-disc list-inside text-slate-600 mt-3 space-y-2\">\n                  <li>{txtUse1}</li>\n                  <li>{txtUse2}</li>\n                  <li>{txtUse3}</li>\n                  <li>{txtUse4}</li>\n                  <li>{txtUse5}</li>\n                </ul>\n              </section>\n\n              <section>\n                <h2 className=\"text-xl font-semibold text-slate-900\">{txtIPTitle}</h2>\n                <p className=\"text-slate-600 mt-2\">{txtIPText}</p>\n              </section>\n\n              <section>\n                <h2 className=\"text-xl font-semibold text-slate-900 flex items-center gap-2\">\n                  <AlertTriangle className=\"w-5 h-5 text-amber-600\" />\n                  {txtTerminationTitle}\n                </h2>\n                <p className=\"text-slate-600 mt-2\">{txtTerminationText}</p>\n              </section>\n\n              <section>\n                <h2 className=\"text-xl font-semibold text-slate-900\">{txtLiabilityTitle}</h2>\n                <p className=\"text-slate-600 mt-2\">{txtLiabilityText}</p>\n              </section>\n\n              <section>\n                <h2 className=\"text-xl font-semibold text-slate-900\">{txtDisclaimerTitle}</h2>\n                <p className=\"text-slate-600 mt-2\">{txtDisclaimerText}</p>\n              </section>\n\n              <section>\n                <h2 className=\"text-xl font-semibold text-slate-900\">{txtLawTitle}</h2>\n                <p className=\"text-slate-600 mt-2\">{txtLawText}</p>\n              </section>\n\n              <section>\n                <h2 className=\"text-xl font-semibold text-slate-900\">{txtChangesTitle}</h2>\n                <p className=\"text-slate-600 mt-2\">{txtChangesText}</p>\n              </section>\n\n              <section>\n                <h2 className=\"text-xl font-semibold text-slate-900 flex items-center gap-2\">\n                  <Mail className=\"w-5 h-5 text-indigo-600\" />\n                  {txtContactTitle}\n                </h2>\n                <p className=\"text-slate-600 mt-2\">{txtContactText}</p>\n                <div className=\"mt-3 p-4 bg-slate-50 rounded-lg\">\n                  <p className=\"text-slate-700\"><strong>Email:</strong> suporteqzero@gmail.com</p>\n                </div>\n              </section>\n            </div>\n          </CardContent>\n        </Card>\n      </div>\n    </div>\n  );\n}\n","path":null,"size_bytes":15571,"size_tokens":null},"src/hooks/usePushNotifications.js":{"content":"import { useEffect, useState, useCallback } from 'react';\nimport { useNavigate } from 'react-router-dom';\nimport { toast } from 'sonner';\nimport { pushNotificationService } from '@/services/pushNotificationService';\nimport { useUser } from '@/contexts/UserContext';\n\nexport function usePushNotifications() {\n  const [isSupported, setIsSupported] = useState(false);\n  const [isEnabled, setIsEnabled] = useState(false);\n  const [token, setToken] = useState(null);\n  const navigate = useNavigate();\n  const { user } = useUser();\n\n  useEffect(() => {\n    const supported = pushNotificationService.isSupported();\n    setIsSupported(supported);\n    \n    if (supported && user) {\n      initializePushNotifications();\n    }\n  }, [user]);\n\n  const initializePushNotifications = useCallback(async () => {\n    try {\n      await pushNotificationService.init();\n      const currentToken = pushNotificationService.getToken();\n      setToken(currentToken);\n      setIsEnabled(!!currentToken);\n\n      const removeListener = pushNotificationService.addListener((event, data) => {\n        if (event === 'received') {\n          handleNotificationReceived(data);\n        } else if (event === 'actionPerformed') {\n          handleNotificationAction(data);\n        }\n      });\n\n      return removeListener;\n    } catch (error) {\n      console.error('Error initializing push notifications:', error);\n    }\n  }, []);\n\n  const handleNotificationReceived = useCallback((notification) => {\n    const { title, body, data } = notification;\n    \n    toast.info(title, {\n      description: body,\n      action: data?.type ? {\n        label: 'Ver',\n        onClick: () => navigateToNotification(data),\n      } : undefined,\n    });\n  }, []);\n\n  const handleNotificationAction = useCallback((notification) => {\n    const { data } = notification.notification;\n    navigateToNotification(data);\n  }, [navigate]);\n\n  const navigateToNotification = useCallback((data) => {\n    if (!data) return;\n    \n    switch (data.type) {\n      case 'queue_alert':\n      case 'ticket_called':\n        navigate('/my-tickets');\n        break;\n      case 'appointment_reminder':\n      case 'appointment_confirmed':\n        navigate('/my-appointments');\n        break;\n      default:\n        break;\n    }\n  }, [navigate]);\n\n  const requestPermission = useCallback(async () => {\n    if (!isSupported) {\n      toast.error('Notificações push não são suportadas neste dispositivo');\n      return false;\n    }\n\n    try {\n      await pushNotificationService.init();\n      const currentToken = pushNotificationService.getToken();\n      setToken(currentToken);\n      setIsEnabled(!!currentToken);\n      \n      if (currentToken) {\n        toast.success('Notificações push ativadas com sucesso!');\n      }\n      \n      return !!currentToken;\n    } catch (error) {\n      console.error('Error requesting push permission:', error);\n      toast.error('Erro ao ativar notificações push');\n      return false;\n    }\n  }, [isSupported]);\n\n  const sendTestNotification = useCallback(async () => {\n    try {\n      const response = await fetch('/api/push-notifications/test', {\n        method: 'POST',\n        credentials: 'include',\n      });\n      \n      const data = await response.json();\n      \n      if (data.success) {\n        toast.success('Notificação de teste enviada!');\n      } else {\n        toast.error(data.reason === 'firebase_not_configured' \n          ? 'Firebase não configurado no servidor'\n          : 'Erro ao enviar notificação de teste');\n      }\n      \n      return data;\n    } catch (error) {\n      console.error('Error sending test notification:', error);\n      toast.error('Erro ao enviar notificação de teste');\n      return { success: false, error: error.message };\n    }\n  }, []);\n\n  return {\n    isSupported,\n    isEnabled,\n    token,\n    requestPermission,\n    sendTestNotification,\n  };\n}\n\nexport default usePushNotifications;\n","path":null,"size_bytes":3900,"size_tokens":null},"src/services/pushNotificationService.js":{"content":"import { Capacitor } from '@capacitor/core';\nimport { PushNotifications } from '@capacitor/push-notifications';\n\nclass PushNotificationService {\n  constructor() {\n    this.initialized = false;\n    this.token = null;\n    this.listeners = [];\n  }\n\n  async init() {\n    if (this.initialized) return;\n    \n    if (!Capacitor.isNativePlatform()) {\n      console.log('📱 Push notifications only available on native platforms');\n      return;\n    }\n\n    try {\n      const permStatus = await PushNotifications.checkPermissions();\n      \n      if (permStatus.receive === 'prompt') {\n        const newStatus = await PushNotifications.requestPermissions();\n        if (newStatus.receive !== 'granted') {\n          console.log('❌ Push notification permission denied');\n          return;\n        }\n      } else if (permStatus.receive !== 'granted') {\n        console.log('❌ Push notification permission not granted');\n        return;\n      }\n\n      await PushNotifications.register();\n      this.setupListeners();\n      this.initialized = true;\n      console.log('✅ Push notifications initialized');\n    } catch (error) {\n      console.error('❌ Error initializing push notifications:', error);\n    }\n  }\n\n  setupListeners() {\n    PushNotifications.addListener('registration', async (token) => {\n      console.log('📱 Push registration token:', token.value);\n      this.token = token.value;\n      await this.saveTokenToServer(token.value);\n    });\n\n    PushNotifications.addListener('registrationError', (error) => {\n      console.error('❌ Push registration error:', error);\n    });\n\n    PushNotifications.addListener('pushNotificationReceived', (notification) => {\n      console.log('📬 Push notification received:', notification);\n      this.notifyListeners('received', notification);\n    });\n\n    PushNotifications.addListener('pushNotificationActionPerformed', (notification) => {\n      console.log('👆 Push notification action performed:', notification);\n      this.notifyListeners('actionPerformed', notification);\n    });\n  }\n\n  async saveTokenToServer(token) {\n    try {\n      const platform = Capacitor.getPlatform();\n      const response = await fetch('/api/push-notifications/register-token', {\n        method: 'POST',\n        headers: {\n          'Content-Type': 'application/json',\n        },\n        credentials: 'include',\n        body: JSON.stringify({\n          token,\n          platform,\n          deviceInfo: {\n            platform,\n            isNative: Capacitor.isNativePlatform(),\n          }\n        }),\n      });\n\n      if (!response.ok) {\n        throw new Error('Failed to save push token');\n      }\n\n      console.log('✅ Push token saved to server');\n    } catch (error) {\n      console.error('❌ Error saving push token:', error);\n    }\n  }\n\n  async removeTokenFromServer() {\n    if (!this.token) return;\n\n    try {\n      await fetch('/api/push-notifications/unregister-token', {\n        method: 'POST',\n        headers: {\n          'Content-Type': 'application/json',\n        },\n        credentials: 'include',\n        body: JSON.stringify({ token: this.token }),\n      });\n      console.log('✅ Push token removed from server');\n    } catch (error) {\n      console.error('❌ Error removing push token:', error);\n    }\n  }\n\n  addListener(callback) {\n    this.listeners.push(callback);\n    return () => {\n      this.listeners = this.listeners.filter(l => l !== callback);\n    };\n  }\n\n  notifyListeners(event, data) {\n    this.listeners.forEach(listener => {\n      try {\n        listener(event, data);\n      } catch (error) {\n        console.error('Error in push notification listener:', error);\n      }\n    });\n  }\n\n  getToken() {\n    return this.token;\n  }\n\n  isSupported() {\n    return Capacitor.isNativePlatform();\n  }\n}\n\nexport const pushNotificationService = new PushNotificationService();\nexport default pushNotificationService;\n","path":null,"size_bytes":3873,"size_tokens":null},"src/components/business/ExpiredBanner.jsx":{"content":"import { Button } from '@/components/ui/button';\nimport { CreditCard, Globe } from 'lucide-react';\nimport { useNavigate } from 'react-router-dom';\nimport { createPageUrl } from '@/utils';\nimport { Capacitor } from '@capacitor/core';\nimport { useAutoTranslate } from '@/hooks/useTranslate';\n\nexport function ExpiredBanner({ companyProfileId }) {\n  const navigate = useNavigate();\n  const isNativeApp = Capacitor.isNativePlatform();\n  \n  const txtExpired = useAutoTranslate('Subscrição Expirada', 'pt');\n  const txtRenewNow = useAutoTranslate('Renovar Agora', 'pt');\n  const txtVisitWebsite = useAutoTranslate('Renove em waitless-qzero.com', 'pt');\n\n  return (\n    <div className=\"bg-red-600 text-white p-4 text-center\">\n      <p className=\"font-bold text-lg mb-2\">{txtExpired}</p>\n      \n      {/* 🍎🤖 B2B COMPLIANCE: Apps nativas NÃO podem ter botões de pagamento */}\n      {isNativeApp ? (\n        <div className=\"flex items-center justify-center gap-2 text-white/90\">\n          <Globe className=\"w-5 h-5\" />\n          <span className=\"font-semibold\">{txtVisitWebsite}</span>\n        </div>\n      ) : (\n        <Button\n          onClick={() => navigate(createPageUrl('BusinessSubscription'), { \n            state: { isReactivation: true, existingProfileId: companyProfileId } \n          })}\n          className=\"bg-white text-red-600 hover:bg-red-50 font-bold\"\n        >\n          <CreditCard className=\"w-5 h-5 mr-2\" />\n          {txtRenewNow} - €49,99/mês\n        </Button>\n      )}\n    </div>\n  );\n}\n","path":null,"size_bytes":1516,"size_tokens":null},"src/components/business/RestrictedAccessOverlay.jsx":{"content":"import React from \"react\";\nimport { Button } from \"@/components/ui/button\";\nimport { Card, CardContent } from \"@/components/ui/card\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { useNavigate } from \"react-router-dom\";\nimport { createPageUrl } from \"@/utils\";\nimport { Lock, Crown, ExternalLink, Globe, CheckCircle2 } from \"lucide-react\";\nimport { useAutoTranslate } from \"@/hooks/useTranslate\";\nimport { Capacitor } from \"@capacitor/core\";\n\nexport function RestrictedAccessOverlay({ featureName, onClose }) {\n  const navigate = useNavigate();\n  const isNativeApp = Capacitor.isNativePlatform();\n\n  const txtRestrictedAccess = useAutoTranslate('Acesso Restrito', 'pt');\n  const txtProFeature = useAutoTranslate('Funcionalidade Pro', 'pt');\n  const txtUnlockFeature = useAutoTranslate('Desbloqueia esta funcionalidade ativando o plano empresarial.', 'pt');\n  const txtViewPlans = useAutoTranslate('Ver Planos', 'pt');\n  const txtClose = useAutoTranslate('Fechar', 'pt');\n  const txt7DaysTrial = useAutoTranslate('7 dias grátis para testar', 'pt');\n  const txtUnlimitedQueues = useAutoTranslate('Gestão ilimitada de senhas', 'pt');\n  const txtCompleteBooking = useAutoTranslate('Sistema completo de marcações', 'pt');\n  const txtAdvancedAnalytics = useAutoTranslate('Análises e estatísticas avançadas', 'pt');\n  const txtCancelAnytime = useAutoTranslate('Cancele quando quiser', 'pt');\n  \n  const txtExternalPurchaseTitle = useAutoTranslate('Quase lá!', 'pt');\n  const txtExternalPurchaseDesc = useAutoTranslate('Para desbloquear todas as funcionalidades, visite o nosso site no seu browser ou computador.', 'pt');\n  const txtExternalPurchasePromo = useAutoTranslate('7 dias grátis + €19,99 (1º mês) + €49,99/mês', 'pt');\n  const txtB2BNote = useAutoTranslate('A compra é feita no site waitless-qzero.com para maior segurança.', 'pt');\n\n  const handleViewPlans = () => {\n    navigate(createPageUrl('BusinessSubscription'));\n  };\n\n  return (\n    <div className=\"fixed inset-0 bg-black/60 backdrop-blur-sm z-50 flex items-center justify-center p-4\">\n      <Card className=\"max-w-md w-full border-0 shadow-2xl overflow-hidden animate-in fade-in zoom-in duration-200\">\n        <div className=\"h-1.5 bg-gradient-to-r from-amber-500 via-orange-500 to-red-500\" />\n        <CardContent className=\"p-6\">\n          <div className=\"text-center mb-5\">\n            <div className=\"w-14 h-14 mx-auto mb-3 rounded-full bg-gradient-to-br from-amber-100 to-orange-100 flex items-center justify-center\">\n              <Lock className=\"w-7 h-7 text-amber-600\" />\n            </div>\n            \n            <Badge className=\"bg-amber-100 text-amber-700 border-amber-200 mb-2\">\n              <Crown className=\"w-3 h-3 mr-1\" />\n              {txtProFeature}\n            </Badge>\n            \n            <h2 className=\"text-xl font-bold text-slate-900 mb-1\">\n              {txtRestrictedAccess}\n            </h2>\n            \n            {featureName && (\n              <p className=\"text-sm text-slate-500 mb-2\">\n                {featureName}\n              </p>\n            )}\n            \n            <p className=\"text-slate-600 text-sm\">\n              {txtUnlockFeature}\n            </p>\n          </div>\n\n          {isNativeApp ? (\n            <div className=\"space-y-4\">\n              <div className=\"bg-indigo-50 rounded-xl p-4 text-center\">\n                <Globe className=\"w-8 h-8 text-indigo-600 mx-auto mb-2\" />\n                <p className=\"text-indigo-900 font-semibold mb-1\">\n                  {txtExternalPurchaseTitle}\n                </p>\n                <p className=\"text-indigo-700 text-sm mb-2\">\n                  {txtExternalPurchaseDesc}\n                </p>\n                <p className=\"text-indigo-900 font-bold text-lg\">\n                  waitless-qzero.com\n                </p>\n              </div>\n              \n              <div className=\"text-center\">\n                <span className=\"inline-block px-3 py-1.5 bg-gradient-to-r from-green-500 to-emerald-500 text-white text-xs font-semibold rounded-full\">\n                  {txtExternalPurchasePromo}\n                </span>\n              </div>\n              \n              <p className=\"text-xs text-slate-500 text-center\">\n                {txtB2BNote}\n              </p>\n            </div>\n          ) : (\n            <div className=\"space-y-2 mb-5\">\n              {[txt7DaysTrial, txtUnlimitedQueues, txtCompleteBooking, txtAdvancedAnalytics, txtCancelAnytime].map((feature, idx) => (\n                <div key={idx} className=\"flex items-center gap-2\">\n                  <CheckCircle2 className=\"w-4 h-4 text-green-600 flex-shrink-0\" />\n                  <span className=\"text-slate-700 text-sm\">{feature}</span>\n                </div>\n              ))}\n            </div>\n          )}\n\n          <div className=\"flex flex-col gap-2 mt-5\">\n            {!isNativeApp && (\n              <Button \n                onClick={handleViewPlans}\n                className=\"w-full bg-gradient-to-r from-amber-500 to-orange-500 hover:from-amber-600 hover:to-orange-600 text-white font-semibold\"\n              >\n                <Crown className=\"w-4 h-4 mr-2\" />\n                {txtViewPlans}\n              </Button>\n            )}\n            \n            <Button \n              variant=\"ghost\" \n              onClick={onClose}\n              className=\"w-full text-slate-600\"\n            >\n              {txtClose}\n            </Button>\n          </div>\n        </CardContent>\n      </Card>\n    </div>\n  );\n}\n","path":null,"size_bytes":5491,"size_tokens":null}},"version":2}